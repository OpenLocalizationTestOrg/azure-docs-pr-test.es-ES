---
title: "Conmutación por recuperación de máquinas virtuales de VMware de Azure al sitio local | Microsoft Docs"
description: "Aprenda a conmutar por recuperación al sitio local después de conmutar por error las máquinas virtuales de VMware y los servidores físicos a Azure."
services: site-recovery
documentationcenter: 
author: ruturaj
manager: mkjain
editor: 
ms.assetid: 5a47337f-89a9-43e8-8fdc-7da373c0fb0f
ms.service: site-recovery
ms.devlang: na
ms.tgt_pltfrm: na
ms.topic: article
ms.workload: storage-backup-recovery
ms.date: 03/27/2017
ms.author: ruturajd
ms.openlocfilehash: dde0bb6b4f6bc10afdd7d40adc6689d42b37de81
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 08/03/2017
---
# <a name="fail-back-vmware-virtual-machines-and-physical-servers-to-the-on-premises-site"></a><span data-ttu-id="45403-103">Conmutación por recuperación de máquinas virtuales de VMware y servidores físicos al sitio local</span><span class="sxs-lookup"><span data-stu-id="45403-103">Fail back VMware virtual machines and physical servers to the on-premises site</span></span>


<span data-ttu-id="45403-104">En este artículo se describe cómo conmutar por recuperación máquinas virtuales de Azure al sitio local.</span><span class="sxs-lookup"><span data-stu-id="45403-104">This article describes how to failback Azure virtual machines from Azure to the on-premises site.</span></span> <span data-ttu-id="45403-105">Siga las instrucciones que se describen aquí cuando esté listo para conmutar por recuperación máquinas virtuales de VMware o servidores físicos de Windows o Linux después de que haya vuelto a proteger las máquinas mediante esta [referencia](site-recovery-how-to-reprotect.md).</span><span class="sxs-lookup"><span data-stu-id="45403-105">Follow the instructions here when you're ready to fail back your VMware virtual machines or Windows or Linux physical servers after you have re-protected your machines using this [reference](site-recovery-how-to-reprotect.md).</span></span>

>[!NOTE]
><span data-ttu-id="45403-106">Si usa el Portal de Azure clásico, consulte las instrucciones mencionadas [aquí](site-recovery-failback-azure-to-vmware-classic.md) para obtener una arquitectura mejorada de VMware a Azure y [aquí](site-recovery-failback-azure-to-vmware-classic-legacy.md) para obtener la arquitectura heredada</span><span class="sxs-lookup"><span data-stu-id="45403-106">If you are using the classic Azure portal, please refer to instructions mentioned [here](site-recovery-failback-azure-to-vmware-classic.md) for enhanced VMware to Azure architecture and [here](site-recovery-failback-azure-to-vmware-classic-legacy.md) for the legacy architecture</span></span>

## <a name="overview"></a><span data-ttu-id="45403-107">Información general</span><span class="sxs-lookup"><span data-stu-id="45403-107">Overview</span></span>
<span data-ttu-id="45403-108">Los diagramas de esta sección muestran la arquitectura de conmutación por recuperación en este escenario.</span><span class="sxs-lookup"><span data-stu-id="45403-108">The diagrams in this section show the failback architecture for this scenario.</span></span>

<span data-ttu-id="45403-109">Cuando el servidor de procesos sea local y se esté usando una conexión de Azure ExpressRoute, use esta arquitectura:</span><span class="sxs-lookup"><span data-stu-id="45403-109">When the Process Server is on-premises and you are using an Azure ExpressRoute connection, use this architecture:</span></span>

![Diagrama de la arquitectura de ExpressRoute](./media/site-recovery-failback-azure-to-vmware-classic/architecture.png)

<span data-ttu-id="45403-111">Cuando el servidor de procesos esté en Azure y tenga una VPN o una conexión de ExpressRoute, use esta arquitectura:</span><span class="sxs-lookup"><span data-stu-id="45403-111">When the Process Server is on Azure and you have either a VPN or an ExpressRoute connection, use this architecture:</span></span>

![Diagrama de la arquitectura de VPN](./media/site-recovery-failback-azure-to-vmware-classic/architecture2.png)

<span data-ttu-id="45403-113">Para ver la lista completa de puertos y el diagrama de la arquitectura de la conmutación por recuperación, consulte la imagen siguiente:</span><span class="sxs-lookup"><span data-stu-id="45403-113">For a complete list of ports and the failback architecture diagram, refer to the following image:</span></span>

![Lista de conmutación por error/recuperación de todos los puertos](./media/site-recovery-failback-azure-to-vmware-classic/Failover-Failback.png)

<span data-ttu-id="45403-115">Después de conmutar por error a Azure, conmuta por recuperación a su sitio local en tres fases:</span><span class="sxs-lookup"><span data-stu-id="45403-115">After you’ve failed over to Azure, you fail back to your on-premises site in three stages:</span></span>

* <span data-ttu-id="45403-116">**Fase 1**: proteja de nuevo las máquinas virtuales de Azure de modo que comiencen a replicarse otra vez en las de VMware que se ejecutan en el sitio local.</span><span class="sxs-lookup"><span data-stu-id="45403-116">**Stage 1**: You reprotect the Azure VMs so that they start replicating back to the VMware VMs that are running on your on-premises site.</span></span>
* <span data-ttu-id="45403-117">**Fase 2**: una vez que las máquinas virtuales de Azure se estén replicando en el sitio local, ejecute una conmutación por error para conmutar por recuperación desde Azure.</span><span class="sxs-lookup"><span data-stu-id="45403-117">**Stage 2**: After your Azure VMs are replicated to your on-premises site, you run a failover to fail back from Azure.</span></span>
* <span data-ttu-id="45403-118">**Fase 3**: después de que los datos se hayan conmutado por recuperación, vuelva a proteger las máquinas virtuales locales a las que conmutó por recuperación, para que comiencen a replicarse en Azure.</span><span class="sxs-lookup"><span data-stu-id="45403-118">**Stage 3**: After your data has failed back, you reprotect the on-premises VMs that you failed back to, so that they start replicating to Azure.</span></span>

### <a name="fail-back-to-the-original-location-or-an-alternate-location"></a><span data-ttu-id="45403-119">Conmutación por recuperación a la ubicación original o a una ubicación alternativa</span><span class="sxs-lookup"><span data-stu-id="45403-119">Fail back to the original location or an alternate location</span></span>
<span data-ttu-id="45403-120">Después de conmutar por error una máquina virtual de VMware, puede conmutar por recuperación a la misma máquina virtual de origen si aún existe en el entorno local.</span><span class="sxs-lookup"><span data-stu-id="45403-120">After you fail over a VMware VM, you can fail back to the same source VM if it still exists on-premises.</span></span> <span data-ttu-id="45403-121">En este escenario solo se conmutarán por recuperación las diferencias.</span><span class="sxs-lookup"><span data-stu-id="45403-121">In this scenario, only the deltas are failed back.</span></span>

<span data-ttu-id="45403-122">Si conmutó por error servidores físicos, la conmutación por recuperación siempre se hace a una nueva máquina virtual de VMware.</span><span class="sxs-lookup"><span data-stu-id="45403-122">If you failed over physical servers, failback is always to a new VMware VM.</span></span> <span data-ttu-id="45403-123">Antes de conmutar por recuperación una máquina física, tenga en cuenta lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="45403-123">Before failing back a physical machine, note that:</span></span>
* <span data-ttu-id="45403-124">Las máquinas físicas protegidas volverán como virtuales cuando se conmuten por recuperación de Azure a VMware.</span><span class="sxs-lookup"><span data-stu-id="45403-124">A protected physical machine will come back as a virtual machine when it is failed over back from Azure to VMware.</span></span> <span data-ttu-id="45403-125">Si las máquinas físicas de Windows Server 2008 R2 SP1 están protegidas y conmutan por error a Azure, no se puede realizar la conmutación por recuperación.</span><span class="sxs-lookup"><span data-stu-id="45403-125">A Windows Server 2008 R2 SP1 physical machine, if it is protected and failed over to Azure, cannot be failed back.</span></span> <span data-ttu-id="45403-126">Las máquinas Windows Server 2008 R2 SP1 que se inicien como máquinas virtuales locales podrán realizar la conmutación por recuperación.</span><span class="sxs-lookup"><span data-stu-id="45403-126">A Windows Server 2008 R2 SP1 machine that started as a virtual machine on-premises will be able to fail back.</span></span>
* <span data-ttu-id="45403-127">Asegúrese de detectar al menos un servidor de destino principal junto con los hosts ESX/ESXi a los que necesita conmutar por recuperación.</span><span class="sxs-lookup"><span data-stu-id="45403-127">Ensure that you discover at least one master target server along with the necessary ESX/ESXi hosts that you need to fail back to.</span></span>

<span data-ttu-id="45403-128">Si conmuta por recuperación a la máquina virtual original, se necesita lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="45403-128">If you fail back to the original VM, the following are required:</span></span>

* <span data-ttu-id="45403-129">Si la máquina virtual está administrada por un servidor vCenter, el host ESX del destino principal debe tener acceso al almacén de datos de máquinas virtuales.</span><span class="sxs-lookup"><span data-stu-id="45403-129">If the VM is managed by a vCenter server, the master target's ESX host should have access to the VMs datastore.</span></span>
* <span data-ttu-id="45403-130">Si la máquina virtual está en un host ESX, pero no está administrada por vCenter, el disco duro de la máquina virtual debe estar en un almacén de datos accesible para el host de MT.</span><span class="sxs-lookup"><span data-stu-id="45403-130">If the VM is on an ESX host but isn’t managed by vCenter, the hard disk of the VM must be in a datastore that's accessible by the MT's host.</span></span>
* <span data-ttu-id="45403-131">Si la máquina virtual está en un host ESX y no usa vCenter, debe completar la detección del host ESX de MT antes de volver a protegerla.</span><span class="sxs-lookup"><span data-stu-id="45403-131">If your VM is on an ESX host and doesn't use vCenter, you should complete discovery of the ESX host of the MT before you reprotect.</span></span> <span data-ttu-id="45403-132">Lo mismo se aplica si también conmuta por recuperación a servidores físicos.</span><span class="sxs-lookup"><span data-stu-id="45403-132">This applies if you're failing back physical servers too.</span></span>
* <span data-ttu-id="45403-133">Otra opción (si existe la máquina virtual local) es eliminarla antes de realizar una conmutación por recuperación.</span><span class="sxs-lookup"><span data-stu-id="45403-133">Another option (if the on-premises VM exists) is to delete it before you do a failback.</span></span> <span data-ttu-id="45403-134">En este caso, la conmutación por recuperación crea una nueva máquina virtual en el mismo host que el host ESX de destino maestro.</span><span class="sxs-lookup"><span data-stu-id="45403-134">Failback then creates a new VM on the same host as the master target ESX host.</span></span>

<span data-ttu-id="45403-135">Cuando se conmuta por recuperación a una ubicación alternativa, los datos se recuperan en el mismo almacén de datos y el mismo host ESX que los usados por el servidor de destino principal local.</span><span class="sxs-lookup"><span data-stu-id="45403-135">When you fail back to an alternate location, the data is recovered to the same datastore and the same ESX host as that used by the on-premises master target server.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="45403-136">Requisitos previos</span><span class="sxs-lookup"><span data-stu-id="45403-136">Prerequisites</span></span>
* <span data-ttu-id="45403-137">Para conmutar por recuperación máquinas virtuales de VMware y servidores físicos, necesita un entorno de VMware.</span><span class="sxs-lookup"><span data-stu-id="45403-137">To fail back VMware VMs and physical servers, you need a VMware environment.</span></span> <span data-ttu-id="45403-138">No se admite la conmutación por recuperación a un servidor físico.</span><span class="sxs-lookup"><span data-stu-id="45403-138">Failing back to a physical server isn’t supported.</span></span>
* <span data-ttu-id="45403-139">Para realizar la conmutación por recuperación, debe haber creado una red de Azure cuando configuró inicialmente la protección.</span><span class="sxs-lookup"><span data-stu-id="45403-139">To fail back, you must have created an Azure network when you initially set up protection.</span></span> <span data-ttu-id="45403-140">La conmutación por recuperación necesita una conexión VPN o ExpressRoute desde la red de Azure, en la que se encuentran las máquinas virtuales de Azure, hasta el sitio local.</span><span class="sxs-lookup"><span data-stu-id="45403-140">Failback needs a VPN or ExpressRoute connection from the Azure network in which the Azure VMs are located to the on-premises site.</span></span>
* <span data-ttu-id="45403-141">Si las máquinas virtuales que desea conmutar por recuperación las administra un servidor vCenter, asegúrese de tener los permisos necesarios para la detección de máquinas virtuales en servidores vCenter.</span><span class="sxs-lookup"><span data-stu-id="45403-141">If the VMs that you want to fail back to are managed by a vCenter server, make sure that you have the required permissions for discovery of VMs on vCenter servers.</span></span> <span data-ttu-id="45403-142">Para obtener más información, consulte [Replicación de máquinas virtuales de VMware y servidores físicos en Azure con Azure Site Recovery](site-recovery-vmware-to-azure-classic.md).</span><span class="sxs-lookup"><span data-stu-id="45403-142">For more information, see [Replicate VMware virtual machines and physical servers to Azure with Azure Site Recovery](site-recovery-vmware-to-azure-classic.md).</span></span>
* <span data-ttu-id="45403-143">Si existen instantáneas en una máquina virtual, la reprotección dará error.</span><span class="sxs-lookup"><span data-stu-id="45403-143">If snapshots are present on a VM, reprotection fails.</span></span> <span data-ttu-id="45403-144">Puede eliminar las instantáneas o los discos.</span><span class="sxs-lookup"><span data-stu-id="45403-144">You can delete the snapshots or the disks.</span></span>
* <span data-ttu-id="45403-145">Antes de realizar conmutación por recuperación, cree estos componentes:</span><span class="sxs-lookup"><span data-stu-id="45403-145">Before you fail back, create these components:</span></span>
  * <span data-ttu-id="45403-146">**Cree un servidor de procesos en Azure**.</span><span class="sxs-lookup"><span data-stu-id="45403-146">**Create a Process Server in Azure**.</span></span> <span data-ttu-id="45403-147">Este componente es una máquina virtual de Azure que creará y mantendrá en ejecución durante la conmutación por recuperación.</span><span class="sxs-lookup"><span data-stu-id="45403-147">This component is an Azure VM that you create and keep running during failback.</span></span> <span data-ttu-id="45403-148">Puede eliminar la máquina virtual una vez completada la operación.</span><span class="sxs-lookup"><span data-stu-id="45403-148">You can delete the VM after failback is complete.</span></span>
  * <span data-ttu-id="45403-149">**Cree un servidor de destino maestro**: este servidor envía y recibe datos de conmutación por recuperación.</span><span class="sxs-lookup"><span data-stu-id="45403-149">**Create a master target server**: The master target server sends and receives failback data.</span></span> <span data-ttu-id="45403-150">El servidor de administración que creó de forma local tiene instalado de forma predeterminada un servidor de destino principal.</span><span class="sxs-lookup"><span data-stu-id="45403-150">The management server that you created on-premises has a master target server that's installed by default.</span></span> <span data-ttu-id="45403-151">Sin embargo, según el volumen de tráfico conmutado por recuperación, puede que deba crear un servidor de destino principal distinto para esta operación.</span><span class="sxs-lookup"><span data-stu-id="45403-151">However, depending on the volume of failed-back traffic, you might need to create a separate master target server for failback.</span></span>
  * <span data-ttu-id="45403-152">Para crear un servidor de destino principal adicional que se ejecute en Linux, configure la máquina virtual de Linux antes de instalar al servidor de destino principal, como se describe más adelante.</span><span class="sxs-lookup"><span data-stu-id="45403-152">To create an additional master target server that runs on Linux, set up the Linux VM before you install the master target server, as described later.</span></span>
* <span data-ttu-id="45403-153">El servidor de configuración es necesario localmente cuando realiza una conmutación por recuperación.</span><span class="sxs-lookup"><span data-stu-id="45403-153">A configuration server is required on-premises when you do a failback.</span></span> <span data-ttu-id="45403-154">Durante la conmutación por recuperación, la máquina virtual debe encontrarse en la base de datos del servidor de configuración.</span><span class="sxs-lookup"><span data-stu-id="45403-154">During failback, the virtual machine must exist in the configuration server database.</span></span> <span data-ttu-id="45403-155">Si la base de datos del servidor de configuración no contiene ninguna máquina virtual, no se puede realizar la conmutación por recuperación.</span><span class="sxs-lookup"><span data-stu-id="45403-155">If the configuration server database contains no VM, failback cannot succeed.</span></span> <span data-ttu-id="45403-156">Por lo tanto, asegúrese de realizar copias de seguridad programadas periódicas del servidor.</span><span class="sxs-lookup"><span data-stu-id="45403-156">Therefore, ensure that you make regular scheduled backups of your server.</span></span> <span data-ttu-id="45403-157">En caso de desastre, tiene que restaurarla con la misma dirección IP para que funcione la conmutación por recuperación.</span><span class="sxs-lookup"><span data-stu-id="45403-157">In a disaster, you need to restore it with the same IP address so that failback works.</span></span>
* <span data-ttu-id="45403-158">Establezca la opción disk.enableUUID=true de **Parámetros de configuración** de la máquina virtual de destino principal en VMware.</span><span class="sxs-lookup"><span data-stu-id="45403-158">Set the disk.enableUUID=true setting in **Configuration Parameters** of the master target VM in VMware.</span></span> <span data-ttu-id="45403-159">Si la fila no existe, agréguela.</span><span class="sxs-lookup"><span data-stu-id="45403-159">If this row does not exist, add it.</span></span> <span data-ttu-id="45403-160">Esta configuración es necesaria para proporcionar un identificador único universal (UUID) coherente para el archivo de disco de la máquina virtual (VMDK) para que este se monte correctamente.</span><span class="sxs-lookup"><span data-stu-id="45403-160">This setting is required to provide a consistent universally unique identifier (UUID) to the virtual machine disk (VMDK) file so that it is mounted correctly.</span></span>
* <span data-ttu-id="45403-161">Observe si se muestra la condición "Master target server cannot be storage vMotioned" (El servidor de destino principal no puede almacenarse en vMotion), que puede provocar un error en la conmutación por recuperación.</span><span class="sxs-lookup"><span data-stu-id="45403-161">Be aware of a "Master target server cannot be storage vMotioned" condition, which can cause the failback to fail.</span></span> <span data-ttu-id="45403-162">La máquina virtual no puede iniciarse porque no tiene disponibles los discos.</span><span class="sxs-lookup"><span data-stu-id="45403-162">The VM cannot come up because the disks aren't made available to it.</span></span>
* <span data-ttu-id="45403-163">Agregue una unidad, llamada unidad de retención, en el servidor de destino principal.</span><span class="sxs-lookup"><span data-stu-id="45403-163">Add a drive, called a retention drive, onto the master target server.</span></span> <span data-ttu-id="45403-164">Agregue un nuevo disco y formatee la unidad.</span><span class="sxs-lookup"><span data-stu-id="45403-164">Add a disk, and format the drive.</span></span>

## <a name="failback-policy"></a><span data-ttu-id="45403-165">Directiva de conmutación por recuperación</span><span class="sxs-lookup"><span data-stu-id="45403-165">Failback policy</span></span>
<span data-ttu-id="45403-166">Para volver a replicar en el entorno local, necesitará una directiva de conmutación por recuperación.</span><span class="sxs-lookup"><span data-stu-id="45403-166">To replicate back to on-premises, you need a failback policy.</span></span> <span data-ttu-id="45403-167">La directiva se crea automáticamente al crear una directiva de dirección de avance y se asocia automáticamente con el servidor de configuración.</span><span class="sxs-lookup"><span data-stu-id="45403-167">The policy is automatically created when you create a forward direction policy, and it is automatically associated with the configuration server.</span></span> <span data-ttu-id="45403-168">Esta directiva no es editable</span><span class="sxs-lookup"><span data-stu-id="45403-168">It is not editable.</span></span> <span data-ttu-id="45403-169">y tiene la siguiente configuración de replicación:</span><span class="sxs-lookup"><span data-stu-id="45403-169">The policy has the following replication settings:</span></span>

* <span data-ttu-id="45403-170">Umbral RPO = 15 minutos</span><span class="sxs-lookup"><span data-stu-id="45403-170">RPO threshold = 15 minutes</span></span>
* <span data-ttu-id="45403-171">Retención de punto de recuperación = 24 horas</span><span class="sxs-lookup"><span data-stu-id="45403-171">Recovery point retention = 24 hours</span></span>
* <span data-ttu-id="45403-172">Frecuencia de las instantáneas coherentes con la aplicación = 60 minutos</span><span class="sxs-lookup"><span data-stu-id="45403-172">App consistent snapshot frequency = 60 minutes</span></span>

 ![Configuración de replicación de la directiva de conmutación por recuperación](./media/site-recovery-failback-azure-to-vmware-new/failback-policy.png)

## <a name="set-up-a-process-server-in-azure"></a><span data-ttu-id="45403-174">Configuración de un servidor de procesos en Azure</span><span class="sxs-lookup"><span data-stu-id="45403-174">Set up a Process Server in Azure</span></span>
<span data-ttu-id="45403-175">Instale un servidor de procesos en Azure para que las máquinas virtuales de Azure puedan devolver los datos a un servidor de destino principal local.</span><span class="sxs-lookup"><span data-stu-id="45403-175">Install a Process Server in Azure so that the Azure VMs can send the data back to the on-premises master target server.</span></span>

<span data-ttu-id="45403-176">Si ha protegido las máquinas virtuales como recursos clásicos (es decir, la máquina virtual recuperada en Azure se creó usando el modelo de implementación clásico), necesitará un servidor de procesos clásico en Azure.</span><span class="sxs-lookup"><span data-stu-id="45403-176">If you have protected your virtual machines as classic resources (that is, the VM recovered in Azure is a VM that was created by using the classic deployment model), you need a Process Server in Azure.</span></span> <span data-ttu-id="45403-177">Si se han recuperado las máquinas virtuales con Azure Resource Manager como el tipo de implementación, el servidor de procesos debe tener el administrador de recursos como el tipo de implementación.</span><span class="sxs-lookup"><span data-stu-id="45403-177">If you have recovered the VMs with Azure Resource Manager as the deployment type, the Process Server must have Resource Manager as the deployment type.</span></span> <span data-ttu-id="45403-178">El tipo de implementación se selecciona mediante la red virtual de Azure en la que se implementa el servidor de procesos.</span><span class="sxs-lookup"><span data-stu-id="45403-178">The deployment type is selected by the Azure virtual network that you deploy the Process Server to.</span></span>

1. <span data-ttu-id="45403-179">En **Almacén** > **Configuración** > **Infraestructura de Site Recovery** (en **Administrar**) > **Servidores de configuración** (en **For VMware and Physical Machines** [Para VMware y máquinas físicas]), seleccione el servidor de configuración.</span><span class="sxs-lookup"><span data-stu-id="45403-179">In **Vault** > **Settings** > **Site Recovery Infrastructure** (under **Manage**) > **Configuration Servers** (under **For VMware and Physical Machines**), select the configuration server.</span></span>
2. <span data-ttu-id="45403-180">Haga clic en **Servidor de procesos**.</span><span class="sxs-lookup"><span data-stu-id="45403-180">Click **Process Server**.</span></span>

  ![Botón Servidor de procesos](./media/site-recovery-failback-azure-to-vmware-classic/add-processserver.png)
3. <span data-ttu-id="45403-182">Elija la opción de implementación del servidor de procesos **Deploy a failback process server in Azure** (Implementación de un servidor de procesos de conmutación por recuperación en Azure).</span><span class="sxs-lookup"><span data-stu-id="45403-182">Choose to deploy the Process Server as **Deploy a failback Process Server in Azure**.</span></span>
4. <span data-ttu-id="45403-183">Seleccione la suscripción en la que se han recuperado las máquinas virtuales.</span><span class="sxs-lookup"><span data-stu-id="45403-183">Select the subscription that you have recovered the VMs to.</span></span>
5. <span data-ttu-id="45403-184">Seleccione la red de Azure en la que se han recuperado las máquinas virtuales.</span><span class="sxs-lookup"><span data-stu-id="45403-184">Select the Azure network that you have recovered the VMs to.</span></span> <span data-ttu-id="45403-185">El servidor de procesos debe estar en la misma red para que las máquinas virtuales recuperadas y el servidor de procesos puedan comunicarse.</span><span class="sxs-lookup"><span data-stu-id="45403-185">The Process Server needs to be in the same network so that the recovered VMs and the Process Server can communicate.</span></span>
6. <span data-ttu-id="45403-186">Si ha seleccionado una red de *modelo de implementación clásica*, cree una máquina virtual con Azure Marketplace y después instale en ella el servidor de procesos.</span><span class="sxs-lookup"><span data-stu-id="45403-186">If you selected a *classic deployment model* network, create a VM via the Azure Marketplace, and then install the Process Server in it.</span></span>

 ![Ventana "Agregar servidores de procesos"](./media/site-recovery-failback-azure-to-vmware-classic/add-classic.png)

 <span data-ttu-id="45403-188">Dado que está creando el servidor de procesos, preste atención a lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="45403-188">As you're creating the Process Server, pay attention to the following:</span></span>
 * <span data-ttu-id="45403-189">El nombre de la imagen es *Microsoft Azure Site Recovery Process Server V2*(Servidor de procesos de Microsoft Azure Site Recovery, versión 2).</span><span class="sxs-lookup"><span data-stu-id="45403-189">The name of the image is *Microsoft Azure Site Recovery Process Server V2*.</span></span> <span data-ttu-id="45403-190">Seleccione **Clásico** como el modelo de implementación.</span><span class="sxs-lookup"><span data-stu-id="45403-190">Select **Classic** as the deployment model.</span></span>

       ![Select "Classic" as the Process Server deployment model](./media/site-recovery-failback-azure-to-vmware-classic/templatename.png)
 * <span data-ttu-id="45403-191">Instale el servidor de procesos siguiendo las instrucciones de [Replicación de máquinas virtuales de VMware y servidores físicos en Azure con Azure Site Recovery](site-recovery-vmware-to-azure-classic.md).</span><span class="sxs-lookup"><span data-stu-id="45403-191">Install the Process Server according to the instructions in [Replicate VMware virtual machines and physical servers to Azure with Azure Site Recovery](site-recovery-vmware-to-azure-classic.md).</span></span>
7. <span data-ttu-id="45403-192">Si selecciona la red de Azure *Resource Manager*, implemente el servidor de procesos indicando la siguiente información:</span><span class="sxs-lookup"><span data-stu-id="45403-192">If you select the *Resource Manager* Azure network, deploy the Process Server by providing the following information:</span></span>

  * <span data-ttu-id="45403-193">El nombre del grupo de recursos en el que desea implementar el servidor.</span><span class="sxs-lookup"><span data-stu-id="45403-193">The name of the resource group that you want to deploy the server to</span></span>
  * <span data-ttu-id="45403-194">El nombre del servidor.</span><span class="sxs-lookup"><span data-stu-id="45403-194">The name of the server</span></span>
  * <span data-ttu-id="45403-195">Un nombre de usuario y una contraseña para iniciar sesión en el servidor.</span><span class="sxs-lookup"><span data-stu-id="45403-195">A username and password for signing in to the server</span></span>
  * <span data-ttu-id="45403-196">La cuenta de almacenamiento en la que desea implementar el servidor.</span><span class="sxs-lookup"><span data-stu-id="45403-196">The storage account that you want to deploy the server to</span></span>
  * <span data-ttu-id="45403-197">La subred y la interfaz de red a las que quiere conectarla.</span><span class="sxs-lookup"><span data-stu-id="45403-197">The subnet and the network interface that you want to connect to it</span></span>
   >[!NOTE]
   ><span data-ttu-id="45403-198">Debe crear su propia [interfaz de red](../virtual-network/virtual-networks-multiple-nics.md) (NIC) y seleccionarla durante la implementación del servidor de procesos.</span><span class="sxs-lookup"><span data-stu-id="45403-198">You must create your own [network interface](../virtual-network/virtual-networks-multiple-nics.md) (NIC) and select it while you are deploying the Process Server.</span></span>

    ![Escribir la información en el cuadro de diálogo "Agregar servidor de procesos"](./media/site-recovery-failback-azure-to-vmware-classic/psinputsadd.png)

8. <span data-ttu-id="45403-200">Haga clic en **Aceptar**.</span><span class="sxs-lookup"><span data-stu-id="45403-200">Click **OK**.</span></span> <span data-ttu-id="45403-201">Esta acción desencadena un trabajo que crea una máquina virtual con el tipo de implementación de Resource Manager durante la instalación del servidor de procesos.</span><span class="sxs-lookup"><span data-stu-id="45403-201">This action triggers a job that creates a Resource Manager deployment type virtual machine during the Process Server setup.</span></span> <span data-ttu-id="45403-202">Para registrar el servidor en el servidor de configuración, ejecute el programa de instalación dentro de la máquina virtual siguiendo las instrucciones de [Replicación de máquinas virtuales de VMware y servidores físicos en Azure con Azure Site Recovery](site-recovery-vmware-to-azure-classic.md).</span><span class="sxs-lookup"><span data-stu-id="45403-202">To register the server to the configuration server, run the setup inside the VM by following the instructions in [Replicate VMware virtual machines and physical servers to Azure with Azure Site Recovery](site-recovery-vmware-to-azure-classic.md).</span></span> <span data-ttu-id="45403-203">Se desencadenará también un trabajo para implementar el servidor de procesos.</span><span class="sxs-lookup"><span data-stu-id="45403-203">A job to deploy the Process Server is also triggered.</span></span>

  <span data-ttu-id="45403-204">El servidor de procesos aparece en la pestaña **Servidores de configuración** > **Servidores asociados** > **Servidores de procesos**.</span><span class="sxs-lookup"><span data-stu-id="45403-204">The Process Server is listed on the **Configuration servers** > **Associated servers** > **Process Servers** tab.</span></span>

    ![](./media/site-recovery-failback-azure-to-vmware-new/pslistingincs.png)

    > [!NOTE]
    > <span data-ttu-id="45403-205">El servidor de procesos no está visible en **Propiedades de la máquina virtual**.</span><span class="sxs-lookup"><span data-stu-id="45403-205">The Process Server isn't visible under **VM properties**.</span></span> <span data-ttu-id="45403-206">Solo está visible en la pestaña **Servidores** del servidor de administración en el que está registrado.</span><span class="sxs-lookup"><span data-stu-id="45403-206">It's visible only on the **Servers** tab in the management server that it's registered to.</span></span> <span data-ttu-id="45403-207">Puede tardar entre 10 y 15 minutos en aparecer el servidor de procesos.</span><span class="sxs-lookup"><span data-stu-id="45403-207">It can take 10 to 15 minutes for the Process Server to appear.</span></span>


## <a name="set-up-the-master-target-server-on-premises"></a><span data-ttu-id="45403-208">Configuración del servidor de destino maestro local</span><span class="sxs-lookup"><span data-stu-id="45403-208">Set up the master target server on-premises</span></span>
<span data-ttu-id="45403-209">El servidor de destino maestro recibe los datos de conmutación por recuperación.</span><span class="sxs-lookup"><span data-stu-id="45403-209">The master target server receives the failback data.</span></span> <span data-ttu-id="45403-210">El servidor se instala automáticamente en el servidor de administración local, pero si va a conmutar por recuperación muchos datos, puede que tenga que configurar un servidor de destino principal adicional.</span><span class="sxs-lookup"><span data-stu-id="45403-210">The server is automatically installed on the on-premises management server, but if you're failing back too much data, you might need to set up an additional master target server.</span></span> <span data-ttu-id="45403-211">Para configurar un servidor de destino maestro local, haga lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="45403-211">To set up a master target server on-premises, do the following:</span></span>

> [!NOTE]
> <span data-ttu-id="45403-212">Para configurar un servidor de destino principal en Linux, vaya al procedimiento siguiente.</span><span class="sxs-lookup"><span data-stu-id="45403-212">To set up a master target server on Linux, skip to the next procedure.</span></span> <span data-ttu-id="45403-213">Use solo el sistema operativo mínimo CentOS 6.6 como el sistema operativo de destino principal.</span><span class="sxs-lookup"><span data-stu-id="45403-213">Use only CentOS 6.6 minimal operating system as the master target OS.</span></span>

1. <span data-ttu-id="45403-214">Si está configurando el servidor de destino principal en Windows, abra la página de inicio rápido de la máquina virtual en la que está instalando el servidor de destino principal.</span><span class="sxs-lookup"><span data-stu-id="45403-214">If you're setting up the master target server on Windows, open the quick-start page from the VM that you're installing the master target server on.</span></span>
2. <span data-ttu-id="45403-215">Descargue el archivo de instalación del Asistente para instalación unificada de Azure Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="45403-215">Download the installation file for the Azure Site Recovery Unified Setup wizard.</span></span>
3. <span data-ttu-id="45403-216">Ejecute el programa de instalación y, en **Antes de comenzar**, seleccione **Add additional process servers to scale out deployment** (Agregar servidores de procesos adicionales para el escalado horizontal de la implementación).</span><span class="sxs-lookup"><span data-stu-id="45403-216">Run the setup and, in **Before you begin**, select **Add additional Process Servers to scale out deployment**.</span></span>
4. <span data-ttu-id="45403-217">Complete el asistente tal y como hizo cuando [instaló el servidor de administración](site-recovery-vmware-to-azure-classic.md).</span><span class="sxs-lookup"><span data-stu-id="45403-217">Complete the wizard in the same way you did when you [set up the management server](site-recovery-vmware-to-azure-classic.md).</span></span> <span data-ttu-id="45403-218">En la página **Configuration Server Details** (Detalles del servidor de configuración), especifique la dirección IP de este servidor de destino principal y una frase de contraseña para acceder a la máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="45403-218">On the **Configuration Server Details** page, specify the IP address of the master target server, and enter a passphrase to access the VM.</span></span>

### <a name="set-up-a-linux-vm-as-the-master-target-server"></a><span data-ttu-id="45403-219">Configuración de una máquina virtual de Linux como servidor de destino maestro</span><span class="sxs-lookup"><span data-stu-id="45403-219">Set up a Linux VM as the master target server</span></span>
<span data-ttu-id="45403-220">Para configurar el servidor de administración que ejecuta el servidor de destino principal como una máquina virtual de Linux, instale el sistema operativo mínimo CentOS 6.6.</span><span class="sxs-lookup"><span data-stu-id="45403-220">To set up the management server running the master target server as a Linux VM, install the CentOS 6.6 minimal operating system.</span></span> <span data-ttu-id="45403-221">A continuación, recupere los identificadores de SCSI para todos los discos duros SCSI, instale paquetes adicionales y aplique cambios personalizados.</span><span class="sxs-lookup"><span data-stu-id="45403-221">Next, retrieve the SCSI IDs for each SCSI hard disk, install some additional packages, and apply some custom changes.</span></span>

#### <a name="install-centos-66"></a><span data-ttu-id="45403-222">Instalación de CentOS 6.6</span><span class="sxs-lookup"><span data-stu-id="45403-222">Install CentOS 6.6</span></span>

1. <span data-ttu-id="45403-223">Instale el sistema operativo mínimo CentOS 6.6 en la máquina virtual del servidor de administración.</span><span class="sxs-lookup"><span data-stu-id="45403-223">Install the CentOS 6.6 minimal operating system on the management server VM.</span></span> <span data-ttu-id="45403-224">Guarde la imagen ISO en una unidad de DVD y arranque el sistema.</span><span class="sxs-lookup"><span data-stu-id="45403-224">Keep the ISO on a DVD drive, and boot the system.</span></span> <span data-ttu-id="45403-225">Omita la comprobación de medios físicos.</span><span class="sxs-lookup"><span data-stu-id="45403-225">Skip the media testing.</span></span> <span data-ttu-id="45403-226">Seleccione **Inglés de Estados Unidos** como el idioma, elija **Basic Storage Devices** (Dispositivos de almacenamiento básico), compruebe que el disco duro no tenga información importante, haga clic en **Sí** y descarte los datos.</span><span class="sxs-lookup"><span data-stu-id="45403-226">Select **US English** as the language, select **Basic Storage Devices**, check that the hard drive doesn’t have any important data, click **Yes**, and discard any data.</span></span> <span data-ttu-id="45403-227">Escriba el nombre de host del servidor de administración y seleccione el adaptador de red del servidor.</span><span class="sxs-lookup"><span data-stu-id="45403-227">Enter the host name of the management server, and select the server network adapter.</span></span>  <span data-ttu-id="45403-228">En el cuadro de diálogo **Editing System** (Sistema de edición), seleccione **Conectar automáticamente** y agregue una dirección IP estática, una red y parámetros de configuración de DNS.</span><span class="sxs-lookup"><span data-stu-id="45403-228">In the **Editing System** dialog box, select **Connect automatically**, and then add a static IP address, network, and DNS settings.</span></span> <span data-ttu-id="45403-229">Especifique una zona horaria.</span><span class="sxs-lookup"><span data-stu-id="45403-229">Specify a time zone.</span></span> <span data-ttu-id="45403-230">Para tener acceso al servidor de administración, escriba la contraseña raíz.</span><span class="sxs-lookup"><span data-stu-id="45403-230">To access the management server, enter the root password.</span></span>
2. <span data-ttu-id="45403-231">Cuando se le pregunte por el tipo de instalación que quiere, seleccione **Create Custom Layout** (Crear diseño personalizado) como partición.</span><span class="sxs-lookup"><span data-stu-id="45403-231">When you're asked what type of installation you want, select **Create Custom Layout** as the partition.</span></span> <span data-ttu-id="45403-232">Haga clic en **Siguiente**.</span><span class="sxs-lookup"><span data-stu-id="45403-232">Click **Next**.</span></span> <span data-ttu-id="45403-233">Seleccione **Libre** y, a continuación, haga clic en **Crear**.</span><span class="sxs-lookup"><span data-stu-id="45403-233">Select **Free**, and then click **Create**.</span></span> <span data-ttu-id="45403-234">Cree **/**, **/var/crash** y **/home partitions** con **FS Type:** **ext4**.</span><span class="sxs-lookup"><span data-stu-id="45403-234">Create **/**,  **/var/crash**, and **/home partitions** with **FS Type:** **ext4**.</span></span> <span data-ttu-id="45403-235">Cree la partición de intercambio como **FS Type: swap**(Tipo FS: intercambio).</span><span class="sxs-lookup"><span data-stu-id="45403-235">Create the swap partition as **FS Type: swap**.</span></span>
3. <span data-ttu-id="45403-236">Si se encuentran dispositivos ya existentes, aparecerá un mensaje de advertencia.</span><span class="sxs-lookup"><span data-stu-id="45403-236">If pre-existing devices are found, a warning message appears.</span></span> <span data-ttu-id="45403-237">Haga clic en **Formato** para formatear la unidad con la configuración de partición.</span><span class="sxs-lookup"><span data-stu-id="45403-237">Click **Format** to format the drive with the partition settings.</span></span> <span data-ttu-id="45403-238">Haga clic en **Write change to disk** (Escribir cambios en el disco) para aplicar los cambios de partición.</span><span class="sxs-lookup"><span data-stu-id="45403-238">Click **Write change to disk** to apply the partition changes.</span></span>
4. <span data-ttu-id="45403-239">Seleccione **Install boot loader (Instalar cargador de arranque)** > **Siguiente** para instalar el cargador de arranque en la partición raíz.</span><span class="sxs-lookup"><span data-stu-id="45403-239">Select **Install boot loader** > **Next** to install the boot loader on the root partition.</span></span>
5. <span data-ttu-id="45403-240">Cuando la instalación se haya completado, haga clic en **Reiniciar**.</span><span class="sxs-lookup"><span data-stu-id="45403-240">When the installation is complete, click **Reboot**.</span></span>

#### <a name="retrieve-the-scsi-ids"></a><span data-ttu-id="45403-241">Recuperación de los id. SCSI</span><span class="sxs-lookup"><span data-stu-id="45403-241">Retrieve the SCSI IDs</span></span>

1. <span data-ttu-id="45403-242">Después de la instalación, recupere los identificadores SCSI de cada disco duro SCSI de la máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="45403-242">After the installation, retrieve the SCSI IDs for each SCSI hard disk in the VM.</span></span> <span data-ttu-id="45403-243">Para ello, apague la máquina virtual del servidor de administración.</span><span class="sxs-lookup"><span data-stu-id="45403-243">To do so, shut down the management server VM.</span></span> <span data-ttu-id="45403-244">En las propiedades de la máquina virtual en VMware, haga clic con el botón derecho en la entrada de la máquina virtual > **Editar configuración** > **Opciones**.</span><span class="sxs-lookup"><span data-stu-id="45403-244">In the VM properties in VMware, right-click the VM entry > **Edit Settings** > **Options**.</span></span>
2. <span data-ttu-id="45403-245">Seleccione **Avanzadas** > **General item** (Elemento general) y haga clic en **Configuration Parameters** (Parámetros de configuración).</span><span class="sxs-lookup"><span data-stu-id="45403-245">Select **Advanced** > **General item**, and then click **Configuration Parameters**.</span></span> <span data-ttu-id="45403-246">Esta opción no estará disponible cuando se ejecute la máquina.</span><span class="sxs-lookup"><span data-stu-id="45403-246">This option is unavailable when the machine is running.</span></span> <span data-ttu-id="45403-247">Para que la opción esté disponible, debe apagar la máquina.</span><span class="sxs-lookup"><span data-stu-id="45403-247">For the option to be available, the machine must be shut down.</span></span>
3. <span data-ttu-id="45403-248">Realice cualquiera de las siguientes acciones:</span><span class="sxs-lookup"><span data-stu-id="45403-248">Do either of the following:</span></span>
 * <span data-ttu-id="45403-249">Si existe la fila **disk.EnableUUID**, asegúrese de que el valor esté establecido en **True** (distingue mayúsculas de minúsculas).</span><span class="sxs-lookup"><span data-stu-id="45403-249">If the row **disk.EnableUUID** exists, make sure that the value is set to **True** (case sensitive).</span></span> <span data-ttu-id="45403-250">Si el valor ya está establecido en True, puede cancelar y probar el comando SCSI en un sistema operativo invitado después de arrancar.</span><span class="sxs-lookup"><span data-stu-id="45403-250">If the value is already set to True, you can cancel and test the SCSI command inside a guest operating system after it’s booted.</span></span>
 * <span data-ttu-id="45403-251">Si la fila **disk.EnableUUID** no existe, haga clic en **Agregar fila** y agréguela con el valor **True**.</span><span class="sxs-lookup"><span data-stu-id="45403-251">If the row **disk.EnableUUID** doesn’t exist, click **Add Row**, and then add it with the **True** value.</span></span> <span data-ttu-id="45403-252">No utilice comillas dobles.</span><span class="sxs-lookup"><span data-stu-id="45403-252">Don’t use double quotation marks.</span></span>

#### <a name="install-additional-packages"></a><span data-ttu-id="45403-253">Instalación de paquetes adicionales</span><span class="sxs-lookup"><span data-stu-id="45403-253">Install additional packages</span></span>
<span data-ttu-id="45403-254">Descargue e instale los paquetes adicionales.</span><span class="sxs-lookup"><span data-stu-id="45403-254">Download and install additional packages.</span></span>

1. <span data-ttu-id="45403-255">Asegúrese de que el servidor de destino maestro esté conectado a Internet.</span><span class="sxs-lookup"><span data-stu-id="45403-255">Make sure the master target server is connected to the Internet.</span></span>
2. <span data-ttu-id="45403-256">Para descargar e instalar 15 paquetes desde el repositorio de CentOS, ejecute este comando: `# yum install –y xfsprogs perl lsscsi rsync wget kexec-tools`.</span><span class="sxs-lookup"><span data-stu-id="45403-256">To download and install 15 packages from the CentOS repository, run this command: `# yum install –y xfsprogs perl lsscsi rsync wget kexec-tools`.</span></span>
3. <span data-ttu-id="45403-257">Si las máquinas de origen que va a proteger ejecutan Linux con el sistema de archivos Reiser o XFS en el dispositivo raíz o de arranque, descargue e instale paquetes adicionales de la manera siguiente:</span><span class="sxs-lookup"><span data-stu-id="45403-257">If the source machines you’re protecting are running Linux with a Reiser or XFS file system for the root or boot device, download and install additional packages as follows:</span></span>

   * <span data-ttu-id="45403-258">\# cd /usr/local</span><span class="sxs-lookup"><span data-stu-id="45403-258">\# cd /usr/local</span></span>
   * <span data-ttu-id="45403-259">\# wget [http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/kmod-reiserfs-0.0-1.el6.elrepo.x86_64.rpm](http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/kmod-reiserfs-0.0-1.el6.elrepo.x86_64.rpm)</span><span class="sxs-lookup"><span data-stu-id="45403-259">\# wget [http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/kmod-reiserfs-0.0-1.el6.elrepo.x86_64.rpm](http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/kmod-reiserfs-0.0-1.el6.elrepo.x86_64.rpm)</span></span>
   * <span data-ttu-id="45403-260">\# wget [http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/reiserfs-utils-3.6.21-1.el6.elrepo.x86_64.rpm](http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/reiserfs-utils-3.6.21-1.el6.elrepo.x86_64.rpm)</span><span class="sxs-lookup"><span data-stu-id="45403-260">\# wget [http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/reiserfs-utils-3.6.21-1.el6.elrepo.x86_64.rpm](http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/reiserfs-utils-3.6.21-1.el6.elrepo.x86_64.rpm)</span></span>
   * <span data-ttu-id="45403-261">\#rpm –ivh kmod-reiserfs-0.0-1.el6.elrepo.x86_64.rpm reiserfs-utils-3.6.21-1.el6.elrepo.x86_64.rpm</span><span class="sxs-lookup"><span data-stu-id="45403-261">\# rpm –ivh kmod-reiserfs-0.0-1.el6.elrepo.x86_64.rpm reiserfs-utils-3.6.21-1.el6.elrepo.x86_64.rpm</span></span>
   * <span data-ttu-id="45403-262">\#wget [http://mirror.centos.org/centos/6.6/os/x86_64/Packages/xfsprogs-3.1.1-16.el6.x86_65.rpm](http://mirror.centos.org/centos/6.6/os/x86_64/Packages/xfsprogs-3.1.1-16.el6.x86_65.rpm)</span><span class="sxs-lookup"><span data-stu-id="45403-262">\# wget [http://mirror.centos.org/centos/6.6/os/x86_64/Packages/xfsprogs-3.1.1-16.el6.x86_65.rpm](http://mirror.centos.org/centos/6.6/os/x86_64/Packages/xfsprogs-3.1.1-16.el6.x86_65.rpm)</span></span>
   * <span data-ttu-id="45403-263">\#rpm –ivh xfsprogs-3.1.1-16.el6.x86_64.rpm</span><span class="sxs-lookup"><span data-stu-id="45403-263">\# rpm –ivh xfsprogs-3.1.1-16.el6.x86_64.rpm</span></span>
   * <span data-ttu-id="45403-264">\# yum install device-mapper-multipath (se requiere para habilitar paquetes de múltiples rutas en el servidor de destino principal)</span><span class="sxs-lookup"><span data-stu-id="45403-264">\# yum install device-mapper-multipath (required to enable multipath packages on the master target server)</span></span>

#### <a name="apply-custom-changes"></a><span data-ttu-id="45403-265">Aplicación de cambios personalizados</span><span class="sxs-lookup"><span data-stu-id="45403-265">Apply custom changes</span></span>
<span data-ttu-id="45403-266">Después de haber completado los pasos posteriores a la instalación y haber instalado los paquetes, aplique los cambios personalizados realizando estos pasos:</span><span class="sxs-lookup"><span data-stu-id="45403-266">After you’ve completed the post-installation steps and installed the packages, apply custom changes by doing the following:</span></span>

1. <span data-ttu-id="45403-267">Copie al binario de RHEL 6-64 Unified Agent en la máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="45403-267">Copy the RHEL 6-64 Unified Agent binary to the VM.</span></span> <span data-ttu-id="45403-268">Ejecute este comando para descomprimir el archivo binario: `tar –zxvf <file name>`.</span><span class="sxs-lookup"><span data-stu-id="45403-268">To untar the binary, run this command: `tar –zxvf <file name>`.</span></span>
2. <span data-ttu-id="45403-269">Para conceder permisos, ejecute este comando: `# chmod 755 ./ApplyCustomChanges.sh`.</span><span class="sxs-lookup"><span data-stu-id="45403-269">To give permissions, run this command: `# chmod 755 ./ApplyCustomChanges.sh`.</span></span>
3. <span data-ttu-id="45403-270">Ejecute el siguiente script: `# ./ApplyCustomChanges.sh`.</span><span class="sxs-lookup"><span data-stu-id="45403-270">Run the following script: `# ./ApplyCustomChanges.sh`.</span></span> <span data-ttu-id="45403-271">Ejecútelo una sola vez.</span><span class="sxs-lookup"><span data-stu-id="45403-271">Run it only once.</span></span> <span data-ttu-id="45403-272">Después de que el script se haya ejecutado correctamente, reinicie el servidor.</span><span class="sxs-lookup"><span data-stu-id="45403-272">After it runs successfully, reboot the server.</span></span>

## <a name="run-the-failback"></a><span data-ttu-id="45403-273">Ejecución de la conmutación por recuperación</span><span class="sxs-lookup"><span data-stu-id="45403-273">Run the failback</span></span>
### <a name="reprotect-the-azure-vms"></a><span data-ttu-id="45403-274">Reprotección de las máquinas virtuales de Azure</span><span class="sxs-lookup"><span data-stu-id="45403-274">Reprotect the Azure VMs</span></span>
1. <span data-ttu-id="45403-275">En **Almacén** > **Elementos replicados**, haga clic con el botón derecho en máquina virtual que ha sido objeto de la conmutación por error y seleccione **Reproteger**.</span><span class="sxs-lookup"><span data-stu-id="45403-275">In **Vault**, in **Replicated items**, right-click the VM that has been failed over, and then select **Re-Protect**.</span></span>
2. <span data-ttu-id="45403-276">En la hoja, puede ver que la dirección de protección **De Azure a local** ya está seleccionada.</span><span class="sxs-lookup"><span data-stu-id="45403-276">On the blade, you can see that the direction of protection **Azure to On-premises** is already selected.</span></span>
3. <span data-ttu-id="45403-277">En **Servidor de destino maestro** y **Servidor de procesos**, seleccione el servidor de destino maestro local y el servidor de procesos de la máquina virtual de Azure.</span><span class="sxs-lookup"><span data-stu-id="45403-277">In **Master Target Server** and **Process Server**, select the on-premises master target server and the Azure VM Process Server.</span></span>
4. <span data-ttu-id="45403-278">Seleccione el almacén de datos en el que desea recuperar los discos en el entorno local.</span><span class="sxs-lookup"><span data-stu-id="45403-278">Select the datastore that you want to recover the disks on-premises to.</span></span> <span data-ttu-id="45403-279">Use esta cuando elimine la máquina virtual local y sea necesario crear discos nuevos.</span><span class="sxs-lookup"><span data-stu-id="45403-279">Use this option when the on-premises VM is deleted and you need to create new disks.</span></span> <span data-ttu-id="45403-280">Omita esta opción si los discos ya existen, pero debe especificar un valor.</span><span class="sxs-lookup"><span data-stu-id="45403-280">Ignore the option if the disks already exist, but you still need to specify a value.</span></span>
5. <span data-ttu-id="45403-281">Utilice una unidad de retención para detener los puntos en el tiempo cuando la máquina virtual se replica en local.</span><span class="sxs-lookup"><span data-stu-id="45403-281">Use a retention drive to stop the points in time when the VM is replicated back to on-premises.</span></span> <span data-ttu-id="45403-282">A continuación se enumeran algunos criterios de una unidad de retención.</span><span class="sxs-lookup"><span data-stu-id="45403-282">Some criteria of a retention drive are listed here.</span></span> <span data-ttu-id="45403-283">Sin estos criterios no se muestra la unidad para el servidor de destino maestro.</span><span class="sxs-lookup"><span data-stu-id="45403-283">Without these criteria, the drive is not listed for the master target server.</span></span>

  * <span data-ttu-id="45403-284">El volumen no debe utilizarse para ningún otro propósito (destino de replicación, etc.).</span><span class="sxs-lookup"><span data-stu-id="45403-284">Volume shouldn't be in use for any other purpose (target of replication, and so forth).</span></span>
  * <span data-ttu-id="45403-285">El volumen no debe estar en modo de bloqueo.</span><span class="sxs-lookup"><span data-stu-id="45403-285">Volume shouldn't be in lock mode.</span></span>
  * <span data-ttu-id="45403-286">El volumen no debe ser el volumen de memoria caché.</span><span class="sxs-lookup"><span data-stu-id="45403-286">Volume shouldn't be cache volume.</span></span> <span data-ttu-id="45403-287">(La instalación del destino maestro no debe existir en dicho volumen.</span><span class="sxs-lookup"><span data-stu-id="45403-287">(The master target installation shouldn't exist on that volume.</span></span> <span data-ttu-id="45403-288">El volumen de instalación personalizada del servidor de procesos con destino maestro no es apto para el volumen de retención.</span><span class="sxs-lookup"><span data-stu-id="45403-288">The Process Server plus master target custom installation volume is not eligible for retention volume.</span></span> <span data-ttu-id="45403-289">En este caso, el volumen de servidor de procesos con destino maestro es el volumen de caché del destino maestro).</span><span class="sxs-lookup"><span data-stu-id="45403-289">Here, the installed Process Server plus master target volume is the cache volume of the master target.)</span></span>
  * <span data-ttu-id="45403-290">El tipo de sistema de archivos de volumen no debe ser FAT ni FAT32.</span><span class="sxs-lookup"><span data-stu-id="45403-290">The volume file system type shouldn't be FAT and FAT32.</span></span>
  * <span data-ttu-id="45403-291">La capacidad del volumen debe ser distinta de cero.</span><span class="sxs-lookup"><span data-stu-id="45403-291">The volume capacity should be non-zero.</span></span>
  * <span data-ttu-id="45403-292">El volumen de retención predeterminado para Windows es el volumen R.</span><span class="sxs-lookup"><span data-stu-id="45403-292">The default retention volume for Windows is R volume.</span></span>
  * <span data-ttu-id="45403-293">El volumen de retención predeterminado para Linux es /mnt/retention.</span><span class="sxs-lookup"><span data-stu-id="45403-293">The default retention volume for Linux is /mnt/retention.</span></span>

6. <span data-ttu-id="45403-294">La directiva de conmutación por recuperación se selecciona automáticamente.</span><span class="sxs-lookup"><span data-stu-id="45403-294">The failback policy is automatically selected.</span></span>
7. <span data-ttu-id="45403-295">Tras hacer clic en **Aceptar** para comenzar la reprotección, comienza un trabajo para replicar la máquina virtual de Azure en el sitio local.</span><span class="sxs-lookup"><span data-stu-id="45403-295">After you click **OK** to begin reprotection, a job begins to replicate the VM from Azure to the on-premises site.</span></span> <span data-ttu-id="45403-296">Puede realizar el seguimiento del progreso en la pestaña **Trabajos** .</span><span class="sxs-lookup"><span data-stu-id="45403-296">You can track the progress on the **Jobs** tab.</span></span>

<span data-ttu-id="45403-297">Si desea recuperar en una ubicación alternativa, seleccione la unidad de retención y el almacén de datos configurado para el servidor de destino maestro.</span><span class="sxs-lookup"><span data-stu-id="45403-297">If you want to recover to an alternate location, select the retention drive and datastore that are configured for the master target server.</span></span> <span data-ttu-id="45403-298">Cuando se conmuta por recuperación al sitio local, las máquinas virtuales de VMware del plan de protección de conmutación por recuperación utilizarán el mismo almacén de datos que el servidor de destino maestro.</span><span class="sxs-lookup"><span data-stu-id="45403-298">When you fail back to the on-premises site, the VMware VMs in the failback protection plan use the same datastore as the master target server.</span></span> <span data-ttu-id="45403-299">Si desea recuperar la réplica de la máquina virtual de Azure en la misma máquina virtual local, la máquina virtual local ya debe estar en el mismo almacén de datos que el servidor de destino maestro.</span><span class="sxs-lookup"><span data-stu-id="45403-299">If you want to recover the replica Azure VM to the same on-premises VM, the on-premises VM should already be in the same datastore as the master target server.</span></span> <span data-ttu-id="45403-300">Si no hay ninguna máquina virtual local, se creará una nueva durante la reprotección.</span><span class="sxs-lookup"><span data-stu-id="45403-300">If there's no VM on-premises, a new one is created during reprotection.</span></span>

![Seleccione "Azure a local" en el menú desplegable](./media/site-recovery-failback-azure-to-vmware-new/reprotectinputs.png)

<span data-ttu-id="45403-302">También puede volver a proteger a nivel de un plan de recuperación.</span><span class="sxs-lookup"><span data-stu-id="45403-302">You can also reprotect at a recovery plan level.</span></span> <span data-ttu-id="45403-303">Si tiene un grupo de replicación, este solo se puede volver a proteger con un plan de recuperación.</span><span class="sxs-lookup"><span data-stu-id="45403-303">If you have a replication group, you can reprotect it only by using a recovery plan.</span></span> <span data-ttu-id="45403-304">Cuando vuelva a proteger con un plan de recuperación, utilice los valores anteriores para todos los equipos protegidos.</span><span class="sxs-lookup"><span data-stu-id="45403-304">When you reprotect by using a recovery plan, use the previous values for every protected machine.</span></span>

> [!NOTE]
> <span data-ttu-id="45403-305">Los grupos de replicación deben volver a protegerse con el mismo destino maestro.</span><span class="sxs-lookup"><span data-stu-id="45403-305">Replication groups should be protected back with the same master target.</span></span> <span data-ttu-id="45403-306">Si se han vuelto a proteger con servidores de destino maestro distintos, no se puede determinar un momento dado común para ellos.</span><span class="sxs-lookup"><span data-stu-id="45403-306">If they are protected back with different master target servers, a common point in time cannot be determined for them.</span></span>

### <a name="run-a-failover-to-the-on-premises-site"></a><span data-ttu-id="45403-307">Ejecución de una conmutación por error en el sitio local</span><span class="sxs-lookup"><span data-stu-id="45403-307">Run a failover to the on-premises site</span></span>
<span data-ttu-id="45403-308">Después de volver a proteger una máquina virtual, puede iniciar una conmutación por error desde Azure a un sitio local.</span><span class="sxs-lookup"><span data-stu-id="45403-308">After you reprotect the VM, you can initiate a failover from Azure to on-premises.</span></span>

1. <span data-ttu-id="45403-309">En la página de elementos replicados, haga clic con el botón derecho en la máquina virtual y seleccione **Conmutación por error no planeada**.</span><span class="sxs-lookup"><span data-stu-id="45403-309">On the replicated items page, right-click the virtual machine, and then select **Unplanned Failover**.</span></span>
2. <span data-ttu-id="45403-310">En **Confirmar conmutación por error**, compruebe la dirección de conmutación por error (de Azure) y seleccione el punto de recuperación que quiere usar para la conmutación por error (el último o el último coherente con la aplicación).</span><span class="sxs-lookup"><span data-stu-id="45403-310">In **Confirm Failover**, verify the failover direction (from Azure), and then select the recovery point that you want to use for the failover (the latest, or the latest app-consistent recovery point).</span></span> <span data-ttu-id="45403-311">Un punto de recuperación coherente con la aplicación se produce antes del punto más reciente en el tiempo y provocará pérdida de datos.</span><span class="sxs-lookup"><span data-stu-id="45403-311">An app-consistent recovery point occurs before the most recent point in time, and it will cause some data loss.</span></span>
3. <span data-ttu-id="45403-312">Durante la conmutación por error, se cerrarán las máquinas virtuales de Azure en Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="45403-312">During failover, Site Recovery shuts down the Azure VMs.</span></span> <span data-ttu-id="45403-313">Después de comprobar que la conmutación por recuperación se ha completado como se esperaba, puede comprobar que las máquinas virtuales de Azure se han cerrado según lo previsto.</span><span class="sxs-lookup"><span data-stu-id="45403-313">After you check that failback has been completed as expected, you can check to ensure that the Azure VMs have been shut down as expected.</span></span>

### <a name="reprotect-the-on-premises-site"></a><span data-ttu-id="45403-314">Reprotección del sitio local</span><span class="sxs-lookup"><span data-stu-id="45403-314">Reprotect the on-premises site</span></span>
<span data-ttu-id="45403-315">Una vez finalizada la conmutación por recuperación, confirme la máquina virtual para asegurarse de que se eliminen las máquinas virtuales recuperadas en Azure.</span><span class="sxs-lookup"><span data-stu-id="45403-315">After failback has been completed, commit the virtual machine to ensure that the VMs recovered in Azure are deleted.</span></span> <span data-ttu-id="45403-316">Para ello, haga clic con el botón derecho en el elemento protegido y haga clic en **Confirmar**.</span><span class="sxs-lookup"><span data-stu-id="45403-316">To do so, right-click the protected item, and then click **Commit**.</span></span> <span data-ttu-id="45403-317">Esta acción desencadena un trabajo que quita las anteriores máquinas virtuales recuperadas en Azure.</span><span class="sxs-lookup"><span data-stu-id="45403-317">This action triggers a job that removes the former recovered virtual machines in Azure.</span></span>

<span data-ttu-id="45403-318">Una vez completada la confirmación, los datos deberían volver al sitio local, pero no estarán protegidos.</span><span class="sxs-lookup"><span data-stu-id="45403-318">After the commit is completed, your data should be back on the on-premises site, but it won’t be protected.</span></span> <span data-ttu-id="45403-319">Para volver a iniciar la replicación en Azure, vuelva a hacer lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="45403-319">To start replicating to Azure again, do the following:</span></span>

1. <span data-ttu-id="45403-320">En **Almacén** > **Configuración** > **Elementos replicados**, seleccione las máquinas virtuales que han sido objeto de la conmutación por recuperación y haga clic en **Reproteger**.</span><span class="sxs-lookup"><span data-stu-id="45403-320">In **Vault**, in **Setting** > **Replicated items**, select the VMs that have failed back, and then click **Re-Protect**.</span></span>
2. <span data-ttu-id="45403-321">Asigne el valor de servidor de procesos que debe utilizarse para volver a enviar datos a Azure.</span><span class="sxs-lookup"><span data-stu-id="45403-321">Give the value of the Process Server that needs to be used to send data back to Azure.</span></span>
3. <span data-ttu-id="45403-322">Haga clic en **Aceptar**.</span><span class="sxs-lookup"><span data-stu-id="45403-322">Click **OK**.</span></span>

<span data-ttu-id="45403-323">Una vez completada la reprotección, la máquina virtual se vuelve a replicar en Azure y puede realizar una conmutación por error.</span><span class="sxs-lookup"><span data-stu-id="45403-323">After the reprotection is complete, the VM replicates back to Azure and you can do a failover.</span></span>

### <a name="resolve-common-failback-issues"></a><span data-ttu-id="45403-324">Resolución de problemas habituales de la conmutación por recuperación</span><span class="sxs-lookup"><span data-stu-id="45403-324">Resolve common failback issues</span></span>
* <span data-ttu-id="45403-325">Si realiza la detección de usuarios de solo lectura de vCenter y protege las máquinas virtuales, se ejecutará correctamente y la conmutación por error funcionará.</span><span class="sxs-lookup"><span data-stu-id="45403-325">If you perform a read-only user vCenter discovery and protect virtual machines, it succeeds and failover works.</span></span> <span data-ttu-id="45403-326">Durante la reprotección, se produce un error de conmutación por error porque no se pueden detectar los almacenes de datos.</span><span class="sxs-lookup"><span data-stu-id="45403-326">During reprotection, failover fails because the datastores cannot be discovered.</span></span> <span data-ttu-id="45403-327">El síntoma de este problema es que no se ven los almacenes de datos enumerados durante la reprotección.</span><span class="sxs-lookup"><span data-stu-id="45403-327">As a symptom, you will not see the datastores listed during reprotection.</span></span> <span data-ttu-id="45403-328">Para resolverlo, puede actualizar las credenciales de vCenter con la cuenta adecuada que tenga permisos y tratar de realizar el trabajo de nuevo.</span><span class="sxs-lookup"><span data-stu-id="45403-328">To resolve this issue, you can update the vCenter credential with an appropriate account that has permissions and retry the job.</span></span> <span data-ttu-id="45403-329">Para obtener más información, consulte [Replicación de máquinas virtuales de VMware y servidores físicos en Azure con Azure Site Recovery](site-recovery-vmware-to-azure-classic.md).</span><span class="sxs-lookup"><span data-stu-id="45403-329">For more information, see [Replicate VMware virtual machines and physical servers to Azure with Azure Site Recovery](site-recovery-vmware-to-azure-classic.md)</span></span>
* <span data-ttu-id="45403-330">Cuando conmuta por recuperación una máquina virtual de Linux y la ejecuta localmente, verá que se ha desinstalado el paquete del administrador de red de la máquina.</span><span class="sxs-lookup"><span data-stu-id="45403-330">When you fail back a Linux VM and run it on-premises, you can see that the Network Manager package has been uninstalled from the machine.</span></span> <span data-ttu-id="45403-331">Esto se debe a que el paquete del administrador de red se elimina cuando se recupera la VM en Azure.</span><span class="sxs-lookup"><span data-stu-id="45403-331">This uninstallation happens because the Network Manager package is removed when the VM is recovered in Azure.</span></span>
* <span data-ttu-id="45403-332">Cuando una máquina virtual se configura con una dirección IP estática y se conmuta por error a Azure, se adquiere la dirección IP mediante DHCP.</span><span class="sxs-lookup"><span data-stu-id="45403-332">When a VM is configured with a static IP address and is failed over to Azure, the IP address is acquired via DHCP.</span></span> <span data-ttu-id="45403-333">Al conmutar por error a un entorno local, la VM seguirá utilizando DHCP para obtener la dirección IP.</span><span class="sxs-lookup"><span data-stu-id="45403-333">When you fail over back to on-premises, the VM continues to use DHCP to acquire the IP address.</span></span> <span data-ttu-id="45403-334">Inicie sesión manualmente en el equipo y vuelva a establecer la dirección IP en una dirección estática si es necesario.</span><span class="sxs-lookup"><span data-stu-id="45403-334">Manually sign in to the machine and set the IP address back to a static address if necessary.</span></span>
* <span data-ttu-id="45403-335">Si utiliza las ediciones gratuitas de ESXi 5.5 o vSphere Hypervisor 6, la conmutación por error se llevará a cabo correctamente, pero la conmutación por recuperación, no.</span><span class="sxs-lookup"><span data-stu-id="45403-335">If you are using either ESXi 5.5 free edition or vSphere 6 Hypervisor free edition, failover would succeed, but failback would not succeed.</span></span> <span data-ttu-id="45403-336">Para habilitar la conmutación por recuperación, tendrá que actualizar los programas con una licencia de evaluación.</span><span class="sxs-lookup"><span data-stu-id="45403-336">To enable failback, upgrade to either program's evaluation license.</span></span>
* <span data-ttu-id="45403-337">Si no puede ponerse en contacto con el servidor de configuración desde el servidor de procesos, compruebe la conectividad con el servidor de configuración por Telnet con el equipo del servidor de configuración en el puerto 443.</span><span class="sxs-lookup"><span data-stu-id="45403-337">If you cannot reach the configuration server from the Process Server, check connectivity to the configuration server by Telnet to the configuration server machine on port 443.</span></span> <span data-ttu-id="45403-338">También puede tratar de hacer ping en el servidor de configuración desde la máquina del servidor de procesos.</span><span class="sxs-lookup"><span data-stu-id="45403-338">You can also try to ping the configuration server from the Process Server machine.</span></span> <span data-ttu-id="45403-339">Un servidor de procesos debe tener también un latido cuando esté conectado al servidor de configuración.</span><span class="sxs-lookup"><span data-stu-id="45403-339">A Process Server should also have a heartbeat when it is connected to the configuration server.</span></span>
* <span data-ttu-id="45403-340">Si está tratando de realizar la conmutación por recuperación en un vCenter alternativo, asegúrese de que se detectan tanto el nuevo vCenter como el servidor de destino maestro.</span><span class="sxs-lookup"><span data-stu-id="45403-340">If you are trying to fail back to an alternate vCenter, make sure that your new vCenter is discovered and that the master target server is also discovered.</span></span> <span data-ttu-id="45403-341">Un síntoma típico es que los almacenes de datos no están accesibles ni visibles en el cuadro de diálogo de **Reprotect** (Reproteger).</span><span class="sxs-lookup"><span data-stu-id="45403-341">A typical symptom is that the datastores are not accessible or visible in the **Reprotect** dialog box.</span></span>
* <span data-ttu-id="45403-342">Las máquinas WS2008R2SP1 protegidas como máquinas físicas locales no pueden conmutar por recuperación desde Azure a un entorno local.</span><span class="sxs-lookup"><span data-stu-id="45403-342">A WS2008R2SP1 machine that is protected as a physical on-premises machine cannot be failed back from Azure to on-premises.</span></span>

## <a name="fail-back-with-expressroute"></a><span data-ttu-id="45403-343">Conmutación por recuperación con ExpressRoute</span><span class="sxs-lookup"><span data-stu-id="45403-343">Fail back with ExpressRoute</span></span>
<span data-ttu-id="45403-344">Puede conmutar por recuperación a través de una conexión VPN o usando una conexión ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="45403-344">You can fail back over a VPN connection or by using an ExpressRoute connection.</span></span> <span data-ttu-id="45403-345">Si desea usar ExpressRoute, tenga en cuenta lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="45403-345">If you want to use an ExpressRoute connection, note the following:</span></span>

* <span data-ttu-id="45403-346">La conexión ExpressRoute se debe configurar en la red virtual de Azure a la que conmutarán por error las máquinas de origen, y en la que se encuentran las máquinas virtuales de Azure después de que tenga lugar este proceso.</span><span class="sxs-lookup"><span data-stu-id="45403-346">The ExpressRoute connection should be set up on the Azure virtual network that the source machines fail over to and where the Azure VMs are located after the failover occurs.</span></span>
* <span data-ttu-id="45403-347">Los datos se replican en una cuenta de almacenamiento de Azure en un punto de conexión público.</span><span class="sxs-lookup"><span data-stu-id="45403-347">Data is replicated to an Azure storage account on a public endpoint.</span></span> <span data-ttu-id="45403-348">Para usar una conexión ExpressRoute, realice la configuración entre pares públicos en ExpressRoute con el centro de datos de destino para la replicación de Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="45403-348">To use an ExpressRoute connection, set up public peering in ExpressRoute with the target data center for Site Recovery replication.</span></span>
