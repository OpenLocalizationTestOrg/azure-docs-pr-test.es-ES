---
title: "Diseño de aplicaciones de alta disponibilidad mediante almacenamiento con redundancia geográfica con acceso de lectura (RA-GRS) | Microsoft Docs"
description: "Cómo usar el almacenamiento RA-GRS de Azure para diseñar una aplicación de alta disponibilidad lo bastante flexible como para enfrentarse a interrupciones."
services: storage
documentationcenter: .net
author: robinsh
manager: timlt
editor: tysonn
ms.assetid: 8f040b0f-8926-4831-ac07-79f646f31926
ms.service: storage
ms.workload: storage
ms.tgt_pltfrm: na
ms.devlang: dotnet
ms.topic: article
ms.date: 1/19/2017
ms.author: robinsh
ms.openlocfilehash: adc7e23d8c9f869f2951490020e3d0f1a2b2e81c
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 08/03/2017
---
# <a name="designing-highly-available-applications-using-ra-grs"></a><span data-ttu-id="e1251-103">Diseño de aplicaciones de alta disponibilidad mediante RA-GRS</span><span class="sxs-lookup"><span data-stu-id="e1251-103">Designing Highly Available Applications using RA-GRS</span></span>

<span data-ttu-id="e1251-104">Una característica común de las infraestructuras en la nube es que proporcionan una plataforma de alta disponibilidad para hospedar aplicaciones.</span><span class="sxs-lookup"><span data-stu-id="e1251-104">A common feature of cloud-based infrastructures is that they provide a highly available platform for hosting applications.</span></span> <span data-ttu-id="e1251-105">Los desarrolladores de aplicaciones basadas en la nube deben considerar cuidadosamente cómo aprovechar esta plataforma para entregar aplicaciones de alta disponibilidad a sus usuarios.</span><span class="sxs-lookup"><span data-stu-id="e1251-105">Developers of cloud-based applications must consider carefully how to leverage this platform to deliver highly available applications to their users.</span></span> <span data-ttu-id="e1251-106">Este artículo se centra específicamente en cómo los desarrolladores pueden usar el almacenamiento con redundancia geográfica con acceso de lectura (RA-GRS) de Azure para mejorar la disponibilidad de sus aplicaciones.</span><span class="sxs-lookup"><span data-stu-id="e1251-106">This article focuses specifically on how developers can use the Azure Storage Read Access Geo Redundant Storage (RA-GRS) to make their applications more available.</span></span>

<span data-ttu-id="e1251-107">Existen cuatro opciones de redundancia: LRS (almacenamiento con redundancia local), ZRS (almacenamiento con redundancia de zona), GRS (almacenamiento con redundancia geográfica) y RA-GRS (almacenamiento con redundancia geográfica con acceso de lectura).</span><span class="sxs-lookup"><span data-stu-id="e1251-107">There are four choices for redundancy – LRS (Locally Redundant Storage), ZRS (Zone Redundant Storage), GRS (Geo-Redundant Storage), and RA-GRS (Read Access Geo-Redundant Storage).</span></span> <span data-ttu-id="e1251-108">En este artículo se van a explicar GRS y RA-GRS.</span><span class="sxs-lookup"><span data-stu-id="e1251-108">We are going to discuss GRS and RA-GRS in this article.</span></span> <span data-ttu-id="e1251-109">Con GRS, se mantienen tres copias de los datos en la región primaria que seleccionó al configurar la cuenta de almacenamiento.</span><span class="sxs-lookup"><span data-stu-id="e1251-109">With GRS, three copies of your data are kept in the primary region you selected when setting up the storage account.</span></span> <span data-ttu-id="e1251-110">Se mantienen tres copias adicionales de forma asincrónica en una región secundaria especificada por Azure.</span><span class="sxs-lookup"><span data-stu-id="e1251-110">Three additional copies are maintained asynchronously in a secondary region specified by Azure.</span></span> <span data-ttu-id="e1251-111">RA-GRS es igual que GRS salvo en que tiene acceso de lectura a la copia secundaria.</span><span class="sxs-lookup"><span data-stu-id="e1251-111">RA-GRS is the same thing as GRS except that you have read access to the secondary copy.</span></span> <span data-ttu-id="e1251-112">Para más información sobre las distintas opciones de redundancia de Azure Storage, consulte [Replicación de Azure Storage](https://docs.microsoft.com/en-us/azure/storage/storage-redundancy).</span><span class="sxs-lookup"><span data-stu-id="e1251-112">For more information about the different Azure Storage redundancy options, see [Azure Storage replication](https://docs.microsoft.com/en-us/azure/storage/storage-redundancy).</span></span> <span data-ttu-id="e1251-113">En el artículo sobre replicación también se muestran los emparejamientos de regiones primarias y secundarias.</span><span class="sxs-lookup"><span data-stu-id="e1251-113">The replication article also shows the pairings of the primary and secondary regions.</span></span>

<span data-ttu-id="e1251-114">En este artículo se incluyen fragmentos de código y, al final, un vínculo a un ejemplo completo que puede descargar y ejecutar.</span><span class="sxs-lookup"><span data-stu-id="e1251-114">There are code snippets included in this article, and a link to a complete sample at the end that you can download and run.</span></span>

## <a name="key-features-of-ra-grs"></a><span data-ttu-id="e1251-115">Características fundamentales de RA-GRS</span><span class="sxs-lookup"><span data-stu-id="e1251-115">Key features of RA-GRS</span></span>

<span data-ttu-id="e1251-116">Antes de hablar acerca de cómo usar el almacenamiento RA-GRS, se explicarán sus propiedades y su comportamiento.</span><span class="sxs-lookup"><span data-stu-id="e1251-116">Before we talk about how to use RA-GRS storage, let's talk about its properties and behavior.</span></span>

* <span data-ttu-id="e1251-117">Azure Storage mantiene en una región secundaria una copia de solo lectura de los datos que almacena en su región primaria; como se mencionó antes, el servicio de almacenamiento determina la ubicación de la región secundaria.</span><span class="sxs-lookup"><span data-stu-id="e1251-117">Azure Storage maintains a read-only copy of the data you store in your primary region in a secondary region; as noted above, the storage service determines the location of the secondary region.</span></span>

* <span data-ttu-id="e1251-118">La copia de solo lectura es de [coherencia final](https://en.wikipedia.org/wiki/Eventual_consistency) con los datos en la región primaria.</span><span class="sxs-lookup"><span data-stu-id="e1251-118">The read-only copy is [eventually consistent](https://en.wikipedia.org/wiki/Eventual_consistency) with the data in the primary region.</span></span>

* <span data-ttu-id="e1251-119">Para blobs, tablas y colas, puede consultar en la región secundaria un valor *Hora de última sincronización* que indica cuándo se produjo la última replicación desde la región primaria a la secundaria</span><span class="sxs-lookup"><span data-stu-id="e1251-119">For blobs, tables, and queues, you can query the secondary region for a *Last Sync Time* value that tells you when the last replication from the primary to the secondary region occurred.</span></span> <span data-ttu-id="e1251-120">(esto no se admite para Azure File Storage, que no tiene redundancia RA-GRS en este momento).</span><span class="sxs-lookup"><span data-stu-id="e1251-120">(This is not supported for Azure File storage, which doesn't have RA-GRS redundancy at this time.)</span></span>

* <span data-ttu-id="e1251-121">Puede usar la biblioteca del cliente de almacenamiento para interactuar con los datos en la región principal o la secundaria.</span><span class="sxs-lookup"><span data-stu-id="e1251-121">You can use the Storage Client Library to interact with the data in either the primary or secondary region.</span></span> <span data-ttu-id="e1251-122">También puede redirigir solicitudes de lectura automáticamente a la región secundaria si se agota el tiempo de espera de una solicitud de lectura a la región principal.</span><span class="sxs-lookup"><span data-stu-id="e1251-122">You can also redirect read requests automatically to the secondary region if a read request to the primary region times out.</span></span>

* <span data-ttu-id="e1251-123">Si un problema grave afecta a la accesibilidad de los datos en la región principal, es posible que el equipo de Azure desencadene una conmutación por error geográfica, momento en el cual se cambiarán las entradas DNS que apunten a la región principal de forma que apunten a la secundaria.</span><span class="sxs-lookup"><span data-stu-id="e1251-123">If there is a major issue affecting the accessibility of the data in the primary region, the Azure team may trigger a geo-failover, at which point the DNS entries pointing to the primary region will be changed to point to the secondary region.</span></span>

* <span data-ttu-id="e1251-124">Si se produce una conmutación por error geográfica, Azure seleccionará una nueva ubicación secundaria, replicará los datos en dicha ubicación y hará que las entradas DNS secundarias apunten a ella.</span><span class="sxs-lookup"><span data-stu-id="e1251-124">If a geo-failover occurs, Azure will select a new secondary location and replicate the data to that location, then point the secondary DNS entries to it.</span></span> <span data-ttu-id="e1251-125">El punto de conexión secundario no estará disponible hasta que termine de replicarse la cuenta de almacenamiento.</span><span class="sxs-lookup"><span data-stu-id="e1251-125">The secondary endpoint will be unavailable until the storage account has finished replicating.</span></span> <span data-ttu-id="e1251-126">Para más información, consulte [Qué hacer si se produce una interrupción del servicio Azure Storage](https://docs.microsoft.com/en-us/azure/storage/storage-disaster-recovery-guidance).</span><span class="sxs-lookup"><span data-stu-id="e1251-126">For more information, please see [What to do if an Azure Storage outage occurs](https://docs.microsoft.com/en-us/azure/storage/storage-disaster-recovery-guidance).</span></span>

## <a name="application-design-considerations-when-using-ra-grs"></a><span data-ttu-id="e1251-127">Consideraciones sobre el diseño de aplicaciones cuando se usa RA-GRS</span><span class="sxs-lookup"><span data-stu-id="e1251-127">Application design considerations when using RA-GRS</span></span>

<span data-ttu-id="e1251-128">El propósito principal de este artículo es mostrar cómo diseñar una aplicación que siga funcionando (aunque con limitaciones) incluso si se produce un desastre importante en el centro de datos principal.</span><span class="sxs-lookup"><span data-stu-id="e1251-128">The main purpose of this article is to show you how to design an application that will continue to function (albeit in a limited capacity) even in the event of a major disaster at the primary data center.</span></span> <span data-ttu-id="e1251-129">Para ello, la aplicación debe poder enfrentarse a problemas transitorios o de ejecución prolongada pasando a leer desde la región secundaria mientras haya un problema y regresando después cuando la región principal esté disponible de nuevo.</span><span class="sxs-lookup"><span data-stu-id="e1251-129">You do this by having your application to handle transient or long-running issues by switching to read from the secondary region while there is a problem, and switching back when the primary region is available again.</span></span>

### <a name="using-eventually-consistent-data"></a><span data-ttu-id="e1251-130">Uso de datos con coherencia final</span><span class="sxs-lookup"><span data-stu-id="e1251-130">Using eventually consistent data</span></span>

<span data-ttu-id="e1251-131">En esta solución propuesta, se da por supuesto que no pasa nada por devolver datos posiblemente obsoletos a la aplicación que realiza la llamada.</span><span class="sxs-lookup"><span data-stu-id="e1251-131">This proposed solution assumes that it is okay to return what could be stale data to the calling application.</span></span> <span data-ttu-id="e1251-132">Dado que los datos secundarios son de coherencia final, es posible que los datos se escribieran en la región principal, pero que la actualización en la región secundaria aún no hubiera terminado de replicarse cuando la región primaria dejó de ser accesible.</span><span class="sxs-lookup"><span data-stu-id="e1251-132">Because the secondary data is eventually consistent, it is possible that the data was written to the primary but the update to the secondary had not finished replicating when the primary region became inaccessible.</span></span>

<span data-ttu-id="e1251-133">Por ejemplo, el cliente podría enviar una actualización que sea correcta y después la región principal podría pasar a estar inactiva antes de que la actualización se propague a la región secundaria.</span><span class="sxs-lookup"><span data-stu-id="e1251-133">For example, your customer could submit an update that is successful, and then the primary could go down before the update is propagated to the secondary.</span></span> <span data-ttu-id="e1251-134">En este caso, si el cliente pide leer los datos de nuevo, recibirá los datos obsoletos en lugar de los actualizados.</span><span class="sxs-lookup"><span data-stu-id="e1251-134">In this case, if the customer then asks to read the data back, he receives the stale data instead of the updated data.</span></span> <span data-ttu-id="e1251-135">Debe decidir si esto es aceptable y, en tal caso, cómo enviará mensajes al cliente.</span><span class="sxs-lookup"><span data-stu-id="e1251-135">You must decide if this is acceptable, and if so, how you will message the customer.</span></span> <span data-ttu-id="e1251-136">Verá cómo comprobar la hora de la última sincronización en los datos secundarios más adelante en este artículo para ver si la región secundaria está actualizada.</span><span class="sxs-lookup"><span data-stu-id="e1251-136">You'll see how to check the Last Sync Time on the secondary data later in this article to see if the secondary is up-to-date.</span></span>

### <a name="handling-services-separately-or-all-together"></a><span data-ttu-id="e1251-137">Control de servicios por separado o conjuntamente</span><span class="sxs-lookup"><span data-stu-id="e1251-137">Handling services separately or all together</span></span>

<span data-ttu-id="e1251-138">Aunque no es probable, es posible que un servicio deje de estar disponible mientras que los demás sigan siendo totalmente funcionales.</span><span class="sxs-lookup"><span data-stu-id="e1251-138">While not likely, it is possible for one service to become unavailable while the other services are still fully functional.</span></span> <span data-ttu-id="e1251-139">Puede controlar los reintentos y el modo de solo lectura para cada servicio por separado (blobs, colas, tablas) o puede controlar los reintentos de forma genérica para todos los servicios de almacenamiento en conjunto.</span><span class="sxs-lookup"><span data-stu-id="e1251-139">You can handle the retries and read-only mode for each service separately (blobs, queues, tables), or you can handle retries generically for all the storage services together.</span></span>

<span data-ttu-id="e1251-140">Por ejemplo, si usa colas y blobs en la aplicación, puede decidir colocarlos de forma independiente en el código para poder controlar los errores con posibilidad de reintento para cada uno de ellos.</span><span class="sxs-lookup"><span data-stu-id="e1251-140">For example, if you use queues and blobs in your application, you may decide to put in separate code to handle retryable errors for each of these.</span></span> <span data-ttu-id="e1251-141">Entonces, si obtiene un reintento desde Blob service, pero Queue service sigue funcionando, solo se verá afectada la parte de la aplicación que controla blobs.</span><span class="sxs-lookup"><span data-stu-id="e1251-141">Then if you get a retry from the blob service, but the queue service is still working, only the part of your application that handles blobs will be impacted.</span></span> <span data-ttu-id="e1251-142">Si decide controlar todos los reintentos de servicios de almacenamiento de forma genérica y una llamada a Blob service devuelve un error con posibilidad de reintento, se verán afectadas las solicitudes tanto a Blob service como a Queue service.</span><span class="sxs-lookup"><span data-stu-id="e1251-142">If you decide to handle all storage service retries generically and a call to the blob service returns a retryable error, then requests to both the blob service and the queue service will be impacted.</span></span>

<span data-ttu-id="e1251-143">En última instancia, esto depende de la complejidad de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="e1251-143">Ultimately, this depends on the complexity of your application.</span></span> <span data-ttu-id="e1251-144">Es posible que decida no controlar los errores para cada servicio, sino redirigir las solicitudes de lectura para todos los servicios de almacenamiento a la región secundaria y ejecutar la aplicación en modo de solo lectura cuando se detecte un problema con cualquier servicio de almacenamiento en la región primaria.</span><span class="sxs-lookup"><span data-stu-id="e1251-144">You may decide not to handle the failures by service, but instead to redirect read requests for all storage services to the secondary region and run the application in read-only mode when you detect a problem with any storage service in the primary region.</span></span>

### <a name="other-considerations"></a><span data-ttu-id="e1251-145">Otras consideraciones</span><span class="sxs-lookup"><span data-stu-id="e1251-145">Other considerations</span></span>

<span data-ttu-id="e1251-146">En el resto del artículo, también se tratarán estas consideraciones.</span><span class="sxs-lookup"><span data-stu-id="e1251-146">These are the other considerations we will discuss in the rest of this article.</span></span>

*   <span data-ttu-id="e1251-147">Control de los reintentos de solicitudes de lectura mediante el patrón de disyuntor</span><span class="sxs-lookup"><span data-stu-id="e1251-147">Handling retries of read requests using the Circuit Breaker pattern</span></span>

*   <span data-ttu-id="e1251-148">Datos de coherencia final y la hora de la última sincronización</span><span class="sxs-lookup"><span data-stu-id="e1251-148">Eventually-consistent data and the Last Sync Time</span></span>

*   <span data-ttu-id="e1251-149">Prueba</span><span class="sxs-lookup"><span data-stu-id="e1251-149">Testing</span></span>

## <a name="running-your-application-in-read-only-mode"></a><span data-ttu-id="e1251-150">Ejecución de la aplicación en modo de solo lectura</span><span class="sxs-lookup"><span data-stu-id="e1251-150">Running your application in read-only mode</span></span>

<span data-ttu-id="e1251-151">Para utilizar almacenamiento RA-GRS, debe ser capaz de controlar tanto solicitudes de lectura con errores como solicitudes de actualización con errores (aquí actualización se refiere a inserciones, actualizaciones y eliminaciones).</span><span class="sxs-lookup"><span data-stu-id="e1251-151">To use RA-GRS storage, you must be able to handle both failed read requests and failed update requests (with update in this case meaning inserts, updates, and deletions).</span></span> <span data-ttu-id="e1251-152">Si se produce un error en el centro de datos principal, se pueden redirigir las solicitudes de lectura al centro de datos secundario, pero no las de actualización, porque el centro de datos secundario es de solo lectura.</span><span class="sxs-lookup"><span data-stu-id="e1251-152">If the primary data center fails, read requests can be redirected to the secondary data center, but update requests cannot because the secondary is read only.</span></span> <span data-ttu-id="e1251-153">Por este motivo, se necesita alguna manera de ejecutar la aplicación en modo de solo lectura.</span><span class="sxs-lookup"><span data-stu-id="e1251-153">For this reason, you need some way to run your application in read-only mode.</span></span>

<span data-ttu-id="e1251-154">Por ejemplo, puede establecer una marca que se comprobará antes de enviar solicitudes de actualización al servicio de almacenamiento.</span><span class="sxs-lookup"><span data-stu-id="e1251-154">For example, you can set a flag that will be checked before submitting any update requests to the storage service.</span></span> <span data-ttu-id="e1251-155">Cuando llegue una de las solicitudes de actualización, puede pasarla por alto y devolver una respuesta adecuada al cliente.</span><span class="sxs-lookup"><span data-stu-id="e1251-155">When one of the update requests comes through, you can skip it and return an appropriate response to the customer.</span></span> <span data-ttu-id="e1251-156">Incluso es posible que desee deshabilitar totalmente determinadas características hasta que se resuelva el problema y notificar a los usuarios que esas características no están disponibles temporalmente.</span><span class="sxs-lookup"><span data-stu-id="e1251-156">You may even want to disable certain features altogether until the problem is resolved and notify users that those features are temporarily unavailable.</span></span>

<span data-ttu-id="e1251-157">Si decide controlar errores para cada servicio por separado, también necesitará controlar la capacidad de ejecutar la aplicación en modo de solo lectura para cada servicio.</span><span class="sxs-lookup"><span data-stu-id="e1251-157">If you decide to handle errors for each service separately, you will also need to handle the ability to run your application in read-only mode by service.</span></span> <span data-ttu-id="e1251-158">Podría tener marcas de solo lectura para cada servicio que se puedan habilitar y deshabilitar, y controlar la marca correspondiente en los lugares adecuados del código.</span><span class="sxs-lookup"><span data-stu-id="e1251-158">You could have read-only flags for each service that can be enabled and disabled and handle the appropriate flag in the appropriate places in your code.</span></span>

<span data-ttu-id="e1251-159">Poder ejecutar la aplicación en modo de solo lectura ofrece otra ventaja: la capacidad de garantizar una funcionalidad limitada durante una actualización importante de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="e1251-159">Being able to run your application in read-only mode has another side benefit – it gives you the ability to ensure limited functionality during a major application upgrade.</span></span> <span data-ttu-id="e1251-160">Puede desencadenar la aplicación para que se ejecute en modo de solo lectura y apunte al centro de datos secundario, de forma que nadie acceda a los datos de la región primaria mientras se estén llevando a cabo actualizaciones.</span><span class="sxs-lookup"><span data-stu-id="e1251-160">You can trigger your application to run in read-only mode and point to the secondary data center, ensuring nobody is accessing the data in the primary region while you're making upgrades.</span></span>

## <a name="handling-updates-when-running-in-read-only-mode"></a><span data-ttu-id="e1251-161">Control de las actualizaciones durante la ejecución en modo de solo lectura</span><span class="sxs-lookup"><span data-stu-id="e1251-161">Handling updates when running in read-only mode</span></span>

<span data-ttu-id="e1251-162">Existen muchas formas de controlar solicitudes de actualización durante la ejecución en modo de solo lectura.</span><span class="sxs-lookup"><span data-stu-id="e1251-162">There are many ways to handle update requests when running in read-only mode.</span></span> <span data-ttu-id="e1251-163">No se va a tratar esto de forma exhaustiva, pero, por lo general, hay un par de patrones que tener en cuenta.</span><span class="sxs-lookup"><span data-stu-id="e1251-163">We won't cover this comprehensively, but generally, there are a couple of patterns that you consider.</span></span>

1.  <span data-ttu-id="e1251-164">Puede responder al usuario y indicarle que actualmente no se aceptan actualizaciones.</span><span class="sxs-lookup"><span data-stu-id="e1251-164">You can respond to your user and tell them you are not currently accepting updates.</span></span> <span data-ttu-id="e1251-165">Por ejemplo, un sistema de administración de contactos podría permitir que los clientes accedan a información de contacto, pero no que la actualicen.</span><span class="sxs-lookup"><span data-stu-id="e1251-165">For example, a contact management system could enable customers to access contact information but not make updates.</span></span>

2.  <span data-ttu-id="e1251-166">Puede poner las actualizaciones en cola en otra región.</span><span class="sxs-lookup"><span data-stu-id="e1251-166">You can enqueue your updates in another region.</span></span> <span data-ttu-id="e1251-167">En este caso, podría escribir las solicitudes de actualización pendientes en una cola de una región distinta y, después, contar con una forma de procesar esas solicitudes una vez que el centro de datos principal vuelva a estar en línea.</span><span class="sxs-lookup"><span data-stu-id="e1251-167">In this case, you would write your pending update requests to a queue in a different region, and then have a way to process those requests after the primary data center comes online again.</span></span> <span data-ttu-id="e1251-168">En este escenario, debería hacer saber al cliente que la actualización solicitada está en cola para procesarse más adelante.</span><span class="sxs-lookup"><span data-stu-id="e1251-168">In this scenario, you should let the customer know that the update requested is queued for later processing.</span></span>

3.  <span data-ttu-id="e1251-169">Puede escribir las actualizaciones en una cuenta de almacenamiento de otra región.</span><span class="sxs-lookup"><span data-stu-id="e1251-169">You can write your updates to a storage account in another region.</span></span> <span data-ttu-id="e1251-170">Después, cuando el centro de datos principal vuelva a estar en línea, puede disponer de una forma de combinar esas actualizaciones con los datos principales, en función de la estructura de estos.</span><span class="sxs-lookup"><span data-stu-id="e1251-170">Then when the primary data center comes back online, you can have a way to merge those updates into the primary data, depending on the structure of the data.</span></span> <span data-ttu-id="e1251-171">Por ejemplo, si va a crear archivos distintos con una marca de fecha y hora en el nombre, puede copiar esos archivos de nuevo a la región primaria.</span><span class="sxs-lookup"><span data-stu-id="e1251-171">For example, if you are creating separate files with a date/time stamp in the name, you can copy those files back to the primary region.</span></span> <span data-ttu-id="e1251-172">Esto funciona para algunas cargas de trabajo como los datos de registro e IoT.</span><span class="sxs-lookup"><span data-stu-id="e1251-172">This works for some workloads such as logging and iOT data.</span></span>

## <a name="handling-retries"></a><span data-ttu-id="e1251-173">Control de los reintentos</span><span class="sxs-lookup"><span data-stu-id="e1251-173">Handling retries</span></span>

<span data-ttu-id="e1251-174">¿Cómo saber qué errores se pueden reintentar?</span><span class="sxs-lookup"><span data-stu-id="e1251-174">How do you know which errors are retryable?</span></span> <span data-ttu-id="e1251-175">Esto viene determinado por la biblioteca del cliente de almacenamiento.</span><span class="sxs-lookup"><span data-stu-id="e1251-175">This is determined by the storage client library.</span></span> <span data-ttu-id="e1251-176">Por ejemplo, un error 404 (recurso no encontrado) no se puede reintentar porque es dudoso que se complete de forma correcta.</span><span class="sxs-lookup"><span data-stu-id="e1251-176">For example, a 404 error (resource not found) is not retryable because retrying it is not likely to result in success.</span></span> <span data-ttu-id="e1251-177">Por otro lado, un error 500 sí se puede reintentar porque es un error del servidor y potencialmente transitorio.</span><span class="sxs-lookup"><span data-stu-id="e1251-177">On the other hand, a 500 error is retryable because it is a server error, and it may simply be a transient issue.</span></span> <span data-ttu-id="e1251-178">Para más detalles, visite el [código fuente abierto de la clase ExponentialRetry](https://github.com/Azure/azure-storage-net/blob/87b84b3d5ee884c7adc10e494e2c7060956515d0/Lib/Common/RetryPolicies/ExponentialRetry.cs) en la biblioteca del cliente de almacenamiento de .NET.</span><span class="sxs-lookup"><span data-stu-id="e1251-178">For more details, check out the [open source code for the ExponentialRetry class](https://github.com/Azure/azure-storage-net/blob/87b84b3d5ee884c7adc10e494e2c7060956515d0/Lib/Common/RetryPolicies/ExponentialRetry.cs) in the .NET storage client library.</span></span> <span data-ttu-id="e1251-179">(Busque el método ShouldRetry).</span><span class="sxs-lookup"><span data-stu-id="e1251-179">(Look for the ShouldRetry method.)</span></span>

### <a name="read-requests"></a><span data-ttu-id="e1251-180">Solicitudes de lectura</span><span class="sxs-lookup"><span data-stu-id="e1251-180">Read requests</span></span>

<span data-ttu-id="e1251-181">Las solicitudes de lectura se pueden redirigir a almacenamiento secundario si hay un problema con el principal.</span><span class="sxs-lookup"><span data-stu-id="e1251-181">Read requests can be redirected to secondary storage if there is a problem with primary storage.</span></span> <span data-ttu-id="e1251-182">Como se indicó antes en [Uso de datos con coherencia final](#using-eventually-consistent-data), debe ser aceptable que su aplicación lea datos potencialmente obsoletos.</span><span class="sxs-lookup"><span data-stu-id="e1251-182">As noted above in [Using Eventually Consistent Data](#using-eventually-consistent-data), it must be acceptable for your application to potentially read stale data.</span></span> <span data-ttu-id="e1251-183">Si usa la biblioteca del cliente de almacenamiento para acceder a datos de RA-GRS, puede especificar el comportamiento de reintento de una solicitud de lectura estableciendo uno de los siguientes valores para la propiedad **LocationMode**:</span><span class="sxs-lookup"><span data-stu-id="e1251-183">If you are using the storage client library to access RA-GRS data, you can specify the retry behavior of a read request by setting a value for the **LocationMode** property to one of the following:</span></span>

*   <span data-ttu-id="e1251-184">**PrimaryOnly** (valor predeterminado)</span><span class="sxs-lookup"><span data-stu-id="e1251-184">**PrimaryOnly** (the default)</span></span>

*   <span data-ttu-id="e1251-185">**PrimaryThenSecondary**</span><span class="sxs-lookup"><span data-stu-id="e1251-185">**PrimaryThenSecondary**</span></span>

*   <span data-ttu-id="e1251-186">**SecondaryOnly**</span><span class="sxs-lookup"><span data-stu-id="e1251-186">**SecondaryOnly**</span></span>

*   <span data-ttu-id="e1251-187">**SecondaryThenPrimary**</span><span class="sxs-lookup"><span data-stu-id="e1251-187">**SecondaryThenPrimary**</span></span>

<span data-ttu-id="e1251-188">Cuando se establece **LocationMode** en **PrimaryThenSecondary**, si la solicitud de lectura inicial para el punto de conexión principal genera un error con posibilidad de reintento, el cliente presenta automáticamente otra solicitud de lectura al punto de conexión secundario.</span><span class="sxs-lookup"><span data-stu-id="e1251-188">When you set the **LocationMode** to **PrimaryThenSecondary**, if the initial read request to the primary endpoint fails with a retryable error, the client automatically makes another read request to the secondary endpoint.</span></span> <span data-ttu-id="e1251-189">Si el error es por agotamiento del tiempo de espera del servidor, el cliente tendrá que esperar a que el tiempo de espera expire antes de recibir un error con posibilidad de reintento del servicio.</span><span class="sxs-lookup"><span data-stu-id="e1251-189">If the error is a server timeout, then the client will have to wait for the timeout to expire before it receives a retryable error from the service.</span></span>

<span data-ttu-id="e1251-190">Básicamente, se deben tener en cuenta dos escenarios al decidir cómo responder a un error con posibilidad de reintento:</span><span class="sxs-lookup"><span data-stu-id="e1251-190">There are basically two scenarios to consider when you are deciding how to respond to a retryable error:</span></span>

*   <span data-ttu-id="e1251-191">Se trata de un problema aislado y las solicitudes posteriores al punto de conexión principal no devolverán un error con posibilidad de reintento.</span><span class="sxs-lookup"><span data-stu-id="e1251-191">This is an isolated problem and subsequent requests to the primary endpoint will not return a retryable error.</span></span> <span data-ttu-id="e1251-192">Un ejemplo de cuándo puede ocurrir esto es un error de red transitorio.</span><span class="sxs-lookup"><span data-stu-id="e1251-192">An example of where this might happen is when there is a transient network error.</span></span>

    <span data-ttu-id="e1251-193">En este escenario, no hay ninguna reducción notable del rendimiento por tener **LocationMode** establecido en **PrimaryThenSecondary**, ya que esto solo sucede en raras ocasiones.</span><span class="sxs-lookup"><span data-stu-id="e1251-193">In this scenario, there is no significant performance penalty in having **LocationMode** set to **PrimaryThenSecondary** as this only happens infrequently.</span></span>

*   <span data-ttu-id="e1251-194">Se trata de un problema con al menos uno de los servicios de almacenamiento en la región principal y es probable que todas las solicitudes posteriores a ese servicio en la región principal devuelvan errores con posibilidad de reintento durante un tiempo.</span><span class="sxs-lookup"><span data-stu-id="e1251-194">This is a problem with at least one of the storage services in the primary region and all subsequent requests to that service in the primary region are likely to return retryable errors for a period of time.</span></span> <span data-ttu-id="e1251-195">Un ejemplo se da si la región principal es totalmente inaccesible.</span><span class="sxs-lookup"><span data-stu-id="e1251-195">An example of this is if the primary region is completely inaccessible.</span></span>

    <span data-ttu-id="e1251-196">En este escenario, el rendimiento se ve afectado porque todas las solicitudes de lectura intentarán en primer lugar el punto de conexión principal, esperarán a que el tiempo de espera expire y después cambiarán al punto de conexión secundario.</span><span class="sxs-lookup"><span data-stu-id="e1251-196">In this scenario, there is a performance penalty because all your read requests will try the primary endpoint first, wait for the timeout to expire, then switch to the secondary endpoint.</span></span>

<span data-ttu-id="e1251-197">Para estos escenarios, debe reconocer que existe un problema continuado con el punto de conexión principal y enviar todas las solicitudes de lectura directamente al punto de conexión secundario; para ello, establezca la propiedad **LocationMode** en **SecondaryOnly**.</span><span class="sxs-lookup"><span data-stu-id="e1251-197">For these scenarios, you should identify that there is an ongoing issue with the primary endpoint and send all read requests directly to the secondary endpoint by setting the **LocationMode** property to **SecondaryOnly**.</span></span> <span data-ttu-id="e1251-198">En este momento, también debería cambiar la aplicación para que se ejecute en modo de solo lectura.</span><span class="sxs-lookup"><span data-stu-id="e1251-198">At this time, you should also change the application to run in read-only mode.</span></span> <span data-ttu-id="e1251-199">Este enfoque se conoce como el [patrón de disyuntor](https://msdn.microsoft.com/library/dn589784.aspx).</span><span class="sxs-lookup"><span data-stu-id="e1251-199">This approach is known as the [Circuit Breaker Pattern](https://msdn.microsoft.com/library/dn589784.aspx).</span></span>

### <a name="update-requests"></a><span data-ttu-id="e1251-200">Solicitudes de actualización</span><span class="sxs-lookup"><span data-stu-id="e1251-200">Update requests</span></span>

<span data-ttu-id="e1251-201">El patrón de disyuntor también se puede aplicar a las solicitudes de actualización.</span><span class="sxs-lookup"><span data-stu-id="e1251-201">The Circuit Breaker pattern can also be applied to update requests.</span></span> <span data-ttu-id="e1251-202">Sin embargo, estas no se pueden redirigir al almacenamiento secundario, que es de solo lectura.</span><span class="sxs-lookup"><span data-stu-id="e1251-202">However, update requests cannot be redirected to secondary storage, which is read-only.</span></span> <span data-ttu-id="e1251-203">Para estas solicitudes, debe dejar la propiedad **LocationMode** establecida en **PrimaryOnly** (valor predeterminado).</span><span class="sxs-lookup"><span data-stu-id="e1251-203">For these requests, you should leave the **LocationMode** property set to **PrimaryOnly** (the default).</span></span> <span data-ttu-id="e1251-204">Para controlar estos errores, puede aplicar una métrica a estas solicitudes (por ejemplo, 10 errores consecutivos) y, cuando se alcance el umbral, cambiar la aplicación al modo de solo lectura.</span><span class="sxs-lookup"><span data-stu-id="e1251-204">To handle these errors, you can apply a metric to these requests – such as 10 failures in a row – and when your threshold is met, switch the application into read-only mode.</span></span> <span data-ttu-id="e1251-205">Puede usar los mismos métodos para volver al modo de actualización que los descritos en la siguiente sección sobre el patrón de disyuntor.</span><span class="sxs-lookup"><span data-stu-id="e1251-205">You can use the same methods for returning to update mode as those described below in the next section about the Circuit Breaker pattern.</span></span>

## <a name="circuit-breaker-pattern"></a><span data-ttu-id="e1251-206">Patrón de disyuntor</span><span class="sxs-lookup"><span data-stu-id="e1251-206">Circuit Breaker pattern</span></span>

<span data-ttu-id="e1251-207">Si usa el patrón de disyuntor en la aplicación, puede impedir que reintente una operación que es probable que produzca errores una y otra vez.</span><span class="sxs-lookup"><span data-stu-id="e1251-207">Using the Circuit Breaker pattern in your application can prevent it from retrying an operation that is likely to fail repeatedly.</span></span> <span data-ttu-id="e1251-208">Permite que la aplicación siga ejecutándose en lugar de ocupar tiempo mientras se reintenta la operación de forma exponencial.</span><span class="sxs-lookup"><span data-stu-id="e1251-208">It allows the application to continue to run rather than taking up time while the operation is retried exponentially.</span></span> <span data-ttu-id="e1251-209">Además, detecta cuándo se ha corregido el error, momento en el que la aplicación puede intentar la operación de nuevo.</span><span class="sxs-lookup"><span data-stu-id="e1251-209">It also detects when the fault has been fixed, at which time the application can try the operation again.</span></span>

### <a name="how-to-implement-the-circuit-breaker-pattern"></a><span data-ttu-id="e1251-210">Cómo implementar el patrón de disyuntor</span><span class="sxs-lookup"><span data-stu-id="e1251-210">How to implement the circuit breaker pattern</span></span>

<span data-ttu-id="e1251-211">Para identificar la existencia de un problema continuado con un punto de conexión principal, puede supervisar la frecuencia con que el cliente encuentra errores con posibilidad de reintento.</span><span class="sxs-lookup"><span data-stu-id="e1251-211">To identify that there is an ongoing problem with a primary endpoint, you can monitor how frequently the client encounters retryable errors.</span></span> <span data-ttu-id="e1251-212">Como cada caso es diferente, tendrá que decidir el umbral que desea usar para la decisión de cambiar al punto de conexión secundario y ejecutar la aplicación en modo de solo lectura.</span><span class="sxs-lookup"><span data-stu-id="e1251-212">Because each case is different, you have to decide on the threshold you want to use for the decision to switch to the secondary endpoint and run the application in read-only mode.</span></span> <span data-ttu-id="e1251-213">Por ejemplo, podría decidir cambiar si hay diez errores consecutivos sin ninguna ejecución correcta.</span><span class="sxs-lookup"><span data-stu-id="e1251-213">For example, you could decide to perform the switch if there are 10 failures in a row with no successes.</span></span> <span data-ttu-id="e1251-214">Otro ejemplo consiste en cambiar si se produce un error en el 90 % de las solicitudes en un periodo de dos minutos.</span><span class="sxs-lookup"><span data-stu-id="e1251-214">Another example is to switch if 90% of the requests in a 2-minute period fail.</span></span>

<span data-ttu-id="e1251-215">Para el primer escenario, basta con que cuente los errores y, si se produce un resultado correcto antes de alcanzar el máximo, restablezca el recuento a cero.</span><span class="sxs-lookup"><span data-stu-id="e1251-215">For the first scenario, you can simply keep a count of the failures, and if there is a success before reaching the maximum, set the count back to zero.</span></span> <span data-ttu-id="e1251-216">Para el segundo escenario, una posibilidad de implementación es usar el objeto MemoryCache (en. NET).</span><span class="sxs-lookup"><span data-stu-id="e1251-216">For the second scenario, one way to implement it is to use the MemoryCache object (in .NET).</span></span> <span data-ttu-id="e1251-217">Para cada solicitud, agregue un elemento CacheItem a la memoria caché, establezca el valor en correcto (1) o error (0), y establezca la hora de expiración en 2 minutos a partir del momento actual (o la restricción temporal que sea).</span><span class="sxs-lookup"><span data-stu-id="e1251-217">For each request, add a CacheItem to the cache, set the value to success (1) or fail (0), and set the expiration time to 2 minutes from now (or whatever your time constraint is).</span></span> <span data-ttu-id="e1251-218">Cuando se alcanza la hora de expiración de una entrada, esta se quita automáticamente.</span><span class="sxs-lookup"><span data-stu-id="e1251-218">When an entry's expiration time is reached, the entry is automatically removed.</span></span> <span data-ttu-id="e1251-219">Esto le dará un intervalo gradual de 2 minutos.</span><span class="sxs-lookup"><span data-stu-id="e1251-219">This will give you a rolling 2-minute window.</span></span> <span data-ttu-id="e1251-220">Cada vez que se envíe una solicitud al servicio de almacenamiento, use primero una consulta Linq en el objeto MemoryCache para calcular el porcentaje de corrección, para lo cual se suman los valores y se dividen por el recuento.</span><span class="sxs-lookup"><span data-stu-id="e1251-220">Each time you make a request to the storage service, you first use a Linq query across the MemoryCache object to calculate the percent success by summing the values and dividing by the count.</span></span> <span data-ttu-id="e1251-221">Cuando el porcentaje de corrección sea inferior a un umbral (por ejemplo, 10 %), establezca la propiedad **LocationMode** para solicitudes de lectura en **SecondaryOnly** y cambie la aplicación al modo de solo lectura antes de continuar.</span><span class="sxs-lookup"><span data-stu-id="e1251-221">When the percent success drops below some threshold (such as 10%), set the **LocationMode** property for read requests to **SecondaryOnly** and switch the application into read-only mode before continuing.</span></span>

<span data-ttu-id="e1251-222">El umbral de errores que se usa para determinar cuándo se debe realizar el cambio puede variar para cada servicio en la aplicación, por lo que debería considerar convertir los umbrales en parámetros configurables.</span><span class="sxs-lookup"><span data-stu-id="e1251-222">The threshold of errors used to determine when to make the switch may vary from service to service in your application, so you should consider making them configurable parameters.</span></span> <span data-ttu-id="e1251-223">Aquí también se decide controlar los errores con posibilidad de reintento de cada servicio por separado o en conjunto, según lo descrito antes.</span><span class="sxs-lookup"><span data-stu-id="e1251-223">This is also where you decide to handle retryable errors from each service separately or as one, as discussed previously.</span></span>

<span data-ttu-id="e1251-224">Otra consideración es cómo controlar varias instancias de una aplicación y qué hacer cuando se detecten errores con posibilidad de reintento en cada instancia.</span><span class="sxs-lookup"><span data-stu-id="e1251-224">Another consideration is how to handle multiple instances of an application, and what to do when you detect retryable errors in each instance.</span></span> <span data-ttu-id="e1251-225">Por ejemplo, puede que tenga 20 máquinas virtuales que se ejecutan con la misma aplicación cargada.</span><span class="sxs-lookup"><span data-stu-id="e1251-225">For example, you may have 20 VMs running with the same application loaded.</span></span> <span data-ttu-id="e1251-226">¿Va a controlar cada instancia por separado?</span><span class="sxs-lookup"><span data-stu-id="e1251-226">Do you handle each instance separately?</span></span> <span data-ttu-id="e1251-227">Si una instancia empieza a tener problemas, ¿desea limitar la respuesta solo a esa instancia o intentar que todas las instancias respondan de la misma manera cuando una de ellas tenga un problema?</span><span class="sxs-lookup"><span data-stu-id="e1251-227">If one instance starts having problems, do you want to limit the response to just that one instance, or do you want to try to have all instances respond in the same way when one instance has a problem?</span></span> <span data-ttu-id="e1251-228">Controlar las instancias por separado es mucho más sencillo que intentar coordinar la respuesta en todas ellas, pero la forma de hacerlo depende de la arquitectura de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="e1251-228">Handling the instances separately is much simpler than trying to coordinate the response across them, but how you do this depends on your application's architecture.</span></span>

### <a name="options-for-monitoring-the-error-frequency"></a><span data-ttu-id="e1251-229">Opciones para supervisar la frecuencia de los errores</span><span class="sxs-lookup"><span data-stu-id="e1251-229">Options for monitoring the error frequency</span></span>

<span data-ttu-id="e1251-230">Dispone de tres opciones principales para supervisar la frecuencia de reintentos en la región primaria y determinar cuándo se debe cambiar a la región secundaria y hacer que la aplicación se ejecute en modo de solo lectura.</span><span class="sxs-lookup"><span data-stu-id="e1251-230">You have three main options for monitoring the frequency of retries in the primary region in order to determine when to switch over to the secondary region and change the application to run in read-only mode.</span></span>

*   <span data-ttu-id="e1251-231">Agregue un controlador para el evento [**Retrying**](http://msdn.microsoft.com/en-us/library/microsoft.windowsazure.storage.operationcontext.retrying.aspx) en el objeto [**OperationContext**](http://msdn.microsoft.com/en-us/library/microsoft.windowsazure.storage.operationcontext.aspx) que se pasa a las solicitudes de almacenamiento: este método se muestra en este artículo y se usa en el ejemplo que lo acompaña.</span><span class="sxs-lookup"><span data-stu-id="e1251-231">Add a handler for the [**Retrying**](http://msdn.microsoft.com/en-us/library/microsoft.windowsazure.storage.operationcontext.retrying.aspx) event on the [**OperationContext**](http://msdn.microsoft.com/en-us/library/microsoft.windowsazure.storage.operationcontext.aspx) object you pass to your storage requests – this is the method displayed in this article and used in the accompanying sample.</span></span> <span data-ttu-id="e1251-232">Estos eventos se activan cada vez que el cliente reintenta una solicitud, lo que le permite realizar un seguimiento de la frecuencia con que el cliente encuentra errores con posibilidad de reintento en un punto de conexión principal.</span><span class="sxs-lookup"><span data-stu-id="e1251-232">These events fire whenever the client retries a request, enabling you to track how often the client encounters retryable errors on a primary endpoint.</span></span>

    ```csharp 
    operationContext.Retrying += (sender, arguments) =>
    {
        // Retrying in the primary region
        if (arguments.Request.Host == primaryhostname)
            ...
    };
    ```

*   <span data-ttu-id="e1251-233">En el método [**Evaluate**](http://msdn.microsoft.com/en-us/library/microsoft.windowsazure.storage.retrypolicies.iextendedretrypolicy.evaluate.aspx) de una directiva de reintentos personalizada, puede ejecutar código personalizado siempre que se lleve a cabo un reintento.</span><span class="sxs-lookup"><span data-stu-id="e1251-233">In the [**Evaluate**](http://msdn.microsoft.com/en-us/library/microsoft.windowsazure.storage.retrypolicies.iextendedretrypolicy.evaluate.aspx) method in a custom retry policy, you can run custom code whenever a retry takes place.</span></span> <span data-ttu-id="e1251-234">Además de registrar cuándo sucede un reintento, esto también ofrece la oportunidad de modificar el comportamiento de reintento.</span><span class="sxs-lookup"><span data-stu-id="e1251-234">In addition to recording when a retry happens, this also gives you the opportunity to modify your retry behavior.</span></span>

    ```csharp 
    public RetryInfo Evaluate(RetryContext retryContext,
    OperationContext operationContext)
    {
        var statusCode = retryContext.LastRequestResult.HttpStatusCode;
        if (retryContext.CurrentRetryCount >= this.maximumAttempts
        || ((statusCode &gt;= 300 && statusCode &lt; 500 && statusCode != 408)
        || statusCode == 501 // Not Implemented
        || statusCode == 505 // Version Not Supported
            ))
        {
        // Do not retry
            return null;
        }

        // Monitor retries in the primary location
        ...

        // Determine RetryInterval and TargetLocation
        RetryInfo info =
            CreateRetryInfo(retryContext.CurrentRetryCount);

        return info;
    }
    ```

*   <span data-ttu-id="e1251-235">El tercer enfoque consiste en implementar un componente de supervisión personalizado en la aplicación que haga ping continuamente al punto de conexión de almacenamiento principal con solicitudes de lectura ficticias (por ejemplo, la lectura de un blob pequeño) para determinar su estado.</span><span class="sxs-lookup"><span data-stu-id="e1251-235">The third approach is to implement a custom monitoring component in your application that continually pings your primary storage endpoint with dummy read requests (such as reading a small blob) to determine its health.</span></span> <span data-ttu-id="e1251-236">Esto consumiría recursos, pero no en cantidades notables.</span><span class="sxs-lookup"><span data-stu-id="e1251-236">This would take up some resources, but not a significant amount.</span></span> <span data-ttu-id="e1251-237">Cuando se detecte un problema que alcance el umbral, se llevar a cabo el cambio a **SecondaryOnly** y al modo de solo lectura.</span><span class="sxs-lookup"><span data-stu-id="e1251-237">When a problem is discovered that reaches your threshold, you would then perform the switch to **SecondaryOnly** and read-only mode.</span></span>

<span data-ttu-id="e1251-238">En algún momento, querrá que se vuelva a usar el punto de conexión principal y se permitan las actualizaciones.</span><span class="sxs-lookup"><span data-stu-id="e1251-238">At some point, you will want to switch back to using the primary endpoint and allowing updates.</span></span> <span data-ttu-id="e1251-239">Si usa uno de los dos primeros métodos mencionados antes, podría simplemente cambiar al punto de conexión principal y habilitar el modo de actualización después de un intervalo de tiempo arbitrario o de que se haya llevado a cabo un número de operaciones.</span><span class="sxs-lookup"><span data-stu-id="e1251-239">If using one of the first two methods listed above, you could simply switch back to the primary endpoint and enable update mode after an arbitrarily selected amount of time or number of operations has been performed.</span></span> <span data-ttu-id="e1251-240">A continuación, puede dejar que se repita la lógica de reintento.</span><span class="sxs-lookup"><span data-stu-id="e1251-240">You can then let it go through the retry logic again.</span></span> <span data-ttu-id="e1251-241">Si se ha corregido el problema, procederá a usar el punto de conexión principal y a permitir las actualizaciones.</span><span class="sxs-lookup"><span data-stu-id="e1251-241">If the problem has been fixed, it will continue to use the primary endpoint and allow updates.</span></span> <span data-ttu-id="e1251-242">Si el problema persiste, volverá una vez más a cambiar al punto de conexión secundario y al modo de solo lectura después de que se incumplan los criterios que haya establecido.</span><span class="sxs-lookup"><span data-stu-id="e1251-242">If there is still a problem, it will once more switch back to the secondary endpoint and read-only mode after failing the criteria you've set.</span></span>

<span data-ttu-id="e1251-243">Para el tercer escenario, cuando vuelva a hacer ping correctamente al punto de conexión de almacenamiento principal, puede desencadenar el cambio a **PrimaryOnly** y continuar permitiendo las actualizaciones.</span><span class="sxs-lookup"><span data-stu-id="e1251-243">For the third scenario, when pinging the primary storage endpoint becomes successful again, you can trigger the switch back to **PrimaryOnly** and continue allowing updates.</span></span>

## <a name="handling-eventually-consistent-data"></a><span data-ttu-id="e1251-244">Control de datos con coherencia final</span><span class="sxs-lookup"><span data-stu-id="e1251-244">Handling eventually consistent data</span></span>

<span data-ttu-id="e1251-245">RA-GRS funciona mediante la replicación de transacciones de la región primaria en la región secundaria.</span><span class="sxs-lookup"><span data-stu-id="e1251-245">RA-GRS works by replicating transactions from the primary to the secondary region.</span></span> <span data-ttu-id="e1251-246">Este proceso de replicación garantiza que los datos de la región secundaria tengan *coherencia final*.</span><span class="sxs-lookup"><span data-stu-id="e1251-246">This replication process guarantees that the data in the secondary region is *eventually consistent*.</span></span> <span data-ttu-id="e1251-247">Esto significa que todas las transacciones en la región primaria terminarán por aparecer en la región secundaria, aunque puede darse un retraso antes de que aparezcan y no hay ninguna garantía de que las transacciones lleguen a la región secundaria en el mismo orden en que se aplicaron originalmente en la región primaria.</span><span class="sxs-lookup"><span data-stu-id="e1251-247">This means that all the transactions in the primary region will eventually appear in the secondary region, but that there may be a lag before they appear, and that there is no guarantee the transactions arrive in the secondary region in the same order as that in which they were originally applied in the primary region.</span></span> <span data-ttu-id="e1251-248">Si las transacciones llegan desordenadas a la región secundaria, *podría* considerar que los datos en la región secundaria se encuentran en un estado incoherente hasta que el servicio se ponga al día.</span><span class="sxs-lookup"><span data-stu-id="e1251-248">If your transactions arrive in the secondary region out of order, you *may* consider your data in the secondary region to be in an inconsistent state until the service catches up.</span></span>

<span data-ttu-id="e1251-249">En la tabla siguiente, se muestra un ejemplo de lo que podría suceder al actualizar los detalles de una empleada para convertirla en miembro del rol de *administrador*.</span><span class="sxs-lookup"><span data-stu-id="e1251-249">The following table shows an example of what might happen when you update the details of an employee to make her a member of the *administrators* role.</span></span> <span data-ttu-id="e1251-250">Para este ejemplo, esto requiere actualizar la entidad **empleado** y actualizar una entidad **rol de administrador** con un recuento del número total de administradores.</span><span class="sxs-lookup"><span data-stu-id="e1251-250">For the sake of this example, this requires you update the **employee** entity and update an **administrator role** entity with a count of the total number of administrators.</span></span> <span data-ttu-id="e1251-251">Observe cómo se aplican las actualizaciones desordenadas en la región secundaria.</span><span class="sxs-lookup"><span data-stu-id="e1251-251">Notice how the updates are applied out of order in the secondary region.</span></span>

| <span data-ttu-id="e1251-252">**Hora**</span><span class="sxs-lookup"><span data-stu-id="e1251-252">**Time**</span></span> | <span data-ttu-id="e1251-253">**Transacción**</span><span class="sxs-lookup"><span data-stu-id="e1251-253">**Transaction**</span></span>                                            | <span data-ttu-id="e1251-254">**Replicación**</span><span class="sxs-lookup"><span data-stu-id="e1251-254">**Replication**</span></span>                       | <span data-ttu-id="e1251-255">**Hora de última sincronización**</span><span class="sxs-lookup"><span data-stu-id="e1251-255">**Last Sync Time**</span></span> | <span data-ttu-id="e1251-256">**Resultado**</span><span class="sxs-lookup"><span data-stu-id="e1251-256">**Result**</span></span> |
|----------|------------------------------------------------------------|---------------------------------------|--------------------|------------| 
| <span data-ttu-id="e1251-257">T0</span><span class="sxs-lookup"><span data-stu-id="e1251-257">T0</span></span>       | <span data-ttu-id="e1251-258">Transacción A:</span><span class="sxs-lookup"><span data-stu-id="e1251-258">Transaction A:</span></span> <br> <span data-ttu-id="e1251-259">Insertar entidad</span><span class="sxs-lookup"><span data-stu-id="e1251-259">Insert employee</span></span> <br> <span data-ttu-id="e1251-260">empleado en región primaria</span><span class="sxs-lookup"><span data-stu-id="e1251-260">entity in primary</span></span> |                                   |                    | <span data-ttu-id="e1251-261">Transacción A insertada en región primaria,</span><span class="sxs-lookup"><span data-stu-id="e1251-261">Transaction A inserted to primary,</span></span><br> <span data-ttu-id="e1251-262">aún sin replicar.</span><span class="sxs-lookup"><span data-stu-id="e1251-262">not replicated yet.</span></span> |
| <span data-ttu-id="e1251-263">T1</span><span class="sxs-lookup"><span data-stu-id="e1251-263">T1</span></span>       |                                                            | <span data-ttu-id="e1251-264">Transacción A</span><span class="sxs-lookup"><span data-stu-id="e1251-264">Transaction A</span></span> <br> <span data-ttu-id="e1251-265">replicada en</span><span class="sxs-lookup"><span data-stu-id="e1251-265">replicated to</span></span><br> <span data-ttu-id="e1251-266">región secundaria</span><span class="sxs-lookup"><span data-stu-id="e1251-266">secondary</span></span> | <span data-ttu-id="e1251-267">T1</span><span class="sxs-lookup"><span data-stu-id="e1251-267">T1</span></span> | <span data-ttu-id="e1251-268">Transacción A replicada en región secundaria.</span><span class="sxs-lookup"><span data-stu-id="e1251-268">Transaction A replicated to secondary.</span></span> <br><span data-ttu-id="e1251-269">Hora de última sincronización actualizada.</span><span class="sxs-lookup"><span data-stu-id="e1251-269">Last Sync Time updated.</span></span>    |
| <span data-ttu-id="e1251-270">T2</span><span class="sxs-lookup"><span data-stu-id="e1251-270">T2</span></span>       | <span data-ttu-id="e1251-271">Transacción B:</span><span class="sxs-lookup"><span data-stu-id="e1251-271">Transaction B:</span></span><br><span data-ttu-id="e1251-272">Actualizar</span><span class="sxs-lookup"><span data-stu-id="e1251-272">Update</span></span><br> <span data-ttu-id="e1251-273">entidad empleado</span><span class="sxs-lookup"><span data-stu-id="e1251-273">employee entity</span></span><br> <span data-ttu-id="e1251-274">en región primaria</span><span class="sxs-lookup"><span data-stu-id="e1251-274">in primary</span></span>  |                                | <span data-ttu-id="e1251-275">T1</span><span class="sxs-lookup"><span data-stu-id="e1251-275">T1</span></span>                 | <span data-ttu-id="e1251-276">Transacción B escrita en región primaria,</span><span class="sxs-lookup"><span data-stu-id="e1251-276">Transaction B written to primary,</span></span><br> <span data-ttu-id="e1251-277">aún sin replicar.</span><span class="sxs-lookup"><span data-stu-id="e1251-277">not replicated yet.</span></span>  |
| <span data-ttu-id="e1251-278">T3</span><span class="sxs-lookup"><span data-stu-id="e1251-278">T3</span></span>       | <span data-ttu-id="e1251-279">Transacción C:</span><span class="sxs-lookup"><span data-stu-id="e1251-279">Transaction C:</span></span><br> <span data-ttu-id="e1251-280">Actualizar</span><span class="sxs-lookup"><span data-stu-id="e1251-280">Update</span></span> <br><span data-ttu-id="e1251-281">administrator</span><span class="sxs-lookup"><span data-stu-id="e1251-281">administrator</span></span><br><span data-ttu-id="e1251-282">entidad rol administrador en región</span><span class="sxs-lookup"><span data-stu-id="e1251-282">role entity in</span></span><br><span data-ttu-id="e1251-283">primary</span><span class="sxs-lookup"><span data-stu-id="e1251-283">primary</span></span> |                    | <span data-ttu-id="e1251-284">T1</span><span class="sxs-lookup"><span data-stu-id="e1251-284">T1</span></span>                 | <span data-ttu-id="e1251-285">Transacción C escrita en región primaria,</span><span class="sxs-lookup"><span data-stu-id="e1251-285">Transaction C written to primary,</span></span><br> <span data-ttu-id="e1251-286">aún sin replicar.</span><span class="sxs-lookup"><span data-stu-id="e1251-286">not replicated yet.</span></span>  |
| <span data-ttu-id="e1251-287">*T4*</span><span class="sxs-lookup"><span data-stu-id="e1251-287">*T4*</span></span>     |                                                       | <span data-ttu-id="e1251-288">Transacción C</span><span class="sxs-lookup"><span data-stu-id="e1251-288">Transaction C</span></span> <br><span data-ttu-id="e1251-289">replicada en</span><span class="sxs-lookup"><span data-stu-id="e1251-289">replicated to</span></span><br> <span data-ttu-id="e1251-290">región secundaria</span><span class="sxs-lookup"><span data-stu-id="e1251-290">secondary</span></span> | <span data-ttu-id="e1251-291">T1</span><span class="sxs-lookup"><span data-stu-id="e1251-291">T1</span></span>         | <span data-ttu-id="e1251-292">Transacción C replicada en región secundaria.</span><span class="sxs-lookup"><span data-stu-id="e1251-292">Transaction C replicated to secondary.</span></span><br><span data-ttu-id="e1251-293">LastSyncTime no actualizado porque</span><span class="sxs-lookup"><span data-stu-id="e1251-293">LastSyncTime not updated because</span></span> <br><span data-ttu-id="e1251-294">la transacción B está aún sin replicar.</span><span class="sxs-lookup"><span data-stu-id="e1251-294">transaction B has not been replicated yet.</span></span>|
| <span data-ttu-id="e1251-295">*T5*</span><span class="sxs-lookup"><span data-stu-id="e1251-295">*T5*</span></span>     | <span data-ttu-id="e1251-296">Leer entidades</span><span class="sxs-lookup"><span data-stu-id="e1251-296">Read entities</span></span> <br><span data-ttu-id="e1251-297">desde región secundaria</span><span class="sxs-lookup"><span data-stu-id="e1251-297">from secondary</span></span>                           |                                  | <span data-ttu-id="e1251-298">T1</span><span class="sxs-lookup"><span data-stu-id="e1251-298">T1</span></span>                 | <span data-ttu-id="e1251-299">Obtiene el valor obsoleto de la entidad</span><span class="sxs-lookup"><span data-stu-id="e1251-299">You get the stale value for employee</span></span> <br> <span data-ttu-id="e1251-300">empleado porque la transacción B aún</span><span class="sxs-lookup"><span data-stu-id="e1251-300">entity because transaction B hasn't</span></span> <br> <span data-ttu-id="e1251-301">no se ha replicado.</span><span class="sxs-lookup"><span data-stu-id="e1251-301">replicated yet.</span></span> <span data-ttu-id="e1251-302">Obtiene el valor nuevo para la</span><span class="sxs-lookup"><span data-stu-id="e1251-302">You get the new value for</span></span><br> <span data-ttu-id="e1251-303">entidad rol de administrador porque C</span><span class="sxs-lookup"><span data-stu-id="e1251-303">administrator role entity because C has</span></span><br> <span data-ttu-id="e1251-304">se ha replicado.</span><span class="sxs-lookup"><span data-stu-id="e1251-304">replicated.</span></span> <span data-ttu-id="e1251-305">La hora de la última sincronización aún no se ha</span><span class="sxs-lookup"><span data-stu-id="e1251-305">Last Sync Time still hasn't</span></span><br> <span data-ttu-id="e1251-306">actualizado porque la transacción B</span><span class="sxs-lookup"><span data-stu-id="e1251-306">been updated because transaction B</span></span><br> <span data-ttu-id="e1251-307">no se ha replicado.</span><span class="sxs-lookup"><span data-stu-id="e1251-307">hasn't replicated.</span></span> <span data-ttu-id="e1251-308">Puede ver que la</span><span class="sxs-lookup"><span data-stu-id="e1251-308">You can tell the</span></span><br><span data-ttu-id="e1251-309">entidad rol de administrador es incoherente</span><span class="sxs-lookup"><span data-stu-id="e1251-309">administrator role entity is inconsistent</span></span> <br><span data-ttu-id="e1251-310">porque la fecha y hora de la entidad son posteriores a</span><span class="sxs-lookup"><span data-stu-id="e1251-310">because the entity date/time is after</span></span> <br><span data-ttu-id="e1251-311">Hora de última sincronización.</span><span class="sxs-lookup"><span data-stu-id="e1251-311">the Last Sync Time.</span></span> |
| <span data-ttu-id="e1251-312">*T6*</span><span class="sxs-lookup"><span data-stu-id="e1251-312">*T6*</span></span>     |                                                      | <span data-ttu-id="e1251-313">Transacción B</span><span class="sxs-lookup"><span data-stu-id="e1251-313">Transaction B</span></span><br> <span data-ttu-id="e1251-314">replicada en</span><span class="sxs-lookup"><span data-stu-id="e1251-314">replicated to</span></span><br> <span data-ttu-id="e1251-315">región secundaria</span><span class="sxs-lookup"><span data-stu-id="e1251-315">secondary</span></span> | <span data-ttu-id="e1251-316">T6</span><span class="sxs-lookup"><span data-stu-id="e1251-316">T6</span></span>                 | <span data-ttu-id="e1251-317">*T6*: todas las transacciones hasta la C</span><span class="sxs-lookup"><span data-stu-id="e1251-317">*T6* – All transactions through C have</span></span> <br><span data-ttu-id="e1251-318">se han replicado, Hora de última sincronización</span><span class="sxs-lookup"><span data-stu-id="e1251-318">been replicated, Last Sync Time</span></span><br> <span data-ttu-id="e1251-319">se ha actualizado.</span><span class="sxs-lookup"><span data-stu-id="e1251-319">is updated.</span></span> |

<span data-ttu-id="e1251-320">En este ejemplo, suponga que el cliente pasa a leer desde la región secundaria en T5.</span><span class="sxs-lookup"><span data-stu-id="e1251-320">In this example, assume the client switches to reading from the secondary region at T5.</span></span> <span data-ttu-id="e1251-321">Puede leer correctamente la entidad **rol administrador** en este momento, pero la entidad contiene un valor para el recuento de administradores que no es coherente con el número de entidades **empleado** que están marcadas como administradores en la región secundaria en este momento.</span><span class="sxs-lookup"><span data-stu-id="e1251-321">It can successfully read the **administrator role** entity at this time, but the entity contains a value for the count of administrators that is not consistent with the number of **employee** entities that are marked as administrators in the secondary region at this time.</span></span> <span data-ttu-id="e1251-322">El cliente podría mostrar simplemente este valor y correr el riesgo de que sea información incoherente.</span><span class="sxs-lookup"><span data-stu-id="e1251-322">Your client could simply display this value, with the risk that it is inconsistent information.</span></span> <span data-ttu-id="e1251-323">O bien, el cliente podría intentar determinar que el **rol administrador** se encuentra en un estado potencialmente incoherente porque las actualizaciones se han producido desordenadas y después informar al usuario sobre este hecho.</span><span class="sxs-lookup"><span data-stu-id="e1251-323">Alternatively, the client could attempt to determine that the **administrator role** is in a potentially inconsistent state because the updates have happened out of order, and then inform the user of this fact.</span></span>

<span data-ttu-id="e1251-324">Para reconocer que tiene datos potencialmente incoherentes, el cliente puede usar el valor de *Hora de última sincronización*, que puede obtener en cualquier momento al consultar un servicio de almacenamiento.</span><span class="sxs-lookup"><span data-stu-id="e1251-324">To recognize that it has potentially inconsistent data, the client can use the value of the *Last Sync Time* that you can get at any time by querying a storage service.</span></span> <span data-ttu-id="e1251-325">Esto indica la hora en que los datos de la región secundaria fueron coherentes por última vez y cuándo aplicó el servicio todas las transacciones hasta ese momento.</span><span class="sxs-lookup"><span data-stu-id="e1251-325">This tells you the time when the data in the secondary region was last consistent and when the service had applied all the transactions prior to that point in time.</span></span> <span data-ttu-id="e1251-326">En el ejemplo mostrado antes, una vez que el servicio inserta la entidad **empleado** en la región secundaria, la hora de la última sincronización se establece en *T1*.</span><span class="sxs-lookup"><span data-stu-id="e1251-326">In the example shown above, after the service inserts the **employee** entity in the secondary region, the last sync time is set to *T1*.</span></span> <span data-ttu-id="e1251-327">Permanece en *T1* hasta que el servicio actualiza la entidad **empleado** en la región secundaria cuando se establece en *T6*.</span><span class="sxs-lookup"><span data-stu-id="e1251-327">It remains at *T1* until the service updates the **employee** entity in the secondary region when it is set to *T6*.</span></span> <span data-ttu-id="e1251-328">Si el cliente recupera la última hora de sincronización cuando lee la entidad en *T5*, puede compararla con la marca de tiempo en la entidad.</span><span class="sxs-lookup"><span data-stu-id="e1251-328">If the client retrieves the last sync time when it reads the entity at *T5*, it can compare it with the timestamp on the entity.</span></span> <span data-ttu-id="e1251-329">Si la marca de tiempo en la entidad es posterior a la hora de la última sincronización, la entidad se encuentra en un estado potencialmente incoherente, por lo que podrá llevar a cabo la acción adecuada para su aplicación.</span><span class="sxs-lookup"><span data-stu-id="e1251-329">If the timestamp on the entity is later than the last sync time, then the entity is in a potentially inconsistent state, and you can take whatever is the appropriate action for your application.</span></span> <span data-ttu-id="e1251-330">Para usar este campo, es necesario saber cuándo se completó la última actualización en la región primaria.</span><span class="sxs-lookup"><span data-stu-id="e1251-330">Using this field requires that you know when the last update to the primary was completed.</span></span>

## <a name="testing"></a><span data-ttu-id="e1251-331">Prueba</span><span class="sxs-lookup"><span data-stu-id="e1251-331">Testing</span></span>

<span data-ttu-id="e1251-332">Es importante comprobar que la aplicación se comporte según lo esperado cuando encuentre errores con posibilidad de reintento.</span><span class="sxs-lookup"><span data-stu-id="e1251-332">It's important to test that your application behaves as expected when it encounters retryable errors.</span></span> <span data-ttu-id="e1251-333">Por ejemplo, debe probar que la aplicación cambie a la región secundaria y al modo de solo lectura cuando se detecte un problema y que cambie de vuelta a la región primaria cuando vuelva a estar disponible.</span><span class="sxs-lookup"><span data-stu-id="e1251-333">For example, you need to test that the application switches to the secondary and into read-only mode when it detects a problem, and switches back when the primary region becomes available again.</span></span> <span data-ttu-id="e1251-334">Para ello, necesita una manera de simular errores con posibilidad de reintento y controlar la frecuencia con que se producen.</span><span class="sxs-lookup"><span data-stu-id="e1251-334">To do this, you need a way to simulate retryable errors and control how often they occur.</span></span>

<span data-ttu-id="e1251-335">Puede usar [Fiddler](http://www.telerik.com/fiddler) para interceptar y modificar respuestas HTTP en un script.</span><span class="sxs-lookup"><span data-stu-id="e1251-335">You can use [Fiddler](http://www.telerik.com/fiddler) to intercept and modify HTTP responses in a script.</span></span> <span data-ttu-id="e1251-336">Este script puede identificar las respuestas que proceden de su punto de conexión principal y cambiar el código de estado HTTP para que la biblioteca del cliente de almacenamiento lo reconozca como error con posibilidad de reintento.</span><span class="sxs-lookup"><span data-stu-id="e1251-336">This script can identify responses that come from your primary endpoint and change the HTTP status code to one that the Storage Client Library recognizes as a retryable error.</span></span> <span data-ttu-id="e1251-337">Este fragmento de código muestra un ejemplo sencillo de un script de Fiddler que intercepta respuestas a solicitudes de lectura para la tabla **employeedata** y devuelve un estado 502:</span><span class="sxs-lookup"><span data-stu-id="e1251-337">This code snippet shows a simple example of a Fiddler script that intercepts responses to read requests against the **employeedata** table to return a 502 status:</span></span>

```java
static function OnBeforeResponse(oSession: Session) {
    ...
    if ((oSession.hostname == "\[yourstorageaccount\].table.core.windows.net")
      && (oSession.PathAndQuery.StartsWith("/employeedata?$filter"))) {
        oSession.responseCode = 502;
    }
}
```

<span data-ttu-id="e1251-338">Puede ampliar este ejemplo para interceptar una gama más amplia de solicitudes y solamente cambiar el elemento **responseCode** en algunas de ellas para simular mejor un escenario real.</span><span class="sxs-lookup"><span data-stu-id="e1251-338">You could extend this example to intercept a wider range of requests and only change the **responseCode** on some of them to better simulate a real-world scenario.</span></span> <span data-ttu-id="e1251-339">Para más información sobre cómo personalizar scripts de Fiddler, consulte [Modifying a Request or Response](http://docs.telerik.com/fiddler/KnowledgeBase/FiddlerScript/ModifyRequestOrResponse) (Modificación de una solicitud o respuesta) en la documentación de Fiddler.</span><span class="sxs-lookup"><span data-stu-id="e1251-339">For more information about customizing Fiddler scripts, see [Modifying a Request or Response](http://docs.telerik.com/fiddler/KnowledgeBase/FiddlerScript/ModifyRequestOrResponse) in the Fiddler documentation.</span></span>

<span data-ttu-id="e1251-340">Si ha hecho configurables los umbrales para cambiar la aplicación al modo de solo lectura, será más fácil probar el comportamiento con volúmenes de transacciones que no sean de producción.</span><span class="sxs-lookup"><span data-stu-id="e1251-340">If you have made the thresholds for switching your application to read-only mode configurable, it will be easier to test the behavior with non-production transaction volumes.</span></span>

## <a name="next-steps"></a><span data-ttu-id="e1251-341">Pasos siguientes</span><span class="sxs-lookup"><span data-stu-id="e1251-341">Next Steps</span></span>

* <span data-ttu-id="e1251-342">Para más información sobre la redundancia geográfica con acceso de lectura, incluido otro ejemplo de cómo se establece LastSyncTime, visite [Windows Azure Storage Redundancy Options and Read Access Geo Redundant Storage](https://blogs.msdn.microsoft.com/windowsazurestorage/2013/12/11/windows-azure-storage-redundancy-options-and-read-access-geo-redundant-storage/) (Opciones de redundancia de Microsoft Azure Storage y almacenamiento con redundancia geográfica con acceso de lectura).</span><span class="sxs-lookup"><span data-stu-id="e1251-342">For more information about Read Access Geo-Redundancy, including another example of how the LastSyncTime is set, please see [Windows Azure Storage Redundancy Options and Read Access Geo Redundant Storage](https://blogs.msdn.microsoft.com/windowsazurestorage/2013/12/11/windows-azure-storage-redundancy-options-and-read-access-geo-redundant-storage/).</span></span>

* <span data-ttu-id="e1251-343">Para ver un ejemplo completo de cómo cambiar entre el punto de conexión principal y el secundario, consulte los [ejemplos de Azure para usar el patrón de disyuntor con almacenamiento RA-GRS](https://github.com/Azure-Samples/storage-dotnet-circuit-breaker-pattern-ha-apps-using-ra-grs).</span><span class="sxs-lookup"><span data-stu-id="e1251-343">For a complete sample showing how to make the switch back and forth between the Primary and Secondary endpoints, please see [Azure Samples – Using the Circuit Breaker Pattern with RA-GRS storage](https://github.com/Azure-Samples/storage-dotnet-circuit-breaker-pattern-ha-apps-using-ra-grs).</span></span>
