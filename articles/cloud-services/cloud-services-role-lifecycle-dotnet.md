---
title: Control de los eventos de ciclo de vida del servicio en la nube | Microsoft Docs
description: "Aprenda cómo se pueden usar los métodos del ciclo de vida de un rol de  servicio en la nube en .NET"
services: cloud-services
documentationcenter: .net
author: Thraka
manager: timlt
editor: 
ms.assetid: 39b30acd-57b9-48b7-a7c4-40ea3430e451
ms.service: cloud-services
ms.workload: tbd
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/18/2017
ms.author: adegeo
ms.openlocfilehash: eb78c05df3b3cdf3887334c11bdabd5cebb74747
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 08/03/2017
---
# <a name="customize-the-lifecycle-of-a-web-or-worker-role-in-net"></a><span data-ttu-id="e4e5c-103">Personalizar el ciclo de vida de un rol web o de trabajo en .NET</span><span class="sxs-lookup"><span data-stu-id="e4e5c-103">Customize the Lifecycle of a Web or Worker role in .NET</span></span>
<span data-ttu-id="e4e5c-104">Cuando cree un rol de trabajo, amplíe la clase [RoleEntryPoint](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleentrypoint.aspx) que ofrece métodos para invalidar que le permiten responder a eventos del ciclo de vida.</span><span class="sxs-lookup"><span data-stu-id="e4e5c-104">When you create a worker role, you extend the [RoleEntryPoint](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleentrypoint.aspx) class which provides methods for you to override that let you respond to lifecycle events.</span></span> <span data-ttu-id="e4e5c-105">Para los roles web esta clase es opcional, por lo que debe usarla para responder a eventos del ciclo de vida.</span><span class="sxs-lookup"><span data-stu-id="e4e5c-105">For web roles this class is optional, so you must use it to respond to lifecycle events.</span></span>

## <a name="extend-the-roleentrypoint-class"></a><span data-ttu-id="e4e5c-106">Extender la clase RoleEntryPoint</span><span class="sxs-lookup"><span data-stu-id="e4e5c-106">Extend the RoleEntryPoint class</span></span>
<span data-ttu-id="e4e5c-107">La clase [RoleEntryPoint](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleentrypoint.aspx) incluye métodos a los que llama Azure cuando se **inicia**, **se ejecuta** o **se detiene** un rol web o de trabajo.</span><span class="sxs-lookup"><span data-stu-id="e4e5c-107">The [RoleEntryPoint](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleentrypoint.aspx) class includes methods that are called by Azure when it **starts**, **runs**, or **stops** a web or worker role.</span></span> <span data-ttu-id="e4e5c-108">Opcionalmente, puede invalidar estos métodos para administrar la inicialización de roles, las secuencias de apagado de rol o el subproceso de ejecución del rol.</span><span class="sxs-lookup"><span data-stu-id="e4e5c-108">You can optionally override these methods to manage role initialization, role shutdown sequences, or the execution thread of the role.</span></span> 

<span data-ttu-id="e4e5c-109">Al extender **RoleEntryPoint**, debe tener en cuenta los siguientes comportamientos de los métodos:</span><span class="sxs-lookup"><span data-stu-id="e4e5c-109">When extending **RoleEntryPoint**, you should be aware of the following behaviors of the methods:</span></span>

* <span data-ttu-id="e4e5c-110">Los métodos [OnStart](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleentrypoint.onstart.aspx) y [OnStop](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleentrypoint.onstop.aspx) devuelven un valor booleano, por lo que es posible devolver **false** desde estos métodos.</span><span class="sxs-lookup"><span data-stu-id="e4e5c-110">The [OnStart](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleentrypoint.onstart.aspx) and [OnStop](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleentrypoint.onstop.aspx) methods return a boolean value, so it is possible to return **false** from these methods.</span></span>
  
   <span data-ttu-id="e4e5c-111">Si el código devuelve **false**, el proceso del rol finaliza precipitadamente, sin ejecutar ninguna secuencia de apagado que pueda tener implantada.</span><span class="sxs-lookup"><span data-stu-id="e4e5c-111">If your code returns **false**, the role process is abruptly terminated, without running any shutdown sequence you may have in place.</span></span> <span data-ttu-id="e4e5c-112">En general, debería evitar devolver **false** del método **OnStart**.</span><span class="sxs-lookup"><span data-stu-id="e4e5c-112">In general, you should avoid returning **false** from the **OnStart** method.</span></span>
* <span data-ttu-id="e4e5c-113">Cualquier excepción no detectada en una sobrecarga de un método **RoleEntryPoint** se trata como una excepción no controlada.</span><span class="sxs-lookup"><span data-stu-id="e4e5c-113">Any uncaught exception within an overload of a **RoleEntryPoint** method is treated as an unhandled exception.</span></span>
  
   <span data-ttu-id="e4e5c-114">Si se produce una excepción dentro de uno de los métodos del ciclo de vida, Azure generará el evento [UnhandledException](https://msdn.microsoft.com/library/system.appdomain.unhandledexception.aspx) y luego finalizará el proceso.</span><span class="sxs-lookup"><span data-stu-id="e4e5c-114">If an exception occurs within one of the lifecycle methods, Azure will raise the [UnhandledException](https://msdn.microsoft.com/library/system.appdomain.unhandledexception.aspx) event, and then the process is terminated.</span></span> <span data-ttu-id="e4e5c-115">Tras la desconexión del rol, se reiniciará Azure.</span><span class="sxs-lookup"><span data-stu-id="e4e5c-115">After your role has been taken offline, it will be restarted by Azure.</span></span> <span data-ttu-id="e4e5c-116">Cuando se produzca una excepción no controlada, no se generará el evento [Detener](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleenvironment.stopping.aspx) y no se llamará al método **OnStop** .</span><span class="sxs-lookup"><span data-stu-id="e4e5c-116">When an unhandled exception occurs, the [Stopping](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleenvironment.stopping.aspx) event is not raised, and the **OnStop** method is not called.</span></span>

<span data-ttu-id="e4e5c-117">Si el rol no se inicia, o se recicla entre los estados de inicialización, ocupado y detención, el código puede generar una excepción no controlada en uno de los eventos de ciclo de vida cada vez que se reinicie el rol.</span><span class="sxs-lookup"><span data-stu-id="e4e5c-117">If your role does not start, or is recycling between the initializing, busy, and stopping states, your code may be throwing an unhandled exception within one of the lifecycle events each time the role restarts.</span></span> <span data-ttu-id="e4e5c-118">En este caso, use el evento [UnhandledException](https://msdn.microsoft.com/library/system.appdomain.unhandledexception.aspx) para determinar la causa de la excepción y controlarla de manera adecuada.</span><span class="sxs-lookup"><span data-stu-id="e4e5c-118">In this case, use the [UnhandledException](https://msdn.microsoft.com/library/system.appdomain.unhandledexception.aspx) event to determine the cause of the exception and handle it appropriately.</span></span> <span data-ttu-id="e4e5c-119">Puede que su rol también se pueda devolver desde el método [Ejecutar](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleentrypoint.run.aspx) , que hace que se reinicie el rol.</span><span class="sxs-lookup"><span data-stu-id="e4e5c-119">Your role may also be returning from the [Run](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleentrypoint.run.aspx) method, which causes the role to restart.</span></span> <span data-ttu-id="e4e5c-120">Para obtener más información acerca de los estados de implementación, vea [Problemas comunes que hacen que se reciclen los roles](cloud-services-troubleshoot-common-issues-which-cause-roles-recycle.md).</span><span class="sxs-lookup"><span data-stu-id="e4e5c-120">For more information about deployment states, see [Common Issues Which Cause Roles to Recycle](cloud-services-troubleshoot-common-issues-which-cause-roles-recycle.md).</span></span>

> [!NOTE]
> <span data-ttu-id="e4e5c-121">Si está usando la **Azure Tools para Microsoft Visual Studio** para desarrollar su aplicación, las plantillas de proyecto de rol extienden automáticamente la clase **RoleEntryPoint**, en los archivos *WebRole.cs* y *WorkerRole.cs*.</span><span class="sxs-lookup"><span data-stu-id="e4e5c-121">If you are using the **Azure Tools for Microsoft Visual Studio** to develop your application, the role project templates automatically extend the **RoleEntryPoint** class for you, in the *WebRole.cs* and *WorkerRole.cs* files.</span></span>
> 
> 

## <a name="onstart-method"></a><span data-ttu-id="e4e5c-122">Método OnStart</span><span class="sxs-lookup"><span data-stu-id="e4e5c-122">OnStart method</span></span>
<span data-ttu-id="e4e5c-123">Al método **OnStart** se llama cuando Azure pone en línea la instancia de rol.</span><span class="sxs-lookup"><span data-stu-id="e4e5c-123">The **OnStart** method is called when your role instance is brought online by Azure.</span></span> <span data-ttu-id="e4e5c-124">Mientras se ejecuta el código OnStart, la instancia de rol estará marcada como **ocupada** y el equilibrador de carga no le dirigirá ningún tráfico externo.</span><span class="sxs-lookup"><span data-stu-id="e4e5c-124">While the OnStart code is executing, the role instance is marked as **Busy** and no external traffic will be directed to it by the load balancer.</span></span> <span data-ttu-id="e4e5c-125">Puede invalidar este método para realizar trabajo de inicialización, como la implementación de controladores de eventos el inicio de [Diagnósticos de Azure](cloud-services-how-to-monitor.md).</span><span class="sxs-lookup"><span data-stu-id="e4e5c-125">You can override this method to perform initialization work, such as implementing event handlers and starting [Azure Diagnostics](cloud-services-how-to-monitor.md).</span></span>

<span data-ttu-id="e4e5c-126">Si **OnStart** devuelve **true**, la instancia se inicializa correctamente y Azure llama al método **RoleEntryPoint.Run**.</span><span class="sxs-lookup"><span data-stu-id="e4e5c-126">If **OnStart** returns **true**, the instance is successfully initialized and Azure calls the **RoleEntryPoint.Run** method.</span></span> <span data-ttu-id="e4e5c-127">Si **OnStart** devuelve **false**, el rol finaliza de inmediato, sin ejecutar ninguna secuencia de apagado planeado.</span><span class="sxs-lookup"><span data-stu-id="e4e5c-127">If **OnStart** returns **false**, the role terminates immediately, without executing any planned shutdown sequences.</span></span>

<span data-ttu-id="e4e5c-128">En el ejemplo de código siguiente se muestra cómo invalidar el método **OnStart** .</span><span class="sxs-lookup"><span data-stu-id="e4e5c-128">The following code example shows how to override the **OnStart** method.</span></span> <span data-ttu-id="e4e5c-129">Este método configura e inicia un monitor de diagnóstico cuando se inicia la instancia de rol y se configura una transferencia de datos de registro a una cuenta de almacenamiento:</span><span class="sxs-lookup"><span data-stu-id="e4e5c-129">This method configures and starts a diagnostic monitor when the role instance starts and sets up a transfer of logging data to a storage account:</span></span>

```csharp
public override bool OnStart()
{
    var config = DiagnosticMonitor.GetDefaultInitialConfiguration();

    config.DiagnosticInfrastructureLogs.ScheduledTransferLogLevelFilter = LogLevel.Error;
    config.DiagnosticInfrastructureLogs.ScheduledTransferPeriod = TimeSpan.FromMinutes(5);

    DiagnosticMonitor.Start("DiagnosticsConnectionString", config);

    return true;
}
```

## <a name="onstop-method"></a><span data-ttu-id="e4e5c-130">Método OnStop</span><span class="sxs-lookup"><span data-stu-id="e4e5c-130">OnStop method</span></span>
<span data-ttu-id="e4e5c-131">Al método **OnStop** se llama después de que Azure haya desconectado una instancia de rol Azure y antes de que salga el proceso.</span><span class="sxs-lookup"><span data-stu-id="e4e5c-131">The **OnStop** method is called after a role instance has been taken offline by Azure and before the process exits.</span></span> <span data-ttu-id="e4e5c-132">Puede invalidar este método para llamar al código necesario para que la instancia de rol se desconecte sin errores.</span><span class="sxs-lookup"><span data-stu-id="e4e5c-132">You can override this method to call code required for your role instance to cleanly shut down.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="e4e5c-133">El código que se ejecuta en el método **OnStop** tiene un tiempo limitado para finalizar cuando se llama por motivos distintos del apagado iniciado por un usuario.</span><span class="sxs-lookup"><span data-stu-id="e4e5c-133">Code running in the **OnStop** method has a limited time to finish when it is called for reasons other than a user-initiated shutdown.</span></span> <span data-ttu-id="e4e5c-134">Después de que transcurra este tiempo, el proceso finaliza, por lo que debe asegurarse de que el código del método **OnStop** puede ejecutarse rápidamente o de que no tolera que no haya ninguna ejecución para finalizar.</span><span class="sxs-lookup"><span data-stu-id="e4e5c-134">After this time elapses, the process is terminated, so you must make sure that code in the **OnStop** method can run quickly or tolerates not running to completion.</span></span> <span data-ttu-id="e4e5c-135">Al método **OnStop** se le llama después de que se genere el evento **Deteniendo**.</span><span class="sxs-lookup"><span data-stu-id="e4e5c-135">The **OnStop** method is called after the **Stopping** event is raised.</span></span>
> 
> 

## <a name="run-method"></a><span data-ttu-id="e4e5c-136">Método Run</span><span class="sxs-lookup"><span data-stu-id="e4e5c-136">Run method</span></span>
<span data-ttu-id="e4e5c-137">Puede invalidar el método **Run** para implementar un subproceso de larga ejecución para su instancia de rol.</span><span class="sxs-lookup"><span data-stu-id="e4e5c-137">You can override the **Run** method to implement a long-running thread for your role instance.</span></span>

<span data-ttu-id="e4e5c-138">No es necesaria la invalidación del método **Run** ; la implementación predeterminada inicia un subproceso que se mantiene en suspensión indefinidamente.</span><span class="sxs-lookup"><span data-stu-id="e4e5c-138">Overriding the **Run** method is not required; the default implementation starts a thread that sleeps forever.</span></span> <span data-ttu-id="e4e5c-139">Si invalida el método **Run** , el código debe bloquearse indefinidamente.</span><span class="sxs-lookup"><span data-stu-id="e4e5c-139">If you do override the **Run** method, your code should block indefinitely.</span></span> <span data-ttu-id="e4e5c-140">Si vuelve el método **Ejecutar**, el rol se recicla automáticamente sin problemas; es decir, Azure genera el evento **Detener** y llama al método **OnStop** para que las secuencias de apagado se puedan ejecutar antes de que el rol se quede sin conexión.</span><span class="sxs-lookup"><span data-stu-id="e4e5c-140">If the **Run** method returns, the role is automatically gracefully recycled; in other words, Azure raises the **Stopping** event and calls the **OnStop** method so that your shutdown sequences may be executed before the role is taken offline.</span></span>

### <a name="implementing-the-aspnet-lifecycle-methods-for-a-web-role"></a><span data-ttu-id="e4e5c-141">Implementación de los métodos del ciclo de vida de ASP.NET para un rol web</span><span class="sxs-lookup"><span data-stu-id="e4e5c-141">Implementing the ASP.NET lifecycle methods for a web role</span></span>
<span data-ttu-id="e4e5c-142">Puede usar los métodos del ciclo de vida de ASP.NET, además de los proporcionados por la clase **RoleEntryPoint** , para administrar secuencias de inicialización y apagado para un rol web.</span><span class="sxs-lookup"><span data-stu-id="e4e5c-142">You can use the ASP.NET lifecycle methods, in addition to those provided by the **RoleEntryPoint** class, to manage initialization and shutdown sequences for a web role.</span></span> <span data-ttu-id="e4e5c-143">Esto puede ser útil para compatibilidad si va a portar una aplicación de ASP.NET existente a Azure.</span><span class="sxs-lookup"><span data-stu-id="e4e5c-143">This may be useful for compatibility purposes if you are porting an existing ASP.NET application to Azure.</span></span> <span data-ttu-id="e4e5c-144">Se llama a los métodos de ciclo de vida de ASP.NET desde los métodos **RoleEntryPoint** .</span><span class="sxs-lookup"><span data-stu-id="e4e5c-144">The ASP.NET lifecycle methods are called from within the **RoleEntryPoint** methods.</span></span> <span data-ttu-id="e4e5c-145">Al método **Application\_Start** se llama después de que finalice el método **RoleEntryPoint.OnStart**.</span><span class="sxs-lookup"><span data-stu-id="e4e5c-145">The **Application\_Start** method is called after the **RoleEntryPoint.OnStart** method finishes.</span></span> <span data-ttu-id="e4e5c-146">Al método **Application\_End** se llama después de que se llame al método **RoleEntryPoint.OnStop**.</span><span class="sxs-lookup"><span data-stu-id="e4e5c-146">The **Application\_End** method is called before the **RoleEntryPoint.OnStop** method is called.</span></span>

## <a name="next-steps"></a><span data-ttu-id="e4e5c-147">Pasos siguientes</span><span class="sxs-lookup"><span data-stu-id="e4e5c-147">Next steps</span></span>
<span data-ttu-id="e4e5c-148">Aprenda cómo [crear un paquete de servicio en la nube](cloud-services-model-and-package.md).</span><span class="sxs-lookup"><span data-stu-id="e4e5c-148">Learn how to [create a cloud service package](cloud-services-model-and-package.md).</span></span>

