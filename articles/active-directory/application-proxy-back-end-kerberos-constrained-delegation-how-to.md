---
title: "Configuración de una aplicación de proxy de aplicación para que use la delegación limitada de Kerberos | Microsoft Docs"
description: "Cómo configurar la delegación limitada de Kerberos para una aplicación de proxy de aplicación de Azure AD."
services: active-directory
documentationcenter: 
author: ajamess
manager: femila
ms.assetid: 
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/11/2017
ms.author: asteen
ms.openlocfilehash: 3a768c30cb874d42d7b4fbd2eeaa6c0e23904e10
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 08/03/2017
---
# <a name="how-to-configure-an-application-proxy-application-to-use-kerberos-constrained-delegation"></a><span data-ttu-id="d1d1b-103">Configuración de una aplicación de proxy de aplicación para que use la delegación limitada de Kerberos</span><span class="sxs-lookup"><span data-stu-id="d1d1b-103">How to configure an Application Proxy application to use Kerberos Constrained Delegation</span></span>

<span data-ttu-id="d1d1b-104">Los métodos disponibles para lograr el SSO en las aplicaciones publicadas puede variar ligeramente de una aplicación a otra y una de las opciones que el proxy de aplicación de Azure ofrece desde el principio es la delegación limitada de Kerberos (KCD).</span><span class="sxs-lookup"><span data-stu-id="d1d1b-104">The methods available for achieving SSO to published applications can somewhat vary from application to application and one of the options that Azure Application Proxy offers right out of the box, is Kerberos Constrained Delegation (KCD).</span></span> <span data-ttu-id="d1d1b-105">Esta consiste en un host de conector que está configurado para realizar la autenticación limitada de Kerberos en aplicaciones back-end en nombre de los usuarios.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-105">This is where a connector host is configured to perform constrained kerberos authentication to backend applications, on behalf of users.</span></span>

<span data-ttu-id="d1d1b-106">El procedimiento para habilitar KCD es relativamente sencillo y no suele requerir más que una comprensión general de los diferentes componentes y del flujo de autenticación que hace posible el SSO.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-106">The actual procedure for enabling KCD is relatively straightforward and typically requires no more than a general understanding of the various components and authentication flow that facilitates SSO.</span></span> <span data-ttu-id="d1d1b-107">Escasean las buenas fuentes de información para ayudar a solucionar problemas en los que el SSO de KCD no funcione según lo previsto.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-107">Finding good sources of information to help troubleshoot scenarios where KCD SSO doesn’t function as expected, can be sparse.</span></span>

<span data-ttu-id="d1d1b-108">Por lo tanto, este artículo intenta proporcionar un único punto de referencia que debería ayudar a solucionar problemas y corregir algunos de los problemas más habituales.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-108">As such, this article attempts to provide a single point of reference that should help troubleshoot and self-remediate some of the most common issues that we see.</span></span> <span data-ttu-id="d1d1b-109">Al mismo tiempo, se ofrecen más instrucciones para diagnosticar las implementaciones más complejas y con mayores problemas.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-109">At the same time offer additional guidance for diagnosing the more complex and troubled of implementation.</span></span>

<span data-ttu-id="d1d1b-110">Tenga en cuenta que en este artículo se da por supuesto lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="d1d1b-110">note that this article makes the following assumptions:</span></span>

-   <span data-ttu-id="d1d1b-111">Se ha implementado el proxy de aplicación de Azure según nuestra [documentación](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-enable) y el acceso general a aplicaciones sin KCD funciona según lo previsto.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-111">Azure Application Proxy has been deployed as per our [documentation](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-enable) and general access to non KCD applications is working as expected.</span></span>

-   <span data-ttu-id="d1d1b-112">La aplicación de destino publicada se basa en IIS y la implementación de Kerberos de Microsoft.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-112">The published target application is based on IIS and Microsoft’s implementation of kerberos.</span></span>

-   <span data-ttu-id="d1d1b-113">Los hosts de servidor y aplicación residen en un único dominio de Active Directory.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-113">The server and application hosts reside in a single Active Directory domain.</span></span> <span data-ttu-id="d1d1b-114">Encontrará información detallada sobre los escenarios de bosque y entre dominios en nuestras [notas del producto para KCD](http://aka.ms/KCDPaper).</span><span class="sxs-lookup"><span data-stu-id="d1d1b-114">Detailed information on cross domain and forest scenarios can be found in our [KCD whitepaper](http://aka.ms/KCDPaper).</span></span>

-   <span data-ttu-id="d1d1b-115">Se publica la aplicación en cuestión en un inquilino de Azure con la autenticación previa habilitada y se espera que los usuarios se autentiquen en Azure mediante la autenticación basada en formularios.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-115">The subject application is published in an Azure tenant with pre-authentication enabled, and users are expected to authenticate to Azure via forms based authentication.</span></span> <span data-ttu-id="d1d1b-116">No se tratan los escenarios de autenticación de cliente compleja en este artículo, pero se agregarán en el futuro.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-116">Rich client authentication scenarios are not covered by this article, but be added at some point in the future.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="d1d1b-117">Requisitos previos</span><span class="sxs-lookup"><span data-stu-id="d1d1b-117">Prerequisites</span></span>

<span data-ttu-id="d1d1b-118">El proxy de aplicación de Azure se puede implementar en prácticamente cualquier tipo de entorno o infraestructura y, seguramente, las arquitecturas varían de una organización a otra.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-118">Azure Application Proxy can be deployed into pretty much any type of infrastructure or environment and the architectures no doubt vary from organization to organization.</span></span> <span data-ttu-id="d1d1b-119">Una de las causas más habituales de los problemas relacionados con KCD no son los entornos en sí, sino simples errores de configuración o descuidos en general.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-119">One of the most common causes of KCD related issues are not the environments themselves, but rather simple mis-configurations, or general oversight.</span></span>

<span data-ttu-id="d1d1b-120">Por esta razón, se aconseja empezar siempre comprobando que se cumplan todos los requisitos previos explicados en el artículo principal [sobre el uso del SSO de KCD con el proxy de aplicación](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd) antes de empezar a intentar solucionar los problemas.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-120">For this reason, our advice is always to start by making sure you have met all the pre-requisites laid out in our main [Using KCD SSO with the Application Proxy article](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd) before starting troubleshooting.</span></span>

<span data-ttu-id="d1d1b-121">En particular, la sección sobre la configuración de KCD en 2012R2, ya que emplea un enfoque esencialmente diferente a la configuración de KCD en versiones anteriores de Windows, sin dejar de tener en cuenta otras consideraciones:</span><span class="sxs-lookup"><span data-stu-id="d1d1b-121">Particularly the section on configuring KCD on 2012R2, as this employs a fundamentally different approach to configuring KCD on previous versions of Windows, but also while being mindful of several other considerations:</span></span>

-   <span data-ttu-id="d1d1b-122">No es raro que un servidor miembro del dominio abra un cuadro de diálogo de canal seguro con un controlador de dominio específico</span><span class="sxs-lookup"><span data-stu-id="d1d1b-122">It is not uncommon for a domain member server to open a secure channel dialog with a specific domain controller.</span></span> <span data-ttu-id="d1d1b-123">y más adelante cambie a otro en un momento dado. Por tanto, en general, los hosts de conector no deberían restringirse a la comunicación exclusiva con controladores de dominio de sitio locales específicos.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-123">Then move to another dialog at any given time, so connector hosts should generally not be restricted to being able to communicate with only specific local site DCs.</span></span>

-   <span data-ttu-id="d1d1b-124">De forma semejante al punto anterior, los escenarios entre dominios se basan en referencias que dirigen a un host de conector a controladores de dominio que pueden residir fuera del perímetro de la red local.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-124">Similar to the above point, cross domain scenarios rely on referrals that direct a connector host to DCs that may reside outside of the local network perimeter.</span></span> <span data-ttu-id="d1d1b-125">En este escenario, es igualmente importante asegurarse de permitir también al tráfico hacia controladores de dominio que representen otros dominios para evitar que la delegación genere un error.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-125">In this scenario it is equally important to make sure you are also allowing traffic onwards to DCs that represent other respective domains, or else delegation fail.</span></span>

-   <span data-ttu-id="d1d1b-126">Siempre que sea posible, debe evitar colocar dispositivos IPS/IDS activos entre los hosts de conector y los controladores de dominio, ya que en ocasiones son demasiado intrusivos e interfieren con el tráfico RPC central.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-126">Where possible, you should avoid placing any active IPS/IDS devices between connector hosts and DCs, as these are sometimes over intrusive and interfere with core RPC traffic</span></span>

<span data-ttu-id="d1d1b-127">Aunque lo ideal sería solucionar los problemas de forma rápida y eficiente, esto puede llevar tiempo, así que, en la medida de lo posible, debería probar la delegación en los escenarios más sencillos.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-127">As much as we’d like to resolve issues quickly and effectively, it can take time, so where possible you should try and test delegation in the simplest of scenarios.</span></span> <span data-ttu-id="d1d1b-128">Cuantas más variables introduzca, con más tendrá que trabajar.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-128">The more variables you introduce, the more you may have to contend with.</span></span> <span data-ttu-id="d1d1b-129">Por ejemplo, si limita las pruebas a un solo conector, puede ahorrar valioso tiempo, y puede agregar más conectores una vez resueltos los problemas.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-129">For example, limiting your testing to a single connector can save valuable time, and additional connectors can be added after the issues has been resolved.</span></span>

<span data-ttu-id="d1d1b-130">Algunos factores del entorno también podrían estar contribuyendo a un problema, así que intente reducir la arquitectura al mínimo para las pruebas.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-130">Some environmental factors may also be contributing to an issue, so again if possible try and minimize the architecture to a bare minimum for testing.</span></span> <span data-ttu-id="d1d1b-131">Por ejemplo, las ACL de firewall interno mal configuradas son habituales, así que, si es posible, permita que todo el tráfico procedente de un conector vaya directamente a los controladores de dominio y la aplicación back-end.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-131">For example, misconfigured internal firewall ACLs are not uncommon, so if possible have all traffic from a connector allowed straight through to the DCs and backend application.</span></span> 

<span data-ttu-id="d1d1b-132">En realidad, el mejor lugar donde colocar conectores es lo más cerca posible de sus destinos.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-132">Actually the absolute best place to position connectors is as close to their targets as can be.</span></span> <span data-ttu-id="d1d1b-133">Tener un firewall en línea durante las pruebas simplemente agrega complejidad innecesaria y podría prolongarlas.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-133">Having a firewall sat inline whilst testing simply adds unnecessary complexity, and could just prolong your investigations.</span></span>

<span data-ttu-id="d1d1b-134">De todos modos, ¿qué constituye un problema de KCD?</span><span class="sxs-lookup"><span data-stu-id="d1d1b-134">So, what constitutes a KCD problem anyway?</span></span> <span data-ttu-id="d1d1b-135">Hay varias indicaciones clásicas de que existen problemas con el SSO de KCD y los primeros signos normalmente se manifiestan en el explorador.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-135">Well, there several classic indications of KCD SSO failing and the first signs of an issue usually manifest themselves in the browser.</span></span>

   ![Error de configuración de KCD incorrecta](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic1.png)

   ![Error de autorización por falta de permisos](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic2.png)

<span data-ttu-id="d1d1b-138">Todos ellos manifiestan el mismo síntoma: no se puede llevar a cabo el SSO y, por consiguiente, se deniega el acceso del usuario a la aplicación.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-138">all which bear the same symptom of failing to perform SSO, and consequently denying the user access to the application.</span></span>

## <a name="troubleshooting"></a><span data-ttu-id="d1d1b-139">Solución de problemas</span><span class="sxs-lookup"><span data-stu-id="d1d1b-139">Troubleshooting</span></span>

<span data-ttu-id="d1d1b-140">Cómo solucione cada problema depende del problema y los síntomas observados.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-140">How you then troubleshoot depend on the issue and observed symptoms.</span></span> <span data-ttu-id="d1d1b-141">Antes de continuar, se recomienda seguir estos vínculos, ya que contienen información útil que puede que desconozca:</span><span class="sxs-lookup"><span data-stu-id="d1d1b-141">Before going any further we would suggest the following links, as they contain useful information you may not yet have come across:</span></span>

-   [<span data-ttu-id="d1d1b-142">Solución de problemas y mensajes de error de Proxy de aplicación</span><span class="sxs-lookup"><span data-stu-id="d1d1b-142">Troubleshoot Application Proxy problems and error messages</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-troubleshoot)

-   [<span data-ttu-id="d1d1b-143">Errores y síntomas de Kerberos</span><span class="sxs-lookup"><span data-stu-id="d1d1b-143">Kerberos errors and symptoms</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-troubleshoot#kerberos-errors)

-   [<span data-ttu-id="d1d1b-144">Trabajar con SSO cuando las identidades locales y en la nube no son idénticas</span><span class="sxs-lookup"><span data-stu-id="d1d1b-144">Working with SSO when on-premises and cloud identities are not identical</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd#working-with-sso-when-on-premises-and-cloud-identities-are-not-identical)

<span data-ttu-id="d1d1b-145">Si ha llegado hasta aquí, el principal problema definitivamente existe.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-145">If you’ve got this far, then the main issue definitely exists.</span></span> <span data-ttu-id="d1d1b-146">Debe investigar un poco más; para ello, empiece separando el flujo en tres fases distintas cuyos problemas pueda solucionar.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-146">You need to dig deeper, so start by separating the flow into three distinct stages that you can troubleshoot.</span></span>

<span data-ttu-id="d1d1b-147">**Autenticación previa del cliente**: el usuario externo se autentica en Azure mediante un explorador.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-147">**Client pre-authentication** - The external user authenticating to Azure via a browser.</span></span>

<span data-ttu-id="d1d1b-148">Es fundamental poder realizar la autenticación previa en Azure para que el SSO de KCD funcione.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-148">Being able to pre-authenticate to Azure is imperative for KCD SSO to function.</span></span> <span data-ttu-id="d1d1b-149">Esto es lo primero que se debe probar y solucionar, si hay algún problema.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-149">This should be tested and addressed first, if there are any issues.</span></span> <span data-ttu-id="d1d1b-150">Tenga en cuenta que la fase de autenticación previa no guarda relación con KCD ni con la aplicación publicada.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-150">Note that the pre-authentication stage has no relation to KCD or the published application.</span></span> <span data-ttu-id="d1d1b-151">Debería ser bastante fácil corregir cualquier discrepancia con una comprobación de que la cuenta en cuestión exista en Azure y de que no esté deshabilitada ni bloqueada.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-151">It should be fairly easy to correct any discrepancies by sanity checking the subject account exists in Azure, and that it is not disabled/blocked.</span></span> <span data-ttu-id="d1d1b-152">La respuesta de error en el explorador suele ser lo bastante descriptiva como para entender la causa.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-152">The error response in the browser is usually descriptive enough to understand the cause.</span></span> <span data-ttu-id="d1d1b-153">También puede leer la documentación sobre solución de problemas como referencia si no está seguro.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-153">You can also check our other Troubleshoot docs to verify if you aren’t sure.</span></span>

<span data-ttu-id="d1d1b-154">**Servicio de delegación**: el conector del proxy de Azure obtiene un vale de servicio de Kerberos de un KDC (Centro de distribución de claves Kerberos), en nombre de los usuarios.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-154">**Delegation service** - The Azure Proxy connector obtaining a kerberos service ticket from a KDC (Kerberos Distribution Center), on behalf of users.</span></span>

<span data-ttu-id="d1d1b-155">Las comunicaciones externas entre el cliente y el front-end de Azure no deberían guardar ninguna relación con KCD, aparte de asegurarse de que funcione.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-155">The external communications between the client and the Azure front end should have no bearing on KCD whatsoever, other than ensuring that it works.</span></span> <span data-ttu-id="d1d1b-156">Esto es para que se pueda proporcionar al servicio de proxy de Azure un identificador de usuario válido que se usará para obtener un vale de Kerberos.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-156">This is so the Azure Proxy service can be provided with a valid user ID that be used to obtain a kerberos ticket.</span></span> <span data-ttu-id="d1d1b-157">Sin este KCD, no es posible y se produciría un error.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-157">Without this KCD is not possible and would fail.</span></span>

<span data-ttu-id="d1d1b-158">Como se mencionó antes, los mensajes de error del explorador suelen proporcionan buenos indicios de por qué se producen errores.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-158">As mentioned previously, the browser error messages usually provide some good clues on why things are failing.</span></span> <span data-ttu-id="d1d1b-159">Asegúrese de anotar el identificador de actividad y la marca de tiempo en la respuesta, ya que esto permite correlacionar el comportamiento con eventos reales en el registro de eventos del proxy de Azure.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-159">Make sure to note down the activity ID and timestamp in the response as this allow you to correlate the behavior to actual events in the Azure Proxy event log.</span></span>

   ![Error de configuración de KCD incorrecta](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic3.png)

<span data-ttu-id="d1d1b-161">Las entradas correspondientes en el registro de eventos se verían como los eventos 13019 o 12027.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-161">And the corresponding entries seen the event log would be seen as events 13019 or 12027.</span></span> <span data-ttu-id="d1d1b-162">Puede encontrar los registros de eventos del conector en **Registros de aplicaciones y servicios** &gt; **Microsoft** &gt; **AadApplicationProxy** &gt; **Conector**&gt;**Administración**.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-162">You can find the connector event logs in **Applications and Services Logs** &gt; **Microsoft** &gt; **AadApplicationProxy** &gt; **Connector**&gt;**Admin**.</span></span>

   ![Evento 13019 del registro de eventos del proxy de aplicación](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic4.png)

   ![Evento 12027 del registro de eventos del proxy de aplicación](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic5.png)

-   <span data-ttu-id="d1d1b-165">Use un registro D en su servicio DNS interno para la dirección de la aplicación, en lugar de un registro CName.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-165">Use an A record in your internal DNS for the application’s address, and not a CName</span></span>

-   <span data-ttu-id="d1d1b-166">Vuelva a confirmar que se han concedido al host de conector los derechos para delegar en el SPN de la cuenta de destino designada y que se ha seleccionado **Usar cualquier protocolo de autenticación**.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-166">Re-confirm that the connector host has been granted the rights to delegate to the designated target account’s SPN, and that **Use any authentication protocol** is selected.</span></span> <span data-ttu-id="d1d1b-167">Esto se trata en el artículo principal [sobre la configuración del SSO](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd).</span><span class="sxs-lookup"><span data-stu-id="d1d1b-167">This is covered in our main [SSO configuration article](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd)</span></span>

-   <span data-ttu-id="d1d1b-168">Compruebe que solo haya una instancia del SPN en AD; para ello, emita **setspn - x** desde un símbolo del sistema en cualquier host miembro de dominio.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-168">Verify that there is only a single instance of the SPN in existence in AD by issuing a **setspn -x** from a cmd prompt on any domain member host</span></span>

-   <span data-ttu-id="d1d1b-169">Compruebe si se está aplicando una directiva de dominio para limitar el [tamaño máximo de tokens de Kerberos emitidos](https://blogs.technet.microsoft.com/askds/2012/09/12/maxtokensize-and-windows-8-and-windows-server-2012/), ya que esto impide que el conector obtenga un token si se considera excesivo.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-169">Check to see if a domain policy is being enforced to limit the [max size of issued kerberos tokens](https://blogs.technet.microsoft.com/askds/2012/09/12/maxtokensize-and-windows-8-and-windows-server-2012/), as this prevent the connector from obtaining a token if found to be excessive</span></span>

<span data-ttu-id="d1d1b-170">El siguiente paso que se recomienda para más información de bajo nivel sobre los problemas es un seguimiento de red que capture los intercambios entre el host de conector y un KDC de dominio.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-170">A network trace capturing the exchanges between the connector host and a domain KDC would then be the next best step in obtaining more low level detail on the issues.</span></span> <span data-ttu-id="d1d1b-171">Puede encontrarlo en el [artículo que profundiza en la solución de problemas](https://aka.ms/proxytshootpaper).</span><span class="sxs-lookup"><span data-stu-id="d1d1b-171">You can find this in [deep dive Troubleshoot paper](https://aka.ms/proxytshootpaper).</span></span>

<span data-ttu-id="d1d1b-172">Si la generación de vales no presenta problemas, debería ver un evento en los registros que indique que se produjo un error en la autenticación porque la aplicación devolvió un error 401.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-172">If ticketing looks good, you should see an event in the logs stating that authentication failed due to the application returning a 401.</span></span> <span data-ttu-id="d1d1b-173">Esto suele indicar que la aplicación de destino rechaza el vale; por tanto, continúe con la siguiente fase.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-173">This typically indicates that the target application rejecting your ticket, so proceed with the following next stage.</span></span>

<span data-ttu-id="d1d1b-174">**Aplicación de destino**: el consumidor del vale de Kerberos proporcionado por el conector.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-174">**Target application** - The consumer of the kerberos ticket provided by the connector</span></span>

<span data-ttu-id="d1d1b-175">En esta fase se espera que el conector haya enviado un vale de servicio de Kerberos al back-end, como encabezado de la primera solicitud de aplicación.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-175">At this stage the connector is expected to have sent a kerberos service ticket to the backend, as a header within the first application request.</span></span>

-   <span data-ttu-id="d1d1b-176">Utilizando la dirección URL interna de la aplicación definida en el portal, valide que la aplicación sea accesible directamente desde el explorador en el host de conector.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-176">Using the application’s internal URL defined in the portal, validate that the application is accessible directly from the browser on the connector host.</span></span> <span data-ttu-id="d1d1b-177">Entonces, puede iniciar sesión correctamente.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-177">Then you can login successfully.</span></span> <span data-ttu-id="d1d1b-178">Encontrará detalles sobre cómo hacerlo en la página de solución de problemas del conector.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-178">Details on doing this can be found on the connector Troubleshoot page.</span></span>

-   <span data-ttu-id="d1d1b-179">Todavía en el host de conector, confirme que la autenticación entre el explorador y la aplicación esté utilizando Kerberos, mediante una de las siguientes acciones:</span><span class="sxs-lookup"><span data-stu-id="d1d1b-179">Still on the connector host, confirm that the authentication between the browser and the application is using kerberos, by doing one of the following:</span></span>

1.  <span data-ttu-id="d1d1b-180">Ejecute Herramientas de desarrollo (**F12**) en Internet Explorer o utilice [Fiddler](https://blogs.msdn.microsoft.com/crminthefield/2012/10/10/using-fiddler-to-check-for-kerberos-auth/) desde el host de conector.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-180">Run Dev tools(**F12**) in Internet Explorer, or use [Fiddler](https://blogs.msdn.microsoft.com/crminthefield/2012/10/10/using-fiddler-to-check-for-kerberos-auth/) from the connector host.</span></span> <span data-ttu-id="d1d1b-181">Vaya a la aplicación con la dirección URL interna e inspeccione los encabezados de autorización de World Wide Web ofrecidos que se devuelven en la respuesta de la aplicación, para asegurarse de que Negociar o Kerberos esté presente.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-181">Go to the application using the internal URL, and inspect the offered WWW authorization headers returned in the response from the application, to ensure that either negotiate or kerberos is present.</span></span> <span data-ttu-id="d1d1b-182">Un blob de Kerberos posterior, devuelto en la respuesta del explorador a la aplicación, suele empezar por **YII**, así que esto es una buena indicación de la implicación de Kerberos.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-182">A subsequent kerberos blob returned in the response from the browser to the application typically start with **YII**, so this is a good indication of kerberos being in play.</span></span> <span data-ttu-id="d1d1b-183">Por otra parte, NTLM siempre empieza por **TlRMTVNTUAAB**, que se convierte en NTLMSSP cuando se descodifica desde Base64.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-183">NTLM on the other hand always start with **TlRMTVNTUAAB**, which reads NTLMSSP when decoded from Base64.</span></span> <span data-ttu-id="d1d1b-184">Si ve **TlRMTVNTUAAB** al principio del blob, significa que Kerberos **no** está disponible.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-184">If you see **TlRMTVNTUAAB** at the start of the blob, this means that Kerberos is **not** available.</span></span> <span data-ttu-id="d1d1b-185">Si no lo ve, es probable que Kerberos esté disponible.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-185">If you don’t see this, Kerberos is likely available.</span></span>

  * <span data-ttu-id="d1d1b-186">Tenga en cuenta que, si usa Fiddler, este método requiere deshabilitar temporalmente la protección ampliada en la configuración de la aplicación en IIS.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-186">Note, if using Fiddler, this method would require temporarily disabling extended protection on the application’s config in IIS.</span></span>

     ![Ventana de inspección de red del explorador](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic6.png)

    <span data-ttu-id="d1d1b-188">*Ilustración:* como no empieza por TIRMTVNTUAAB, en este ejemplo, Kerberos está disponible.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-188">*Figure:* Since this does not start with TIRMTVNTUAAB, this is an example that Kerberos is available.</span></span> <span data-ttu-id="d1d1b-189">Se trata de un ejemplo de blob de Kerberos que no empieza por YII.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-189">This is an example of a Kerberos Blob that doesn’t start with YII.</span></span>

2.  <span data-ttu-id="d1d1b-190">Quite NTLM temporalmente de la lista de proveedores en el sitio de IIS y acceda a la aplicación directamente desde Internet Explorer en el host de conector.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-190">Temporarily remove NTLM from the providers list on IIS site and access app directly from IE on connector host.</span></span> <span data-ttu-id="d1d1b-191">Con NTLM eliminado de la lista de proveedores, debería tener acceso a la aplicación solo mediante Kerberos.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-191">With NTLM no longer in the providers list, you should be able to access the application using Kerberos only.</span></span> <span data-ttu-id="d1d1b-192">Si se produce un error, esto indica que hay un problema con la configuración de la aplicación y que la autenticación Kerberos no funciona.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-192">If this fails, then that suggests that there is a problem with the application’s configuration and Kerberos authentication is not functioning.</span></span>

<span data-ttu-id="d1d1b-193">Si Kerberos no está disponible, compruebe la configuración de autenticación de la aplicación en IIS para asegurarse de que Negociar aparezca en primer lugar, con NTLM justo después.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-193">If Kerberos is not available, then check the application’s authentication settings in IIS to make sure negotiate is listed topmost, with NTLM just beneath it.</span></span> <span data-ttu-id="d1d1b-194">(No Negociar:Kerberos o Negociar:PKU2U).</span><span class="sxs-lookup"><span data-stu-id="d1d1b-194">(Not Negotiate:kerberos or Negotiate:PKU2U).</span></span> <span data-ttu-id="d1d1b-195">Continúe solamente si Kerberos es funcional.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-195">Only continue if Kerberos is functional.</span></span>

   ![Proveedores de autenticación de Windows](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic7.png)
   
-   <span data-ttu-id="d1d1b-197">Con Kerberos y NTLM listos, ahora deshabilite temporalmente la autenticación previa de la aplicación en el portal.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-197">With Kerberos and NTLM in place, lets now temporarily disable pre-authentication for the application in the portal.</span></span> <span data-ttu-id="d1d1b-198">Vea si puede acceder a ella desde Internet mediante la dirección URL externa.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-198">See if you can access it from the internet using the external URL.</span></span> <span data-ttu-id="d1d1b-199">Se le debería pedir que se autenticara y debería poder hacerlo con la misma cuenta que usó en el paso anterior.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-199">You should be prompted to authenticate and should be able to do so with the same account used in the previous step.</span></span> <span data-ttu-id="d1d1b-200">De lo contrario, esto indica un problema con la aplicación back-end y no con KCD.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-200">If not, this indicates a problem with the backend application and not KCD at all.</span></span>

-   <span data-ttu-id="d1d1b-201">Ahora vuelva a habilitar la autenticación previa en el portal y autentíquese por medio de Azure; intente conectarse a la aplicación mediante su dirección URL externa.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-201">Now re-enable pre-authentication in the portal and authenticate through Azure by attempting to connect to the application via it’s external URL.</span></span> <span data-ttu-id="d1d1b-202">Si se produce un error de SSO, verá un mensaje de error Prohibido en el explorador, además del evento 13022 en el registro:</span><span class="sxs-lookup"><span data-stu-id="d1d1b-202">If SSO has failed, then you should see a forbidden error message in the browser, plus event 13022 in the log:</span></span>

    <span data-ttu-id="d1d1b-203">*El conector de proxy de aplicación de Microsoft AAD no puede autenticar al usuario porque el servidor back-end responde a los intentos de autenticación Kerberos con un error HTTP 401.*</span><span class="sxs-lookup"><span data-stu-id="d1d1b-203">*Microsoft AAD Application Proxy Connector cannot authenticate the user because the backend server responds to Kerberos authentication attempts with an HTTP 401 error.*</span></span>

    ![Error HTTTP 401: Prohibido](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic8.png)

-   <span data-ttu-id="d1d1b-205">Compruebe la aplicación IIS para asegurarse de que el grupo de aplicaciones esté configurado para usar la misma cuenta con la que se ha configurado el SPN en AD. Para ello, vaya a IIS, como se muestra a continuación.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-205">Check the IIS application to ensure the configured application pool is configured to use the same account that the SPN has been configured against in AD, by navigating in IIS as illustrated below</span></span>

    ![Ventana de configuración de la aplicación IIS](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic9.png)

    <span data-ttu-id="d1d1b-207">Una vez que conozca la identidad, emita el siguiente comando desde un símbolo del sistema para asegurarse de que esta cuenta esté definitivamente configurada con el SPN en cuestión.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-207">Once you know the identity, issue the following from a cmd prompt to make sure this account is definitely configured with the SPN in question.</span></span> <span data-ttu-id="d1d1b-208">Por ejemplo, **setspn – q http/spn.wacketywack.com**</span><span class="sxs-lookup"><span data-stu-id="d1d1b-208">For example,  **setspn – q http/spn.wacketywack.com**</span></span>

    ![Ventana de comando SetSPN](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic10.png)

-   <span data-ttu-id="d1d1b-210">Compruebe que el SPN definido en la configuración de la aplicación en el portal sea el mismo que está configurado en la cuenta de AD de destino utilizada por el grupo de aplicaciones de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-210">Check that the SPN defined against the application’s settings in the portal is the same SPN that is configured against the target AD account in use by the application’s app pool</span></span>

   ![Configuración del SPN en Azure Portal](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic11.png)
   
-   <span data-ttu-id="d1d1b-212">Vaya a IIS y seleccione la opción **Editor de configuración** para la aplicación; vaya a **system.webServer/security/authentication/windowsAuthentication** para asegurarse de que **UseAppPoolCredentials** esté establecido en Verdadero.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-212">Go into IIS and select the **Configuration Editor** option for the application, and navigate to **system.webServer/security/authentication/windowsAuthentication** to make sure that **UseAppPoolCredentials** is set to true</span></span>

   ![Opción de credencial de grupos de aplicaciones en la configuración de IIS](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic12.png)

<span data-ttu-id="d1d1b-214">Aunque resulta útil para mejorar el rendimiento de las operaciones de Kerberos, dejar el modo kernel habilitado también hace que el vale para el servicio solicitado se descifre mediante la cuenta de equipo.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-214">While being useful in improving the performance of Kerberos operations, leaving Kernel mode enabled also causes the ticket for the requested service to be decrypted using machine account.</span></span> <span data-ttu-id="d1d1b-215">Esto también se denomina sistema local, y tenerlo establecido en Verdadero interrumpe KCD cuando la aplicación está hospedada en varios servidores en una granja.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-215">This is also called the Local system, so having this set to true break KCD when the application is hosted across multiple servers in a farm.</span></span>

-   <span data-ttu-id="d1d1b-216">Como comprobación adicional, también puede deshabilitar la protección **extendida**.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-216">As an additional check, you may also want to disable the **Extended** protection too.</span></span> <span data-ttu-id="d1d1b-217">Se han encontrado escenarios donde se ha demostrado que esto interrumpe KCD cuando está habilitada en configuraciones muy específicas, en las que una aplicación se publica como subcarpeta del sitio web predeterminado.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-217">There have been encountered scenarios where this has proved to break KCD when enabled in very specific configurations, where an application is published as a sub folder of the Default Web site.</span></span> <span data-ttu-id="d1d1b-218">En sí está configurada para la autenticación anónima únicamente y deja cuadros de diálogo enteros atenuados, lo que indica que los objetos secundarios no heredarían ninguna configuración activa.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-218">This itself is configured for Anonymous authentication only, leaving the entire dialogs greyed out suggesting child objects would not be inheriting any active settings.</span></span> <span data-ttu-id="d1d1b-219">Sin embargo, si es posible, se recomienda tenerla siempre habilitada. Desde luego, puede hacer pruebas, pero no se olvide de volver a habilitarla.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-219">But where possible we would always recommend having this enabled, so by all means test, but don’t forget to restore this to enabled.</span></span>

<span data-ttu-id="d1d1b-220">Estas comprobaciones adicionales deberían haberle encaminado a empezar a usar la aplicación publicada.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-220">These additional checks should have put you on track to start using your published application.</span></span> <span data-ttu-id="d1d1b-221">Puede proceder a agregar más conectores que también estén configurados para la delegación pero, a estas alturas, se recomienda leer este tutorial técnico más detallado [La guía completa para solucionar problemas del proxy de aplicación de Azure AD](https://aka.ms/proxytshootpaper).</span><span class="sxs-lookup"><span data-stu-id="d1d1b-221">You can go ahead and spin up additional connectors that are also configured to delegate, but if things are no further then we would suggest a read of our more in-depth technical walkthrough [The complete guide for Troubleshoot Azure AD Application Proxy](https://aka.ms/proxytshootpaper)</span></span>

<span data-ttu-id="d1d1b-222">Si todavía no puede solucionar el problema, el equipo de soporte técnico estará encantado de ayudarle a partir de aquí.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-222">If you’re still unable to progress your issue, support would be more than happy to assist and continue from here.</span></span> <span data-ttu-id="d1d1b-223">Cree un vale de soporte directamente en el portal y nuestros ingenieros se pondrán en contacto.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-223">Create a support ticket directly within the portal and our engineers will reach out to you.</span></span>

## <a name="other-scenarios"></a><span data-ttu-id="d1d1b-224">Otros escenarios</span><span class="sxs-lookup"><span data-stu-id="d1d1b-224">Other scenarios</span></span>

-   <span data-ttu-id="d1d1b-225">El proxy de aplicación de Azure solicita un vale de Kerberos antes de enviar su solicitud a una aplicación.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-225">Azure Application Proxy requests a Kerberos ticket before sending its request to an application.</span></span> <span data-ttu-id="d1d1b-226">Algunas aplicaciones de terceros, como Tableau Server, no aceptan este método de autenticación, sino que esperan que se lleven a cabo negociaciones más convencionales.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-226">Some 3rd party applications such as Tableau Server do not like this method of authenticating, and rather expects the more conventional negotiations to take place,.</span></span> <span data-ttu-id="d1d1b-227">La primera solicitud es anónima, lo que permite que la aplicación responda con los tipos de autenticación que admite mediante un error 401.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-227">The first request is anonymous, allowing the application to respond with the authentication types that it supports through a 401.</span></span>

-   <span data-ttu-id="d1d1b-228">Autenticación de dos saltos: se utiliza normalmente en escenarios con una aplicación en niveles, con un back-end y un front-end, ambos de los cuales requieren autenticación, como SQL Reporting Services.</span><span class="sxs-lookup"><span data-stu-id="d1d1b-228">Double hop authentication - Commonly used in scenarios where an application is tiered, with a backend and front end, both requiring authentication, such as SQL Reporting Services.</span></span>

## <a name="next-steps"></a><span data-ttu-id="d1d1b-229">Pasos siguientes</span><span class="sxs-lookup"><span data-stu-id="d1d1b-229">Next steps</span></span>
[<span data-ttu-id="d1d1b-230">Configuración de la delegación limitada de Kerberos (KCD) en un dominio administrado</span><span class="sxs-lookup"><span data-stu-id="d1d1b-230">Configure kerberos constrained delegation (KCD) on a managed domain</span></span>](https://docs.microsoft.com/azure/active-directory-domain-services/active-directory-ds-enable-kcd)
