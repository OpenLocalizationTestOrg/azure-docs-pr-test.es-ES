---
title: Instrucciones para desarrolladores para Acceso condicional de Azure Active Directory | Microsoft Docs
description: Instrucciones para desarrolladores y escenarios para el acceso condicional de Azure AD
services: active-directory
keywords: 
author: danieldobalian
manager: mbaldwin
editor: PatAltimore
ms.author: dadobali
ms.date: 07/19/2017
ms.assetid: 115bdab2-e1fd-4403-ac15-d4195e24ac95
ms.service: active-directory
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: identity
ms.openlocfilehash: b8fac1b258535fd668b45acbe2c1c8580fb8a340
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 08/18/2017
---
# <a name="developer-guidance-for-azure-active-directory-conditional-access"></a><span data-ttu-id="e7670-103">Instrucciones para desarrolladores para Acceso condicional de Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="e7670-103">Developer Guidance for Azure Active Directory Conditional Access</span></span>

<span data-ttu-id="e7670-104">Azure Active Directory (AD) ofrece varias de maneras para proteger la aplicación y los servicios.</span><span class="sxs-lookup"><span data-stu-id="e7670-104">Azure Active Directory (AD) offers several ways to secure your app and protect a service.</span></span>  <span data-ttu-id="e7670-105">Una de estas características únicas es el acceso condicional.</span><span class="sxs-lookup"><span data-stu-id="e7670-105">One of these unique features is conditional access.</span></span>  <span data-ttu-id="e7670-106">El acceso condicional permite que los desarrolladores y clientes empresariales protejan los servicios de diversas formas, entre las que se incluyen las siguientes:</span><span class="sxs-lookup"><span data-stu-id="e7670-106">Conditional access enables developers and enterprise customers to protect services in a multitude of ways including:</span></span>

* <span data-ttu-id="e7670-107">Multi-Factor Authentication</span><span class="sxs-lookup"><span data-stu-id="e7670-107">Multi-factor authentication</span></span>
* <span data-ttu-id="e7670-108">Autorización para que solo los dispositivos inscritos en Intune accedan a servicios específicos</span><span class="sxs-lookup"><span data-stu-id="e7670-108">Allowing only Intune enrolled devices to access specific services</span></span>
* <span data-ttu-id="e7670-109">Restricción de ubicaciones de usuario e intervalos IP</span><span class="sxs-lookup"><span data-stu-id="e7670-109">Restricting user locations and IP ranges</span></span>

<span data-ttu-id="e7670-110">Para más información sobre la totalidad de funcionalidades de acceso condicional, consulte [Acceso condicional en el Portal de Azure clásico](../active-directory-conditional-access.md).</span><span class="sxs-lookup"><span data-stu-id="e7670-110">For more information on the full capabilities of conditional access, see [Conditional access in the Azure classic portal](../active-directory-conditional-access.md).</span></span> 

<span data-ttu-id="e7670-111">En este artículo, nos centramos en el significado que tiene el acceso condicional para los desarrolladores que compilan aplicaciones para Azure AD.</span><span class="sxs-lookup"><span data-stu-id="e7670-111">In this article, we focus on what conditional access means to developers building apps for Azure AD.</span></span>  <span data-ttu-id="e7670-112">En él se supone que tiene conocimientos de aplicaciones de inquilino [único](active-directory-integrating-applications.md) y [multiinquilino](active-directory-devhowto-multi-tenant-overview.md), además de los [patrones comunes de autenticación](active-directory-authentication-scenarios.md).</span><span class="sxs-lookup"><span data-stu-id="e7670-112">It assumes knowledge of [single](active-directory-integrating-applications.md) and [multi-tenant](active-directory-devhowto-multi-tenant-overview.md) apps and [common authentication patterns](active-directory-authentication-scenarios.md).</span></span>

<span data-ttu-id="e7670-113">Analizaremos en profundidad el impacto de acceder a recursos sobre los cuales no tiene control y en los que se puedan aplicar directivas de acceso condicional.</span><span class="sxs-lookup"><span data-stu-id="e7670-113">We'll dive into the impact of accessing resources you don't have control over that may have conditional access policies applied.</span></span>  <span data-ttu-id="e7670-114">Además, exploraremos las implicaciones del acceso condicional en el flujo en el nombre de y aplicaciones web, mediante el acceso a Microsoft Graph y llamando a API.</span><span class="sxs-lookup"><span data-stu-id="e7670-114">Moreover, we explore the implications of conditional access in the on-behalf-of flow, web apps, accessing the Microsoft Graph, and calling APIs.</span></span>

## <a name="how-does-conditional-access-impact-an-app"></a><span data-ttu-id="e7670-115">¿Cómo el acceso condicional impacta a una aplicación?</span><span class="sxs-lookup"><span data-stu-id="e7670-115">How does conditional access impact an app?</span></span>

### <a name="app-topologies-impacted"></a><span data-ttu-id="e7670-116">Topologías de aplicaciones afectadas</span><span class="sxs-lookup"><span data-stu-id="e7670-116">App topologies impacted</span></span>

<span data-ttu-id="e7670-117">En los casos más comunes, el acceso condicional no cambia el comportamiento de una aplicación ni requiere ningún cambio por parte del desarrollador.</span><span class="sxs-lookup"><span data-stu-id="e7670-117">In most common cases, conditional access does not change an app's behavior or requires any changes from the developer.</span></span>  <span data-ttu-id="e7670-118">Solo en ciertos casos en los que una aplicación, de manera indirecta o silenciosa, solicita un token para un servicio, una aplicación requiere cambios en el código para controlar los "desafíos" del acceso condicional.</span><span class="sxs-lookup"><span data-stu-id="e7670-118">Only in certain cases when an app indirectly or silently requests a token for a service, an app requires code changes to handle conditional access "challenges".</span></span>  <span data-ttu-id="e7670-119">Puede ser tan sencillo como realizar una solicitud de inicio de sesión interactiva.</span><span class="sxs-lookup"><span data-stu-id="e7670-119">It may be as simple as performing an interactive sign-in request.</span></span> 

<span data-ttu-id="e7670-120">En concreto, los escenarios siguientes requieren código para controlar los "desafíos" del acceso condicional:</span><span class="sxs-lookup"><span data-stu-id="e7670-120">Specifically, the following scenarios require code to handle conditional access "challenges":</span></span> 

* <span data-ttu-id="e7670-121">Aplicaciones que acceden a Microsoft Graph</span><span class="sxs-lookup"><span data-stu-id="e7670-121">Apps accessing the Microsoft Graph</span></span>
* <span data-ttu-id="e7670-122">Aplicaciones que realizan el flujo "en nombre de"</span><span class="sxs-lookup"><span data-stu-id="e7670-122">Apps performing the on-behalf-of flow</span></span>
* <span data-ttu-id="e7670-123">Aplicaciones que acceden a varios servicios o recursos</span><span class="sxs-lookup"><span data-stu-id="e7670-123">Apps accessing multiple services/resources</span></span>
* <span data-ttu-id="e7670-124">Aplicaciones de una sola página que usan ADAL.js</span><span class="sxs-lookup"><span data-stu-id="e7670-124">Single page apps using ADAL.js</span></span>

<span data-ttu-id="e7670-125">Las directivas de acceso condicional se pueden aplicar a la aplicación, pero también se pueden aplicar a una API web a la que accede la aplicación.</span><span class="sxs-lookup"><span data-stu-id="e7670-125">Conditional access policies can be applied to the app, but also can be applied to a web API your app accesses.</span></span> <span data-ttu-id="e7670-126">Para más información sobre cómo configurar una directiva de acceso condicional, consulte [Introducción al acceso condicional de Azure Active Directory](../active-directory-conditional-access-azuread-connected-apps.md#configure-per-application-access-rules).</span><span class="sxs-lookup"><span data-stu-id="e7670-126">To learn more about how to configure a conditional access policy, please see [Getting started with Azure Active Directory Conditional Access](../active-directory-conditional-access-azuread-connected-apps.md#configure-per-application-access-rules).</span></span>

<span data-ttu-id="e7670-127">Según el escenario, un cliente empresarial puede aplicar y quitar directivas de acceso condicional en cualquier momento.</span><span class="sxs-lookup"><span data-stu-id="e7670-127">Depending on the scenario, an enterprise customer can apply and remove conditional access policies at any time.</span></span>  <span data-ttu-id="e7670-128">Con el fin de que la aplicación siga funcionando cuando se aplica una directiva nueva, es necesario implementar el control de "desafíos".</span><span class="sxs-lookup"><span data-stu-id="e7670-128">In order for your app to continue functioning when a new policy is applied, you need to implement the "challenge" handling.</span></span> <span data-ttu-id="e7670-129">En los ejemplos siguientes se ilustra el control de desafíos.</span><span class="sxs-lookup"><span data-stu-id="e7670-129">The following examples illustrate challenge handling.</span></span> 

### <a name="conditional-access-examples"></a><span data-ttu-id="e7670-130">Ejemplos de acceso condicional</span><span class="sxs-lookup"><span data-stu-id="e7670-130">Conditional access examples</span></span>

<span data-ttu-id="e7670-131">En algunos escenarios se requieren cambios en el código para controlar el acceso condicional, mientras que en otros se trabaja tal cual.</span><span class="sxs-lookup"><span data-stu-id="e7670-131">Some scenarios require code changes to handle conditional access whereas others work as is.</span></span>  <span data-ttu-id="e7670-132">Estos son algunos escenarios que usan el acceso condicional para realizar la autenticación multifactor que proporciona información sobre la diferencia.</span><span class="sxs-lookup"><span data-stu-id="e7670-132">Here are a few scenarios using conditional access to do multi-factor authentication that gives some insight into the difference.</span></span>

* <span data-ttu-id="e7670-133">Se genera una aplicación iOS de inquilino único y se aplica una directiva de acceso condicional.</span><span class="sxs-lookup"><span data-stu-id="e7670-133">You are building a single-tenant iOS app and apply a conditional access policy.</span></span>  <span data-ttu-id="e7670-134">La aplicación inicia la sesión de un usuario y no solicita acceso a una API.</span><span class="sxs-lookup"><span data-stu-id="e7670-134">The app signs in a user and doesn't request access to an API.</span></span>  <span data-ttu-id="e7670-135">Cuando el usuario inicia sesión, la directiva se invoca automáticamente y el usuario debe realizar la autenticación multifactor (MFA).</span><span class="sxs-lookup"><span data-stu-id="e7670-135">When the user signs in, the policy is automatically invoked and the user needs to perform multi-factor authentication (MFA).</span></span> 
* <span data-ttu-id="e7670-136">Crea una aplicación web multiinquilino que usa Microsoft Graph para acceder a Exchange, entre otros servicios.</span><span class="sxs-lookup"><span data-stu-id="e7670-136">You are building a multi-tenant web app that uses the Microsoft Graph to access Exchange, among other services.</span></span>  <span data-ttu-id="e7670-137">Un cliente empresarial que adopta esta aplicación establece una directiva en SharePoint Online.</span><span class="sxs-lookup"><span data-stu-id="e7670-137">An enterprise customer who adopts this app sets a policy on SharePoint Online.</span></span>  <span data-ttu-id="e7670-138">Cuando la aplicación web solicita un token para MS Graph, se aplica una directiva sobre cualquier servicio de Microsoft (específicamente los servicios a los que se puede acceder a través de Graph).</span><span class="sxs-lookup"><span data-stu-id="e7670-138">When the web app requests a token for MS Graph, a policy on any Microsoft Service is applied (specifically services that can be accessed through graph).</span></span>  <span data-ttu-id="e7670-139">A este usuario final se le solicita que realice MFA.</span><span class="sxs-lookup"><span data-stu-id="e7670-139">This end-user is prompted for MFA.</span></span> <span data-ttu-id="e7670-140">En el caso en cuestión, el usuario final inicia sesión con tokens válidos, se devuelve un "desafío" de notificaciones a la aplicación web.</span><span class="sxs-lookup"><span data-stu-id="e7670-140">In the case, the end-user is signed in with valid tokens, a claims "challenge" is returned to the web app.</span></span>  
* <span data-ttu-id="e7670-141">Compila una aplicación nativa que usa un servicio de nivel intermedio para acceder a Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="e7670-141">You are building a native app that uses a middle tier service to access the Microsoft Graph.</span></span>  <span data-ttu-id="e7670-142">Un cliente empresarial de la empresa usa esta aplicación y aplica una directiva a Exchange Online.</span><span class="sxs-lookup"><span data-stu-id="e7670-142">An enterprise customer at the company using this app applies a policy to Exchange Online.</span></span>  <span data-ttu-id="e7670-143">Cuando un usuario final inicia sesión, la aplicación nativa solicita acceso al nivel intermedio y envía el token.</span><span class="sxs-lookup"><span data-stu-id="e7670-143">When an end-user signs in, the native app requests access to the middle tier and sends the token.</span></span>  <span data-ttu-id="e7670-144">El nivel intermedio realiza el flujo "en nombre de" para solicitar acceso a MS Graph.</span><span class="sxs-lookup"><span data-stu-id="e7670-144">The middle tier performs on-behalf-of flow to request access to the MS Graph.</span></span>  <span data-ttu-id="e7670-145">En este punto, se presenta un "desafío" de notificaciones al nivel intermedio.</span><span class="sxs-lookup"><span data-stu-id="e7670-145">At this point, a claims "challenge" is presented to the middle tier.</span></span> <span data-ttu-id="e7670-146">El nivel intermedio envía el desafío de vuelta a la aplicación nativa, la que necesita cumplir con la directiva de acceso condicional.</span><span class="sxs-lookup"><span data-stu-id="e7670-146">The middle tier sends the challenge back to the native app, which needs to comply with the conditional access policy.</span></span>

### <a name="complying-with-a-conditional-access-policy"></a><span data-ttu-id="e7670-147">Cumplimiento con una directiva de acceso condicional</span><span class="sxs-lookup"><span data-stu-id="e7670-147">Complying with a conditional access policy</span></span>

<span data-ttu-id="e7670-148">En el caso de varias topologías de aplicaciones distintas, se evalúa una directiva de acceso condicional cuando se establece la sesión.</span><span class="sxs-lookup"><span data-stu-id="e7670-148">For several different app topologies, a conditional access policy is evaluated when the session is established.</span></span>  <span data-ttu-id="e7670-149">Si bien una directiva de acceso condicional opera en la granularidad de aplicaciones y servicios, el punto en que se invoca depende en gran medida del escenario que intenta lograr.</span><span class="sxs-lookup"><span data-stu-id="e7670-149">As a conditional access policy operates on the granularity of apps and services, the point at which it is invoked depends heavily on the scenario you're trying to accomplish.</span></span>

<span data-ttu-id="e7670-150">Cuando la aplicación intenta acceder a un servicio con una directiva de acceso condicional, podría encontrar un desafío de acceso condicional.</span><span class="sxs-lookup"><span data-stu-id="e7670-150">When your app attempts to access a service with a conditional access policy, it may encounter a conditional access challenge.</span></span>  <span data-ttu-id="e7670-151">Este desafío se codifica en el parámetro `claims` que se incluye en una respuesta de Azure AD o Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="e7670-151">This challenge is encoded in the `claims` parameter that comes in a response from Azure AD or the Microsoft Graph.</span></span>  <span data-ttu-id="e7670-152">Este es un ejemplo de este parámetro de desafío:</span><span class="sxs-lookup"><span data-stu-id="e7670-152">Here's an example of this challenge parameter:</span></span> 

```
claims={"access_token":{"polids":{"essential":true,"Values":["<GUID>"]}}}
```

<span data-ttu-id="e7670-153">Los desarrolladores pueden tomar este desafío y anexarlo a una solicitud nueva a Azure AD.</span><span class="sxs-lookup"><span data-stu-id="e7670-153">Developers can take this challenge and append it onto a new request to Azure AD.</span></span>  <span data-ttu-id="e7670-154">Cuando se pasa este estado, se solicita al usuario final que realice cualquier acción necesaria para cumplir con la directiva de acceso condicional.</span><span class="sxs-lookup"><span data-stu-id="e7670-154">Passing this state prompts the end-user to perform any action necessary to comply with the conditional access policy.</span></span> <span data-ttu-id="e7670-155">En los escenarios siguientes, se explican los detalles específicos del error y cómo extraer el parámetro.</span><span class="sxs-lookup"><span data-stu-id="e7670-155">In the following scenarios, specifics of the error and how to extract the parameter are explained.</span></span> 

## <a name="scenarios"></a><span data-ttu-id="e7670-156">Escenarios</span><span class="sxs-lookup"><span data-stu-id="e7670-156">Scenarios</span></span>

### <a name="prerequisites"></a><span data-ttu-id="e7670-157">Requisitos previos</span><span class="sxs-lookup"><span data-stu-id="e7670-157">Prerequisites</span></span>

<span data-ttu-id="e7670-158">El acceso condicional de Azure AD es una característica que se incluye en [Azure AD Premium](../active-directory-whatis.md#choose-an-edition).</span><span class="sxs-lookup"><span data-stu-id="e7670-158">Azure AD conditional access is a feature included in [Azure AD Premium](../active-directory-whatis.md#choose-an-edition).</span></span>  <span data-ttu-id="e7670-159">Puede obtener más información sobre los requisitos de licencia en el [informe de uso sin licencia](../active-directory-conditional-access-unlicensed-usage-report.md).</span><span class="sxs-lookup"><span data-stu-id="e7670-159">You can learn more about licensing requirements in the [unlicensed usage report](../active-directory-conditional-access-unlicensed-usage-report.md).</span></span>  <span data-ttu-id="e7670-160">Los desarrolladores pueden unirse a [Microsoft Developer Network](https://msdn.microsoft.com/dn308572.aspx), que incluye una suscripción gratis a Enterprise Mobility Suite que, a su vez, incluye Azure AD Premium.</span><span class="sxs-lookup"><span data-stu-id="e7670-160">Developers can join the [Microsoft Developer Network](https://msdn.microsoft.com/dn308572.aspx), which includes a free subscription to the Enterprise Mobility Suite which includes Azure AD Premium.</span></span>

### <a name="considerations-for-specific-scenarios"></a><span data-ttu-id="e7670-161">Consideraciones para escenarios específicos</span><span class="sxs-lookup"><span data-stu-id="e7670-161">Considerations for specific scenarios</span></span>

<span data-ttu-id="e7670-162">La información siguiente solo se aplica en estos escenarios de acceso condicional:</span><span class="sxs-lookup"><span data-stu-id="e7670-162">The following information only applies in these conditional access scenarios:</span></span>

* <span data-ttu-id="e7670-163">Aplicaciones que acceden a Microsoft Graph</span><span class="sxs-lookup"><span data-stu-id="e7670-163">Apps accessing the Microsoft Graph</span></span>
* <span data-ttu-id="e7670-164">Aplicaciones que realizan el flujo "en nombre de"</span><span class="sxs-lookup"><span data-stu-id="e7670-164">Apps performing the on-behalf-of flow</span></span>
* <span data-ttu-id="e7670-165">Aplicaciones que acceden a varios servicios o recursos</span><span class="sxs-lookup"><span data-stu-id="e7670-165">Apps accessing multiple services/resources</span></span>
* <span data-ttu-id="e7670-166">Aplicaciones de una sola página que usan ADAL.js</span><span class="sxs-lookup"><span data-stu-id="e7670-166">Single page apps using ADAL.js</span></span>

<span data-ttu-id="e7670-167">En las secciones siguientes, describiremos escenarios comunes mucho más complejos.</span><span class="sxs-lookup"><span data-stu-id="e7670-167">In the following sections, we'll get into common scenarios in which are more complex.</span></span>  <span data-ttu-id="e7670-168">El principio operativo central es que las directivas de acceso condicional se evalúan en el momento en que se solicita el token para el servicio que tiene aplicada una directiva de acceso condicional, a menos que se acceda a través de Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="e7670-168">The core operating principle is conditional access policies are evaluated at the time the token is requested for the service that has a conditional access policy applied unless it's being accessed through the Microsoft Graph.</span></span>

### <a name="scenario-app-accessing-the-microsoft-graph"></a><span data-ttu-id="e7670-169">Escenario: Aplicación que accede a Microsoft Graph</span><span class="sxs-lookup"><span data-stu-id="e7670-169">Scenario: App accessing the Microsoft Graph</span></span>

<span data-ttu-id="e7670-170">En este escenario, analizaremos un caso en el que una aplicación web solicita acceso a Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="e7670-170">In this scenario, we walk through the case when a web app requests access to the Microsoft Graph.</span></span> <span data-ttu-id="e7670-171">En este caso, la directiva de acceso condicional se podría asignar a SharePoint, Exchange o algún otro servicio al que se accede como carga de trabajo mediante Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="e7670-171">The conditional access policy in this case could be assigned to SharePoint, Exchange, or some other service that is accessed as a workload through the Microsoft Graph.</span></span>  <span data-ttu-id="e7670-172">En este ejemplo, vamos a suponer que hay una directiva de acceso condicional en SharePoint Online.</span><span class="sxs-lookup"><span data-stu-id="e7670-172">In this example, let's assume there's a conditional access policy on Sharepoint Online.</span></span>

![Diagrama de flujo de la aplicación que accede a Microsoft Graph](media/active-directory-conditional-access-developer/app-accessing-microsoft-graph-scenario.png)

<span data-ttu-id="e7670-174">En primer lugar, la aplicación solicita autorización a Microsoft Graph, lo que requiere acceder a una carga de trabajo de bajada sin acceso condicional.</span><span class="sxs-lookup"><span data-stu-id="e7670-174">The app first requests authorization to the Microsoft Graph which requires accessing a downstream workload without conditional access.</span></span>  <span data-ttu-id="e7670-175">La solicitud se realiza correctamente sin invocar ninguna directiva y la aplicación recibe tokens para Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="e7670-175">The request succeeds without invoking any policy and the app receives tokens for Microsoft Graph.</span></span>  <span data-ttu-id="e7670-176">En este punto, la aplicación puede usar el token de acceso en la solicitud de portador del punto de conexión solicitado.</span><span class="sxs-lookup"><span data-stu-id="e7670-176">At this point, the app may use the access token in a bearer request for the endpoint requested.</span></span> <span data-ttu-id="e7670-177">Ahora, la aplicación necesita acceder a un punto de conexión de SharePoint Online de Microsoft Graph, por ejemplo: `https://graph.microsoft.com/v1.0/me/mySite`</span><span class="sxs-lookup"><span data-stu-id="e7670-177">Now, the app needs to access a Sharepoint Online endpoint of Microsoft Graph, for example: `https://graph.microsoft.com/v1.0/me/mySite`</span></span>

<span data-ttu-id="e7670-178">La aplicación ya tiene un token válido para Microsoft Graph, por lo que puede realizar la solicitud nueva sin que se emita un token nuevo.</span><span class="sxs-lookup"><span data-stu-id="e7670-178">The app already has a valid token for the Microsoft Graph, so it can perform the new request without being issued a new token.</span></span> <span data-ttu-id="e7670-179">Esta solicitud genera un error y se emite un desafío de notificaciones desde Microsoft Graph con el formato de HTTP 403 Prohibido con un desafío ```WWW-Authenticate```.</span><span class="sxs-lookup"><span data-stu-id="e7670-179">This request fails and a claims challenge is issued from Microsoft Graph in the form of an HTTP 403 Forbidden with a ```WWW-Authenticate``` challenge.</span></span>
<span data-ttu-id="e7670-180">Este es un ejemplo de la respuesta:</span><span class="sxs-lookup"><span data-stu-id="e7670-180">Here's an example of the response:</span></span> 

```
HTTP 403; Forbidden 
error=insufficient_claims
www-authenticate="Bearer realm="", authorization_uri="https://login.windows.net/common/oauth2/authorize", client_id="<GUID>", error=insufficient_claims, claims={"access_token":{"polids":{"essential":true,"values":["<GUID>"]}}}"
```

<span data-ttu-id="e7670-181">El desafío de notificaciones está dentro del encabezado ```WWW-Authenticate```, que se puede analizar para extraer el parámetro de notificaciones correspondiente a la solicitud siguiente.</span><span class="sxs-lookup"><span data-stu-id="e7670-181">The claims challenge is inside the ```WWW-Authenticate``` header, which can be parsed to extract the claims parameter for the next request.</span></span>  <span data-ttu-id="e7670-182">Una vez que se anexa a la solicitud nueva, Azure AD sabe evaluar la directiva de acceso condicional cuando el usuario inicia sesión y ahora la aplicación cumple con la directiva de acceso condicional.</span><span class="sxs-lookup"><span data-stu-id="e7670-182">Once it's appended to the new request, Azure AD knows to evaluate the conditional access policy when signing in the user and the app is now in compliance with the conditional access policy.</span></span>  <span data-ttu-id="e7670-183">La repetición de la solicitud al punto de conexión de SharePoint Online se realiza correctamente.</span><span class="sxs-lookup"><span data-stu-id="e7670-183">Repeating the request to the Sharepoint Online endpoint succeeds.</span></span>

<span data-ttu-id="e7670-184">Para códigos de ejemplo que demuestran cómo controlar el desafío de notificaciones, consulte el [código de ejemplo de escritorio de .NET](https://github.com/Azure-Samples/active-directory-dotnet-native-desktop) para ADAL .NET o el [ejemplo de código "en nombre de"](https://github.com/Azure-Samples/active-directory-dotnet-webapi-onbehalfof-ca) para ADAL .NET.</span><span class="sxs-lookup"><span data-stu-id="e7670-184">For code samples that demonstrate how to handle the claims challenge, refer to the [.NET Desktop code sample](https://github.com/Azure-Samples/active-directory-dotnet-native-desktop) for ADAL .NET or the [On-behalf-of code sample](https://github.com/Azure-Samples/active-directory-dotnet-webapi-onbehalfof-ca) for ADAL .NET.</span></span>

### <a name="scenario-app-performing-the-on-behalf-of-flow"></a><span data-ttu-id="e7670-185">Escenario: Aplicación que realiza el flujo "en nombre de"</span><span class="sxs-lookup"><span data-stu-id="e7670-185">Scenario: App performing the on-behalf-of flow</span></span>

<span data-ttu-id="e7670-186">En este escenario, analizaremos un caso en el que una aplicación nativa llama a una API o servicio web.</span><span class="sxs-lookup"><span data-stu-id="e7670-186">In this scenario, we walk through the case in which a native app calls a web service/API.</span></span>  <span data-ttu-id="e7670-187">A su vez, este servicio realiza [el flujo "en nombre de"](active-directory-authentication-scenarios.md#application-types-and-scenarios) para llamar a un servicio de bajada.</span><span class="sxs-lookup"><span data-stu-id="e7670-187">In turn, this service does [the "on-behalf-of" flow](active-directory-authentication-scenarios.md#application-types-and-scenarios) to call a downstream service.</span></span>  <span data-ttu-id="e7670-188">En este caso, se aplica la directiva de acceso condicional al servicio de bajada (API web 2) y se usa una aplicación nativa en lugar de una aplicación demonio/servidor.</span><span class="sxs-lookup"><span data-stu-id="e7670-188">In our case, we've applied our conditional access policy to the downstream service (Web API 2) and are using a native app rather than a server/daemon app.</span></span> 

![Aplicación que realiza el flujo "en nombre de"](media/active-directory-conditional-access-developer/app-performing-on-behalf-of-scenario.png)

<span data-ttu-id="e7670-190">La solicitud de token inicial para API web 1 no solicita al usuario final que realice la autenticación multifactor, dado que API web 1 no siempre puede alcanzar la API de bajada.</span><span class="sxs-lookup"><span data-stu-id="e7670-190">The initial token request for Web API 1 does not prompt the end-user for multi-factor authentication as Web API 1 may not always hit the downstream API.</span></span>  <span data-ttu-id="e7670-191">Una vez que API web 1 intenta solicitar un token en nombre del usuario para API web 2, la solicitud genera un error porque el usuario no inició sesión con la autenticación multifactor.</span><span class="sxs-lookup"><span data-stu-id="e7670-191">Once Web API 1 tries to request a token on-behalf-of the user for Web API 2, the request fails since the user has not signed in with multi-factor authentication.</span></span>

<span data-ttu-id="e7670-192">Azure AD devuelve una respuesta HTTP con algunos datos interesantes:</span><span class="sxs-lookup"><span data-stu-id="e7670-192">Azure AD returns an HTTP response with some interesting data:</span></span> 

> [!NOTE]
> <span data-ttu-id="e7670-193">En esta instancia se trata de la descripción de un error de autenticación multifactor, sino que es un intervalo amplio de `interaction_required` posiblemente perteneciente al acceso condicional.</span><span class="sxs-lookup"><span data-stu-id="e7670-193">In this instance it's a multi-factor authentication error description, but there's a wide range of `interaction_required` possible pertaining to conditional access.</span></span>  

```
HTTP 400; Bad Request 
error=interaction_required
error_description=AADSTS50076: Due to a configuration change made by your administrator, or because you moved to a new location, you must use multi-factor authentication to access '<Web API 2 App/Client ID>'.
claims={"access_token":{"polids":{"essential":true,"Values":["<GUID>"]}}}
```

<span data-ttu-id="e7670-194">En la API web 1, se captura el error `error=interaction_required` y el desafío `claims` se envía de vuelta a la aplicación de escritorio.</span><span class="sxs-lookup"><span data-stu-id="e7670-194">In our Web API 1, we catch the error `error=interaction_required`, and send back the `claims` challenge to the desktop app.</span></span>  <span data-ttu-id="e7670-195">En ese momento, la aplicación de escritorio puede realizar una llamada `acquireToken()` nueva y anexa el desafío `claims` como un parámetro de cadena de solicitud adicional.</span><span class="sxs-lookup"><span data-stu-id="e7670-195">At that point, the desktop app can make a new `acquireToken()` call and append the `claims`challenge as an extra query string parameter.</span></span>  <span data-ttu-id="e7670-196">Esta solicitud nueva requiere que el usuario realice la autenticación multifactor y, luego, envíe el token nuevo de vuelta a la API web 1 y complete el flujo "en nombre de".</span><span class="sxs-lookup"><span data-stu-id="e7670-196">This new request requires the user to do multi-factor authentication and then send this new token back to Web API 1 and complete the on-behalf-of flow.</span></span>

<span data-ttu-id="e7670-197">Para probar el escenario, consulte el [ejemplo de código .NET](https://github.com/Azure-Samples/active-directory-dotnet-webapi-onbehalfof-ca).</span><span class="sxs-lookup"><span data-stu-id="e7670-197">To try out this scenario, see our [.NET code sample](https://github.com/Azure-Samples/active-directory-dotnet-webapi-onbehalfof-ca).</span></span>  <span data-ttu-id="e7670-198">Muestra cómo pasar el desafío de notificaciones de vuelta desde API web 1 a la aplicación nativa y construye una solicitud nueva dentro de la aplicación cliente.</span><span class="sxs-lookup"><span data-stu-id="e7670-198">It demonstrates how to pass the claims challenge back from Web API 1 to the native app and construct a new request inside the client app.</span></span> 

### <a name="scenario-app-accessing-multiple-services"></a><span data-ttu-id="e7670-199">Escenario: Aplicación que accede a varios servicios</span><span class="sxs-lookup"><span data-stu-id="e7670-199">Scenario: App accessing multiple services</span></span>

<span data-ttu-id="e7670-200">En este escenario se describe un caso en el que una aplicación web accede a dos servicios, uno de los cuales tiene asignada una directiva de acceso condicional.</span><span class="sxs-lookup"><span data-stu-id="e7670-200">In this scenario, we walk through the case in which a web app accesses two services one of which has a conditional access policy assigned.</span></span>  <span data-ttu-id="e7670-201">En función de la lógica de la aplicación, es posible que exista una ruta de acceso en la que la aplicación no requiera acceso a ambos servicios web.</span><span class="sxs-lookup"><span data-stu-id="e7670-201">Depending on your app logic, there may exist a path in which your app does not require access to both web services.</span></span>  <span data-ttu-id="e7670-202">En este escenario, el orden en que se solicita un token representa un papel importante en la experiencia del usuario final.</span><span class="sxs-lookup"><span data-stu-id="e7670-202">In this scenario, the order in which you request a token plays an important role in the end-user experience.</span></span>

<span data-ttu-id="e7670-203">Vamos a suponer que tenemos un servicio web A y B y que el servicio web B tiene aplicada la directiva de acceso condicional.</span><span class="sxs-lookup"><span data-stu-id="e7670-203">Let's assume we have web service A and B and web service B has our conditional access policy applied.</span></span>  <span data-ttu-id="e7670-204">Si bien la solicitud de autenticación interactiva inicial requiere consentimiento para ambos servicios, la directiva de acceso condicional no se requiere en todos los casos.</span><span class="sxs-lookup"><span data-stu-id="e7670-204">While the initial interactive auth request requires consent for both services, the conditional access policy is not required in all cases.</span></span>  <span data-ttu-id="e7670-205">Si la aplicación solicita un token para el servicio web B, se invoca la directiva y las solicitudes subsiguientes del servicio web A también se realizan correctamente, como se indica a continuación.</span><span class="sxs-lookup"><span data-stu-id="e7670-205">If the app requests a token for web service B, then the policy is invoked and subsequent requests for web service A also succeeds as follows.</span></span>

![Diagrama de flujo de la aplicación que accede a varios servicios](media/active-directory-conditional-access-developer/app-accessing-multiple-services-scenario.png)

<span data-ttu-id="e7670-207">De manera alternativa, si la aplicación inicialmente solicita un token para el servicio web A, el usuario final no invoca la directiva de acceso condicional.</span><span class="sxs-lookup"><span data-stu-id="e7670-207">Alternatively, if the app initially requests a token for web service A, the end-user does not invoke the conditional access policy.</span></span>  <span data-ttu-id="e7670-208">Esto permite que el desarrollador de la aplicación controle la experiencia del usuario final y no obligue a que la directiva de acceso condicional se invoque en todos los casos.</span><span class="sxs-lookup"><span data-stu-id="e7670-208">This allows the app developer to control the end-user experience and not force the conditional access policy to be invoked in all cases.</span></span> <span data-ttu-id="e7670-209">La parte complicada se genera si la aplicación solicita posteriormente un token para el servicio web B. En este punto, el usuario final necesita cumplir con la directiva de acceso condicional.</span><span class="sxs-lookup"><span data-stu-id="e7670-209">The tricky case is if the app subsequently requests a token for web service B. At this point, the end-user needs to comply with the conditional access policy.</span></span>  <span data-ttu-id="e7670-210">Si la aplicación intenta `acquireToken`, puede generar el error siguiente (que se ilustra en el diagrama a continuación):</span><span class="sxs-lookup"><span data-stu-id="e7670-210">When the app tries to `acquireToken`, it may generate the following error (illustrated in the following diagram):</span></span> 

```
HTTP 400; Bad Request
error=interaction_required
error_description=AADSTS50076: Due to a configuration change made by your administrator, or because you moved to a new location, you must use multi-factor authentication to access '<Web API App/Client ID>'.
claims={"access_token":{"polids":{"essential":true,"Values":["<GUID>"]}}}
``` 

![Aplicación que accede a varios servicios que solicitan un token nuevo](media/active-directory-conditional-access-developer/app-accessing-multiple-services-new-token.png)

<span data-ttu-id="e7670-212">Si la aplicación usa la biblioteca ADAL, la adquisición de un token siempre se reintenta de forma interactiva si se genera un error.</span><span class="sxs-lookup"><span data-stu-id="e7670-212">If the app is using the ADAL library, a failure to acquire the token is always retried interactively.</span></span>  <span data-ttu-id="e7670-213">Cuando se produce esta solicitud interactiva, el usuario final tiene la oportunidad de cumplir con el acceso condicional.</span><span class="sxs-lookup"><span data-stu-id="e7670-213">When this interactive request occurs, the end-user has the opportunity to comply with the conditional access.</span></span>  <span data-ttu-id="e7670-214">Esto se aplica a menos que la solicitud sea `AcquireTokenSilentAsync` o `PromptBehavior.Never`, en cuyo caso la aplicación debe realizar una solicitud ```AcquireToken``` interactiva para dar al usuario final la oportunidad de cumplir con la directiva.</span><span class="sxs-lookup"><span data-stu-id="e7670-214">This is true unless the request is a `AcquireTokenSilentAsync` or `PromptBehavior.Never` in which case the app needs to perform an interactive ```AcquireToken``` request to give the end use the opportunity to comply with the policy.</span></span> 

### <a name="scenario-single-page-app-spa-using-adaljs"></a><span data-ttu-id="e7670-215">Escenario: Aplicación de una sola página (SPA) que usa ADAL.js</span><span class="sxs-lookup"><span data-stu-id="e7670-215">Scenario: Single Page App (SPA) using ADAL.js</span></span>

<span data-ttu-id="e7670-216">En este escenario, se describe un caso en el que se tiene una aplicación de una sola página (SPA) que usa ADAL.js para llamar a una API web protegida por acceso condicional.</span><span class="sxs-lookup"><span data-stu-id="e7670-216">In this scenario, we walk through the case when we have a single page app (SPA), using ADAL.js to call a conditional access protected web API.</span></span>  <span data-ttu-id="e7670-217">Se trata de una arquitectura simple, pero tiene algunos matices que se deben considerar cuando se desarrollen aplicaciones alrededor del acceso condicional.</span><span class="sxs-lookup"><span data-stu-id="e7670-217">This is a simple architecture but has some nuances that need to be taken into account when developing around conditional access.</span></span>

<span data-ttu-id="e7670-218">En ADAL.js, existen algunas funciones que obtienen tokens: `login()`, `acquireToken(...)`, `acquireTokenPopup(…)` y `acquireTokenRedirect(…)`.</span><span class="sxs-lookup"><span data-stu-id="e7670-218">In ADAL.js, there are a few functions that obtain tokens: `login()`, `acquireToken(...)`, `acquireTokenPopup(…)`, and `acquireTokenRedirect(…)`.</span></span> 

* <span data-ttu-id="e7670-219">`login()` obtiene un token de identificador mediante una solicitud de inicio de sesión interactiva, pero no obtiene tokens de acceso para ningún servicio (incluida una API web protegida por acceso condicional).</span><span class="sxs-lookup"><span data-stu-id="e7670-219">`login()` obtains an ID token through an interactive sign-in request but does not obtain access tokens for any service (including a conditional access protected web API).</span></span>  
* <span data-ttu-id="e7670-220">`acquireToken(…)` se puede usar para obtener silenciosamente un token de acceso, lo que significa que no muestra UI en ninguna circunstancia.</span><span class="sxs-lookup"><span data-stu-id="e7670-220">`acquireToken(…)` can then be used to silently obtain an access token meaning it does not show UI in any circumstance.</span></span>  
* <span data-ttu-id="e7670-221">Tanto `acquireTokenPopup(…)` como `acquireTokenRedirect(…)` se usan para solicitar de manera interactiva un token para un recurso, lo que significa que siempre muestra la UI de inicio de sesión.</span><span class="sxs-lookup"><span data-stu-id="e7670-221">`acquireTokenPopup(…)` and `acquireTokenRedirect(…)` are both used to interactively request a token for a resource meaning they always show sign-in UI.</span></span>

<span data-ttu-id="e7670-222">Cuando una aplicación necesita un token de acceso para llamar a una API web, intenta un `acquireToken(…)`.</span><span class="sxs-lookup"><span data-stu-id="e7670-222">When an app needs an access token to call a Web API, it attempts an `acquireToken(…)`.</span></span>  <span data-ttu-id="e7670-223">Si la sesión de token expira o es necesario cumplir con una directiva de acceso condicional, la función *acquireToken* genera un error y la aplicación usa `acquireTokenPopup()` o `acquireTokenRedirect()`.</span><span class="sxs-lookup"><span data-stu-id="e7670-223">If the token session is expired or we need to comply with a conditional access policy, then the *acquireToken* function fails and the app uses `acquireTokenPopup()` or `acquireTokenRedirect()`.</span></span>

![Diagrama de flujo de la aplicación de una sola página que usa ADAL](media/active-directory-conditional-access-developer/spa-using-adal-scenario.png)

<span data-ttu-id="e7670-225">Veamos un ejemplo con el escenario de acceso condicional.</span><span class="sxs-lookup"><span data-stu-id="e7670-225">Let's walk through an example with our conditional access scenario.</span></span>  <span data-ttu-id="e7670-226">El usuario final acaba de llegar al sitio y no tiene una sesión.</span><span class="sxs-lookup"><span data-stu-id="e7670-226">The end-user just landed on the site and doesn’t have a session.</span></span>  <span data-ttu-id="e7670-227">Se realiza una llamada `login()` y se obtiene un token de identificador sin autenticación multifactor.</span><span class="sxs-lookup"><span data-stu-id="e7670-227">We perform a `login()` call, get an ID token without multi-factor authentication.</span></span>  <span data-ttu-id="e7670-228">Luego, el usuario presiona un botón que requiere que la aplicación solicite datos de una API web.</span><span class="sxs-lookup"><span data-stu-id="e7670-228">Then the user hits a button that requires the app to request data from a web API.</span></span>  <span data-ttu-id="e7670-229">La aplicación intenta realizar una llamada `acquireToken()` pero se genera un error, dado que el usuario todavía no realizó la autenticación multifactor y debe cumplir con la directiva de acceso condicional.</span><span class="sxs-lookup"><span data-stu-id="e7670-229">The app tries to do an `acquireToken()` call but fails since the user has not performed multi-factor authentication yet and needs to comply with the conditional access policy.</span></span>

<span data-ttu-id="e7670-230">Azure AD envía de vuelta la respuesta HTTP siguiente:</span><span class="sxs-lookup"><span data-stu-id="e7670-230">Azure AD sends back the following HTTP response:</span></span> 

```
HTTP 400; Bad Request 
error=interaction_required
error_description=AADSTS50076: Due to a configuration change made by your administrator, or because you moved to a new location, you must use multi-factor authentication to access '<Web API App/Client ID>'.
```

<span data-ttu-id="e7670-231">La aplicación debe capturar `error=interaction_required`.</span><span class="sxs-lookup"><span data-stu-id="e7670-231">Our app needs to catch the `error=interaction_required`.</span></span>  <span data-ttu-id="e7670-232">Luego, la aplicación puede usar `acquireTokenPopup()` o `acquireTokenRedirect()` en el mismo recurso.</span><span class="sxs-lookup"><span data-stu-id="e7670-232">The application can then use either `acquireTokenPopup()` or `acquireTokenRedirect()` on the same resource.</span></span>  <span data-ttu-id="e7670-233">Se obliga al usuario a realizar la autenticación multifactor.</span><span class="sxs-lookup"><span data-stu-id="e7670-233">The user is forced to do a multi-factor authentication.</span></span> <span data-ttu-id="e7670-234">Una vez que el usuario completa la autenticación multifactor, la aplicación recibe un token de acceso nuevo para el recurso solicitado.</span><span class="sxs-lookup"><span data-stu-id="e7670-234">After the user completes the multi-factor authentication, the app is issued a fresh access token for the requested resource.</span></span>

<span data-ttu-id="e7670-235">Para probar el escenario, consulte el [ejemplo de código "en nombre de" de SPA de JS](https://github.com/Azure-Samples/active-directory-dotnet-webapi-onbehalfof-ca).</span><span class="sxs-lookup"><span data-stu-id="e7670-235">To try out this scenario, see our [JS SPA On-behalf-of code sample](https://github.com/Azure-Samples/active-directory-dotnet-webapi-onbehalfof-ca).</span></span>  <span data-ttu-id="e7670-236">Este ejemplo de código usa la directiva de acceso condicional y la API web que registró anteriormente con un SPA de JS para mostrar el escenario.</span><span class="sxs-lookup"><span data-stu-id="e7670-236">This code sample uses the conditional access policy and web API you registered earlier with a JS SPA to demonstrate this scenario.</span></span> <span data-ttu-id="e7670-237">Muestra cómo controlar de forma adecuada el desafío de notificaciones y obtener un token de acceso que se puede usar para la API web.</span><span class="sxs-lookup"><span data-stu-id="e7670-237">It shows how to properly handle the claims challenge and get an access token that can be used for your Web API.</span></span> <span data-ttu-id="e7670-238">De manera alternativa, revise el [ejemplo de código Angular.js](https://github.com/Azure-Samples/active-directory-angularjs-singlepageapp) general para información sobre un SPA de Angular</span><span class="sxs-lookup"><span data-stu-id="e7670-238">Alternatively, checkout the general [Angular.js code sample](https://github.com/Azure-Samples/active-directory-angularjs-singlepageapp) for guidance on an Angular SPA</span></span>


## <a name="see-also"></a><span data-ttu-id="e7670-239">Otras referencias</span><span class="sxs-lookup"><span data-stu-id="e7670-239">See also</span></span>

* <span data-ttu-id="e7670-240">Para más información sobre las funcionalidades, consulte [Acceso condicional en Azure AD](../active-directory-conditional-access.md).</span><span class="sxs-lookup"><span data-stu-id="e7670-240">To learn more about the capabilities, see [Conditional Access in Azure AD](../active-directory-conditional-access.md).</span></span>
* <span data-ttu-id="e7670-241">Para más información sobre los ejemplos de código de Azure AD, consulte [repositorio de GitHub de ejemplos de código](https://github.com/azure-samples?utf8=%E2%9C%93&q=active-directory).</span><span class="sxs-lookup"><span data-stu-id="e7670-241">For more Azure AD code samples, see [Github Repo of Code Samples](https://github.com/azure-samples?utf8=%E2%9C%93&q=active-directory).</span></span> 
* <span data-ttu-id="e7670-242">Para más información sobre el SDK de ADAL y acceso a la documentación de referencia, consulte la [guía de la biblioteca](active-directory-authentication-libraries.md).</span><span class="sxs-lookup"><span data-stu-id="e7670-242">For more info on the ADAL SDK's and access the reference documentation, see [library guide](active-directory-authentication-libraries.md).</span></span>
* <span data-ttu-id="e7670-243">Para más información sobre los escenarios multiinquilino, consulte el artículo sobre el [inicio de sesión de usuarios con el patrón multiinquilino](active-directory-devhowto-multi-tenant-overview.md).</span><span class="sxs-lookup"><span data-stu-id="e7670-243">To learn more about multi-tenant scenarios, see [How to sign in users using the multi-tenant pattern](active-directory-devhowto-multi-tenant-overview.md).</span></span>
