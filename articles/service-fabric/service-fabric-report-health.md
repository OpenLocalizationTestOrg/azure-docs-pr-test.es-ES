---
title: "Adición de informes de mantenimiento de Service Fabric personalizados | Microsoft Docs"
description: "Describe cómo enviar informes de estado personalizados a entidades de estado de Azure Service Fabric. Proporciona recomendaciones para diseñar e implementar informes de estado de calidad."
services: service-fabric
documentationcenter: .net
author: oanapl
manager: timlt
editor: 
ms.assetid: 0a00a7d2-510e-47d0-8aa8-24c851ea847f
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 07/19/2017
ms.author: oanapl
ms.openlocfilehash: ed10eef347d4d93012078456b3a145589e66d30e
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 08/18/2017
---
# <a name="add-custom-service-fabric-health-reports"></a><span data-ttu-id="fd370-104">Incorporación de informes de mantenimiento de Service Fabric personalizados</span><span class="sxs-lookup"><span data-stu-id="fd370-104">Add custom Service Fabric health reports</span></span>
<span data-ttu-id="fd370-105">Azure Service Fabric presenta un [modelo de estado](service-fabric-health-introduction.md) diseñado para marcar las condiciones poco favorables del clúster o de la aplicación en entidades específicas.</span><span class="sxs-lookup"><span data-stu-id="fd370-105">Azure Service Fabric introduces a [health model](service-fabric-health-introduction.md) designed to flag unhealthy cluster and application conditions on specific entities.</span></span> <span data-ttu-id="fd370-106">El modelo de mantenimiento utiliza **informadores de estado** (componentes del sistema y guardianes).</span><span class="sxs-lookup"><span data-stu-id="fd370-106">The health model uses **health reporters** (system components and watchdogs).</span></span> <span data-ttu-id="fd370-107">El objetivo es obtener un diagnóstico y reparación sencillo y rápido.</span><span class="sxs-lookup"><span data-stu-id="fd370-107">The goal is easy and fast diagnosis and repair.</span></span> <span data-ttu-id="fd370-108">Los escritores de servicio deben pensar por adelantado sobre el estado.</span><span class="sxs-lookup"><span data-stu-id="fd370-108">Service writers need to think upfront about health.</span></span> <span data-ttu-id="fd370-109">Cualquier condición que pueda afectar al estado debe notificarse, sobre todo si puede ayudar a marcar la causa raíz de los problemas.</span><span class="sxs-lookup"><span data-stu-id="fd370-109">Any condition that can impact health should be reported on, especially if it can help flag problems close to the root.</span></span> <span data-ttu-id="fd370-110">La información de estado puede ahorrar tiempo y esfuerzo en la depuración y la investigación.</span><span class="sxs-lookup"><span data-stu-id="fd370-110">The health information can save time and effort on debugging and investigation.</span></span> <span data-ttu-id="fd370-111">La utilidad resulta especialmente clara una vez que el servicio está en funcionamiento a escala en la nube (privada o Azure).</span><span class="sxs-lookup"><span data-stu-id="fd370-111">The usefulness is especially clear once the service is up and running at scale in the cloud (private or Azure).</span></span>

<span data-ttu-id="fd370-112">Los generadores de informes de Service Fabric identificaron las condiciones de interés.</span><span class="sxs-lookup"><span data-stu-id="fd370-112">The Service Fabric reporters monitor identified conditions of interest.</span></span> <span data-ttu-id="fd370-113">Informan sobre esas condiciones en función de su vista local.</span><span class="sxs-lookup"><span data-stu-id="fd370-113">They report on those conditions based on their local view.</span></span> <span data-ttu-id="fd370-114">El [almacén de estado](service-fabric-health-introduction.md#health-store) agrega datos de mantenimiento que todos los informadores envían para determinar si el estado de las entidades es bueno en general.</span><span class="sxs-lookup"><span data-stu-id="fd370-114">The [health store](service-fabric-health-introduction.md#health-store) aggregates health data sent by all reporters to determine whether entities are globally healthy.</span></span> <span data-ttu-id="fd370-115">La intención es que el modelo sea completo, flexible y fácil de usar.</span><span class="sxs-lookup"><span data-stu-id="fd370-115">The model is intended to be rich, flexible, and easy to use.</span></span> <span data-ttu-id="fd370-116">La calidad de los informes de mantenimiento determina la precisión de la vista de estado del clúster.</span><span class="sxs-lookup"><span data-stu-id="fd370-116">The quality of the health reports determines the accuracy of the health view of the cluster.</span></span> <span data-ttu-id="fd370-117">Los falsos positivos que muestran erróneamente problemas pueden afectar negativamente a las actualizaciones u otros servicios que usan datos de mantenimiento.</span><span class="sxs-lookup"><span data-stu-id="fd370-117">False positives that wrongly show unhealthy issues can negatively impact upgrades or other services that use health data.</span></span> <span data-ttu-id="fd370-118">Ejemplos de estos servicios son los servicios de reparación y los mecanismos de alerta.</span><span class="sxs-lookup"><span data-stu-id="fd370-118">Examples of such services are repair services and alerting mechanisms.</span></span> <span data-ttu-id="fd370-119">Por lo tanto, se necesita cierto grado de reflexión para proporcionar informes que capturen condiciones que resulten interesantes de la mejor manera posible.</span><span class="sxs-lookup"><span data-stu-id="fd370-119">Therefore, some thought is needed to provide reports that capture conditions of interest in the best possible way.</span></span>

<span data-ttu-id="fd370-120">Para diseñar e implementar informes de mantenimiento, los guardianes y componentes del sistema deben:</span><span class="sxs-lookup"><span data-stu-id="fd370-120">To design and implement health reporting, watchdogs and system components must:</span></span>

* <span data-ttu-id="fd370-121">Definir la condición que le interese, la forma en que se supervisa y la repercusión sobre la funcionalidad del clúster o de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="fd370-121">Define the condition they are interested in, the way it is monitored, and the impact on the cluster or application functionality.</span></span> <span data-ttu-id="fd370-122">Según esta información, decidir sobre la propiedad de informe de mantenimiento y el estado de mantenimiento.</span><span class="sxs-lookup"><span data-stu-id="fd370-122">Based on this information, decide on the health report property and health state.</span></span>
* <span data-ttu-id="fd370-123">Determinar la [entidad](service-fabric-health-introduction.md#health-entities-and-hierarchy) a la que se aplica el informe.</span><span class="sxs-lookup"><span data-stu-id="fd370-123">Determine the [entity](service-fabric-health-introduction.md#health-entities-and-hierarchy) that the report applies to.</span></span>
* <span data-ttu-id="fd370-124">Determinar dónde se generan los informes, desde el servicio o desde un guardián interno o externo.</span><span class="sxs-lookup"><span data-stu-id="fd370-124">Determine where the reporting is done, from within the service or from an internal or external watchdog.</span></span>
* <span data-ttu-id="fd370-125">Definir un origen utilizado para identificar el generador de informes.</span><span class="sxs-lookup"><span data-stu-id="fd370-125">Define a source used to identify the reporter.</span></span>
* <span data-ttu-id="fd370-126">Elegir una estrategia de generación de informes, periódicamente o en las transiciones.</span><span class="sxs-lookup"><span data-stu-id="fd370-126">Choose a reporting strategy, either periodically or on transitions.</span></span> <span data-ttu-id="fd370-127">La manera recomendada es periódicamente, ya que el código necesario es más simple y menos propenso a errores.</span><span class="sxs-lookup"><span data-stu-id="fd370-127">The recommended way is periodically, as it requires simpler code and is less prone to errors.</span></span>
* <span data-ttu-id="fd370-128">Determinar cuánto tiempo debe permanecer en el almacén de estado y cómo debe borrarse el informe de condiciones incorrectas.</span><span class="sxs-lookup"><span data-stu-id="fd370-128">Determine how long the report for unhealthy conditions should stay in the health store and how it should be cleared.</span></span> <span data-ttu-id="fd370-129">Con esta información, decidir el tiempo de duración del informe y el comportamiento de eliminación cuando caduca.</span><span class="sxs-lookup"><span data-stu-id="fd370-129">Using this information, decide the report's time to live and remove-on-expiration behavior.</span></span>

<span data-ttu-id="fd370-130">Tal y como se ha mencionado, la creación de informes puede realizarse desde:</span><span class="sxs-lookup"><span data-stu-id="fd370-130">As mentioned, reporting can be done from:</span></span>

* <span data-ttu-id="fd370-131">La réplica de Service Fabric supervisado.</span><span class="sxs-lookup"><span data-stu-id="fd370-131">The monitored Service Fabric service replica.</span></span>
* <span data-ttu-id="fd370-132">Guardianes internos implementados como un servicio de Service Fabric (por ejemplo, un servicio sin estado de Service Fabric que supervisa las condiciones y los informes de problemas).</span><span class="sxs-lookup"><span data-stu-id="fd370-132">Internal watchdogs deployed as a Service Fabric service (for example, a Service Fabric stateless service that monitors conditions and issues reports).</span></span> <span data-ttu-id="fd370-133">Los guardianes pueden implementarse un todos los nodos o pueden afinarse en el servicio supervisado.</span><span class="sxs-lookup"><span data-stu-id="fd370-133">The watchdogs can be deployed an all nodes or can be affinitized to the monitored service.</span></span>
* <span data-ttu-id="fd370-134">Guardianes internos que se ejecutan en los nodos de Service Fabric pero que *no* se implementan como servicios de Service Fabric.</span><span class="sxs-lookup"><span data-stu-id="fd370-134">Internal watchdogs that run on the Service Fabric nodes but are *not* implemented as Service Fabric services.</span></span>
* <span data-ttu-id="fd370-135">Guardianes externos que sondean el recurso desde *fuera* del clúster de Service Fabric (por ejemplo, un servicio de supervisión de tipo Gomez).</span><span class="sxs-lookup"><span data-stu-id="fd370-135">External watchdogs that probe the resource from *outside* the Service Fabric cluster (for example, monitoring service like Gomez).</span></span>

> [!NOTE]
> <span data-ttu-id="fd370-136">De fábrica, el clúster está rellenado con informes de estado enviados por los componentes del sistema.</span><span class="sxs-lookup"><span data-stu-id="fd370-136">Out of the box, the cluster is populated with health reports sent by the system components.</span></span> <span data-ttu-id="fd370-137">Lea más en [Uso de informes de mantenimiento del sistema para solucionar problemas](service-fabric-understand-and-troubleshoot-with-system-health-reports.md).</span><span class="sxs-lookup"><span data-stu-id="fd370-137">Read more at [Using system health reports for troubleshooting](service-fabric-understand-and-troubleshoot-with-system-health-reports.md).</span></span> <span data-ttu-id="fd370-138">Los informes de usuario deben enviarse en [entidades de estado](service-fabric-health-introduction.md#health-entities-and-hierarchy) ya creadas por el sistema.</span><span class="sxs-lookup"><span data-stu-id="fd370-138">The user reports must be sent on [health entities](service-fabric-health-introduction.md#health-entities-and-hierarchy) that have already been created by the system.</span></span>
> 
> 

<span data-ttu-id="fd370-139">Una vez que el diseño de informes de mantenimiento está vacío, los informes de mantenimiento se pueden enviar de forma fácil.</span><span class="sxs-lookup"><span data-stu-id="fd370-139">Once the health reporting design is clear, health reports can be sent easily.</span></span> <span data-ttu-id="fd370-140">Puede usar [FabricClient](https://docs.microsoft.com/dotnet/api/system.fabric.fabricclient) para informar del mantenimiento si el clúster no es [seguro](service-fabric-cluster-security.md) o si el cliente de Fabric tiene privilegios de administrador.</span><span class="sxs-lookup"><span data-stu-id="fd370-140">You can use [FabricClient](https://docs.microsoft.com/dotnet/api/system.fabric.fabricclient) to report health if the cluster is not [secure](service-fabric-cluster-security.md) or if the fabric client has admin privileges.</span></span> <span data-ttu-id="fd370-141">La notificación se puede hacer a través de la API mediante [FabricClient.HealthManager.ReportHealth](https://docs.microsoft.com/dotnet/api/system.fabric.fabricclient.healthclient.reporthealth), PowerShell o REST.</span><span class="sxs-lookup"><span data-stu-id="fd370-141">Reporting can be done through the API by using [FabricClient.HealthManager.ReportHealth](https://docs.microsoft.com/dotnet/api/system.fabric.fabricclient.healthclient.reporthealth), through PowerShell, or through REST.</span></span> <span data-ttu-id="fd370-142">Los botones de configuración procesan los informes por lotes para un mejor rendimiento.</span><span class="sxs-lookup"><span data-stu-id="fd370-142">Configuration knobs batch reports for improved performance.</span></span>

> [!NOTE]
> <span data-ttu-id="fd370-143">El informe de mantenimiento es sincrónico y solo representa el trabajo de validación en el cliente.</span><span class="sxs-lookup"><span data-stu-id="fd370-143">Report health is synchronous, and it represents only the validation work on the client side.</span></span> <span data-ttu-id="fd370-144">El hecho de que el cliente de mantenimiento o los objetos `Partition` o `CodePackageActivationContext` acepten el informe no significa que se aplique en el almacén.</span><span class="sxs-lookup"><span data-stu-id="fd370-144">The fact that the report is accepted by the health client or the `Partition` or `CodePackageActivationContext` objects doesn't mean that it is applied in the store.</span></span> <span data-ttu-id="fd370-145">Se envía de forma asincrónica y posiblemente por lotes con otros informes.</span><span class="sxs-lookup"><span data-stu-id="fd370-145">It is sent asynchronously and possibly batched with other reports.</span></span> <span data-ttu-id="fd370-146">El procesamiento en el servidor todavía puede seguir dando error: el número de secuencia puede estar obsoleto, la entidad en la que se debe aplicar el informe ha sido eliminada, etc.</span><span class="sxs-lookup"><span data-stu-id="fd370-146">The processing on the server may still fail: the sequence number could be stale, the entity on which the report must be applied has been deleted, etc.</span></span>
> 
> 

## <a name="health-client"></a><span data-ttu-id="fd370-147">Cliente de mantenimiento</span><span class="sxs-lookup"><span data-stu-id="fd370-147">Health client</span></span>
<span data-ttu-id="fd370-148">Los informes de mantenimiento se envían al almacén de estado por medio de un cliente de mantenimiento, que reside en el cliente de Fabric.</span><span class="sxs-lookup"><span data-stu-id="fd370-148">The health reports are sent to the health store through a health client, which lives inside the fabric client.</span></span> <span data-ttu-id="fd370-149">El cliente de mantenimiento puede configurarse con las opciones siguientes:</span><span class="sxs-lookup"><span data-stu-id="fd370-149">The health client can be configured with the following settings:</span></span>

* <span data-ttu-id="fd370-150">**HealthReportSendInterval**: el retraso entre el momento en que el informe se agrega al cliente y el momento en que se envía al almacén de estado.</span><span class="sxs-lookup"><span data-stu-id="fd370-150">**HealthReportSendInterval**: The delay between the time the report is added to the client and the time it is sent to the health store.</span></span> <span data-ttu-id="fd370-151">Se usa para procesar por lotes los informes en un único mensaje, en lugar de enviar un mensaje para cada informe.</span><span class="sxs-lookup"><span data-stu-id="fd370-151">Used to batch reports into a single message, rather than sending one message for each report.</span></span> <span data-ttu-id="fd370-152">El procesamiento por lotes mejora el rendimiento.</span><span class="sxs-lookup"><span data-stu-id="fd370-152">The batching improves performance.</span></span> <span data-ttu-id="fd370-153">Valor predeterminado: 30 segundos.</span><span class="sxs-lookup"><span data-stu-id="fd370-153">Default: 30 seconds.</span></span>
* <span data-ttu-id="fd370-154">**HealthReportRetrySendInterval**: el intervalo en el que el cliente de mantenimiento reenvía los informes de mantenimiento acumulados al almacén de estado.</span><span class="sxs-lookup"><span data-stu-id="fd370-154">**HealthReportRetrySendInterval**: The interval at which the health client resends accumulated health reports to the health store.</span></span> <span data-ttu-id="fd370-155">Valor predeterminado: 30 segundos.</span><span class="sxs-lookup"><span data-stu-id="fd370-155">Default: 30 seconds.</span></span>
* <span data-ttu-id="fd370-156">**HealthOperationTimeout**: el período de tiempo de espera para un mensaje de informe enviado al almacén de estado.</span><span class="sxs-lookup"><span data-stu-id="fd370-156">**HealthOperationTimeout**: The timeout period for a report message sent to the health store.</span></span> <span data-ttu-id="fd370-157">Si un mensaje supera el tiempo de espera, el cliente de mantenimiento lo sigue intentando hasta que el almacén de estado confirme que el informe se ha procesado.</span><span class="sxs-lookup"><span data-stu-id="fd370-157">If a message times out, the health client retries it until the health store confirms that the report has been processed.</span></span> <span data-ttu-id="fd370-158">Valor predeterminado: dos minutos.</span><span class="sxs-lookup"><span data-stu-id="fd370-158">Default: two minutes.</span></span>

> [!NOTE]
> <span data-ttu-id="fd370-159">Cuando los informes se procesan por lotes, el cliente de Fabric se debe mantener activo durante al menos el valor de HealthReportSendInterval para tener la seguridad de que se envían.</span><span class="sxs-lookup"><span data-stu-id="fd370-159">When the reports are batched, the fabric client must be kept alive for at least the HealthReportSendInterval to ensure that they are sent.</span></span> <span data-ttu-id="fd370-160">Si el mensaje se pierde o el almacén de estado no es capaz de aplicarlos debido a errores transitorios, el cliente de Fabric debe mantenerse activo más tiempo para darle una oportunidad de volver a intentarlo.</span><span class="sxs-lookup"><span data-stu-id="fd370-160">If the message is lost or the health store cannot apply them due to transient errors, the fabric client must be kept alive longer to give it a chance to retry.</span></span>
> 
> 

<span data-ttu-id="fd370-161">El almacenamiento en búfer en el cliente toma en consideración el carácter único de los informes.</span><span class="sxs-lookup"><span data-stu-id="fd370-161">The buffering on the client takes the uniqueness of the reports into consideration.</span></span> <span data-ttu-id="fd370-162">Por ejemplo, si un informador incorrecto determinado notifica 100 informes por segundo en la misma propiedad de la misma entidad, los informes se reemplazan por la versión más reciente.</span><span class="sxs-lookup"><span data-stu-id="fd370-162">For example, if a particular bad reporter is reporting 100 reports per second on the same property of the same entity, the reports are replaced with the last version.</span></span> <span data-ttu-id="fd370-163">A lo sumo, existirá un informe de este tipo en la cola de cliente.</span><span class="sxs-lookup"><span data-stu-id="fd370-163">At most one such report exists in the client queue.</span></span> <span data-ttu-id="fd370-164">Si se configura el procesamiento por lotes, el número de informes que se envían al almacén de estado es simplemente uno por intervalo de envío.</span><span class="sxs-lookup"><span data-stu-id="fd370-164">If batching is configured, the number of reports sent to the health store is just one per send interval.</span></span> <span data-ttu-id="fd370-165">Este informe es el último informe agregado, que refleja el estado más reciente de la entidad.</span><span class="sxs-lookup"><span data-stu-id="fd370-165">This report is the last added report, which reflects the most current state of the entity.</span></span>
<span data-ttu-id="fd370-166">Especifique los parámetros de configuración al crear `FabricClient`, pasando [FabricClientSettings](https://docs.microsoft.com/dotnet/api/system.fabric.fabricclientsettings) con los valores deseados para las entradas relacionadas con el mantenimiento.</span><span class="sxs-lookup"><span data-stu-id="fd370-166">Specify configuration parameters when `FabricClient` is created by passing [FabricClientSettings](https://docs.microsoft.com/dotnet/api/system.fabric.fabricclientsettings) with the desired values for health-related entries.</span></span>

<span data-ttu-id="fd370-167">En el siguiente ejemplo se crea un cliente de Fabric y se especifica que se deben enviar los informes cuando se agregan.</span><span class="sxs-lookup"><span data-stu-id="fd370-167">The following example creates a fabric client and specifies that the reports should be sent when they are added.</span></span> <span data-ttu-id="fd370-168">En tiempos de espera y errores que se pueden reintentar, los reintentos se producen cada 40 segundos.</span><span class="sxs-lookup"><span data-stu-id="fd370-168">On timeouts and errors that can be retried, retries happen every 40 seconds.</span></span>

```csharp
var clientSettings = new FabricClientSettings()
{
    HealthOperationTimeout = TimeSpan.FromSeconds(120),
    HealthReportSendInterval = TimeSpan.FromSeconds(0),
    HealthReportRetrySendInterval = TimeSpan.FromSeconds(40),
};
var fabricClient = new FabricClient(clientSettings);
```

<span data-ttu-id="fd370-169">Se recomienda mantener la configuración predeterminada del cliente de Fabric, que establece `HealthReportSendInterval` en 30 segundos.</span><span class="sxs-lookup"><span data-stu-id="fd370-169">We recommend keeping the default fabric client settings, which set `HealthReportSendInterval` to 30 seconds.</span></span> <span data-ttu-id="fd370-170">Esta configuración garantiza un rendimiento óptimo debido al procesamiento por lotes.</span><span class="sxs-lookup"><span data-stu-id="fd370-170">This setting ensures optimal performance due to batching.</span></span> <span data-ttu-id="fd370-171">Para los informes importantes que se deban enviar tan pronto como sea posible, utilice `HealthReportSendOptions` con la marca Immediate establecida en `true` en la API [FabricClient.HealthClient.ReportHealth](https://docs.microsoft.com/dotnet/api/system.fabric.fabricclient.healthclient.reporthealth).</span><span class="sxs-lookup"><span data-stu-id="fd370-171">For critical reports that must be sent as soon as possible, use `HealthReportSendOptions` with Immediate `true` in [FabricClient.HealthClient.ReportHealth](https://docs.microsoft.com/dotnet/api/system.fabric.fabricclient.healthclient.reporthealth) API.</span></span> <span data-ttu-id="fd370-172">Los informes inmediatos omiten el intervalo de procesamiento por lotes.</span><span class="sxs-lookup"><span data-stu-id="fd370-172">Immediate reports bypass the batching interval.</span></span> <span data-ttu-id="fd370-173">Utilice esta marca con cuidado; queremos aprovechar el procesamiento por lotes del cliente de mantenimiento siempre que sea posible.</span><span class="sxs-lookup"><span data-stu-id="fd370-173">Use this flag with care; we want to take advantage of the health client batching whenever possible.</span></span> <span data-ttu-id="fd370-174">El envío inmediato también es útil cuando se está cerrando el cliente Fabric (por ejemplo, el proceso ha determinado que el estado no es válido y debe cerrarse para evitar efectos secundarios).</span><span class="sxs-lookup"><span data-stu-id="fd370-174">Immediate send is also useful when the fabric client is closing (for example, the process has determined invalid state and needs to shut down to prevent side effects).</span></span> <span data-ttu-id="fd370-175">Garantiza el envío más eficaz de los informes acumulados.</span><span class="sxs-lookup"><span data-stu-id="fd370-175">It ensures a best-effort send of the accumulated reports.</span></span> <span data-ttu-id="fd370-176">Cuando se agrega un informe con la marca Immediate, el cliente de mantenimiento envía por lotes todos los informes acumulados desde el último envío.</span><span class="sxs-lookup"><span data-stu-id="fd370-176">When one report is added with Immediate flag, the health client batches all the accumulated reports since last send.</span></span>

<span data-ttu-id="fd370-177">Se pueden especificar los mismos parámetros cuando se crea una conexión a un clúster mediante Powershell.</span><span class="sxs-lookup"><span data-stu-id="fd370-177">Same parameters can be specified when a connection to a cluster is created through PowerShell.</span></span> <span data-ttu-id="fd370-178">En el ejemplo siguiente se inicia una conexión con un clúster local:</span><span class="sxs-lookup"><span data-stu-id="fd370-178">The following example starts a connection to a local cluster:</span></span>

```powershell
PS C:\> Connect-ServiceFabricCluster -HealthOperationTimeoutInSec 120 -HealthReportSendIntervalInSec 0 -HealthReportRetrySendIntervalInSec 40
True

ConnectionEndpoint   :
FabricClientSettings : {
                       ClientFriendlyName                   : PowerShell-1944858a-4c6d-465f-89c7-9021c12ac0bb
                       PartitionLocationCacheLimit          : 100000
                       PartitionLocationCacheBucketCount    : 1024
                       ServiceChangePollInterval            : 00:02:00
                       ConnectionInitializationTimeout      : 00:00:02
                       KeepAliveInterval                    : 00:00:20
                       HealthOperationTimeout               : 00:02:00
                       HealthReportSendInterval             : 00:00:00
                       HealthReportRetrySendInterval        : 00:00:40
                       NotificationGatewayConnectionTimeout : 00:00:00
                       NotificationCacheUpdateTimeout       : 00:00:00
                       }
GatewayInformation   : {
                       NodeAddress                          : localhost:19000
                       NodeId                               : 1880ec88a3187766a6da323399721f53
                       NodeInstanceId                       : 130729063464981219
                       NodeName                             : Node.1
                       }
```

<span data-ttu-id="fd370-179">De forma similar a la API, los informes pueden enviarse con la marca `-Immediate` para ser enviados inmediatamente, con independencia del valor `HealthReportSendInterval`.</span><span class="sxs-lookup"><span data-stu-id="fd370-179">Similarly to API, reports can be sent using `-Immediate` switch to be sent immediately, regardless of the `HealthReportSendInterval` value.</span></span>

<span data-ttu-id="fd370-180">Para REST, los informes se envían a la puerta de enlace de Service Fabric, que tiene un cliente Fabric interno.</span><span class="sxs-lookup"><span data-stu-id="fd370-180">For REST, the reports are sent to the Service Fabric gateway, which has an internal fabric client.</span></span> <span data-ttu-id="fd370-181">De forma predeterminada, este cliente se configura para enviar informes por lotes cada 30 segundos.</span><span class="sxs-lookup"><span data-stu-id="fd370-181">By default, this client is configured to send reports batched every 30 seconds.</span></span> <span data-ttu-id="fd370-182">Puede cambiar el intervalo de envío de lotes con la opción de configuración de clúster `HttpGatewayHealthReportSendInterval` en `HttpGateway`.</span><span class="sxs-lookup"><span data-stu-id="fd370-182">You can change the batch interval with the cluster configuration setting `HttpGatewayHealthReportSendInterval` on `HttpGateway`.</span></span> <span data-ttu-id="fd370-183">Como se mencionó antes, una mejor opción consiste en enviar los informes con `Immediate` establecido en true.</span><span class="sxs-lookup"><span data-stu-id="fd370-183">As mentioned, a better option is to send the reports with `Immediate` true.</span></span> 

> [!NOTE]
> <span data-ttu-id="fd370-184">Para asegurarse de que los servicios no autorizados no puedan notificar el estado en las entidades del clúster, configure el servidor para que acepte solamente solicitudes de clientes protegidos.</span><span class="sxs-lookup"><span data-stu-id="fd370-184">To ensure that unauthorized services can't report health against the entities in the cluster, configure the server to accept requests only from secured clients.</span></span> <span data-ttu-id="fd370-185">El objeto `FabricClient` utilizado para la creación de informes debe tener habilitada la seguridad para poder comunicarse con el clúster (por ejemplo, con la autenticación Kerberos o de certificados).</span><span class="sxs-lookup"><span data-stu-id="fd370-185">The `FabricClient` used for reporting must have security enabled to be able to communicate with the cluster (for example, with Kerberos or certificate authentication).</span></span> <span data-ttu-id="fd370-186">Obtenga más información sobre la [seguridad del clúster](service-fabric-cluster-security.md).</span><span class="sxs-lookup"><span data-stu-id="fd370-186">Read more about [cluster security](service-fabric-cluster-security.md).</span></span>
> 
> 

## <a name="report-from-within-low-privilege-services"></a><span data-ttu-id="fd370-187">Informes desde servicios con pocos privilegios</span><span class="sxs-lookup"><span data-stu-id="fd370-187">Report from within low privilege services</span></span>
<span data-ttu-id="fd370-188">Si los servicios de Service Fabric no tienen acceso de administrador al clúster, puede informar sobre el estado de las entidades desde el contexto actual mediante `Partition` o `CodePackageActivationContext`.</span><span class="sxs-lookup"><span data-stu-id="fd370-188">If Service Fabric services do not have admin access to the cluster, you can report health on entities from the current context through `Partition` or `CodePackageActivationContext`.</span></span>

* <span data-ttu-id="fd370-189">Para los servicios sin estado, use [IStatelessServicePartition.ReportInstanceHealth](https://docs.microsoft.com/dotnet/api/system.fabric.istatelessservicepartition.reportinstancehealth) para informar sobre la instancia de servicio actual.</span><span class="sxs-lookup"><span data-stu-id="fd370-189">For stateless services, use [IStatelessServicePartition.ReportInstanceHealth](https://docs.microsoft.com/dotnet/api/system.fabric.istatelessservicepartition.reportinstancehealth) to report on the current service instance.</span></span>
* <span data-ttu-id="fd370-190">Para los servicios con estado, use [IStatefulServicePartition.ReportReplicaHealth](https://docs.microsoft.com/dotnet/api/system.fabric.istatefulservicepartition.reportreplicahealth) para informar sobre la réplica actual.</span><span class="sxs-lookup"><span data-stu-id="fd370-190">For stateful services, use [IStatefulServicePartition.ReportReplicaHealth](https://docs.microsoft.com/dotnet/api/system.fabric.istatefulservicepartition.reportreplicahealth) to report on current replica.</span></span>
* <span data-ttu-id="fd370-191">Use [IServicePartition.ReportPartitionHealth](https://docs.microsoft.com/dotnet/api/system.fabric.iservicepartition.reportpartitionhealth) para informar sobre la entidad de partición actual.</span><span class="sxs-lookup"><span data-stu-id="fd370-191">Use [IServicePartition.ReportPartitionHealth](https://docs.microsoft.com/dotnet/api/system.fabric.iservicepartition.reportpartitionhealth) to report on the current partition entity.</span></span>
* <span data-ttu-id="fd370-192">Use [CodePackageActivationContext.ReportApplicationHealth](https://docs.microsoft.com/dotnet/api/system.fabric.codepackageactivationcontext.reportapplicationhealth) para informar sobre la aplicación actual.</span><span class="sxs-lookup"><span data-stu-id="fd370-192">Use [CodePackageActivationContext.ReportApplicationHealth](https://docs.microsoft.com/dotnet/api/system.fabric.codepackageactivationcontext.reportapplicationhealth) to report on current application.</span></span>
* <span data-ttu-id="fd370-193">Use [CodePackageActivationContext.ReportDeployedApplicationHealth](https://docs.microsoft.com/dotnet/api/system.fabric.codepackageactivationcontext.reportdeployedapplicationhealth) para informar sobre la aplicación actual implementada en el nodo actual.</span><span class="sxs-lookup"><span data-stu-id="fd370-193">Use [CodePackageActivationContext.ReportDeployedApplicationHealth](https://docs.microsoft.com/dotnet/api/system.fabric.codepackageactivationcontext.reportdeployedapplicationhealth) to report on the current application deployed on the current node.</span></span>
* <span data-ttu-id="fd370-194">Use [CodePackageActivationContext.ReportDeployedServicePackageHealth](https://docs.microsoft.com/dotnet/api/system.fabric.codepackageactivationcontext.reportdeployedservicepackagehealth) para informar sobre un paquete de servicio para la aplicación implementada en el nodo actual.</span><span class="sxs-lookup"><span data-stu-id="fd370-194">Use [CodePackageActivationContext.ReportDeployedServicePackageHealth](https://docs.microsoft.com/dotnet/api/system.fabric.codepackageactivationcontext.reportdeployedservicepackagehealth) to report on a service package for the application deployed on the current node.</span></span>

> [!NOTE]
> <span data-ttu-id="fd370-195">Internamente, `Partition` y `CodePackageActivationContext` contienen un cliente de mantenimiento configurado con los valores predeterminados.</span><span class="sxs-lookup"><span data-stu-id="fd370-195">Internally, the `Partition` and the `CodePackageActivationContext` hold a health client configured with default settings.</span></span> <span data-ttu-id="fd370-196">Como se explica para el [cliente de mantenimiento](service-fabric-report-health.md#health-client), los informes se envían por lotes según un temporizador.</span><span class="sxs-lookup"><span data-stu-id="fd370-196">As explained for the [health client](service-fabric-report-health.md#health-client), reports are batched and sent on a timer.</span></span> <span data-ttu-id="fd370-197">Los objetos deben estar activos para que tener ocasión de enviar el informe.</span><span class="sxs-lookup"><span data-stu-id="fd370-197">The objects should be kept alive to have a chance to send the report.</span></span>
> 
> 

<span data-ttu-id="fd370-198">Puede especificar `HealthReportSendOptions` al enviar informes a través de las API de mantenimiento `Partition` y `CodePackageActivationContext`.</span><span class="sxs-lookup"><span data-stu-id="fd370-198">You can specify `HealthReportSendOptions` when sending reports through `Partition` and `CodePackageActivationContext` health APIs.</span></span> <span data-ttu-id="fd370-199">Si tiene informes importantes que deben enviarse tan pronto como sea posible, use `HealthReportSendOptions` con la marca Inmediate establecida en `true`.</span><span class="sxs-lookup"><span data-stu-id="fd370-199">If you have critical reports that must be sent as soon as possible, use `HealthReportSendOptions` with Immediate `true`.</span></span> <span data-ttu-id="fd370-200">Los informes inmediatos omiten el intervalo de procesamiento por lotes del cliente de mantenimiento interno.</span><span class="sxs-lookup"><span data-stu-id="fd370-200">Immediate reports bypass the batching interval of the internal health client.</span></span> <span data-ttu-id="fd370-201">Como se mencionó anteriormente, use esta marca con cuidado: queremos aprovechar el procesamiento por lotes del cliente de mantenimiento siempre que sea posible.</span><span class="sxs-lookup"><span data-stu-id="fd370-201">As mentioned before, use this flag with care; we want to take advantage of the health client batching whenever possible.</span></span>

## <a name="design-health-reporting"></a><span data-ttu-id="fd370-202">Informes de estado del diseño</span><span class="sxs-lookup"><span data-stu-id="fd370-202">Design health reporting</span></span>
<span data-ttu-id="fd370-203">El primer paso en la generación de informes de alta calidad es identificar las condiciones que pueden afectar al estado del servicio.</span><span class="sxs-lookup"><span data-stu-id="fd370-203">The first step in generating high-quality reports is identifying the conditions that can impact the health of the service.</span></span> <span data-ttu-id="fd370-204">Cualquier condición que puede ayudar a indicar los problemas en el servicio o el clúster cuando se inicia, o mejor aún, antes de que ocurran, puede suponer un ahorro potencial de miles de millones de dólares.</span><span class="sxs-lookup"><span data-stu-id="fd370-204">Any condition that can help flag problems in the service or cluster when it starts--or even better, before a problem happens--can potentially save billions of dollars.</span></span> <span data-ttu-id="fd370-205">Las ventajas incluyen menos tiempo de inactividad, menos noches dedicadas a investigar y reparar problemas y una mayor satisfacción del cliente.</span><span class="sxs-lookup"><span data-stu-id="fd370-205">The benefits include less down time, fewer night hours spent investigating and repairing issues, and higher customer satisfaction.</span></span>

<span data-ttu-id="fd370-206">Una vez identificadas las condiciones, los escritores de guardianes deben averiguar cuál es la mejor forma de supervisarlas para obtener un mejor equilibrio entre sobrecarga y utilidad.</span><span class="sxs-lookup"><span data-stu-id="fd370-206">Once the conditions are identified, watchdog writers need to figure out the best way to monitor them for balance between overhead and usefulness.</span></span> <span data-ttu-id="fd370-207">Por ejemplo, considere un servicio que realiza cálculos complejos mediante el uso de algunos archivos temporales en un recurso compartido.</span><span class="sxs-lookup"><span data-stu-id="fd370-207">For example, consider a service that does complex calculations that use some temporary files on a share.</span></span> <span data-ttu-id="fd370-208">Un guardián podría supervisar el recurso compartido para asegurarse de que hay suficiente espacio disponible.</span><span class="sxs-lookup"><span data-stu-id="fd370-208">A watchdog could monitor the share to ensure that enough space is available.</span></span> <span data-ttu-id="fd370-209">Podría escuchar las notificaciones de cambios en un archivo o un directorio.</span><span class="sxs-lookup"><span data-stu-id="fd370-209">It could listen for notifications of file or directory changes.</span></span> <span data-ttu-id="fd370-210">Podría notificar una advertencia si se alcanza un umbral anticipadamente, y un error si el recurso compartido está lleno.</span><span class="sxs-lookup"><span data-stu-id="fd370-210">It could report a warning if an upfront threshold is reached, and report an error if the share is full.</span></span> <span data-ttu-id="fd370-211">Con una advertencia, un sistema de reparación podría iniciar la limpieza de los archivos antiguos en el recurso compartido.</span><span class="sxs-lookup"><span data-stu-id="fd370-211">On a warning, a repair system could start cleaning up older files on the share.</span></span> <span data-ttu-id="fd370-212">En caso de error, un sistema de reparación podría mover la réplica de servicio a otro nodo.</span><span class="sxs-lookup"><span data-stu-id="fd370-212">On an error, a repair system could move the service replica to another node.</span></span> <span data-ttu-id="fd370-213">Observe cómo los estados de la condición se describen en lo relativo al mantenimiento: el estado de la condición que se puede considerar correcto (válido) o incorrecto (advertencia o error).</span><span class="sxs-lookup"><span data-stu-id="fd370-213">Note how the condition states are described in terms of health: the state of the condition that can be considered healthy (ok) or unhealthy (warning or error).</span></span>

<span data-ttu-id="fd370-214">Una vez que se establecen los detalles de supervisión, el escritor del guardián debe determinar cómo implementarlo.</span><span class="sxs-lookup"><span data-stu-id="fd370-214">Once the monitoring details are set, a watchdog writer needs to figure out how to implement the watchdog.</span></span> <span data-ttu-id="fd370-215">Si las condiciones se pueden determinar desde dentro del servicio, el guardián puede formar parte del propio servicio supervisado.</span><span class="sxs-lookup"><span data-stu-id="fd370-215">If the conditions can be determined from within the service, the watchdog can be part of the monitored service itself.</span></span> <span data-ttu-id="fd370-216">Por ejemplo, el código del servicio puede comprobar el uso del recurso compartido y luego notificarlo cada vez que intente escribir un archivo.</span><span class="sxs-lookup"><span data-stu-id="fd370-216">For example, the service code can check the share usage, and then report every time it tries to write a file.</span></span> <span data-ttu-id="fd370-217">La ventaja de este enfoque es que la generación de informes es sencilla.</span><span class="sxs-lookup"><span data-stu-id="fd370-217">The advantage of this approach is that reporting is simple.</span></span> <span data-ttu-id="fd370-218">Debe tener cuidado para evitar que los errores de vigilancia afecten a la funcionalidad del servicio.</span><span class="sxs-lookup"><span data-stu-id="fd370-218">Care must be taken to prevent watchdog bugs from impacting the service functionality.</span></span>

<span data-ttu-id="fd370-219">La generación de informes desde dentro del servicio supervisado no es siempre una opción.</span><span class="sxs-lookup"><span data-stu-id="fd370-219">Reporting from within the monitored service is not always an option.</span></span> <span data-ttu-id="fd370-220">Puede que un guardián dentro del servicio no detecte las condiciones.</span><span class="sxs-lookup"><span data-stu-id="fd370-220">A watchdog within the service may not be able to detect the conditions.</span></span> <span data-ttu-id="fd370-221">Puede que no tenga la lógica o los datos para realizar la determinación.</span><span class="sxs-lookup"><span data-stu-id="fd370-221">It may not have the logic or data to make the determination.</span></span> <span data-ttu-id="fd370-222">La sobrecarga de las condiciones de supervisión puede ser alta.</span><span class="sxs-lookup"><span data-stu-id="fd370-222">The overhead of monitoring the conditions may be high.</span></span> <span data-ttu-id="fd370-223">Además, las condiciones pueden no ser específicas de un servicio, sino que afecten a las interacciones entre servicios.</span><span class="sxs-lookup"><span data-stu-id="fd370-223">The conditions also may not be specific to a service, but instead affect interactions between services.</span></span> <span data-ttu-id="fd370-224">Otra opción es tener los guardianes del clúster como procesos independientes.</span><span class="sxs-lookup"><span data-stu-id="fd370-224">Another option is to have watchdogs in the cluster as separate processes.</span></span> <span data-ttu-id="fd370-225">Los guardianes supervisan las condiciones y el informe, sin que afecte a los servicios principales de ninguna manera.</span><span class="sxs-lookup"><span data-stu-id="fd370-225">The watchdogs monitor the conditions and report, without affecting the main services in any way.</span></span> <span data-ttu-id="fd370-226">Por ejemplo, estos guardianes se podrían implementar como servicios sin estado en la misma aplicación, en todos los nodos o en los mismos nodos que el servicio.</span><span class="sxs-lookup"><span data-stu-id="fd370-226">For example, these watchdogs could be implemented as stateless services in the same application, deployed on all nodes or on the same nodes as the service.</span></span>

<span data-ttu-id="fd370-227">En ocasiones, un guardián que se ejecuta en el clúster tampoco es una opción.</span><span class="sxs-lookup"><span data-stu-id="fd370-227">Sometimes, a watchdog running in the cluster is not an option either.</span></span> <span data-ttu-id="fd370-228">Si la condición supervisada es la disponibilidad o la funcionalidad del servicio que ven los usuarios, es mejor tener los guardianes en el mismo lugar que los clientes de usuario.</span><span class="sxs-lookup"><span data-stu-id="fd370-228">If the monitored condition is the availability or functionality of the service as users see it, it's best to have the watchdogs in the same place as the user clients.</span></span> <span data-ttu-id="fd370-229">Allí, pueden probar las operaciones tal y como las llaman los usuarios.</span><span class="sxs-lookup"><span data-stu-id="fd370-229">There, they can test the operations in the same way users call them.</span></span> <span data-ttu-id="fd370-230">Por ejemplo, puede tener un guardián que resida fuera del clúster, emita las solicitudes al servicio y compruebe la latencia y si el resultado es correcto.</span><span class="sxs-lookup"><span data-stu-id="fd370-230">For example, you can have a watchdog that lives outside the cluster, issues requests to the service, and checks the latency and correctness of the result.</span></span> <span data-ttu-id="fd370-231">(Para un servicio de calculadora, por ejemplo, ¿2 + 2 devuelve 4 en un período de tiempo razonable?)</span><span class="sxs-lookup"><span data-stu-id="fd370-231">(For a calculator service, for example, does 2+2 return 4 in a reasonable amount of time?)</span></span>

<span data-ttu-id="fd370-232">Cuando los detalles del guardián hayan finalizado, debe determinar un identificador de origen que lo identifique de forma única.</span><span class="sxs-lookup"><span data-stu-id="fd370-232">Once the watchdog details have been finalized, you should decide on a source ID that uniquely identifies it.</span></span> <span data-ttu-id="fd370-233">Si en el clúster residen varios guardianes del mismo tipo, deben informar en entidades diferentes o, si lo hacen en la misma entidad, usar un identificador de origen o propiedad distintos.</span><span class="sxs-lookup"><span data-stu-id="fd370-233">If multiple watchdogs of the same type are living in the cluster, they must report on different entities, or, if they report on the same entity, use different source ID or property.</span></span> <span data-ttu-id="fd370-234">De este modo, los informes podrán coexistir.</span><span class="sxs-lookup"><span data-stu-id="fd370-234">This way, their reports can coexist.</span></span> <span data-ttu-id="fd370-235">La propiedad del informe de estado debe capturar la condición supervisada.</span><span class="sxs-lookup"><span data-stu-id="fd370-235">The property of the health report should capture the monitored condition.</span></span> <span data-ttu-id="fd370-236">(En el ejemplo anterior, la propiedad puede ser **ShareSize**). Si se aplican varios informes a la misma condición, la propiedad debe contener cierta información dinámica para permitir que los informes coexistan.</span><span class="sxs-lookup"><span data-stu-id="fd370-236">(For the example above, the property could be **ShareSize**.) If multiple reports apply to the same condition, the property should contain some dynamic information that allows reports to coexist.</span></span> <span data-ttu-id="fd370-237">Por ejemplo, si hay varios recursos compartidos que deben supervisarse, el nombre de propiedad puede ser **ShareSize-sharename**.</span><span class="sxs-lookup"><span data-stu-id="fd370-237">For example, if multiple shares need to be monitored, the property name can be **ShareSize-sharename**.</span></span>

> [!NOTE]
> <span data-ttu-id="fd370-238">*No* use el almacén de estado para mantener la información de estado.</span><span class="sxs-lookup"><span data-stu-id="fd370-238">Do *not* use the health store to keep status information.</span></span> <span data-ttu-id="fd370-239">Solo la información relacionada con el mantenimiento se debe notificar como estado, dado que esta información afecta a la evaluación del mantenimiento de una entidad.</span><span class="sxs-lookup"><span data-stu-id="fd370-239">Only health-related information should be reported as health, as this information impacts the health evaluation of an entity.</span></span> <span data-ttu-id="fd370-240">El almacén de estado no se diseñó como almacén de uso general.</span><span class="sxs-lookup"><span data-stu-id="fd370-240">The health store was not designed as a general-purpose store.</span></span> <span data-ttu-id="fd370-241">Usa una lógica de evaluación de estado para agregar todos los datos al estado de mantenimiento.</span><span class="sxs-lookup"><span data-stu-id="fd370-241">It uses health evaluation logic to aggregate all data into the health state.</span></span> <span data-ttu-id="fd370-242">El envío de información no relacionada con el estado (por ejemplo, el informe del estado con un estado de mantenimiento de correcto) no afecta al estado de mantenimiento agregado pero puede afectar negativamente al rendimiento del almacén de estado.</span><span class="sxs-lookup"><span data-stu-id="fd370-242">Sending information unrelated to health (like reporting status with a health state of OK) doesn't impact the aggregated health state, but it can negatively affect the performance of the health store.</span></span>
> 
> 

<span data-ttu-id="fd370-243">El siguiente punto de decisión trata de en qué entidad informar.</span><span class="sxs-lookup"><span data-stu-id="fd370-243">The next decision point is which entity to report on.</span></span> <span data-ttu-id="fd370-244">La mayor parte de las veces, la condición identifica claramente la entidad.</span><span class="sxs-lookup"><span data-stu-id="fd370-244">Most of the time, the condition clearly idetifies the entity.</span></span> <span data-ttu-id="fd370-245">Elija la entidad con la mejor granularidad posible.</span><span class="sxs-lookup"><span data-stu-id="fd370-245">Choose the entity with best possible granularity.</span></span> <span data-ttu-id="fd370-246">Si una condición afecta a todas las réplicas de una partición, haga un informe sobre la partición, no sobre el servicio.</span><span class="sxs-lookup"><span data-stu-id="fd370-246">If a condition impacts all replicas in a partition, report on the partition, not on the service.</span></span> <span data-ttu-id="fd370-247">Hay casos excepcionales en los que es necesario dedicar más esfuerzo.</span><span class="sxs-lookup"><span data-stu-id="fd370-247">There are corner cases where more thought is needed, though.</span></span> <span data-ttu-id="fd370-248">Si la condición afecta a una entidad (por ejemplo, a una réplica) pero lo que se quiere es marcar la condición durante un período superior al de la duración de la réplica, se debe notificar en la partición.</span><span class="sxs-lookup"><span data-stu-id="fd370-248">If the condition impacts an entity, such as a replica, but the desire is to have the condition flagged for more than the duration of replica life, then it should be reported on the partition.</span></span> <span data-ttu-id="fd370-249">De lo contrario, cuando se elimina la réplica, el almacén de estado limpia todos sus informes.</span><span class="sxs-lookup"><span data-stu-id="fd370-249">Otherwise, when the replica is deleted, the health store cleans up all its reports.</span></span> <span data-ttu-id="fd370-250">Los escritores guardianes deben tener en cuenta la duración de la entidad y del informe.</span><span class="sxs-lookup"><span data-stu-id="fd370-250">Watchdog writers must think about the lifetimes of the entity and the report.</span></span> <span data-ttu-id="fd370-251">Debe quedar claro cuándo se debe limpiar un informe de un almacén (por ejemplo, cuándo deja de aplicarse un error notificado en una entidad).</span><span class="sxs-lookup"><span data-stu-id="fd370-251">It must be clear when a report should be cleaned up from a store (for example, when an error reported on an entity no longer applies).</span></span>

<span data-ttu-id="fd370-252">Veamos un ejemplo que reúne los puntos descritos.</span><span class="sxs-lookup"><span data-stu-id="fd370-252">Let's look at an example that puts together the points I described.</span></span> <span data-ttu-id="fd370-253">Considere una aplicación de Service Fabric compuesta de un servicio persistente con estado maestro y varios servicios sin estado secundario implementados en todos los nodos (un tipo de servicio secundario para cada tipo de tarea).</span><span class="sxs-lookup"><span data-stu-id="fd370-253">Consider a Service Fabric application composed of a master stateful persistent service and secondary stateless services deployed on all nodes (one secondary service type for each type of task).</span></span> <span data-ttu-id="fd370-254">El servicio maestro tiene una cola de procesamiento con comandos que ejecutarán los servicios secundarios.</span><span class="sxs-lookup"><span data-stu-id="fd370-254">The master has a processing queue that contains commands to be executed by secondaries.</span></span> <span data-ttu-id="fd370-255">Estos últimos ejecutan las solicitudes entrantes y devuelven señales de confirmación.</span><span class="sxs-lookup"><span data-stu-id="fd370-255">The secondaries execute the incoming requests and send back acknowledgement signals.</span></span> <span data-ttu-id="fd370-256">Una condición que puede supervisarse es la longitud de la cola de procesamiento maestra.</span><span class="sxs-lookup"><span data-stu-id="fd370-256">One condition that could be monitored is the length of the master processing queue.</span></span> <span data-ttu-id="fd370-257">Si la longitud de la cola maestra alcanza un umbral, se devuelve una advertencia</span><span class="sxs-lookup"><span data-stu-id="fd370-257">If the master queue length reaches a threshold, a warning is reported.</span></span> <span data-ttu-id="fd370-258">La advertencia que indica que los servicios secundarios no pueden controlar la carga.</span><span class="sxs-lookup"><span data-stu-id="fd370-258">The warning indicates that the secondaries can't handle the load.</span></span> <span data-ttu-id="fd370-259">Si la cola alcanza la longitud máxima y se quitan los comandos, se notifica un error, ya que el servicio no se puede recuperar.</span><span class="sxs-lookup"><span data-stu-id="fd370-259">If the queue reaches the maximum length and commands are dropped, an error is reported, as the service can't recover.</span></span> <span data-ttu-id="fd370-260">Los informes pueden estar en la propiedad **QueueStatus**.</span><span class="sxs-lookup"><span data-stu-id="fd370-260">The reports can be on the property **QueueStatus**.</span></span> <span data-ttu-id="fd370-261">El guardián reside dentro del servicio y se envía periódicamente en la réplica principal maestra.</span><span class="sxs-lookup"><span data-stu-id="fd370-261">The watchdog lives inside the service, and it's sent periodically on the master primary replica.</span></span> <span data-ttu-id="fd370-262">El período de vida es de dos minutos y se envía periódicamente cada 30 segundos.</span><span class="sxs-lookup"><span data-stu-id="fd370-262">The time to live is two minutes, and it's sent periodically every 30 seconds.</span></span> <span data-ttu-id="fd370-263">Si el principal deja de funcionar, el informe se limpia automáticamente del almacén.</span><span class="sxs-lookup"><span data-stu-id="fd370-263">If the primary goes down, the report is cleaned up automatically from store.</span></span> <span data-ttu-id="fd370-264">Si la réplica de servicio está activa, pero se ha interbloqueado o tiene otros problemas, el informe expira en el Almacén de estado.</span><span class="sxs-lookup"><span data-stu-id="fd370-264">If the service replica is up, but it is deadlocked or having other issues, the report expires in the health store.</span></span> <span data-ttu-id="fd370-265">En este caso, la entidad se evalúa con error.</span><span class="sxs-lookup"><span data-stu-id="fd370-265">In this case, the entity is evaluated at error.</span></span>

<span data-ttu-id="fd370-266">Otra condición que se pueden supervisar es el tiempo de ejecución de las tareas.</span><span class="sxs-lookup"><span data-stu-id="fd370-266">Another condition that can be monitored is task execution time.</span></span> <span data-ttu-id="fd370-267">El servicio maestro distribuye las tareas a los servicios secundarios según su tipo.</span><span class="sxs-lookup"><span data-stu-id="fd370-267">The master distributes tasks to the secondaries based on the task type.</span></span> <span data-ttu-id="fd370-268">Dependiendo del diseño, el maestro podría sondear los servicios secundarios para averiguar el estado de la tarea.</span><span class="sxs-lookup"><span data-stu-id="fd370-268">Depending on the design, the master could poll the secondaries for task status.</span></span> <span data-ttu-id="fd370-269">También podría esperar a que los servicios secundarios envíen señales de confirmación cuando hayan terminado.</span><span class="sxs-lookup"><span data-stu-id="fd370-269">It could also wait for secondaries to send back acknowledgement signals when they are done.</span></span> <span data-ttu-id="fd370-270">En el segundo caso, se debe tener cuidado de detectar situaciones en las que los servicios secundarios mueren o se pierden los mensajes.</span><span class="sxs-lookup"><span data-stu-id="fd370-270">In the second case, care must be taken to detect situations where secondaries die or messages are lost.</span></span> <span data-ttu-id="fd370-271">Una opción es que el servicio maestro envíe una solicitud de ping al mismo servicio secundario, que devuelve su estado.</span><span class="sxs-lookup"><span data-stu-id="fd370-271">One option is for the master to send a ping request to the same secondary, which sends back its status.</span></span> <span data-ttu-id="fd370-272">Si no se recibe ningún estado, el maestro lo considera un error y reprograma la tarea.</span><span class="sxs-lookup"><span data-stu-id="fd370-272">If no status is received, the master considers it a failure and reschedules the task.</span></span> <span data-ttu-id="fd370-273">Este comportamiento asume que las tareas son idempotentes.</span><span class="sxs-lookup"><span data-stu-id="fd370-273">This behavior assumes that the tasks are idempotent.</span></span>

<span data-ttu-id="fd370-274">Se puede traducir la condición supervisada como Advertencia si la tarea no se realiza en un tiempo determinado (**t1**, por ejemplo, 10 minutos).</span><span class="sxs-lookup"><span data-stu-id="fd370-274">The monitored condition can be translated as a warning if the task is not done in a certain time (**t1**, for example 10 minutes).</span></span> <span data-ttu-id="fd370-275">Si la tarea no se completó a tiempo (**t2**, por ejemplo, 20 minutos), se puede traducir la condición supervisada como Error.</span><span class="sxs-lookup"><span data-stu-id="fd370-275">If the task is not completed in time (**t2**, for example 20 minutes), the monitored condition can be translated as Error.</span></span> <span data-ttu-id="fd370-276">Estos informes pueden realizarse de varias maneras:</span><span class="sxs-lookup"><span data-stu-id="fd370-276">This reporting can be done in multiple ways:</span></span>

* <span data-ttu-id="fd370-277">La réplica principal maestra informa periódicamente sobre sí misma.</span><span class="sxs-lookup"><span data-stu-id="fd370-277">The master primary replica reports on itself periodically.</span></span> <span data-ttu-id="fd370-278">Puede tener una propiedad para todas las tareas pendientes en la cola.</span><span class="sxs-lookup"><span data-stu-id="fd370-278">You can have one property for all pending tasks in the queue.</span></span> <span data-ttu-id="fd370-279">Si al menos una de las tareas tarda más, el estado del informe en la propiedad **PendingTasks** es una advertencia o un error, según corresponda.</span><span class="sxs-lookup"><span data-stu-id="fd370-279">If at least one task takes longer, the report status on the property **PendingTasks** is a warning or error, as appropriate.</span></span> <span data-ttu-id="fd370-280">Si no hay ninguna tarea pendiente o todas acaban de empezar su ejecución, el estado del informe es correcto.</span><span class="sxs-lookup"><span data-stu-id="fd370-280">If there are no pending tasks or all tasks started execution, the report status is OK.</span></span> <span data-ttu-id="fd370-281">Las tareas son persistentes.</span><span class="sxs-lookup"><span data-stu-id="fd370-281">The tasks are persistent.</span></span> <span data-ttu-id="fd370-282">Si la principal deja de funcionar, la nueva tarea principal promocionada puede seguir informando correctamente.</span><span class="sxs-lookup"><span data-stu-id="fd370-282">If the primary goes down, the newly promoted primary can continue to report properly.</span></span>
* <span data-ttu-id="fd370-283">Otro proceso guardián (en la nube o externo) comprueba las tareas (desde fuera, en función del resultado deseado de la tarea) para ver si se han completado.</span><span class="sxs-lookup"><span data-stu-id="fd370-283">Another watchdog process (in the cloud or external) checks the tasks (from outside, based on the desired task result) to see if they are completed.</span></span> <span data-ttu-id="fd370-284">Si no respetan los umbrales, se envía un informe en el servicio principal.</span><span class="sxs-lookup"><span data-stu-id="fd370-284">If they do not respect the thresholds, a report is sent on the master service.</span></span> <span data-ttu-id="fd370-285">También se envía un informe en cada tarea que incluye el identificador de la tarea, como **PendingTask+taskId**.</span><span class="sxs-lookup"><span data-stu-id="fd370-285">A report is also sent on each task that includes the task identifier, like **PendingTask+taskId**.</span></span> <span data-ttu-id="fd370-286">Los informes solo se deben enviar con estados incorrectos.</span><span class="sxs-lookup"><span data-stu-id="fd370-286">Reports should be sent only on unhealthy states.</span></span> <span data-ttu-id="fd370-287">Establezca el período de vida en unos minutos y marque los informes para ser eliminados cuando caduquen para garantizar la limpieza.</span><span class="sxs-lookup"><span data-stu-id="fd370-287">Set time to live to a few minutes, and mark the reports to be removed when they expire to ensure cleanup.</span></span>
* <span data-ttu-id="fd370-288">El servicio secundario que ejecuta una tarea informa cuando tarda más tiempo del esperado en ejecutarse.</span><span class="sxs-lookup"><span data-stu-id="fd370-288">The secondary that is executing a task reports when it takes longer than expected to run it.</span></span> <span data-ttu-id="fd370-289">Informa en la instancia de servicio en la propiedad **PendingTasks**.</span><span class="sxs-lookup"><span data-stu-id="fd370-289">It reports on the service instance on the property **PendingTasks**.</span></span> <span data-ttu-id="fd370-290">Este informe indica la instancia de servicio que tiene problemas pero no captura la situación en la que se bloquea la instancia.</span><span class="sxs-lookup"><span data-stu-id="fd370-290">The report pinpoints the service instance that has issues, but it doesn't capture the situation where the instance dies.</span></span> <span data-ttu-id="fd370-291">Los informes se limpian en ese momento.</span><span class="sxs-lookup"><span data-stu-id="fd370-291">The reports are cleaned up then.</span></span> <span data-ttu-id="fd370-292">Podría informar sobre el servicio secundario.</span><span class="sxs-lookup"><span data-stu-id="fd370-292">It could report on the secondary service.</span></span> <span data-ttu-id="fd370-293">Si el servicio secundario completa la tarea, la instancia secundaria borra el informe del almacén.</span><span class="sxs-lookup"><span data-stu-id="fd370-293">If the secondary completes the task, the secondary instance clears the report from the store.</span></span> <span data-ttu-id="fd370-294">El informe no captura la situación en la que se pierde el mensaje de confirmación y la tarea no se considera terminada desde el punto de vista del maestro.</span><span class="sxs-lookup"><span data-stu-id="fd370-294">The report doesn't capture the situation where the acknowledgement message is lost and the task is not finished from the master's point of view.</span></span>

<span data-ttu-id="fd370-295">Sin embargo, los informes se crean en los casos que se han descrito anteriormente y se capturan en el mantenimiento de la aplicación cuando se evalúe el mantenimiento.</span><span class="sxs-lookup"><span data-stu-id="fd370-295">However the reporting is done in the cases described above, the reports are captured in application health when health is evaluated.</span></span>

## <a name="report-periodically-vs-on-transition"></a><span data-ttu-id="fd370-296">Informar periódicamente frente a en transiciones</span><span class="sxs-lookup"><span data-stu-id="fd370-296">Report periodically vs. on transition</span></span>
<span data-ttu-id="fd370-297">Con el modelo de informes de mantenimiento, los guardianes pueden enviar informes periódicamente o en las transiciones.</span><span class="sxs-lookup"><span data-stu-id="fd370-297">By using the health reporting model, watchdogs can send reports periodically or on transitions.</span></span> <span data-ttu-id="fd370-298">Se recomienda que los informes guardián sean periódicos, ya que el código es mucho más sencillo y menos propenso a errores.</span><span class="sxs-lookup"><span data-stu-id="fd370-298">The recommended way for watchdog reporting is periodically, because the code is much simpler and less prone to errors.</span></span> <span data-ttu-id="fd370-299">Los guardianes deben esforzarse por ser los más simples posible para evitar errores que desencadenen informes incorrectos.</span><span class="sxs-lookup"><span data-stu-id="fd370-299">The watchdogs must strive to be as simple as possible to avoid bugs that trigger incorrect reports.</span></span> <span data-ttu-id="fd370-300">Los informes de *mal estado* incorrectos afectarán a los escenarios y las evaluaciones de mantenimiento en función del estado, como las actualizaciones.</span><span class="sxs-lookup"><span data-stu-id="fd370-300">Incorrect *unhealthy* reports impact health evaluations and scenarios based on health, including upgrades.</span></span> <span data-ttu-id="fd370-301">Los informes de *buen estado* incorrectos ocultan problemas en el clúster, lo cual no es deseable.</span><span class="sxs-lookup"><span data-stu-id="fd370-301">Incorrect *healthy* reports hide issues in the cluster, which is not desired.</span></span>

<span data-ttu-id="fd370-302">Para los informes periódicos, el guardián puede implementarse con un temporizador.</span><span class="sxs-lookup"><span data-stu-id="fd370-302">For periodic reporting, the watchdog can be implemented with a timer.</span></span> <span data-ttu-id="fd370-303">En la devolución de llamada del temporizador, el guardián puede comprobar el estado y enviar un informe según el estado actual.</span><span class="sxs-lookup"><span data-stu-id="fd370-303">On a timer callback, the watchdog can check the state and send a report based on the current state.</span></span> <span data-ttu-id="fd370-304">No es necesario comprobar qué informe se ha enviado anteriormente ni realizar ninguna optimización en términos de mensajería.</span><span class="sxs-lookup"><span data-stu-id="fd370-304">There is no need to see which report was sent previously or make any optimizations in terms of messaging.</span></span> <span data-ttu-id="fd370-305">El cliente de mantenimiento tiene una lógica de procesamiento por lotes para ayudarle con el rendimiento.</span><span class="sxs-lookup"><span data-stu-id="fd370-305">The health client has batching logic to help with performance.</span></span> <span data-ttu-id="fd370-306">Mientras el cliente de mantenimiento se mantenga activo, vuelve a intentarlo internamente hasta que el informe sea confirmado por parte del Almacén de estado o que el guardián genere un informe más reciente con la misma entidad, propiedad y origen.</span><span class="sxs-lookup"><span data-stu-id="fd370-306">While the health client is kept alive, it retries internally until the report is acknowledged by the health store or the watchdog generates a newer report with the same entity, property, and source.</span></span>

<span data-ttu-id="fd370-307">Los informes en las transiciones requieren un tratamiento especial del estado.</span><span class="sxs-lookup"><span data-stu-id="fd370-307">Reporting on transitions requires careful handling of state.</span></span> <span data-ttu-id="fd370-308">El guardián supervisa algunas condiciones y solo informa cuando cambian las condiciones.</span><span class="sxs-lookup"><span data-stu-id="fd370-308">The watchdog monitors some conditions and reports only when the conditions change.</span></span> <span data-ttu-id="fd370-309">La parte positiva de este enfoque es que se necesitan menos informes.</span><span class="sxs-lookup"><span data-stu-id="fd370-309">The upside of this approach is that fewer reports are needed.</span></span> <span data-ttu-id="fd370-310">La parte negativa es que la lógica del guardián es compleja.</span><span class="sxs-lookup"><span data-stu-id="fd370-310">The downside is that the logic of the watchdog is complex.</span></span> <span data-ttu-id="fd370-311">El guardián debe mantener las condiciones o los informes, de modo que se puedan inspeccionar para determinar los cambios de estado.</span><span class="sxs-lookup"><span data-stu-id="fd370-311">The watchdog must maintain the conditions or the reports, so that they can be inspected to determine state changes.</span></span> <span data-ttu-id="fd370-312">En la conmutación por error, tenga cuidado con los informes agregados que aún no se hayan enviado al almacén de estado.</span><span class="sxs-lookup"><span data-stu-id="fd370-312">On failover, care must be taken with reports added, but not yet sent to the health store.</span></span> <span data-ttu-id="fd370-313">El número de secuencia debe ser creciente.</span><span class="sxs-lookup"><span data-stu-id="fd370-313">The sequence number must be ever-increasing.</span></span> <span data-ttu-id="fd370-314">Si no es así, los informes se rechazan como obsoletos.</span><span class="sxs-lookup"><span data-stu-id="fd370-314">If not, the reports are rejected as stale.</span></span> <span data-ttu-id="fd370-315">En los casos poco frecuentes en los que se produce la pérdida de datos, puede que sea necesario realizar la sincronización entre el estado del informador y el estado del almacén de estado.</span><span class="sxs-lookup"><span data-stu-id="fd370-315">In the rare cases where data loss is incurred, synchronization may be needed between the state of the reporter and the state of the health store.</span></span>

<span data-ttu-id="fd370-316">La creación de informes sobre las transiciones tiene sentido para los servicios que crean informes sobre sí mismos, mediante `Partition` o `CodePackageActivationContext`.</span><span class="sxs-lookup"><span data-stu-id="fd370-316">Reporting on transitions makes sense for services reporting on themselves, through `Partition` or `CodePackageActivationContext`.</span></span> <span data-ttu-id="fd370-317">Cuando se quita el objeto local (paquete de servicio de réplica o implementado / aplicación implementada), también se quitan todos sus informes.</span><span class="sxs-lookup"><span data-stu-id="fd370-317">When the local object (replica or deployed service package / deployed application) is removed, all its reports are also removed.</span></span> <span data-ttu-id="fd370-318">Esta limpieza automática reduce la necesidad de sincronización entre el informador y el Almacén de estado.</span><span class="sxs-lookup"><span data-stu-id="fd370-318">This automatic cleanup relaxes the need for synchronization between reporter and health store.</span></span> <span data-ttu-id="fd370-319">Si el informe es para la partición o la aplicación primaria, debe tener cuidado en la conmutación por error para evitar informes obsoletos en el almacén de estado.</span><span class="sxs-lookup"><span data-stu-id="fd370-319">If the report is for parent partition or parent application, care must be taken on failover to avoid stale reports in the health store.</span></span> <span data-ttu-id="fd370-320">Debe agregarse lógica para mantener el estado correcto y borrar el informe del almacén cuando ya no sea necesario.</span><span class="sxs-lookup"><span data-stu-id="fd370-320">Logic must be added to maintain the correct state and clear the report from store when not needed anymore.</span></span>

## <a name="implement-health-reporting"></a><span data-ttu-id="fd370-321">Implementación de la generación de informes de estado</span><span class="sxs-lookup"><span data-stu-id="fd370-321">Implement health reporting</span></span>
<span data-ttu-id="fd370-322">Una vez que los detalles de entidades e informes están claros, el envío de informes de estado puede realizarse a través de API, Powershell o REST.</span><span class="sxs-lookup"><span data-stu-id="fd370-322">Once the entity and report details are clear, sending health reports can be done through the API, PowerShell, or REST.</span></span>

### <a name="api"></a><span data-ttu-id="fd370-323">API</span><span class="sxs-lookup"><span data-stu-id="fd370-323">API</span></span>
<span data-ttu-id="fd370-324">Para informar a través de API, debe crear un informe de mantenimiento específico del tipo de entidad sobre la que desea informar.</span><span class="sxs-lookup"><span data-stu-id="fd370-324">To report through the API, you need to create a health report specific to the entity type they want to report on.</span></span> <span data-ttu-id="fd370-325">Entregue el informe a un cliente de mantenimiento.</span><span class="sxs-lookup"><span data-stu-id="fd370-325">Give the report to a health client.</span></span> <span data-ttu-id="fd370-326">Como alternativa, cree información de mantenimiento y pásela para corregir los métodos de creación de informes en `Partition` o `CodePackageActivationContext` a fin de informar sobre entidades actuales.</span><span class="sxs-lookup"><span data-stu-id="fd370-326">Alternatively, create a health information and pass it to correct reporting methods on `Partition` or `CodePackageActivationContext` to report on current entities.</span></span>

<span data-ttu-id="fd370-327">El ejemplo siguiente muestra informes periódicos de un guardián dentro del clúster.</span><span class="sxs-lookup"><span data-stu-id="fd370-327">The following example shows periodic reporting from a watchdog within the cluster.</span></span> <span data-ttu-id="fd370-328">El guardián comprueba si se puede acceder a un recurso externo desde dentro de un nodo.</span><span class="sxs-lookup"><span data-stu-id="fd370-328">The watchdog checks whether an external resource can be accessed from within a node.</span></span> <span data-ttu-id="fd370-329">El recurso es necesario para un manifiesto de servicio de dentro de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="fd370-329">The resource is needed by a service manifest within the application.</span></span> <span data-ttu-id="fd370-330">Si el recurso no está disponible, los demás servicios de dentro de la aplicación pueden seguir funcionando correctamente.</span><span class="sxs-lookup"><span data-stu-id="fd370-330">If the resource is unavailable, the other services within the application can still function properly.</span></span> <span data-ttu-id="fd370-331">Por lo tanto, el informe se envía en la entidad del paquete de servicio implementado cada 30 segundos.</span><span class="sxs-lookup"><span data-stu-id="fd370-331">Therefore, the report is sent on the deployed service package entity every 30 seconds.</span></span>

```csharp
private static Uri ApplicationName = new Uri("fabric:/WordCount");
private static string ServiceManifestName = "WordCount.Service";
private static string NodeName = FabricRuntime.GetNodeContext().NodeName;
private static Timer ReportTimer = new Timer(new TimerCallback(SendReport), null, 30 * 1000, 30 * 1000);
private static FabricClient Client = new FabricClient(new FabricClientSettings() { HealthReportSendInterval = TimeSpan.FromSeconds(0) });

public static void SendReport(object obj)
{
    // Test whether the resource can be accessed from the node
    HealthState healthState = this.TestConnectivityToExternalResource();

    // Send report on deployed service package, as the connectivity is needed by the specific service manifest
    // and can be different on different nodes
    var deployedServicePackageHealthReport = new DeployedServicePackageHealthReport(
        ApplicationName,
        ServiceManifestName,
        NodeName,
        new HealthInformation("ExternalSourceWatcher", "Connectivity", healthState));

    // TODO: handle exception. Code omitted for snippet brevity.
    // Possible exceptions: FabricException with error codes
    // FabricHealthStaleReport (non-retryable, the report is already queued on the health client),
    // FabricHealthMaxReportsReached (retryable; user should retry with exponential delay until the report is accepted).
    Client.HealthManager.ReportHealth(deployedServicePackageHealthReport);
}
```

### <a name="powershell"></a><span data-ttu-id="fd370-332">PowerShell</span><span class="sxs-lookup"><span data-stu-id="fd370-332">PowerShell</span></span>
<span data-ttu-id="fd370-333">Envíe informes de mantenimiento con **Send-ServiceFabric*EntityType*HealthReport**.</span><span class="sxs-lookup"><span data-stu-id="fd370-333">Send health reports with **Send-ServiceFabric*EntityType*HealthReport**.</span></span>

<span data-ttu-id="fd370-334">El ejemplo siguiente muestra informes periódicos sobre valores de la CPU en un nodo.</span><span class="sxs-lookup"><span data-stu-id="fd370-334">The following example shows periodic reporting on CPU values on a node.</span></span> <span data-ttu-id="fd370-335">Los informes se deben enviar cada 30 segundos, y tienen un período de vida de dos minutos.</span><span class="sxs-lookup"><span data-stu-id="fd370-335">The reports should be sent every 30 seconds, and they have a time to live of two minutes.</span></span> <span data-ttu-id="fd370-336">Si caducan, significa que el informador tiene problemas, por lo que el nodo se ha evaluado con error.</span><span class="sxs-lookup"><span data-stu-id="fd370-336">If they expire, the reporter has issues, so the node is evaluated at error.</span></span> <span data-ttu-id="fd370-337">Cuando la CPU está por encima de un umbral, el informe tiene un estado de advertencia.</span><span class="sxs-lookup"><span data-stu-id="fd370-337">When the CPU is above a threshold, the report has a health state of warning.</span></span> <span data-ttu-id="fd370-338">Cuando la CPU se mantiene por encima de un umbral un tiempo superior al configurado, se notifica como error.</span><span class="sxs-lookup"><span data-stu-id="fd370-338">When the CPU remains above a threshold for more than the configured time, it's reported as an error.</span></span> <span data-ttu-id="fd370-339">De lo contrario, el informador envía un estado correcto.</span><span class="sxs-lookup"><span data-stu-id="fd370-339">Otherwise, the reporter sends a health state of OK.</span></span>

```powershell
PS C:\> Send-ServiceFabricNodeHealthReport -NodeName Node.1 -HealthState Warning -SourceId PowershellWatcher -HealthProperty CPU -Description "CPU is above 80% threshold" -TimeToLiveSec 120

PS C:\> Get-ServiceFabricNodeHealth -NodeName Node.1
NodeName              : Node.1
AggregatedHealthState : Warning
UnhealthyEvaluations  :
                        Unhealthy event: SourceId='PowershellWatcher', Property='CPU', HealthState='Warning', ConsiderWarningAsError=false.

HealthEvents          :
                        SourceId              : System.FM
                        Property              : State
                        HealthState           : Ok
                        SequenceNumber        : 5
                        SentAt                : 4/21/2015 8:01:17 AM
                        ReceivedAt            : 4/21/2015 8:02:12 AM
                        TTL                   : Infinite
                        Description           : Fabric node is up.
                        RemoveWhenExpired     : False
                        IsExpired             : False
                        Transitions           : ->Ok = 4/21/2015 8:02:12 AM

                        SourceId              : PowershellWatcher
                        Property              : CPU
                        HealthState           : Warning
                        SequenceNumber        : 130741236814913394
                        SentAt                : 4/21/2015 9:01:21 PM
                        ReceivedAt            : 4/21/2015 9:01:21 PM
                        TTL                   : 00:02:00
                        Description           : CPU is above 80% threshold
                        RemoveWhenExpired     : False
                        IsExpired             : False
                        Transitions           : ->Warning = 4/21/2015 9:01:21 PM
```

<span data-ttu-id="fd370-340">En el ejemplo siguiente se notifica una advertencia transitoria en una réplica.</span><span class="sxs-lookup"><span data-stu-id="fd370-340">The following example reports a transient warning on a replica.</span></span> <span data-ttu-id="fd370-341">Primero se obtiene el identificador de partición y luego el identificador de réplica del servicio en el que está interesado.</span><span class="sxs-lookup"><span data-stu-id="fd370-341">It first gets the partition ID and then the replica ID for the service it is interested in.</span></span> <span data-ttu-id="fd370-342">A continuación, se envía un informe de **PowershellWatcher** en la propiedad **ResourceDependency**.</span><span class="sxs-lookup"><span data-stu-id="fd370-342">It then sends a report from **PowershellWatcher** on the property **ResourceDependency**.</span></span> <span data-ttu-id="fd370-343">El informe es de interés durante solo dos minutos, y se quita del almacén de manera automática.</span><span class="sxs-lookup"><span data-stu-id="fd370-343">The report is of interest for only two minutes, and it is removed from the store automatically.</span></span>

```powershell
PS C:\> $partitionId = (Get-ServiceFabricPartition -ServiceName fabric:/WordCount/WordCount.Service).PartitionId

PS C:\> $replicaId = (Get-ServiceFabricReplica -PartitionId $partitionId | where {$_.ReplicaRole -eq "Primary"}).ReplicaId

PS C:\> Send-ServiceFabricReplicaHealthReport -PartitionId $partitionId -ReplicaId $replicaId -HealthState Warning -SourceId PowershellWatcher -HealthProperty ResourceDependency -Description "The external resource that the primary is using has been rebooted at 4/21/2015 9:01:21 PM. Expect processing delays for a few minutes." -TimeToLiveSec 120 -RemoveWhenExpired

PS C:\> Get-ServiceFabricReplicaHealth  -PartitionId $partitionId -ReplicaOrInstanceId $replicaId


PartitionId           : 8f82daff-eb68-4fd9-b631-7a37629e08c0
ReplicaId             : 130740415594605869
AggregatedHealthState : Warning
UnhealthyEvaluations  :
                        Unhealthy event: SourceId='PowershellWatcher', Property='ResourceDependency', HealthState='Warning', ConsiderWarningAsError=false.

HealthEvents          :
                        SourceId              : System.RA
                        Property              : State
                        HealthState           : Ok
                        SequenceNumber        : 130740768777734943
                        SentAt                : 4/21/2015 8:01:17 AM
                        ReceivedAt            : 4/21/2015 8:02:12 AM
                        TTL                   : Infinite
                        Description           : Replica has been created.
                        RemoveWhenExpired     : False
                        IsExpired             : False
                        Transitions           : ->Ok = 4/21/2015 8:02:12 AM

                        SourceId              : PowershellWatcher
                        Property              : ResourceDependency
                        HealthState           : Warning
                        SequenceNumber        : 130741243777723555
                        SentAt                : 4/21/2015 9:12:57 PM
                        ReceivedAt            : 4/21/2015 9:12:57 PM
                        TTL                   : 00:02:00
                        Description           : The external resource that the primary is using has been rebooted at 4/21/2015 9:01:21 PM. Expect processing delays for a few minutes.
                        RemoveWhenExpired     : True
                        IsExpired             : False
                        Transitions           : ->Warning = 4/21/2015 9:12:32 PM
```

### <a name="rest"></a><span data-ttu-id="fd370-344">REST</span><span class="sxs-lookup"><span data-stu-id="fd370-344">REST</span></span>
<span data-ttu-id="fd370-345">Envíe informes de mantenimiento mediante REST con solicitudes POST que vayan a la entidad deseada y tengan en el cuerpo la descripción del informe de mantenimiento.</span><span class="sxs-lookup"><span data-stu-id="fd370-345">Send health reports using REST with POST requests that go to the desired entity and have in the body the health report description.</span></span> <span data-ttu-id="fd370-346">Por ejemplo, consulte cómo enviar [informes de mantenimiento de clúster](https://docs.microsoft.com/rest/api/servicefabric/report-the-health-of-a-cluster) o [informes de mantenimiento de servicio](https://docs.microsoft.com/rest/api/servicefabric/report-the-health-of-a-service) de REST.</span><span class="sxs-lookup"><span data-stu-id="fd370-346">For example, see how to send REST [cluster health reports](https://docs.microsoft.com/rest/api/servicefabric/report-the-health-of-a-cluster) or [service health reports](https://docs.microsoft.com/rest/api/servicefabric/report-the-health-of-a-service).</span></span> <span data-ttu-id="fd370-347">Se admiten todas las entidades.</span><span class="sxs-lookup"><span data-stu-id="fd370-347">All entities are supported.</span></span>

## <a name="next-steps"></a><span data-ttu-id="fd370-348">Pasos siguientes</span><span class="sxs-lookup"><span data-stu-id="fd370-348">Next steps</span></span>
<span data-ttu-id="fd370-349">Según los datos del estado, los escritores del servicio y los administradores de clúster/aplicación pueden pensar en maneras de utilizar la información.</span><span class="sxs-lookup"><span data-stu-id="fd370-349">Based on the health data, service writers and cluster/application administrators can think of ways to consume the information.</span></span> <span data-ttu-id="fd370-350">Por ejemplo, pueden configurar alertas basadas en el estado de mantenimiento para detectar problemas graves antes de provocar interrupciones.</span><span class="sxs-lookup"><span data-stu-id="fd370-350">For example, they can set up alerts based on health status to catch severe issues before they provoke outages.</span></span> <span data-ttu-id="fd370-351">Los administradores también pueden configurar sistemas de reparación para solucionar problemas de forma automática.</span><span class="sxs-lookup"><span data-stu-id="fd370-351">Administrators can also set up repair systems to fix issues automatically.</span></span>

[<span data-ttu-id="fd370-352">Introducción a la supervisión de mantenimiento de Service Fabric</span><span class="sxs-lookup"><span data-stu-id="fd370-352">Introduction to Service Fabric health Monitoring</span></span>](service-fabric-health-introduction.md)

[<span data-ttu-id="fd370-353">Vista de los informes de estado de Service Fabric</span><span class="sxs-lookup"><span data-stu-id="fd370-353">View Service Fabric health reports</span></span>](service-fabric-view-entities-aggregated-health.md)

[<span data-ttu-id="fd370-354">Notificación y comprobación del estado del servicio</span><span class="sxs-lookup"><span data-stu-id="fd370-354">How to report and check service health</span></span>](service-fabric-diagnostics-how-to-report-and-check-service-health.md)

[<span data-ttu-id="fd370-355">Uso de informes de mantenimiento del sistema para solucionar problemas</span><span class="sxs-lookup"><span data-stu-id="fd370-355">Use system health reports for troubleshooting</span></span>](service-fabric-understand-and-troubleshoot-with-system-health-reports.md)

[<span data-ttu-id="fd370-356">Supervisión y diagnóstico de los servicios localmente</span><span class="sxs-lookup"><span data-stu-id="fd370-356">Monitor and diagnose services locally</span></span>](service-fabric-diagnostics-how-to-monitor-and-diagnose-services-locally.md)

[<span data-ttu-id="fd370-357">Actualización de la aplicación de Service Fabric</span><span class="sxs-lookup"><span data-stu-id="fd370-357">Service Fabric application upgrade</span></span>](service-fabric-application-upgrade.md)

