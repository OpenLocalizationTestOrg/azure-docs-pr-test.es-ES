---
title: aaaOverview del ciclo de vida de hello Service Fabric confiable de servicios de Azure | Documentos de Microsoft
description: "Obtenga información acerca de los eventos de ciclo de vida distinto de hello en servicios de Service Fabric confiables"
services: Service-Fabric
documentationcenter: .net
author: masnider
manager: timlt
editor: vturecek;
ms.assetid: 
ms.service: Service-Fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 08/18/2017
ms.author: masnider
ms.openlocfilehash: 0d75ed5ee7cda85ac9af6a02e160727277804a2b
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 10/06/2017
---
# <a name="reliable-services-lifecycle-overview"></a><span data-ttu-id="24db0-103">Información general del ciclo de vida de Reliable Services</span><span class="sxs-lookup"><span data-stu-id="24db0-103">Reliable services lifecycle overview</span></span>
> [!div class="op_single_selector"]
> * [<span data-ttu-id="24db0-104">C# en Windows</span><span class="sxs-lookup"><span data-stu-id="24db0-104">C# on Windows</span></span>](service-fabric-reliable-services-lifecycle.md)
> * [<span data-ttu-id="24db0-105">Java en Linux</span><span class="sxs-lookup"><span data-stu-id="24db0-105">Java on Linux</span></span>](service-fabric-reliable-services-lifecycle-java.md)
>
>

<span data-ttu-id="24db0-106">Al pensar en los ciclos de vida de hello de servicios de confianza, conceptos básicos de hello del ciclo de vida de hello son hello más importante.</span><span class="sxs-lookup"><span data-stu-id="24db0-106">When thinking about hello lifecycles of Reliable Services, hello basics of hello lifecycle are hello most important.</span></span> <span data-ttu-id="24db0-107">En general:</span><span class="sxs-lookup"><span data-stu-id="24db0-107">In general:</span></span>

- <span data-ttu-id="24db0-108">Durante el inicio:</span><span class="sxs-lookup"><span data-stu-id="24db0-108">During Startup</span></span>
  - <span data-ttu-id="24db0-109">se construyen los servicios,</span><span class="sxs-lookup"><span data-stu-id="24db0-109">Services are constructed</span></span>
  - <span data-ttu-id="24db0-110">Tienen un tooconstruct oportunidad y devolver cero o más agentes de escucha</span><span class="sxs-lookup"><span data-stu-id="24db0-110">They have an opportunity tooconstruct and return zero or more listeners</span></span>
  - <span data-ttu-id="24db0-111">Se abre cualquier agente de escucha devuelta, que permita la comunicación con el servicio de Hola</span><span class="sxs-lookup"><span data-stu-id="24db0-111">Any returned listeners are opened, allowing communication with hello service</span></span>
  - <span data-ttu-id="24db0-112">Coredispatcher del servicio de Hello método se llama, permitiendo hello toodo larga ejecución del servicio o trabajo en segundo plano</span><span class="sxs-lookup"><span data-stu-id="24db0-112">hello Service's RunAsync method is called, allowing hello service toodo long running or background work</span></span>
- <span data-ttu-id="24db0-113">Durante el cierre:</span><span class="sxs-lookup"><span data-stu-id="24db0-113">During shutdown</span></span>
  - <span data-ttu-id="24db0-114">tooRunAsync pasado token Hola de cancelación se cancela y se cierran los agentes de escucha de Hola</span><span class="sxs-lookup"><span data-stu-id="24db0-114">hello cancellation token passed tooRunAsync is canceled, and hello listeners are closed</span></span>
  - <span data-ttu-id="24db0-115">Una vez completado, se destruye propio objeto de servicio Hola</span><span class="sxs-lookup"><span data-stu-id="24db0-115">Once that is complete, hello service object itself is destructed</span></span>

<span data-ttu-id="24db0-116">No hay información alrededor de hello exacto de orden de estos eventos.</span><span class="sxs-lookup"><span data-stu-id="24db0-116">There are details around hello exact ordering of these events.</span></span> <span data-ttu-id="24db0-117">En concreto, orden de Hola de eventos puede cambiar ligeramente dependiendo de si Hola servicio confiable es Stateless o con estado.</span><span class="sxs-lookup"><span data-stu-id="24db0-117">In particular, hello order of events may change slightly depending on whether hello Reliable Service is Stateless or Stateful.</span></span> <span data-ttu-id="24db0-118">Además, los servicios con estado, tenemos toodeal con el escenario de intercambio principal Hola.</span><span class="sxs-lookup"><span data-stu-id="24db0-118">In addition, for stateful services, we have toodeal with hello Primary swap scenario.</span></span> <span data-ttu-id="24db0-119">Durante esta secuencia, rol de Hola de principal es tooanother transfieren réplica (o vuelve a estar) sin el servicio de Hola que se va a cerrar.</span><span class="sxs-lookup"><span data-stu-id="24db0-119">During this sequence, hello role of Primary is transferred tooanother replica (or comes back) without hello service shutting down.</span></span> <span data-ttu-id="24db0-120">Por último, tenemos toothink acerca de las condiciones de error o un error.</span><span class="sxs-lookup"><span data-stu-id="24db0-120">Finally, we have toothink about error or failure conditions.</span></span>

## <a name="stateless-service-startup"></a><span data-ttu-id="24db0-121">Inicio de un servicio sin estado</span><span class="sxs-lookup"><span data-stu-id="24db0-121">Stateless service startup</span></span>
<span data-ttu-id="24db0-122">ciclo de vida de Hola de un servicio sin estado es bastante sencilla.</span><span class="sxs-lookup"><span data-stu-id="24db0-122">hello lifecycle of a stateless service is fairly straightforward.</span></span> <span data-ttu-id="24db0-123">Este es el orden Hola de eventos:</span><span class="sxs-lookup"><span data-stu-id="24db0-123">Here's hello order of events:</span></span>

1. <span data-ttu-id="24db0-124">Hola se construye servicio</span><span class="sxs-lookup"><span data-stu-id="24db0-124">hello Service is constructed</span></span>
2. <span data-ttu-id="24db0-125">A continuación, suceden dos cosas simultáneamente:</span><span class="sxs-lookup"><span data-stu-id="24db0-125">Then, in parallel two things happen:</span></span>
    - <span data-ttu-id="24db0-126">Se invoca `StatelessService.CreateServiceInstanceListeners()` y se abren los agentes de escucha devueltos.</span><span class="sxs-lookup"><span data-stu-id="24db0-126">`StatelessService.CreateServiceInstanceListeners()` is invoked and any returned listeners are Opened.</span></span> <span data-ttu-id="24db0-127">Se llama a `ICommunicationListener.OpenAsync()` en cada uno de los agentes de escucha.</span><span class="sxs-lookup"><span data-stu-id="24db0-127">`ICommunicationListener.OpenAsync()` is called on each listener</span></span>
    - <span data-ttu-id="24db0-128">Hola del servicio `StatelessService.RunAsync()` se llama al método</span><span class="sxs-lookup"><span data-stu-id="24db0-128">hello service's `StatelessService.RunAsync()` method is called</span></span>
3. <span data-ttu-id="24db0-129">Si está presente, Hola del servicio `StatelessService.OnOpenAsync()` se llama al método.</span><span class="sxs-lookup"><span data-stu-id="24db0-129">If present, hello service's `StatelessService.OnOpenAsync()` method is called.</span></span> <span data-ttu-id="24db0-130">Esta invalidación es poco habitual, pero está disponible.</span><span class="sxs-lookup"><span data-stu-id="24db0-130">This is an uncommon override, but it is available.</span></span>

<span data-ttu-id="24db0-131">Es importante toonote que no hay ningún orden entre Hola llamadas toocreate y agentes de escucha de hello abierto y Coredispatcher.</span><span class="sxs-lookup"><span data-stu-id="24db0-131">It is important toonote that there is no ordering between hello calls toocreate and open hello listeners and RunAsync.</span></span> <span data-ttu-id="24db0-132">pueden abrir los agentes de escucha de Hola antes de inicia la Coredispatcher.</span><span class="sxs-lookup"><span data-stu-id="24db0-132">hello listeners may open before RunAsync is started.</span></span> <span data-ttu-id="24db0-133">De forma similar, Coredispatcher terminen invoca antes de que los agentes de escucha de comunicación de hello están abiertos o incluso construidos.</span><span class="sxs-lookup"><span data-stu-id="24db0-133">Similarly, RunAsync may end up invoked before hello communication listeners are open or have even been constructed.</span></span> <span data-ttu-id="24db0-134">Si no se necesita ninguna sincronización, se deja como ejercicio toohello implementador.</span><span class="sxs-lookup"><span data-stu-id="24db0-134">If any synchronization is required, it is left as an exercise toohello implementer.</span></span> <span data-ttu-id="24db0-135">Soluciones comunes:</span><span class="sxs-lookup"><span data-stu-id="24db0-135">Common solutions:</span></span>

  - <span data-ttu-id="24db0-136">En ocasiones, los agentes de escucha no pueden funcionar hasta que se crea otra información o se realiza un trabajo.</span><span class="sxs-lookup"><span data-stu-id="24db0-136">Sometimes listeners can't function until some other information is created or work done.</span></span> <span data-ttu-id="24db0-137">En el caso de los servicios sin estado, normalmente, esto puede hacerse en otras ubicaciones, como:</span><span class="sxs-lookup"><span data-stu-id="24db0-137">For stateless services that work can usually be done in other locations, such as:</span></span> 
    - <span data-ttu-id="24db0-138">en el constructor del servicio de Hola</span><span class="sxs-lookup"><span data-stu-id="24db0-138">in hello service's constructor</span></span>
    - <span data-ttu-id="24db0-139">durante el saludo `CreateServiceInstanceListeners()` llamar a</span><span class="sxs-lookup"><span data-stu-id="24db0-139">during hello `CreateServiceInstanceListeners()` call</span></span>
    - <span data-ttu-id="24db0-140">como parte de la construcción de Hola de hello propio agente de escucha</span><span class="sxs-lookup"><span data-stu-id="24db0-140">as a part of hello construction of hello listener itself</span></span>
  - <span data-ttu-id="24db0-141">A veces hello código en Coredispatcher no quiere toostart hasta que los agentes de escucha de hello están abiertos.</span><span class="sxs-lookup"><span data-stu-id="24db0-141">Sometimes hello code in RunAsync does not want toostart until hello listeners are open.</span></span> <span data-ttu-id="24db0-142">En este caso, hace falta coordinación adicional.</span><span class="sxs-lookup"><span data-stu-id="24db0-142">In this case additional coordination is necessary.</span></span> <span data-ttu-id="24db0-143">Una solución habitual es algún indicador dentro de los agentes de escucha hello, que indica cuándo ha completado.</span><span class="sxs-lookup"><span data-stu-id="24db0-143">One common solution is some flag within hello listeners indicating when they have completed.</span></span> <span data-ttu-id="24db0-144">Esta marca, a continuación, se comprueba en Coredispatcher antes de continuar el trabajo de tooactual.</span><span class="sxs-lookup"><span data-stu-id="24db0-144">This flag is then checked in RunAsync before continuing tooactual work.</span></span>

## <a name="stateless-service-shutdown"></a><span data-ttu-id="24db0-145">Cierre de un servicio sin estado</span><span class="sxs-lookup"><span data-stu-id="24db0-145">Stateless service shutdown</span></span>
<span data-ttu-id="24db0-146">Cuando se va a cerrar un servicio sin estado, Hola se sigue el mismo patrón, solo en orden inverso:</span><span class="sxs-lookup"><span data-stu-id="24db0-146">When shutting down a stateless service, hello same pattern is followed, just in reverse:</span></span>

1. <span data-ttu-id="24db0-147">En paralelo</span><span class="sxs-lookup"><span data-stu-id="24db0-147">In parallel</span></span>
    - <span data-ttu-id="24db0-148">Todos los agentes de escucha abiertos se cierran.</span><span class="sxs-lookup"><span data-stu-id="24db0-148">Any open listeners are Closed.</span></span> <span data-ttu-id="24db0-149">Se llama a `ICommunicationListener.CloseAsync()` en cada uno de los agentes de escucha.</span><span class="sxs-lookup"><span data-stu-id="24db0-149">`ICommunicationListener.CloseAsync()` is called on each listener.</span></span>
    - <span data-ttu-id="24db0-150">token de cancelación de Hello pasa demasiado`RunAsync()` se cancela.</span><span class="sxs-lookup"><span data-stu-id="24db0-150">hello cancellation token passed too`RunAsync()` is canceled.</span></span> <span data-ttu-id="24db0-151">Comprobando token de cancelación de hello `IsCancellationRequested` propiedad devuelve true y si se llama del token de hello `ThrowIfCancellationRequested` método inicie una excepción un `OperationCanceledException`.</span><span class="sxs-lookup"><span data-stu-id="24db0-151">Checking hello cancellation token's `IsCancellationRequested` property returns true, and if called hello token's `ThrowIfCancellationRequested` method throws an `OperationCanceledException`.</span></span>
2. <span data-ttu-id="24db0-152">Una vez `CloseAsync()` completa en cada agente de escucha y `RunAsync()` también completa, del servicio de hello `StatelessService.OnCloseAsync()` se llama el método, si está presente.</span><span class="sxs-lookup"><span data-stu-id="24db0-152">Once `CloseAsync()` completes on each listener and `RunAsync()` also completes, hello service's `StatelessService.OnCloseAsync()` method is called, if present.</span></span> <span data-ttu-id="24db0-153">Es raro que toooverride `StatelessService.OnCloseAsync()`.</span><span class="sxs-lookup"><span data-stu-id="24db0-153">It is uncommon toooverride `StatelessService.OnCloseAsync()`.</span></span>
3. <span data-ttu-id="24db0-154">Después de `StatelessService.OnCloseAsync()` completa, se destruye el objeto de servicio de Hola</span><span class="sxs-lookup"><span data-stu-id="24db0-154">After `StatelessService.OnCloseAsync()` completes, hello service object is destructed</span></span>

## <a name="stateful-service-startup"></a><span data-ttu-id="24db0-155">Inicio de un servicio con estado</span><span class="sxs-lookup"><span data-stu-id="24db0-155">Stateful service Startup</span></span>
<span data-ttu-id="24db0-156">Servicios con estado tienen un servicios de toostateless de patrón similar, con unos pocos cambios.</span><span class="sxs-lookup"><span data-stu-id="24db0-156">Stateful services have a similar pattern toostateless services, with a few changes.</span></span> <span data-ttu-id="24db0-157">Al iniciarse un servicio con estado, orden de Hola de eventos es el siguiente:</span><span class="sxs-lookup"><span data-stu-id="24db0-157">When starting up a stateful service, hello order of events is as follows:</span></span>

1. <span data-ttu-id="24db0-158">Hola se construye servicio</span><span class="sxs-lookup"><span data-stu-id="24db0-158">hello Service is constructed</span></span>
2. <span data-ttu-id="24db0-159">Se llama a `StatefulServiceBase.OnOpenAsync()`.</span><span class="sxs-lookup"><span data-stu-id="24db0-159">`StatefulServiceBase.OnOpenAsync()` is called.</span></span> <span data-ttu-id="24db0-160">Esto se reemplaza uncommonly en servicio Hola.</span><span class="sxs-lookup"><span data-stu-id="24db0-160">This is uncommonly overridden in hello service.</span></span>
3. <span data-ttu-id="24db0-161">Hello ocurrirá lo siguiente en paralelo</span><span class="sxs-lookup"><span data-stu-id="24db0-161">hello following things happen in parallel</span></span>
    - <span data-ttu-id="24db0-162">Se invoca a `StatefulServiceBase.CreateServiceReplicaListeners()`.</span><span class="sxs-lookup"><span data-stu-id="24db0-162">`StatefulServiceBase.CreateServiceReplicaListeners()` is invoked</span></span> 
      - <span data-ttu-id="24db0-163">Si el servicio de hello es un elemento principal se abren todos los agentes de escucha devueltas.</span><span class="sxs-lookup"><span data-stu-id="24db0-163">If hello service is a Primary all returned listeners are Opened.</span></span> <span data-ttu-id="24db0-164">Se llama a `ICommunicationListener.OpenAsync()` en cada uno de los agentes de escucha.</span><span class="sxs-lookup"><span data-stu-id="24db0-164">`ICommunicationListener.OpenAsync()` is called on each listener.</span></span>
      - <span data-ttu-id="24db0-165">Si el servicio de hello es un elemento secundario, sólo los agentes de escucha marcan como `ListenOnSecondary = true` están abiertos.</span><span class="sxs-lookup"><span data-stu-id="24db0-165">If hello service is a Secondary, only those listeners marked as `ListenOnSecondary = true` are opened.</span></span> <span data-ttu-id="24db0-166">No es muy frecuente tener agentes de escucha abiertos en servicios secundarios.</span><span class="sxs-lookup"><span data-stu-id="24db0-166">Having listeners that are open on Secondaries is less common.</span></span>
    - <span data-ttu-id="24db0-167">Hola si Hola servicio actualmente es un servicio de hello principal, `StatefulServiceBase.RunAsync()` se llama al método</span><span class="sxs-lookup"><span data-stu-id="24db0-167">hello if hello Service is currently a Primary, hello service's `StatefulServiceBase.RunAsync()` method is called</span></span>
4. <span data-ttu-id="24db0-168">Una vez que todos Hola del agente de escucha de réplica `OpenAsync()` una llamada de finalización y `RunAsync()` se llama, `StatefulServiceBase.OnChangeRoleAsync()` se llama.</span><span class="sxs-lookup"><span data-stu-id="24db0-168">Once all hello replica listener's `OpenAsync()` calls complete and `RunAsync()` is called, `StatefulServiceBase.OnChangeRoleAsync()` is called.</span></span> <span data-ttu-id="24db0-169">Esto se reemplaza uncommonly en servicio Hola.</span><span class="sxs-lookup"><span data-stu-id="24db0-169">This is uncommonly overridden in hello service.</span></span>

<span data-ttu-id="24db0-170">Servicios de toostateless del mismo modo, no hay ningún coordinación entre el orden de hello en qué Hola agentes de escucha se crea y se abre y cuando se llama a Coredispatcher.</span><span class="sxs-lookup"><span data-stu-id="24db0-170">Similarly toostateless services, there's no coordination between hello order in which hello listeners are created and opened and when RunAsync is called.</span></span> <span data-ttu-id="24db0-171">Si necesita coordinación, soluciones de hello son mucho Hola mismo.</span><span class="sxs-lookup"><span data-stu-id="24db0-171">If you need coordination, hello solutions are much hello same.</span></span> <span data-ttu-id="24db0-172">Hay un caso adicional: decir que las llamadas de Hola que llegan a los agentes de escucha de comunicación de hello requieren información que se mantiene dentro de algunas [colecciones confiable](service-fabric-reliable-services-reliable-collections.md).</span><span class="sxs-lookup"><span data-stu-id="24db0-172">THere is one additional case: say that hello calls arriving at hello communication listeners require information kept inside some [Reliable Collections](service-fabric-reliable-services-reliable-collections.md).</span></span> <span data-ttu-id="24db0-173">Dado escuchas de comunicación de hello podrían abrir antes de colecciones confiable de hello son legibles o de escritura, y antes de que se puede iniciar Coredispatcher, algunos coordinación adicional es necesario.</span><span class="sxs-lookup"><span data-stu-id="24db0-173">Because hello communication listeners could open before hello reliable collections are readable or writeable, and before RunAsync could start, some additional coordination is necessary.</span></span> <span data-ttu-id="24db0-174">solución más sencilla y más común de Hello es para tooreturn de agentes de escucha de comunicación de hello algún código de error que Hola Hola solicitud de cliente utiliza tooknow tooretry.</span><span class="sxs-lookup"><span data-stu-id="24db0-174">hello simplest and most common solution is for hello communication listeners tooreturn some error code that hello client uses tooknow tooretry hello request.</span></span>

## <a name="stateful-service-shutdown"></a><span data-ttu-id="24db0-175">Cierre de un servicio con estado</span><span class="sxs-lookup"><span data-stu-id="24db0-175">Stateful service Shutdown</span></span>
<span data-ttu-id="24db0-176">De igual forma tooStateless services, eventos de ciclo de vida de Hola durante el cierre son Hola igual durante el inicio, pero invierten.</span><span class="sxs-lookup"><span data-stu-id="24db0-176">Similarly tooStateless services, hello lifecycle events during shutdown are hello same as during startup, but reversed.</span></span> <span data-ttu-id="24db0-177">Cuando un servicio con estado se está cerrando, hello ocurrirá lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="24db0-177">When a stateful service is being shut down, hello following events occur:</span></span>

1. <span data-ttu-id="24db0-178">En paralelo</span><span class="sxs-lookup"><span data-stu-id="24db0-178">In parallel</span></span>
    - <span data-ttu-id="24db0-179">Todos los agentes de escucha abiertos se cierran.</span><span class="sxs-lookup"><span data-stu-id="24db0-179">Any open listeners are Closed.</span></span> <span data-ttu-id="24db0-180">Se llama a `ICommunicationListener.CloseAsync()` en cada uno de los agentes de escucha.</span><span class="sxs-lookup"><span data-stu-id="24db0-180">`ICommunicationListener.CloseAsync()` is called on each listener.</span></span>
    - <span data-ttu-id="24db0-181">token de cancelación de Hello pasa demasiado`RunAsync()` se cancela.</span><span class="sxs-lookup"><span data-stu-id="24db0-181">hello cancellation token passed too`RunAsync()` is canceled.</span></span> <span data-ttu-id="24db0-182">Comprobando token de cancelación de hello `IsCancellationRequested` propiedad devuelve true y si se llama del token de hello `ThrowIfCancellationRequested` método inicie una excepción un `OperationCanceledException`.</span><span class="sxs-lookup"><span data-stu-id="24db0-182">Checking hello cancellation token's `IsCancellationRequested` property returns true, and if called hello token's `ThrowIfCancellationRequested` method throws an `OperationCanceledException`.</span></span>
2. <span data-ttu-id="24db0-183">Una vez `CloseAsync()` completa en cada agente de escucha y `RunAsync()` también completa, del servicio de hello `StatefulServiceBase.OnChangeRoleAsync()` se llama.</span><span class="sxs-lookup"><span data-stu-id="24db0-183">Once `CloseAsync()` completes on each listener and `RunAsync()` also completes, hello service's `StatefulServiceBase.OnChangeRoleAsync()` is called.</span></span> <span data-ttu-id="24db0-184">(Esto uncommonly se reemplaza en el servicio de hello).</span><span class="sxs-lookup"><span data-stu-id="24db0-184">(This is uncommonly overridden in hello service.)</span></span>
    - <span data-ttu-id="24db0-185">Esperando Coredispatcher toocomplete solo es necesario si esta réplica de servicio es un elemento principal.</span><span class="sxs-lookup"><span data-stu-id="24db0-185">Waiting for RunAsync toocomplete is only necessary if this service replica was a Primary.</span></span>
3. <span data-ttu-id="24db0-186">Una vez Hola `StatefulServiceBase.OnChangeRoleAsync()` método finaliza, hello `StatefulServiceBase.OnCloseAsync()` se llama al método.</span><span class="sxs-lookup"><span data-stu-id="24db0-186">Once hello `StatefulServiceBase.OnChangeRoleAsync()` method completes, hello `StatefulServiceBase.OnCloseAsync()` method is called.</span></span> <span data-ttu-id="24db0-187">Esta invalidación es poco habitual, pero está disponible.</span><span class="sxs-lookup"><span data-stu-id="24db0-187">This is an uncommon override, but it is available.</span></span>
3. <span data-ttu-id="24db0-188">Después de `StatefulServiceBase.OnCloseAsync()` completa, se destruye el objeto de servicio de Hola.</span><span class="sxs-lookup"><span data-stu-id="24db0-188">After `StatefulServiceBase.OnCloseAsync()` completes, hello service object is destructed.</span></span>

## <a name="stateful-service-primary-swaps"></a><span data-ttu-id="24db0-189">Intercambios de servicios con estado principales</span><span class="sxs-lookup"><span data-stu-id="24db0-189">Stateful service primary swaps</span></span>
<span data-ttu-id="24db0-190">Mientras se ejecuta un servicio con estado, sólo hello las réplicas principales de que los servicios con estado tienen sus agentes de escucha de comunicación abiertos y su método Coredispatcher llamado.</span><span class="sxs-lookup"><span data-stu-id="24db0-190">While a stateful service is running, only hello Primary replicas of that stateful services have their communication listeners opened and their RunAsync method called.</span></span> <span data-ttu-id="24db0-191">Los secundarios se construyen, pero no reciben más llamadas.</span><span class="sxs-lookup"><span data-stu-id="24db0-191">Secondary are constructed but see no further calls.</span></span> <span data-ttu-id="24db0-192">Mientras un servicio con estado se ejecuta sin embargo, pueden cambiar qué réplica actualmente es hello principal.</span><span class="sxs-lookup"><span data-stu-id="24db0-192">While a stateful service is running however, which replica is currently hello Primary can change.</span></span> <span data-ttu-id="24db0-193">¿Qué significa esto en términos de los eventos de ciclo de vida de Hola que puede ver una réplica? Hola comportamiento Hola réplica con estado ve depende de si es réplica Hola se degradan o promueve durante el intercambio de Hola.</span><span class="sxs-lookup"><span data-stu-id="24db0-193">What does this mean in terms of hello lifecycle events that a replica can see? hello behavior hello stateful replica sees depends on whether it is hello replica being demoted or promoted during hello swap.</span></span>

### <a name="for-hello-primary-being-demoted"></a><span data-ttu-id="24db0-194">Que se degradan para hello principal</span><span class="sxs-lookup"><span data-stu-id="24db0-194">For hello primary being demoted</span></span>
<span data-ttu-id="24db0-195">Tejido de servicio necesita esta toostop réplica procesar mensajes y salga de cualquier trabajo en segundo plano que esté realizando.</span><span class="sxs-lookup"><span data-stu-id="24db0-195">Service Fabric needs this replica toostop processing messages and quit any background work it is doing.</span></span> <span data-ttu-id="24db0-196">Como resultado, este servicio paso parece similar toowhen Hola se está cerrando.</span><span class="sxs-lookup"><span data-stu-id="24db0-196">As a result, this step looks similar toowhen hello service is being shut down.</span></span> <span data-ttu-id="24db0-197">Una diferencia es que hello servicio no destruye o se cierra puesto que permanece como un elemento secundario.</span><span class="sxs-lookup"><span data-stu-id="24db0-197">One difference is that hello Service isn't destructed or closed since it remains as a Secondary.</span></span> <span data-ttu-id="24db0-198">se llama después de las API de Hola:</span><span class="sxs-lookup"><span data-stu-id="24db0-198">hello following APIs are called:</span></span>

1. <span data-ttu-id="24db0-199">En paralelo</span><span class="sxs-lookup"><span data-stu-id="24db0-199">In parallel</span></span>
    - <span data-ttu-id="24db0-200">Todos los agentes de escucha abiertos se cierran.</span><span class="sxs-lookup"><span data-stu-id="24db0-200">Any open listeners are Closed.</span></span> <span data-ttu-id="24db0-201">Se llama a `ICommunicationListener.CloseAsync()` en cada uno de los agentes de escucha.</span><span class="sxs-lookup"><span data-stu-id="24db0-201">`ICommunicationListener.CloseAsync()` is called on each listener.</span></span>
    - <span data-ttu-id="24db0-202">token de cancelación de Hello pasa demasiado`RunAsync()` se cancela.</span><span class="sxs-lookup"><span data-stu-id="24db0-202">hello cancellation token passed too`RunAsync()` is canceled.</span></span> <span data-ttu-id="24db0-203">Comprobando token de cancelación de hello `IsCancellationRequested` propiedad devuelve true y si se llama del token de hello `ThrowIfCancellationRequested` método inicie una excepción un `OperationCanceledException`.</span><span class="sxs-lookup"><span data-stu-id="24db0-203">Checking hello cancellation token's `IsCancellationRequested` property returns true, and if called hello token's `ThrowIfCancellationRequested` method throws an `OperationCanceledException`.</span></span>
2. <span data-ttu-id="24db0-204">Una vez `CloseAsync()` completa en cada agente de escucha y `RunAsync()` también completa, del servicio de hello `StatefulServiceBase.OnChangeRoleAsync()` se llama.</span><span class="sxs-lookup"><span data-stu-id="24db0-204">Once `CloseAsync()` completes on each listener and `RunAsync()` also completes, hello service's `StatefulServiceBase.OnChangeRoleAsync()` is called.</span></span> <span data-ttu-id="24db0-205">Esto se reemplaza uncommonly en servicio Hola.</span><span class="sxs-lookup"><span data-stu-id="24db0-205">This is uncommonly overridden in hello service.</span></span>

### <a name="for-hello-secondary-being-promoted"></a><span data-ttu-id="24db0-206">Promocionado para hello secundaria</span><span class="sxs-lookup"><span data-stu-id="24db0-206">For hello secondary being promoted</span></span>
<span data-ttu-id="24db0-207">De forma similar, Service Fabric necesita este toostart réplica realiza escuchas de mensajes en el cable de Hola e iniciar las tareas en segundo plano se ocupa de sobre.</span><span class="sxs-lookup"><span data-stu-id="24db0-207">Similarly, Service Fabric needs this replica toostart listening for messages on hello wire and start any background tasks it cares about.</span></span> <span data-ttu-id="24db0-208">Como resultado, este aspecto del proceso se crea el servicio de hello toowhen similar, salvo que la réplica Hola propio ya existe.</span><span class="sxs-lookup"><span data-stu-id="24db0-208">As a result, this process looks similar toowhen hello service is created, except that hello replica itself already exists.</span></span> <span data-ttu-id="24db0-209">se llama después de las API de Hola:</span><span class="sxs-lookup"><span data-stu-id="24db0-209">hello following APIs are called:</span></span>

1. <span data-ttu-id="24db0-210">En paralelo</span><span class="sxs-lookup"><span data-stu-id="24db0-210">In parallel</span></span>
    - <span data-ttu-id="24db0-211">Se invoca `StatefulServiceBase.CreateServiceReplicaListeners()` y se abren los agentes de escucha devueltos.</span><span class="sxs-lookup"><span data-stu-id="24db0-211">`StatefulServiceBase.CreateServiceReplicaListeners()` is invoked and any returned listeners are Opened.</span></span> <span data-ttu-id="24db0-212">Se llama a `ICommunicationListener.OpenAsync()` en cada uno de los agentes de escucha.</span><span class="sxs-lookup"><span data-stu-id="24db0-212">`ICommunicationListener.OpenAsync()` is called on each listener.</span></span>
    - <span data-ttu-id="24db0-213">Hola del servicio `StatefulServiceBase.RunAsync()` se llama al método</span><span class="sxs-lookup"><span data-stu-id="24db0-213">hello service's `StatefulServiceBase.RunAsync()` method is called</span></span>
2. <span data-ttu-id="24db0-214">Una vez que todos Hola del agente de escucha de réplica `OpenAsync()` una llamada de finalización y `RunAsync()` se ha llamado `StatefulServiceBase.OnChangeRoleAsync()` se llama.</span><span class="sxs-lookup"><span data-stu-id="24db0-214">Once all hello replica listener's `OpenAsync()` calls complete and `RunAsync()` has been called,  `StatefulServiceBase.OnChangeRoleAsync()` is called.</span></span> <span data-ttu-id="24db0-215">Esto se reemplaza uncommonly en servicio Hola.</span><span class="sxs-lookup"><span data-stu-id="24db0-215">This is uncommonly overridden in hello service.</span></span>

### <a name="common-issues-during-stateful-service-shutdown-and-primary-demotion"></a><span data-ttu-id="24db0-216">Problemas habituales durante la degradación de la categoría principal y el cierre de un servicio con estado</span><span class="sxs-lookup"><span data-stu-id="24db0-216">Common issues during stateful service shutdown and primary demotion</span></span>
<span data-ttu-id="24db0-217">Cambios de Service Fabric Hola principal de un servicio con estado para una variedad de motivos.</span><span class="sxs-lookup"><span data-stu-id="24db0-217">Service Fabric changes hello Primary of a stateful service for a variety of reasons.</span></span> <span data-ttu-id="24db0-218">Hello más comunes son [clúster reequilibrio](service-fabric-cluster-resource-manager-balancing.md) y [actualización de la aplicación](service-fabric-application-upgrade.md).</span><span class="sxs-lookup"><span data-stu-id="24db0-218">hello most common are [cluster rebalancing](service-fabric-cluster-resource-manager-balancing.md) and [application upgrade](service-fabric-application-upgrade.md).</span></span> <span data-ttu-id="24db0-219">Durante estas operaciones (así como durante el cierre del servicio normal, como vería si se eliminó el servicio de hello), es importante que Hola Hola de respeto de servicio `CancellationToken`.</span><span class="sxs-lookup"><span data-stu-id="24db0-219">During these operations (as well as during normal service shutdown, like you'd see if hello service was deleted), it is important that hello service respect hello `CancellationToken`.</span></span> <span data-ttu-id="24db0-220">Los servicios que no administren correctamente la cancelación experimentarán errores.</span><span class="sxs-lookup"><span data-stu-id="24db0-220">Services that do not handle cancellation cleanly will experience several issues.</span></span> <span data-ttu-id="24db0-221">En concreto, estas operaciones será lentas desde Service Fabric espera Hola servicios toostop correctamente.</span><span class="sxs-lookup"><span data-stu-id="24db0-221">In particular, these operations will be slow since Service Fabric waits for hello services toostop gracefully.</span></span> <span data-ttu-id="24db0-222">En última instancia, esto puede provocar actualizaciones toofailed ese tiempo de espera y revertir.</span><span class="sxs-lookup"><span data-stu-id="24db0-222">This can ultimately lead toofailed upgrades that time out and roll back.</span></span> <span data-ttu-id="24db0-223">Token de cancelación de error toohonor Hola también puede producir desequilibrados clústeres porque nodos obtener acceso rápidos pero no se volverán a equilibrar servicios Hola puesto que tarda demasiado toomove ellos en otro lugar.</span><span class="sxs-lookup"><span data-stu-id="24db0-223">Failure toohonor hello cancellation token can also cause imbalanced clusters because nodes get hot but hello services can't be rebalanced since it takes too long toomove them elsewhere.</span></span> 

<span data-ttu-id="24db0-224">Puesto que Servicios de hello están activo, también es probable que estén usando hello [colecciones confiable](service-fabric-reliable-services-reliable-collections.md).</span><span class="sxs-lookup"><span data-stu-id="24db0-224">Since hello services are stateful, it is also likely that they are using hello [Reliable Collections](service-fabric-reliable-services-reliable-collections.md).</span></span> <span data-ttu-id="24db0-225">En Service Fabric, cuando se degrada principal, uno de hello lo que ocurre es que el estado de acceso de escritura toohello subyacente se ha revocado.</span><span class="sxs-lookup"><span data-stu-id="24db0-225">In Service Fabric, when a Primary is demoted, one of hello first things that happens is that write access toohello underlying state is revoked.</span></span> <span data-ttu-id="24db0-226">Esto conduce tooa segundo conjunto de problemas que pueden afectar el ciclo de vida de servicio de Hola.</span><span class="sxs-lookup"><span data-stu-id="24db0-226">This leads tooa second set of issues that can impact hello service lifecycle.</span></span> <span data-ttu-id="24db0-227">colecciones de Hello devueltos excepciones basadas en tiempo de Hola y si se ha movido réplica Hola o apagado.</span><span class="sxs-lookup"><span data-stu-id="24db0-227">hello collections return Exceptions based on hello timing and whether hello replica is being moved or shut down.</span></span> <span data-ttu-id="24db0-228">Estas excepciones deberían administrarse correctamente.</span><span class="sxs-lookup"><span data-stu-id="24db0-228">These exceptions should be handled correctly.</span></span> <span data-ttu-id="24db0-229">Las excepciones iniciadas por Service Fabric pueden corresponder a dos categorías: permanentes [(`FabricException`)](https://docs.microsoft.com/en-us/dotnet/api/system.fabric.fabricexception?view=azure-dotnet) y transitorias [(`FabricTransientException`)](https://docs.microsoft.com/en-us/dotnet/api/system.fabric.fabrictransientexception?view=azure-dotnet).</span><span class="sxs-lookup"><span data-stu-id="24db0-229">Exceptions thrown by Service Fabric fall into permanent [(`FabricException`)](https://docs.microsoft.com/en-us/dotnet/api/system.fabric.fabricexception?view=azure-dotnet) and transient [(`FabricTransientException`)](https://docs.microsoft.com/en-us/dotnet/api/system.fabric.fabrictransientexception?view=azure-dotnet) categories.</span></span> <span data-ttu-id="24db0-230">Excepciones permanentes deben registrarse y produzca, mientras que las excepciones transitorias de Hola se pueden reintentar basado en alguna lógica de reintento.</span><span class="sxs-lookup"><span data-stu-id="24db0-230">Permanent exceptions should be logged and thrown, while hello transient exceptions may be retried based on some retry logic.</span></span>

<span data-ttu-id="24db0-231">Control de excepciones de Hola que proceden de uso de hello `ReliableCollections` junto con eventos de ciclo de vida de servicio es una parte importante de prueba y validación de un servicio confiable.</span><span class="sxs-lookup"><span data-stu-id="24db0-231">Handling hello exceptions that come from use of hello `ReliableCollections` in conjunction with service lifecycle events is an important part of testing and validating a Reliable Service.</span></span> <span data-ttu-id="24db0-232">Hola recomendación es el servicio bajo una carga de siempre toorun al realizar actualizaciones y [chaos pruebas](service-fabric-controlled-chaos.md) antes de implementar alguna vez tooproduction.</span><span class="sxs-lookup"><span data-stu-id="24db0-232">hello recommendation is always toorun your service under load while performing upgrades and [chaos testing](service-fabric-controlled-chaos.md) before ever deploying tooproduction.</span></span> <span data-ttu-id="24db0-233">Estos pasos básicos ayudan a garantizar que el servicio está implementado correctamente y puede administrar los eventos del ciclo de vida correctamente.</span><span class="sxs-lookup"><span data-stu-id="24db0-233">These basic steps help ensure that your service is correctly implemented and handles lifecycle events correctly.</span></span>


## <a name="notes-on-service-lifecycle"></a><span data-ttu-id="24db0-234">Notas sobre el ciclo de vida del servicio</span><span class="sxs-lookup"><span data-stu-id="24db0-234">Notes on service lifecycle</span></span>
  - <span data-ttu-id="24db0-235">Ambos hello `RunAsync()` hello y método `CreateServiceReplicaListeners/CreateServiceInstanceListeners` llamadas son opcionales.</span><span class="sxs-lookup"><span data-stu-id="24db0-235">Both hello `RunAsync()` method and hello `CreateServiceReplicaListeners/CreateServiceInstanceListeners` calls are optional.</span></span> <span data-ttu-id="24db0-236">Un servicio puede tener uno, ambos o ninguno.</span><span class="sxs-lookup"><span data-stu-id="24db0-236">A service may have one of them, both, or neither.</span></span> <span data-ttu-id="24db0-237">Por ejemplo, si servicio Hola hace todo el trabajo en las llamadas de toouser de respuesta, no es necesario para el mismo tooimplement `RunAsync()`.</span><span class="sxs-lookup"><span data-stu-id="24db0-237">For example, if hello service does all its work in response toouser calls, there is no need for it tooimplement `RunAsync()`.</span></span> <span data-ttu-id="24db0-238">Es necesario solo escuchas de comunicación de Hola y su código asociado.</span><span class="sxs-lookup"><span data-stu-id="24db0-238">Only hello communication listeners and their associated code are necessary.</span></span> <span data-ttu-id="24db0-239">Del mismo modo, crear y devolver los agentes de escucha de comunicación es opcional, como servicio de hello puede tener solo fondo toodo de trabajo y por lo que solo necesita tooimplement`RunAsync()`</span><span class="sxs-lookup"><span data-stu-id="24db0-239">Similarly, creating and returning communication listeners is optional, as hello service may have only background work toodo, and so only needs tooimplement `RunAsync()`</span></span>
  - <span data-ttu-id="24db0-240">Es válido para un servicio toocomplete `RunAsync()` correctamente y vuelva a partir de él.</span><span class="sxs-lookup"><span data-stu-id="24db0-240">It is valid for a service toocomplete `RunAsync()` successfully and return from it.</span></span> <span data-ttu-id="24db0-241">La finalización no es una condición de error.</span><span class="sxs-lookup"><span data-stu-id="24db0-241">Completing is not a failure condition.</span></span> <span data-ttu-id="24db0-242">Completar `RunAsync()` indica que ha finalizado el trabajo en segundo plano del servicio de Hola Hola.</span><span class="sxs-lookup"><span data-stu-id="24db0-242">Completing `RunAsync()` indicates that hello background work of hello service has completed.</span></span> <span data-ttu-id="24db0-243">Para los servicios de confianza con estado, `RunAsync()` se llama de nuevo si la réplica de Hola se degrada de tooSecondary principal y, a continuación, promocionar tooPrimary atrás.</span><span class="sxs-lookup"><span data-stu-id="24db0-243">For stateful reliable services, `RunAsync()` is called again if hello replica were demoted from Primary tooSecondary and then promoted back tooPrimary.</span></span>
  - <span data-ttu-id="24db0-244">Si un servicio sale de `RunAsync()` iniciando una excepción inesperada, se considera un error.</span><span class="sxs-lookup"><span data-stu-id="24db0-244">If a service exits from `RunAsync()` by throwing some unexpected exception, this constitutes a failure.</span></span> <span data-ttu-id="24db0-245">se cierra el objeto de servicio de Hola y notifica un error de estado.</span><span class="sxs-lookup"><span data-stu-id="24db0-245">hello service object is shut down and a health error reported.</span></span>
  - <span data-ttu-id="24db0-246">Aunque no hay ningún límite de tiempo en la devolución de estos métodos, que inmediatamente pierda Hola capacidad toowrite tooReliable colecciones y, por tanto, no puede completar cualquier trabajo real.</span><span class="sxs-lookup"><span data-stu-id="24db0-246">While there is no time limit on returning from these methods, you immediately lose hello ability toowrite tooReliable Collections and therefore cannot complete any real work.</span></span> <span data-ttu-id="24db0-247">Se recomienda que vuelva tan pronto como sea posible tras la recepción de solicitud de cancelación de Hola.</span><span class="sxs-lookup"><span data-stu-id="24db0-247">It is recommended that you return as quickly as possible upon receiving hello cancellation request.</span></span> <span data-ttu-id="24db0-248">Si el servicio no responde toothese API llamadas en un período razonable de tiempo que Service Fabric forzosamente puede finalizar su servicio.</span><span class="sxs-lookup"><span data-stu-id="24db0-248">If your service does not respond toothese API calls in a reasonable amount of time Service Fabric may forcibly terminate your service.</span></span> <span data-ttu-id="24db0-249">Esto solo suele pasar durante las actualizaciones de aplicación o cuando se elimina un servicio.</span><span class="sxs-lookup"><span data-stu-id="24db0-249">Usually this only happens during application upgrades or when a service is being deleted.</span></span> <span data-ttu-id="24db0-250">Este tiempo de espera es de 15 minutos de manera predeterminada.</span><span class="sxs-lookup"><span data-stu-id="24db0-250">This timeout is 15 minutes by default.</span></span>
  - <span data-ttu-id="24db0-251">Errores en hello `OnCloseAsync()` resultado de la ruta de acceso en `OnAbort()` que se la llame que es una oportunidad de mejor esfuerzo de última oportunidad para hello servicio tooclean seguridad y liberar cualquier recurso que ha solicitado.</span><span class="sxs-lookup"><span data-stu-id="24db0-251">Failures in hello `OnCloseAsync()` path result in `OnAbort()` being called which is a last-chance best-effort opportunity for hello service tooclean up and release any resources that they have claimed.</span></span>

## <a name="next-steps"></a><span data-ttu-id="24db0-252">Pasos siguientes</span><span class="sxs-lookup"><span data-stu-id="24db0-252">Next steps</span></span>
- [<span data-ttu-id="24db0-253">Servicios de tooReliable de introducción</span><span class="sxs-lookup"><span data-stu-id="24db0-253">Introduction tooReliable Services</span></span>](service-fabric-reliable-services-introduction.md)
- [<span data-ttu-id="24db0-254">Introducción a Reliable Services de Service Fabric de Microsoft Azure</span><span class="sxs-lookup"><span data-stu-id="24db0-254">Reliable Services quick start</span></span>](service-fabric-reliable-services-quick-start.md)
- [<span data-ttu-id="24db0-255">Uso avanzado de Reliable Services</span><span class="sxs-lookup"><span data-stu-id="24db0-255">Reliable Services advanced usage</span></span>](service-fabric-reliable-services-advanced-usage.md)
