---
title: "aaaService tejido de copia de seguridad y restauración | Documentos de Microsoft"
description: "Documentación conceptual para la copia de seguridad y la restauración de Service Fabric"
services: service-fabric
documentationcenter: .net
author: mcoskun
manager: timlt
editor: subramar,jessebenson
ms.assetid: 91ea6ca4-cc2a-4155-9823-dcbd0b996349
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 08/18/2017
ms.author: mcoskun
ms.openlocfilehash: e502b59c84999c3fe825167383f00a5ebd70c9b5
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 10/06/2017
---
# <a name="back-up-and-restore-reliable-services-and-reliable-actors"></a><span data-ttu-id="22a8c-103">Copia de seguridad y restauración de Reliable Services y Reliable Actors</span><span class="sxs-lookup"><span data-stu-id="22a8c-103">Back up and restore Reliable Services and Reliable Actors</span></span>
<span data-ttu-id="22a8c-104">Azure Service Fabric es una plataforma de alta disponibilidad que se replica estado hello toomaintain de varios nodos esta alta disponibilidad.</span><span class="sxs-lookup"><span data-stu-id="22a8c-104">Azure Service Fabric is a high-availability platform that replicates hello state across multiple nodes toomaintain this high availability.</span></span>  <span data-ttu-id="22a8c-105">Por lo tanto, incluso si se produce un error en un nodo del clúster de hello, servicios de hello continúan toobe disponible.</span><span class="sxs-lookup"><span data-stu-id="22a8c-105">Thus, even if one node in hello cluster fails, hello services continue toobe available.</span></span> <span data-ttu-id="22a8c-106">Aunque esta redundancia integrada proporcionada por la plataforma de hello puede ser suficiente para algunos, en algunos casos es deseable para hello servicio tooback los datos (tooan almacén externo).</span><span class="sxs-lookup"><span data-stu-id="22a8c-106">While this in-built redundancy provided by hello platform may be sufficient for some, in certain cases it is desirable for hello service tooback up data (tooan external store).</span></span>

> [!NOTE]
> <span data-ttu-id="22a8c-107">Es fundamental toobackup y restaure los datos (y la prueba que funciona según lo previsto) por lo que es posible recuperarse de los escenarios de pérdida de datos.</span><span class="sxs-lookup"><span data-stu-id="22a8c-107">It is critical toobackup and restore your data (and test that it works as expected) so you can recover from data loss scenarios.</span></span>
> 
> 

<span data-ttu-id="22a8c-108">Por ejemplo, un servicio que desee tooback datos en orden tooprotect de hello los escenarios siguientes:</span><span class="sxs-lookup"><span data-stu-id="22a8c-108">For example, a service may want tooback up data in order tooprotect from hello following scenarios:</span></span>

- <span data-ttu-id="22a8c-109">En caso de hello de pérdida permanente de Hola de todo un clúster de Service Fabric.</span><span class="sxs-lookup"><span data-stu-id="22a8c-109">In hello event of hello permanent loss of an entire Service Fabric cluster.</span></span>
- <span data-ttu-id="22a8c-110">Pérdida permanente de una mayoría de las réplicas de Hola de una partición de servicio</span><span class="sxs-lookup"><span data-stu-id="22a8c-110">Permanent loss of a majority of hello replicas of a service partition</span></span>
- <span data-ttu-id="22a8c-111">Errores administrativos mediante el cual Hola estado accidentalmente obtiene eliminado o dañado.</span><span class="sxs-lookup"><span data-stu-id="22a8c-111">Administrative errors whereby hello state accidentally gets deleted or corrupted.</span></span> <span data-ttu-id="22a8c-112">Por ejemplo, esto puede ocurrir si un administrador con suficientes privilegios erróneamente elimina el servicio de Hola.</span><span class="sxs-lookup"><span data-stu-id="22a8c-112">For example, this may happen if an administrator with sufficient privilege erroneously deletes hello service.</span></span>
- <span data-ttu-id="22a8c-113">Errores en el servicio de Hola que provocan daños en los datos.</span><span class="sxs-lookup"><span data-stu-id="22a8c-113">Bugs in hello service that cause data corruption.</span></span> <span data-ttu-id="22a8c-114">Por ejemplo, esto puede ocurrir cuando una actualización de código de servicio comienza a escribir datos defectuoso tooa colección confiable.</span><span class="sxs-lookup"><span data-stu-id="22a8c-114">For example, this may happen when a service code upgrade starts writing faulty data tooa Reliable Collection.</span></span> <span data-ttu-id="22a8c-115">En tal caso, ambos Hola código y datos de hello pueden tener toobe revertir tooan estado anterior.</span><span class="sxs-lookup"><span data-stu-id="22a8c-115">In such a case, both hello code and hello data may have toobe reverted tooan earlier state.</span></span>
- <span data-ttu-id="22a8c-116">Procesamiento de datos sin conexión.</span><span class="sxs-lookup"><span data-stu-id="22a8c-116">Offline data processing.</span></span> <span data-ttu-id="22a8c-117">Podría ser conveniente toohave procesamiento sin conexión de datos de business intelligence que se produce por separado del servicio de Hola que genera datos de Hola.</span><span class="sxs-lookup"><span data-stu-id="22a8c-117">It might be convenient toohave offline processing of data for business intelligence that happens separately from hello service that generates hello data.</span></span>

<span data-ttu-id="22a8c-118">la característica de copia de seguridad y restauración de Hello permite servicios integrados en hello confiable API de servicios toocreate y restaurar las copias de seguridad.</span><span class="sxs-lookup"><span data-stu-id="22a8c-118">hello Backup/Restore feature allows services built on hello Reliable Services API toocreate and restore backups.</span></span> <span data-ttu-id="22a8c-119">Hello las API de copia de seguridad proporcionadas por plataforma de hello permiten backup(s) del estado de la partición de servicio, sin bloqueo operaciones de lectura o escritura.</span><span class="sxs-lookup"><span data-stu-id="22a8c-119">hello backup APIs provided by hello platform allow backup(s) of a service partition's state, without blocking read or write operations.</span></span> <span data-ttu-id="22a8c-120">Hola restauración que API permiten toobe de estado de la partición de servicio restaurado a partir de una copia de seguridad seleccionado.</span><span class="sxs-lookup"><span data-stu-id="22a8c-120">hello restore APIs allow a service partition's state toobe restored from a chosen backup.</span></span>

## <a name="types-of-backup"></a><span data-ttu-id="22a8c-121">Tipos de copia de seguridad</span><span class="sxs-lookup"><span data-stu-id="22a8c-121">Types of Backup</span></span>
<span data-ttu-id="22a8c-122">Hay dos opciones de copia de seguridad: completa e incremental.</span><span class="sxs-lookup"><span data-stu-id="22a8c-122">There are two backup options: Full and Incremental.</span></span>
<span data-ttu-id="22a8c-123">Una copia de seguridad completa es una copia de seguridad que contiene todos los Hola datos necesarios toorecreate Hola estado de réplica de hello: puntos de control y todos los registros.</span><span class="sxs-lookup"><span data-stu-id="22a8c-123">A full backup is a backup that contains all hello data required toorecreate hello state of hello replica: checkpoints and all log records.</span></span>
<span data-ttu-id="22a8c-124">Porque tiene puntos de control de Hola y de registro de hello, se puede restaurar una copia de seguridad completa por sí mismo.</span><span class="sxs-lookup"><span data-stu-id="22a8c-124">Since it has hello checkpoints and hello log, a full backup can be restored by itself.</span></span>

<span data-ttu-id="22a8c-125">problema de Hello con copias de seguridad completas se produce cuando los puntos de control de hello son grandes.</span><span class="sxs-lookup"><span data-stu-id="22a8c-125">hello problem with full backups arises when hello checkpoints are large.</span></span>
<span data-ttu-id="22a8c-126">Por ejemplo, una réplica que tiene 16 GB de estado tendrá puntos de comprobación que suman aproximadamente too16 GB.</span><span class="sxs-lookup"><span data-stu-id="22a8c-126">For example, a replica that has 16 GB of state will have checkpoints that add up approximately too16 GB.</span></span>
<span data-ttu-id="22a8c-127">Si tiene un objetivo de punto de recuperación de cinco minutos, la réplica de hello necesita toobe copia de seguridad cada cinco minutos.</span><span class="sxs-lookup"><span data-stu-id="22a8c-127">If we have a Recovery Point Objective of five minutes, hello replica needs toobe backed up every five minutes.</span></span>
<span data-ttu-id="22a8c-128">Cada vez que se hace la copia debe toocopy 16 GB de puntos de control además too50 MB (configurables usando `CheckpointThresholdInMB`) correspondientes a los registros.</span><span class="sxs-lookup"><span data-stu-id="22a8c-128">Each time it backs up it needs toocopy 16 GB of checkpoints in addition too50 MB (configurable using `CheckpointThresholdInMB`) worth of logs.</span></span>

![Ejemplo de copia de seguridad completa.](media/service-fabric-reliable-services-backup-restore/FullBackupExample.PNG)

<span data-ttu-id="22a8c-130">problema de Hello solución toothis es copias de seguridad incrementales, que copia de seguridad solo contiene entradas de registro de hello cambiado desde la última copia de seguridad de Hola.</span><span class="sxs-lookup"><span data-stu-id="22a8c-130">hello solution toothis problem is incremental backups, where backup only contains hello changed log records since hello last backup.</span></span>

![Ejemplo de copia de seguridad incremental.](media/service-fabric-reliable-services-backup-restore/IncrementalBackupExample.PNG)

<span data-ttu-id="22a8c-132">Dado que copias de seguridad incrementales son los únicos cambios desde Hola última copia de seguridad (no se incluyen los puntos de control de hello), suelen toobe más rápido pero no se pueden restaurar por sí solas.</span><span class="sxs-lookup"><span data-stu-id="22a8c-132">Since incremental backups are only changes since hello last backup (does not include hello checkpoints), they tend toobe faster but they cannot be restored on their own.</span></span>
<span data-ttu-id="22a8c-133">toorestore una copia de seguridad incremental, la cadena de copia de seguridad completa de hello es necesario.</span><span class="sxs-lookup"><span data-stu-id="22a8c-133">toorestore an incremental backup, hello entire backup chain is required.</span></span>
<span data-ttu-id="22a8c-134">Una cadena de copia de seguridad empieza por una copia de seguridad completa a la que sigue un número contiguo de copias de seguridad incrementales.</span><span class="sxs-lookup"><span data-stu-id="22a8c-134">A backup chain is a chain of backups starting with a full backup and followed by a number of contiguous incremental backups.</span></span>

## <a name="backup-reliable-services"></a><span data-ttu-id="22a8c-135">Copias de seguridad de Reliable Services</span><span class="sxs-lookup"><span data-stu-id="22a8c-135">Backup Reliable Services</span></span>
<span data-ttu-id="22a8c-136">autor del servicio Hello tenga control total sobre cuándo las copias de seguridad de toomake y donde se almacenarán las copias de seguridad.</span><span class="sxs-lookup"><span data-stu-id="22a8c-136">hello service author has full control of when toomake backups and where backups will be stored.</span></span>

<span data-ttu-id="22a8c-137">toostart una copia de seguridad, el servicio de hello necesita tooinvoke Hola heredarse miembro función `BackupAsync`.</span><span class="sxs-lookup"><span data-stu-id="22a8c-137">toostart a backup, hello service needs tooinvoke hello inherited member function `BackupAsync`.</span></span>  
<span data-ttu-id="22a8c-138">Las copias de seguridad pueden realizarse únicamente desde las réplicas principales y requieren toobe de estado de escritura concedido.</span><span class="sxs-lookup"><span data-stu-id="22a8c-138">Backups can be made only from primary replicas, and they require write status toobe granted.</span></span>

<span data-ttu-id="22a8c-139">Tal y como se muestra a continuación, `BackupAsync` toma una `BackupDescription` objeto, donde uno puede especificar una copia de seguridad completa o incremental, así como una función de devolución de llamada, `Func<< BackupInfo, CancellationToken, Task<bool>>>` que se invoca cuando la carpeta de copia de seguridad de Hola se ha creado localmente y está listo toobe ha sacado toosome almacenamiento externo.</span><span class="sxs-lookup"><span data-stu-id="22a8c-139">As shown below, `BackupAsync` takes in a `BackupDescription` object, where one can specify a full or incremental backup, as well as a callback function, `Func<< BackupInfo, CancellationToken, Task<bool>>>` that is invoked when hello backup folder has been created locally and is ready toobe moved out toosome external storage.</span></span>

```csharp

BackupDescription myBackupDescription = new BackupDescription(backupOption.Incremental,this.BackupCallbackAsync);

await this.BackupAsync(myBackupDescription);

```

<span data-ttu-id="22a8c-140">Tootake de solicitud de una copia de seguridad incremental se puede producir un `FabricMissingFullBackupException`.</span><span class="sxs-lookup"><span data-stu-id="22a8c-140">Request tootake an incremental backup can fail with `FabricMissingFullBackupException`.</span></span> <span data-ttu-id="22a8c-141">Esta excepción indica que se está realizando uno de hello siguientes cosas:</span><span class="sxs-lookup"><span data-stu-id="22a8c-141">This exception indicates that one of hello following things is happening:</span></span>

- <span data-ttu-id="22a8c-142">réplica de Hello nunca ha tomado una copia de seguridad completa porque se ha convertido en principal,</span><span class="sxs-lookup"><span data-stu-id="22a8c-142">hello replica has never taken a full backup since it has become primary,</span></span>
- <span data-ttu-id="22a8c-143">algunos de hello las entradas de registro porque se ha truncado la última copia de seguridad de Hola o</span><span class="sxs-lookup"><span data-stu-id="22a8c-143">some of hello log records since hello last backup has been truncated or</span></span>
- <span data-ttu-id="22a8c-144">réplica pasado hello `MaxAccumulatedBackupLogSizeInMB` límite.</span><span class="sxs-lookup"><span data-stu-id="22a8c-144">replica passed hello `MaxAccumulatedBackupLogSizeInMB` limit.</span></span>

<span data-ttu-id="22a8c-145">Los usuarios pueden aumentar la probabilidad de Hola de ser capaz de toodo copias de seguridad incrementales configurando `MinLogSizeInMB` o `TruncationThresholdFactor`.</span><span class="sxs-lookup"><span data-stu-id="22a8c-145">Users can increase hello likelihood of being able toodo incremental backups by configuring `MinLogSizeInMB` or `TruncationThresholdFactor`.</span></span>
<span data-ttu-id="22a8c-146">Tenga en cuenta que estos valores si aumenta Hola por el uso del disco de réplica.</span><span class="sxs-lookup"><span data-stu-id="22a8c-146">Note that increasing these values increases hello per replica disk usage.</span></span>
<span data-ttu-id="22a8c-147">Para obtener más información, consulte el artículo de [configuración de Reliable Services](service-fabric-reliable-services-configuration.md).</span><span class="sxs-lookup"><span data-stu-id="22a8c-147">For more information, see [Reliable Services Configuration](service-fabric-reliable-services-configuration.md)</span></span>

<span data-ttu-id="22a8c-148">`BackupInfo`Proporciona información relativa a la copia de seguridad de hello, incluida la ubicación de Hola de carpeta Hola donde hello en tiempo de ejecución guarda la copia de seguridad de hello (`BackupInfo.Directory`).</span><span class="sxs-lookup"><span data-stu-id="22a8c-148">`BackupInfo` provides information regarding hello backup, including hello location of hello folder where hello runtime saved hello backup (`BackupInfo.Directory`).</span></span> <span data-ttu-id="22a8c-149">función de devolución de llamada de Hello puede mover hello `BackupInfo.Directory` tooan almacén externo u otra ubicación.</span><span class="sxs-lookup"><span data-stu-id="22a8c-149">hello callback function can move hello `BackupInfo.Directory` tooan external store or another location.</span></span>  <span data-ttu-id="22a8c-150">Esta función también devuelve un valor booleano que indica si se trataba de ubicación de destino de tooits de toosuccessfully puede mover Hola carpeta de copia de seguridad.</span><span class="sxs-lookup"><span data-stu-id="22a8c-150">This function also returns a bool that indicates whether it was able toosuccessfully move hello backup folder tooits target location.</span></span>

<span data-ttu-id="22a8c-151">Hello código siguiente se muestra cómo Hola `BackupCallbackAsync` método puede ser utilizado tooupload Hola copia de seguridad tooAzure almacenamiento:</span><span class="sxs-lookup"><span data-stu-id="22a8c-151">hello following code demonstrates how hello `BackupCallbackAsync` method can be used tooupload hello backup tooAzure Storage:</span></span>

```csharp
private async Task<bool> BackupCallbackAsync(BackupInfo backupInfo, CancellationToken cancellationToken)
{
    var backupId = Guid.NewGuid();

    await externalBackupStore.UploadBackupFolderAsync(backupInfo.Directory, backupId, cancellationToken);

    return true;
}
```

<span data-ttu-id="22a8c-152">En el ejemplo de Hola precedente, `ExternalBackupStore` es la clase de ejemplo de Hola es toointerface usado con el almacenamiento de blobs de Azure, y `UploadBackupFolderAsync` es método hello que comprime carpeta hello y lo coloca en el almacén de blobs de Azure Hola.</span><span class="sxs-lookup"><span data-stu-id="22a8c-152">In hello preceeding example, `ExternalBackupStore` is hello sample class that is used toointerface with Azure Blob storage, and `UploadBackupFolderAsync` is hello method that compresses hello folder and places it in hello Azure Blob store.</span></span>

<span data-ttu-id="22a8c-153">Observe lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="22a8c-153">Note that:</span></span>

  - <span data-ttu-id="22a8c-154">Solo puede haber una operación de copia de seguridad en proceso por réplica en cualquier momento dado.</span><span class="sxs-lookup"><span data-stu-id="22a8c-154">There can be only one backup operation in-flight per replica at any given time.</span></span> <span data-ttu-id="22a8c-155">Más de un `BackupAsync` llama a la vez, se producirá `FabricBackupInProgressException` tooone de copias de seguridad de toolimit en proceso.</span><span class="sxs-lookup"><span data-stu-id="22a8c-155">More than one `BackupAsync` call at a time will throw `FabricBackupInProgressException` toolimit inflight backups tooone.</span></span>
  - <span data-ttu-id="22a8c-156">Si una réplica conmuta por error mientras se realiza una copia de seguridad, copia de seguridad de hello puede no haberse completado.</span><span class="sxs-lookup"><span data-stu-id="22a8c-156">If a replica fails over while a backup is in progress, hello backup may not have been completed.</span></span> <span data-ttu-id="22a8c-157">Por lo tanto, una vez finalizada la conmutación por error de hello, es copia de seguridad del servicio de hello responsabilidad toorestart Hola invocando `BackupAsync` según sea necesario.</span><span class="sxs-lookup"><span data-stu-id="22a8c-157">Thus, once hello failover finishes, it is hello service's responsibility toorestart hello backup by invoking `BackupAsync` as necessary.</span></span>

## <a name="restore-reliable-services"></a><span data-ttu-id="22a8c-158">Restauración de Reliable Services</span><span class="sxs-lookup"><span data-stu-id="22a8c-158">Restore Reliable Services</span></span>
<span data-ttu-id="22a8c-159">En general, los casos de Hola que tal vez tenga tooperform una operación de restauración se dividen en una de estas categorías:</span><span class="sxs-lookup"><span data-stu-id="22a8c-159">In general, hello cases when you might need tooperform a restore operation fall into one of these categories:</span></span>

  - <span data-ttu-id="22a8c-160">servicio de Hello particionar datos perdidos.</span><span class="sxs-lookup"><span data-stu-id="22a8c-160">hello service partition lost data.</span></span> <span data-ttu-id="22a8c-161">Por ejemplo, disco de Hola para dos de los tres réplicas de una partición (incluida la réplica principal de hello) obtiene dañado o se borre.</span><span class="sxs-lookup"><span data-stu-id="22a8c-161">For example, hello disk for two out of three replicas for a partition (including hello primary replica) gets corrupted or wiped.</span></span> <span data-ttu-id="22a8c-162">nuevo elemento principal Hola necesite toorestore datos desde una copia de seguridad.</span><span class="sxs-lookup"><span data-stu-id="22a8c-162">hello new primary may need toorestore data from a backup.</span></span>
  - <span data-ttu-id="22a8c-163">servicio completo de Hola se pierde.</span><span class="sxs-lookup"><span data-stu-id="22a8c-163">hello entire service is lost.</span></span> <span data-ttu-id="22a8c-164">Por ejemplo, un administrador quita todo el servicio hello y, por tanto, el servicio de Hola y los datos de Hola necesitan toobe restaurar.</span><span class="sxs-lookup"><span data-stu-id="22a8c-164">For example, an administrator removes hello entire service and thus hello service and hello data need toobe restored.</span></span>
  - <span data-ttu-id="22a8c-165">servicio de Hello replica datos de la aplicación está dañado (por ejemplo, debido a un error de la aplicación).</span><span class="sxs-lookup"><span data-stu-id="22a8c-165">hello service replicated corrupt application data (e.g., because of an application bug).</span></span> <span data-ttu-id="22a8c-166">En este caso, servicio de hello tiene toobe actualizado o revertida tooremove Hola causa de daños de Hola y datos de no dañar tiene toobe restaurar.</span><span class="sxs-lookup"><span data-stu-id="22a8c-166">In this case, hello service has toobe upgraded or reverted tooremove hello cause of hello corruption, and non-corrupt data has toobe restored.</span></span>

<span data-ttu-id="22a8c-167">Aunque muchos enfoques son posibles, se ofrecen algunos ejemplos sobre el uso de `RestoreAsync` toorecover de Hola por encima de los escenarios.</span><span class="sxs-lookup"><span data-stu-id="22a8c-167">While many approaches are possible, we offer some examples on using `RestoreAsync` toorecover from hello above scenarios.</span></span>

## <a name="partition-data-loss-in-reliable-services"></a><span data-ttu-id="22a8c-168">Pérdida de datos de la partición en Reliable Services</span><span class="sxs-lookup"><span data-stu-id="22a8c-168">Partition data loss in Reliable Services</span></span>
<span data-ttu-id="22a8c-169">En este caso, en tiempo de ejecución de hello automáticamente se detecta la pérdida de datos de hello e invocar hello `OnDataLossAsync` API.</span><span class="sxs-lookup"><span data-stu-id="22a8c-169">In this case, hello runtime would automatically detect hello data loss and invoke hello `OnDataLossAsync` API.</span></span>

<span data-ttu-id="22a8c-170">el autor del servicio de Hello tiene hello tooperform después toorecover:</span><span class="sxs-lookup"><span data-stu-id="22a8c-170">hello service author needs tooperform hello following toorecover:</span></span>

  - <span data-ttu-id="22a8c-171">Invalide el método de clase base virtual hello `OnDataLossAsync`.</span><span class="sxs-lookup"><span data-stu-id="22a8c-171">Override hello virtual base class method `OnDataLossAsync`.</span></span>
  - <span data-ttu-id="22a8c-172">Buscar Hola copia de seguridad más reciente en la ubicación externa Hola que contiene copias de seguridad del servicio de Hola.</span><span class="sxs-lookup"><span data-stu-id="22a8c-172">Find hello latest backup in hello external location that contains hello service's backups.</span></span>
  - <span data-ttu-id="22a8c-173">Descargar la última copia de seguridad de hello (y descomprimir copia de seguridad de hello en la carpeta de copia de seguridad de hello si estaba comprimido).</span><span class="sxs-lookup"><span data-stu-id="22a8c-173">Download hello latest backup (and uncompress hello backup into hello backup folder if it was compressed).</span></span>
  - <span data-ttu-id="22a8c-174">Hola `OnDataLossAsync` método proporciona un `RestoreContext`.</span><span class="sxs-lookup"><span data-stu-id="22a8c-174">hello `OnDataLossAsync` method provides a `RestoreContext`.</span></span> <span data-ttu-id="22a8c-175">Llamar a hello `RestoreAsync` API en hello proporciona `RestoreContext`.</span><span class="sxs-lookup"><span data-stu-id="22a8c-175">Call hello `RestoreAsync` API on hello provided `RestoreContext`.</span></span>
  - <span data-ttu-id="22a8c-176">Devuelve true si la restauración de hello tuvo éxito.</span><span class="sxs-lookup"><span data-stu-id="22a8c-176">Return true if hello restoration was a success.</span></span>

<span data-ttu-id="22a8c-177">Aquí te mostramos un ejemplo de implementación de hello `OnDataLossAsync` método:</span><span class="sxs-lookup"><span data-stu-id="22a8c-177">Following is an example implementation of hello `OnDataLossAsync` method:</span></span>

```csharp
protected override async Task<bool> OnDataLossAsync(RestoreContext restoreCtx, CancellationToken cancellationToken)
{
    var backupFolder = await this.externalBackupStore.DownloadLastBackupAsync(cancellationToken);

    var restoreDescription = new RestoreDescription(backupFolder);

    await restoreCtx.RestoreAsync(restoreDescription);

    return true;
}
```

<span data-ttu-id="22a8c-178">`RestoreDescription`pasa toohello `RestoreContext.RestoreAsync` llamada contiene un miembro denominado `BackupFolderPath`.</span><span class="sxs-lookup"><span data-stu-id="22a8c-178">`RestoreDescription` passed in toohello `RestoreContext.RestoreAsync` call contains a member called `BackupFolderPath`.</span></span>
<span data-ttu-id="22a8c-179">Al restaurar una copia de seguridad completa solo esto `BackupFolderPath` debe establecerse toohello ruta de acceso local de la carpeta de Hola que contiene la copia de seguridad completa.</span><span class="sxs-lookup"><span data-stu-id="22a8c-179">When restoring a single full backup, this `BackupFolderPath` should be set toohello local path of hello folder that contains your full backup.</span></span>
<span data-ttu-id="22a8c-180">Al restaurar una copia de seguridad completa y un número de copias de seguridad incrementales, `BackupFolderPath` debe establecerse toohello ruta de acceso local de carpeta de Hola que no solo contiene la copia de seguridad completa de hello, sino también todos los Hola copias de seguridad incrementales.</span><span class="sxs-lookup"><span data-stu-id="22a8c-180">When restoring a full backup and a number of incremental backups, `BackupFolderPath` should be set toohello local path of hello folder that not only contains hello full backup, but also all hello incremental backups.</span></span>
<span data-ttu-id="22a8c-181">`RestoreAsync`puede iniciar la llamada `FabricMissingFullBackupException` si hello `BackupFolderPath` proporcionado no contiene una copia de seguridad completa.</span><span class="sxs-lookup"><span data-stu-id="22a8c-181">`RestoreAsync` call can throw `FabricMissingFullBackupException` if hello `BackupFolderPath` provided does not contain a full backup.</span></span>
<span data-ttu-id="22a8c-182">También puede iniciar una excepción `ArgumentException` si `BackupFolderPath` tiene una cadena de copias de seguridad incrementales rota.</span><span class="sxs-lookup"><span data-stu-id="22a8c-182">It can also throw `ArgumentException` if `BackupFolderPath` has a broken chain of incremental backups.</span></span>
<span data-ttu-id="22a8c-183">Por ejemplo, si contiene Hola copia de seguridad completa, en primer lugar Hola incremental y Hola tercera copia de seguridad incremental pero ninguna copia de seguridad incremental de segundo de Hola.</span><span class="sxs-lookup"><span data-stu-id="22a8c-183">For example, if it contains hello full backup, hello first incremental and hello third incremental backup but no hello second incremental backup.</span></span>

> [!NOTE]
> <span data-ttu-id="22a8c-184">Hola RestorePolicy se establece tooSafe de forma predeterminada.</span><span class="sxs-lookup"><span data-stu-id="22a8c-184">hello RestorePolicy is set tooSafe by default.</span></span>  <span data-ttu-id="22a8c-185">Esto significa que hello `RestoreAsync` API se producirá un error con ArgumentException si detecta esta carpeta de copia de seguridad de hello contiene un estado que está en estado toohello igual o anterior a contenidos en esta réplica.</span><span class="sxs-lookup"><span data-stu-id="22a8c-185">This means that hello `RestoreAsync` API will fail with ArgumentException if it detects that hello backup folder contains a state that is older than or equal toohello state contained in this replica.</span></span>  <span data-ttu-id="22a8c-186">`RestorePolicy.Force`puede ser usado tooskip esta comprobación de seguridad.</span><span class="sxs-lookup"><span data-stu-id="22a8c-186">`RestorePolicy.Force` can be used tooskip this safety check.</span></span> <span data-ttu-id="22a8c-187">Este objeto se especifica como parte de `RestoreDescription`.</span><span class="sxs-lookup"><span data-stu-id="22a8c-187">This is specified as part of `RestoreDescription`.</span></span>
> 

## <a name="deleted-or-lost-service"></a><span data-ttu-id="22a8c-188">Eliminación o pérdida del servicio</span><span class="sxs-lookup"><span data-stu-id="22a8c-188">Deleted or lost service</span></span>
<span data-ttu-id="22a8c-189">Si se quita un servicio, primero debe volver a crear el servicio de Hola antes de pueden restaurar datos de Hola.</span><span class="sxs-lookup"><span data-stu-id="22a8c-189">If a service is removed, you must first re-create hello service before hello data can be restored.</span></span>  <span data-ttu-id="22a8c-190">Es importante toocreate Hola servicio con hello misma configuración, por ejemplo, partición de esquema, por lo que Hola datos puede restaurarse sin problemas.</span><span class="sxs-lookup"><span data-stu-id="22a8c-190">It is important toocreate hello service with hello same configuration, e.g., partitioning scheme, so that hello data can be restored seamlessly.</span></span>  <span data-ttu-id="22a8c-191">Una vez que el servicio de hello está en funcionamiento, Hola datos toorestore de API (`OnDataLossAsync` anteriormente) tiene toobe invocar en cada partición de este servicio.</span><span class="sxs-lookup"><span data-stu-id="22a8c-191">Once hello service is up, hello API toorestore data (`OnDataLossAsync` above) has toobe invoked on every partition of this service.</span></span> <span data-ttu-id="22a8c-192">Esta operación puede llevarse a cabo utilizando `[FabricClient.TestManagementClient.StartPartitionDataLossAsync](https://msdn.microsoft.com/library/mt693569.aspx)` en todas las particiones.</span><span class="sxs-lookup"><span data-stu-id="22a8c-192">One way of achieving this is by using `[FabricClient.TestManagementClient.StartPartitionDataLossAsync](https://msdn.microsoft.com/library/mt693569.aspx)` on every partition.</span></span>  

<span data-ttu-id="22a8c-193">Desde este punto de implementación es Hola igual que Hola por encima del escenario.</span><span class="sxs-lookup"><span data-stu-id="22a8c-193">From this point, implementation is hello same as hello above scenario.</span></span> <span data-ttu-id="22a8c-194">Cada partición debe toorestore hello más reciente relevante copia de seguridad del almacén externo Hola.</span><span class="sxs-lookup"><span data-stu-id="22a8c-194">Each partition needs toorestore hello latest relevant backup from hello external store.</span></span> <span data-ttu-id="22a8c-195">Una advertencia es esa partición Hola que identificador puede ahora cambiaron, puesto que en tiempo de ejecución de hello crea identificadores de partición dinámicamente.</span><span class="sxs-lookup"><span data-stu-id="22a8c-195">One caveat is that hello partition ID may have now changed, since hello runtime creates partition IDs dynamically.</span></span> <span data-ttu-id="22a8c-196">Por lo tanto, servicio de hello necesita información de partición apropiada de hello toostore y servicio nombre tooidentify Hola correcto última copia de seguridad toorestore de para cada partición.</span><span class="sxs-lookup"><span data-stu-id="22a8c-196">Thus, hello service needs toostore hello appropriate partition information and service name tooidentify hello correct latest backup toorestore from for each partition.</span></span>

> [!NOTE]
> <span data-ttu-id="22a8c-197">No se recomienda toouse `FabricClient.ServiceManager.InvokeDataLossAsync` en cada partición toorestore Hola servicio completo, ya que puede dañar el estado del clúster.</span><span class="sxs-lookup"><span data-stu-id="22a8c-197">It is not recommended toouse `FabricClient.ServiceManager.InvokeDataLossAsync` on each partition toorestore hello entire service, since that may corrupt your cluster state.</span></span>
> 

## <a name="replication-of-corrupt-application-data"></a><span data-ttu-id="22a8c-198">Replicación de datos de aplicación dañados</span><span class="sxs-lookup"><span data-stu-id="22a8c-198">Replication of corrupt application data</span></span>
<span data-ttu-id="22a8c-199">Si la actualización de la aplicación hello recién implementado tiene un error, que puede producir daños de datos.</span><span class="sxs-lookup"><span data-stu-id="22a8c-199">If hello newly deployed application upgrade has a bug, that may cause corruption of data.</span></span> <span data-ttu-id="22a8c-200">Por ejemplo, una actualización de la aplicación puede iniciar tooupdate cada registro del número de teléfono en un diccionario confiable con un código de área no válido.</span><span class="sxs-lookup"><span data-stu-id="22a8c-200">For example, an application upgrade may start tooupdate every phone number record in a Reliable Dictionary with an invalid area code.</span></span>  <span data-ttu-id="22a8c-201">En este caso, los números de teléfono no válido de Hola se replicarán desde Service Fabric no es consciente de la naturaleza de Hola de datos de Hola que se va a almacenar.</span><span class="sxs-lookup"><span data-stu-id="22a8c-201">In this case, hello invalid phone numbers will be replicated since Service Fabric is not aware of hello nature of hello data that is being stored.</span></span>

<span data-ttu-id="22a8c-202">Hello lo primero toodo después de detectar tal un error notoria que provoca daños en los datos que es toofreeze Hola servicio Hola a nivel de aplicación y, si es posible, actualice versión toohello Hola del código de aplicación que no tiene errores de Hola.</span><span class="sxs-lookup"><span data-stu-id="22a8c-202">hello first thing toodo after you detect such an egregious bug that causes data corruption is toofreeze hello service at hello application level and, if possible, upgrade toohello version of hello application code that does not have hello bug.</span></span>  <span data-ttu-id="22a8c-203">Sin embargo, incluso después de corregir el código del servicio de hello, datos de hello todavía pueden estar dañados y, por tanto, los datos pueden necesitar que toobe restaurar.</span><span class="sxs-lookup"><span data-stu-id="22a8c-203">However, even after hello service code is fixed, hello data may still be corrupt and thus data may need toobe restored.</span></span>  <span data-ttu-id="22a8c-204">En tales casos, no puede ser suficiente toorestore Hola última copia de seguridad, puesto que las copias de seguridad más recientes de hello también pueden estar dañados.</span><span class="sxs-lookup"><span data-stu-id="22a8c-204">In such cases, it may not be sufficient toorestore hello latest backup, since hello latest backups may also be corrupt.</span></span>  <span data-ttu-id="22a8c-205">Por lo tanto, tienen toofind Hola última copia de seguridad realizada antes de que se ha dañado datos Hola.</span><span class="sxs-lookup"><span data-stu-id="22a8c-205">Thus, you have toofind hello last backup that was made before hello data got corrupted.</span></span>

<span data-ttu-id="22a8c-206">Si no estás seguro de que las copias de seguridad están dañados, podría implementar un nuevo clúster de Service Fabric y restaurar copias de seguridad de Hola de las particiones afectadas como Hola anteriormente "Deleted o servicio pierde" escenario.</span><span class="sxs-lookup"><span data-stu-id="22a8c-206">If you are not sure which backups are corrupt, you could deploy a new Service Fabric cluster and restore hello backups of affected partitions just like hello above "Deleted or lost service" scenario.</span></span>  <span data-ttu-id="22a8c-207">Para cada partición, iniciar Restaurar copias de seguridad de Hola de hello más reciente toohello menos.</span><span class="sxs-lookup"><span data-stu-id="22a8c-207">For each partition, start restoring hello backups from hello most recent toohello least.</span></span> <span data-ttu-id="22a8c-208">Una vez que encuentre una copia de seguridad no tiene daños de hello, mover o eliminar todas las copias de seguridad de esta partición que estaban más recientes (que esa copia de seguridad).</span><span class="sxs-lookup"><span data-stu-id="22a8c-208">Once you find a backup that does not have hello corruption, move/delete all backups of this partition that were more recent (than that backup).</span></span> <span data-ttu-id="22a8c-209">Repita este proceso para cada partición.</span><span class="sxs-lookup"><span data-stu-id="22a8c-209">Repeat this process for each partition.</span></span> <span data-ttu-id="22a8c-210">Ahora, cuando `OnDataLossAsync` se llama en partición de hello en el clúster de producción de hello, última copia de seguridad de hello encontradas en hello externo almacén será Hola uno seleccionado por Hola por encima del proceso.</span><span class="sxs-lookup"><span data-stu-id="22a8c-210">Now, when `OnDataLossAsync` is called on hello partition in hello production cluster, hello last backup found in hello external store will be hello one picked by hello above process.</span></span>

<span data-ttu-id="22a8c-211">Ahora, los pasos Hola Hola "Deleted o servicio pierde" sección puede ser usar estado de hello toorestore del estado de toohello del servicio de hello antes de código con errores de hello dañado estado Hola.</span><span class="sxs-lookup"><span data-stu-id="22a8c-211">Now, hello steps in hello "Deleted or lost service" section can be used toorestore hello state of hello service toohello state before hello buggy code corrupted hello state.</span></span>

<span data-ttu-id="22a8c-212">Observe lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="22a8c-212">Note that:</span></span>

  - <span data-ttu-id="22a8c-213">Cuando se restaura, existe es probable que Hola copia de seguridad que se va a restaurar es anterior a estado de Hola de partición de Hola antes de que se han perdido datos Hola.</span><span class="sxs-lookup"><span data-stu-id="22a8c-213">When you restore, there is a chance that hello backup being restored is older than hello state of hello partition before hello data was lost.</span></span> <span data-ttu-id="22a8c-214">Por este motivo, debe restaurar solo como una última toorecover recurso tantos datos como sea posible.</span><span class="sxs-lookup"><span data-stu-id="22a8c-214">Because of this, you should restore only as a last resort toorecover as much data as possible.</span></span>
  - <span data-ttu-id="22a8c-215">Hola de cadena que representa la ruta de acceso de carpeta de copia de seguridad de Hola y Hola rutas de acceso de archivos dentro de la carpeta de copia de seguridad de hello pueden ser mayores que 255 caracteres, dependiendo de la ruta de acceso de hello FabricDataRoot y longitud del nombre del tipo de aplicación.</span><span class="sxs-lookup"><span data-stu-id="22a8c-215">hello string that represents hello backup folder path and hello paths of files inside hello backup folder can be greater than 255 characters, depending on hello FabricDataRoot path and Application Type name's length.</span></span> <span data-ttu-id="22a8c-216">Esto puede causar algunos métodos. NET, como `Directory.Move`, toothrow hello `PathTooLongException` excepción.</span><span class="sxs-lookup"><span data-stu-id="22a8c-216">This can cause some .NET methods, like `Directory.Move`, toothrow hello `PathTooLongException` exception.</span></span> <span data-ttu-id="22a8c-217">Una solución es toodirectly llamar a las API de kernel32, como `CopyFile`.</span><span class="sxs-lookup"><span data-stu-id="22a8c-217">One workaround is toodirectly call kernel32 APIs, like `CopyFile`.</span></span>

## <a name="backup-and-restore-reliable-actors"></a><span data-ttu-id="22a8c-218">Copia de seguridad y restauración de Reliable Actors</span><span class="sxs-lookup"><span data-stu-id="22a8c-218">Backup and restore Reliable Actors</span></span>


<span data-ttu-id="22a8c-219">El marco de Reliable Actors está basado en Reliable Services.</span><span class="sxs-lookup"><span data-stu-id="22a8c-219">Reliable Actors Framework is built on top of Reliable Services.</span></span> <span data-ttu-id="22a8c-220">Hola ActorService que hospeda hello actor(s) es un servicio confiable con estado.</span><span class="sxs-lookup"><span data-stu-id="22a8c-220">hello ActorService which hosts hello actor(s) is a stateful reliable service.</span></span> <span data-ttu-id="22a8c-221">Por lo tanto, todas las copias de seguridad de Hola y funcionalidad de restauración disponible en servicios de confianza también es actores tooReliable disponibles (excepto los comportamientos que son específicos de proveedor de estado).</span><span class="sxs-lookup"><span data-stu-id="22a8c-221">Hence, all hello backup and restore functionality available in Reliable Services is also available tooReliable Actors (except behaviors that are state provider specific).</span></span> <span data-ttu-id="22a8c-222">Puesto que las copias de seguridad se realizan por partición, se llevará a cabo una copia de seguridad de los estados para todos los actores de esa partición. La restauración es similar y se realizará por partición.</span><span class="sxs-lookup"><span data-stu-id="22a8c-222">Since backups will be taken on a per-partition basis, states for all actors in that partition will be backed up (and restoration is similar and will happen on a per-partition basis).</span></span> <span data-ttu-id="22a8c-223">tooperform copia de seguridad/restauración, el propietario del servicio Hola debe crear una clase de servicio de actor personalizada que deriva de la clase ActorService y, a continuación, backup/restore tooReliable similar servicios tal como se describió en las secciones anteriores.</span><span class="sxs-lookup"><span data-stu-id="22a8c-223">tooperform backup/restore, hello service owner should create a custom actor service class that derives from ActorService class and then do backup/restore similar tooReliable Services as described above in previous sections.</span></span>

```csharp
class MyCustomActorService : ActorService
{
     public MyCustomActorService(StatefulServiceContext context, ActorTypeInformation actorTypeInfo)
            : base(context, actorTypeInfo)
     {                  
     }
    
    //
   // Method overrides and other code.
    //
}
```

<span data-ttu-id="22a8c-224">Cuando se crea una clase de servicio de actor personalizado, debe tooregister es así cuando se registra el actor Hola.</span><span class="sxs-lookup"><span data-stu-id="22a8c-224">When you create a custom actor service class, you need tooregister that as well when registering hello actor.</span></span>

```csharp
ActorRuntime.RegisterActorAsync<MyActor>(
   (context, typeInfo) => new MyCustomActorService(context, typeInfo)).GetAwaiter().GetResult();
```

<span data-ttu-id="22a8c-225">proveedor de estado predeterminado de Hola de Reliable Actors es `KvsActorStateProvider`.</span><span class="sxs-lookup"><span data-stu-id="22a8c-225">hello default state provider for Reliable Actors is `KvsActorStateProvider`.</span></span> <span data-ttu-id="22a8c-226">La copia de seguridad incremental no está habilitada de manera predeterminada para `KvsActorStateProvider`.</span><span class="sxs-lookup"><span data-stu-id="22a8c-226">Incremental backup is not enabled by default for `KvsActorStateProvider`.</span></span> <span data-ttu-id="22a8c-227">Puede habilitar la copia de seguridad incremental mediante la creación de `KvsActorStateProvider` con hello adecuados en su constructor y, a continuación, pasándole tooActorService constructor como se muestra en el siguiente fragmento de código:</span><span class="sxs-lookup"><span data-stu-id="22a8c-227">You can enable incremental backup by creating `KvsActorStateProvider` with hello appropriate setting in its constructor and then passing it tooActorService constructor as shown in following code snippet:</span></span>

```csharp
class MyCustomActorService : ActorService
{
     public MyCustomActorService(StatefulServiceContext context, ActorTypeInformation actorTypeInfo)
            : base(context, actorTypeInfo, null, null, new KvsActorStateProvider(true)) // Enable incremental backup
     {                  
     }
    
    //
   // Method overrides and other code.
    //
}
```

<span data-ttu-id="22a8c-228">Después de que se ha habilitado la copia de seguridad incremental, realizar una copia de seguridad incremental se puede producir un FabricMissingFullBackupException para uno de los siguientes motivos y deberá tootake una copia de seguridad completa antes de realizar backup(s) incremental:</span><span class="sxs-lookup"><span data-stu-id="22a8c-228">After incremental backup has been enabled, taking an incremental backup can fail with FabricMissingFullBackupException for one of following reasons and you will need tootake a full backup before taking incremental backup(s):</span></span>

  - <span data-ttu-id="22a8c-229">réplica de Hello nunca ha tomado una copia de seguridad completa porque se convirtió en principal.</span><span class="sxs-lookup"><span data-stu-id="22a8c-229">hello replica has never taken a full backup since it became primary.</span></span>
  - <span data-ttu-id="22a8c-230">Algunas de las entradas del registro de hello se truncaron desde que se realizó la última copia de seguridad.</span><span class="sxs-lookup"><span data-stu-id="22a8c-230">Some of hello log records were truncated since last backup was taken.</span></span>

<span data-ttu-id="22a8c-231">Cuando se habilita la copia de seguridad incremental, `KvsActorStateProvider` no usa el búfer circular toomanage su registro registra y periódicamente lo trunca.</span><span class="sxs-lookup"><span data-stu-id="22a8c-231">When incremental backup is enabled, `KvsActorStateProvider` does not use circular buffer toomanage its log records and periodically truncates it.</span></span> <span data-ttu-id="22a8c-232">Si no se realiza ninguna copia de seguridad por usuario durante un período de 45 minutos, el sistema de Hola trunca automáticamente entradas del registro de hello.</span><span class="sxs-lookup"><span data-stu-id="22a8c-232">If no backup is taken by user for a period of 45 minutes, hello system automatically truncates hello log records.</span></span> <span data-ttu-id="22a8c-233">Este intervalo se puede configurar mediante la especificación de `logTrunctationIntervalInMinutes` en `KvsActorStateProvider` constructor (habilitar la copia de seguridad incremental de toowhen similar).</span><span class="sxs-lookup"><span data-stu-id="22a8c-233">This interval can be configured by specifying `logTrunctationIntervalInMinutes` in `KvsActorStateProvider` constructor (similar toowhen enabling incremental backup).</span></span> <span data-ttu-id="22a8c-234">También pueden obtener truncados entradas del registro de Hello si la réplica principal necesita toobuild otra réplica mediante el envío de todos sus datos.</span><span class="sxs-lookup"><span data-stu-id="22a8c-234">hello log records may also get truncated if primary replica need toobuild another replica by sending all its data.</span></span>

<span data-ttu-id="22a8c-235">Al realizar la restauración a partir de una cadena de copia de seguridad, los servicios de tooReliable similares, hello BackupFolderPath debe contener subdirectorios con un subdirectorio que contiene copias de seguridad completa y otros subdirectorios que contienen backup(s) incremental.</span><span class="sxs-lookup"><span data-stu-id="22a8c-235">When doing restore from a backup chain, similar tooReliable Services, hello BackupFolderPath should contain subdirectories with one subdirectory containing full backup and others subdirectories containing incremental backup(s).</span></span> <span data-ttu-id="22a8c-236">API de restauración de Hello producirá FabricException con mensaje de error adecuado si se produce un error de validación de la cadena de copia de seguridad de Hola.</span><span class="sxs-lookup"><span data-stu-id="22a8c-236">hello restore API will throw FabricException with appropriate error message if hello backup chain validation fails.</span></span> 

> [!NOTE]
> <span data-ttu-id="22a8c-237">`KvsActorStateProvider`actualmente se omite la opción de hello RestorePolicy.Safe.</span><span class="sxs-lookup"><span data-stu-id="22a8c-237">`KvsActorStateProvider` currently ignores hello option RestorePolicy.Safe.</span></span> <span data-ttu-id="22a8c-238">La compatibilidad con esta característica está pensada para un próximo lanzamiento.</span><span class="sxs-lookup"><span data-stu-id="22a8c-238">Support for this feature is planned in an upcoming release.</span></span>
> 

## <a name="testing-backup-and-restore"></a><span data-ttu-id="22a8c-239">Prueba de la copia de seguridad y la restauración</span><span class="sxs-lookup"><span data-stu-id="22a8c-239">Testing Backup and Restore</span></span>
<span data-ttu-id="22a8c-240">Es importante tooensure que se hace copia datos críticos y se pueden restaurar desde.</span><span class="sxs-lookup"><span data-stu-id="22a8c-240">It is important tooensure that critical data is being backed up, and can be restored from.</span></span> <span data-ttu-id="22a8c-241">Esto puede hacerse mediante la invocación de hello `Start-ServiceFabricPartitionDataLoss` cmdlet de PowerShell que puede inducir la pérdida de datos en una partición determinada tootest si datos Hola de copia de seguridad y restauración la funcionalidad para su servicio está funcionando según lo previsto.</span><span class="sxs-lookup"><span data-stu-id="22a8c-241">This can be done by invoking hello `Start-ServiceFabricPartitionDataLoss` cmdlet in PowerShell that can induce data loss in a particular partition tootest whether hello data backup and restore functionality for your service is working as expected.</span></span>  <span data-ttu-id="22a8c-242">También es posible tooprogrammatically invocar la pérdida de datos y restaurar a partir de ese evento así.</span><span class="sxs-lookup"><span data-stu-id="22a8c-242">It is also possible tooprogrammatically invoke data loss and restore from that event as well.</span></span>

> [!NOTE]
> <span data-ttu-id="22a8c-243">Puede encontrar una implementación de ejemplo de copia de seguridad y restaurar la funcionalidad en hello aplicación de referencia Web en GitHub.</span><span class="sxs-lookup"><span data-stu-id="22a8c-243">You can find a sample implementation of backup and restore functionality in hello Web Reference App on GitHub.</span></span> <span data-ttu-id="22a8c-244">Mire hello `Inventory.Service` service para obtener más detalles.</span><span class="sxs-lookup"><span data-stu-id="22a8c-244">Please look at hello `Inventory.Service` service for more details.</span></span>
> 
> 

## <a name="under-hello-hood-more-details-on-backup-and-restore"></a><span data-ttu-id="22a8c-245">Bajo el paraguas de hello: más detalles sobre copia de seguridad y restauración</span><span class="sxs-lookup"><span data-stu-id="22a8c-245">Under hello hood: more details on backup and restore</span></span>
<span data-ttu-id="22a8c-246">A continuación se proporcionan más detalles sobre la copia de seguridad y la restauración.</span><span class="sxs-lookup"><span data-stu-id="22a8c-246">Here's some more details on backup and restore.</span></span>

### <a name="backup"></a><span data-ttu-id="22a8c-247">Backup</span><span class="sxs-lookup"><span data-stu-id="22a8c-247">Backup</span></span>
<span data-ttu-id="22a8c-248">Hola, Administrador de estado confiable proporciona Hola capacidad toocreate copias de seguridad coherentes sin bloquear cualquiera leen o las operaciones de escritura.</span><span class="sxs-lookup"><span data-stu-id="22a8c-248">hello Reliable State Manager provides hello ability toocreate consistent backups without blocking any read or write operations.</span></span> <span data-ttu-id="22a8c-249">toodo por lo tanto, utiliza un mecanismo de persistencia de punto de comprobación y de registro.</span><span class="sxs-lookup"><span data-stu-id="22a8c-249">toodo so, it utilizes a checkpoint and log persistence mechanism.</span></span>  <span data-ttu-id="22a8c-250">Hola, Administrador de estado confiable toma los puntos de control (ligeras) aproximadas en determinadas presión de toorelieve puntos de registro de transacciones de Hola y mejorar los tiempos de recuperación.</span><span class="sxs-lookup"><span data-stu-id="22a8c-250">hello Reliable State Manager takes fuzzy (lightweight) checkpoints at certain points toorelieve pressure from hello transactional log and improve recovery times.</span></span>  <span data-ttu-id="22a8c-251">Cuando `BackupAsync` se denomina hello confiable Administrador de estado indica toocopy de todos los objetos confiable su últimas checkpoint archivos tooa copia de seguridad carpeta local.</span><span class="sxs-lookup"><span data-stu-id="22a8c-251">When `BackupAsync` is called, hello Reliable State Manager instructs all Reliable objects toocopy their latest checkpoint files tooa local backup folder.</span></span>  <span data-ttu-id="22a8c-252">A continuación, Hola el Administrador de estado confiable copia todas las entradas del registro, a partir de Hola "start puntero" toohello última entrada de registro en carpeta de copia de seguridad de Hola.</span><span class="sxs-lookup"><span data-stu-id="22a8c-252">Then, hello Reliable State Manager copies all log records, starting from hello "start pointer" toohello latest log record into hello backup folder.</span></span>  <span data-ttu-id="22a8c-253">Dado que todas las entradas de registro de hello una entrada de registro más reciente de toohello se incluyen en la copia de seguridad de Hola y Hola el Administrador de estado confiable conserva el registro de escritura anticipada, Hola el Administrador de estado confiable garantiza que todas las transacciones que se confirman (`CommitAsync` ha devuelto correctamente) se incluyen en la copia de seguridad de Hola.</span><span class="sxs-lookup"><span data-stu-id="22a8c-253">Since all hello log records up toohello latest log record are included in hello backup and hello Reliable State Manager preserves write-ahead logging, hello Reliable State Manager guarantees that all transactions that are committed (`CommitAsync` has returned successfully) are included in hello backup.</span></span>

<span data-ttu-id="22a8c-254">Cualquier transacción que confirma después de `BackupAsync` se ha llamado puede o no puede estar en la copia de seguridad de Hola.</span><span class="sxs-lookup"><span data-stu-id="22a8c-254">Any transaction that commits after `BackupAsync` has been called may or may not be in hello backup.</span></span>  <span data-ttu-id="22a8c-255">Una vez que se ha rellenado la carpeta de copia de seguridad local de Hola por plataforma de hello (es decir, copia de seguridad local se completa en tiempo de ejecución de hello), se invoca la devolución de llamada copia de seguridad del servicio de Hola.</span><span class="sxs-lookup"><span data-stu-id="22a8c-255">Once hello local backup folder has been populated by hello platform (i.e., local backup is completed by hello runtime), hello service's backup callback is invoked.</span></span>  <span data-ttu-id="22a8c-256">Esta devolución de llamada es responsable de transferir tooan de ubicación externa como almacenamiento de Azure para la carpeta de copia de seguridad Hola.</span><span class="sxs-lookup"><span data-stu-id="22a8c-256">This callback is responsible for moving hello backup folder tooan external location such as Azure Storage.</span></span>

### <a name="restore"></a><span data-ttu-id="22a8c-257">Restauración</span><span class="sxs-lookup"><span data-stu-id="22a8c-257">Restore</span></span>
<span data-ttu-id="22a8c-258">Hola, Administrador de estado confiable proporciona Hola capacidad toorestore desde una copia de seguridad mediante hello `RestoreAsync` API.</span><span class="sxs-lookup"><span data-stu-id="22a8c-258">hello Reliable State Manager provides hello ability toorestore from a backup by using hello `RestoreAsync` API.</span></span>  
<span data-ttu-id="22a8c-259">Hola `RestoreAsync` método `RestoreContext` puede llamar solo dentro de hello `OnDataLossAsync` método.</span><span class="sxs-lookup"><span data-stu-id="22a8c-259">hello `RestoreAsync` method on `RestoreContext` can be called only inside hello `OnDataLossAsync` method.</span></span>
<span data-ttu-id="22a8c-260">Hola bool devuelto por `OnDataLossAsync` indica si el servicio de hello restaura su estado desde un origen externo.</span><span class="sxs-lookup"><span data-stu-id="22a8c-260">hello bool returned by `OnDataLossAsync` indicates whether hello service restored its state from an external source.</span></span>
<span data-ttu-id="22a8c-261">Si hello `OnDataLossAsync` devuelve true, Service Fabric se volverá a generar todas las demás réplicas del servidor principal.</span><span class="sxs-lookup"><span data-stu-id="22a8c-261">If hello `OnDataLossAsync` returns true, Service Fabric will rebuild all other replicas from this primary.</span></span> <span data-ttu-id="22a8c-262">Service Fabric garantiza que las réplicas que van a recibir `OnDataLossAsync` llame al primer rol principal de transición toohello pero no tienen permisos de lectura estado o estado de escritura.</span><span class="sxs-lookup"><span data-stu-id="22a8c-262">Service Fabric ensures that replicas that will receive `OnDataLossAsync` call first transition toohello primary role but are not granted read status or write status.</span></span>
<span data-ttu-id="22a8c-263">Esto supone que, en el caso de los implementadores de StatefulService, no se va a llamar a `RunAsync` hasta que `OnDataLossAsync` se complete correctamente.</span><span class="sxs-lookup"><span data-stu-id="22a8c-263">This implies that for StatefulService implementers, `RunAsync` will not be called until `OnDataLossAsync` finishes successfully.</span></span>
<span data-ttu-id="22a8c-264">A continuación, `OnDataLossAsync` se invocará en la nueva réplica principal de Hola.</span><span class="sxs-lookup"><span data-stu-id="22a8c-264">Then, `OnDataLossAsync` will be invoked on hello new primary.</span></span>
<span data-ttu-id="22a8c-265">Hasta que un servicio de esta API completa correctamente (devolviendo true o false) y finaliza la reconfiguración de hello relevante, Hola API mantener que se llamará a uno en uno.</span><span class="sxs-lookup"><span data-stu-id="22a8c-265">Until a service completes this API successfully (by returning true or false) and finishes hello relevant reconfiguration, hello API will keep being called one at a time.</span></span>

<span data-ttu-id="22a8c-266">`RestoreAsync`en primer lugar se quita todo el estado existente en la réplica principal de Hola que se llamó en.</span><span class="sxs-lookup"><span data-stu-id="22a8c-266">`RestoreAsync` first drops all existing state in hello primary replica that it was called on.</span></span>  
<span data-ttu-id="22a8c-267">A continuación, Hola confiable Administrador de Estados crea todos los objetos confiable Hola que existen en la carpeta de copia de seguridad de Hola.</span><span class="sxs-lookup"><span data-stu-id="22a8c-267">Then hello Reliable State Manager creates all hello Reliable objects that exist in hello backup folder.</span></span>  
<span data-ttu-id="22a8c-268">A continuación, objetos de confianza de hello son toorestore siguiendo las instrucciones de sus puntos de control en la carpeta de copia de seguridad de Hola.</span><span class="sxs-lookup"><span data-stu-id="22a8c-268">Next, hello Reliable objects are instructed toorestore from their checkpoints in hello backup folder.</span></span>  
<span data-ttu-id="22a8c-269">Por último, Hola confiable State Manager recupera su propio estado de los registros de hello en la carpeta de copia de seguridad de Hola y realiza la recuperación.</span><span class="sxs-lookup"><span data-stu-id="22a8c-269">Finally, hello Reliable State Manager recovers its own state from hello log records in hello backup folder and performs recovery.</span></span>  
<span data-ttu-id="22a8c-270">Como parte del proceso de recuperación de hello, las operaciones desde Hola "punto de partida" que tienen entradas de registro de confirmación en la carpeta de copia de seguridad de hello son objetos confiable de toohello reproducido.</span><span class="sxs-lookup"><span data-stu-id="22a8c-270">As part of hello recovery process, operations starting from hello "starting point" that have commit log records in hello backup folder are replayed toohello Reliable objects.</span></span>  
<span data-ttu-id="22a8c-271">Este paso garantiza que Hola recuperada del estado es coherente.</span><span class="sxs-lookup"><span data-stu-id="22a8c-271">This step ensures that hello recovered state is consistent.</span></span>

## <a name="next-steps"></a><span data-ttu-id="22a8c-272">Pasos siguientes</span><span class="sxs-lookup"><span data-stu-id="22a8c-272">Next steps</span></span>
  - [<span data-ttu-id="22a8c-273">Colecciones confiables</span><span class="sxs-lookup"><span data-stu-id="22a8c-273">Reliable Collections</span></span>](service-fabric-work-with-reliable-collections.md)
  - [<span data-ttu-id="22a8c-274">Introducción a Reliable Services de Service Fabric de Microsoft Azure</span><span class="sxs-lookup"><span data-stu-id="22a8c-274">Reliable Services quick start</span></span>](service-fabric-reliable-services-quick-start.md)
  - [<span data-ttu-id="22a8c-275">Notificaciones de Reliable Services</span><span class="sxs-lookup"><span data-stu-id="22a8c-275">Reliable Services notifications</span></span>](service-fabric-reliable-services-notifications.md)
  - [<span data-ttu-id="22a8c-276">Configuración de Reliable Services</span><span class="sxs-lookup"><span data-stu-id="22a8c-276">Reliable Services configuration</span></span>](service-fabric-reliable-services-configuration.md)
  - [<span data-ttu-id="22a8c-277">Referencia para desarrolladores de colecciones confiables</span><span class="sxs-lookup"><span data-stu-id="22a8c-277">Developer reference for Reliable Collections</span></span>](https://msdn.microsoft.com/library/azure/microsoft.servicefabric.data.collections.aspx)

