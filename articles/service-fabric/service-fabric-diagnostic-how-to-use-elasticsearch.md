---
title: "Uso de Elasticsearch como almacén de seguimientos de aplicaciones de Service Fabric | Microsoft Docs"
description: "Describe cómo las aplicaciones de Service Fabric pueden usar ElasticSearch y Kibana para el almacenamiento, la indexación y la búsqueda de seguimientos de aplicaciones."
services: service-fabric
documentationcenter: .net
author: karolz-ms
manager: adegeo
editor: 
ms.assetid: e59b0c39-e468-4d9e-b453-d5f2a8ad20d8
ms.service: service-fabric
ms.devlang: dotNet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 04/07/2017
ms.author: karolz@microsoft.com
redirect_url: /azure/service-fabric/service-fabric-diagnostics-event-aggregation-eventflow
ms.openlocfilehash: 2d2ceceea131b41ad1a1735aaa2a859d035ab098
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 07/11/2017
---
# <a name="use-elasticsearch-as-a-service-fabric-application-trace-store"></a><span data-ttu-id="e4407-103">Uso de ElasticSearch como almacén de seguimientos de aplicaciones de Service Fabric</span><span class="sxs-lookup"><span data-stu-id="e4407-103">Use Elasticsearch as a Service Fabric application trace store</span></span>
## <a name="introduction"></a><span data-ttu-id="e4407-104">Introducción</span><span class="sxs-lookup"><span data-stu-id="e4407-104">Introduction</span></span>
<span data-ttu-id="e4407-105">En este artículo se describe cómo las aplicaciones de [Azure Service Fabric](https://azure.microsoft.com/documentation/services/service-fabric/) pueden usar **ElasticSearch** y **Kibana** para el almacenamiento, la indexación y la búsqueda de seguimientos de aplicaciones.</span><span class="sxs-lookup"><span data-stu-id="e4407-105">This article describes how [Azure Service Fabric](https://azure.microsoft.com/documentation/services/service-fabric/) applications can use **Elasticsearch** and **Kibana** for application trace storage, indexing, and search.</span></span> <span data-ttu-id="e4407-106">[ElasticSearch](https://www.elastic.co/guide/index.html) es un motor de búsqueda y análisis de código abierto, distribuido, escalable y en tiempo real que resulta adecuado para esta tarea.</span><span class="sxs-lookup"><span data-stu-id="e4407-106">[Elasticsearch](https://www.elastic.co/guide/index.html) is an open-source, distributed, and scalable real-time search and analytics engine that is well-suited for this task.</span></span> <span data-ttu-id="e4407-107">Se puede instalar en máquinas virtuales de Windows o Linux que se ejecutan en Microsoft Azure.</span><span class="sxs-lookup"><span data-stu-id="e4407-107">It can be installed on Windows and Linux virtual machines running in Microsoft Azure.</span></span> <span data-ttu-id="e4407-108">Elasticsearch puede procesar de forma eficiente seguimientos *estructurados* producidos con tecnologías como **Seguimiento de eventos para Windows (ETW)**.</span><span class="sxs-lookup"><span data-stu-id="e4407-108">Elasticsearch can efficiently process *structured* traces produced using technologies such as **Event Tracing for Windows (ETW)**.</span></span>

<span data-ttu-id="e4407-109">El tiempo de ejecución de Service Fabric usa ETW para producir información de diagnóstico (seguimientos).</span><span class="sxs-lookup"><span data-stu-id="e4407-109">ETW is used by Service Fabric runtime to source diagnostic information (traces).</span></span> <span data-ttu-id="e4407-110">También es el método recomendado para que las aplicaciones de Service Fabric produzcan su información de diagnóstico.</span><span class="sxs-lookup"><span data-stu-id="e4407-110">It is the recommended method for Service Fabric applications to source their diagnostic information, too.</span></span> <span data-ttu-id="e4407-111">El uso del mismo mecanismo permite correlacionar los seguimientos proporcionados por el sistema en tiempo de ejecución y los suministrados por la aplicación, y facilita la solución de problemas.</span><span class="sxs-lookup"><span data-stu-id="e4407-111">Using the same mechanism allows for correlation between runtime-supplied and application-supplied traces and makes troubleshooting easier.</span></span> <span data-ttu-id="e4407-112">Las plantillas de proyecto de Service Fabric en Visual Studio incluyen una API de registro (basada en la clase **EventSource** de .NET) que emite seguimientos de ETW de forma predeterminada.</span><span class="sxs-lookup"><span data-stu-id="e4407-112">Service Fabric project templates in Visual Studio include a logging API (based on the .NET **EventSource** class) that emits ETW traces by default.</span></span> <span data-ttu-id="e4407-113">Para una descripción general del seguimiento de aplicaciones de Service Fabric mediante ETW, consulte [Supervisión y diagnóstico de servicios en una configuración de desarrollo de máquina local](service-fabric-diagnostics-how-to-monitor-and-diagnose-services-locally.md).</span><span class="sxs-lookup"><span data-stu-id="e4407-113">For a general overview of Service Fabric application tracing using ETW, see [Monitoring and diagnosing services in a local machine development setup](service-fabric-diagnostics-how-to-monitor-and-diagnose-services-locally.md).</span></span>

<span data-ttu-id="e4407-114">Para que los seguimientos aparezcan en ElasticSearch, deben capturarse en los nodos de clúster de Service Fabric en tiempo real (mientras se ejecuta la aplicación) y enviarse al punto de conexión de ElasticSearch.</span><span class="sxs-lookup"><span data-stu-id="e4407-114">For the traces to show up in Elasticsearch, they need to be captured at the Service Fabric cluster nodes in real time (while the application is running) and sent to an Elasticsearch endpoint.</span></span> <span data-ttu-id="e4407-115">Hay dos opciones principales para la captura de seguimientos:</span><span class="sxs-lookup"><span data-stu-id="e4407-115">There are two major options for trace capturing:</span></span>

* <span data-ttu-id="e4407-116">**Captura de seguimientos en proceso**</span><span class="sxs-lookup"><span data-stu-id="e4407-116">**In-process trace capturing**</span></span>  
  <span data-ttu-id="e4407-117">La aplicación o, más concretamente, el proceso de servicio es responsable de enviar los datos de diagnóstico al almacén de seguimientos (ElasticSearch).</span><span class="sxs-lookup"><span data-stu-id="e4407-117">The application, or more precisely, service process, is responsible for sending out the diagnostic data to the trace store (Elasticsearch).</span></span>
* <span data-ttu-id="e4407-118">**Captura de seguimientos fuera de proceso**</span><span class="sxs-lookup"><span data-stu-id="e4407-118">**Out-of-process trace capturing**</span></span>  
  <span data-ttu-id="e4407-119">Un agente independiente captura los seguimientos de los procesos del servicio y los envía al almacén de seguimientos.</span><span class="sxs-lookup"><span data-stu-id="e4407-119">A separate agent is capturing traces from the service process or processes and sending them to the trace store.</span></span>

<span data-ttu-id="e4407-120">En el resto del artículo se describe cómo configurar ElasticSearch en Azure, se analizan los pros y los contras de ambas opciones de captura y se explica cómo configurar un servicio de Service Fabric para enviar datos a ElasticSearch.</span><span class="sxs-lookup"><span data-stu-id="e4407-120">Below, we describe how to set up Elasticsearch on Azure, discuss the pros and cons for both capture options, and explain how to configure a Service Fabric service to send data to Elasticsearch.</span></span>

## <a name="set-up-elasticsearch-on-azure"></a><span data-ttu-id="e4407-121">Configuración de ElasticSearch en Azure</span><span class="sxs-lookup"><span data-stu-id="e4407-121">Set up Elasticsearch on Azure</span></span>
<span data-ttu-id="e4407-122">La manera más sencilla de configurar el servicio ElasticSearch en Azure es mediante las [**plantillas de Azure Resource Manager**](../azure-resource-manager/resource-group-overview.md).</span><span class="sxs-lookup"><span data-stu-id="e4407-122">The most straightforward way to set up the Elasticsearch service on Azure is through [**Azure Resource Manager templates**](../azure-resource-manager/resource-group-overview.md).</span></span> <span data-ttu-id="e4407-123">Hay disponible una [plantilla del Administrador de recursos de Azure de inicio rápido para ElasticSearch](https://github.com/Azure/azure-quickstart-templates/tree/master/elasticsearch) en el repositorio de plantillas de inicio rápido de Azure.</span><span class="sxs-lookup"><span data-stu-id="e4407-123">A comprehensive [Quickstart Azure Resource Manager template for Elasticsearch](https://github.com/Azure/azure-quickstart-templates/tree/master/elasticsearch) is available from Azure Quickstart templates repository.</span></span> <span data-ttu-id="e4407-124">Esta plantilla usa cuentas de almacenamiento independiente para unidades de escalado (grupos de nodos).</span><span class="sxs-lookup"><span data-stu-id="e4407-124">This template uses separate storage accounts for scale units (groups of nodes).</span></span> <span data-ttu-id="e4407-125">También puede aprovisionar nodos de cliente y de servidor independientes con distintas configuraciones y varios números de discos de datos adjuntos.</span><span class="sxs-lookup"><span data-stu-id="e4407-125">It can also provision separate client and server nodes with different configurations and various numbers of data disks attached.</span></span>

<span data-ttu-id="e4407-126">Aquí, se usa otra plantilla, llamada **ES-MultiNode** , del [repositorio de herramientas de diagnóstico de Azure](https://github.com/Azure/azure-diagnostics-tools).</span><span class="sxs-lookup"><span data-stu-id="e4407-126">Here, we use another template, called **ES-MultiNode** from the [Azure diagnostic tools repository](https://github.com/Azure/azure-diagnostics-tools).</span></span> <span data-ttu-id="e4407-127">Esta plantilla es más fácil de usar y crea un clúster de Elasticsearch protegido mediante autenticación HTTP básica.</span><span class="sxs-lookup"><span data-stu-id="e4407-127">This template is easier to use, and it creates an Elasticsearch cluster protected by HTTP basic authentication.</span></span> <span data-ttu-id="e4407-128">Antes de continuar, descargue el repositorio de GitHub en su equipo (ya sea mediante la clonación de dicho repositorio o la descarga de un archivo ZIP).</span><span class="sxs-lookup"><span data-stu-id="e4407-128">Before you proceed, download the repository from GitHub to your machine (by either cloning the repository or downloading a zip file).</span></span> <span data-ttu-id="e4407-129">La plantilla ES-MultiNode se encuentra en la carpeta con el mismo nombre.</span><span class="sxs-lookup"><span data-stu-id="e4407-129">The ES-MultiNode template is located in the folder with the same name.</span></span>

### <a name="prepare-a-machine-to-run-elasticsearch-installation-scripts"></a><span data-ttu-id="e4407-130">Preparación de una máquina para ejecutar scripts de instalación de ElasticSearch</span><span class="sxs-lookup"><span data-stu-id="e4407-130">Prepare a machine to run Elasticsearch installation scripts</span></span>
<span data-ttu-id="e4407-131">La manera más fácil de usar la plantilla ES-MultiNode es mediante un script de Azure PowerShell llamado `CreateElasticSearchCluster`.</span><span class="sxs-lookup"><span data-stu-id="e4407-131">The easiest way to use the ES-MultiNode template is through a provided Azure PowerShell script called `CreateElasticSearchCluster`.</span></span> <span data-ttu-id="e4407-132">Para usar este script, debe instalar módulos de PowerShell y una herramienta llamada **openssl**.</span><span class="sxs-lookup"><span data-stu-id="e4407-132">To use this script, you need to install PowerShell modules and a tool called **openssl**.</span></span> <span data-ttu-id="e4407-133">Esta es necesaria para crear una clave SSH que se puede usar para administrar el clúster de ElasticSearch de forma remota.</span><span class="sxs-lookup"><span data-stu-id="e4407-133">The latter is needed for creating an SSH key that can be used to administer your Elasticsearch cluster remotely.</span></span>

<span data-ttu-id="e4407-134">`CreateElasticSearchCluster` está diseñado para facilitar su uso con la plantilla ES-MultiNode en una máquina con Windows.</span><span class="sxs-lookup"><span data-stu-id="e4407-134">`CreateElasticSearchCluster` script is designed for ease of use with the ES-MultiNode template from a Windows machine.</span></span> <span data-ttu-id="e4407-135">Se puede usar la plantilla en una máquina que no sea de Windows, pero ese escenario queda fuera del ámbito de este artículo.</span><span class="sxs-lookup"><span data-stu-id="e4407-135">It is possible to use the template on a non-Windows machine, but that scenario is beyond the scope of this article.</span></span>

1. <span data-ttu-id="e4407-136">Si aún no lo hizo, instale los [**módulos de Azure PowerShell**](http://aka.ms/webpi-azps).</span><span class="sxs-lookup"><span data-stu-id="e4407-136">If you haven't installed them already, install [**Azure PowerShell modules**](http://aka.ms/webpi-azps).</span></span> <span data-ttu-id="e4407-137">Cuando se le pida, haga clic en **Ejecutar** y, después, en **Instalar**.</span><span class="sxs-lookup"><span data-stu-id="e4407-137">When prompted, click **Run**, then **Install**.</span></span> <span data-ttu-id="e4407-138">Se requiere Azure PowerShell 1.3 o posterior.</span><span class="sxs-lookup"><span data-stu-id="e4407-138">Azure PowerShell 1.3 or newer is required.</span></span>
2. <span data-ttu-id="e4407-139">La herramienta **openssl** se incluye en la distribución de [**Git para Windows**](http://www.git-scm.com/downloads).</span><span class="sxs-lookup"><span data-stu-id="e4407-139">The **openssl** tool is included in the distribution of [**Git for Windows**](http://www.git-scm.com/downloads).</span></span> <span data-ttu-id="e4407-140">Si aún no lo hizo, instale [Git para Windows](http://www.git-scm.com/downloads) ahora.</span><span class="sxs-lookup"><span data-stu-id="e4407-140">If you have not done so already, install [Git for Windows](http://www.git-scm.com/downloads) now.</span></span> <span data-ttu-id="e4407-141">(las opciones de instalación predeterminadas son adecuadas).</span><span class="sxs-lookup"><span data-stu-id="e4407-141">(The default installation options are OK.)</span></span>
3. <span data-ttu-id="e4407-142">Si Git está instalado pero no está incluido en la ruta de acceso del sistema, abra la ventana de Microsoft Azure PowerShell y ejecute los siguientes comandos:</span><span class="sxs-lookup"><span data-stu-id="e4407-142">Assuming that Git has been installed but not included in the system path, open a Microsoft Azure PowerShell window and run the following commands:</span></span>
   
    ```powershell
    $ENV:PATH += ";<Git installation folder>\usr\bin"
    $ENV:OPENSSL_CONF = "<Git installation folder>\usr\ssl\openssl.cnf"
    ```
   
    <span data-ttu-id="e4407-143">Reemplace `<Git installation folder>` por la ubicación de Git en su equipo; el valor predeterminado es **"C:\Archivos de programa\Git"**.</span><span class="sxs-lookup"><span data-stu-id="e4407-143">Replace the `<Git installation folder>` with the Git location on your machine; the default is **"C:\Program Files\Git"**.</span></span> <span data-ttu-id="e4407-144">No olvide el carácter de punto y coma al principio de la primera ruta de acceso.</span><span class="sxs-lookup"><span data-stu-id="e4407-144">Note the semicolon character at the beginning of the first path.</span></span>
4. <span data-ttu-id="e4407-145">Asegúrese de iniciar sesión en Azure (mediante el cmdlet [`Add-AzureRmAccount`](https://msdn.microsoft.com/library/mt619267.aspx) ) y de seleccionar la suscripción que se debe usar para crear el clúster de Elasticsearch.</span><span class="sxs-lookup"><span data-stu-id="e4407-145">Ensure that you are logged on to Azure (via [`Add-AzureRmAccount`](https://msdn.microsoft.com/library/mt619267.aspx) cmdlet) and that you have selected the subscription that should be used to create your Elastic Search cluster.</span></span> <span data-ttu-id="e4407-146">Puede comprobar que se ha seleccionado la suscripción correcta utilizando los cmdlets `Get-AzureRmContext` y `Get-AzureRmSubscription`.</span><span class="sxs-lookup"><span data-stu-id="e4407-146">You can verify that correct subscription is selected using `Get-AzureRmContext` and `Get-AzureRmSubscription` cmdlets.</span></span>
5. <span data-ttu-id="e4407-147">Si aún no lo hizo, cambie el directorio actual a la carpeta ES-MultiNode.</span><span class="sxs-lookup"><span data-stu-id="e4407-147">If you haven't done so already, change the current directory to the ES-MultiNode folder.</span></span>

### <a name="run-the-createelasticsearchcluster-script"></a><span data-ttu-id="e4407-148">Ejecución del script CreateElasticSearchCluster</span><span class="sxs-lookup"><span data-stu-id="e4407-148">Run the CreateElasticSearchCluster script</span></span>
<span data-ttu-id="e4407-149">Antes de ejecutar el script, abra el archivo `azuredeploy-parameters.json` y compruebe o indique los valores de los parámetros del script.</span><span class="sxs-lookup"><span data-stu-id="e4407-149">Before you run the script, open the `azuredeploy-parameters.json` file and verify or provide values for the script parameters.</span></span> <span data-ttu-id="e4407-150">Se proporcionan los parámetros siguientes:</span><span class="sxs-lookup"><span data-stu-id="e4407-150">The following parameters are provided:</span></span>

| <span data-ttu-id="e4407-151">Nombre de parámetro</span><span class="sxs-lookup"><span data-stu-id="e4407-151">Parameter Name</span></span> | <span data-ttu-id="e4407-152">Description</span><span class="sxs-lookup"><span data-stu-id="e4407-152">Description</span></span> |
| --- | --- |
| <span data-ttu-id="e4407-153">dnsNameForLoadBalancerIP</span><span class="sxs-lookup"><span data-stu-id="e4407-153">dnsNameForLoadBalancerIP</span></span> |<span data-ttu-id="e4407-154">El nombre que se usa para crear el nombre DNS públicamente visible del clúster de Elasticsearch (anexando el dominio de la región de Azure al nombre proporcionado).</span><span class="sxs-lookup"><span data-stu-id="e4407-154">The name that is used to create the publicly visible DNS name for the Elastic Search cluster (by appending the Azure region domain to the provided name).</span></span> <span data-ttu-id="e4407-155">Por ejemplo, si el valor de este parámetro es "myBigCluster" y la región de Azure elegida corresponde al oeste de EE. UU., el nombre DNS resultante del clúster será myBigCluster.westus.cloudapp.azure.com.</span><span class="sxs-lookup"><span data-stu-id="e4407-155">For example, if this parameter value is "myBigCluster" and the chosen Azure region is West US, the resulting DNS name for the cluster is myBigCluster.westus.cloudapp.azure.com.</span></span> <br /><br /><span data-ttu-id="e4407-156">Este nombre también sirve como raíz para los nombres de numerosos artefactos asociados con el clúster de Elasticsearch, como los nombres de nodos de datos.</span><span class="sxs-lookup"><span data-stu-id="e4407-156">This name also serves as a root name for many artifacts associated with the Elastic Search cluster, such as data node names.</span></span> |
| <span data-ttu-id="e4407-157">adminUsername</span><span class="sxs-lookup"><span data-stu-id="e4407-157">adminUsername</span></span> |<span data-ttu-id="e4407-158">Nombre de la cuenta de administrador para administrar el clúster de Elasticsearch (las claves SSH correspondientes se generan automáticamente).</span><span class="sxs-lookup"><span data-stu-id="e4407-158">The name of the administrator account for managing the Elastic Search cluster (corresponding SSH keys are generated automatically).</span></span> |
| <span data-ttu-id="e4407-159">dataNodeCount</span><span class="sxs-lookup"><span data-stu-id="e4407-159">dataNodeCount</span></span> |<span data-ttu-id="e4407-160">Número de nodos del clúster de Elastic Search.</span><span class="sxs-lookup"><span data-stu-id="e4407-160">The number of nodes in the Elastic Search cluster.</span></span> <span data-ttu-id="e4407-161">La versión actual del script no distingue entre los nodos de datos y de consulta: todos los nodos representan ambos roles.</span><span class="sxs-lookup"><span data-stu-id="e4407-161">The current version of the script does not distinguish between data and query nodes; all nodes play both roles.</span></span> <span data-ttu-id="e4407-162">El valor predeterminado son 3 nodos.</span><span class="sxs-lookup"><span data-stu-id="e4407-162">Defaults to 3 nodes.</span></span> |
| <span data-ttu-id="e4407-163">dataDiskSize</span><span class="sxs-lookup"><span data-stu-id="e4407-163">dataDiskSize</span></span> |<span data-ttu-id="e4407-164">El tamaño de los discos de datos (en GB) que se va a asignar a cada nodo de datos.</span><span class="sxs-lookup"><span data-stu-id="e4407-164">The size of data disks (in GB) that is allocated for each data node.</span></span> <span data-ttu-id="e4407-165">Cada nodo recibe 4 discos de datos dedicados exclusivamente al servicio Elasticsearch.</span><span class="sxs-lookup"><span data-stu-id="e4407-165">Each node receives 4 data disks, exclusively dedicated to Elastic Search service.</span></span> |
| <span data-ttu-id="e4407-166">region</span><span class="sxs-lookup"><span data-stu-id="e4407-166">region</span></span> |<span data-ttu-id="e4407-167">Nombre de la región de Azure donde se debe ubicar el clúster de Elastic Search.</span><span class="sxs-lookup"><span data-stu-id="e4407-167">The name of Azure region where the Elastic Search cluster should be located.</span></span> |
| <span data-ttu-id="e4407-168">esUserName</span><span class="sxs-lookup"><span data-stu-id="e4407-168">esUserName</span></span> |<span data-ttu-id="e4407-169">El nombre del usuario que se configura para acceder al clúster ES (de acuerdo con la autenticación HTTP básica).</span><span class="sxs-lookup"><span data-stu-id="e4407-169">The user name of the user that is configured to have access to ES cluster (subject to HTTP basic authentication).</span></span> <span data-ttu-id="e4407-170">La contraseña no forma parte del archivo de parámetros y debe proporcionarse cuando se invoca el script `CreateElasticSearchCluster` .</span><span class="sxs-lookup"><span data-stu-id="e4407-170">The password is not part of parameters file and must be provided when `CreateElasticSearchCluster` script is invoked.</span></span> |
| <span data-ttu-id="e4407-171">vmSizeDataNodes</span><span class="sxs-lookup"><span data-stu-id="e4407-171">vmSizeDataNodes</span></span> |<span data-ttu-id="e4407-172">Tamaño de la máquina virtual de Azure para nodos de clúster de Elastic Search.</span><span class="sxs-lookup"><span data-stu-id="e4407-172">The Azure virtual machine size for Elastic Search cluster nodes.</span></span> <span data-ttu-id="e4407-173">El valor predeterminado es Standard_D2.</span><span class="sxs-lookup"><span data-stu-id="e4407-173">Defaults to Standard_D2.</span></span> |

<span data-ttu-id="e4407-174">Ya está preparado para ejecutar el script.</span><span class="sxs-lookup"><span data-stu-id="e4407-174">Now you are ready to run the script.</span></span> <span data-ttu-id="e4407-175">Ejecute el siguiente comando:</span><span class="sxs-lookup"><span data-stu-id="e4407-175">Issue the following command:</span></span>

```powershell
CreateElasticSearchCluster -ResourceGroupName <es-group-name> -Region <azure-region> -EsPassword <es-password>
```

<span data-ttu-id="e4407-176">donde</span><span class="sxs-lookup"><span data-stu-id="e4407-176">where</span></span> 

| <span data-ttu-id="e4407-177">Nombre del parámetro de script</span><span class="sxs-lookup"><span data-stu-id="e4407-177">Script Parameter Name</span></span> | <span data-ttu-id="e4407-178">Description</span><span class="sxs-lookup"><span data-stu-id="e4407-178">Description</span></span> |
| --- | --- |
| `<es-group-name>` |<span data-ttu-id="e4407-179">El nombre del grupo de recursos de Azure que contendrá todos los recursos del clúster de Elasticsearch.</span><span class="sxs-lookup"><span data-stu-id="e4407-179">The name of the Azure resource group that will contain all Elastic Search cluster resources.</span></span> |
| `<azure-region>` |<span data-ttu-id="e4407-180">El nombre de la región de Azure en la que se debe crear el clúster de Elasticsearch.</span><span class="sxs-lookup"><span data-stu-id="e4407-180">The name of the Azure region where the Elastic Search cluster should be created.</span></span> |
| `<es-password>` |<span data-ttu-id="e4407-181">La contraseña del usuario de Elasticsearch.</span><span class="sxs-lookup"><span data-stu-id="e4407-181">The password for the Elastic Search user.</span></span> |

> [!NOTE]
> <span data-ttu-id="e4407-182">Si recibe una excepción NullReferenceException del cmdlet Test-AzureResourceGroup, significa que olvidó iniciar sesión en Azure (`Add-AzureRmAccount`).</span><span class="sxs-lookup"><span data-stu-id="e4407-182">If you get a NullReferenceException from the Test-AzureResourceGroup cmdlet, you have forgotten to log on to Azure (`Add-AzureRmAccount`).</span></span>
> 
> 

<span data-ttu-id="e4407-183">Si recibe un error de ejecución del script y determina que la causa del error es un valor incorrecto del parámetro de plantilla, corrija el archivo de parámetros y ejecute de nuevo el script con un nombre de grupo de recursos distinto.</span><span class="sxs-lookup"><span data-stu-id="e4407-183">If you get an error from running the script and you determine that the error was caused by a wrong template parameter value, correct the parameter file and run the script again with a different resource group name.</span></span> <span data-ttu-id="e4407-184">También puede volver a usar el mismo nombre de grupo de recursos y hacer que el script limpie el antiguo agregando el parámetro `-RemoveExistingResourceGroup` a la invocación del script.</span><span class="sxs-lookup"><span data-stu-id="e4407-184">You can also reuse the same resource group name and have the script clean up the old one by adding the `-RemoveExistingResourceGroup` parameter to the script invocation.</span></span>

### <a name="result-of-running-the-createelasticsearchcluster-script"></a><span data-ttu-id="e4407-185">Resultado de ejecutar el script CreateElasticSearchCluster</span><span class="sxs-lookup"><span data-stu-id="e4407-185">Result of running the CreateElasticSearchCluster script</span></span>
<span data-ttu-id="e4407-186">Después de ejecutar el script `CreateElasticSearchCluster`, se crearán los siguientes artefactos principales.</span><span class="sxs-lookup"><span data-stu-id="e4407-186">After you run the `CreateElasticSearchCluster` script, the following main artifacts will be created.</span></span> <span data-ttu-id="e4407-187">En este ejemplo, se asume que ha usado "myBigCluster" como valor del parámetro `dnsNameForLoadBalancerIP` y que la región donde ha creado el clúster es el oeste de EE. UU.</span><span class="sxs-lookup"><span data-stu-id="e4407-187">For this example we assume that you have used "myBigCluster" as the value of the `dnsNameForLoadBalancerIP` parameter and that the region where you created the cluster is West US.</span></span>

| <span data-ttu-id="e4407-188">Artefacto</span><span class="sxs-lookup"><span data-stu-id="e4407-188">Artifact</span></span> | <span data-ttu-id="e4407-189">Nombre, ubicación y comentarios</span><span class="sxs-lookup"><span data-stu-id="e4407-189">Name, location, and remarks</span></span> |
| --- | --- |
| <span data-ttu-id="e4407-190">Clave SSH para administración remota</span><span class="sxs-lookup"><span data-stu-id="e4407-190">SSH key for remote administration</span></span> |<span data-ttu-id="e4407-191">Archivo myBigCluster.key (en el directorio desde el que se ejecutó CreateElasticSearchCluster).</span><span class="sxs-lookup"><span data-stu-id="e4407-191">myBigCluster.key file (in the directory from which the CreateElasticSearchCluster was run).</span></span> <br /><br /><span data-ttu-id="e4407-192">Este es el archivo de clave que se puede usar para conectar con el nodo de administración y, mediante este último, con los nodos de datos del clúster.</span><span class="sxs-lookup"><span data-stu-id="e4407-192">This key file can be used to connect to the admin node and (through the admin node) to data nodes in the cluster.</span></span> |
| <span data-ttu-id="e4407-193">Nodo de administración</span><span class="sxs-lookup"><span data-stu-id="e4407-193">Admin node</span></span> |<span data-ttu-id="e4407-194">myBigCluster-admin.westus.cloudapp.azure.com </span><span class="sxs-lookup"><span data-stu-id="e4407-194">myBigCluster-admin.westus.cloudapp.azure.com</span></span> <br /><br /><span data-ttu-id="e4407-195">Una VM dedicada para la administración remota de clústeres de Elasticsearch, la única que permite conexiones SSH externas.</span><span class="sxs-lookup"><span data-stu-id="e4407-195">A dedicated VM for remote Elasticsearch cluster administration--the only one that allows external SSH connections.</span></span> <span data-ttu-id="e4407-196">Se ejecuta en la misma red virtual que todos los nodos de clúster de Elasticsearch, pero no ejecuta servicios Elasticsearch.</span><span class="sxs-lookup"><span data-stu-id="e4407-196">It runs on the same virtual network as all the Elasticsearch cluster nodes, but it does not run any Elasticsearch services.</span></span> |
| <span data-ttu-id="e4407-197">Nodos de datos</span><span class="sxs-lookup"><span data-stu-id="e4407-197">Data nodes</span></span> |<span data-ttu-id="e4407-198">myBigCluster1 …</span><span class="sxs-lookup"><span data-stu-id="e4407-198">myBigCluster1 …</span></span> <span data-ttu-id="e4407-199">myBigCluster*N*</span><span class="sxs-lookup"><span data-stu-id="e4407-199">myBigCluster*N*</span></span> <br /><br /><span data-ttu-id="e4407-200">Nodos de datos que ejecutan servicios Elasticsearch y Kibana.</span><span class="sxs-lookup"><span data-stu-id="e4407-200">Data nodes that are running Elasticsearch and Kibana services.</span></span> <span data-ttu-id="e4407-201">Puede conectarse mediante SSH a cada nodo, pero solo mediante el nodo de administración.</span><span class="sxs-lookup"><span data-stu-id="e4407-201">You can connect via SSH to each node, but only via the admin node.</span></span> |
| <span data-ttu-id="e4407-202">Clúster Elasticsearch</span><span class="sxs-lookup"><span data-stu-id="e4407-202">Elasticsearch cluster</span></span> |<span data-ttu-id="e4407-203">http://myBigCluster.westus.cloudapp.azure.com/es/</span><span class="sxs-lookup"><span data-stu-id="e4407-203">http://myBigCluster.westus.cloudapp.azure.com/es/</span></span> <br /><br /><span data-ttu-id="e4407-204">El punto de conexión principal del clúster de Elasticsearch (observe el sufijo /es).</span><span class="sxs-lookup"><span data-stu-id="e4407-204">The primary endpoint for the Elasticsearch cluster (note the /es suffix).</span></span> <span data-ttu-id="e4407-205">Está protegido por autenticación HTTP básica (las credenciales son los parámetros esUserName/esPassword especificados en la plantilla ES-MultiNode).</span><span class="sxs-lookup"><span data-stu-id="e4407-205">It is protected by basic HTTP authentication (the credentials were the specified esUserName/esPassword parameters of the ES-MultiNode template).</span></span> <span data-ttu-id="e4407-206">El clúster tiene también el complemento de encabezado instalado (http://myBigCluster.westus.cloudapp.azure.com/es/_plugin/head) para la administración básica de clústeres.</span><span class="sxs-lookup"><span data-stu-id="e4407-206">The cluster has also the head plug-in installed (http://myBigCluster.westus.cloudapp.azure.com/es/_plugin/head) for basic cluster administration.</span></span> |
| <span data-ttu-id="e4407-207">Servicio Kibana</span><span class="sxs-lookup"><span data-stu-id="e4407-207">Kibana service</span></span> |<span data-ttu-id="e4407-208">http://myBigCluster.westus.cloudapp.azure.com</span><span class="sxs-lookup"><span data-stu-id="e4407-208">http://myBigCluster.westus.cloudapp.azure.com</span></span> <br /><br /><span data-ttu-id="e4407-209">El servicio Kibana está configurado para mostrar datos del clúster de Elasticsearch creado.</span><span class="sxs-lookup"><span data-stu-id="e4407-209">The Kibana service is set up to show data from the created Elasticsearch cluster.</span></span> <span data-ttu-id="e4407-210">Está protegido por las mismas credenciales de autenticación que el propio clúster.</span><span class="sxs-lookup"><span data-stu-id="e4407-210">It is protected by the same authentication credentials as the cluster itself.</span></span> |

## <a name="in-process-versus-out-of-process-trace-capturing"></a><span data-ttu-id="e4407-211">Captura de seguimientos en proceso frente a fuera de proceso</span><span class="sxs-lookup"><span data-stu-id="e4407-211">In-process versus out-of-process trace capturing</span></span>
<span data-ttu-id="e4407-212">En la introducción mencionamos dos formas básicas de recopilar datos de diagnóstico: en proceso y fuera de proceso.</span><span class="sxs-lookup"><span data-stu-id="e4407-212">In the introduction, we mentioned two fundamental ways of collecting diagnostic data: in-process and out-of-process.</span></span> <span data-ttu-id="e4407-213">Cada una tiene sus ventajas y desventajas.</span><span class="sxs-lookup"><span data-stu-id="e4407-213">Each has strengths and weaknesses.</span></span>

<span data-ttu-id="e4407-214">Las ventajas de la **captura de seguimientos en proceso** son:</span><span class="sxs-lookup"><span data-stu-id="e4407-214">Advantages of the **in-process trace capturing** include:</span></span>

1. <span data-ttu-id="e4407-215">*Fácil configuración e implementación*</span><span class="sxs-lookup"><span data-stu-id="e4407-215">*Easy configuration and deployment*</span></span>
   
   * <span data-ttu-id="e4407-216">La configuración de recopilación de datos de diagnóstico es parte de la configuración de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="e4407-216">The configuration of diagnostic data collection is just part of the application configuration.</span></span> <span data-ttu-id="e4407-217">Es fácil mantenerla siempre "sincronizada" con el resto de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="e4407-217">It is easy to always keep it "in sync" with the rest of the application.</span></span>
   * <span data-ttu-id="e4407-218">Se puede realizar fácilmente la configuración por aplicación o por servicio.</span><span class="sxs-lookup"><span data-stu-id="e4407-218">Per-application or per-service configuration is easily achievable.</span></span>
   * <span data-ttu-id="e4407-219">La captura de seguimientos fuera de proceso normalmente requiere una implementación y configuración independientes del agente de diagnóstico, lo que supone una tarea administrativa adicional y una posible fuente de errores.</span><span class="sxs-lookup"><span data-stu-id="e4407-219">Out-of-process trace capturing usually requires a separate deployment and configuration of the diagnostic agent, which is an extra administrative task and a potential source of errors.</span></span> <span data-ttu-id="e4407-220">A menudo, la tecnología del agente particular permite solo una instancia del agente por máquina virtual (nodo).</span><span class="sxs-lookup"><span data-stu-id="e4407-220">The particular agent technology often allows only one instance of the agent per virtual machine (node).</span></span> <span data-ttu-id="e4407-221">Esto significa que la configuración de recopilación de la configuración de diagnóstico se comparte entre todas las aplicaciones y servicios que se ejecutan en ese nodo.</span><span class="sxs-lookup"><span data-stu-id="e4407-221">This means that configuration for the collection of the diagnostic configuration is shared among all applications and services running on that node.</span></span>
2. <span data-ttu-id="e4407-222">*Flexibilidad*</span><span class="sxs-lookup"><span data-stu-id="e4407-222">*Flexibility*</span></span>
   
   * <span data-ttu-id="e4407-223">La aplicación puede enviar los datos dondequiera que deban ir siempre que haya una biblioteca de cliente que admita el sistema de almacenamiento de datos de destino.</span><span class="sxs-lookup"><span data-stu-id="e4407-223">The application can send the data wherever it needs to go, as long as there is a client library that supports the targeted data storage system.</span></span> <span data-ttu-id="e4407-224">Se pueden agregar tantos receptores nuevos como se desee.</span><span class="sxs-lookup"><span data-stu-id="e4407-224">New sinks can be added as desired.</span></span>
   * <span data-ttu-id="e4407-225">Se pueden implementar reglas complejas de captura, filtrado y agregación de datos.</span><span class="sxs-lookup"><span data-stu-id="e4407-225">Complex capture, filtering, and data-aggregation rules can be implemented.</span></span>
   * <span data-ttu-id="e4407-226">Una captura de seguimientos fuera de proceso a menudo está limitada por los receptores de datos que admite el agente.</span><span class="sxs-lookup"><span data-stu-id="e4407-226">An out-of-process trace capturing is often limited by the data sinks that the agent supports.</span></span> <span data-ttu-id="e4407-227">Algunos agentes se pueden ampliar.</span><span class="sxs-lookup"><span data-stu-id="e4407-227">Some agents are extensible.</span></span>
3. <span data-ttu-id="e4407-228">*Acceso a los datos y el contexto internos de la aplicación*</span><span class="sxs-lookup"><span data-stu-id="e4407-228">*Access to internal application data and context*</span></span>
   
   * <span data-ttu-id="e4407-229">El subsistema de diagnóstico que se ejecuta dentro del proceso de la aplicación o servicio puede ampliar fácilmente los seguimientos con información contextual.</span><span class="sxs-lookup"><span data-stu-id="e4407-229">The diagnostic subsystem running inside the application/service process can easily augment the traces with contextual information.</span></span>
   * <span data-ttu-id="e4407-230">En el método fuera de proceso, los datos se deben enviar a un agente mediante algún mecanismo de comunicación entre procesos, como el Seguimiento de eventos para Windows.</span><span class="sxs-lookup"><span data-stu-id="e4407-230">In the out-of-process approach, the data must be sent to an agent via some inter-process communication mechanism, such as Event Tracing for Windows.</span></span> <span data-ttu-id="e4407-231">Este mecanismo podría imponer limitaciones adicionales.</span><span class="sxs-lookup"><span data-stu-id="e4407-231">This mechanism could impose additional limitations.</span></span>

<span data-ttu-id="e4407-232">Las ventajas de la **captura de seguimientos fuera de proceso** son:</span><span class="sxs-lookup"><span data-stu-id="e4407-232">Advantages of the **out-of-process trace capturing** include:</span></span>

1. <span data-ttu-id="e4407-233">*Capacidad para supervisar la aplicación y recopilar volcados de memoria*</span><span class="sxs-lookup"><span data-stu-id="e4407-233">*The ability to monitor the application and collect crash dumps*</span></span>
   
   * <span data-ttu-id="e4407-234">Se puede producir un error en la captura de seguimientos en proceso si la aplicación no se inicia o se bloquea.</span><span class="sxs-lookup"><span data-stu-id="e4407-234">In-process trace capturing may be unsuccessful if the application fails to start or crashes.</span></span> <span data-ttu-id="e4407-235">Un agente independiente tiene muchas más probabilidades de capturar información crucial de solución de problemas.</span><span class="sxs-lookup"><span data-stu-id="e4407-235">An independent agent has a much better chance of capturing crucial troubleshooting information.</span></span><br /><br />
2. <span data-ttu-id="e4407-236">*Madurez, solidez y rendimiento probado*</span><span class="sxs-lookup"><span data-stu-id="e4407-236">*Maturity, robustness, and proven performance*</span></span>
   
   * <span data-ttu-id="e4407-237">Se sometió a rigurosas pruebas y refuerzos a un agente desarrollado por el proveedor de la plataforma (por ejemplo, el agente de Diagnósticos de Microsoft Azure).</span><span class="sxs-lookup"><span data-stu-id="e4407-237">An agent developed by a platform vendor (such as a Microsoft Azure Diagnostics agent) has been subject to rigorous testing and battle-hardening.</span></span>
   * <span data-ttu-id="e4407-238">Con la captura de seguimientos en proceso, hay que tener cuidado y asegurarse de que la actividad de envío de datos de diagnóstico desde un proceso de aplicación no interfiera con las tareas principales de la aplicación y no presente problemas de rendimiento o de temporización.</span><span class="sxs-lookup"><span data-stu-id="e4407-238">With in-process trace capturing, care must be taken to ensure that the activity of sending diagnostic data from an application process does not interfere with the application's main tasks or introduce timing or performance problems.</span></span> <span data-ttu-id="e4407-239">Un agente que se ejecuta de forma independiente es menos propenso a estos problemas y está específicamente diseñado para limitar su impacto en el sistema.</span><span class="sxs-lookup"><span data-stu-id="e4407-239">An independently running agent is less prone to these issues and is specifically designed to limit its impact on the system.</span></span>

<span data-ttu-id="e4407-240">Por supuesto, es posible combinar y beneficiarse de ambos enfoques;</span><span class="sxs-lookup"><span data-stu-id="e4407-240">It is possible to combine and benefit from both approaches.</span></span> <span data-ttu-id="e4407-241">de hecho, puede que sea la mejor solución para muchas aplicaciones.</span><span class="sxs-lookup"><span data-stu-id="e4407-241">Indeed, it might be the best solution for many applications.</span></span>

<span data-ttu-id="e4407-242">En este artículo, se usa la **biblioteca Microsoft.Diagnostic.Listeners** y la característica de captura de seguimientos en proceso para enviar datos desde una aplicación de Service Fabric hasta un clúster de Elasticsearch.</span><span class="sxs-lookup"><span data-stu-id="e4407-242">Here, we use the **Microsoft.Diagnostic.Listeners library** and the in-process trace capturing to send data from a Service Fabric application to an Elasticsearch cluster.</span></span>

## <a name="use-the-listeners-library-to-send-diagnostic-data-to-elasticsearch"></a><span data-ttu-id="e4407-243">Uso de la biblioteca de agentes de escucha para enviar datos de diagnóstico a ElasticSearch</span><span class="sxs-lookup"><span data-stu-id="e4407-243">Use the Listeners library to send diagnostic data to Elasticsearch</span></span>
<span data-ttu-id="e4407-244">La biblioteca Microsoft.Diagnostic.Listeners forma parte de la aplicación de clúster de Service Fabric de ejemplo.</span><span class="sxs-lookup"><span data-stu-id="e4407-244">The Microsoft.Diagnostic.Listeners library is part of PartyCluster sample Service Fabric application.</span></span> <span data-ttu-id="e4407-245">Para usarla:</span><span class="sxs-lookup"><span data-stu-id="e4407-245">To use it:</span></span>

1. <span data-ttu-id="e4407-246">Descargue [el ejemplo de PartyCluster](https://github.com/Azure-Samples/service-fabric-dotnet-management-party-cluster) desde GitHub.</span><span class="sxs-lookup"><span data-stu-id="e4407-246">Download [the PartyCluster sample](https://github.com/Azure-Samples/service-fabric-dotnet-management-party-cluster) from GitHub.</span></span>
2. <span data-ttu-id="e4407-247">Copie los proyectos Microsoft.Diagnostics.Listeners y Microsoft.Diagnostics.Listeners.Fabric (las carpetas completas) desde el directorio del ejemplo de PartyCluster a la carpeta de solución de la aplicación que se supone que debe enviar los datos a ElasticSearch.</span><span class="sxs-lookup"><span data-stu-id="e4407-247">Copy the Microsoft.Diagnostics.Listeners and Microsoft.Diagnostics.Listeners.Fabric projects (whole folders) from the PartyCluster sample directory to the solution folder of the application that is supposed to send the data to Elasticsearch.</span></span>
3. <span data-ttu-id="e4407-248">Abra la solución de destino, haga clic con el botón derecho en el nodo de solución del Explorador de soluciones y elija **Agregar proyecto existente**.</span><span class="sxs-lookup"><span data-stu-id="e4407-248">Open the target solution, right-click the solution node in the Solution Explorer, and choose **Add Existing Project**.</span></span> <span data-ttu-id="e4407-249">Agregue el proyecto Microsoft.Diagnostics.Listeners a la solución.</span><span class="sxs-lookup"><span data-stu-id="e4407-249">Add the Microsoft.Diagnostics.Listeners project to the solution.</span></span> <span data-ttu-id="e4407-250">Repita lo mismo para el proyecto Microsoft.Diagnostics.Listeners.Fabric.</span><span class="sxs-lookup"><span data-stu-id="e4407-250">Repeat the same for the Microsoft.Diagnostics.Listeners.Fabric project.</span></span>
4. <span data-ttu-id="e4407-251">Agregue una referencia de proyecto desde sus proyectos de servicio a los dos proyectos agregados</span><span class="sxs-lookup"><span data-stu-id="e4407-251">Add a project reference from your service project(s) to the two added projects.</span></span> <span data-ttu-id="e4407-252">(cada servicio que debe enviar datos a ElasticSearch deberá hacer referencia a Microsoft.Diagnostics.EventListeners y Microsoft.Diagnostics.EventListeners.Fabric).</span><span class="sxs-lookup"><span data-stu-id="e4407-252">(Each service that is supposed to send data to Elasticsearch should reference Microsoft.Diagnostics.EventListeners and Microsoft.Diagnostics.EventListeners.Fabric).</span></span>
   
    ![Referencias de proyecto a las bibliotecas Microsoft.Diagnostics.EventListeners y Microsoft.Diagnostics.EventListeners.Fabric.][1]

### <a name="service-fabric-general-availability-release-and-microsoftdiagnosticstracing-nuget-package"></a><span data-ttu-id="e4407-254">Versión de disponibilidad general de Service Fabric y paquete NuGet Microsoft.Diagnostics.Tracing</span><span class="sxs-lookup"><span data-stu-id="e4407-254">Service Fabric General Availability release and Microsoft.Diagnostics.Tracing Nuget package</span></span>
<span data-ttu-id="e4407-255">Las aplicaciones creadas con la versión de disponibilidad general de Service Fabric (2.0.135, publicada el 31 de marzo de 2016) están destinadas a **.NET Framework 4.5.2**.</span><span class="sxs-lookup"><span data-stu-id="e4407-255">Applications built with Service Fabric General Availability release (2.0.135, released March 31, 2016) target **.NET Framework 4.5.2**.</span></span> <span data-ttu-id="e4407-256">Se trata de la última versión de .NET Framework compatible con Azure en el momento de publicar la versión de disponibilidad general.</span><span class="sxs-lookup"><span data-stu-id="e4407-256">This version is the highest version of the .NET Framework supported by Azure at the time of the GA release.</span></span> <span data-ttu-id="e4407-257">Lamentablemente, esta versión de Framework carece de ciertas API de EventListener que la biblioteca Microsoft.Diagnostics.Listeners necesita.</span><span class="sxs-lookup"><span data-stu-id="e4407-257">Unfortunately, this version of the framework lacks certain EventListener APIs that the Microsoft.Diagnostics.Listeners library needs.</span></span> <span data-ttu-id="e4407-258">Como EventSource (el componente que constituye la base de las API de registro en las aplicaciones de Fabric) y EventListener están estrechamente relacionados, cada proyecto que use la biblioteca Microsoft.Diagnostics.Listeners debe usar una implementación alternativa de EventSource,</span><span class="sxs-lookup"><span data-stu-id="e4407-258">Because EventSource (the component that forms the basis of logging APIs in Fabric applications) and EventListener are tightly coupled, every project that uses the Microsoft.Diagnostics.Listeners library must use an alternative implementation of EventSource.</span></span> <span data-ttu-id="e4407-259">que la proporciona el **paquete NuGet Microsoft.Diagnostics.Tracing** creado por Microsoft.</span><span class="sxs-lookup"><span data-stu-id="e4407-259">This implementation is provided by the **Microsoft.Diagnostics.Tracing Nuget package**, authored by Microsoft.</span></span> <span data-ttu-id="e4407-260">Este paquete es totalmente compatible con la versión anterior de EventSource incluida en Framework, por lo que no se necesitan cambios en el código salvo los cambios de espacio de nombres indicados.</span><span class="sxs-lookup"><span data-stu-id="e4407-260">The package is fully backward-compatible with EventSource included in the framework, so no code changes should be necessary other than referenced namespace changes.</span></span>

<span data-ttu-id="e4407-261">Para empezar a usar la implementación para Microsoft.Diagnostics.Tracing de la clase EventSource, siga estos pasos para cada proyecto de servicio que necesite enviar datos a ElasticSearch:</span><span class="sxs-lookup"><span data-stu-id="e4407-261">To start using the Microsoft.Diagnostics.Tracing implementation of the EventSource class, follow these steps for each service project that needs to send data to Elasticsearch:</span></span>

1. <span data-ttu-id="e4407-262">Haga clic con el botón derecho en el proyecto de servicio y elija **Administrar paquetes NuGet**.</span><span class="sxs-lookup"><span data-stu-id="e4407-262">Right-click on the service project and choose **Manage Nuget Packages**.</span></span>
2. <span data-ttu-id="e4407-263">Cambie al origen del paquete nuget.org (si no está ya seleccionado) y busque "**Microsoft.Diagnostics.Tracing**".</span><span class="sxs-lookup"><span data-stu-id="e4407-263">Switch to the nuget.org package source (if it is not already selected) and search for "**Microsoft.Diagnostics.Tracing**".</span></span>
3. <span data-ttu-id="e4407-264">Instale el paquete `Microsoft.Diagnostics.Tracing.EventSource` (y sus dependencias).</span><span class="sxs-lookup"><span data-stu-id="e4407-264">Install the `Microsoft.Diagnostics.Tracing.EventSource` package (and its dependencies).</span></span>
4. <span data-ttu-id="e4407-265">Abra el archivo **ServiceEventSource.cs** o **ActorEventSource.cs** en el proyecto de servicio y reemplace la directiva `using System.Diagnostics.Tracing` de la parte superior del archivo por la directiva `using Microsoft.Diagnostics.Tracing`.</span><span class="sxs-lookup"><span data-stu-id="e4407-265">Open the **ServiceEventSource.cs** or **ActorEventSource.cs** file in your service project and replace the `using System.Diagnostics.Tracing` directive on top of the file with the `using Microsoft.Diagnostics.Tracing` directive.</span></span>

<span data-ttu-id="e4407-266">No habrá que realizar estos pasos cuando **.NET Framework 4.6** sea compatible con Microsoft Azure.</span><span class="sxs-lookup"><span data-stu-id="e4407-266">These steps will not be necessary once the **.NET Framework 4.6** is supported by Microsoft Azure.</span></span>

### <a name="elasticsearch-listener-instantiation-and-configuration"></a><span data-ttu-id="e4407-267">Configuración y creación de instancias del agente de escucha de ElasticSearch</span><span class="sxs-lookup"><span data-stu-id="e4407-267">Elasticsearch listener instantiation and configuration</span></span>
<span data-ttu-id="e4407-268">El último paso para enviar datos de diagnóstico a Elastic Search es crear una instancia de `ElasticSearchListener` y configurarla con datos de conexión de Elasticsearch.</span><span class="sxs-lookup"><span data-stu-id="e4407-268">The final step for sending diagnostic data to Elasticsearch is to create an instance of `ElasticSearchListener` and configure it with Elasticsearch connection data.</span></span> <span data-ttu-id="e4407-269">El agente de escucha captura automáticamente todos los eventos generados mediante las clases EventSource definidas en el proyecto de servicio.</span><span class="sxs-lookup"><span data-stu-id="e4407-269">The listener automatically captures all events raised via EventSource classes defined in the service project.</span></span> <span data-ttu-id="e4407-270">Debe estar activa durante toda la vida del servicio, por lo que el mejor lugar para crearla es en el código de inicialización del servicio.</span><span class="sxs-lookup"><span data-stu-id="e4407-270">It needs to be alive during the lifetime of the service, so the best place to create it is in the service initialization code.</span></span> <span data-ttu-id="e4407-271">Este es el aspecto que podría tener el código de inicialización para un servicio sin estado después de los cambios necesarios (las incorporaciones se indican en los comentarios que comienzan con `****`):</span><span class="sxs-lookup"><span data-stu-id="e4407-271">Here is how the initialization code for a stateless service could look after the necessary changes (additions pointed out in comments starting with `****`):</span></span>

```csharp
using System;
using System.Diagnostics;
using System.Fabric;
using System.Threading;
using System.Threading.Tasks;
using Microsoft.ServiceFabric.Services.Runtime;

// **** Add the following directives
using Microsoft.Diagnostics.EventListeners;
using Microsoft.Diagnostics.EventListeners.Fabric;

namespace Stateless1
{
    internal static class Program
    {
        /// <summary>
        /// This is the entry point of the service host process.
        /// </summary>        
        private static void Main()
        {
            try
            {
                // **** Instantiate ElasticSearchListener
                var configProvider = new FabricConfigurationProvider("ElasticSearchEventListener");
                ElasticSearchListener esListener = null;
                if (configProvider.HasConfiguration)
                {
                    esListener = new ElasticSearchListener(configProvider, new FabricHealthReporter("ElasticSearchEventListener"));
                }

                // The ServiceManifest.XML file defines one or more service type names.
                // Registering a service maps a service type name to a .NET type.
                // When Service Fabric creates an instance of this service type,
                // an instance of the class is created in this host process.

                ServiceRuntime.RegisterServiceAsync("Stateless1Type", 
                    context => new Stateless1(context)).GetAwaiter().GetResult();

                ServiceEventSource.Current.ServiceTypeRegistered(Process.GetCurrentProcess().Id, typeof(Stateless1).Name);

                // Prevents this host process from terminating so services keep running.
                Thread.Sleep(Timeout.Infinite);

                // **** Ensure that the ElasticSearchListner instance is not garbage-collected prematurely
                GC.KeepAlive(esListener);
            }
            catch (Exception e)
            {
                ServiceEventSource.Current.ServiceHostInitializationFailed(e);
                throw;
            }
        }
    }
}
```

<span data-ttu-id="e4407-272">Los datos de conexión de Elasticsearch deben colocarse en una sección independiente del archivo de configuración de servicio (**PackageRoot\Config\Settings.xml**).</span><span class="sxs-lookup"><span data-stu-id="e4407-272">Elasticsearch connection data should be put in a separate section in the service configuration file (**PackageRoot\Config\Settings.xml**).</span></span> <span data-ttu-id="e4407-273">El nombre de la sección debe corresponder con el valor pasado al constructor `FabricConfigurationProvider` , por ejemplo:</span><span class="sxs-lookup"><span data-stu-id="e4407-273">The name of the section must correspond to the value passed to the `FabricConfigurationProvider` constructor, for example:</span></span>

```xml
<Section Name="ElasticSearchEventListener">
  <Parameter Name="serviceUri" Value="http://myBigCluster.westus.cloudapp.azure.com/es/" />
  <Parameter Name="userName" Value="(ES user name)" />
  <Parameter Name="password" Value="(ES user password)" />
  <Parameter Name="indexNamePrefix" Value="myapp" />
</Section>
```
<span data-ttu-id="e4407-274">Los valores de los parámetros `serviceUri`, `userName` y `password` corresponden a la dirección del punto de conexión de clúster Elasticsearch, al nombre de usuario Elasticsearch y a la contraseña, respectivamente.</span><span class="sxs-lookup"><span data-stu-id="e4407-274">The values of `serviceUri`, `userName` and `password` parameters correspond to the Elasticsearch cluster endpoint address, Elasticsearch user name, and password, respectively.</span></span> <span data-ttu-id="e4407-275">`indexNamePrefix` es el prefijo de los índices de Elasticsearch; la biblioteca Microsoft.Diagnostics.Listeners crea un nuevo índice para sus datos cada día.</span><span class="sxs-lookup"><span data-stu-id="e4407-275">`indexNamePrefix` is the prefix for Elasticsearch indexes; the Microsoft.Diagnostics.Listeners library creates a new index for its data daily.</span></span>

### <a name="verification"></a><span data-ttu-id="e4407-276">Comprobación</span><span class="sxs-lookup"><span data-stu-id="e4407-276">Verification</span></span>
<span data-ttu-id="e4407-277">Eso es todo.</span><span class="sxs-lookup"><span data-stu-id="e4407-277">That's it!</span></span> <span data-ttu-id="e4407-278">Ahora, cada vez que se ejecute el servicio, empezará a enviar seguimientos al servicio Elasticsearch especificado en la configuración.</span><span class="sxs-lookup"><span data-stu-id="e4407-278">Now, whenever the service is run, it starts sending traces to the Elasticsearch service specified in the configuration.</span></span> <span data-ttu-id="e4407-279">Puede comprobarlo abriendo la IU de Kibana asociada a la instancia de Elasticsearch de destino.</span><span class="sxs-lookup"><span data-stu-id="e4407-279">You can verify this by opening the Kibana UI associated with the target Elasticsearch instance.</span></span> <span data-ttu-id="e4407-280">En nuestro ejemplo, la dirección de la página es http://myBigCluster.westus.cloudapp.azure.com/.</span><span class="sxs-lookup"><span data-stu-id="e4407-280">In our example, the page address is http://myBigCluster.westus.cloudapp.azure.com/.</span></span> <span data-ttu-id="e4407-281">Compruebe que los índices con el prefijo del nombre elegido para la instancia de `ElasticSearchListener` efectivamente se han creado y rellenado con datos.</span><span class="sxs-lookup"><span data-stu-id="e4407-281">Check that indexes with the name prefix chosen for the `ElasticSearchListener` instance have indeed been created and populated with data.</span></span>

![Kibana muestra eventos de aplicación de PartyCluster][2]

## <a name="next-steps"></a><span data-ttu-id="e4407-283">Pasos siguientes</span><span class="sxs-lookup"><span data-stu-id="e4407-283">Next steps</span></span>
* [<span data-ttu-id="e4407-284">Más información sobre cómo diagnosticar y supervisar un servicio Service Fabric</span><span class="sxs-lookup"><span data-stu-id="e4407-284">Learn more about diagnosing and monitoring a Service Fabric service</span></span>](service-fabric-diagnostics-how-to-monitor-and-diagnose-services-locally.md)

<!--Image references-->
[1]: ./media/service-fabric-diagnostics-how-to-use-elasticsearch/listener-lib-references.png
[2]: ./media/service-fabric-diagnostics-how-to-use-elasticsearch/kibana.png
