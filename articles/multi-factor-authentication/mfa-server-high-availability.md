---
title: "Configuración del Servidor Azure MFA para la alta disponibilidad | Microsoft Docs"
description: Implemente varias instancias del Servidor Microsoft Azure Multi-Factor Authentication en configuraciones que proporcionan alta disponibilidad.
services: multi-factor-authentication
keywords: Azure MFA
documentationcenter: 
author: MicrosoftGuyJFlo
manager: femila
ms.assetid: 
ms.service: multi-factor-authentication
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/23/2017
ms.author: joflore
ms.reviewer: alexwe
ms.custom: it-pro
ms.openlocfilehash: 9f03e61e05383c309fb66b67e0641b17df5ab00f
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 08/29/2017
---
# <a name="configure-azure-multi-factor-authentication-server-for-high-availability"></a><span data-ttu-id="0e5cf-104">Configuración del Servidor Microsoft Azure Multi-Factor Authentication para la alta disponibilidad</span><span class="sxs-lookup"><span data-stu-id="0e5cf-104">Configure Azure Multi-Factor Authentication Server for high availability</span></span>

<span data-ttu-id="0e5cf-105">Para conseguir una alta disponibilidad con la implementación del Servidor Azure MFA, debe implementar varios servidores MFA.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-105">To achieve high-availability with your Azure Server MFA deployment, you need to deploy multiple MFA servers.</span></span> <span data-ttu-id="0e5cf-106">En esta sección se proporciona información sobre un diseño de carga equilibrada para conseguir objetivos de alta disponibilidad en la implementación del Servidor Azure MFA.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-106">This section provides information on a load-balanced design to achieve your high availability targets in you Azure MFS Server deployment.</span></span>

## <a name="mfa-server-overview"></a><span data-ttu-id="0e5cf-107">Introducción al Servidor MFA</span><span class="sxs-lookup"><span data-stu-id="0e5cf-107">MFA Server overview</span></span>

<span data-ttu-id="0e5cf-108">La arquitectura del servicio del Servidor Azure MFA consta de varios componentes, como se muestra en el siguiente diagrama:</span><span class="sxs-lookup"><span data-stu-id="0e5cf-108">The Azure MFA Server service architecture comprises several components as shown in the following diagram:</span></span>

 ![Arquitectura del Servidor MFA](./media/mfa-server-high-availability/mfa-ha-architecture.png)

<span data-ttu-id="0e5cf-110">Un Servidor MFA es un servidor con Windows Server que tiene instalado el software Azure Multi-Factor Authentication.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-110">An MFA Server is a Windows Server that has the Azure Multi-Factor Authentication software installed.</span></span> <span data-ttu-id="0e5cf-111">El servicio MFA debe activar la instancia del Servidor MFA en Azure para que dicho servidor funcione.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-111">The MFA Server instance must be activated by the MFA Service in Azure to function.</span></span> <span data-ttu-id="0e5cf-112">Se puede instalar más de una instancia del Servidor MFA en el entorno local.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-112">More than one MFA Server can be installed on-premises.</span></span>

<span data-ttu-id="0e5cf-113">De forma predeterminada, la primera instancia del Servidor MFA instalada se corresponde con la instancia maestra del Servidor MFA tras la activación realizada por el servicio Azure MFA.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-113">The first MFA Server that is installed is the master MFA Server upon activation by the Azure MFA Service by default.</span></span> <span data-ttu-id="0e5cf-114">La instancia maestra del Servidor MFA tiene una copia grabable de la base de datos PhoneFactor.pfdata.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-114">The master MFA server has a writeable copy of the PhoneFactor.pfdata database.</span></span> <span data-ttu-id="0e5cf-115">Las instalaciones posteriores de instancias del Servidor MFA se conocen como subordinadas.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-115">Subsequent installations of instances of MFA Server are known as slaves.</span></span> <span data-ttu-id="0e5cf-116">Las instancias subordinadas de MFA tienen una copia replicada de solo lectura de la base de datos PhoneFactor.pfdata.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-116">The MFA slaves have a replicated read-only copy of the PhoneFactor.pfdata database.</span></span> <span data-ttu-id="0e5cf-117">Las instancias del Servidor MFA replican información mediante la llamada a procedimiento remoto (RPC).</span><span class="sxs-lookup"><span data-stu-id="0e5cf-117">MFA servers replicate information using Remote Procedure Call (RPC).</span></span> <span data-ttu-id="0e5cf-118">Todas las instancias del Servidor MFA deben tener en común estar unidas a un dominio o ser independientes para replicar la información.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-118">All MFA Severs must collectively either be domain joined or standalone to replicate information.</span></span>

<span data-ttu-id="0e5cf-119">Las instancias maestras y subordinadas del Servidor MFA se comunican con el servicio MFA cuando se requiere la autenticación en dos fases.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-119">Both MFA master and slave MFA Servers communicate with the MFA Service when two-factor authentication is required.</span></span> <span data-ttu-id="0e5cf-120">Por ejemplo, cuando un usuario intenta acceder a una aplicación que requiere autenticación en dos fases, al usuario lo autenticará primero un proveedor de identidades, como Active Directory (AD).</span><span class="sxs-lookup"><span data-stu-id="0e5cf-120">For example, when a user attempts to gain access to an application that requires two-factor authentication, the user will first be authenticated by an identity provider, such as Active Directory (AD).</span></span>

<span data-ttu-id="0e5cf-121">Tras la autenticación correcta con AD, la instancia del Servidor MFA se comunicará con el servicio MFA.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-121">After successful authentication with AD, the MFA Server will communicate with the MFA Service.</span></span> <span data-ttu-id="0e5cf-122">La instancia del Servidor MFA espera a recibir una notificación del servicio MFA para permitir o denegar el acceso del usuario a la aplicación.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-122">The MFA Server waits for notification from the MFA Service to allow or deny the user access to the application.</span></span>

<span data-ttu-id="0e5cf-123">Si la instancia maestra del Servidor MFA se queda sin conexión, las autenticaciones todavía pueden procesarse, pero no las operaciones que requieren cambios en la base de datos de MFA.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-123">If the MFA master server goes offline, authentications can still be processed, but operations that require changes to the MFA database cannot be processed.</span></span> <span data-ttu-id="0e5cf-124">(Algunos ejemplos son: la adición de usuarios, los cambios de PIN de autoservicio y las modificaciones de la información de usuario).</span><span class="sxs-lookup"><span data-stu-id="0e5cf-124">(Examples include: the addition of users, self-service PIN changes, and changing user information)</span></span>

## <a name="deployment"></a><span data-ttu-id="0e5cf-125">Implementación</span><span class="sxs-lookup"><span data-stu-id="0e5cf-125">Deployment</span></span>

<span data-ttu-id="0e5cf-126">Tenga en cuenta los siguientes puntos importantes para el equilibrio de carga del Servidor Azure MFA y los componentes relacionados.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-126">Consider the following important points for load balancing Azure MFA Server and its related components.</span></span>

* <span data-ttu-id="0e5cf-127">**Uso del protocolo RADIUS para conseguir alta disponibilidad**.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-127">**Using RADIUS standard to achieve high availability**.</span></span> <span data-ttu-id="0e5cf-128">Si usa instancias del Servidor Azure MFA como servidores RADIUS, puede configurar un Servidor MFA como un destino de autenticación de RADIUS principal y otras instancias del Servidor Azure MFA como destinos de autenticación secundarios.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-128">If you are using Azure MFA Servers as RADIUS servers, you can potentially configure one MFA Server as a primary RADIUS authentication target and other Azure MFA Servers as secondary authentication targets.</span></span> <span data-ttu-id="0e5cf-129">Sin embargo, este método para lograr alta disponibilidad puede no resultar práctico, porque debe transcurrir un tiempo de espera en caso de errores de autenticación en el destino de autenticación principal para poder realizar la autenticación en el destino de autenticación secundario.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-129">However, this method to achieve high availability may not be practical because you must wait for a time-out period to occur when authentication fails on the primary authentication target before you can be authenticated against the secondary authentication target.</span></span> <span data-ttu-id="0e5cf-130">Resulta más eficaz equilibrar la carga del tráfico RADIUS entre el cliente RADIUS y los servidores RADIUS (en este caso, las instancias del Servidor Azure MFA actúan como servidores RADIUS), para que pueda configurar los clientes RADIUS con una sola dirección URL a la que puedan apuntar.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-130">It is more efficient to load balance the RADIUS traffic between the RADIUS client and the RADIUS Servers (in this case, the Azure MFA Servers acting as RADIUS servers) so that you can configure the RADIUS clients with a single URL that they can point to.</span></span>
* <span data-ttu-id="0e5cf-131">**Necesidad de promover manualmente las instancias subordinadas de MFA**.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-131">**Need to manually promote MFA slaves**.</span></span> <span data-ttu-id="0e5cf-132">Si la instancia maestra del Servidor Azure MFA se queda sin conexión, la instancia secundaria continúa con el procesamiento de solicitudes de MFA.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-132">If the master Azure MFA server goes offline, the secondary Azure MFA Servers continue to process MFA requests.</span></span> <span data-ttu-id="0e5cf-133">Sin embargo, hasta que la instancia maestra del Servidor MFA no esté disponible, los administradores no pueden agregar usuarios ni modificar la configuración de MFA, y los usuarios no pueden realizar cambios a través del portal de usuarios.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-133">However, until a master MFA server is available, admins can not add users or modify MFA settings, and users can not make changes using the user portal.</span></span> <span data-ttu-id="0e5cf-134">La promoción de una instancia subordinada de MFA al rol principal siempre se realiza a través de un proceso manual.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-134">Promoting an MFA slave to the master role is always a manual process.</span></span>
* <span data-ttu-id="0e5cf-135">**Separación de los componentes**.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-135">**Separability of components**.</span></span> <span data-ttu-id="0e5cf-136">El Servidor Azure MFA consta de varios componentes que se pueden instalar en la misma instancia de Windows Server o en instancias diferentes.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-136">The Azure MFA Server comprises several components that can be installed on the same Windows Server instance or on different instances.</span></span> <span data-ttu-id="0e5cf-137">Estos componentes incluyen el Portal de usuarios, el servicio web de aplicación móvil y el adaptador de AD FS (agente).</span><span class="sxs-lookup"><span data-stu-id="0e5cf-137">These components include the User Portal, Mobile App Web Service, and the ADFS adapter (agent).</span></span> <span data-ttu-id="0e5cf-138">Esta separación permite usar el Proxy de aplicación web para publicar en el Portal de usuarios y en el servidor web de aplicación móvil desde la red perimetral.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-138">This separability makes it possible to use the Web Application Proxy to publish the User Portal and Mobile App Web Server from the perimeter network.</span></span> <span data-ttu-id="0e5cf-139">Esta configuración se agrega a la seguridad global del diseño, tal como se muestra en el diagrama siguiente.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-139">Such a configuration adds to the overall security of your design, as shown in the following diagram.</span></span> <span data-ttu-id="0e5cf-140">El Portal de usuarios de MFA y el servidor web de aplicación móvil también se pueden implementar en las configuraciones de carga equilibrada de alta disponibilidad.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-140">The MFA User Portal and Mobile App Web Server may also be deployed in HA load-balanced configurations.</span></span>

   ![Servidor MFA con una red perimetral](./media/mfa-server-high-availability/mfasecurity.png)

* <span data-ttu-id="0e5cf-142">**La contraseña de un solo uso (OTP) a través de SMS (conocido también como SMS unidireccional) requiere usar sesiones temporales si se trata de tráfico de carga equilibrada**.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-142">**One-time password (OTP) over SMS (aka one-way SMS) requires the use of sticky sessions if traffic is load-balanced**.</span></span> <span data-ttu-id="0e5cf-143">SMS unidireccional es una opción de autenticación que hace que la instancia del Servidor MFA envíe a los usuarios un mensaje de texto que contiene una OTP.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-143">One-way SMS is an authentication option that causes the MFA Server to send the users a text message containing an OTP.</span></span> <span data-ttu-id="0e5cf-144">El usuario escribe la OTP en una ventana del símbolo del sistema para completar el desafío de MFA.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-144">The user enters the OTP in a prompt window to complete the MFA challenge.</span></span> <span data-ttu-id="0e5cf-145">Si las instancias del Servidor Azure MFA son de carga equilibrada, el mismo servidor que atiende la solicitud de autenticación inicial debe ser el servidor que recibe el mensaje de la OTP del usuario; si otra instancia del Servidor MFA recibe la respuesta de la OTP, se produce un error en el desafío de autenticación.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-145">If you load balance Azure MFA Servers, the same server that served the initial authentication request must be the server that receives the OTP message from the user; if another MFA Server receives the OTP reply, the authentication challenge fails.</span></span> <span data-ttu-id="0e5cf-146">Para más información, vea [One Time Password over SMS Added to Azure MFA Server](https://blogs.technet.microsoft.com/enterprisemobility/2015/03/02/one-time-password-over-sms-added-to-azure-mfa-server) (Contraseña de un solo uso a través de SMS agregada a Servidor Azure MFA).</span><span class="sxs-lookup"><span data-stu-id="0e5cf-146">For more information, see [One Time Password over SMS Added to Azure MFA Server](https://blogs.technet.microsoft.com/enterprisemobility/2015/03/02/one-time-password-over-sms-added-to-azure-mfa-server).</span></span>
* <span data-ttu-id="0e5cf-147">**Las implementaciones de carga equilibrada del Portal de usuarios y del servicio web de aplicación móvil requieren sesiones temporales**.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-147">**Load-Balanced deployments of the User Portal and Mobile App Web Service require sticky sessions**.</span></span> <span data-ttu-id="0e5cf-148">Si va a equilibrar la carga del Portal de usuarios de MFA y del servicio web de aplicación móvil, cada sesión debe estar en el mismo servidor.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-148">If you are load-balancing the MFA User Portal and the Mobile App Web Service, each session needs to stay on the same server.</span></span>

## <a name="high-availability-deployment"></a><span data-ttu-id="0e5cf-149">Implementación de alta disponibilidad</span><span class="sxs-lookup"><span data-stu-id="0e5cf-149">High-availability deployment</span></span>

<span data-ttu-id="0e5cf-150">En el diagrama siguiente se muestra una implementación completa de carga equilibrada de alta disponibilidad de Azure MFA y sus componentes, junto con AD FS como referencia.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-150">The following diagram shows a complete HA load-balanced implementation of Azure MFA and its components, along with ADFS for reference.</span></span>

 ![Implementación de alta disponibilidad del Servidor Azure MFA](./media/mfa-server-high-availability/mfa-ha-deployment.png)

<span data-ttu-id="0e5cf-152">Tenga en cuenta los siguientes elementos para el área numerada correspondiente del diagrama anterior.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-152">Note the following items for the correspondingly numbered area of the preceding diagram.</span></span>

1. <span data-ttu-id="0e5cf-153">Las dos instancias del Servidor Azure MFA (MFA1 y MFA2) tienen carga equilibrada (mfaapp.contoso.com) y están configuradas para usar un puerto estático (4443) para replicar la base de datos PhoneFactor.pfdata.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-153">The two Azure MFA Servers (MFA1 and MFA2) are load balanced (mfaapp.contoso.com) and are configured to use a static port (4443) to replicate the PhoneFactor.pfdata database.</span></span> <span data-ttu-id="0e5cf-154">El SDK del servicio web está instalado en cada una de las instancias del Servidor MFA para habilitar la comunicación a través del puerto TCP 443 con los servidores de AD FS.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-154">The Web Service SDK is installed on each of the MFA Server to enable communication over TCP port 443 with the ADFS servers.</span></span> <span data-ttu-id="0e5cf-155">Las instancias del Servidor MFA se implementan en una configuración de carga equilibrada sin estado.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-155">The MFA servers are deployed in a stateless load-balanced configuration.</span></span> <span data-ttu-id="0e5cf-156">Sin embargo, si desea utilizar la OTP a través de SMS, debe usar el equilibrio de carga con estado.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-156">However, if you wanted to use OTP over SMS, you must use stateful load balancing.</span></span>
   <span data-ttu-id="0e5cf-157">![Servidor Azure MFA: alta disponibilidad del servidor de aplicaciones](./media/mfa-server-high-availability/mfaapp.png)</span><span class="sxs-lookup"><span data-stu-id="0e5cf-157">![Azure MFA Server - App server HA](./media/mfa-server-high-availability/mfaapp.png)</span></span>

   > [!NOTE]
   > <span data-ttu-id="0e5cf-158">Dado que RPC usa puertos dinámicos, no se recomienda abrir los firewalls hasta el intervalo de puertos dinámicos que RPC puede usar.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-158">Because RPC uses dynamic ports, it is not recommended to open firewalls up to the range of dynamic ports that RPC can potentially use.</span></span> <span data-ttu-id="0e5cf-159">Si tiene un firewall **entre** los servidores de aplicaciones de MFA, debe configurar la instancia del Servidor MFA para comunicarse en un puerto estático para el tráfico de replicación entre servidores maestros y subordinados y abrir ese puerto en el firewall.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-159">If you have a firewall **between** your MFA application servers, you should configure the MFA Server to communicate on a static port for the replication traffic between slave and master servers and open that port on your firewall.</span></span> <span data-ttu-id="0e5cf-160">Puede forzar el puerto estático mediante la creación de un valor del Registro DWORD en ```HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\Positive Networks\PhoneFactor``` denominado ```Pfsvc_ncan_ip_tcp_port``` y establecer el valor en un puerto estático disponible.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-160">You can force the static port by creating a DWORD registry value at ```HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\Positive Networks\PhoneFactor``` called ```Pfsvc_ncan_ip_tcp_port``` and setting the value to an available static port.</span></span> <span data-ttu-id="0e5cf-161">Las instancias subordinadas del Servidor MFA siempre inician las conexiones en la instancia maestra y el puerto estático solo es necesario en la instancia maestra, pero, como se puede promover una instancia secundaria para que actúe como maestra en cualquier momento, debe definir el puerto estático en todas las instancias de Servidor MFA.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-161">Connections are always initiated by the slave MFA Servers to the master, the static port is only required on the master, but since you can promote a slave to be the master at any time, you should set the static port on all MFA Servers.</span></span>

2. <span data-ttu-id="0e5cf-162">Se equilibra la carga del servidor del Portal de usuarios y el servidor de aplicaciones móviles de MFA (MFA-UP-MAS1 y MFA-UP-MAS2) en una configuración **con estado** (mfa.contoso.com).</span><span class="sxs-lookup"><span data-stu-id="0e5cf-162">The two User Portal/MFA Mobile App servers (MFA-UP-MAS1 and MFA-UP-MAS2) are load balanced in a **stateful** configuration (mfa.contoso.com).</span></span> <span data-ttu-id="0e5cf-163">Recuerde que las sesiones temporales son un requisito para el equilibrio de carga del servicio de aplicaciones móviles y el Portal de usuarios de MFA.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-163">Recall that sticky sessions are a requirement for load balancing the MFA User Portal and Mobile App Service.</span></span>
   <span data-ttu-id="0e5cf-164">![Servidor Azure MFA: alta disponibilidad del servicio de aplicación móvil y del Portal de usuarios](./media/mfa-server-high-availability/mfaportal.png)</span><span class="sxs-lookup"><span data-stu-id="0e5cf-164">![Azure MFA Server - User Portal and Mobile App Service HA](./media/mfa-server-high-availability/mfaportal.png)</span></span>
3. <span data-ttu-id="0e5cf-165">Se equilibra la carga de la granja de servidores de AD FS y se publica en Internet a través de servidores proxy de AD FS de carga equilibrada en la red perimetral.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-165">The ADFS Server farm is load balanced and published to the Internet through load-balanced ADFS proxies in the perimeter network.</span></span> <span data-ttu-id="0e5cf-166">Cada servidor de AD FS usa al agente de AD FS para comunicarse con las instancias del Servidor Azure MFA mediante una dirección URL única de carga equilibrada (mfaapp.contoso.com) a través del puerto TCP 443.</span><span class="sxs-lookup"><span data-stu-id="0e5cf-166">Each ADFS Server uses the ADFS agent to communicate with the Azure MFA Servers using a single load-balanced URL (mfaapp.contoso.com) over TCP port 443.</span></span>

## <a name="next-steps"></a><span data-ttu-id="0e5cf-167">Pasos siguientes</span><span class="sxs-lookup"><span data-stu-id="0e5cf-167">Next steps</span></span>

* [<span data-ttu-id="0e5cf-168">Instalación y configuración del Servidor Azure MFA</span><span class="sxs-lookup"><span data-stu-id="0e5cf-168">Install and configure Azure MFA Server</span></span>](multi-factor-authentication-get-started-server.md)
