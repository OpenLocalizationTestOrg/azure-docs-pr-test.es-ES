---
title: "Integración de la VPN con Azure MFA con la extensión NPS | Microsoft Docs"
description: "Este artículo describe la integración de la infraestructura de VPN con Azure MFA utilizando la extensión Servidor de directivas de redes (NPS) para Microsoft Azure."
services: active-directory
keywords: "Azure MFA, integración de VPN, Azure Active Directory, extensión Servidor de directivas de redes"
documentationcenter: 
author: kgremban
manager: femila
ms.assetid: 
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/15/2017
ms.author: kgremban
ms.reviewer: jsnow
ms.custom: it-pro
ms.openlocfilehash: 3dfcf25856ede50266336c2ebb057dd3f7b8897e
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 08/29/2017
---
# <a name="integrate-your-vpn-infrastructure-with-azure-multi-factor-authentication-mfa-using-the-network-policy-server-nps-extension-for-azure"></a><span data-ttu-id="c846b-104">Este artículo describe la integración de la infraestructura de VPN con Azure Multi-Factor Authentication (MFA) utilizando la extensión Servidor de directivas de redes (NPS) para Azure</span><span class="sxs-lookup"><span data-stu-id="c846b-104">Integrate your VPN infrastructure with Azure Multi-Factor Authentication (MFA) using the Network Policy Server (NPS) extension for Azure</span></span>

## <a name="overview"></a><span data-ttu-id="c846b-105">Información general</span><span class="sxs-lookup"><span data-stu-id="c846b-105">Overview</span></span>

<span data-ttu-id="c846b-106">La extensión Servidor de directivas de redes (NPS) para Azure permite a las organizaciones proteger la autenticación de cliente del Servicio de autenticación remota telefónica de usuario (RADIUS) utilizando la autenticación basada en la nube [Azure Multi-Factor Authentication (MFA)](multi-factor-authentication-get-started-server-rdg.md), que proporciona verificación en dos pasos.</span><span class="sxs-lookup"><span data-stu-id="c846b-106">The Network Policy Service (NPS) extension for Azure allows organizations to safeguard Remote Authentication Dial-In User Service (RADIUS) client authentication using cloud-based [Azure Multi-Factor Authentication (MFA)](multi-factor-authentication-get-started-server-rdg.md), which provides two-step verification.</span></span>

<span data-ttu-id="c846b-107">Este artículo proporciona instrucciones para integrar la infraestructura NPS con Azure MFA con la extensión NPS para Azure para habilitar la verificación segura en dos pasos para los usuarios que intentan conectarse a la red mediante una VPN.</span><span class="sxs-lookup"><span data-stu-id="c846b-107">This article provides instructions for integrating the NPS infrastructure with Azure MFA using the NPS extension for Azure to enable secure two-step verification for users attempting to connect to your network using a VPN.</span></span> 

<span data-ttu-id="c846b-108">La directiva de red y servicios de acceso (NPS) ofrece a las organizaciones las siguientes posibilidades:</span><span class="sxs-lookup"><span data-stu-id="c846b-108">The Network Policy and Access Services (NPS) gives organizations the following abilities:</span></span>

* <span data-ttu-id="c846b-109">Especificar ubicaciones centrales para la administración y el control de las solicitudes de red mediante la especificación de quién puede conectarse, las franjas horarias en las que se permiten conexiones, la duración de las conexiones, el nivel de seguridad que los clientes deben usar para conectarse, etc.</span><span class="sxs-lookup"><span data-stu-id="c846b-109">Specify central locations for the management and control of network requests to specify who can connect, what times of day connections are allowed, the duration of connections, and the level of security that clients must use to connect, and so on.</span></span> <span data-ttu-id="c846b-110">En vez de especificar estas directivas en cada VPN o servidor de puerta de enlace de Escritorio remoto (RD), estas directivas se especifican una vez en una ubicación central.</span><span class="sxs-lookup"><span data-stu-id="c846b-110">Rather than specify these policies on each VPN or Remote Desktop (RD) Gateway server, these policies can be specified once in a central location.</span></span> <span data-ttu-id="c846b-111">El protocolo RADIUS se usa para proporcionar autenticación, autorización y contabilización de cuentas (AAA) centralizadas.</span><span class="sxs-lookup"><span data-stu-id="c846b-111">The RADIUS protocol is used to provide the centralized Authentication, Authorization, and Accounting (AAA).</span></span> 
* <span data-ttu-id="c846b-112">Establecer y aplicar directivas de mantenimiento de cliente de Protección de acceso a redes (NAP) que determinan si los dispositivos tienen acceso restringido o sin restricciones a los recursos de la red.</span><span class="sxs-lookup"><span data-stu-id="c846b-112">Establish and enforce Network Access Protection (NAP) client health policies that determine whether devices are granted unrestricted or restricted access to network resources.</span></span>
* <span data-ttu-id="c846b-113">Proporcionar un medio para aplicar la autenticación y autorización para el acceso a puntos de acceso inalámbricos 802.1x y conmutadores Ethernet.</span><span class="sxs-lookup"><span data-stu-id="c846b-113">Provide a means to enforce authentication and authorization for access to 802.1x-capable wireless access points and Ethernet switches.</span></span>    

<span data-ttu-id="c846b-114">Consulte [Servidor de directivas de redes (NPS)](https://docs.microsoft.com/windows-server/networking/technologies/nps/nps-top) para más información.</span><span class="sxs-lookup"><span data-stu-id="c846b-114">For more information, see [Network Policy Server (NPS)](https://docs.microsoft.com/windows-server/networking/technologies/nps/nps-top).</span></span> 

<span data-ttu-id="c846b-115">Para mejorar la seguridad y proporcionar un nivel elevado de cumplimiento, las organizaciones pueden integrar NPS con Azure MFA para asegurarse de que los usuarios utilizan la verificación en dos pasos para poder conectarse al puerto virtual en el servidor VPN.</span><span class="sxs-lookup"><span data-stu-id="c846b-115">To enhance security and provide high level of compliance, organizations can integrate NPS with Azure MFA to ensure that users use two-step verification to be able connect to the virtual port on the VPN server.</span></span> <span data-ttu-id="c846b-116">Para tener acceso, los usuarios deben proporcionar su combinación de nombre de usuario y contraseña junto con información que el usuario tiene bajo su control.</span><span class="sxs-lookup"><span data-stu-id="c846b-116">For users to be granted access, they must provide their username/password combination with information that the user has in their control.</span></span> <span data-ttu-id="c846b-117">Esta información debe ser de confianza y no duplicable fácilmente, como un número de teléfono móvil, el número fijo o una aplicación en un dispositivo móvil, entre otros.</span><span class="sxs-lookup"><span data-stu-id="c846b-117">This information must be trusted and not easily duplicated, such as a cell phone number, landline number, application on a mobile device, and so on.</span></span>

<span data-ttu-id="c846b-118">Antes de la disponibilidad de la extensión NPS para Azure, los clientes que querían implementar la verificación en dos pasos para entornos integrados de NPS y Azure MFA tenían que configurar y mantener un servidor independiente de MFA en el entorno local tal como se documenta en Puerta de enlace de Escritorio remoto y Servidor Azure Multi-Factor Authentication con RADIUS.</span><span class="sxs-lookup"><span data-stu-id="c846b-118">Prior to the availability of the NPS extension for Azure, customers who wished to implement two-step verification for integrated NPS and Azure MFA environments had to configure and maintain a separate MFA Server in the on-premises environment as documented in Remote Desktop Gateway and Azure Multi-Factor Authentication Server using RADIUS.</span></span>

<span data-ttu-id="c846b-119">La disponibilidad de la extensión NPS para Azure ahora da a las organizaciones la opción de implementar una solución MFA basada en el entorno local o una solución MFA basada en la nube para la autenticación segura de clientes RADIUS.</span><span class="sxs-lookup"><span data-stu-id="c846b-119">The availability of the NPS extension for Azure now gives organizations the choice to deploy either an on-premises based MFA solution or a cloud-based MFA solution to secure RADIUS client authentication.</span></span>
 
## <a name="authentication-flow"></a><span data-ttu-id="c846b-120">Flujo de autenticación</span><span class="sxs-lookup"><span data-stu-id="c846b-120">Authentication Flow</span></span>
<span data-ttu-id="c846b-121">Cuando un usuario se conecta a un puerto virtual en un servidor VPN, debe autenticarse primero con una variedad de protocolos, lo que permite el uso de una combinación de nombre de usuario y contraseña y métodos de autenticación basados en certificados.</span><span class="sxs-lookup"><span data-stu-id="c846b-121">When a user connects to a virtual port on a VPN server, they must first authenticate using a variety of protocols, which allow the use of a combination of user name/password and certificate-based authentication methods.</span></span> 

<span data-ttu-id="c846b-122">Además de la autenticación y verificación de identidad, los usuarios deben tener los permisos adecuados de acceso telefónico.</span><span class="sxs-lookup"><span data-stu-id="c846b-122">In addition to authenticating and verifying identity, users must have the appropriate dial-in permissions.</span></span> <span data-ttu-id="c846b-123">En implementaciones sencillas, estos permisos de acceso telefónico que permiten tener acceso se establecen directamente en los objetos de usuario de Active Directory.</span><span class="sxs-lookup"><span data-stu-id="c846b-123">In simple implementations, these dial-in permissions that allow access are set directly on the Active Directory user objects.</span></span> 

 ![Propiedades de usuario](./media/nps-extension-vpn/image1.png)

<span data-ttu-id="c846b-125">Para implementaciones sencillas, cada servidor VPN concede o deniega el acceso en función de las directivas definidas en cada servidor VPN local.</span><span class="sxs-lookup"><span data-stu-id="c846b-125">For simple implementations, each VPN server grants or denies access based on policies defined on each local VPN server.</span></span>

<span data-ttu-id="c846b-126">En implementaciones más grandes y escalables, las directivas que conceden o deniegan el acceso a la VPN están centralizadas en servidores RADIUS.</span><span class="sxs-lookup"><span data-stu-id="c846b-126">In larger and more scalable implementations, the polices that grant or deny VPN access are centralized on RADIUS servers.</span></span> <span data-ttu-id="c846b-127">En este caso, el servidor VPN actúa como un servidor de acceso (cliente RADIUS) que reenvía las solicitudes de conexión y mensajes de la cuenta a un servidor RADIUS.</span><span class="sxs-lookup"><span data-stu-id="c846b-127">In this case, the VPN server acts as an access server (RADIUS client) that forwards connection requests and account messages to a RADIUS server.</span></span> <span data-ttu-id="c846b-128">Para conectarse al puerto virtual en el servidor VPN, los usuarios deben autenticarse y cumplir las condiciones definidas de forma centralizada en servidores RADIUS.</span><span class="sxs-lookup"><span data-stu-id="c846b-128">To connect to the virtual port on the VPN server, users must be authenticated and meet the conditions defined centrally on RADIUS servers.</span></span> 

<span data-ttu-id="c846b-129">Cuando la extensión NPS para Azure está integrada con el NPS, el flujo de una autenticación correcta es como sigue:</span><span class="sxs-lookup"><span data-stu-id="c846b-129">When the NPS extension for Azure is integrated with the NPS, the successful authentication flow is as follows:</span></span>

1. <span data-ttu-id="c846b-130">El servidor VPN recibe una solicitud de autenticación de un usuario de VPN que incluye el nombre de usuario y contraseña para conectarse a un recurso, como una sesión de escritorio remoto.</span><span class="sxs-lookup"><span data-stu-id="c846b-130">The VPN server receives an authentication request from a VPN user that includes the username and password to connect to a resource, such as a Remote Desktop session.</span></span> 
2. <span data-ttu-id="c846b-131">Actuando como un cliente RADIUS, el servidor VPN convierte la solicitud en un mensaje de solicitud de acceso RADIUS y envía el mensaje (la contraseña se cifra) al servidor RADIUS (NPS) donde está instalada la extensión NPS.</span><span class="sxs-lookup"><span data-stu-id="c846b-131">Acting as a RADIUS client, VPN server converts the request to a RADIUS Access-Request message and sends the message (password is encrypted) to the RADIUS (NPS) server where the NPS extension is installed.</span></span> 
3. <span data-ttu-id="c846b-132">La combinación de nombre de usuario y contraseña se verifica en Active Directory.</span><span class="sxs-lookup"><span data-stu-id="c846b-132">The username and password combination is verified in Active Directory.</span></span> <span data-ttu-id="c846b-133">Si el nombre de usuario y contraseña son incorrectos, el servidor RADIUS envía un mensaje de rechazo de acceso.</span><span class="sxs-lookup"><span data-stu-id="c846b-133">If the username / password is incorrect, the RADIUS Server sends an Access-Reject message.</span></span> 
4. <span data-ttu-id="c846b-134">Si se cumplen todas las condiciones especificadas en la solicitud de conexión NPS y las directivas de red (por ejemplo, la hora del día o restricciones por pertenencia a un grupo), la extensión NPS desencadena una solicitud de autenticación secundaria con Azure MFA.</span><span class="sxs-lookup"><span data-stu-id="c846b-134">If all conditions as specified in the NPS Connection Request and Network Policies are met (for example, time of day or group membership restrictions), the NPS extension triggers a request for secondary authentication with Azure MFA.</span></span> 
5. <span data-ttu-id="c846b-135">Azure MFA se comunica con Azure Active Directory, recupera los detalles del usuario y realiza la autenticación secundaria con el método de verificación configurado por el usuario (mensaje de texto, aplicación móvil, etc).</span><span class="sxs-lookup"><span data-stu-id="c846b-135">Azure MFA communicates with Azure Active Directory, retrieves the user’s details, and performs the secondary authentication using the method configured by the user (text message, mobile app, and so on).</span></span> 
6. <span data-ttu-id="c846b-136">Cuando se realiza correctamente el desafío de MFA, Azure MFA comunica el resultado a la extensión NPS.</span><span class="sxs-lookup"><span data-stu-id="c846b-136">Upon success of the MFA challenge, Azure MFA communicates the result to the NPS extension.</span></span>
7. <span data-ttu-id="c846b-137">Después de que el intento de conexión se autentica y autoriza, el servidor NPS donde está instalada la extensión envía un mensaje de aceptación de acceso RADIUS al servidor VPN (cliente RADIUS).</span><span class="sxs-lookup"><span data-stu-id="c846b-137">After the connection attempt is both authenticated and authorized, the NPS server where the extension is installed sends a RADIUS Access-Accept message to the VPN server (RADIUS client).</span></span>
8. <span data-ttu-id="c846b-138">Se concede acceso al usuario al puerto virtual en el servidor VPN y se establece un túnel VPN cifrado.</span><span class="sxs-lookup"><span data-stu-id="c846b-138">The user is granted access to the virtual port on VPN server and establishes an encrypted VPN tunnel.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="c846b-139">Requisitos previos</span><span class="sxs-lookup"><span data-stu-id="c846b-139">Prerequisites</span></span>
<span data-ttu-id="c846b-140">En esta sección se detallan los requisitos previos necesarios antes de integrar Azure MFA con la puerta de enlace de Escritorio remoto.</span><span class="sxs-lookup"><span data-stu-id="c846b-140">This section details the prerequisites necessary before integrating Azure MFA with the Remote Desktop Gateway.</span></span> <span data-ttu-id="c846b-141">Antes de comenzar, debe cumplir los siguientes requisitos previos.</span><span class="sxs-lookup"><span data-stu-id="c846b-141">Before you begin, you must have the following prerequisites in place.</span></span>

* <span data-ttu-id="c846b-142">Infraestructura de VPN</span><span class="sxs-lookup"><span data-stu-id="c846b-142">VPN infrastructure</span></span>
* <span data-ttu-id="c846b-143">Directiva de red y rol de servicios de acceso (NPS)</span><span class="sxs-lookup"><span data-stu-id="c846b-143">Network Policy and Access Services (NPS) role</span></span>
* <span data-ttu-id="c846b-144">Licencia de Azure MFA</span><span class="sxs-lookup"><span data-stu-id="c846b-144">Azure MFA License</span></span>
* <span data-ttu-id="c846b-145">Software de Windows Server</span><span class="sxs-lookup"><span data-stu-id="c846b-145">Windows Server software</span></span>
* <span data-ttu-id="c846b-146">Bibliotecas</span><span class="sxs-lookup"><span data-stu-id="c846b-146">Libraries</span></span>
* <span data-ttu-id="c846b-147">Azure AD sincronizado con AD local</span><span class="sxs-lookup"><span data-stu-id="c846b-147">Azure AD synched with on-premises AD</span></span> 
* <span data-ttu-id="c846b-148">Identificador de GUID de Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="c846b-148">Azure Active Directory GUID ID</span></span>

### <a name="vpn-infrastructure"></a><span data-ttu-id="c846b-149">Infraestructura de VPN</span><span class="sxs-lookup"><span data-stu-id="c846b-149">VPN infrastructure</span></span>
<span data-ttu-id="c846b-150">En este artículo se da por supuesto que tiene una infraestructura VPN en funcionamiento con Microsoft Windows Server 2016 y que el servidor VPN actualmente no está configurado para reenviar solicitudes de conexión a un servidor RADIUS.</span><span class="sxs-lookup"><span data-stu-id="c846b-150">This article assumes that you have a working VPN infrastructure using Microsoft Windows Server 2016 in place and that the VPN server is currently not configured to forward connection requests to a RADIUS server.</span></span> <span data-ttu-id="c846b-151">En esta guía se va a configurar la infraestructura de VPN para usar un servidor RADIUS central.</span><span class="sxs-lookup"><span data-stu-id="c846b-151">You will configure the VPN infrastructure to use a central RADIUS server in this guide.</span></span>

<span data-ttu-id="c846b-152">Si no tiene una infraestructura en funcionamiento, puede crear rápidamente esta infraestructura siguiendo las instrucciones indicadas en numerosos tutoriales de instalación de VPN que puede encontrar en sitios de terceros y de Microsoft.</span><span class="sxs-lookup"><span data-stu-id="c846b-152">If you do not have a working infrastructure in place, you can quickly create this infrastructure by following the guidance provided in numerous VPN setup tutorials you can find on the Microsoft and third-party sites.</span></span> 

### <a name="network-policy-and-access-services-nps-role"></a><span data-ttu-id="c846b-153">Directiva de red y rol de servicios de acceso (NPS)</span><span class="sxs-lookup"><span data-stu-id="c846b-153">Network Policy and Access Services (NPS) role</span></span>

<span data-ttu-id="c846b-154">El servicio de rol NPS proporciona la funcionalidad de cliente y servidor RADIUS.</span><span class="sxs-lookup"><span data-stu-id="c846b-154">The NPS role service provides the RADIUS server and client functionality.</span></span> <span data-ttu-id="c846b-155">En este artículo se da por supuesto que ha instalado el rol NPS en un servidor miembro o en un controlador de dominio en su entorno.</span><span class="sxs-lookup"><span data-stu-id="c846b-155">This article assumes you have installed the NPS role on a member server or domain controller in your environment.</span></span> <span data-ttu-id="c846b-156">En esta guía configurará RADIUS para una configuración de VPN.</span><span class="sxs-lookup"><span data-stu-id="c846b-156">You will configure RADIUS for a VPN configuration in this guide.</span></span> <span data-ttu-id="c846b-157">Instalación del rol NPS en un servidor _distinto_ del servidor VPN.</span><span class="sxs-lookup"><span data-stu-id="c846b-157">Install the NPS role on a server _other_ than your VPN server.</span></span>

<span data-ttu-id="c846b-158">Para obtener información acerca de cómo instalar el servicio de rol NPS en Windows Server 2012 o posterior, consulte [Instalación de un servidor de directivas de mantenimiento de NAP](https://technet.microsoft.com/library/dd296890.aspx).</span><span class="sxs-lookup"><span data-stu-id="c846b-158">For information on installing the NPS role service Windows Server 2012 or higher, see [Install a NAP Health Policy Server](https://technet.microsoft.com/library/dd296890.aspx).</span></span> <span data-ttu-id="c846b-159">La directiva de acceso a redes (NAP) está en desuso en Windows Server 2016.</span><span class="sxs-lookup"><span data-stu-id="c846b-159">Network Access Policy (NAP) is deprecated in Windows Server 2016.</span></span> <span data-ttu-id="c846b-160">Para obtener una descripción de las prácticas recomendadas para NPS, incluida la recomendación de instalar NPS en un controlador de dominio, consulte [Prácticas recomendadas para NPS](https://technet.microsoft.com/library/cc771746).</span><span class="sxs-lookup"><span data-stu-id="c846b-160">For a description of best practices for NPS, including the recommendation to install NPS on a domain controller, see [Best Practices for NPS](https://technet.microsoft.com/library/cc771746).</span></span>

### <a name="licenses"></a><span data-ttu-id="c846b-161">Licencias</span><span class="sxs-lookup"><span data-stu-id="c846b-161">Licenses</span></span>

<span data-ttu-id="c846b-162">Es necesaria una licencia para Azure MFA, que está disponible a través de una suscripción de Azure AD Premium, de Enterprise Mobility + Security (EMS) o de MFA.</span><span class="sxs-lookup"><span data-stu-id="c846b-162">Required is a license for Azure MFA, which is available through an Azure AD Premium, Enterprise Mobility plus Security (EMS), or an MFA subscription.</span></span> <span data-ttu-id="c846b-163">Para más información, consulte [Cómo obtener Azure Multi-Factor Authentication](multi-factor-authentication-versions-plans.md).</span><span class="sxs-lookup"><span data-stu-id="c846b-163">For more information, see [How to get Azure Multi-Factor Authentication](multi-factor-authentication-versions-plans.md).</span></span> <span data-ttu-id="c846b-164">Para realizar pruebas, puede usar una suscripción de evaluación.</span><span class="sxs-lookup"><span data-stu-id="c846b-164">For testing purposes, you can use a trial subscription.</span></span>

### <a name="software"></a><span data-ttu-id="c846b-165">Software</span><span class="sxs-lookup"><span data-stu-id="c846b-165">Software</span></span>

<span data-ttu-id="c846b-166">La extensión NPS requiere Windows Server 2008 R2 SP1 o posterior con el servicio de rol NPS instalado.</span><span class="sxs-lookup"><span data-stu-id="c846b-166">The NPS extension requires Windows Server 2008 R2 SP1 or above with the NPS role service installed.</span></span> <span data-ttu-id="c846b-167">Todos los pasos de esta guía se han realizado con Windows Server 2016.</span><span class="sxs-lookup"><span data-stu-id="c846b-167">All the steps in this guide were performed using Windows Server 2016.</span></span>

### <a name="libraries"></a><span data-ttu-id="c846b-168">Bibliotecas</span><span class="sxs-lookup"><span data-stu-id="c846b-168">Libraries</span></span>

<span data-ttu-id="c846b-169">Se requieren las dos bibliotecas siguientes:</span><span class="sxs-lookup"><span data-stu-id="c846b-169">The following two libraries are required:</span></span>

* [<span data-ttu-id="c846b-170">Paquetes redistribuibles de Visual C++ para Visual Studio 2013 (X64)</span><span class="sxs-lookup"><span data-stu-id="c846b-170">Visual C++ Redistributable Packages for Visual Studio 2013 (X64)</span></span>](https://www.microsoft.com/download/details.aspx?id=40784)
* <span data-ttu-id="c846b-171">_Módulo Microsoft Azure Active Directory para Windows PowerShell versión1.1.166.0_ o posterior.</span><span class="sxs-lookup"><span data-stu-id="c846b-171">_Microsoft Azure Active Directory Module for Windows PowerShell version 1.1.166.0_ or higher.</span></span> <span data-ttu-id="c846b-172">Para la versión más reciente e instrucciones de instalación, consulte [Historial de versiones del Módulo Microsoft Azure Active Directory para PowerShell](https://social.technet.microsoft.com/wiki/contents/articles/28552.microsoft-azure-active-directory-powershell-module-version-release-history.aspx).</span><span class="sxs-lookup"><span data-stu-id="c846b-172">For the latest release and installation instructions, see [Microsoft Azure Active Directory PowerShell Module Version Release History](https://social.technet.microsoft.com/wiki/contents/articles/28552.microsoft-azure-active-directory-powershell-module-version-release-history.aspx).</span></span>

<span data-ttu-id="c846b-173">Estas bibliotecas no se empaquetan con los archivos de instalación de la extensión NPS (versión 0.9.1.2), a pesar de que en la documentación existente se indique lo contrario.</span><span class="sxs-lookup"><span data-stu-id="c846b-173">These libraries are not packaged with the NPS extension setup files (version 0.9.1.2), despite existing documentation that states otherwise.</span></span> <span data-ttu-id="c846b-174">Como mínimo, debe instalar los paquetes redistribuibles de Visual C++ para Visual Studio 2013.</span><span class="sxs-lookup"><span data-stu-id="c846b-174">At a minimum, you must install the Visual C++ Redistributable Packages for Visual Studio 2013.</span></span> <span data-ttu-id="c846b-175">El módulo Microsoft Azure Active Directory para Windows PowerShell se instala, si todavía no está presente, a través de un script de configuración que se ejecuta como parte del proceso de instalación.</span><span class="sxs-lookup"><span data-stu-id="c846b-175">The Microsoft Azure Active Directory Module for Windows PowerShell is installed, if it is not already present, through a configuration script you run as part of the setup process.</span></span> <span data-ttu-id="c846b-176">No es necesario instalar este módulo con antelación si aún no está instalado.</span><span class="sxs-lookup"><span data-stu-id="c846b-176">There is no need to install this module ahead of time if it is not already installed.</span></span>

### <a name="azure-active-directory-synched-with-on-premises-active-directory"></a><span data-ttu-id="c846b-177">Azure Active Directory sincronizado con Active Directory local</span><span class="sxs-lookup"><span data-stu-id="c846b-177">Azure Active Directory synched with on-premises Active Directory</span></span> 

<span data-ttu-id="c846b-178">Para usar la extensión NPS, los usuarios locales deben estar sincronizados con Azure Active Directory y habilitados para Multi-Factor Authentication.</span><span class="sxs-lookup"><span data-stu-id="c846b-178">To use the NPS extension, on-premises users must be synced with Azure Active Directory and enabled for Multi-Factor Authentication.</span></span> <span data-ttu-id="c846b-179">En esta guía se da por supuesto que los usuarios locales están sincronizados con Azure Active Directory mediante AD Connect.</span><span class="sxs-lookup"><span data-stu-id="c846b-179">This guide assumes that on-premises users are synched with Azure Active Directory using AD Connect.</span></span> <span data-ttu-id="c846b-180">A continuación, se proporcionan instrucciones para habilitar a los usuarios para usar MFA.</span><span class="sxs-lookup"><span data-stu-id="c846b-180">Instructions for enabling users for MFA are provided below.</span></span>
<span data-ttu-id="c846b-181">Para obtener información sobre Azure AD Connect, consulte [Integración de los directorios locales con Azure Active Directory](../active-directory/connect/active-directory-aadconnect.md).</span><span class="sxs-lookup"><span data-stu-id="c846b-181">For information on Azure AD connect, see [Integrate your on-premises directories with Azure Active Directory](../active-directory/connect/active-directory-aadconnect.md).</span></span> 

### <a name="azure-active-directory-guid-id"></a><span data-ttu-id="c846b-182">Identificador de GUID de Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="c846b-182">Azure Active Directory GUID ID</span></span> 
<span data-ttu-id="c846b-183">Para instalar NPS, debe conocer el GUID de Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="c846b-183">To install the NPS, you need to know the GUID of the Azure Active Directory.</span></span> <span data-ttu-id="c846b-184">En la siguiente sección se proporcionan instrucciones para buscar el GUID de Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="c846b-184">Instructions for finding the GUID of the Azure Active Directory are provided in the next section.</span></span>

## <a name="configure-radius-for-vpn-connections"></a><span data-ttu-id="c846b-185">Configuración de RADIUS para conexiones VPN</span><span class="sxs-lookup"><span data-stu-id="c846b-185">Configure RADIUS for VPN connections</span></span>

<span data-ttu-id="c846b-186">Si ha instalado el rol de servidor NPS en un servidor miembro, debe configurarlo para autenticar y autorizar clientes VPN que soliciten conexiones VPN.</span><span class="sxs-lookup"><span data-stu-id="c846b-186">If you have installed the NPS server role on a member server, you need to configure to authenticate and authorize VPN client that request VPN connections.</span></span> 

<span data-ttu-id="c846b-187">En esta sección se supone que ha instalado el rol de servidor de directivas de redes pero no lo ha configurado para su uso en su infraestructura.</span><span class="sxs-lookup"><span data-stu-id="c846b-187">This section assumes that you have installed the Network Policy Server role but have not configured it for use in your infrastructure.</span></span>

>[!NOTE]
><span data-ttu-id="c846b-188">Si ya tiene un servidor VPN en funcionamiento que usa un servidor RADIUS centralizado para la autenticación, puede omitir esta sección.</span><span class="sxs-lookup"><span data-stu-id="c846b-188">If you already have a working VPN server that uses a centralized RADIUS server for authentication, you can skip this section.</span></span>
>

### <a name="register-server-in-active-directory"></a><span data-ttu-id="c846b-189">Registro del servidor en Active Directory</span><span class="sxs-lookup"><span data-stu-id="c846b-189">Register Server in Active Directory</span></span>
<span data-ttu-id="c846b-190">Para que funcione correctamente en este escenario, el servidor NPS debe estar registrado en Active Directory.</span><span class="sxs-lookup"><span data-stu-id="c846b-190">To function properly in this scenario, the NPS server needs to be registered in Active Directory.</span></span>

1. <span data-ttu-id="c846b-191">Abra el Administrador del servidor.</span><span class="sxs-lookup"><span data-stu-id="c846b-191">Open Server Manager.</span></span>
2. <span data-ttu-id="c846b-192">En el Administrador del servidor, haga clic en **Herramientas** y, a continuación, haga clic en **Servidor de directivas de redes**.</span><span class="sxs-lookup"><span data-stu-id="c846b-192">In Server Manager, click **Tools**, and then click **Network Policy Server**.</span></span> 
3. <span data-ttu-id="c846b-193">En la consola del servidor de directivas de redes, haga clic con el botón derecho en **NPS (Local)** y, a continuación, haga clic en **Registrar el servidor en Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="c846b-193">In the Network Policy Server console, right-click **NPS (Local)**, and then click **Register server in Active Directory**.</span></span> <span data-ttu-id="c846b-194">Haga clic en **Aceptar** dos veces.</span><span class="sxs-lookup"><span data-stu-id="c846b-194">Click **OK** two times.</span></span>

 ![Servidor de directivas de redes](./media/nps-extension-vpn/image2.png)

4. <span data-ttu-id="c846b-196">Deje la consola abierta para el siguiente procedimiento.</span><span class="sxs-lookup"><span data-stu-id="c846b-196">Leave the console open for the next procedure.</span></span>

### <a name="use-wizard-to-configure-radius-server"></a><span data-ttu-id="c846b-197">Utilice el asistente para configurar el servidor RADIUS</span><span class="sxs-lookup"><span data-stu-id="c846b-197">Use wizard to configure RADIUS server</span></span>
<span data-ttu-id="c846b-198">Puede usar la opción de configuración estándar (basada en asistente) o la opción avanzada para configurar el servidor RADIUS.</span><span class="sxs-lookup"><span data-stu-id="c846b-198">You can use a standard (wizard-based) or advanced configuration option to configure the RADIUS server.</span></span> <span data-ttu-id="c846b-199">Esta sección supone el uso de la opción de configuración estándar con el asistente.</span><span class="sxs-lookup"><span data-stu-id="c846b-199">This section assumes the use of the wizard-based standard configuration option.</span></span>

1. <span data-ttu-id="c846b-200">En la consola del Servidor de directivas de redes, haga clic en **NPS (Local)**.</span><span class="sxs-lookup"><span data-stu-id="c846b-200">In the Network Policy Server console, click **NPS (Local)**.</span></span>
2. <span data-ttu-id="c846b-201">En la configuración estándar, seleccione **Servidor RADIUS para conexiones telefónicas o VPN** y, a continuación, haga clic en **Configurar VPN o acceso telefónico**.</span><span class="sxs-lookup"><span data-stu-id="c846b-201">Under Standard Configuration, select **RADIUS Server for Dial-Up or VPN Connections**, and then click **Configure VPN or Dial-Up**.</span></span>

 ![Configuración de VPN](./media/nps-extension-vpn/image3.png)

3. <span data-ttu-id="c846b-203">En la página Seleccione tipo de conexión de acceso telefónico o red privada virtual, seleccione **Conexiones de red privada virtual** y haga clic en **Siguiente**.</span><span class="sxs-lookup"><span data-stu-id="c846b-203">On the Select Dial-up or Virtual Private Network Connections Type page, select **Virtual Private Network Connections**, and click **Next**.</span></span>

 ![Red privada virtual](./media/nps-extension-vpn/image4.png)

4. <span data-ttu-id="c846b-205">En la página Especificar servidor de acceso telefónico o VPN, haga clic en **Agregar**.</span><span class="sxs-lookup"><span data-stu-id="c846b-205">On the Specify Dial-Up or VPN Server page, click **Add**.</span></span>
5. <span data-ttu-id="c846b-206">En el cuadro de diálogo **Nuevo cliente RADIUS**, proporcione un nombre descriptivo, escriba el nombre para resolver o la dirección IP del servidor VPN y escriba una contraseña secreta compartida.</span><span class="sxs-lookup"><span data-stu-id="c846b-206">In the **New RADIUS client** dialog box, provide a friendly name, enter the resolvable name or IP address of the VPN server, and enter a shared secret password.</span></span> <span data-ttu-id="c846b-207">Elija una contraseña secreta compartida larga y compleja.</span><span class="sxs-lookup"><span data-stu-id="c846b-207">Make this shared secret password long and complex.</span></span> <span data-ttu-id="c846b-208">Registre esta contraseña, será necesaria para los pasos de la sección siguiente.</span><span class="sxs-lookup"><span data-stu-id="c846b-208">Record this password, as you need it for steps in the next section.</span></span>

 ![Nuevo cliente RADIUS](./media/nps-extension-vpn/image5.png)

6. <span data-ttu-id="c846b-210">Haga clic en **Aceptar** y, a continuación, en **Siguiente**.</span><span class="sxs-lookup"><span data-stu-id="c846b-210">Click **OK**, and then **Next**.</span></span>
7. <span data-ttu-id="c846b-211">En la página **Configurar métodos de autenticación**, acepte la selección predeterminada (Microsoft Encrypted Authentication versión 2 [MS-CHAPv2]) o elija otra opción y haga clic en **Siguiente**.</span><span class="sxs-lookup"><span data-stu-id="c846b-211">On the **Configure Authentication Methods** page, accept the default selection (Microsoft Encrypted Authentication version 2 (MS-CHAPv2) or choose another option, and click **Next**.</span></span>

  >[!NOTE]
  ><span data-ttu-id="c846b-212">Si configura el Protocolo de autenticación extensible (EAP), debe usar MS CHAPv2 o PEAP.</span><span class="sxs-lookup"><span data-stu-id="c846b-212">If you configure Extensible Authentication Protocol (EAP), you must use either MS CHAPv2 or PEAP.</span></span> <span data-ttu-id="c846b-213">No se admite ningún otro tipo de EAP.</span><span class="sxs-lookup"><span data-stu-id="c846b-213">No other EAP is supported.</span></span>
 
8. <span data-ttu-id="c846b-214">En la página Especificar grupos de usuarios, haga clic en **Agregar** y seleccione un grupo apropiado, si existe alguno.</span><span class="sxs-lookup"><span data-stu-id="c846b-214">On the Specify User Groups page, click **Add** and select an appropriate group, if one exists.</span></span> <span data-ttu-id="c846b-215">En caso contrario, deje la selección en blanco para conceder acceso a todos los usuarios.</span><span class="sxs-lookup"><span data-stu-id="c846b-215">Otherwise, leave the selection blank to grant access to all users.</span></span>

 ![Especificar grupos de usuarios](./media/nps-extension-vpn/image7.png)

9. <span data-ttu-id="c846b-217">Haga clic en **Siguiente**.</span><span class="sxs-lookup"><span data-stu-id="c846b-217">Click **Next**.</span></span>
10. <span data-ttu-id="c846b-218">En la página Especificar filtros IP, haga clic en **Siguiente**.</span><span class="sxs-lookup"><span data-stu-id="c846b-218">On the Specify IP Filters page, click **Next**.</span></span>
11. <span data-ttu-id="c846b-219">En la página Especificar la configuración de cifrado, acepte la configuración predeterminada y haga clic en **Siguiente**.</span><span class="sxs-lookup"><span data-stu-id="c846b-219">On the Specify Encryption Settings page, accept the default settings, and click **Next**.</span></span>

 ![Especificar cifrado](./media/nps-extension-vpn/image8.png)

12. <span data-ttu-id="c846b-221">En Especificar un nombre de dominio Kerberos, deje el nombre en blanco, acepte la configuración predeterminada y haga clic en **Siguiente**.</span><span class="sxs-lookup"><span data-stu-id="c846b-221">On the Specify a Realm Name, leave the name blank, accept the default setting, and click **Next**.</span></span>

 ![Especificar un nombre de dominio Kerberos](./media/nps-extension-vpn/image9.png)

13. <span data-ttu-id="c846b-223">En la página Finalizando nueva conexión de acceso telefónico o VPN y cliente RADIUS, haga clic en **Finalizar**.</span><span class="sxs-lookup"><span data-stu-id="c846b-223">On the Completing New Dial-up or Virtual Private Network Connections and RADIUS clients page, click **Finish**.</span></span>

 ![Conexiones finalizadas](./media/nps-extension-vpn/image10.png)

### <a name="verify-radius-configuration"></a><span data-ttu-id="c846b-225">Comprobación de la configuración de RADIUS</span><span class="sxs-lookup"><span data-stu-id="c846b-225">Verify RADIUS configuration</span></span>
<span data-ttu-id="c846b-226">En esta sección se detalla la configuración creada con el asistente.</span><span class="sxs-lookup"><span data-stu-id="c846b-226">This section details the configuration you created using the wizard.</span></span>

1. <span data-ttu-id="c846b-227">En el servidor NPS, en la consola NPS (Local), expanda Clientes RADIUS y seleccione **Clientes RADIUS**.</span><span class="sxs-lookup"><span data-stu-id="c846b-227">On the NPS server, in the NPS (Local) console, expand RADIUS Clients, and select **RADIUS Clients**.</span></span>
2. <span data-ttu-id="c846b-228">En el panel de detalles, haga clic con el botón derecho en el cliente RADIUS que ha creado con el asistente y haga clic en **Propiedades**.</span><span class="sxs-lookup"><span data-stu-id="c846b-228">In the details pane, right-click the RADIUS client you created using wizard, and click **Properties**.</span></span> <span data-ttu-id="c846b-229">Las propiedades del cliente RADIUS (el servidor VPN) deben ser similares a las que se muestran a continuación.</span><span class="sxs-lookup"><span data-stu-id="c846b-229">The properties for your RADIUS client (the VPN server) should be similar to those shown below.</span></span>

 ![Propiedades de VPN](./media/nps-extension-vpn/image11.png)

3. <span data-ttu-id="c846b-231">Haga clic en **Cancelar**.</span><span class="sxs-lookup"><span data-stu-id="c846b-231">Click **Cancel**.</span></span>
4. <span data-ttu-id="c846b-232">En el servidor NPS, en la consola NPS (Local), expanda **Directivas** y seleccione **Directivas de solicitud de conexión**.</span><span class="sxs-lookup"><span data-stu-id="c846b-232">On the NPS server, in the NPS (Local) console, expand **Policies**, and select **Connection Request Policies**.</span></span> <span data-ttu-id="c846b-233">Debería ver la directiva de conexiones VPN, con un aspecto similar a la imagen siguiente.</span><span class="sxs-lookup"><span data-stu-id="c846b-233">You should see the VPN Connections policy that resembles the image below.</span></span>

 ![Solicitudes de conexión](./media/nps-extension-vpn/image12.png)

5. <span data-ttu-id="c846b-235">En Directivas, seleccione **Directivas de red**.</span><span class="sxs-lookup"><span data-stu-id="c846b-235">Under Policies, select **Network Policies**.</span></span> <span data-ttu-id="c846b-236">Debería ver una directiva de conexiones de red privada virtual (VPN), con un aspecto similar a la imagen siguiente.</span><span class="sxs-lookup"><span data-stu-id="c846b-236">You should a Virtual Private Network (VPN) Connections policy that resembles the image below.</span></span>

 ![Propiedades de red](./media/nps-extension-vpn/image13.png)

## <a name="configure-vpn-server-to-use-radius-authentication"></a><span data-ttu-id="c846b-238">Configuración del servidor VPN para que utilice la autenticación RADIUS</span><span class="sxs-lookup"><span data-stu-id="c846b-238">Configure VPN Server to use RADIUS authentication</span></span>
<span data-ttu-id="c846b-239">En esta sección, configurará el servidor VPN para utilizar la autenticación RADIUS.</span><span class="sxs-lookup"><span data-stu-id="c846b-239">In this section, you configure the VPN server to use RADIUS authentication.</span></span> <span data-ttu-id="c846b-240">En esta sección se da por supuesto que tiene una configuración de servidor VPN en funcionamiento, pero no se ha configurado el servidor VPN para utilizar la autenticación RADIUS.</span><span class="sxs-lookup"><span data-stu-id="c846b-240">This section assumes that you have a working configuration of VPN server but have not configured the VPN server to use RADIUS authentication.</span></span> <span data-ttu-id="c846b-241">Después de configurar el servidor VPN, confirme que la configuración funciona según lo previsto.</span><span class="sxs-lookup"><span data-stu-id="c846b-241">After configuring the VPN server, you confirm that your configuration is working as expected.</span></span>

>[!NOTE]
><span data-ttu-id="c846b-242">Si ya tiene una configuración de servidor VPN en funcionamiento que usa autenticación RADIUS, puede omitir esta sección.</span><span class="sxs-lookup"><span data-stu-id="c846b-242">If you already have a working VPN server configuration that uses RADIUS authentication, you can skip this section.</span></span>
>

### <a name="configure-authentication-provider"></a><span data-ttu-id="c846b-243">Configuración del proveedor de autenticación</span><span class="sxs-lookup"><span data-stu-id="c846b-243">Configure authentication provider</span></span>
1. <span data-ttu-id="c846b-244">En el servidor VPN, abra el Administrador del servidor.</span><span class="sxs-lookup"><span data-stu-id="c846b-244">On the VPN server, open Server Manager.</span></span>
2. <span data-ttu-id="c846b-245">En el Administrador del servidor, haga clic en **Herramientas** y, a continuación, en **Enrutamiento y acceso remoto**.</span><span class="sxs-lookup"><span data-stu-id="c846b-245">In Server Manager, click **Tools**, and then **Routing and Remote Access**.</span></span>
3. <span data-ttu-id="c846b-246">En la consola de Enrutamiento y acceso remoto, haga clic con el botón derecho en  **\[nombre del servidor\] (local)** y, a continuación, haga clic en **Propiedades**.</span><span class="sxs-lookup"><span data-stu-id="c846b-246">In the Routing and Remote Access console, right-click **\[Server Name\] (local)**, and then click **Properties**.</span></span>

 ![Enrutamiento y acceso remoto](./media/nps-extension-vpn/image14.png)
 
4. <span data-ttu-id="c846b-248">En el cuadro de diálogo **Propiedades de [nombre del servidor} (local)**, haga clic en la pestaña **Seguridad**.</span><span class="sxs-lookup"><span data-stu-id="c846b-248">In the **[Server Name} (local) Properties** dialog box, click the **Security** tab.</span></span> 
5. <span data-ttu-id="c846b-249">En la pestaña **Seguridad**, en Proveedor de autenticación, haga clic en **Autenticación RADIUS** y, a continuación, en **Configurar**.</span><span class="sxs-lookup"><span data-stu-id="c846b-249">On the **Security** tab, under Authentication provider, click **RADIUS Authentication**, and then **Configure**.</span></span>

 ![Autenticación RADIUS](./media/nps-extension-vpn/image15.png)
 
6. <span data-ttu-id="c846b-251">En el cuadro de diálogo Autenticación RADIUS, haga clic en **Agregar**.</span><span class="sxs-lookup"><span data-stu-id="c846b-251">In the RADIUS Authentication dialog box, click **Add**.</span></span>
7. <span data-ttu-id="c846b-252">En Agregar servidor RADIUS, en nombre del servidor, agregue el nombre o la dirección IP del servidor RADIUS que configuró en la sección anterior.</span><span class="sxs-lookup"><span data-stu-id="c846b-252">In the Add RADIUS Server, in Server name, add the name or the IP address of the RADIUS server you configured in the previous section.</span></span>
8. <span data-ttu-id="c846b-253">En Secreto compartido, haga clic en **Cambiar** y agregue la contraseña secreta compartida que creó y anotó anteriormente.</span><span class="sxs-lookup"><span data-stu-id="c846b-253">In Shared secret, click **Change** and add the shared secret password you created and recorded earlier.</span></span>
9. <span data-ttu-id="c846b-254">En Tiempo de espera (segundos), cambie el valor a un valor entre **30** y **60**.</span><span class="sxs-lookup"><span data-stu-id="c846b-254">In Time-out (seconds), change the value to a value between **30** and **60**.</span></span> <span data-ttu-id="c846b-255">Esto es necesario para dar tiempo suficiente para completar el segundo factor de autenticación.</span><span class="sxs-lookup"><span data-stu-id="c846b-255">This is necessary to allow enough time to complete the second authentication factor.</span></span>
 
 ![Agregar servidor RADIUS](./media/nps-extension-vpn/image16.png)
 
10. <span data-ttu-id="c846b-257">Haga clic en **Aceptar** hasta cerrar todos los cuadros de diálogo.</span><span class="sxs-lookup"><span data-stu-id="c846b-257">Click **OK** until you complete closing all dialog boxes.</span></span>

### <a name="test-vpn-connectivity"></a><span data-ttu-id="c846b-258">Probar la conectividad VPN</span><span class="sxs-lookup"><span data-stu-id="c846b-258">Test VPN connectivity</span></span>
<span data-ttu-id="c846b-259">En esta sección, confirmará que el cliente VPN se autentica y es autorizado por el servidor RADIUS cuando intenta conectarse al puerto virtual de VPN.</span><span class="sxs-lookup"><span data-stu-id="c846b-259">In this section, you confirm that the VPN client is authenticated and authorized by the RADIUS server when you attempt to connect to VPN virtual port.</span></span> <span data-ttu-id="c846b-260">En esta sección se supone que usa Windows 10 como cliente de VPN.</span><span class="sxs-lookup"><span data-stu-id="c846b-260">This section assumes you are using Windows 10 as a VPN client.</span></span> 

>[!NOTE]
><span data-ttu-id="c846b-261">Si ya tiene configurado un cliente VPN para conectarse al servidor VPN y ha guardado la configuración, puede omitir los pasos descritos para configurar y guardar un objeto de conexión VPN.</span><span class="sxs-lookup"><span data-stu-id="c846b-261">If you already configured a VPN client to connect to the VPN server and have saved the settings, you can skip the steps related to configuring and saving a VPN connection object.</span></span>
>

1. <span data-ttu-id="c846b-262">En el equipo del cliente VPN, haga clic en **Inicio** y, a continuación, en **Configuración** (icono de engranaje).</span><span class="sxs-lookup"><span data-stu-id="c846b-262">On your VPN client computer, click **Start**, and then **Settings** (gear icon).</span></span>
2. <span data-ttu-id="c846b-263">En configuración de Windows, haga clic en **Red e Internet**.</span><span class="sxs-lookup"><span data-stu-id="c846b-263">In Window Settings, click **Network & Internet**.</span></span>
3. <span data-ttu-id="c846b-264">Haga clic en **VPN**.</span><span class="sxs-lookup"><span data-stu-id="c846b-264">Click **VPN**.</span></span>
4. <span data-ttu-id="c846b-265">Haga clic en **Agregar una conexión VPN**.</span><span class="sxs-lookup"><span data-stu-id="c846b-265">Click **Add a VPN connection**.</span></span>
5. <span data-ttu-id="c846b-266">En Agregar una conexión VPN, especifique Windows (integrada) como el Proveedor de VPN, a continuación, complete los campos restantes según corresponda y haga clic en **Guardar**.</span><span class="sxs-lookup"><span data-stu-id="c846b-266">In Add a VPN connection, specify Windows (built-in) as the VPN provider, then complete the remaining fields, as appropriate, and click **Save**.</span></span> 

 ![Agregar una conexión VPN](./media/nps-extension-vpn/image17.png)
 
6. <span data-ttu-id="c846b-268">Abra el **Centro de redes y recursos compartidos** en el Panel de Control.</span><span class="sxs-lookup"><span data-stu-id="c846b-268">Open the **Network and Sharing Center** in Control Panel.</span></span>
7. <span data-ttu-id="c846b-269">Haga clic en **Cambiar configuración del adaptador**.</span><span class="sxs-lookup"><span data-stu-id="c846b-269">Click **Change adapter settings**.</span></span>

 ![Cambiar configuración del adaptador](./media/nps-extension-vpn/image18.png)

8. <span data-ttu-id="c846b-271">Haga clic con el botón derecho en la conexión de red VPN y haga clic en Propiedades.</span><span class="sxs-lookup"><span data-stu-id="c846b-271">Right-click the VPN network connection, and click Properties.</span></span> 

 ![Propiedades de red VPN](./media/nps-extension-vpn/image19.png)

9. <span data-ttu-id="c846b-273">En el cuadro de diálogo Propiedades de VPN, haga clic en la pestaña **Seguridad**.</span><span class="sxs-lookup"><span data-stu-id="c846b-273">In the VPN properties dialog box, click the **Security** tab.</span></span> 
10. <span data-ttu-id="c846b-274">En la pestaña Seguridad, asegúrese de que solo está seleccionado **Microsoft CHAP versión 2 (MS-CHAP v2)** y haga clic en Aceptar.</span><span class="sxs-lookup"><span data-stu-id="c846b-274">On the Security tab, ensure that only **Microsoft CHAP Version 2 (MS-CHAP v2)** is selected, and click OK.</span></span>

 ![Protocolos permitidos](./media/nps-extension-vpn/image20.png)

11. <span data-ttu-id="c846b-276">Haga clic con el botón derecho en la conexión VPN y haga clic en **Conectar**.</span><span class="sxs-lookup"><span data-stu-id="c846b-276">Right-click the VPN connection, and click **Connect**.</span></span>
12. <span data-ttu-id="c846b-277">En la página Configuración, haga clic en **Conectar**.</span><span class="sxs-lookup"><span data-stu-id="c846b-277">On the Settings page, click **Connect**.</span></span>

<span data-ttu-id="c846b-278">Aparece una conexión correcta en el registro de seguridad en el servidor RADIUS con el identificador de evento 6272, como se muestra a continuación.</span><span class="sxs-lookup"><span data-stu-id="c846b-278">A successful connection appears in the Security log on the RADIUS server as Event ID 6272, as shown below.</span></span>

 ![Propiedades de evento](./media/nps-extension-vpn/image21.png)

## <a name="troubleshoot-guide"></a><span data-ttu-id="c846b-280">Guía de solución de problemas</span><span class="sxs-lookup"><span data-stu-id="c846b-280">Troubleshoot Guide</span></span>
<span data-ttu-id="c846b-281">Se supone que la configuración de VPN funcionaba correctamente antes de configurar el servidor VPN para que utilice un servidor RADIUS centralizado para la autenticación y autorización.</span><span class="sxs-lookup"><span data-stu-id="c846b-281">Assume that your VPN configuration was working before you configured the VPN server to use a centralized RADIUS server for authentication and authorization.</span></span> <span data-ttu-id="c846b-282">En este caso, es probable que el problema pueda deberse a una configuración incorrecta del servidor RADIUS o al uso de un nombre de usuario o contraseña no válidos.</span><span class="sxs-lookup"><span data-stu-id="c846b-282">In this case, it is likely that the issue may be caused by a misconfiguration of the RADIUS Server or the use of an invalid username or password.</span></span> <span data-ttu-id="c846b-283">Por ejemplo, si usa el sufijo UPN alternativo en el nombre de usuario, el intento de inicio de sesión puede producir un error (debe usar el mismo nombre de cuenta para obtener los mejores resultados).</span><span class="sxs-lookup"><span data-stu-id="c846b-283">For example, if you use the alternate UPN suffix in the username, the login attempt might fail (you should use the same Account name for best results).</span></span> 

<span data-ttu-id="c846b-284">Para solucionar estos problemas, un lugar ideal para comenzar es examinar los registros de eventos de seguridad en el servidor RADIUS.</span><span class="sxs-lookup"><span data-stu-id="c846b-284">To troubleshoot these issues, an ideal place to start is to examine the Security event logs on the RADIUS server.</span></span> <span data-ttu-id="c846b-285">Para ahorrar tiempo buscando eventos, puede utilizar la vista personalizada basada en roles Servidor de directivas de red y acceso en el Visor de eventos, como se muestra a continuación.</span><span class="sxs-lookup"><span data-stu-id="c846b-285">To save time searching for events, you can use the role-based Network Policy and Access Server custom view in Event Viewer, as show below.</span></span> <span data-ttu-id="c846b-286">El identificador de evento 6273 indica eventos en los que el servidor de directivas de redes deniega el acceso a un usuario.</span><span class="sxs-lookup"><span data-stu-id="c846b-286">Event ID 6273 indicates events where the Network Policy Server denied access to a user.</span></span> 

 ![Visor de eventos](./media/nps-extension-vpn/image22.png)
 
## <a name="configure-multi-factor-authentication"></a><span data-ttu-id="c846b-288">Configuración de Multi-Factor Authentication</span><span class="sxs-lookup"><span data-stu-id="c846b-288">Configure Multi-Factor Authentication</span></span>
<span data-ttu-id="c846b-289">Esta sección proporciona instrucciones para habilitar a los usuarios para MFA y para configurar las cuentas para la verificación en dos pasos.</span><span class="sxs-lookup"><span data-stu-id="c846b-289">This section provides instructions for enabling users for MFA and for setting up accounts for two-step verification.</span></span> 

### <a name="enable-multi-factor-authentication"></a><span data-ttu-id="c846b-290">Habilitar Multi-Factor Authentication</span><span class="sxs-lookup"><span data-stu-id="c846b-290">Enable multi-factor authentication</span></span>
<span data-ttu-id="c846b-291">En esta sección, se habilitan cuentas de Azure AD para MFA.</span><span class="sxs-lookup"><span data-stu-id="c846b-291">In this section, you enable Azure AD accounts for MFA.</span></span> <span data-ttu-id="c846b-292">Use el **portal clásico** para habilitar a los usuarios para MFA.</span><span class="sxs-lookup"><span data-stu-id="c846b-292">Use the **classic portal** to enable users for MFA.</span></span> 

1. <span data-ttu-id="c846b-293">Abra un explorador y vaya a [https://manage.windowsazure.com](https://manage.windowsazure.com).</span><span class="sxs-lookup"><span data-stu-id="c846b-293">Open a browser, and navigate to [https://manage.windowsazure.com](https://manage.windowsazure.com).</span></span> 
2. <span data-ttu-id="c846b-294">Inicie sesión como administrador.</span><span class="sxs-lookup"><span data-stu-id="c846b-294">Log on as the administrator.</span></span>
3. <span data-ttu-id="c846b-295">En el panel de navegación izquierdo del portal, haga clic en **Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="c846b-295">In the portal, in the left navigation, click **ACTIVE DIRECTORY**.</span></span>

 ![Directorio predeterminado](./media/nps-extension-vpn/image23.png)

4. <span data-ttu-id="c846b-297">En la columna nombre, haga clic en **Directorio predeterminado** (o en otro directorio, si procede).</span><span class="sxs-lookup"><span data-stu-id="c846b-297">In the NAME column, click **Default Directory** (or another directory, if appropriate).</span></span>
5. <span data-ttu-id="c846b-298">En la página Inicio rápido, haga clic en **Configurar**.</span><span class="sxs-lookup"><span data-stu-id="c846b-298">On the Quick Start page, click **Configure**.</span></span>

 ![Configurar valor predeterminado](./media/nps-extension-vpn/image24.png)

6. <span data-ttu-id="c846b-300">En la página Configurar, desplácese hacia abajo y, en la sección de la autenticación multifactor, haga clic en **Administrar el valor de configuración del servicio**.</span><span class="sxs-lookup"><span data-stu-id="c846b-300">On the CONFIGURE page, scroll down and, in the multi-factor authentication section, click **Manage service settings**.</span></span>

 ![Administrar la configuración de MFA](./media/nps-extension-vpn/image25.png)
 
7. <span data-ttu-id="c846b-302">En la página de la autenticación multifactor, revise la configuración predeterminada del servicio y, a continuación, haga clic en **Usuarios**.</span><span class="sxs-lookup"><span data-stu-id="c846b-302">On the multi-factor authentication page, review the default service settings, and then click **Users**.</span></span> 

 ![Usuarios de MFA](./media/nps-extension-vpn/image26.png)
 
8. <span data-ttu-id="c846b-304">En la página Usuarios, seleccione los usuarios que desea habilitar para MFA y, a continuación, haga clic en **Habilitar**.</span><span class="sxs-lookup"><span data-stu-id="c846b-304">On the Users page, select the users that you wish to enable for MFA, and then click **Enable**.</span></span>

 ![Propiedades](./media/nps-extension-vpn/image27.png)
 
9. <span data-ttu-id="c846b-306">Cuando se le solicite, haga clic en **Habilitar autenticación multifactor**.</span><span class="sxs-lookup"><span data-stu-id="c846b-306">When prompted, click **Enable multi-factor auth**.</span></span>

 ![Habilitar MFA](./media/nps-extension-vpn/image28.png)
 
10. <span data-ttu-id="c846b-308">Haga clic en **Cerrar**.</span><span class="sxs-lookup"><span data-stu-id="c846b-308">Click **Close**.</span></span> 
11. <span data-ttu-id="c846b-309">Actualice la página.</span><span class="sxs-lookup"><span data-stu-id="c846b-309">Refresh the page.</span></span> <span data-ttu-id="c846b-310">Se cambia el estado de MFA a Habilitado.</span><span class="sxs-lookup"><span data-stu-id="c846b-310">The MFA status is changed to Enabled.</span></span>

<span data-ttu-id="c846b-311">Para información sobre cómo habilitar usuarios para Multi-Factor Authentication, consulte [Introducción a Azure Multi-Factor Authentication en la nube](multi-factor-authentication-get-started-cloud.md).</span><span class="sxs-lookup"><span data-stu-id="c846b-311">For information on how to enable users for Multi-Factor Authentication, see [Getting started with Azure Multi-Factor Authentication in the cloud](multi-factor-authentication-get-started-cloud.md).</span></span> 

### <a name="configure-accounts-for-two-step-verification"></a><span data-ttu-id="c846b-312">Configuración de cuentas para la verificación en dos pasos</span><span class="sxs-lookup"><span data-stu-id="c846b-312">Configure accounts for two-step verification</span></span>
<span data-ttu-id="c846b-313">Una vez que una cuenta se ha habilitado para MFA, los usuarios no pueden iniciar sesión en los recursos controlados por la directiva MFA hasta que hayan configurado correctamente un dispositivo de confianza que se utilizará para el segundo factor de autenticación de la verificación en dos pasos.</span><span class="sxs-lookup"><span data-stu-id="c846b-313">Once an account has been enabled for MFA, users are not able to sign in to resources governed by the MFA policy until they have successfully configured a trusted device to use for the second authentication factor having used two-step verification.</span></span>

<span data-ttu-id="c846b-314">En esta sección, configurará un dispositivo de confianza para su uso con la verificación en dos pasos.</span><span class="sxs-lookup"><span data-stu-id="c846b-314">In this section, you configure a trusted device for use with two-step verification.</span></span> <span data-ttu-id="c846b-315">Hay varias opciones disponibles para configurar estos elementos, incluidas las siguientes:</span><span class="sxs-lookup"><span data-stu-id="c846b-315">There are several options available for you to configure these, including the following:</span></span>

* <span data-ttu-id="c846b-316">**Aplicación móvil**.</span><span class="sxs-lookup"><span data-stu-id="c846b-316">**Mobile app**.</span></span> <span data-ttu-id="c846b-317">Instale la aplicación Microsoft Authenticator en un dispositivo Windows Phone, Android o iOS.</span><span class="sxs-lookup"><span data-stu-id="c846b-317">You install the Microsoft Authenticator app on a Windows Phone, Android, or iOS device.</span></span> <span data-ttu-id="c846b-318">Según las directivas de su organización, deberá usar la aplicación en uno de estos dos modos: Recibir notificaciones de comprobación (se envía una notificación al dispositivo) o Usar código de comprobación (deberá escribir un código de comprobación que se actualiza cada 30 segundos).</span><span class="sxs-lookup"><span data-stu-id="c846b-318">Depending on your organization’s policies, you are required to use the app in one of two modes: Receive notifications for verifications (a notification is pushed to your device) or Use verification code (you are required to enter a verification code that updates every 30 seconds).</span></span> 
* <span data-ttu-id="c846b-319">**Llamada de teléfono móvil o mensaje de texto**.</span><span class="sxs-lookup"><span data-stu-id="c846b-319">**Mobile phone call or text**.</span></span> <span data-ttu-id="c846b-320">Puede recibir un mensaje de texto o una llamada de teléfono automática.</span><span class="sxs-lookup"><span data-stu-id="c846b-320">You can either receive an automated phone call or text message.</span></span> <span data-ttu-id="c846b-321">En la opción de llamada de teléfono, debe responder a la llamada y presionar el signo # para autenticarse.</span><span class="sxs-lookup"><span data-stu-id="c846b-321">With the phone call option, you answer the call and press the # sign to authenticate.</span></span> <span data-ttu-id="c846b-322">En la opción de mensaje de texto, puede responder al mensaje o escribir el código de comprobación en la interfaz de inicio de sesión.</span><span class="sxs-lookup"><span data-stu-id="c846b-322">With the text option, you can either reply to the text message or enter the verification code into the sign-in interface.</span></span>
* <span data-ttu-id="c846b-323">**Llamada de teléfono de la oficina**.</span><span class="sxs-lookup"><span data-stu-id="c846b-323">**Office phone call**.</span></span> <span data-ttu-id="c846b-324">Este proceso es el mismo que se ha descrito para las llamadas de teléfono automatizadas anteriores.</span><span class="sxs-lookup"><span data-stu-id="c846b-324">This process is the same as that described for automated phone calls above.</span></span>

<span data-ttu-id="c846b-325">Siga estas instrucciones para configurar un dispositivo para usar la aplicación móvil para recibir una notificación push para la comprobación.</span><span class="sxs-lookup"><span data-stu-id="c846b-325">Follow these instructions for setting up a device to use the mobile app to receive push notification for verification.</span></span>

1. <span data-ttu-id="c846b-326">Inicie sesión en [https://aka.ms/mfasetup](https://aka.ms/mfasetup) o en cualquier otro sitio, como [https://portal.azure.com](https://portal.azure.com), donde sea necesario autenticarse con sus credenciales basadas en MFA.</span><span class="sxs-lookup"><span data-stu-id="c846b-326">Log on to [https://aka.ms/mfasetup](https://aka.ms/mfasetup) or any site, such as [https://portal.azure.com](https://portal.azure.com), where you required to authenticate using your MFA-enabled credentials.</span></span> 
2. <span data-ttu-id="c846b-327">Al iniciar sesión con su nombre de usuario y contraseña, se le presentará una pantalla que le pregunta si desea configurar la cuenta para la comprobación de seguridad adicional.</span><span class="sxs-lookup"><span data-stu-id="c846b-327">Upon signing in with your username and password, you are presented with a screen that prompts you to set up the account for additional security verification.</span></span>

 ![Seguridad adicional](./media/nps-extension-vpn/image29.png)

3. <span data-ttu-id="c846b-329">Haga clic en **Configurar ahora**.</span><span class="sxs-lookup"><span data-stu-id="c846b-329">Click **Set it up now**.</span></span>
4. <span data-ttu-id="c846b-330">En la página Comprobación de seguridad adicional, seleccione un tipo de contacto (aplicación móvil, teléfono del trabajo o teléfono de autenticación).</span><span class="sxs-lookup"><span data-stu-id="c846b-330">On the Additional security verification page, select a contact type (authentication phone, office phone, or mobile app).</span></span> <span data-ttu-id="c846b-331">A continuación, seleccione un país o región y seleccione un método.</span><span class="sxs-lookup"><span data-stu-id="c846b-331">Then select a country or region, and select a method.</span></span> <span data-ttu-id="c846b-332">El método varía según el tipo de contacto que seleccione.</span><span class="sxs-lookup"><span data-stu-id="c846b-332">The method varies by contact type you select.</span></span> <span data-ttu-id="c846b-333">Por ejemplo, si elige Aplicación móvil, puede seleccionar si desea recibir notificaciones de comprobación o usar un código de comprobación.</span><span class="sxs-lookup"><span data-stu-id="c846b-333">For example, if you choose Mobile app, you can select whether to receive notifications for verification or to use a verification code.</span></span> <span data-ttu-id="c846b-334">En los pasos siguientes se supone que ha elegido **Aplicación móvil** como el tipo de contacto.</span><span class="sxs-lookup"><span data-stu-id="c846b-334">The steps that follow assume you choose **Mobile app** as the contact type.</span></span>

 ![Teléfono de autenticación](./media/nps-extension-vpn/image30.png)

5. <span data-ttu-id="c846b-336">Seleccione Aplicación móvil, haga clic en **Recibir notificaciones de comprobación** y, a continuación, haga clic en **Configurar**.</span><span class="sxs-lookup"><span data-stu-id="c846b-336">Select Mobile app, click **Receive notifications for verification**, and then **Set up**.</span></span> 

 ![Comprobación con aplicación móvil](./media/nps-extension-vpn/image31.png)
 
6. <span data-ttu-id="c846b-338">Si aún no lo ha hecho, instale la aplicación móvil Authenticator en el dispositivo.</span><span class="sxs-lookup"><span data-stu-id="c846b-338">If you haven’t done so already, install the authenticator mobile app on your device.</span></span> 
7. <span data-ttu-id="c846b-339">Siga las instrucciones de la aplicación móvil para examinar el código de barras que se le presenta o escriba manualmente la información y, a continuación, haga clic en **Listo**.</span><span class="sxs-lookup"><span data-stu-id="c846b-339">Follow the instructions in the mobile app to scan the presented bar code or enter the information manually, and then click **Done**.</span></span>

 ![Configuración de la aplicación móvil](./media/nps-extension-vpn/image32.png)

8. <span data-ttu-id="c846b-341">En la página Comprobación de seguridad adicional, haga clic en **Contactarme** y responda a la notificación que se envía al dispositivo.</span><span class="sxs-lookup"><span data-stu-id="c846b-341">On the Additional security verification page, click **Contact me** and reply to notification sent to your device.</span></span>
9. <span data-ttu-id="c846b-342">En la página Comprobación de seguridad adicional, escriba un número de contacto para utilizar en caso de que pierda el acceso a la aplicación móvil y haga clic en **Siguiente**.</span><span class="sxs-lookup"><span data-stu-id="c846b-342">On the Additional security verification page, enter a contact number in case you lose access to the mobile app, and click **Next**.</span></span>

 ![Número de teléfono móvil](./media/nps-extension-vpn/image33.png)
 
10. <span data-ttu-id="c846b-344">En Comprobación de seguridad adicional, haga clic en **Listo**.</span><span class="sxs-lookup"><span data-stu-id="c846b-344">On the Additional security verification, click **Done**.</span></span>

<span data-ttu-id="c846b-345">El dispositivo está configurado ahora para proporcionar un segundo método de comprobación.</span><span class="sxs-lookup"><span data-stu-id="c846b-345">The device is now configured to provide a second method of verification.</span></span> <span data-ttu-id="c846b-346">Para obtener información sobre cómo configurar cuentas para la verificación en dos pasos, consulte [Configurar mi cuenta para la verificación en dos pasos](./end-user/multi-factor-authentication-end-user-first-time.md).</span><span class="sxs-lookup"><span data-stu-id="c846b-346">For information on setting up accounts for two-step verification, see [Set up my account for two-step verification](./end-user/multi-factor-authentication-end-user-first-time.md).</span></span>

## <a name="install-and-configure-nps-extension"></a><span data-ttu-id="c846b-347">Instalación y configuración de la extensión NPS</span><span class="sxs-lookup"><span data-stu-id="c846b-347">Install and configure NPS extension</span></span>

<span data-ttu-id="c846b-348">Esta sección proporciona instrucciones para configurar la VPN para usar Azure MFA para la autenticación de cliente con el servidor de VPN.</span><span class="sxs-lookup"><span data-stu-id="c846b-348">This section provides instructions for configuring VPN to use Azure MFA for client authentication with the VPN Server.</span></span>

<span data-ttu-id="c846b-349">Una vez que instale y configure la extensión NPS, toda la autenticación de cliente basada en RADIUS procesada por este servidor debe usar Azure MFA.</span><span class="sxs-lookup"><span data-stu-id="c846b-349">Once you install and configure the NPS extension, all RADIUS-based client authentication that is processed by this server is required to use Azure MFA.</span></span> <span data-ttu-id="c846b-350">Si todos los usuarios de VPN no están inscritos en Azure MFA, puede configurar otro servidor RADIUS para autenticar a los usuarios que no están configurados para usar MFA.</span><span class="sxs-lookup"><span data-stu-id="c846b-350">If not all your VPN users are enrolled in Azure MFA, you can set up another RADIUS server to authenticate users who are not configured to use MFA.</span></span> <span data-ttu-id="c846b-351">O bien, puede crear una entrada del registro que permite a sus usuarios proporcionar un segundo factor de autenticación solo si están inscritos en MFA.</span><span class="sxs-lookup"><span data-stu-id="c846b-351">Or you can create a registry entry that allows challenged users to provide a second authentication factor, only if they are enrolled in MFA.</span></span> 

<span data-ttu-id="c846b-352">Cree un nuevo valor de cadena denominado _REQUIRE_USER_MATCH en HKLM\SOFTWARE\Microsoft\AzureMfa_ y establezca el valor como TRUE o FALSE.</span><span class="sxs-lookup"><span data-stu-id="c846b-352">Create a new string value named _REQUIRE_USER_MATCH in HKLM\SOFTWARE\Microsoft\AzureMfa_, and set the value to TRUE or FALSE.</span></span> 

 ![Require User Match (Requerir coincidencia de usuario)](./media/nps-extension-vpn/image34.png)
 
<span data-ttu-id="c846b-354">Si el valor se establece en TRUE o no está establecido, todas las solicitudes de autenticación están sujetas a un desafío MFA.</span><span class="sxs-lookup"><span data-stu-id="c846b-354">If the value is set to TRUE or not set, all authentication requests are subject to an MFA challenge.</span></span> <span data-ttu-id="c846b-355">Si el valor se establece en FALSE, se emiten desafíos MFA únicamente a los usuarios que están inscritos en MFA.</span><span class="sxs-lookup"><span data-stu-id="c846b-355">If the value is set to FALSE, MFA challenges are issued only to users that are enrolled in MFA.</span></span> <span data-ttu-id="c846b-356">Use solo el valor FALSE en las pruebas o en entornos de producción durante un período de incorporación.</span><span class="sxs-lookup"><span data-stu-id="c846b-356">Only use the FALSE setting in testing or in production environments during an onboarding period.</span></span>

### <a name="acquire-azure-active-directory-guid-id"></a><span data-ttu-id="c846b-357">Obtener el identificador de GUID de Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="c846b-357">Acquire Azure Active Directory GUID ID</span></span>

<span data-ttu-id="c846b-358">Como parte de la configuración de la extensión NPS, debe proporcionar las credenciales de administrador y el identificador de Azure Active Directory para el inquilino de Azure AD.</span><span class="sxs-lookup"><span data-stu-id="c846b-358">As part of the configuration of the NPS extension, you need to supply admin credentials and the Azure Active Directory ID for your Azure AD tenant.</span></span> <span data-ttu-id="c846b-359">Los pasos siguientes muestran cómo obtener el identificador del inquilino.</span><span class="sxs-lookup"><span data-stu-id="c846b-359">The steps below show you how to get the tenant ID.</span></span>

1. <span data-ttu-id="c846b-360">Inicie sesión en Azure Portal en [https://portal.azure.com](https://portal.azure.com) como administrador global del inquilino de Azure.</span><span class="sxs-lookup"><span data-stu-id="c846b-360">Sign in to the Azure portal at [https://portal.azure.com](https://portal.azure.com) as the global administrator of the Azure tenant.</span></span>
2. <span data-ttu-id="c846b-361">En la barra de navegación de la izquierda, haga clic en el icono de **Azure Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="c846b-361">In the left navigation, click the **Azure Active Directory** icon.</span></span>
3. <span data-ttu-id="c846b-362">Haga clic en **Propiedades**.</span><span class="sxs-lookup"><span data-stu-id="c846b-362">Click **Properties**.</span></span>
4. <span data-ttu-id="c846b-363">Para copiar el identificador de directorio en el Portapapeles, seleccione el icono **Copiar**.</span><span class="sxs-lookup"><span data-stu-id="c846b-363">To copy your Directory ID to the clipboard, select the **Copy** icon.</span></span>
 
 ![Identificador de directorio](./media/nps-extension-vpn/image35.png)

### <a name="install-the-nps-extension"></a><span data-ttu-id="c846b-365">Instalación de la extensión de NPS</span><span class="sxs-lookup"><span data-stu-id="c846b-365">Install the NPS extension</span></span>
<span data-ttu-id="c846b-366">La extensión NPS debe instalarse en un servidor que tenga el rol Directiva de red y servicios de acceso (NPS) instalado y que funcione como servidor RADIUS en el diseño.</span><span class="sxs-lookup"><span data-stu-id="c846b-366">The NPS extension needs to be installed on a server that has the Network Policy and Access Services (NPS) role installed and that functions as the RADIUS server in your design.</span></span> <span data-ttu-id="c846b-367">No instale la extensión NPS en el servidor de Escritorio remoto.</span><span class="sxs-lookup"><span data-stu-id="c846b-367">Don't install the NPS extension on your Remote Desktop Server.</span></span>

1. <span data-ttu-id="c846b-368">Puede descargar la extensión NPS de [https://aka.ms/npsmfa](https://aka.ms/npsmfa).</span><span class="sxs-lookup"><span data-stu-id="c846b-368">Download the NPS extension from [https://aka.ms/npsmfa](https://aka.ms/npsmfa).</span></span> 
2. <span data-ttu-id="c846b-369">Copie el archivo ejecutable de instalación (NpsExtnForAzureMfaInstaller.exe) en el servidor NPS.</span><span class="sxs-lookup"><span data-stu-id="c846b-369">Copy the setup executable file (NpsExtnForAzureMfaInstaller.exe) to the NPS server.</span></span>
3. <span data-ttu-id="c846b-370">En el servidor NPS, haga doble clic en **NpsExtnForAzureMfaInstaller.exe**.</span><span class="sxs-lookup"><span data-stu-id="c846b-370">On the NPS server, double-click **NpsExtnForAzureMfaInstaller.exe**.</span></span> <span data-ttu-id="c846b-371">Cuando se le solicite, haga clic en **Ejecutar**.</span><span class="sxs-lookup"><span data-stu-id="c846b-371">If prompted, click **Run**.</span></span>
4. <span data-ttu-id="c846b-372">En el cuadro de diálogo Extensión NPS para Azure MFA, revise los términos de licencia de software, marque la casilla **Acepto los términos de licencia y condiciones** y haga clic en **Instalar**.</span><span class="sxs-lookup"><span data-stu-id="c846b-372">In the NPS Extension for Azure MFA dialog box, review the software license terms, check **I agree to the license terms and conditions**, and click **Install**.</span></span>

 ![Extensión NPS](./media/nps-extension-vpn/image36.png)
 
5. <span data-ttu-id="c846b-374">En el cuadro de diálogo Extensión NPS para Azure MFA, haga clic en **Cerrar**.</span><span class="sxs-lookup"><span data-stu-id="c846b-374">In the NPS Extension for Azure MFA dialog box, click **Close**.</span></span>  

 ![Instalación correcta](./media/nps-extension-vpn/image37.png) 
 
### <a name="configure-certificates-for-use-with-the-nps-extension-using-a-powershell-script"></a><span data-ttu-id="c846b-376">Configuración de los certificados para su uso con la extensión NPS mediante un script de PowerShell</span><span class="sxs-lookup"><span data-stu-id="c846b-376">Configure certificates for use with the NPS extension using a PowerShell script</span></span>
<span data-ttu-id="c846b-377">Debe configurar los certificados para su uso por la extensión NPS para garantizar la seguridad de las comunicaciones.</span><span class="sxs-lookup"><span data-stu-id="c846b-377">To ensure secure communications and assurance, you need to configure certificates for use by the NPS extension.</span></span> <span data-ttu-id="c846b-378">Los componentes de NPS incluyen un script de Windows PowerShell que configura un certificado autofirmado para su uso con NPS.</span><span class="sxs-lookup"><span data-stu-id="c846b-378">The NPS components include a Windows PowerShell script that configures a self-signed certificate for use with NPS.</span></span> 

<span data-ttu-id="c846b-379">Este script realiza las acciones siguientes:</span><span class="sxs-lookup"><span data-stu-id="c846b-379">The script performs the following actions:</span></span>

* <span data-ttu-id="c846b-380">Crea un certificado autofirmado</span><span class="sxs-lookup"><span data-stu-id="c846b-380">Creates a self-signed certificate</span></span>
* <span data-ttu-id="c846b-381">Asocia la clave pública del certificado a la entidad de servicio en Azure AD</span><span class="sxs-lookup"><span data-stu-id="c846b-381">Associates public key of certificate to service principal on Azure AD</span></span>
* <span data-ttu-id="c846b-382">Almacena el certificado en el almacén de certificados del equipo local</span><span class="sxs-lookup"><span data-stu-id="c846b-382">Stores the cert in the local machine store</span></span>
* <span data-ttu-id="c846b-383">Concede acceso a la clave privada del certificado al usuario de red</span><span class="sxs-lookup"><span data-stu-id="c846b-383">Grants access to the certificate’s private key to the Network User</span></span>
* <span data-ttu-id="c846b-384">Reinicia el servicio Servidor de directivas de redes</span><span class="sxs-lookup"><span data-stu-id="c846b-384">Restarts Network Policy Server service</span></span>

<span data-ttu-id="c846b-385">Si desea utilizar sus propios certificados, debe asociar la clave pública de su certificado para la entidad de servicio en Azure AD, etc.</span><span class="sxs-lookup"><span data-stu-id="c846b-385">If you want to use your own certificates, you need to associate the public of your certificate to the service principle on Azure AD, and so on.</span></span>
<span data-ttu-id="c846b-386">Para usar el script, indique a la extensión sus credenciales de administrador de Azure Active Directory y el identificador del inquilino de Azure Active Directory que copió anteriormente.</span><span class="sxs-lookup"><span data-stu-id="c846b-386">To use the script, provide the extension with your Azure Active Directory administrative credentials and the Azure Active Directory tenant ID you copied earlier.</span></span> <span data-ttu-id="c846b-387">Ejecute el script en cada servidor NPS donde instaló la extensión NPS.</span><span class="sxs-lookup"><span data-stu-id="c846b-387">Run the script on each NPS server where you install the NPS extension.</span></span>

1. <span data-ttu-id="c846b-388">Abra un símbolo del sistema administrativo de Windows PowerShell.</span><span class="sxs-lookup"><span data-stu-id="c846b-388">Open an administrative Windows PowerShell prompt.</span></span>
2. <span data-ttu-id="c846b-389">En el símbolo del sistema de PowerShell, escriba _cd 'c:\Program Files\Microsoft\AzureMfa\Config'_ y presione **ENTRAR**.</span><span class="sxs-lookup"><span data-stu-id="c846b-389">At the PowerShell prompt, type _cd ‘c:\Program Files\Microsoft\AzureMfa\Config’_, and press **ENTER**.</span></span>
3. <span data-ttu-id="c846b-390">Escriba _.\AzureMfsNpsExtnConfigSetup.ps1_ y presione **ENTRAR**.</span><span class="sxs-lookup"><span data-stu-id="c846b-390">Type _.\AzureMfsNpsExtnConfigSetup.ps1_, and press **ENTER**.</span></span> 
 * <span data-ttu-id="c846b-391">El script comprueba si está instalado el módulo de PowerShell de Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="c846b-391">The script checks to see if the Azure Active Directory PowerShell module is installed.</span></span> <span data-ttu-id="c846b-392">Si no está instalado, el script instala el módulo.</span><span class="sxs-lookup"><span data-stu-id="c846b-392">If it is not installed, the script installs the module for you.</span></span>
 
 ![PowerShell](./media/nps-extension-vpn/image38.png)
 
4. <span data-ttu-id="c846b-394">Una vez que el script comprueba la instalación del módulo de PowerShell, muestra el cuadro de diálogo del módulo de PowerShell de Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="c846b-394">After the script verifies the installation of the PowerShell module, it displays the Azure Active Directory PowerShell module dialog box.</span></span> <span data-ttu-id="c846b-395">En el cuadro de diálogo, escriba sus credenciales de administrador de Azure AD y la contraseña y haga clic en **Iniciar sesión**.</span><span class="sxs-lookup"><span data-stu-id="c846b-395">In the dialog box, enter your Azure AD admin credentials and password, and click **Sign in**.</span></span> 
 
 ![Inicio de sesión de PowerShell](./media/nps-extension-vpn/image39.png)
 
5. <span data-ttu-id="c846b-397">Cuando se le solicite, pegue el identificador del inquilino que copió al Portapapeles anteriormente y presione **ENTRAR**.</span><span class="sxs-lookup"><span data-stu-id="c846b-397">When prompted, paste the tenant ID you copied to the clipboard earlier, and press **ENTER**.</span></span> 

 ![Id. de inquilino](./media/nps-extension-vpn/image40.png)

6. <span data-ttu-id="c846b-399">El script crea un certificado autofirmado y realiza otros cambios en la configuración.</span><span class="sxs-lookup"><span data-stu-id="c846b-399">The script creates a self-signed certificate and performs other configuration changes.</span></span> <span data-ttu-id="c846b-400">La salida es similar a la imagen que se muestra a continuación.</span><span class="sxs-lookup"><span data-stu-id="c846b-400">The output is like the image shown below.</span></span>

 ![Certificado autofirmado](./media/nps-extension-vpn/image41.png)

7. <span data-ttu-id="c846b-402">Reinicie el servidor.</span><span class="sxs-lookup"><span data-stu-id="c846b-402">Reboot the server.</span></span>
 
### <a name="verify-configuration"></a><span data-ttu-id="c846b-403">Comprobación de la configuración</span><span class="sxs-lookup"><span data-stu-id="c846b-403">Verify configuration</span></span>
<span data-ttu-id="c846b-404">Para comprobar la configuración, debe establecer una conexión VPN nueva con el servidor VPN.</span><span class="sxs-lookup"><span data-stu-id="c846b-404">To verify the configuration, you need to establish a new VPN connection with VPN server.</span></span> <span data-ttu-id="c846b-405">Después de escribir correctamente las credenciales para la autenticación principal, la conexión VPN espera a que la autenticación secundaria sea correcta para establecer la conexión, como se muestra a continuación.</span><span class="sxs-lookup"><span data-stu-id="c846b-405">Upon successfully entering your credentials for primary authentication, the VPN connection waits for the secondary authentication to succeed before the connection is established, as shown below.</span></span> 

 ![Comprobación de la configuración](./media/nps-extension-vpn/image42.png)

<span data-ttu-id="c846b-407">Si se autentica correctamente con el método de comprobación secundario que ha configurado previamente en Azure MFA, se conecta al recurso.</span><span class="sxs-lookup"><span data-stu-id="c846b-407">If you successfully authenticate with the secondary verification method you previously configured in Azure MFA, you are connected to the resource.</span></span> <span data-ttu-id="c846b-408">Sin embargo, si la autenticación secundaria no se realiza correctamente, se deniega el acceso al recurso.</span><span class="sxs-lookup"><span data-stu-id="c846b-408">However, if the secondary authentication is not successful, you are denied access to resource.</span></span> 

<span data-ttu-id="c846b-409">En el ejemplo siguiente, la aplicación Authenticator en un dispositivo Windows Phone se utiliza para proporcionar la autenticación secundaria.</span><span class="sxs-lookup"><span data-stu-id="c846b-409">In the example below, the Authenticator app on a Windows phone is used to provide the secondary authentication.</span></span>

 ![Comprobar cuenta](./media/nps-extension-vpn/image43.png)

<span data-ttu-id="c846b-411">Una vez que se haya autenticado correctamente con el método secundario, se le concede acceso al puerto virtual en el servidor VPN.</span><span class="sxs-lookup"><span data-stu-id="c846b-411">Once you have successfully authenticated using the secondary method, you are granted access to the virtual port on the VPN server.</span></span> <span data-ttu-id="c846b-412">Sin embargo, como ha sido necesario usar un método de autenticación secundario con una aplicación móvil en un dispositivo de confianza, el proceso de inicio de sesión es más seguro que utilizando solo una combinación de nombre de usuario y contraseña.</span><span class="sxs-lookup"><span data-stu-id="c846b-412">However, because you were required to use a secondary authentication method using a mobile app on a trusted device, the log in process is more secure than it would be using only a username / password combination.</span></span>

### <a name="view-event-viewer-logs-for-successful-logon-events"></a><span data-ttu-id="c846b-413">Ver los registros del Visor de eventos para eventos de inicio de sesión correcto</span><span class="sxs-lookup"><span data-stu-id="c846b-413">View Event Viewer logs for successful logon events</span></span>
<span data-ttu-id="c846b-414">Para ver los eventos de inicio de sesión correctos en los registros del Visor de eventos de Windows, puede utilizar el siguiente comando de Windows PowerShell para consultar el registro de seguridad de Windows en el servidor NPS.</span><span class="sxs-lookup"><span data-stu-id="c846b-414">To view the successful logon events in the Windows Event Viewer logs, you can issue the following Windows PowerShell command to query the Windows Security log on the NPS server.</span></span>

<span data-ttu-id="c846b-415">Para consultar los eventos de inicio de sesión correcto en los registros del Visor de eventos de seguridad, use el comando siguiente,</span><span class="sxs-lookup"><span data-stu-id="c846b-415">To query successful logon events in the Security event viewer logs, use the following command,</span></span>
* <span data-ttu-id="c846b-416">_Get-WinEvent -Logname Security_ | where {$_.ID -eq '6272'} | FL</span><span class="sxs-lookup"><span data-stu-id="c846b-416">_Get-WinEvent -Logname Security_ | where {$_.ID -eq '6272'} | FL</span></span> 

 ![Visor de eventos de seguridad](./media/nps-extension-vpn/image44.png)
 
<span data-ttu-id="c846b-418">También puede ver el registro de seguridad o la vista personalizada de Directivas de red y servicios de acceso, tal y como se muestra a continuación:</span><span class="sxs-lookup"><span data-stu-id="c846b-418">You can also view the Security log or the Network Policy and Access Services custom view, as shown below:</span></span>

 ![Acceso a la directiva de red](./media/nps-extension-vpn/image45.png)

<span data-ttu-id="c846b-420">En el servidor donde instaló la extensión NPS para Azure MFA, puede encontrar registros de aplicación del Visor de eventos específicos de la extensión en **Application and Services Logs\Microsoft\AzureMfa**.</span><span class="sxs-lookup"><span data-stu-id="c846b-420">On the server where you installed the NPS extension for Azure MFA, you can find Event Viewer application logs specific to the extension at **Application and Services Logs\Microsoft\AzureMfa**.</span></span> 

* <span data-ttu-id="c846b-421">_Get-WinEvent -Logname Security_ | where {$_.ID -eq '6272'} | FL</span><span class="sxs-lookup"><span data-stu-id="c846b-421">_Get-WinEvent -Logname Security_ | where {$_.ID -eq '6272'} | FL</span></span>

 ![Número de eventos](./media/nps-extension-vpn/image46.png)

## <a name="troubleshoot-guide"></a><span data-ttu-id="c846b-423">Guía de solución de problemas</span><span class="sxs-lookup"><span data-stu-id="c846b-423">Troubleshoot Guide</span></span>
<span data-ttu-id="c846b-424">Si la configuración no funciona según lo esperado, un buen lugar para comenzar es comprobar que el usuario está configurado para usar Azure MFA.</span><span class="sxs-lookup"><span data-stu-id="c846b-424">If the configuration is not working as expected, a good place to start to troubleshoot is to verify that the user is configured to use Azure MFA.</span></span> <span data-ttu-id="c846b-425">Haga que el usuario se conecte a [https://portal.azure.com](https://portal.azure.com). Si a los usuarios se les solicita la autenticación secundaria y se pueden autenticar correctamente, puede descartar una configuración incorrecta de Azure MFA.</span><span class="sxs-lookup"><span data-stu-id="c846b-425">Have the user connect to [https://portal.azure.com](https://portal.azure.com). If they are prompted for secondary authentication and can successfully authenticate, you can eliminate an incorrect configuration of Azure MFA.</span></span>

<span data-ttu-id="c846b-426">Si Azure MFA está funcionando para los usuarios, debe revisar los registros de eventos pertinentes.</span><span class="sxs-lookup"><span data-stu-id="c846b-426">If Azure MFA is working for the user(s), you should review the relevant Event logs.</span></span> <span data-ttu-id="c846b-427">Esto incluye los eventos de seguridad, de operativa de la puerta de enlace y los registros de Azure MFA que se describen en la sección anterior.</span><span class="sxs-lookup"><span data-stu-id="c846b-427">These include the Security Event, Gateway operational, and Azure MFA logs that are discussed in the previous section.</span></span> 

<span data-ttu-id="c846b-428">A continuación, se muestra un ejemplo de salida del registro de seguridad que muestra un evento de inicio de sesión incorrecto (identificador de evento 6273):</span><span class="sxs-lookup"><span data-stu-id="c846b-428">Below is an example output of Security log showing a failed logon event (Event ID 6273):</span></span>

 ![Registro de seguridad](./media/nps-extension-vpn/image47.png)

<span data-ttu-id="c846b-430">A continuación, se muestra un evento relacionado de los registros de AzureMFA:</span><span class="sxs-lookup"><span data-stu-id="c846b-430">Below is a related event from the AzureMFA logs:</span></span>

 ![Registros de Azure MFA](./media/nps-extension-vpn/image48.png)

<span data-ttu-id="c846b-432">Para realizar opciones avanzadas de solución de problemas, consulte los archivos de registro de formato de la base de datos de NPS donde está instalado el servicio NPS.</span><span class="sxs-lookup"><span data-stu-id="c846b-432">To perform advanced troubleshoot options, consult the NPS database format log files where the NPS service is installed.</span></span> <span data-ttu-id="c846b-433">Estos archivos de registro se crean en la carpeta _%SystemRoot%\System32\Logs_ como archivos de texto delimitado por comas.</span><span class="sxs-lookup"><span data-stu-id="c846b-433">These log files are created in _%SystemRoot%\System32\Logs_ folder as comma-delimited text files.</span></span> <span data-ttu-id="c846b-434">Para obtener una descripción de estos archivos de registro, consulte [Interpretación de los archivos de registro de formato de la base de datos de NPS](https://technet.microsoft.com/library/cc771748.aspx).</span><span class="sxs-lookup"><span data-stu-id="c846b-434">For a description of these log files, see [Interpret NPS Database Format Log Files](https://technet.microsoft.com/library/cc771748.aspx).</span></span> 

<span data-ttu-id="c846b-435">Las entradas de estos archivos de registro son difíciles de interpretar sin importarlos en una hoja de cálculo o una base de datos.</span><span class="sxs-lookup"><span data-stu-id="c846b-435">The entries in these log files are difficult to interpret without importing them into a spreadsheet or a database.</span></span> <span data-ttu-id="c846b-436">Puede encontrar varios analizadores de IAS en línea que le ayudarán a interpretar los archivos de registro.</span><span class="sxs-lookup"><span data-stu-id="c846b-436">You can find a number of IAS parsers online to assist you in interpreting the log files.</span></span> <span data-ttu-id="c846b-437">A continuación, se muestra la salida de una [aplicación shareware](http://www.deepsoftware.com/iasviewer) que se puede descargar:</span><span class="sxs-lookup"><span data-stu-id="c846b-437">Below is the output of one such downloadable [shareware application](http://www.deepsoftware.com/iasviewer):</span></span> 

 ![Aplicación shareware](./media/nps-extension-vpn/image49.png)

<span data-ttu-id="c846b-439">Por último, para más opciones de solución de problemas, puede utilizar un analizador de protocolos, como Wireshark o el [Analizador de mensajes de Microsoft](https://technet.microsoft.com/library/jj649776.aspx).</span><span class="sxs-lookup"><span data-stu-id="c846b-439">Finally, for additional troubleshoot options, you can use a protocol analyzer such as Wireshark or [Microsoft Message Analyzer](https://technet.microsoft.com/library/jj649776.aspx).</span></span> <span data-ttu-id="c846b-440">La siguiente imagen de Wireshark muestra los mensajes RADIUS entre el servidor VPN y el servidor NPS.</span><span class="sxs-lookup"><span data-stu-id="c846b-440">The following image from Wireshark shows the RADIUS messages between the VPN server and the NPS server.</span></span>

 ![Analizador de mensajes de Microsoft](./media/nps-extension-vpn/image50.png)

<span data-ttu-id="c846b-442">Para más información, consulte [Integración de la infraestructura NPS existente con Azure Multi-Factor Authentication](multi-factor-authentication-nps-extension.md).</span><span class="sxs-lookup"><span data-stu-id="c846b-442">For more information, see [Integrate your existing NPS infrastructure with Azure Multi-Factor Authentication](multi-factor-authentication-nps-extension.md).</span></span>  

## <a name="next-steps"></a><span data-ttu-id="c846b-443">Pasos siguientes</span><span class="sxs-lookup"><span data-stu-id="c846b-443">Next steps</span></span>
[<span data-ttu-id="c846b-444">Cómo conseguir Azure Multi-Factor Authentication</span><span class="sxs-lookup"><span data-stu-id="c846b-444">How to get Azure Multi-Factor Authentication</span></span>](multi-factor-authentication-versions-plans.md)

[<span data-ttu-id="c846b-445">Puerta de enlace de Escritorio remoto y Servidor Azure Multi-Factor Authentication con RADIUS</span><span class="sxs-lookup"><span data-stu-id="c846b-445">Remote Desktop Gateway and Azure Multi-Factor Authentication Server using RADIUS</span></span>](multi-factor-authentication-get-started-server-rdg.md)

[<span data-ttu-id="c846b-446">Integración de los directorios locales con Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="c846b-446">Integrate your on-premises directories with Azure Active Directory</span></span>](../active-directory/connect/active-directory-aadconnect.md)

