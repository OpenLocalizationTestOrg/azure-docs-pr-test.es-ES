---
title: "Sondeos personalizados del Equilibrador de carga y supervisión de estado de mantenimiento | Microsoft Docs"
description: "Aprenda a usar sondeos personalizados para el Equilibrador de carga de Azure para supervisar las instancias detrás de dicho Equilibrador."
services: load-balancer
documentationcenter: na
author: kumudd
manager: timlt
editor: 
tags: azure-resource-manager
ms.assetid: 46b152c5-6a27-4bfc-bea3-05de9ce06a57
ms.service: load-balancer
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 10/24/2016
ms.author: kumud
ms.openlocfilehash: cab028fed58d544a56f2f6b12b72364c7baf4d86
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 07/11/2017
---
# <a name="understand-load-balancer-probes"></a><span data-ttu-id="77dc6-103">Descripción de los sondeos del equilibrador de carga</span><span class="sxs-lookup"><span data-stu-id="77dc6-103">Understand load balancer probes</span></span>

<span data-ttu-id="77dc6-104">El Equilibrador de carga de Azure ofrece la capacidad de supervisar el estado de las instancias del servidor mediante sondeos.</span><span class="sxs-lookup"><span data-stu-id="77dc6-104">Azure Load Balancer offers the capability to monitor the health of server instances by using probes.</span></span> <span data-ttu-id="77dc6-105">Cuando un sondeo no responde, el Equilibrador de carga deja de enviar nuevas conexiones a la instancia incorrecta.</span><span class="sxs-lookup"><span data-stu-id="77dc6-105">When a probe fails to respond, Load Balancer stops sending new connections to the unhealthy instance.</span></span> <span data-ttu-id="77dc6-106">Las conexiones existentes no resultan afectadas y las nuevas conexiones se envían a instancias en buen estado.</span><span class="sxs-lookup"><span data-stu-id="77dc6-106">The existing connections are not affected, and new connections are sent to healthy instances.</span></span>

<span data-ttu-id="77dc6-107">Los roles del servicio en la nube (los roles de trabajo y los roles web) usan un agente invitado con supervisión del sondeo del agente invitado.</span><span class="sxs-lookup"><span data-stu-id="77dc6-107">Cloud service roles (worker roles and web roles) use a guest agent for probe monitoring.</span></span> <span data-ttu-id="77dc6-108">Deben configurarse sondeos TCP o HTTP personalizados al usar máquinas virtuales detrás del Equilibrador de carga.</span><span class="sxs-lookup"><span data-stu-id="77dc6-108">TCP or HTTP custom probes must be configured when you use virtual machines behind Load Balancer.</span></span>

## <a name="understand-probe-count-and-timeout"></a><span data-ttu-id="77dc6-109">Descripción del número y el tiempo de espera de los sondeos</span><span class="sxs-lookup"><span data-stu-id="77dc6-109">Understand probe count and timeout</span></span>

<span data-ttu-id="77dc6-110">El comportamiento de los sondeos depende de:</span><span class="sxs-lookup"><span data-stu-id="77dc6-110">Probe behavior depends on:</span></span>

* <span data-ttu-id="77dc6-111">El número de sondeos correctos que permiten que una instancia se etiquete como activa.</span><span class="sxs-lookup"><span data-stu-id="77dc6-111">The number of successful probes that allow an instance to be labeled as up.</span></span>
* <span data-ttu-id="77dc6-112">El número de sondeos erróneos que permiten que una instancia se etiquete como inactiva.</span><span class="sxs-lookup"><span data-stu-id="77dc6-112">The number of failed probes that cause an instance to be labeled as down.</span></span>

<span data-ttu-id="77dc6-113">El tiempo de espera y el valor de frecuencia establecidos en SuccessFailCount confirman si una instancia está en ejecución o en no ejecución.</span><span class="sxs-lookup"><span data-stu-id="77dc6-113">The timeout and frequency value set in  SuccessFailCount determine whether an instance is confirmed to be running or not running.</span></span> <span data-ttu-id="77dc6-114">En el portal de Azure, el tiempo de espera se establece en dos veces el valor de la frecuencia.</span><span class="sxs-lookup"><span data-stu-id="77dc6-114">In the Azure portal, the timeout is set to two times the value of the frequency.</span></span>

<span data-ttu-id="77dc6-115">La configuración de los sondeos de todas las instancias con carga equilibrada para un punto de conexión (es decir, un conjunto de carga equilibrada) debe ser igual.</span><span class="sxs-lookup"><span data-stu-id="77dc6-115">The probe configuration of all load-balanced instances for an endpoint (that is, a load-balanced set) must be the same.</span></span> <span data-ttu-id="77dc6-116">Esto significa que no puede tener una configuración de sondeo distinta para cada instancia de rol o máquina virtual en el mismo servicio hospedado para una combinación determinada de puntos de conexión.</span><span class="sxs-lookup"><span data-stu-id="77dc6-116">This means you cannot have a different probe configuration for each role instance or virtual machine in the same hosted service for a particular endpoint combination.</span></span> <span data-ttu-id="77dc6-117">Por ejemplo, cada instancia debe tener puertos locales y tiempos de espera idénticos.</span><span class="sxs-lookup"><span data-stu-id="77dc6-117">For example, each instance must have identical local ports and timeouts.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="77dc6-118">Un sondeo del Equilibrador de carga utiliza la dirección IP 168.63.129.16.</span><span class="sxs-lookup"><span data-stu-id="77dc6-118">A Load Balancer probe uses the IP address 168.63.129.16.</span></span> <span data-ttu-id="77dc6-119">Esta dirección IP pública facilita un canal de comunicación a los recursos internos de plataforma para el escenario de Red virtual de Azure que permite especificar su propia IP.</span><span class="sxs-lookup"><span data-stu-id="77dc6-119">This public IP address facilitates communication to internal platform resources for the bring-your-own-IP Azure Virtual Network scenario.</span></span> <span data-ttu-id="77dc6-120">La dirección IP pública virtual 168.63.129.16 se utiliza en todas las regiones y no cambiará.</span><span class="sxs-lookup"><span data-stu-id="77dc6-120">The virtual public IP address 168.63.129.16 is used in all regions and will not change.</span></span> <span data-ttu-id="77dc6-121">Le recomendamos que permita esta dirección IP en cualquiera de las directivas de firewall local.</span><span class="sxs-lookup"><span data-stu-id="77dc6-121">We recommend that you allow this IP address in any local firewall policies.</span></span> <span data-ttu-id="77dc6-122">No se debe considerar un riesgo de seguridad porque la plataforma interna de Azure es la única que puede originar un mensaje procedente de esa dirección.</span><span class="sxs-lookup"><span data-stu-id="77dc6-122">It should not be considered a security risk because only the internal Azure platform can source a message from that address.</span></span> <span data-ttu-id="77dc6-123">Si no hace esto, se producirá un comportamiento inesperado en varios escenarios, como la configuración del mismo intervalo de direcciones IP de 168.63.129.16 y el hecho de contar con direcciones IP duplicadas.</span><span class="sxs-lookup"><span data-stu-id="77dc6-123">If you do not do this, there will be unexpected behavior in a variety of scenarios like configuring the same IP address range of 168.63.129.16 and having duplicated IP addresses.</span></span>

## <a name="learn-about-the-types-of-probes"></a><span data-ttu-id="77dc6-124">Obtención de información sobre el tipo de sondeo</span><span class="sxs-lookup"><span data-stu-id="77dc6-124">Learn about the types of probes</span></span>

### <a name="guest-agent-probe"></a><span data-ttu-id="77dc6-125">Sondeo de agente invitado</span><span class="sxs-lookup"><span data-stu-id="77dc6-125">Guest agent probe</span></span>

<span data-ttu-id="77dc6-126">Este sondeo solo está disponible para Servicios en la nube de Azure.</span><span class="sxs-lookup"><span data-stu-id="77dc6-126">This probe is available for Azure Cloud Services only.</span></span> <span data-ttu-id="77dc6-127">El Equilibrador de carga usa al agente invitado que hay dentro de la máquina virtual y después escucha y responde con una respuesta HTTP 200 OK solo cuando la instancia está en estado Preparada (es decir, no se encuentra en otro, como Ocupada, Reciclando, Deteniendo, etc.).</span><span class="sxs-lookup"><span data-stu-id="77dc6-127">Load Balancer utilizes the guest agent inside the virtual machine, and then listens and responds with an HTTP 200 OK response only when the instance is in the Ready state (that is, not in another state such as Busy, Recycling, or Stopping).</span></span>

<span data-ttu-id="77dc6-128">Para más información, consulte [Configuring the service definition file (csdef) for health probes](https://msdn.microsoft.com/library/azure/ee758710.aspx) (Configuración del archivo de definición de servicio (csdef) para los sondeos de estado) o [Introducción a la creación de un equilibrador de carga orientado a Internet para servicios en la nube](load-balancer-get-started-internet-classic-cloud.md#check-load-balancer-health-status-for-cloud-services).</span><span class="sxs-lookup"><span data-stu-id="77dc6-128">For more information, see [Configuring the service definition file (csdef) for health probes](https://msdn.microsoft.com/library/azure/ee758710.aspx) or [Get started creating an Internet-facing load balancer for cloud services](load-balancer-get-started-internet-classic-cloud.md#check-load-balancer-health-status-for-cloud-services).</span></span>

### <a name="what-makes-a-guest-agent-probe-mark-an-instance-as-unhealthy"></a><span data-ttu-id="77dc6-129">¿Qué hace que un sondeo de agente invitado marque una instancia como en mal estado?</span><span class="sxs-lookup"><span data-stu-id="77dc6-129">What makes a guest agent probe mark an instance as unhealthy?</span></span>

<span data-ttu-id="77dc6-130">Si el agente invitado no responde con HTTP 200 OK, el equilibrador de carga marca la instancia como sin respuesta y deja de enviar tráfico a esa instancia.</span><span class="sxs-lookup"><span data-stu-id="77dc6-130">If the guest agent fails to respond with HTTP 200 OK, the load balancer marks the instance as unresponsive and stops sending traffic to that instance.</span></span> <span data-ttu-id="77dc6-131">El equilibrador de carga continúa para hacer ping a la instancia.</span><span class="sxs-lookup"><span data-stu-id="77dc6-131">The load balancer continues to ping the instance.</span></span> <span data-ttu-id="77dc6-132">Si el agente invitado responde con un HTTP 200, el equilibrador de carga envía de nuevo tráfico a esa instancia.</span><span class="sxs-lookup"><span data-stu-id="77dc6-132">If the guest agent responds with an HTTP 200, the load balancer sends traffic to that instance again.</span></span>

<span data-ttu-id="77dc6-133">Cuando se usa un rol web, el código de sitio web normalmente se ejecuta en w3wp.exe, que no está supervisado por el agente invitado o el tejido de Azure.</span><span class="sxs-lookup"><span data-stu-id="77dc6-133">When you use a web role, the website code typically runs in w3wp.exe, which is not monitored by the Azure fabric or guest agent.</span></span> <span data-ttu-id="77dc6-134">Esto significa que los errores en w3wp.exe (por ejemplo, respuestas HTTP 500) no se notificarán al agente invitado y el equilibrador de carga no sacará esa instancia de la rotación.</span><span class="sxs-lookup"><span data-stu-id="77dc6-134">This means that failures in w3wp.exe (for example, HTTP 500 responses) will not be reported to the guest agent, and the load balancer will not take that instance out of rotation.</span></span>

### <a name="http-custom-probe"></a><span data-ttu-id="77dc6-135">Sondeo HTTP personalizado</span><span class="sxs-lookup"><span data-stu-id="77dc6-135">HTTP custom probe</span></span>

<span data-ttu-id="77dc6-136">El sondeo HTTP personalizado del Equilibrador de carga invalida el sondeo del agente invitado predeterminado, lo que significa que usted puede crear su propia lógica personalizada para determinar el estado de la instancia de rol.</span><span class="sxs-lookup"><span data-stu-id="77dc6-136">The custom HTTP Load Balancer probe overrides the default guest agent probe, which means that you can create your own custom logic to determine the health of the role instance.</span></span> <span data-ttu-id="77dc6-137">El equilibrador de carga sondea el punto de conexión cada 15 segundos de forma predeterminada.</span><span class="sxs-lookup"><span data-stu-id="77dc6-137">The load balancer probes your endpoint every 15 seconds, by default.</span></span> <span data-ttu-id="77dc6-138">Se considera que la instancia está en la rotación del equilibrador de carga si responde con un HTTP 200 dentro del período de tiempo de espera (que, de forma predeterminada, es 31 segundos).</span><span class="sxs-lookup"><span data-stu-id="77dc6-138">The instance is considered to be in the load balancer rotation if it responds with an HTTP 200 within the timeout period (31 seconds by default).</span></span>

<span data-ttu-id="77dc6-139">Esto puede resultar útil si desea implementar su propia lógica para quitar instancias de rotación del equilibrador de carga.</span><span class="sxs-lookup"><span data-stu-id="77dc6-139">This can be useful if you want to implement your own logic to remove instances from load balancer rotation.</span></span> <span data-ttu-id="77dc6-140">Por ejemplo, podría decidir quitar una instancia si está por encima del 90 % de la CPU y devuelve un estado no 200.</span><span class="sxs-lookup"><span data-stu-id="77dc6-140">For example, you could decide to remove an instance if it is above 90% CPU and returns a non-200 status.</span></span> <span data-ttu-id="77dc6-141">Si tiene roles web que usan w3wp.exe, esto también significa que dispone de supervisión automática de su sitio web, porque los errores en el código de su sitio web devolverán un estado diferente de 200 al sondeo del equilibrador de carga.</span><span class="sxs-lookup"><span data-stu-id="77dc6-141">If you have web roles that use w3wp.exe, this also means you get automatic monitoring of your website, because failures in your website code will return a non-200 status to the load balancer probe.</span></span>

> [!NOTE]
> <span data-ttu-id="77dc6-142">El sondeo personalizado HTTP admite solo rutas de acceso relativas y protocolo HTTP.</span><span class="sxs-lookup"><span data-stu-id="77dc6-142">The HTTP custom probe supports relative paths and HTTP protocol only.</span></span> <span data-ttu-id="77dc6-143">HTTPS no es compatible.</span><span class="sxs-lookup"><span data-stu-id="77dc6-143">HTTPS is not supported.</span></span>

### <a name="what-makes-an-http-custom-probe-mark-an-instance-as-unhealthy"></a><span data-ttu-id="77dc6-144">¿Qué hace que un sondeo HTTP personalizado marque una instancia como en mal estado?</span><span class="sxs-lookup"><span data-stu-id="77dc6-144">What makes an HTTP custom probe mark an instance as unhealthy?</span></span>

* <span data-ttu-id="77dc6-145">La aplicación HTTP devuelve un código HTTP de respuesta distinto de 200 (por ejemplo, 403, 404 o 500).</span><span class="sxs-lookup"><span data-stu-id="77dc6-145">The HTTP application returns an HTTP response code other than 200 (for example, 403, 404, or 500).</span></span> <span data-ttu-id="77dc6-146">Se trata de una confirmación positiva de que la instancia de la aplicación debe desconectarse del servicio inmediatamente.</span><span class="sxs-lookup"><span data-stu-id="77dc6-146">This is a positive acknowledgment that the application instance should be taken out of service right away.</span></span>
* <span data-ttu-id="77dc6-147">El servidor HTTP no responde en absoluto después del período de tiempo de espera.</span><span class="sxs-lookup"><span data-stu-id="77dc6-147">The HTTP server does not respond at all after the timeout period.</span></span> <span data-ttu-id="77dc6-148">Dependiendo del valor del tiempo de espera establecido, esto podría significar que varias solicitudes de sondeo van sin respuesta antes de que el sondeo se marque como no en ejecutando (es decir, antes de que se envíen sondeos SuccessFailCount).</span><span class="sxs-lookup"><span data-stu-id="77dc6-148">Depending on the timeout value that is set, this might mean that multiple probe requests go unanswered before the probe gets marked as not running (that is, before SuccessFailCount probes are sent).</span></span>
* <span data-ttu-id="77dc6-149">El servidor cierra la conexión a través de un restablecimiento TCP.</span><span class="sxs-lookup"><span data-stu-id="77dc6-149">The server closes the connection via a TCP reset.</span></span>

### <a name="tcp-custom-probe"></a><span data-ttu-id="77dc6-150">Sondeo TCP personalizado</span><span class="sxs-lookup"><span data-stu-id="77dc6-150">TCP custom probe</span></span>

<span data-ttu-id="77dc6-151">Los sondeos TCP inician una conexión mediante la realización de un protocolo de enlace de tres vías con el puerto definido.</span><span class="sxs-lookup"><span data-stu-id="77dc6-151">TCP probes initiate a connection by performing a three-way handshake with the defined port.</span></span>

### <a name="what-makes-a-tcp-custom-probe-mark-an-instance-as-unhealthy"></a><span data-ttu-id="77dc6-152">¿Qué hace que un sondeo TCP personalizado marque una instancia como en mal estado?</span><span class="sxs-lookup"><span data-stu-id="77dc6-152">What makes a TCP custom probe mark an instance as unhealthy?</span></span>

* <span data-ttu-id="77dc6-153">El servidor TCP no responde en absoluto después del período de tiempo de espera.</span><span class="sxs-lookup"><span data-stu-id="77dc6-153">The TCP server does not respond at all after the timeout period.</span></span> <span data-ttu-id="77dc6-154">Cuando el sondeo se marca como no en ejecución depende del número de solicitudes de sondeo con error que se configuraron para ir sin respuesta antes de marcar el sondeo como no en ejecución.</span><span class="sxs-lookup"><span data-stu-id="77dc6-154">When the probe is marked as not running depends on the number of failed probe requests that were configured to go unanswered before marking the probe as not running.</span></span>
* <span data-ttu-id="77dc6-155">El sondeo recibe un restablecimiento TCP de la instancia de rol.</span><span class="sxs-lookup"><span data-stu-id="77dc6-155">The probe receives a TCP reset from the role instance.</span></span>

<span data-ttu-id="77dc6-156">Para más información sobre cómo configurar un sondeo de estado HTTP o un sondeo TCP, consulte [Introducción a la creación de un equilibrador de carga orientado a Internet en el Administrador de recursos con PowerShell](load-balancer-get-started-internet-arm-ps.md).</span><span class="sxs-lookup"><span data-stu-id="77dc6-156">For more information about configuring an HTTP health probe or a TCP probe, see [Get started creating an Internet-facing load balancer in Resource Manager using PowerShell](load-balancer-get-started-internet-arm-ps.md).</span></span>

## <a name="add-healthy-instances-back-into-load-balancer-rotation"></a><span data-ttu-id="77dc6-157">Incorporación de instancias en estado correcto de nuevo en la rotación del equilibrador de carga</span><span class="sxs-lookup"><span data-stu-id="77dc6-157">Add healthy instances back into load balancer rotation</span></span>

<span data-ttu-id="77dc6-158">Los sondeos TCP y HTTP se consideran en buen estado y marcan la instancia de rol como en buen estado en los casos siguientes:</span><span class="sxs-lookup"><span data-stu-id="77dc6-158">TCP and HTTP probes are considered healthy and mark the role instance as healthy when:</span></span>

* <span data-ttu-id="77dc6-159">El equilibrador de carga obtiene un sondeo positivo la primera vez que se inicia la máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="77dc6-159">The load balancer gets a positive probe the first time the VM boots.</span></span>
* <span data-ttu-id="77dc6-160">El número SuccessFailCount (descrito anteriormente) define el valor de los sondeos correctos que son necesarios para marcar la instancia de rol como en buen estado.</span><span class="sxs-lookup"><span data-stu-id="77dc6-160">The number SuccessFailCount (described earlier) defines the value of successful probes that are required to mark the role instance as healthy.</span></span> <span data-ttu-id="77dc6-161">Si se quitó una instancia de rol, el número de sondeos correctos y sucesivos debe ser igual o superior al valor de SuccessFailCount para marcar la instancia de rol como en ejecución.</span><span class="sxs-lookup"><span data-stu-id="77dc6-161">If a role instance was removed, the number of successful, successive probes must equal or exceed the value of SuccessFailCount to mark the role instance as running.</span></span>

> [!NOTE]
> <span data-ttu-id="77dc6-162">Si el estado de una instancia de rol fluctúa, el equilibrador de carga espera más tiempo antes de devolver dicha instancia al estado correcto.</span><span class="sxs-lookup"><span data-stu-id="77dc6-162">If the health of a role instance is fluctuating, the load balancer waits longer before putting the role instance back in the healthy state.</span></span> <span data-ttu-id="77dc6-163">Esto se hace mediante la directiva para proteger al usuario y a la infraestructura.</span><span class="sxs-lookup"><span data-stu-id="77dc6-163">This is done via policy to protect the user and the infrastructure.</span></span>

## <a name="use-log-analytics-for-load-balancer"></a><span data-ttu-id="77dc6-164">Uso del análisis de registros para el Equilibrador de carga</span><span class="sxs-lookup"><span data-stu-id="77dc6-164">Use log analytics for Load Balancer</span></span>

<span data-ttu-id="77dc6-165">Puede usar el [análisis de registros para el Equilibrador de carga](load-balancer-monitor-log.md) para comprobar el estado de mantenimiento de un sondeo y el número de sondeos.</span><span class="sxs-lookup"><span data-stu-id="77dc6-165">You can use [log analytics for Load Balancer](load-balancer-monitor-log.md) to check on the probe health status and probe count.</span></span> <span data-ttu-id="77dc6-166">El registro se puede utilizar con Power BI o con Visión operativa de Azure para proporcionar estadísticas del estado de mantenimiento del Equilibrador de carga.</span><span class="sxs-lookup"><span data-stu-id="77dc6-166">Logging can be used with Power BI or Azure Operational Insights to provide statistics about Load Balancer health status.</span></span>
