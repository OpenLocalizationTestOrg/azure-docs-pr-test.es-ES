---
title: Usar Azure API Management con redes virtuales
description: "Obtenga información sobre cómo configurar una conexión a una red virtual en Azure API Management y acceder a servicios web con esta."
services: api-management
documentationcenter: 
author: antonba
manager: erikre
editor: 
ms.assetid: 64b58f7b-ca22-47dc-89c0-f6bb0af27a48
ms.service: api-management
ms.workload: mobile
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 12/15/2016
ms.author: apimpm
ms.openlocfilehash: 268cee739188d81feffc36ac07fcdfa18ff95a4d
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 08/18/2017
---
# <a name="how-to-use-azure-api-management-with-virtual-networks"></a><span data-ttu-id="57c37-103">Usar Azure API Management con redes virtuales</span><span class="sxs-lookup"><span data-stu-id="57c37-103">How to use Azure API Management with virtual networks</span></span>
<span data-ttu-id="57c37-104">Las redes virtuales de Azure (VNET) le permiten colocar cualquier recurso de Azure en una red que se pueda enrutar distinta de Internet y a la que controla el acceso.</span><span class="sxs-lookup"><span data-stu-id="57c37-104">Azure Virtual Networks (VNETs) allow you to place any of your Azure resources in a non-internet routeable network that you control access to.</span></span> <span data-ttu-id="57c37-105">Después, estas redes se pueden conectar a sus redes locales mediante diversas tecnologías de VPN.</span><span class="sxs-lookup"><span data-stu-id="57c37-105">These networks can then be connected to your on-premises networks using various VPN technologies.</span></span> <span data-ttu-id="57c37-106">Para más información sobre las redes virtuales de Azure, vea: [Información general sobre redes virtuales](../virtual-network/virtual-networks-overview.md).</span><span class="sxs-lookup"><span data-stu-id="57c37-106">To learn more about Azure Virtual Networks start with the information here: [Azure Virtual Network Overview](../virtual-network/virtual-networks-overview.md).</span></span>

<span data-ttu-id="57c37-107">Azure API Management se puede implementar dentro de la red virtual (VNET), por lo que puede tener acceso a los servicios back-end dentro de la red.</span><span class="sxs-lookup"><span data-stu-id="57c37-107">Azure API Management can be deployed inside the virtual network (VNET), so it can access backend services within the network.</span></span> <span data-ttu-id="57c37-108">El portal para desarrolladores y la puerta de enlace de API pueden configurarse para que sea accesible desde Internet o solo dentro de la red virtual.</span><span class="sxs-lookup"><span data-stu-id="57c37-108">The developer portal and API gateway, can be configured to be accessible either from the Internet or only within the virtual network.</span></span>

> [!NOTE]
> <span data-ttu-id="57c37-109">Azure API Management admite redes virtuales clásicas y de Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="57c37-109">Azure API Management supports both classic and Azure Resource Manager VNets.</span></span>
>
>

## <span data-ttu-id="57c37-110"><a name="enable-vpn"> </a>Habilitar la conexión de VNET</span><span class="sxs-lookup"><span data-stu-id="57c37-110"><a name="enable-vpn"> </a>Enable VNET connection</span></span>
> [!NOTE]
> <span data-ttu-id="57c37-111">La conectividad de VNET está disponible en los niveles **Premium** y **Desarrollador**.</span><span class="sxs-lookup"><span data-stu-id="57c37-111">VNET connectivity is available in the **Premium** and **Developer** tiers.</span></span> <span data-ttu-id="57c37-112">Para cambiar de nivel, abra el servicio API Management en Azure Portal y, después, abra la pestaña **Scale and pricing** (Escala y precios). En la sección **Plan de tarifa**, seleccione el nivel Premium o Developer y haga clic en Guardar.</span><span class="sxs-lookup"><span data-stu-id="57c37-112">To switch between the tiers, open your API Management service in the Azure portal and then open the **Scale and pricing** tab. Under the **Pricing tier** section, select the Premium or Developer tier and click Save.</span></span>
>

<span data-ttu-id="57c37-113">Para habilitar la conectividad de VNET, abra el servicio API Management en Azure Portal y, después, abra la página **Red virtual**.</span><span class="sxs-lookup"><span data-stu-id="57c37-113">To enable VNET connectivity, open your API Management service in the Azure portal and open the **Virtual network** page.</span></span>

![Menú Red virtual de API Management][api-management-using-vnet-menu]

<span data-ttu-id="57c37-115">Seleccione el tipo de acceso que prefiera:</span><span class="sxs-lookup"><span data-stu-id="57c37-115">Select the desired access type:</span></span>

* <span data-ttu-id="57c37-116">**Externo:** la puerta de enlace de API Management y el portal para desarrolladores son accesibles públicamente desde Internet con un equilibrador de carga externo.</span><span class="sxs-lookup"><span data-stu-id="57c37-116">**External**: the API Management gateway and developer portal are accessible from the public internet via an external load balancer.</span></span> <span data-ttu-id="57c37-117">La puerta de enlace puede acceder a recursos dentro de la red virtual.</span><span class="sxs-lookup"><span data-stu-id="57c37-117">The gateway can access resources within the virtual network.</span></span>

![Emparejamiento público][api-management-vnet-public]

* <span data-ttu-id="57c37-119">**Interno:** la puerta de enlace de API Management y el portal para desarrolladores solo son accesibles desde la red virtual con un equilibrador de carga interno.</span><span class="sxs-lookup"><span data-stu-id="57c37-119">**Internal**: the API Management gateway and developer portal are accessible only from within the virtual network via an internal load balancer.</span></span> <span data-ttu-id="57c37-120">La puerta de enlace puede acceder a recursos dentro de la red virtual.</span><span class="sxs-lookup"><span data-stu-id="57c37-120">The gateway can access resources within the virtual network.</span></span>

![Emparejamiento privado][api-management-vnet-private]

<span data-ttu-id="57c37-122">Ahora verá una lista de todas las regiones donde se aprovisiona el servicio Administración de API.</span><span class="sxs-lookup"><span data-stu-id="57c37-122">You will now see a list of all regions where your API Management service is provisioned.</span></span> <span data-ttu-id="57c37-123">Seleccione una VNET y la subred de cada región.</span><span class="sxs-lookup"><span data-stu-id="57c37-123">Select a VNET and subnet for every region.</span></span> <span data-ttu-id="57c37-124">La lista se rellena con redes virtuales de Resource Manager y clásicas disponibles en las suscripciones de Azure que se configuran en la región que va a configurar.</span><span class="sxs-lookup"><span data-stu-id="57c37-124">The list is populated with both classic and Resource Manager virtual networks available in your Azure subscriptions that are setup in the region you are configuring.</span></span>

> [!NOTE]
> <span data-ttu-id="57c37-125">**Punto de conexión de servicio** en el diagrama anterior incluye la puerta de enlace o proxy, el portal para desarrolladores, el portal para editores, GIT y el punto de conexión de administración directa.</span><span class="sxs-lookup"><span data-stu-id="57c37-125">**Service Endpoint** in the above diagram includes Gateway/Proxy, Publisher Portal, Developer Portal, GIT, and the Direct Management Endpoint.</span></span>
> <span data-ttu-id="57c37-126">**Punto de conexión de administración** en el diagrama anterior es el punto de conexión hospedado en el servicio para administrar la configuración mediante Azure Portal y Powershell.</span><span class="sxs-lookup"><span data-stu-id="57c37-126">**Management Endpoint** in the above diagram is the endpoint hosted on the service to manage configuration via Azure portal and Powershell.</span></span>
> <span data-ttu-id="57c37-127">Además, tenga en cuenta que, aunque el diagrama muestra las direcciones IP para sus diversos puntos de conexión, el servicio API Management **solo** responde en sus nombres de host configurados.</span><span class="sxs-lookup"><span data-stu-id="57c37-127">Also, note, that, even though, the diagram shows IP Addresses for its various endpoints, API Management service **only** responds on its configured Hostnames.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="57c37-128">Al implementar una instancia de Azure API Management en una VNET de Resource Manager, el servicio debe estar en una subred dedicada que no contiene ningún otro recurso excepto instancias de Azure API Management.</span><span class="sxs-lookup"><span data-stu-id="57c37-128">When deploying an Azure API Management instance to a Resource Manager VNET, the service must be in a dedicated subnet that contains no other resources except for Azure API Management instances.</span></span> <span data-ttu-id="57c37-129">Si se intenta implementar una instancia de Azure API Management en una subred de VNET de Resource Manager que contiene otros recursos, se producirá un error en la implementación.</span><span class="sxs-lookup"><span data-stu-id="57c37-129">If an attempt is made to deploy an Azure API Management instance to a Resource Manager VNET subnet that contains other resources, the deployment will fail.</span></span>
>
>

![Selección de una VPN][api-management-setup-vpn-select]

<span data-ttu-id="57c37-131">Haga clic en **Guardar** en la parte superior de la pantalla.</span><span class="sxs-lookup"><span data-stu-id="57c37-131">Click **Save** at the top of the screen.</span></span>

> [!NOTE]
> <span data-ttu-id="57c37-132">Tenga en cuenta que la dirección VIP de la instancia de API Management cambiará cada vez que se habilita o deshabilita VNET.</span><span class="sxs-lookup"><span data-stu-id="57c37-132">The VIP address of the API Management instance will change each time VNET is enabled or disabled.</span></span>  
> <span data-ttu-id="57c37-133">La dirección VIP también cambia cuando se mueve API Management de **externo** a **interno** o viceversa.</span><span class="sxs-lookup"><span data-stu-id="57c37-133">The VIP address will also change when API Management is moved from **External** to **Internal** or vice-versa</span></span>
>


> [!IMPORTANT]
> <span data-ttu-id="57c37-134">Si quita API Management de una red virtual o cambia aquella en la que se implementa, la red virtual usada anteriormente puede permanecer bloqueada hasta 4 horas.</span><span class="sxs-lookup"><span data-stu-id="57c37-134">If you remove API Management from a VNET or change the one it is deployed in, the previously used VNET can remain locked for up to 4 hours.</span></span> <span data-ttu-id="57c37-135">Durante este periodo no será posible eliminar la red virtual ni implementar un nuevo recurso en ella.</span><span class="sxs-lookup"><span data-stu-id="57c37-135">During this period it will not be possible to delete the VNET or deploy a new resource to it.</span></span>

## <span data-ttu-id="57c37-136"><a name="enable-vnet-powershell"> </a>Habilitar una conexión de VNET con cmdlets de PowerShell</span><span class="sxs-lookup"><span data-stu-id="57c37-136"><a name="enable-vnet-powershell"> </a>Enable VNET connection using PowerShell cmdlets</span></span>
<span data-ttu-id="57c37-137">También puede habilitar la conectividad de VNET con los cmdlets de PowerShell</span><span class="sxs-lookup"><span data-stu-id="57c37-137">You can also enable VNET connectivity using the PowerShell cmdlets</span></span>

* <span data-ttu-id="57c37-138">**Crear un servicio de API Management dentro de una red virtual**: use el cmdlet [New-AzureRmApiManagement](/powershell/module/azurerm.apimanagement/new-azurermapimanagement) para crear un servicio de Azure API Management dentro de una VNET.</span><span class="sxs-lookup"><span data-stu-id="57c37-138">**Create an API Management service inside a VNET**: Use the cmdlet [New-AzureRmApiManagement](/powershell/module/azurerm.apimanagement/new-azurermapimanagement) to create an Azure API Management service inside a VNET.</span></span>

* <span data-ttu-id="57c37-139">**Implementar un servicio existente de API Management dentro de una VNET**: use el cmdlet [Update-AzureRmApiManagementDeployment](/powershell/module/azurerm.apimanagement/update-azurermapimanagementdeployment) para mover un servicio existente de Azure API Management dentro de una red virtual.</span><span class="sxs-lookup"><span data-stu-id="57c37-139">**Deploy an existing API Management service inside a VNET**: Use the cmdlet [Update-AzureRmApiManagementDeployment](/powershell/module/azurerm.apimanagement/update-azurermapimanagementdeployment) to move an existing Azure API Management service inside a Virtual Network.</span></span>

## <span data-ttu-id="57c37-140"><a name="connect-vnet"> </a>Conectar a un servicio web hospedado en una red virtual</span><span class="sxs-lookup"><span data-stu-id="57c37-140"><a name="connect-vnet"> </a>Connect to a web service hosted within a virtual Network</span></span>
<span data-ttu-id="57c37-141">Después de conectar el servicio API Management a la VNET, se accede a los servicios de back-end de la misma forma que a los servicios públicos.</span><span class="sxs-lookup"><span data-stu-id="57c37-141">After your API Management service is connected to the VNET, accessing backend services within it is no different than accessing public services.</span></span> <span data-ttu-id="57c37-142">Solo tiene que escribir la dirección IP local o el nombre de host (si se ha configurado un servidor DNS para la VNET) del servicio web en el campo **Dirección URL de servicio web** al crear una API o editar una existente.</span><span class="sxs-lookup"><span data-stu-id="57c37-142">Just type in the local IP address or the host name (if a DNS server is configured for the VNET) of your web service into the **Web service URL** field when creating a new API or editing an existing one.</span></span>

![Agregar una API desde VPN][api-management-setup-vpn-add-api]

## <span data-ttu-id="57c37-144"><a name="network-configuration-issues"> </a>Problemas comunes de configuración de red</span><span class="sxs-lookup"><span data-stu-id="57c37-144"><a name="network-configuration-issues"> </a>Common Network Configuration Issues</span></span>
<span data-ttu-id="57c37-145">A continuación se muestra una lista de problemas de errores de configuración comunes que pueden producirse al implementar el servicio de API Management en una red virtual.</span><span class="sxs-lookup"><span data-stu-id="57c37-145">Following is a list of common misconfiguration issues that can occur while deploying API Management service into a Virtual Network.</span></span>

* <span data-ttu-id="57c37-146">**Configuración del servidor DNS personalizado**: el servicio de API Management depende de varios servicios de Azure.</span><span class="sxs-lookup"><span data-stu-id="57c37-146">**Custom DNS server setup**: The API Management service depends on several Azure services.</span></span> <span data-ttu-id="57c37-147">Cuando API Management está hospedado en una red virtual con un servidor DNS personalizado, necesita resolver los nombres de host de esos servicios de Azure.</span><span class="sxs-lookup"><span data-stu-id="57c37-147">When API Management is hosted in a VNET with a custom DNS server, it needs to resolve the hostnames of those Azure services.</span></span> <span data-ttu-id="57c37-148">Siga [estas](../virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances.md#name-resolution-using-your-own-dns-server) instrucciones sobre la configuración de DNS personalizado.</span><span class="sxs-lookup"><span data-stu-id="57c37-148">Please follow [this](../virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances.md#name-resolution-using-your-own-dns-server) guidance on custom DNS setup.</span></span> <span data-ttu-id="57c37-149">Vea la siguiente tabla de puertos y otros requisitos de red a efectos de referencia.</span><span class="sxs-lookup"><span data-stu-id="57c37-149">See the ports table below and other network requirements for reference.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="57c37-150">Se recomienda que, si usa un servidor de DNS personalizado para la red virtual, lo configure **antes** de implementar en él un servicio de API Management.</span><span class="sxs-lookup"><span data-stu-id="57c37-150">It is recommended that, if you are using a Custom DNS Server(s) for the VNET, you set that up **before** deploying an API Management service into it.</span></span> <span data-ttu-id="57c37-151">En caso contrario, debe actualizar el servicio API Management cada vez que cambie los servidores DNS (s) mediante la ejecución de la [operación Aplicar configuración de red](https://docs.microsoft.com/en-us/rest/api/apimanagement/apimanagementservice#ApiManagementService_ApplyNetworkConfigurationUpdates).</span><span class="sxs-lookup"><span data-stu-id="57c37-151">Otherwise you need to update the API Management service each time you change the DNS Servers(s) by running the [Apply Network Configuration Operation](https://docs.microsoft.com/en-us/rest/api/apimanagement/apimanagementservice#ApiManagementService_ApplyNetworkConfigurationUpdates)</span></span>

* <span data-ttu-id="57c37-152">**Puertos necesarios para API Management**: el tráfico entrante y saliente en la subred en la que se implementa API Management puede controlarse mediante el [grupo de seguridad de red][Network Security Group].</span><span class="sxs-lookup"><span data-stu-id="57c37-152">**Ports required for API Management**: Inbound and Outbound traffic into the Subnet in which API Management is deployed can be controlled using [Network Security Group][Network Security Group].</span></span> <span data-ttu-id="57c37-153">Si alguno de estos puertos no está disponible, es posible que API Management no funcione correctamente y sea inaccesible.</span><span class="sxs-lookup"><span data-stu-id="57c37-153">If any of these ports are unavailable, API Management may not operate properly and may become inaccessible.</span></span> <span data-ttu-id="57c37-154">Tener bloqueados uno o varios de estos puertos es otro problema común de una configuración incorrecta cuando se usa API Management con una red virtual.</span><span class="sxs-lookup"><span data-stu-id="57c37-154">Having one or more of these ports blocked is another common misconfiguration issue when using API Management with a VNET.</span></span>

<span data-ttu-id="57c37-155">Cuando la instancia del servicio de Administración de API se hospeda en una red virtual, se usan los puertos de la tabla siguiente.</span><span class="sxs-lookup"><span data-stu-id="57c37-155">When an API Management service instance is hosted in a VNET, the ports in the following table are used.</span></span>

| <span data-ttu-id="57c37-156">Puertos de origen/destino</span><span class="sxs-lookup"><span data-stu-id="57c37-156">Source / Destination Port(s)</span></span> | <span data-ttu-id="57c37-157">Dirección</span><span class="sxs-lookup"><span data-stu-id="57c37-157">Direction</span></span> | <span data-ttu-id="57c37-158">Protocolo de transporte</span><span class="sxs-lookup"><span data-stu-id="57c37-158">Transport protocol</span></span> | <span data-ttu-id="57c37-159">Propósito</span><span class="sxs-lookup"><span data-stu-id="57c37-159">Purpose</span></span> | <span data-ttu-id="57c37-160">Origen/destino</span><span class="sxs-lookup"><span data-stu-id="57c37-160">Source / Destination</span></span> | <span data-ttu-id="57c37-161">Tipo de acceso</span><span class="sxs-lookup"><span data-stu-id="57c37-161">Access type</span></span> |
| --- | --- | --- | --- | --- | --- |
| <span data-ttu-id="57c37-162">* / 80, 443</span><span class="sxs-lookup"><span data-stu-id="57c37-162">* / 80, 443</span></span> |<span data-ttu-id="57c37-163">Entrada</span><span class="sxs-lookup"><span data-stu-id="57c37-163">Inbound</span></span> |<span data-ttu-id="57c37-164">TCP</span><span class="sxs-lookup"><span data-stu-id="57c37-164">TCP</span></span> |<span data-ttu-id="57c37-165">Comunicación de cliente con Administración de API</span><span class="sxs-lookup"><span data-stu-id="57c37-165">Client communication to API Management</span></span> |<span data-ttu-id="57c37-166">INTERNET/VIRTUAL_NETWORK</span><span class="sxs-lookup"><span data-stu-id="57c37-166">INTERNET / VIRTUAL_NETWORK</span></span> |<span data-ttu-id="57c37-167">Externo</span><span class="sxs-lookup"><span data-stu-id="57c37-167">External</span></span> |
| <span data-ttu-id="57c37-168">* / 3443</span><span class="sxs-lookup"><span data-stu-id="57c37-168">* / 3443</span></span> |<span data-ttu-id="57c37-169">Entrada</span><span class="sxs-lookup"><span data-stu-id="57c37-169">Inbound</span></span> |<span data-ttu-id="57c37-170">TCP</span><span class="sxs-lookup"><span data-stu-id="57c37-170">TCP</span></span> |<span data-ttu-id="57c37-171">Punto de conexión de administración para Azure Portal y Powershell</span><span class="sxs-lookup"><span data-stu-id="57c37-171">Management endpoint for Azure portal and Powershell</span></span> |<span data-ttu-id="57c37-172">INTERNET/VIRTUAL_NETWORK</span><span class="sxs-lookup"><span data-stu-id="57c37-172">INTERNET / VIRTUAL_NETWORK</span></span> |<span data-ttu-id="57c37-173">Externa e interna</span><span class="sxs-lookup"><span data-stu-id="57c37-173">External & Internal</span></span> |
| <span data-ttu-id="57c37-174">* / 80, 443</span><span class="sxs-lookup"><span data-stu-id="57c37-174">* / 80, 443</span></span> |<span data-ttu-id="57c37-175">Salida</span><span class="sxs-lookup"><span data-stu-id="57c37-175">Outbound</span></span> |<span data-ttu-id="57c37-176">TCP</span><span class="sxs-lookup"><span data-stu-id="57c37-176">TCP</span></span> |<span data-ttu-id="57c37-177">Dependencia en Azure Storage y Azure Service Bus</span><span class="sxs-lookup"><span data-stu-id="57c37-177">Dependency on Azure Storage and Azure Service Bus</span></span> |<span data-ttu-id="57c37-178">VIRTUAL_NETWORK/INTERNET</span><span class="sxs-lookup"><span data-stu-id="57c37-178">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="57c37-179">Externa e interna</span><span class="sxs-lookup"><span data-stu-id="57c37-179">External & Internal</span></span> |
| <span data-ttu-id="57c37-180">* / 1433</span><span class="sxs-lookup"><span data-stu-id="57c37-180">* / 1433</span></span> |<span data-ttu-id="57c37-181">Salida</span><span class="sxs-lookup"><span data-stu-id="57c37-181">Outbound</span></span> |<span data-ttu-id="57c37-182">TCP</span><span class="sxs-lookup"><span data-stu-id="57c37-182">TCP</span></span> |<span data-ttu-id="57c37-183">Dependencia de Azure SQL</span><span class="sxs-lookup"><span data-stu-id="57c37-183">Dependency on Azure SQL</span></span> |<span data-ttu-id="57c37-184">VIRTUAL_NETWORK/INTERNET</span><span class="sxs-lookup"><span data-stu-id="57c37-184">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="57c37-185">Externa e interna</span><span class="sxs-lookup"><span data-stu-id="57c37-185">External & Internal</span></span> |
| <span data-ttu-id="57c37-186">* / 11000 - 11999</span><span class="sxs-lookup"><span data-stu-id="57c37-186">* / 11000 - 11999</span></span> |<span data-ttu-id="57c37-187">Salida</span><span class="sxs-lookup"><span data-stu-id="57c37-187">Outbound</span></span> |<span data-ttu-id="57c37-188">TCP</span><span class="sxs-lookup"><span data-stu-id="57c37-188">TCP</span></span> |<span data-ttu-id="57c37-189">Dependencia de Azure SQL V12</span><span class="sxs-lookup"><span data-stu-id="57c37-189">Dependency on Azure SQL V12</span></span> |<span data-ttu-id="57c37-190">VIRTUAL_NETWORK/INTERNET</span><span class="sxs-lookup"><span data-stu-id="57c37-190">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="57c37-191">Externa e interna</span><span class="sxs-lookup"><span data-stu-id="57c37-191">External & Internal</span></span> |
| <span data-ttu-id="57c37-192">* / 14000 - 14999</span><span class="sxs-lookup"><span data-stu-id="57c37-192">* / 14000 - 14999</span></span> |<span data-ttu-id="57c37-193">Salida</span><span class="sxs-lookup"><span data-stu-id="57c37-193">Outbound</span></span> |<span data-ttu-id="57c37-194">TCP</span><span class="sxs-lookup"><span data-stu-id="57c37-194">TCP</span></span> |<span data-ttu-id="57c37-195">Dependencia de Azure SQL V12</span><span class="sxs-lookup"><span data-stu-id="57c37-195">Dependency on Azure SQL V12</span></span> |<span data-ttu-id="57c37-196">VIRTUAL_NETWORK/INTERNET</span><span class="sxs-lookup"><span data-stu-id="57c37-196">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="57c37-197">Externa e interna</span><span class="sxs-lookup"><span data-stu-id="57c37-197">External & Internal</span></span> |
| <span data-ttu-id="57c37-198">* / 5671</span><span class="sxs-lookup"><span data-stu-id="57c37-198">* / 5671</span></span> |<span data-ttu-id="57c37-199">Salida</span><span class="sxs-lookup"><span data-stu-id="57c37-199">Outbound</span></span> |<span data-ttu-id="57c37-200">AMQP</span><span class="sxs-lookup"><span data-stu-id="57c37-200">AMQP</span></span> |<span data-ttu-id="57c37-201">Dependencia de la directiva de registro en el centro de eventos y el agente de supervisión</span><span class="sxs-lookup"><span data-stu-id="57c37-201">Dependency for Log to Event Hub policy and monitoring agent</span></span> |<span data-ttu-id="57c37-202">VIRTUAL_NETWORK/INTERNET</span><span class="sxs-lookup"><span data-stu-id="57c37-202">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="57c37-203">Externa e interna</span><span class="sxs-lookup"><span data-stu-id="57c37-203">External & Internal</span></span> |
| <span data-ttu-id="57c37-204">6381 - 6383 / 6381 - 6383</span><span class="sxs-lookup"><span data-stu-id="57c37-204">6381 - 6383 / 6381 - 6383</span></span> |<span data-ttu-id="57c37-205">Entrada y salida</span><span class="sxs-lookup"><span data-stu-id="57c37-205">Inbound & Outbound</span></span> |<span data-ttu-id="57c37-206">UDP</span><span class="sxs-lookup"><span data-stu-id="57c37-206">UDP</span></span> |<span data-ttu-id="57c37-207">Dependencia de Redis Cache</span><span class="sxs-lookup"><span data-stu-id="57c37-207">Dependency on Redis Cache</span></span> |<span data-ttu-id="57c37-208">VIRTUAL_NETWORK/VIRTUAL_NETWORK</span><span class="sxs-lookup"><span data-stu-id="57c37-208">VIRTUAL_NETWORK / VIRTUAL_NETWORK</span></span> |<span data-ttu-id="57c37-209">Externa e interna</span><span class="sxs-lookup"><span data-stu-id="57c37-209">External & Internal</span></span> |-
| <span data-ttu-id="57c37-210">* / 445</span><span class="sxs-lookup"><span data-stu-id="57c37-210">* / 445</span></span> |<span data-ttu-id="57c37-211">Salida</span><span class="sxs-lookup"><span data-stu-id="57c37-211">Outbound</span></span> |<span data-ttu-id="57c37-212">TCP</span><span class="sxs-lookup"><span data-stu-id="57c37-212">TCP</span></span> |<span data-ttu-id="57c37-213">Dependencia del recurso compartido de archivos de Azure para Git</span><span class="sxs-lookup"><span data-stu-id="57c37-213">Dependency on Azure File Share for GIT</span></span> |<span data-ttu-id="57c37-214">VIRTUAL_NETWORK/INTERNET</span><span class="sxs-lookup"><span data-stu-id="57c37-214">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="57c37-215">Externa e interna</span><span class="sxs-lookup"><span data-stu-id="57c37-215">External & Internal</span></span> |
| <span data-ttu-id="57c37-216">* / *</span><span class="sxs-lookup"><span data-stu-id="57c37-216">* / *</span></span> | <span data-ttu-id="57c37-217">Entrada</span><span class="sxs-lookup"><span data-stu-id="57c37-217">Inbound</span></span> |<span data-ttu-id="57c37-218">TCP</span><span class="sxs-lookup"><span data-stu-id="57c37-218">TCP</span></span> |<span data-ttu-id="57c37-219">Equilibrador de carga de la infraestructura de Azure</span><span class="sxs-lookup"><span data-stu-id="57c37-219">Azure Infrastructure Load Balancer</span></span> | <span data-ttu-id="57c37-220">AZURE_LOAD_BALANCER / VIRTUAL_NETWORK</span><span class="sxs-lookup"><span data-stu-id="57c37-220">AZURE_LOAD_BALANCER / VIRTUAL_NETWORK</span></span> |<span data-ttu-id="57c37-221">Externa e interna</span><span class="sxs-lookup"><span data-stu-id="57c37-221">External & Internal</span></span> |

* <span data-ttu-id="57c37-222">**Funcionalidad SSL**: para permitir la creación y validación de la cadena de certificados SSL, el servicio API Management necesita conectividad de red saliente a ocsp.msocsp.com, mscrl.microsoft.com y crl.microsoft.com. Esta dependencia no es obligatoria, si los certificados que cargue en API Management contienen la cadena completa de la raíz de la entidad de certificación.</span><span class="sxs-lookup"><span data-stu-id="57c37-222">**SSL functionality**: To enable SSL certificate chain building and validation the API Management service needs Outbound network connectivity to ocsp.msocsp.com, mscrl.microsoft.com and crl.microsoft.com. This dependency is not required, if any certificate you upload to API Management contain the full chain to the CA root.</span></span>

* <span data-ttu-id="57c37-223">**Acceso de DNS**: se requiere acceso saliente en el puerto 53 para establecer la comunicación con los servidores DNS.</span><span class="sxs-lookup"><span data-stu-id="57c37-223">**DNS Access**: Outbound access on port 53 is required for communication with DNS servers.</span></span> <span data-ttu-id="57c37-224">Si existe un servidor DNS personalizado en el otro punto de conexión de una puerta de enlace de VPN, el servidor DNS debe estar accesible desde la subred que alberga la API Management.</span><span class="sxs-lookup"><span data-stu-id="57c37-224">If a custom DNS server exists on the other end of a VPN gateway, the DNS server must be reachable from the subnet hosting API Management.</span></span>

* <span data-ttu-id="57c37-225">**Supervisión de métricas y estado**: conexión de red saliente a puntos de conexión de supervisión de Azure, que se resuelven en los siguientes dominios: global.metrics.nsatc.net, shoebox2.metrics.nsatc.net, prod3.metrics.nsatc.net.</span><span class="sxs-lookup"><span data-stu-id="57c37-225">**Metrics and Health Monitoring**: Outbound network connectivity to Azure Monitoring endpoints, which resolve under the following domains: global.metrics.nsatc.net, shoebox2.metrics.nsatc.net, prod3.metrics.nsatc.net.</span></span>

* <span data-ttu-id="57c37-226">**Configuración de ExpressRoute**: una configuración de cliente común es definir su propia ruta predeterminada (0.0.0.0/0) que fuerza a que el tráfico saliente de Internet fluya a nivel local.</span><span class="sxs-lookup"><span data-stu-id="57c37-226">**Express Route Setup**: A common customer configuration is to define their own default route (0.0.0.0/0) which forces outbound Internet traffic to instead flow on-premises.</span></span> <span data-ttu-id="57c37-227">El flujo de tráfico interrumpe invariablemente la conectividad con Azure API Management porque el tráfico saliente está bloqueado de forma local o porque se usa NAT para convertirlo en un conjunto de direcciones irreconocibles que no funcionan con varios puntos de conexión de Azure.</span><span class="sxs-lookup"><span data-stu-id="57c37-227">This traffic flow invariably breaks connectivity with Azure API Management because the outbound traffic is either blocked on-premises, or NAT'd to an unrecognizable set of addresses that no longer work with various Azure endpoints.</span></span> <span data-ttu-id="57c37-228">La solución es definir una, o varias, rutas definidas por el usuario ([UDR][UDRs]) en la subred que contiene el servicio Azure API Management.</span><span class="sxs-lookup"><span data-stu-id="57c37-228">The solution is to define one (or more) user-defined routes ([UDRs][UDRs]) on the subnet that contains the Azure API Management.</span></span> <span data-ttu-id="57c37-229">Una ruta definida por el usuario define las rutas de subred específica que se respetarán en lugar de la ruta predeterminada.</span><span class="sxs-lookup"><span data-stu-id="57c37-229">A UDR defines subnet-specific routes that will be honored instead of the default route.</span></span>
  <span data-ttu-id="57c37-230">Si es posible, se recomienda usar la configuración siguiente:</span><span class="sxs-lookup"><span data-stu-id="57c37-230">If possible, it is recommended to use the following configuration:</span></span>
 * <span data-ttu-id="57c37-231">La configuración de ExpressRoute anuncia 0.0.0.0/0 y, de manera predeterminada, fuerza la tunelización de todo el tráfico saliente a local.</span><span class="sxs-lookup"><span data-stu-id="57c37-231">The ExpressRoute configuration advertises 0.0.0.0/0 and by default force tunnels all outbound traffic on-premises.</span></span>
 * <span data-ttu-id="57c37-232">El UDR aplicado a la subred que contiene Azure API Management define 0.0.0.0/0 con un tipo de próximo salto de Internet.</span><span class="sxs-lookup"><span data-stu-id="57c37-232">The UDR applied to the subnet containing the Azure API Management defines 0.0.0.0/0 with a next hop type of Internet.</span></span>
 <span data-ttu-id="57c37-233">El efecto combinado de estos pasos es que el UDR a nivel de subred tiene prioridad sobre la tunelización forzada de ExpressRoute, lo que garantiza el acceso saliente a Internet desde Azure API Management.</span><span class="sxs-lookup"><span data-stu-id="57c37-233">The combined effect of these steps is that the subnet level UDR takes precedence over the ExpressRoute forced tunneling, thus ensuring outbound Internet access from the Azure API Management.</span></span>

>[!WARNING]  
><span data-ttu-id="57c37-234">Azure API Management no es compatible con las configuraciones de ExpressRoute que **anuncian incorrectamente rutas entre la ruta de acceso entre pares públicos y la ruta de acceso entre pares privados**.</span><span class="sxs-lookup"><span data-stu-id="57c37-234">Azure API Management is not supported with ExpressRoute configurations that **incorrectly cross-advertise routes from the public peering path to the private peering path**.</span></span> <span data-ttu-id="57c37-235">Las configuraciones de ExpressRoute con el emparejamiento público configurado recibirán anuncios de ruta de Microsoft para un amplio conjunto de intervalos de direcciones IP de Microsoft Azure.</span><span class="sxs-lookup"><span data-stu-id="57c37-235">ExpressRoute configurations that have public peering configured, will receive route advertisements from Microsoft for a large set of Microsoft Azure IP address ranges.</span></span> <span data-ttu-id="57c37-236">Si estos intervalos de direcciones se anuncian incorrectamente en la ruta de acceso entre pares privados, el resultado final es que se forzará incorrectamente la tunelización de todos los paquetes de red salientes desde la subred de la instancia de Azure API Management a la infraestructura de red local del cliente.</span><span class="sxs-lookup"><span data-stu-id="57c37-236">If these address ranges are incorrectly cross-advertised on the private peering path, the end result is that all outbound network packets from the Azure API Management instance's subnet are incorrectly force-tunneled to a customer's on-premises network infrastructure.</span></span> <span data-ttu-id="57c37-237">Este flujo de red interrumpe Azure API Management.</span><span class="sxs-lookup"><span data-stu-id="57c37-237">This network flow breaks Azure API Management.</span></span> <span data-ttu-id="57c37-238">La solución a este problema consiste en detener rutas anunciadas entre la ruta de acceso de interconexión pública y la ruta de acceso de interconexión privada.</span><span class="sxs-lookup"><span data-stu-id="57c37-238">The solution to this problem is to stop cross-advertising routes from the public peering path to the private peering path.</span></span>


## <span data-ttu-id="57c37-239"><a name="troubleshooting"> </a>Solución de problemas</span><span class="sxs-lookup"><span data-stu-id="57c37-239"><a name="troubleshooting"> </a>Troubleshooting</span></span>
<span data-ttu-id="57c37-240">Al realizar cambios en la red, consulte [NetworkStatus API](https://docs.microsoft.com/en-us/rest/api/apimanagement/networkstatus), para validar si el servicio API Management no ha perdido el acceso a cualquiera de los recursos críticos de los que depende.</span><span class="sxs-lookup"><span data-stu-id="57c37-240">When making changes to your network, refer to [NetworkStatus API](https://docs.microsoft.com/en-us/rest/api/apimanagement/networkstatus), to validate if the API Management service has not lost access to any of the critical resources which it depends upon.</span></span> <span data-ttu-id="57c37-241">El estado de conectividad debe actualizarse cada 15 minutos.</span><span class="sxs-lookup"><span data-stu-id="57c37-241">The connectivity status should be updated every 15 minutes.</span></span>

## <span data-ttu-id="57c37-242"><a name="limitations"> </a>Limitaciones</span><span class="sxs-lookup"><span data-stu-id="57c37-242"><a name="limitations"> </a>Limitations</span></span>
* <span data-ttu-id="57c37-243">Una subred que contenga instancias de API Management no puede contener otros tipos de recursos de Azure.</span><span class="sxs-lookup"><span data-stu-id="57c37-243">A subnet containing API Management instances cannot contain any other Azure resource types.</span></span>
* <span data-ttu-id="57c37-244">La subred y el servicio API Management tienen que estar en la misma suscripción.</span><span class="sxs-lookup"><span data-stu-id="57c37-244">The subnet and the API Management service must be in the same subscription.</span></span>
* <span data-ttu-id="57c37-245">Una subred que contenga instancias de API Management no se puede mover a otras suscripciones.</span><span class="sxs-lookup"><span data-stu-id="57c37-245">A subnet containing API Management instances cannot be moved across subscriptions.</span></span>
* <span data-ttu-id="57c37-246">Al usar una red virtual interna, solo estará disponible una dirección IP interna del intervalo indicado en [RFC 1918](https://tools.ietf.org/html/rfc1918), no se puede especificar una dirección IP pública.</span><span class="sxs-lookup"><span data-stu-id="57c37-246">When using an internal virtual network, only an internal IP address will be available from the range stated in [RFC 1918](https://tools.ietf.org/html/rfc1918), a public IP address cannot be provided.</span></span>
* <span data-ttu-id="57c37-247">Para implementaciones de API Management de varias regiones con redes virtuales internas configuradas, los usuarios son responsables de administrar su propio equilibrio de carga, ya que son los propietarios del host DNS.</span><span class="sxs-lookup"><span data-stu-id="57c37-247">For multi-region API Management deployments, with Internal virtual networks configured, users are responsible for managing their own load balancing as they own the DNS.</span></span>


## <span data-ttu-id="57c37-248"><a name="related-content"> </a>Contenido relacionado</span><span class="sxs-lookup"><span data-stu-id="57c37-248"><a name="related-content"> </a>Related content</span></span>
* [<span data-ttu-id="57c37-249">Conexión de una red virtual a back-end mediante VPN Gateway</span><span class="sxs-lookup"><span data-stu-id="57c37-249">Connecting a Virtual Network to backend using Vpn Gateway</span></span>](../vpn-gateway/vpn-gateway-about-vpngateways.md#s2smulti)
* [<span data-ttu-id="57c37-250">Conexión a una red virtual a partir de diferentes modelos de implementación</span><span class="sxs-lookup"><span data-stu-id="57c37-250">Connecting a Virtual Network from different deployment models</span></span>](../vpn-gateway/vpn-gateway-connect-different-deployment-models-powershell.md)
* [<span data-ttu-id="57c37-251">Uso del API Inspector para hacer un seguimiento de las llamadas en Administración de API de Azure</span><span class="sxs-lookup"><span data-stu-id="57c37-251">How to use the API Inspector to trace calls in Azure API Management</span></span>](api-management-howto-api-inspector.md)

[api-management-using-vnet-menu]: ./media/api-management-using-with-vnet/api-management-menu-vnet.png
[api-management-setup-vpn-select]: ./media/api-management-using-with-vnet/api-management-using-vnet-type.png
[api-management-setup-vpn-select]: ./media/api-management-using-with-vnet/api-management-using-vnet-select.png
[api-management-setup-vpn-add-api]: ./media/api-management-using-with-vnet/api-management-using-vnet-add-api.png
[api-management-vnet-private]: ./media/api-management-using-with-vnet/api-management-vnet-private.png
[api-management-vnet-public]: ./media/api-management-using-with-vnet/api-management-vnet-public.png

[Enable VPN connections]: #enable-vpn
[Connect to a web service behind VPN]: #connect-vpn
[Related content]: #related-content

[UDRs]: ../virtual-network/virtual-networks-udr-overview.md
[Network Security Group]: ../virtual-network/virtual-networks-nsg.md
