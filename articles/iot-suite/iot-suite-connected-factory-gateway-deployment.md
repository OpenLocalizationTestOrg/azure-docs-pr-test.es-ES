---
title: "Implementación de la puerta de enlace de fábrica conectada al Conjunto de aplicaciones de IoT de Azure | Microsoft Docs"
description: "Cómo implementar una puerta de enlace en Windows o Linux para habilitar la conectividad a la solución preconfigurada de fábrica conectada."
services: 
suite: iot-suite
documentationcenter: na
author: dominicbetts
manager: timlt
editor: 
ms.service: iot-suite
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 07/24/2017
ms.author: dobett
ms.openlocfilehash: b0e6ae705911d7c18643c77b7fe08fdffffa5eb1
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 08/03/2017
---
# <a name="deploy-a-gateway-on-windows-or-linux-for-the-connected-factory-preconfigured-solution"></a><span data-ttu-id="0dbc8-103">Implementación de una puerta de enlace en Windows o Linux para la solución preconfigurada de fábrica conectada</span><span class="sxs-lookup"><span data-stu-id="0dbc8-103">Deploy a gateway on Windows or Linux for the connected factory preconfigured solution</span></span>

<span data-ttu-id="0dbc8-104">El software necesario para implementar una puerta de enlace para la solución preconfigurada de fábrica conectada tiene dos componentes:</span><span class="sxs-lookup"><span data-stu-id="0dbc8-104">The software required to deploy a gateway for the connected factory preconfigured solution has two components:</span></span>

* <span data-ttu-id="0dbc8-105">El componente *OPC Proxy* establece una conexión a IoT Hub.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-105">The *OPC Proxy* establishes a connection to IoT Hub.</span></span> <span data-ttu-id="0dbc8-106">El componente *OPC Proxy* espera los mensajes de comando y control desde el explorador de OPC integrado que se ejecuta en el portal de la solución de fábrica conectada.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-106">The *OPC Proxy* then waits for command and control messages from the integrated OPC Browser that runs in the connected factory solution portal.</span></span>
* <span data-ttu-id="0dbc8-107">El componente *Publisher OPC* se conecta a los servidores de agente de usuario de OPC locales existentes y reenvía sus mensajes de telemetría a IoT Hub.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-107">The *OPC Publisher* connects to existing on-premises OPC UA servers and forwards telemetry messages from them to IoT Hub.</span></span>

<span data-ttu-id="0dbc8-108">Ambos componentes son de código abierto y están disponibles como código fuente en GitHub y como contenedores de Docker:</span><span class="sxs-lookup"><span data-stu-id="0dbc8-108">Both components are open-source and are available as source on GitHub and as Docker containers:</span></span>

| <span data-ttu-id="0dbc8-109">GitHub</span><span class="sxs-lookup"><span data-stu-id="0dbc8-109">GitHub</span></span> | <span data-ttu-id="0dbc8-110">DockerHub</span><span class="sxs-lookup"><span data-stu-id="0dbc8-110">DockerHub</span></span> |
| ------ | --------- |
| <span data-ttu-id="0dbc8-111">[OPC Publisher][lnk-publisher-github]</span><span class="sxs-lookup"><span data-stu-id="0dbc8-111">[OPC Publisher][lnk-publisher-github]</span></span> | <span data-ttu-id="0dbc8-112">[OPC Publisher][lnk-publisher-docker]</span><span class="sxs-lookup"><span data-stu-id="0dbc8-112">[OPC Publisher][lnk-publisher-docker]</span></span> |
| <span data-ttu-id="0dbc8-113">[OPC Proxy][lnk-proxy-github]</span><span class="sxs-lookup"><span data-stu-id="0dbc8-113">[OPC Proxy][lnk-proxy-github]</span></span> | <span data-ttu-id="0dbc8-114">[OPC Proxy][lnk-proxy-docker]</span><span class="sxs-lookup"><span data-stu-id="0dbc8-114">[OPC Proxy][lnk-proxy-docker]</span></span> |

<span data-ttu-id="0dbc8-115">No se requiere ninguna dirección IP de acceso público ni marcadores en el firewall de la puerta de enlace para cualquiera de los componentes.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-115">No public-facing IP address or holes in the gateway firewall are required for either component.</span></span> <span data-ttu-id="0dbc8-116">Los componentes OPC Proxy y OPC Publisher utilizan solo los puertos de salida 443, 5671 y 8883.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-116">The OPC Proxy and OPC Publisher use only outbound ports 443, 5671, and 8883.</span></span>

<span data-ttu-id="0dbc8-117">Los pasos que se indican en este artículo muestran cómo implementar una puerta de enlace con Docker en [Windows](#windows-deployment) o [Linux](#linux-deployment).</span><span class="sxs-lookup"><span data-stu-id="0dbc8-117">The steps in this article show you how to deploy a gateway using Docker on either [Windows](#windows-deployment) or [Linux](#linux-deployment).</span></span> <span data-ttu-id="0dbc8-118">La puerta de enlace habilita la conectividad con la solución preconfigurada de fábrica conectada.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-118">The gateway enables connectivity to the connected factory preconfigured solution.</span></span>

> [!NOTE]
> <span data-ttu-id="0dbc8-119">El software de puerta de enlace que se ejecuta en el contenedor de Docker es [Azure IoT Edge].</span><span class="sxs-lookup"><span data-stu-id="0dbc8-119">The gateway software that runs in the Docker container is [Azure IoT Edge].</span></span>

## <a name="windows-deployment"></a><span data-ttu-id="0dbc8-120">Implementación de Windows</span><span class="sxs-lookup"><span data-stu-id="0dbc8-120">Windows deployment</span></span>

> [!NOTE]
> <span data-ttu-id="0dbc8-121">Si todavía no tiene un dispositivo de puerta de enlace, Microsoft le recomienda comprar una puerta de enlace comercial con uno de nuestros asociados.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-121">If you don't yet have a gateway device, Microsoft recommends you buy a commercial gateway from one of our partners.</span></span> <span data-ttu-id="0dbc8-122">Visite el [catálogo de dispositivos IoT de Azure] para ver una lista de los dispositivos de puerta de enlace compatibles con la solución de fábrica conectada.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-122">Visit the [Azure IoT device catalog] for a list of gateway devices compatible with the connected factory solution.</span></span> <span data-ttu-id="0dbc8-123">Siga las instrucciones que se incluyen con el dispositivo para configurar la puerta de enlace.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-123">Follow the instructions that come with the device to set up the gateway.</span></span> <span data-ttu-id="0dbc8-124">Como alternativa, puede usar las instrucciones siguientes para establecer manualmente una de las puertas de enlace existentes.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-124">Alternatively, use the following instructions to manually set up one of your existing gateways.</span></span>

### <a name="install-docker"></a><span data-ttu-id="0dbc8-125">Instalación de Docker</span><span class="sxs-lookup"><span data-stu-id="0dbc8-125">Install Docker</span></span>

<span data-ttu-id="0dbc8-126">Instale [Docker para Windows] en el dispositivo de puerta de enlace Windows.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-126">Install [Docker for Windows] on your Windows-based gateway device.</span></span> <span data-ttu-id="0dbc8-127">Durante la configuración de Windows Docker, seleccione una unidad en el equipo host para compartirla con Docker.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-127">During Windows Docker setup, select a drive on your host machine to share with Docker.</span></span> <span data-ttu-id="0dbc8-128">En la captura de pantalla siguiente se muestra el uso compartido de la unidad D en el sistema Windows:</span><span class="sxs-lookup"><span data-stu-id="0dbc8-128">The following screenshot shows sharing the D drive on your Windows system:</span></span>

![Instalación de Docker][img-install-docker]

<span data-ttu-id="0dbc8-130">Luego, cree una carpeta llamada **docker** en la raíz de la unidad compartida.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-130">Then create a folder called **docker** in the root of the shared drive.</span></span>
<span data-ttu-id="0dbc8-131">También puede realizar este paso después de instalar docker desde el menú **Configuración**.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-131">You can also perform this step after installing docker from the **Settings** menu.</span></span>

### <a name="configure-the-gateway"></a><span data-ttu-id="0dbc8-132">Configuración de la puerta de enlace</span><span class="sxs-lookup"><span data-stu-id="0dbc8-132">Configure the gateway</span></span>

1. <span data-ttu-id="0dbc8-133">Necesita la cadena de conexión **iothubowner** de la implementación de fábrica conectada del Conjunto de aplicaciones de IoT de Azure para completar la implementación de la puerta de enlace.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-133">You need the **iothubowner** connection string of your Azure IoT Suite connected factory deployment to complete the gateway deployment.</span></span> <span data-ttu-id="0dbc8-134">En [Azure Portal], vaya a IoT Hub en el grupo de recursos que se creó cuando implementó la solución de fábrica conectada.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-134">In the [Azure portal], navigate to your IoT Hub in the resource group created when you deployed the connected factory solution.</span></span> <span data-ttu-id="0dbc8-135">Haga clic en **Directivas de acceso compartido** para tener acceso a la cadena de conexión **iothubowner**:</span><span class="sxs-lookup"><span data-stu-id="0dbc8-135">Click **Shared access policies** to access the **iothubowner** connection string:</span></span>

    ![Búsqueda de la cadena de conexión IoT Hub][img-hub-connection]

    <span data-ttu-id="0dbc8-137">Copie el valor **Connection string--primary key**.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-137">Copy the **Connection string--primary key** value.</span></span>

1. <span data-ttu-id="0dbc8-138">Configure la puerta de enlace de la instancia de IoT Hub mediante la ejecución de los dos módulos de puerta de enlace **una vez** desde un símbolo del sistema con:</span><span class="sxs-lookup"><span data-stu-id="0dbc8-138">Configure the gateway for your IoT Hub by running the two gateway modules **once** from a command prompt with:</span></span>

    `docker run -it --rm -h <ApplicationName> -v //D/docker:/build/src/GatewayApp.NetCore/bin/Debug/netcoreapp1.0/publish/CertificateStores -v //D/docker:/root/.dotnet/corefx/cryptography/x509stores microsoft/iot-gateway-opc-ua:1.0.0 <ApplicationName> "<IoTHubOwnerConnectionString>"`

    `docker run -it --rm -v //D/docker:/mapped microsoft/iot-gateway-opc-ua-proxy:0.1.3 -i -c "<IoTHubOwnerConnectionString>" -D /mapped/cs.db`

    * <span data-ttu-id="0dbc8-139">**&lt;ApplicationName&gt;** es el nombre del publicador de agente de usuario de OPC con el formato **publisher.&lt;nombre de dominio completo&gt;**.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-139">**&lt;ApplicationName&gt;** is the name to give to your OPC UA Publisher in the format **publisher.&lt;your fully qualified domain name&gt;**.</span></span> <span data-ttu-id="0dbc8-140">Por ejemplo, si la red de fábrica se denomina **myfactorynetwork.com**, el valor de **ApplicationName** es **publisher.myfactorynetwork.com**.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-140">For example, if your factory network is called **myfactorynetwork.com**, the **ApplicationName** value is **publisher.myfactorynetwork.com**.</span></span>
    * <span data-ttu-id="0dbc8-141">**&lt;IoTHubOwnerConnectionString&gt;** es la cadena de conexión **iothubowner** que se copió en el paso anterior.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-141">**&lt;IoTHubOwnerConnectionString&gt;** is the **iothubowner** connection string you copied in the previous step.</span></span> <span data-ttu-id="0dbc8-142">Esta cadena de conexión solo se usa en este paso y no la necesita en los pasos siguientes:</span><span class="sxs-lookup"><span data-stu-id="0dbc8-142">This connection string is only used in this step, you don’t need it in the following steps:</span></span>

    <span data-ttu-id="0dbc8-143">Use la ruta de acceso D:\\carpeta docker asignada (el argumento `-v`) más adelante para conservar los dos certificados X.509 que los módulos de la puerta de enlace utilizan.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-143">You use the mapped D:\\docker folder (the `-v` argument) later to persist the two X.509 certificates that the gateway modules use.</span></span>

### <a name="run-the-gateway"></a><span data-ttu-id="0dbc8-144">Ejecución de la puerta de enlace</span><span class="sxs-lookup"><span data-stu-id="0dbc8-144">Run the gateway</span></span>

1. <span data-ttu-id="0dbc8-145">Use estos comandos para reiniciar la puerta de enlace:</span><span class="sxs-lookup"><span data-stu-id="0dbc8-145">Restart the gateway using the following commands:</span></span>

    `docker run -it --rm -h <ApplicationName> --expose 62222 -p 62222:62222 -v //D/docker:/build/src/GatewayApp.NetCore/bin/Debug/netcoreapp1.0/publish/Logs -v //D/docker:/build/src/GatewayApp.NetCore/bin/Debug/netcoreapp1.0/publish/CertificateStores -v //D/docker:/shared -v //D/docker:/root/.dotnet/corefx/cryptography/x509stores -e _GW_PNFP="/shared/publishednodes.JSON" microsoft/iot-gateway-opc-ua:1.0.0 <ApplicationName>`

    `docker run -it --rm -v //D/docker:/mapped microsoft/iot-gateway-opc-ua-proxy:0.1.3 -D /mapped/cs.db`

1. <span data-ttu-id="0dbc8-146">Por motivos de seguridad, los dos certificados X.509 que se conservan en la carpeta D:\\docker contienen la clave privada.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-146">For security reasons, the two X.509 certificates persisted in the D:\\docker folder contain the private key.</span></span> <span data-ttu-id="0dbc8-147">Limite el acceso a esta carpeta con las credenciales (habitualmente, **Administradores**) que se usan para ejecutar el contenedor Docker.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-147">Limit access to this folder to the credentials (typically **Administrators**) you use to run the Docker container.</span></span> <span data-ttu-id="0dbc8-148">Haga clic con el botón derecho en la carpeta D:\\docker, elija **Propiedades**, **Seguridad** y, luego, **Editar**.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-148">Right-click the D:\\docker folder, choose **Properties**, then **Security**, and then **Edit**.</span></span> <span data-ttu-id="0dbc8-149">Conceda a los **administradores** el control total y quite a todos los demás:</span><span class="sxs-lookup"><span data-stu-id="0dbc8-149">Give **Administrators** full control and remove everyone else:</span></span>

    ![Concesión de permisos para el recurso compartido Docker][img-docker-share]

1. <span data-ttu-id="0dbc8-151">Compruebe la conectividad de la red.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-151">Verify network connectivity.</span></span> <span data-ttu-id="0dbc8-152">En un símbolo del sistema, escriba el comando `ping publisher.<your fully qualified domain name>` para hacer ping a la puerta de enlace.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-152">From a command prompt, enter the command `ping publisher.<your fully qualified domain name>` to ping your gateway.</span></span> <span data-ttu-id="0dbc8-153">Si el destino es inaccesible, agregue la dirección IP y el nombre de la puerta de enlace al archivo de hosts de la puerta de enlace.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-153">If the destination is unreachable, add the IP address and name of your gateway to the hosts file on your gateway.</span></span> <span data-ttu-id="0dbc8-154">El archivo de hosts está en la carpeta **Windows\\System32\\drivers\\etc**.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-154">The hosts file is located in the **Windows\\System32\\drivers\\etc** folder.</span></span>

1. <span data-ttu-id="0dbc8-155">A continuación, intente conectarse al publicador a través de un cliente OPC UA local que se ejecute en la puerta de enlace.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-155">Next, try to connect to the publisher using a local OPC UA client running on the gateway.</span></span> <span data-ttu-id="0dbc8-156">La dirección URL del punto de conexión de OPC UA es `opc.tcp://publisher.<your fully qualified domain name>:62222`.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-156">The OPC UA endpoint URL is `opc.tcp://publisher.<your fully qualified domain name>:62222`.</span></span> <span data-ttu-id="0dbc8-157">Si no tiene un cliente OPC UA, puede descargar un [cliente OPC UA de código abierto] y úselo.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-157">If you don't have an OPC UA client, you can download and use an [open-source OPC UA client].</span></span>

1. <span data-ttu-id="0dbc8-158">Una vez que complete correctamente estas pruebas locales, vaya a la página **Connect your own OPC UA Server** (Conexión de su propio servidor OPC UA) en el portal de solución de fábrica conectada.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-158">When you have successfully completed these local tests, browse to the **Connect your own OPC UA Server** page in the connected factory solution portal.</span></span> <span data-ttu-id="0dbc8-159">Escriba la dirección URL del punto de conexión de publicador (`tcp://publisher.<your fully qualified domain name>:62222`) y haga clic en **Conectar**.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-159">Enter the publisher endpoint URL (`tcp://publisher.<your fully qualified domain name>:62222`) and click **Connect**.</span></span> <span data-ttu-id="0dbc8-160">Recibirá una advertencia de certificado; luego, haga clic en **Proceed** (Continuar).</span><span class="sxs-lookup"><span data-stu-id="0dbc8-160">You get a certificate warning, then click **Proceed.**</span></span> <span data-ttu-id="0dbc8-161">A continuación, recibirá un error que indica que el publicador no confía en el cliente web UA.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-161">Next you get an error that the publisher doesn’t trust the UA Web Client.</span></span> <span data-ttu-id="0dbc8-162">Para solucionar el error, copie el certificado de **cliente web UA** desde la carpeta **D:\\docker\\Rejected Certificates\\certs** a la carpeta **D:\\docker\\UA Applications\\certs** en la puerta de enlace.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-162">To resolve this error, copy the **UA Web Client** certificate from the **D:\\docker\\Rejected Certificates\\certs** folder to the **D:\\docker\\UA Applications\\certs** folder on the gateway.</span></span> <span data-ttu-id="0dbc8-163">No necesita reiniciar la puerta de enlace.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-163">You do not need to restart of the gateway.</span></span> <span data-ttu-id="0dbc8-164">Repita este paso.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-164">Repeat this step.</span></span> <span data-ttu-id="0dbc8-165">Ahora puede conectarse a la puerta de enlace desde la nube y está preparado para agregar servidores OPC UA a la solución.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-165">You can now connect to the gateway from the cloud, and you are ready to add OPC UA servers to the solution.</span></span>

### <a name="add-your-opc-ua-servers"></a><span data-ttu-id="0dbc8-166">Incorporación de los servidores OPC UA</span><span class="sxs-lookup"><span data-stu-id="0dbc8-166">Add your OPC UA servers</span></span>

1. <span data-ttu-id="0dbc8-167">Vaya a la página **Connect your own OPC UA Server** (Conexión con su propio servidor OPC UA) en el portal de solución de fábrica conectada.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-167">Browse to the **Connect your own OPC UA Server** page in the connected factory solution portal.</span></span> <span data-ttu-id="0dbc8-168">Siga los mismos pasos de la sección anterior para establecer la confianza entre el portal de fábrica conectada y el servidor OPC UA.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-168">Follow the same steps as in the preceding section to establish trust between the connected factory portal and the OPC UA server.</span></span> <span data-ttu-id="0dbc8-169">Este paso establece una confianza mutua de los certificados desde el portal de factoría conectada al servidor OPC UA y crea una conexión.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-169">This step establishes a mutual trust of the certificates from the connected factory portal and the OPC UA server and creates a connection.</span></span>

1. <span data-ttu-id="0dbc8-170">Examine el árbol de nodos de OPC UA del servidor OPC UA, haga clic con el botón derecho en los nodos OPC y seleccione **Publicar**.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-170">Browse the OPC UA nodes tree of your OPC UA server, right-click the OPC nodes, and select **publish**.</span></span> <span data-ttu-id="0dbc8-171">Para que la publicación funcione de esta manera, el servidor OPC UA y el publicador deben estar en la misma red.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-171">For publishing to work this way, the OPC UA server and the publisher must be on the same network.</span></span> <span data-ttu-id="0dbc8-172">En otras palabras, si el nombre de dominio completo del publicador es **publisher.mydomain.com**, el nombre de dominio completo del servidor OPC UA debe ser, por ejemplo, **myopcuaserver.mydomain.com**.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-172">In other words, if the fully qualified domain name of the publisher is **publisher.mydomain.com** then the fully qualified domain name of the OPC UA server must be, for example, **myopcuaserver.mydomain.com**.</span></span> <span data-ttu-id="0dbc8-173">Si la configuración es distinta, puede agregar nodos manualmente al archivo publishesnodes.json que se encuentra en la carpeta **D:\\docker**.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-173">If your setup is different, you can manually add nodes to the publishesnodes.json file found in the **D:\\docker** folder.</span></span> <span data-ttu-id="0dbc8-174">El archivo publishesnodes.json se genera automáticamente cuando se publica correctamente un nodo OPC por primera vez.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-174">The publishesnodes.json file is automatically generated on the first successful publish of an OPC node.</span></span>

1. <span data-ttu-id="0dbc8-175">Ahora la telemetría fluye desde el dispositivo de puerta de enlace.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-175">Telemetry now flows from the gateway device.</span></span> <span data-ttu-id="0dbc8-176">Puede ver la telemetría en la vista **Factory Locations** (Ubicaciones de fábrica) del portal de fábrica conectada en **New Factory** (Nueva fábrica).</span><span class="sxs-lookup"><span data-stu-id="0dbc8-176">You can view the telemetry in the **Factory Locations** view of the connected factory portal under **New Factory**.</span></span>

## <a name="linux-deployment"></a><span data-ttu-id="0dbc8-177">Implementación de Linux</span><span class="sxs-lookup"><span data-stu-id="0dbc8-177">Linux deployment</span></span>

> [!NOTE]
> <span data-ttu-id="0dbc8-178">Si todavía no tiene un dispositivo de puerta de enlace, Microsoft le recomienda comprar una puerta de enlace comercial con uno de nuestros asociados.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-178">If you don't yet have a gateway device, Microsoft recommends you buy a commercial gateway from one of our partners.</span></span> <span data-ttu-id="0dbc8-179">Visite el [catálogo de dispositivos IoT de Azure] para ver una lista de los dispositivos de puerta de enlace compatibles con la solución de fábrica conectada.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-179">Visit the [Azure IoT device catalog] for a list of gateway devices compatible with the connected factory solution.</span></span> <span data-ttu-id="0dbc8-180">Siga las instrucciones que se incluyen con el dispositivo para configurar la puerta de enlace.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-180">Follow the instructions that come with the device to set up the gateway.</span></span> <span data-ttu-id="0dbc8-181">Como alternativa, puede usar las instrucciones siguientes para establecer manualmente una de las puertas de enlace existentes.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-181">Alternatively, use the following instructions to manually set up one of your existing gateways.</span></span>

<span data-ttu-id="0dbc8-182">[Instale Docker] en el dispositivo de puerta de enlace Linux.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-182">[Install Docker] on your Linux gateway device.</span></span>

### <a name="configure-the-gateway"></a><span data-ttu-id="0dbc8-183">Configuración de la puerta de enlace</span><span class="sxs-lookup"><span data-stu-id="0dbc8-183">Configure the gateway</span></span>

1. <span data-ttu-id="0dbc8-184">Necesita la cadena de conexión **iothubowner** de la implementación de fábrica conectada del Conjunto de aplicaciones de IoT de Azure para completar la implementación de la puerta de enlace.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-184">You need the **iothubowner** connection string of your Azure IoT Suite connected factory deployment to complete the gateway deployment.</span></span> <span data-ttu-id="0dbc8-185">En [Azure Portal], vaya a IoT Hub en el grupo de recursos que se creó cuando implementó la solución de fábrica conectada.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-185">In the [Azure portal], navigate to your IoT Hub in the resource group created when you deployed the connected factory solution.</span></span> <span data-ttu-id="0dbc8-186">Haga clic en **Directivas de acceso compartido** para tener acceso a la cadena de conexión **iothubowner**:</span><span class="sxs-lookup"><span data-stu-id="0dbc8-186">Click **Shared access policies** to access the **iothubowner** connection string:</span></span>

    ![Búsqueda de la cadena de conexión IoT Hub][img-hub-connection]

    <span data-ttu-id="0dbc8-188">Copie el valor **Connection string--primary key**.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-188">Copy the **Connection string--primary key** value.</span></span>

1. <span data-ttu-id="0dbc8-189">Configure la puerta de enlace de la instancia de IoT Hub mediante la ejecución de los dos módulos de puerta de enlace **una vez** desde un shell con:</span><span class="sxs-lookup"><span data-stu-id="0dbc8-189">Configure the gateway for your IoT Hub by running the two gateway modules **once** from a shell with:</span></span>

    `sudo docker run -it --rm -h <ApplicationName> -v /shared:/build/src/GatewayApp.NetCore/bin/Debug/netcoreapp1.0/publish/ -v /shared:/root/.dotnet/corefx/cryptography/x509stores microsoft/iot-gateway-opc-ua:1.0.0 <ApplicationName> "<IoTHubOwnerConnectionString>"`

    `sudo docker run --rm -it -v /shared:/mapped microsoft/iot-gateway-opc-ua-proxy:0.1.3 -i -c "<IoTHubOwnerConnectionString>" -D /mapped/cs.db`

    * <span data-ttu-id="0dbc8-190">**&lt;ApplicationName&gt;** es el nombre de la aplicación OPC UA que la puerta de enlace crea con formato **publisher.&lt;nombre de dominio completo&gt;**.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-190">**&lt;ApplicationName&gt;** is the name of the OPC UA application the gateway creates in the format **publisher.&lt;your fully qualified domain name&gt;**.</span></span> <span data-ttu-id="0dbc8-191">Por ejemplo, **publisher.microsoft.com**.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-191">For example, **publisher.microsoft.com**.</span></span>
    * <span data-ttu-id="0dbc8-192">**&lt;IoTHubOwnerConnectionString&gt;** es la cadena de conexión **iothubowner** que se copió en el paso anterior.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-192">**&lt;IoTHubOwnerConnectionString&gt;** is the **iothubowner** connection string you copied in the previous step.</span></span> <span data-ttu-id="0dbc8-193">Esta cadena de conexión solo se usa en este paso y no la necesita en los pasos siguientes:</span><span class="sxs-lookup"><span data-stu-id="0dbc8-193">This connection string is only used in this step, you don’t need it in the following steps:</span></span>

    <span data-ttu-id="0dbc8-194">Use la carpeta **/shared** (el argumento `-v`) más adelante para conservar los dos certificados X.509 que los módulos de la puerta de enlace utilizan.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-194">You use the **/shared** folder (the `-v` argument) later to persist the two X.509 certificates that the gateway modules use.</span></span>

### <a name="run-the-gateway"></a><span data-ttu-id="0dbc8-195">Ejecución de la puerta de enlace</span><span class="sxs-lookup"><span data-stu-id="0dbc8-195">Run the gateway</span></span>

1. <span data-ttu-id="0dbc8-196">Use estos comandos para reiniciar la puerta de enlace:</span><span class="sxs-lookup"><span data-stu-id="0dbc8-196">Restart the gateway using the following commands:</span></span>

    `sudo docker run -it -h <ApplicationName> --expose 62222 -p 62222:62222 –-rm -v /shared:/build/src/GatewayApp.NetCore/bin/Debug/netcoreapp1.0/publish/Logs -v /shared:/build/src/GatewayApp.NetCore/bin/Debug/netcoreapp1.0/publish/CertificateStores -v /shared:/shared -v /shared:/root/.dotnet/corefx/cryptography/x509stores -e _GW_PNFP="/shared/publishednodes.JSON" microsoft/iot-gateway-opc-ua:1.0.0 <ApplicationName>`

    `sudo docker run -it -v /shared:/mapped microsoft/iot-gateway-opc-ua-proxy:0.1.3 -D /mapped/cs.db`

1. <span data-ttu-id="0dbc8-197">Por motivos de seguridad, los dos certificados X.509 que se conservan en la carpeta **/shared** contienen la clave privada.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-197">For security reasons, the two X.509 certificates persisted in the **/shared** folder contain the private key.</span></span> <span data-ttu-id="0dbc8-198">Limite el acceso a esta carpeta con las credenciales que se usan para ejecutar el contenedor Docker.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-198">Limit access to this folder to the credentials you use to run the Docker container.</span></span> <span data-ttu-id="0dbc8-199">Para establecer los permisos solo para **raíz**, use el comando de shell `chmod` en la carpeta.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-199">To set the permissions for **root** only, use the `chmod` shell command on the folder.</span></span>

1. <span data-ttu-id="0dbc8-200">Compruebe la conectividad de la red.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-200">Verify network connectivity.</span></span> <span data-ttu-id="0dbc8-201">En un shell, escriba el comando `ping publisher.<your fully qualified domain name>` para hacer ping a la puerta de enlace.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-201">From a shell, enter the command `ping publisher.<your fully qualified domain name>` to ping your gateway.</span></span> <span data-ttu-id="0dbc8-202">Si el destino es inaccesible, agregue la dirección IP y el nombre de la puerta de enlace al archivo de hosts de la puerta de enlace.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-202">If the destination is unreachable, add the IP address and name of your gateway to your hosts file on your gateway.</span></span> <span data-ttu-id="0dbc8-203">El archivo de hosts está en la carpeta **/etc**.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-203">The hosts file is located in the **/etc** folder.</span></span>

1. <span data-ttu-id="0dbc8-204">A continuación, intente conectarse al publicador a través de un cliente OPC UA local que se ejecute en la puerta de enlace.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-204">Next, try to connect to the publisher using a local OPC UA client running on the gateway.</span></span> <span data-ttu-id="0dbc8-205">La dirección URL del punto de conexión de OPC UA es `opc.tcp://publisher.<your fully qualified domain name>:62222`.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-205">The OPC UA endpoint URL is `opc.tcp://publisher.<your fully qualified domain name>:62222`.</span></span> <span data-ttu-id="0dbc8-206">Si no tiene un cliente OPC UA, puede descargar un [cliente OPC UA de código abierto] y úselo.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-206">If you don't have an OPC UA client, you can download and use an [open-source OPC UA client].</span></span>

1. <span data-ttu-id="0dbc8-207">Una vez que complete correctamente estas pruebas locales, vaya a la página **Connect your own OPC UA Server** (Conexión de su propio servidor OPC UA) en el portal de solución de fábrica conectada.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-207">When you have successfully completed these local tests, browse to the **Connect your own OPC UA Server** page in the connected factory solution portal.</span></span> <span data-ttu-id="0dbc8-208">Escriba la dirección URL del punto de conexión de publicador (`tcp://publisher.<your fully qualified domain name>:62222`) y haga clic en **Conectar**.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-208">Enter the publisher endpoint URL (`tcp://publisher.<your fully qualified domain name>:62222`) and click **Connect**.</span></span> <span data-ttu-id="0dbc8-209">Recibirá una advertencia de certificado; luego, haga clic en **Proceed** (Continuar).</span><span class="sxs-lookup"><span data-stu-id="0dbc8-209">You get a certificate warning, then click **Proceed.**</span></span> <span data-ttu-id="0dbc8-210">A continuación, recibirá un error que indica que el publicador no confía en el cliente web UA.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-210">Next you get an error that the publisher doesn’t trust the UA Web Client.</span></span> <span data-ttu-id="0dbc8-211">Para solucionar el error, copie el certificado de **cliente web UA** desde la carpeta **/shared/Rejected Certificates/certs** a la carpeta **/shared/UA Applications/certs** en la puerta de enlace.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-211">To resolve this error, copy the **UA Web Client** certificate from the **/shared/Rejected Certificates/certs** folder to the **/shared/UA Applications/certs** folder on the gateway.</span></span> <span data-ttu-id="0dbc8-212">No necesita reiniciar la puerta de enlace.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-212">You do not need to restart of the gateway.</span></span> <span data-ttu-id="0dbc8-213">Repita este paso.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-213">Repeat this step.</span></span> <span data-ttu-id="0dbc8-214">Ahora puede conectarse a la puerta de enlace desde la nube y está preparado para agregar servidores OPC UA a la solución.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-214">You can now connect to the gateway from the cloud, and you are ready to add OPC UA servers to the solution.</span></span>

### <a name="add-your-opc-ua-servers"></a><span data-ttu-id="0dbc8-215">Incorporación de los servidores OPC UA</span><span class="sxs-lookup"><span data-stu-id="0dbc8-215">Add your OPC UA servers</span></span>

1. <span data-ttu-id="0dbc8-216">Vaya a la página **Connect your own OPC UA Server** (Conexión con su propio servidor OPC UA) en el portal de solución de fábrica conectada.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-216">Browse to the **Connect your own OPC UA Server** page in the connected factory solution portal.</span></span> <span data-ttu-id="0dbc8-217">Siga los mismos pasos de la sección anterior para establecer la confianza entre el portal de fábrica conectada y el servidor OPC UA.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-217">Follow the same steps as in the preceding section to establish trust between the connected factory portal and the OPC UA server.</span></span> <span data-ttu-id="0dbc8-218">Este paso establece una confianza mutua de los certificados desde el portal de factoría conectada al servidor OPC UA y crea una conexión.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-218">This step establishes a mutual trust of the certificates from the connected factory portal and the OPC UA server and creates a connection.</span></span>

1. <span data-ttu-id="0dbc8-219">Examine el árbol de nodos de OPC UA del servidor OPC UA, haga clic con el botón derecho en los nodos OPC y seleccione **Publicar**.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-219">Browse the OPC UA nodes tree of your OPC UA server, right-click the OPC nodes, and select **publish**.</span></span> <span data-ttu-id="0dbc8-220">Para que la publicación funcione de esta manera, el servidor OPC UA y el publicador deben estar en la misma red.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-220">For publishing to work this way, the OPC UA server and the publisher must be on the same network.</span></span> <span data-ttu-id="0dbc8-221">En otras palabras, si el nombre de dominio completo del publicador es **publisher.mydomain.com**, el nombre de dominio completo del servidor OPC UA debe ser, por ejemplo, **myopcuaserver.mydomain.com**.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-221">In other words, if the fully qualified domain name of the publisher is **publisher.mydomain.com** then the fully qualified domain name of the OPC UA server must be, for example, **myopcuaserver.mydomain.com**.</span></span> <span data-ttu-id="0dbc8-222">Si la configuración es distinta, puede agregar nodos manualmente al archivo publishesnodes.json que se encuentra en la carpeta **/shared**.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-222">If your setup is different, you can manually add nodes to the publishesnodes.json file found in the **/shared** folder.</span></span> <span data-ttu-id="0dbc8-223">El archivo publishesnodes.json se genera automáticamente cuando se publica correctamente un nodo OPC por primera vez.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-223">The publishesnodes.json is automatically generated on the first successful publish of an OPC node.</span></span>

1. <span data-ttu-id="0dbc8-224">Ahora la telemetría fluye desde el dispositivo de puerta de enlace.</span><span class="sxs-lookup"><span data-stu-id="0dbc8-224">Telemetry now flows from the gateway device.</span></span> <span data-ttu-id="0dbc8-225">Puede ver la telemetría en la vista **Factory Locations** (Ubicaciones de fábrica) del portal de fábrica conectada en **New Factory** (Nueva fábrica).</span><span class="sxs-lookup"><span data-stu-id="0dbc8-225">You can view the telemetry in the **Factory Locations** view of the connected factory portal under **New Factory**.</span></span>

## <a name="next-steps"></a><span data-ttu-id="0dbc8-226">Pasos siguientes</span><span class="sxs-lookup"><span data-stu-id="0dbc8-226">Next steps</span></span>

<span data-ttu-id="0dbc8-227">Para más información sobre la arquitectura de la solución preconfigurada de fábrica conectada, consulte el [tutorial de la solución preconfigurada de fábrica conectada][lnk-walkthrough].</span><span class="sxs-lookup"><span data-stu-id="0dbc8-227">To learn more about the architecture of the connected factory preconfigured solution, see [Connected factory preconfigured solution walkthrough][lnk-walkthrough].</span></span>

[img-install-docker]: ./media/iot-suite-connected-factory-gateway-deployment/image1.png
[img-hub-connection]: ./media/iot-suite-connected-factory-gateway-deployment/image2.png
[img-docker-share]: ./media/iot-suite-connected-factory-gateway-deployment/image3.png

<span data-ttu-id="0dbc8-228">[Docker para Windows]: https://www.docker.com/docker-windows</span><span class="sxs-lookup"><span data-stu-id="0dbc8-228">[Docker for Windows]: https://www.docker.com/docker-windows</span></span>
<span data-ttu-id="0dbc8-229">[catálogo de dispositivos IoT de Azure]: https://catalog.azureiotsuite.com/?q=opc</span><span class="sxs-lookup"><span data-stu-id="0dbc8-229">[Azure IoT device catalog]: https://catalog.azureiotsuite.com/?q=opc</span></span>
<span data-ttu-id="0dbc8-230">[Azure Portal]: http://portal.azure.com/</span><span class="sxs-lookup"><span data-stu-id="0dbc8-230">[Azure portal]: http://portal.azure.com/</span></span>
<span data-ttu-id="0dbc8-231">[cliente OPC UA de código abierto]: https://github.com/OPCFoundation/UA-.NETStandardLibrary/tree/master/SampleApplications/Samples/Client.Net4</span><span class="sxs-lookup"><span data-stu-id="0dbc8-231">[open-source OPC UA client]: https://github.com/OPCFoundation/UA-.NETStandardLibrary/tree/master/SampleApplications/Samples/Client.Net4</span></span>
<span data-ttu-id="0dbc8-232">[Instale Docker]: https://www.docker.com/community-edition#/download</span><span class="sxs-lookup"><span data-stu-id="0dbc8-232">[Install Docker]: https://www.docker.com/community-edition#/download</span></span>
[lnk-walkthrough]: iot-suite-connected-factory-sample-walkthrough.md
<span data-ttu-id="0dbc8-233">[Azure IoT Edge]: https://github.com/Azure/iot-edge</span><span class="sxs-lookup"><span data-stu-id="0dbc8-233">[Azure IoT Edge]: https://github.com/Azure/iot-edge</span></span>

[lnk-publisher-github]: https://github.com/Azure/iot-edge-opc-publisher
[lnk-publisher-docker]: https://hub.docker.com/r/microsoft/iot-gateway-opc-ua
[lnk-proxy-github]: https://github.com/Azure/iot-edge-opc-proxy
[lnk-proxy-docker]: https://hub.docker.com/r/microsoft/iot-gateway-opc-ua-proxy