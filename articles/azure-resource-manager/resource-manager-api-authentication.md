---
title: "Autenticación de Azure Active Directory y Resource Manager | Microsoft Docs"
description: "Guía del desarrollador para la autenticación con la API de Azure Resource Manager y Azure Active Directory a fin de integrar una aplicación con otras suscripciones de Azure."
services: azure-resource-manager,active-directory
documentationcenter: na
author: dushyantgill
manager: timlt
editor: tysonn
ms.assetid: 17b2b40d-bf42-4c7d-9a88-9938409c5088
ms.service: azure-resource-manager
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: identity
ms.date: 12/27/2016
ms.author: dugill;tomfitz
ms.openlocfilehash: 7830dc4774652f4d108e98660dce3bcea7b32d05
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 07/11/2017
---
# <a name="use-resource-manager-authentication-api-to-access-subscriptions"></a><span data-ttu-id="dfb61-103">Uso de la API de autenticación de Resource Manager para acceder a suscripciones</span><span class="sxs-lookup"><span data-stu-id="dfb61-103">Use Resource Manager authentication API to access subscriptions</span></span>
## <a name="introduction"></a><span data-ttu-id="dfb61-104">Introducción</span><span class="sxs-lookup"><span data-stu-id="dfb61-104">Introduction</span></span>
<span data-ttu-id="dfb61-105">A los desarrolladores de software que necesitan crear una aplicación que administre los recursos de Azure de un cliente, este tema les muestra cómo realizar la autenticación con las API de Azure Resource Manager y obtener acceso a los recursos de otras suscripciones.</span><span class="sxs-lookup"><span data-stu-id="dfb61-105">If you are a software developer who needs to create an app that manages customer's Azure resources, this topic shows you how to authenticate with the Azure Resource Manager APIs and gain access to resources in other subscriptions.</span></span>

<span data-ttu-id="dfb61-106">Una aplicación puede acceder a las API de Resource Manager de cualquiera de estas dos formas:</span><span class="sxs-lookup"><span data-stu-id="dfb61-106">Your app can access the Resource Manager APIs in couple of ways:</span></span>

1. <span data-ttu-id="dfb61-107">**Acceso de usuario + aplicación**: para aplicaciones que acceden a los recursos en nombre de un usuario con una sesión iniciada.</span><span class="sxs-lookup"><span data-stu-id="dfb61-107">**User + app access**: for apps that access resources on behalf of a signed-in user.</span></span> <span data-ttu-id="dfb61-108">Este enfoque funciona con aplicaciones, como aplicaciones web y herramientas de línea de comandos, que se encargan solo de la "administración interactiva" de los recursos de Azure.</span><span class="sxs-lookup"><span data-stu-id="dfb61-108">This approach works for apps, such as web apps and command-line tools, that deal with only "interactive management" of Azure resources.</span></span>
2. <span data-ttu-id="dfb61-109">**Acceso de solo aplicación**: para las aplicaciones que ejecutan servicios de demonio y trabajos programados.</span><span class="sxs-lookup"><span data-stu-id="dfb61-109">**App-only access**: for apps that run daemon services and scheduled jobs.</span></span> <span data-ttu-id="dfb61-110">A la identidad de la aplicación se le concede acceso directo a los recursos.</span><span class="sxs-lookup"><span data-stu-id="dfb61-110">The app's identity is granted direct access to the resources.</span></span> <span data-ttu-id="dfb61-111">Este enfoque funciona para aplicaciones que necesitan acceso desatendido a largo plazo a Azure.</span><span class="sxs-lookup"><span data-stu-id="dfb61-111">This approach works for apps that need long-term headless (unattended) access to Azure.</span></span>

<span data-ttu-id="dfb61-112">En este tema se proporciona instrucciones detalladas de cómo crear una aplicación que emplea ambos métodos de autorización.</span><span class="sxs-lookup"><span data-stu-id="dfb61-112">This topic provides step-by-step instructions to create an app that employs both these authorization methods.</span></span> <span data-ttu-id="dfb61-113">Muestra cómo realizar cada paso con la API de REST o C#.</span><span class="sxs-lookup"><span data-stu-id="dfb61-113">It shows how to perform each step with REST API or C#.</span></span> <span data-ttu-id="dfb61-114">La aplicación ASP.NET MVC completa está disponible en [https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense](https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense).</span><span class="sxs-lookup"><span data-stu-id="dfb61-114">The complete ASP.NET MVC application is available at [https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense](https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense).</span></span>

## <a name="what-the-web-app-does"></a><span data-ttu-id="dfb61-115">Lo que hace la aplicación web</span><span class="sxs-lookup"><span data-stu-id="dfb61-115">What the web app does</span></span>
<span data-ttu-id="dfb61-116">La aplicación web:</span><span class="sxs-lookup"><span data-stu-id="dfb61-116">The web app:</span></span>

1. <span data-ttu-id="dfb61-117">Inicia sesión de un usuario de Azure.</span><span class="sxs-lookup"><span data-stu-id="dfb61-117">Signs-in an Azure user.</span></span>
2. <span data-ttu-id="dfb61-118">Pide al usuario que conceda a la aplicación web acceso a Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="dfb61-118">Asks user to grant the web app access to Resource Manager.</span></span>
3. <span data-ttu-id="dfb61-119">Obtiene un token de acceso de usuario + aplicación para acceder a Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="dfb61-119">Gets user + app access token for accessing Resource Manager.</span></span>
4. <span data-ttu-id="dfb61-120">Utiliza el token (del paso 3) para llamar a Resource Manager y asignar la entidad de servicio de la aplicación a un rol de la suscripción, que proporciona a la aplicación acceso a largo plazo a la suscripción.</span><span class="sxs-lookup"><span data-stu-id="dfb61-120">Uses token (from step 3) to call Resource Manager and assign the app's service principal to a role in the subscription, which gives the app long-term access to the subscription.</span></span>
5. <span data-ttu-id="dfb61-121">Obtiene un token de acceso de solo aplicación.</span><span class="sxs-lookup"><span data-stu-id="dfb61-121">Gets app-only access token.</span></span>
6. <span data-ttu-id="dfb61-122">Utiliza el token (del paso 5) para administrar los recursos de la suscripción a través de Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="dfb61-122">Uses token (from step 5) to manage resources in the subscription through Resource Manager.</span></span>

<span data-ttu-id="dfb61-123">Este es, de principio a fin, el flujo de la aplicación web.</span><span class="sxs-lookup"><span data-stu-id="dfb61-123">Here's the end-to-end flow of the web application.</span></span>

![Flujo de autenticación de Resource Manage](./media/resource-manager-api-authentication/Auth-Swim-Lane.png)

<span data-ttu-id="dfb61-125">Como usuario, proporcione el identificador de suscripción para especificar la suscripción que quiere usar:</span><span class="sxs-lookup"><span data-stu-id="dfb61-125">As a user, you provide the subscription id for the subscription you want to use:</span></span>

![proporcionar id. de suscripción](./media/resource-manager-api-authentication/sample-ux-1.png)

<span data-ttu-id="dfb61-127">Seleccione la cuenta que se va a usar para iniciar sesión.</span><span class="sxs-lookup"><span data-stu-id="dfb61-127">Select the account to use for logging in.</span></span>

![seleccionar cuenta](./media/resource-manager-api-authentication/sample-ux-2.png)

<span data-ttu-id="dfb61-129">Proporcione sus credenciales.</span><span class="sxs-lookup"><span data-stu-id="dfb61-129">Provide your credentials.</span></span>

![proporcionar credenciales](./media/resource-manager-api-authentication/sample-ux-3.png)

<span data-ttu-id="dfb61-131">Conceda a la aplicación acceso a las suscripciones de Azure:</span><span class="sxs-lookup"><span data-stu-id="dfb61-131">Grant the app access to your Azure subscriptions:</span></span>

![Conceder acceso](./media/resource-manager-api-authentication/sample-ux-4.png)

<span data-ttu-id="dfb61-133">Administre las suscripciones conectadas:</span><span class="sxs-lookup"><span data-stu-id="dfb61-133">Manage your connected subscriptions:</span></span>

![Conectar suscripción](./media/resource-manager-api-authentication/sample-ux-7.png)

## <a name="register-application"></a><span data-ttu-id="dfb61-135">Registre la aplicación</span><span class="sxs-lookup"><span data-stu-id="dfb61-135">Register application</span></span>
<span data-ttu-id="dfb61-136">Antes de comenzar a codificar, registre la aplicación web con Azure Active Directory (AD).</span><span class="sxs-lookup"><span data-stu-id="dfb61-136">Before you start coding, register your web app with Azure Active Directory (AD).</span></span> <span data-ttu-id="dfb61-137">El registro de aplicación crea una identidad central para la aplicación en Azure AD.</span><span class="sxs-lookup"><span data-stu-id="dfb61-137">The app registration creates a central identity for your app in Azure AD.</span></span> <span data-ttu-id="dfb61-138">Contiene información básica acerca de la aplicación, como el Id. de cliente de OAuth, las direcciones URL de respuesta y las credenciales que utiliza la aplicación para autenticarse y acceder a las API de Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="dfb61-138">It holds basic information about your application like OAuth Client ID, Reply URLs, and credentials that your application uses to authenticate and access Azure Resource Manager APIs.</span></span> <span data-ttu-id="dfb61-139">El registro de aplicación también registra los distintos permisos delegados que necesita la aplicación al acceder a las API de Microsoft en nombre del usuario.</span><span class="sxs-lookup"><span data-stu-id="dfb61-139">The app registration also records the various delegated permissions that your application needs when accessing Microsoft APIs on behalf of the user.</span></span>

<span data-ttu-id="dfb61-140">Dado que la aplicación tiene acceso a otra suscripción, debe configurarla como una aplicación multiinquilino.</span><span class="sxs-lookup"><span data-stu-id="dfb61-140">Because your app accesses other subscription, you must configure it as a multi-tenant application.</span></span> <span data-ttu-id="dfb61-141">Para aprobar la validación, proporcione un dominio asociado a Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="dfb61-141">To pass validation, provide a domain associated with your Azure Active Directory.</span></span> <span data-ttu-id="dfb61-142">Para ver los dominios asociados a Azure Active Directory, inicie sesión en el [portal clásico](https://manage.windowsazure.com).</span><span class="sxs-lookup"><span data-stu-id="dfb61-142">To see the domains associated with your Azure Active Directory, log in to the [classic portal](https://manage.windowsazure.com).</span></span> <span data-ttu-id="dfb61-143">Seleccione Azure Active Directory y luego **Dominios**.</span><span class="sxs-lookup"><span data-stu-id="dfb61-143">Select your Azure Active Directory and then select **Domains**.</span></span>

<span data-ttu-id="dfb61-144">En el ejemplo siguiente se muestra cómo registrar la aplicación con Azure PowerShell.</span><span class="sxs-lookup"><span data-stu-id="dfb61-144">The following example shows how to register the app by using Azure PowerShell.</span></span> <span data-ttu-id="dfb61-145">Debe tener la versión más reciente (agosto de 2016) de Azure PowerShell para que funcione este comando.</span><span class="sxs-lookup"><span data-stu-id="dfb61-145">You must have the latest version (August 2016) of Azure PowerShell for this command to work.</span></span>

    $app = New-AzureRmADApplication -DisplayName "{app name}" -HomePage "https://{your domain}/{app name}" -IdentifierUris "https://{your domain}/{app name}" -Password "{your password}" -AvailableToOtherTenants $true

<span data-ttu-id="dfb61-146">Para iniciar sesión como la aplicación de AD, necesita el identificador y la contraseña de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="dfb61-146">To log in as the AD application, you need the application id and password.</span></span> <span data-ttu-id="dfb61-147">Para ver el identificador de aplicación que se devuelve desde el comando anterior, use:</span><span class="sxs-lookup"><span data-stu-id="dfb61-147">To see the application id that is returned from the previous command, use:</span></span>

    $app.ApplicationId

<span data-ttu-id="dfb61-148">En el ejemplo siguiente se muestra cómo registrar la aplicación con la CLI de Azure.</span><span class="sxs-lookup"><span data-stu-id="dfb61-148">The following example shows how to register the app by using Azure CLI.</span></span>

    azure ad app create --name {app name} --home-page https://{your domain}/{app name} --identifier-uris https://{your domain}/{app name} --password {your password} --available true

<span data-ttu-id="dfb61-149">Los resultados incluyen AppId, que necesita para autenticarse como la aplicación.</span><span class="sxs-lookup"><span data-stu-id="dfb61-149">The results include the AppId, which you need when authenticating as the application.</span></span>

### <a name="optional-configuration---certificate-credential"></a><span data-ttu-id="dfb61-150">Configuración opcional: credencial de certificado</span><span class="sxs-lookup"><span data-stu-id="dfb61-150">Optional configuration - certificate credential</span></span>
<span data-ttu-id="dfb61-151">Azure AD también admite credenciales de certificado para las aplicaciones: cree un certificado autofirmado, mantenga la clave privada y agregue la clave pública al registro de la aplicación Azure AD.</span><span class="sxs-lookup"><span data-stu-id="dfb61-151">Azure AD also supports certificate credentials for applications: you create a self-signed cert, keep the private key, and add the public key to your Azure AD application registration.</span></span> <span data-ttu-id="dfb61-152">Para la autenticación, la aplicación envía una carga pequeña a Azure AD firmada con su clave privada y Azure AD valida la firma mediante la clave pública que se ha registrado.</span><span class="sxs-lookup"><span data-stu-id="dfb61-152">For authentication, your application sends a small payload to Azure AD signed using your private key, and Azure AD validates the signature using the public key that you registered.</span></span>

<span data-ttu-id="dfb61-153">Para obtener más información sobre cómo crear una aplicación de AD con un certificado, consulte [Uso de Azure PowerShell para crear una entidad de servicio para acceder a recursos](resource-group-authenticate-service-principal.md#create-service-principal-with-certificate-from-certificate-authority) o [Uso de la CLI de Azure para crear una entidad de servicio para acceder a recursos](resource-group-authenticate-service-principal-cli.md#create-service-principal-with-certificate).</span><span class="sxs-lookup"><span data-stu-id="dfb61-153">For information about creating an AD app with a certificate, see [Use Azure PowerShell to create a service principal to access resources](resource-group-authenticate-service-principal.md#create-service-principal-with-certificate-from-certificate-authority) or [Use Azure CLI to create a service principal to access resources](resource-group-authenticate-service-principal-cli.md#create-service-principal-with-certificate).</span></span>

## <a name="get-tenant-id-from-subscription-id"></a><span data-ttu-id="dfb61-154">Obtención de un identificador de inquilino a partir del identificador de suscripción</span><span class="sxs-lookup"><span data-stu-id="dfb61-154">Get tenant id from subscription id</span></span>
<span data-ttu-id="dfb61-155">Para solicitar un token que se pueda utilizar para llamar a Resource Manager, la aplicación necesita conocer el identificador del inquilino de Azure AD que hospeda la suscripción de Azure.</span><span class="sxs-lookup"><span data-stu-id="dfb61-155">To request a token that can be used to call Resource Manager, your application needs to know the tenant ID of the Azure AD tenant that hosts the Azure subscription.</span></span> <span data-ttu-id="dfb61-156">Es muy probable que los usuarios conozcan sus identificadores de suscripción, pero quizá no sus identificadores de inquilino para Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="dfb61-156">Most likely, your users know their subscription ids, but they might not know their tenant ids for Azure Active Directory.</span></span> <span data-ttu-id="dfb61-157">Para obtener el identificador de inquilino del usuario, solicítele el identificador de suscripción.</span><span class="sxs-lookup"><span data-stu-id="dfb61-157">To get the user's tenant id, ask the user for the subscription id.</span></span> <span data-ttu-id="dfb61-158">Proporcione ese identificador de suscripción al enviar una solicitud acerca de la suscripción:</span><span class="sxs-lookup"><span data-stu-id="dfb61-158">Provide that subscription id when sending a request about the subscription:</span></span>

    https://management.azure.com/subscriptions/{subscription-id}?api-version=2015-01-01

<span data-ttu-id="dfb61-159">Se produce un error en la solicitud porque el usuario aún no ha iniciado sesión pero puede recuperar el identificador de inquilino en la respuesta.</span><span class="sxs-lookup"><span data-stu-id="dfb61-159">The request fails because the user has not logged in yet, but you can retrieve the tenant id from the response.</span></span> <span data-ttu-id="dfb61-160">En esa excepción, recupere el identificador de inquilino en el valor de encabezado de la respuesta de **WWW-Authenticate**.</span><span class="sxs-lookup"><span data-stu-id="dfb61-160">In that exception, retrieve the tenant id from the response header value for **WWW-Authenticate**.</span></span> <span data-ttu-id="dfb61-161">Consulte esta implementación en el método [GetDirectoryForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L20) .</span><span class="sxs-lookup"><span data-stu-id="dfb61-161">You see this implementation in the [GetDirectoryForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L20) method.</span></span>

## <a name="get-user--app-access-token"></a><span data-ttu-id="dfb61-162">Obtención de un token de acceso de usuario + aplicación</span><span class="sxs-lookup"><span data-stu-id="dfb61-162">Get user + app access token</span></span>
<span data-ttu-id="dfb61-163">La aplicación redirige al usuario a Azure AD con una solicitud de autorización de OAuth 2.0 (para autenticar las credenciales del usuario y obtener un código de autorización).</span><span class="sxs-lookup"><span data-stu-id="dfb61-163">Your application redirects the user to Azure AD with an OAuth 2.0 Authorize Request - to authenticate the user's credentials and get back an authorization code.</span></span> <span data-ttu-id="dfb61-164">La aplicación utiliza el código de autorización para obtener un token de acceso para Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="dfb61-164">Your application uses the authorization code to get an access token for Resource Manager.</span></span> <span data-ttu-id="dfb61-165">El método [ConnectSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/Controllers/HomeController.cs#L42) crea la solicitud de autorización.</span><span class="sxs-lookup"><span data-stu-id="dfb61-165">The [ConnectSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/Controllers/HomeController.cs#L42) method creates the authorization request.</span></span>

<span data-ttu-id="dfb61-166">Este tema muestra las solicitudes de la API de REST para autenticar al usuario.</span><span class="sxs-lookup"><span data-stu-id="dfb61-166">This topic shows the REST API requests to authenticate the user.</span></span> <span data-ttu-id="dfb61-167">También puede utilizar bibliotecas auxiliares para realizar la autenticación en el código.</span><span class="sxs-lookup"><span data-stu-id="dfb61-167">You can also use helper libraries to perform authentication in your code.</span></span> <span data-ttu-id="dfb61-168">Para obtener más información sobre estas bibliotecas, consulte [Bibliotecas de autenticación de Azure Active Directory](../active-directory/active-directory-authentication-libraries.md).</span><span class="sxs-lookup"><span data-stu-id="dfb61-168">For more information about these libraries, see [Azure Active Directory Authentication Libraries](../active-directory/active-directory-authentication-libraries.md).</span></span> <span data-ttu-id="dfb61-169">Para obtener instrucciones sobre la integración de la administración de identidades en una aplicación, consulte la [Guía del desarrollador de Azure Active Directory](../active-directory/active-directory-developers-guide.md).</span><span class="sxs-lookup"><span data-stu-id="dfb61-169">For guidance on integrating identity management in an application, see [Azure Active Directory developer's guide](../active-directory/active-directory-developers-guide.md).</span></span>

### <a name="auth-request-oauth-20"></a><span data-ttu-id="dfb61-170">Solicitud de autenticación (OAuth 2.0)</span><span class="sxs-lookup"><span data-stu-id="dfb61-170">Auth request (OAuth 2.0)</span></span>
<span data-ttu-id="dfb61-171">Emita una solicitud de autorización de Open ID Connect u OAuth2.0 para el punto de conexión de autorización de Azure AD:</span><span class="sxs-lookup"><span data-stu-id="dfb61-171">Issue an Open ID Connect/OAuth2.0 Authorize Request to the Azure AD Authorize endpoint:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Authorize

<span data-ttu-id="dfb61-172">Los parámetros de la cadena de consulta disponibles para esta solicitud se describen en el tema sobre [solicitud de un código de autorización](../active-directory/develop/active-directory-protocols-oauth-code.md#request-an-authorization-code) .</span><span class="sxs-lookup"><span data-stu-id="dfb61-172">The query string parameters that are available for this request are described in the [request an authorization code](../active-directory/develop/active-directory-protocols-oauth-code.md#request-an-authorization-code) topic.</span></span>

<span data-ttu-id="dfb61-173">En el ejemplo siguiente se muestra cómo solicitar una autorización de OAuth2.0:</span><span class="sxs-lookup"><span data-stu-id="dfb61-173">The following example shows how to request OAuth2.0 authorization:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Authorize?client_id=a0448380-c346-4f9f-b897-c18733de9394&response_mode=query&response_type=code&redirect_uri=http%3a%2f%2fwww.vipswapper.com%2fcloudsense%2fAccount%2fSignIn&resource=https%3a%2f%2fgraph.windows.net%2f&domain_hint=live.com

<span data-ttu-id="dfb61-174">Azure AD autentica al usuario y, si es necesario, pide al usuario que conceda permiso a la aplicación.</span><span class="sxs-lookup"><span data-stu-id="dfb61-174">Azure AD authenticates the user, and, if necessary, asks the user to grant permission to the app.</span></span> <span data-ttu-id="dfb61-175">Devuelve el código de autorización a la dirección URL de respuesta de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="dfb61-175">It returns the authorization code to the Reply URL of your application.</span></span> <span data-ttu-id="dfb61-176">Dependiendo del parámetro response_mode solicitado, Azure AD devuelve los datos en la cadena de consulta o como datos POST.</span><span class="sxs-lookup"><span data-stu-id="dfb61-176">Depending on the requested response_mode, Azure AD either sends back the data in query string or as post data.</span></span>

    code=AAABAAAAiL****FDMZBUwZ8eCAA&session_state=2d16bbce-d5d1-443f-acdf-75f6b0ce8850

### <a name="auth-request-open-id-connect"></a><span data-ttu-id="dfb61-177">Solicitud de autenticación (Open ID Connect)</span><span class="sxs-lookup"><span data-stu-id="dfb61-177">Auth request (Open ID Connect)</span></span>
<span data-ttu-id="dfb61-178">Si no solo desea acceder a Azure Resource Manager en nombre del usuario, sino también permitirle usar su propia cuenta de Azure AD para iniciar sesión en la aplicación, emita una solicitud de autorización de Open ID Connect.</span><span class="sxs-lookup"><span data-stu-id="dfb61-178">If you not only wish to access Azure Resource Manager on behalf of the user, but also allow the user to sign in to your application using their Azure AD account, issue an Open ID Connect Authorize Request.</span></span> <span data-ttu-id="dfb61-179">Con Open ID Connect, la aplicación recibe también un id_token de Azure AD que puede utilizar para el inicio de sesión del usuario.</span><span class="sxs-lookup"><span data-stu-id="dfb61-179">With Open ID Connect, your application also receives an id_token from Azure AD that your app can use to sign in the user.</span></span>

<span data-ttu-id="dfb61-180">Los parámetros de la cadena de consulta disponibles para esta solicitud se describen en el tema [Envío de la solicitud de inicio de sesión](../active-directory/develop/active-directory-protocols-openid-connect-code.md#send-the-sign-in-request) .</span><span class="sxs-lookup"><span data-stu-id="dfb61-180">The query string parameters that are available for this request are described in the [Send the sign-in request](../active-directory/develop/active-directory-protocols-openid-connect-code.md#send-the-sign-in-request) topic.</span></span>

<span data-ttu-id="dfb61-181">Este es un ejemplo de solicitud de Open ID Connect:</span><span class="sxs-lookup"><span data-stu-id="dfb61-181">An example Open ID Connect request is:</span></span>

     https://login.microsoftonline.com/{tenant-id}/OAuth2/Authorize?client_id=a0448380-c346-4f9f-b897-c18733de9394&response_mode=form_post&response_type=code+id_token&redirect_uri=http%3a%2f%2fwww.vipswapper.com%2fcloudsense%2fAccount%2fSignIn&resource=https%3a%2f%2fgraph.windows.net%2f&scope=openid+profile&nonce=63567Dc4MDAw&domain_hint=live.com&state=M_12tMyKaM8

<span data-ttu-id="dfb61-182">Azure AD autentica al usuario y, si es necesario, pide al usuario que conceda permiso a la aplicación.</span><span class="sxs-lookup"><span data-stu-id="dfb61-182">Azure AD authenticates the user, and, if necessary, asks the user to grant permission to the app.</span></span> <span data-ttu-id="dfb61-183">Devuelve el código de autorización a la dirección URL de respuesta de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="dfb61-183">It returns the authorization code to the Reply URL of your application.</span></span> <span data-ttu-id="dfb61-184">Dependiendo del parámetro response_mode solicitado, Azure AD devuelve los datos en la cadena de consulta o como datos POST.</span><span class="sxs-lookup"><span data-stu-id="dfb61-184">Depending on the requested response_mode, Azure AD either sends back the data in query string or as post data.</span></span>

<span data-ttu-id="dfb61-185">Este es un ejemplo de respuesta de Open ID Connect:</span><span class="sxs-lookup"><span data-stu-id="dfb61-185">An example Open ID Connect response is:</span></span>

    code=AAABAAAAiL*****I4rDWd7zXsH6WUjlkIEQxIAA&id_token=eyJ0eXAiOiJKV1Q*****T3GrzzSFxg&state=M_12tMyKaM8&session_state=2d16bbce-d5d1-443f-acdf-75f6b0ce8850

### <a name="token-request-oauth20-code-grant-flow"></a><span data-ttu-id="dfb61-186">Solicitud de token (flujo de concesión de códigos de OAuth2.0)</span><span class="sxs-lookup"><span data-stu-id="dfb61-186">Token request (OAuth2.0 Code Grant Flow)</span></span>
<span data-ttu-id="dfb61-187">Una vez que la aplicación haya recibido el código de autorización de Azure AD, es el momento de obtener el token de acceso para Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="dfb61-187">Now that your application has received the authorization code from Azure AD, it is time to get the access token for Azure Resource Manager.</span></span>  <span data-ttu-id="dfb61-188">Publique una solicitud de token de concesión de códigos de OAuth2.0 en el punto de conexión del token de Azure AD:</span><span class="sxs-lookup"><span data-stu-id="dfb61-188">Post an OAuth2.0 Code Grant Token Request to the Azure AD Token endpoint:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Token

<span data-ttu-id="dfb61-189">Los parámetros de la cadena de consulta disponibles para esta solicitud se describen en el tema sobre el [uso del código de autorización](../active-directory/develop/active-directory-protocols-oauth-code.md#use-the-authorization-code-to-request-an-access-token) .</span><span class="sxs-lookup"><span data-stu-id="dfb61-189">The query string parameters that are available for this request are described in the [use the authorization code](../active-directory/develop/active-directory-protocols-oauth-code.md#use-the-authorization-code-to-request-an-access-token) topic.</span></span>

<span data-ttu-id="dfb61-190">El ejemplo siguiente muestra una solicitud de token de concesión de códigos con la credencial de contraseña:</span><span class="sxs-lookup"><span data-stu-id="dfb61-190">The following example shows a request for code grant token with password credential:</span></span>

    POST https://login.microsoftonline.com/7fe877e6-a150-4992-bbfe-f517e304dfa0/oauth2/token HTTP/1.1

    Content-Type: application/x-www-form-urlencoded
    Content-Length: 1012

    grant_type=authorization_code&code=AAABAAAAiL9Kn2Z*****L1nVMH3Z5ESiAA&redirect_uri=http%3A%2F%2Flocalhost%3A62080%2FAccount%2FSignIn&client_id=a0448380-c346-4f9f-b897-c18733de9394&client_secret=olna84E8*****goScOg%3D

<span data-ttu-id="dfb61-191">Cuando trabaje con credenciales de certificado, cree un JSON Web Token (JWT) y una firma (RSA SHA256) mediante la clave privada de la credencial de certificado de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="dfb61-191">When working with certificate credentials, create a JSON Web Token (JWT) and sign (RSA SHA256) using the private key of your application's certificate credential.</span></span> <span data-ttu-id="dfb61-192">Se muestran los tipos de notificación para el token en [Notificaciones de token JWT](../active-directory/develop/active-directory-protocols-oauth-code.md#jwt-token-claims).</span><span class="sxs-lookup"><span data-stu-id="dfb61-192">The claim types for the token are shown in [JWT token claims](../active-directory/develop/active-directory-protocols-oauth-code.md#jwt-token-claims).</span></span> <span data-ttu-id="dfb61-193">Para referencia, consulte el [código de la biblioteca de autorización de Active Directory (.NET)](https://github.com/AzureAD/azure-activedirectory-library-for-dotnet/blob/dev/src/ADAL.PCL.Desktop/CryptographyHelper.cs) para firmar tokens JWT de aserción de cliente.</span><span class="sxs-lookup"><span data-stu-id="dfb61-193">For reference, see the [Active Directory Auth Library (.NET) code](https://github.com/AzureAD/azure-activedirectory-library-for-dotnet/blob/dev/src/ADAL.PCL.Desktop/CryptographyHelper.cs) to sign Client Assertion JWT tokens.</span></span>

<span data-ttu-id="dfb61-194">Consulte la [especificación de Open ID Connect](http://openid.net/specs/openid-connect-core-1_0.html#ClientAuthentication) para más información acerca de la autenticación de cliente.</span><span class="sxs-lookup"><span data-stu-id="dfb61-194">See the [Open ID Connect spec](http://openid.net/specs/openid-connect-core-1_0.html#ClientAuthentication) for details on client authentication.</span></span>

<span data-ttu-id="dfb61-195">El ejemplo siguiente muestra una solicitud de token de concesión de códigos con una credencial de certificado:</span><span class="sxs-lookup"><span data-stu-id="dfb61-195">The following example shows a request for code grant token with certificate credential:</span></span>

    POST https://login.microsoftonline.com/7fe877e6-a150-4992-bbfe-f517e304dfa0/oauth2/token HTTP/1.1

    Content-Type: application/x-www-form-urlencoded
    Content-Length: 1012

    grant_type=authorization_code&code=AAABAAAAiL9Kn2Z*****L1nVMH3Z5ESiAA&redirect_uri=http%3A%2F%2Flocalhost%3A62080%2FAccount%2FSignIn&client_id=a0448380-c346-4f9f-b897-c18733de9394&client_assertion_type=urn%3Aietf%3Aparams%3Aoauth%3Aclient-assertion-type%3Ajwt-bearer&client_assertion=eyJhbG*****Y9cYo8nEjMyA

<span data-ttu-id="dfb61-196">Un ejemplo de respuesta de token de concesión de códigos:</span><span class="sxs-lookup"><span data-stu-id="dfb61-196">An example response for code grant token:</span></span>

    HTTP/1.1 200 OK

    {"token_type":"Bearer","expires_in":"3599","expires_on":"1432039858","not_before":"1432035958","resource":"https://management.core.windows.net/","access_token":"eyJ0eXAiOiJKV1Q****M7Cw6JWtfY2lGc5A","refresh_token":"AAABAAAAiL9Kn2Z****55j-sjnyYgAA","scope":"user_impersonation","id_token":"eyJ0eXAiOiJKV*****-drP1J3P-HnHi9Rr46kGZnukEBH4dsg"}

#### <a name="handle-code-grant-token-response"></a><span data-ttu-id="dfb61-197">Control de la respuesta de token de concesión de códigos</span><span class="sxs-lookup"><span data-stu-id="dfb61-197">Handle code grant token response</span></span>
<span data-ttu-id="dfb61-198">Una respuesta correcta del token contiene el token de acceso (usuario + aplicación) para Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="dfb61-198">A successful token response contains the (user + app) access token for Azure Resource Manager.</span></span> <span data-ttu-id="dfb61-199">La aplicación utiliza este token de acceso para acceder a Resource Manager en nombre del usuario.</span><span class="sxs-lookup"><span data-stu-id="dfb61-199">Your application uses this access token to access Resource Manager on behalf of the user.</span></span> <span data-ttu-id="dfb61-200">Los tokens de acceso emitidos por Azure AD tienen una duración de una hora.</span><span class="sxs-lookup"><span data-stu-id="dfb61-200">The lifetime of access tokens issued by Azure AD is one hour.</span></span> <span data-ttu-id="dfb61-201">Es poco probable que la aplicación web necesite renovar el token de acceso (usuario + aplicación).</span><span class="sxs-lookup"><span data-stu-id="dfb61-201">It is unlikely that your web application needs to renew the (user + app) access token.</span></span> <span data-ttu-id="dfb61-202">Si necesita renovar el token de acceso, utilice el token de actualización que recibe la aplicación en la respuesta del token.</span><span class="sxs-lookup"><span data-stu-id="dfb61-202">If it needs to renew the access token, use the refresh token that your application receives in the token response.</span></span> <span data-ttu-id="dfb61-203">Publique una solicitud de token de OAuth2.0 en el punto de conexión del token de Azure AD:</span><span class="sxs-lookup"><span data-stu-id="dfb61-203">Post an OAuth2.0 Token Request to the Azure AD Token endpoint:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Token

<span data-ttu-id="dfb61-204">Los parámetros que se usan con la solicitud de actualización se describen en [Actualización de los tokens de acceso](../active-directory/develop/active-directory-protocols-oauth-code.md#refreshing-the-access-tokens).</span><span class="sxs-lookup"><span data-stu-id="dfb61-204">The parameters to use with the refresh request are described in [refreshing the access token](../active-directory/develop/active-directory-protocols-oauth-code.md#refreshing-the-access-tokens).</span></span>

<span data-ttu-id="dfb61-205">En el ejemplo siguiente se muestra cómo utilizar el token de actualización:</span><span class="sxs-lookup"><span data-stu-id="dfb61-205">The following example shows how to use the refresh token:</span></span>

    POST https://login.microsoftonline.com/7fe877e6-a150-4992-bbfe-f517e304dfa0/oauth2/token HTTP/1.1

    Content-Type: application/x-www-form-urlencoded
    Content-Length: 1012

    grant_type=refresh_token&refresh_token=AAABAAAAiL9Kn2Z****55j-sjnyYgAA&client_id=a0448380-c346-4f9f-b897-c18733de9394&client_secret=olna84E8*****goScOg%3D

<span data-ttu-id="dfb61-206">Aunque se pueden usar tokens de actualización para obtener nuevos tokens de acceso para Azure Resource Manager, no son adecuados para el acceso sin conexión por parte de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="dfb61-206">Although refresh tokens can be used to get new access tokens for Azure Resource Manager, they are not suitable for offline access by your application.</span></span> <span data-ttu-id="dfb61-207">La duración de los tokens de actualización está limitada y los tokens de actualización están enlazados al usuario.</span><span class="sxs-lookup"><span data-stu-id="dfb61-207">The refresh tokens lifetime is limited, and refresh tokens are bound to the user.</span></span> <span data-ttu-id="dfb61-208">Si el usuario abandona la organización, la aplicación que usa el token de actualización pierde el acceso.</span><span class="sxs-lookup"><span data-stu-id="dfb61-208">If the user leaves the organization, the application using the refresh token loses access.</span></span> <span data-ttu-id="dfb61-209">Este enfoque no es adecuado para las aplicaciones que se utilizan los equipos para administrar los recursos de Azure.</span><span class="sxs-lookup"><span data-stu-id="dfb61-209">This approach isn't suitable for applications that are used by teams to manage their Azure resources.</span></span>

## <a name="check-if-user-can-assign-access-to-subscription"></a><span data-ttu-id="dfb61-210">Comprobación de que el usuario pueda asignar acceso a la suscripción</span><span class="sxs-lookup"><span data-stu-id="dfb61-210">Check if user can assign access to subscription</span></span>
<span data-ttu-id="dfb61-211">Su aplicación ahora tiene un token para acceder a Azure Resource Manager en nombre del usuario.</span><span class="sxs-lookup"><span data-stu-id="dfb61-211">Your application now has a token to access Azure Resource Manager on behalf of the user.</span></span> <span data-ttu-id="dfb61-212">El siguiente paso es conectar la aplicación con la suscripción.</span><span class="sxs-lookup"><span data-stu-id="dfb61-212">The next step is to connect your app to the subscription.</span></span> <span data-ttu-id="dfb61-213">Después de conectarse, la aplicación puede administrar estas suscripciones incluso si el usuario no está presente (acceso sin conexión a largo plazo).</span><span class="sxs-lookup"><span data-stu-id="dfb61-213">After connecting, your app can manage those subscriptions even when the user isn't present (long-term offline access).</span></span>

<span data-ttu-id="dfb61-214">En cada suscripción que haya que conectar, llame a la API de [enumeración de permisos de Resource Manager](https://docs.microsoft.com/rest/api/authorization/permissions) para determinar si el usuario tiene derechos de administración de acceso en la suscripción.</span><span class="sxs-lookup"><span data-stu-id="dfb61-214">For each subscription to connect, call the [Resource Manager list permissions](https://docs.microsoft.com/rest/api/authorization/permissions) API to determine whether the user has access management rights for the subscription.</span></span>

<span data-ttu-id="dfb61-215">El método [UserCanManagerAccessForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L44) de la aplicación de ejemplo ASP.NET MVC implementa esta llamada.</span><span class="sxs-lookup"><span data-stu-id="dfb61-215">The [UserCanManagerAccessForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L44) method of the ASP.NET MVC sample app implements this call.</span></span>

<span data-ttu-id="dfb61-216">En el ejemplo siguiente se muestra cómo solicitar permisos de un usuario en una suscripción.</span><span class="sxs-lookup"><span data-stu-id="dfb61-216">The following example shows how to request a user's permissions on a subscription.</span></span> <span data-ttu-id="dfb61-217">83cfe939-2402-4581-b761-4f59b0a041e4 es el identificador de la suscripción.</span><span class="sxs-lookup"><span data-stu-id="dfb61-217">83cfe939-2402-4581-b761-4f59b0a041e4 is the id of the subscription.</span></span>

    GET https://management.azure.com/subscriptions/83cfe939-2402-4581-b761-4f59b0a041e4/providers/microsoft.authorization/permissions?api-version=2015-07-01 HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJKV1QiLC***lwO1mM7Cw6JWtfY2lGc5A

<span data-ttu-id="dfb61-218">Un ejemplo de la respuesta para obtener los permisos del usuario en la suscripción es:</span><span class="sxs-lookup"><span data-stu-id="dfb61-218">An example of the response to get user's permissions on subscription is:</span></span>

    HTTP/1.1 200 OK

    {"value":[{"actions":["*"],"notActions":["Microsoft.Authorization/*/Write","Microsoft.Authorization/*/Delete"]},{"actions":["*/read"],"notActions":[]}]}

<span data-ttu-id="dfb61-219">La API de permisos devuelve varios permisos.</span><span class="sxs-lookup"><span data-stu-id="dfb61-219">The permissions API returns multiple permissions.</span></span> <span data-ttu-id="dfb61-220">Cada permiso consta de acciones permitidas (actions) y acciones no permitidas (notactions).</span><span class="sxs-lookup"><span data-stu-id="dfb61-220">Each permission consists of allowed actions (actions) and disallowed actions (notactions).</span></span> <span data-ttu-id="dfb61-221">Si una acción está presente en la lista de acciones permitidas de cualquier permiso y no está presente en la lista de notactions de dicho permiso, el usuario puede realizar dicha acción.</span><span class="sxs-lookup"><span data-stu-id="dfb61-221">If an action is present in the allowed actions list of any permission and not present in the notactions list of that permission, the user is allowed to perform that action.</span></span> <span data-ttu-id="dfb61-222">**microsoft.authorization/roleassignments/write** es la acción que concede derechos de administración de acceso.</span><span class="sxs-lookup"><span data-stu-id="dfb61-222">**microsoft.authorization/roleassignments/write** is the action that that grants access management rights.</span></span> <span data-ttu-id="dfb61-223">La aplicación debe analizar el resultado de los permisos para buscar una coincidencia de regex en esta cadena de acción en las actions y notactions de cada permiso.</span><span class="sxs-lookup"><span data-stu-id="dfb61-223">Your application must parse the permissions result to look for a regex match on this action string in the actions and notactions of each permission.</span></span>

## <a name="get-app-only-access-token"></a><span data-ttu-id="dfb61-224">Obtención de un token de acceso de solo aplicación</span><span class="sxs-lookup"><span data-stu-id="dfb61-224">Get app-only access token</span></span>
<span data-ttu-id="dfb61-225">Ahora ya sabe si el usuario puede asignar acceso a la suscripción de Azure.</span><span class="sxs-lookup"><span data-stu-id="dfb61-225">Now, you know if the user can assign access to the Azure subscription.</span></span> <span data-ttu-id="dfb61-226">Los pasos siguientes son:</span><span class="sxs-lookup"><span data-stu-id="dfb61-226">The next steps are:</span></span>

1. <span data-ttu-id="dfb61-227">Asignar el rol RBAC adecuado a la identidad de la aplicación en la suscripción.</span><span class="sxs-lookup"><span data-stu-id="dfb61-227">Assign the appropriate RBAC role to your application's identity on the subscription.</span></span>
2. <span data-ttu-id="dfb61-228">Validar la asignación de acceso al consultar el permiso de la aplicación en la suscripción o acceder a Resource Manager con el token de solo aplicación.</span><span class="sxs-lookup"><span data-stu-id="dfb61-228">Validate the access assignment by querying for the Application's permission on the subscription or by accessing Resource Manager using app-only token.</span></span>
3. <span data-ttu-id="dfb61-229">Registrar la conexión en la estructura de datos de "suscripciones conectadas" de las aplicaciones (sin perder el identificador de la suscripción).</span><span class="sxs-lookup"><span data-stu-id="dfb61-229">Record the connection in your applications "connected subscriptions" data structure - persisting the id of the subscription.</span></span>

<span data-ttu-id="dfb61-230">Examinemos más detenidamente el primer paso.</span><span class="sxs-lookup"><span data-stu-id="dfb61-230">Let's look closer at the first step.</span></span> <span data-ttu-id="dfb61-231">Para asignar el rol RBAC adecuado a la identidad de la aplicación, es preciso determinar:</span><span class="sxs-lookup"><span data-stu-id="dfb61-231">To assign the appropriate RBAC role to the application's identity, you must determine:</span></span>

* <span data-ttu-id="dfb61-232">El identificador de objeto de la identidad de la aplicación en el directorio de Azure Active Directory del usuario</span><span class="sxs-lookup"><span data-stu-id="dfb61-232">The object id of your application's identity in the user's Azure Active Directory</span></span>
* <span data-ttu-id="dfb61-233">El identificador del rol RBAC que requiere la aplicación en la suscripción</span><span class="sxs-lookup"><span data-stu-id="dfb61-233">The identifier of the RBAC role that your application requires on the subscription</span></span>

<span data-ttu-id="dfb61-234">Cuando la aplicación autentica a un usuario desde un directorio de Azure AD, crea un objeto de entidad de servicio para la aplicación en dicho directorio de Azure AD.</span><span class="sxs-lookup"><span data-stu-id="dfb61-234">When your application authenticates a user from an Azure AD, it creates a service principal object for your application in that Azure AD.</span></span> <span data-ttu-id="dfb61-235">Azure permite asignar roles RBAC a entidades de servicio, con el fin de conceder acceso directo a las aplicaciones correspondientes en los recursos de Azure.</span><span class="sxs-lookup"><span data-stu-id="dfb61-235">Azure allows RBAC roles to be assigned to service principals to grant direct access to corresponding applications on Azure resources.</span></span> <span data-ttu-id="dfb61-236">Esta acción es exactamente lo que deseamos hacer.</span><span class="sxs-lookup"><span data-stu-id="dfb61-236">This action is exactly what we wish to do.</span></span> <span data-ttu-id="dfb61-237">Consulte la API de Azure AD Graph para determinar el identificador de la entidad de servicio de la aplicación en el directorio de Azure AD del usuario que inició sesión.</span><span class="sxs-lookup"><span data-stu-id="dfb61-237">Query the Azure AD Graph API to determine the identifier of the service principal of your application in the signed-in user's Azure AD.</span></span>

<span data-ttu-id="dfb61-238">Solo tiene un token de acceso para Azure Resource Manager (se necesita un token de acceso nuevo para llamar a la API de Azure AD Graph).</span><span class="sxs-lookup"><span data-stu-id="dfb61-238">You only have an access token for Azure Resource Manager - you need a new access token to call the Azure AD Graph API.</span></span> <span data-ttu-id="dfb61-239">Todas las aplicaciones de Azure AD tienen permiso para consultar su propio objeto de entidad de servicio, por lo que bastará con un token de acceso de solo aplicación.</span><span class="sxs-lookup"><span data-stu-id="dfb61-239">Every application in Azure AD has permission to query its own service principal object, so an app-only access token is sufficient.</span></span>

<a id="app-azure-ad-graph" />

### <a name="get-app-only-access-token-for-azure-ad-graph-api"></a><span data-ttu-id="dfb61-240">Obtención de token de acceso de solo aplicación para la API de Azure AD Graph</span><span class="sxs-lookup"><span data-stu-id="dfb61-240">Get app-only access token for Azure AD Graph API</span></span>
<span data-ttu-id="dfb61-241">Para autenticar una aplicación y obtener un token para la API de Azure AD Graph, emita una solicitud de token de flujo de OAuth2.0 de concesión de credenciales de cliente al punto de conexión del token de Azure AD (**https://login.microsoftonline.com/{directory_domain_name}/OAuth2/Token**).</span><span class="sxs-lookup"><span data-stu-id="dfb61-241">To authenticate your app and get a token to Azure AD Graph API, issue a Client Credential Grant OAuth2.0 flow token request to Azure AD token endpoint (**https://login.microsoftonline.com/{directory_domain_name}/OAuth2/Token**).</span></span>

<span data-ttu-id="dfb61-242">El método [GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs) de la aplicación de ejemplo ASP.NET MVC obtiene un token de acceso de solo aplicación para la API Graph mediante la Biblioteca de autenticación de Active Directory para .NET.</span><span class="sxs-lookup"><span data-stu-id="dfb61-242">The [GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs) method of the ASP.net MVC sample application gets an app-only access token for Graph API using the Active Directory Authentication Library for .NET.</span></span>

<span data-ttu-id="dfb61-243">Los parámetros de la cadena de consulta disponibles para esta solicitud se describen en el tema [Solicitar un token de acceso](../active-directory/develop/active-directory-protocols-oauth-service-to-service.md#request-an-access-token) .</span><span class="sxs-lookup"><span data-stu-id="dfb61-243">The query string parameters that are available for this request are described in the [Request an Access Token](../active-directory/develop/active-directory-protocols-oauth-service-to-service.md#request-an-access-token) topic.</span></span>

<span data-ttu-id="dfb61-244">Una solicitud de ejemplo de token de concesión de credenciales de cliente:</span><span class="sxs-lookup"><span data-stu-id="dfb61-244">An example request for client credential grant token:</span></span>

    POST https://login.microsoftonline.com/62e173e9-301e-423e-bcd4-29121ec1aa24/oauth2/token HTTP/1.1
    Content-Type: application/x-www-form-urlencoded
    Content-Length: 187</pre>
    <pre>grant_type=client_credentials&client_id=a0448380-c346-4f9f-b897-c18733de9394&resource=https%3A%2F%2Fgraph.windows.net%2F &client_secret=olna8C*****Og%3D

<span data-ttu-id="dfb61-245">Una respuesta de ejemplo de token de concesión de credenciales de cliente:</span><span class="sxs-lookup"><span data-stu-id="dfb61-245">An example response for client credential grant token:</span></span>

    HTTP/1.1 200 OK

    {"token_type":"Bearer","expires_in":"3599","expires_on":"1432039862","not_before":"1432035962","resource":"https://graph.windows.net/","access_token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik1uQ19WWmNBVGZNNXBPWWlKSE1iYTlnb0VLWSIsImtpZCI6Ik1uQ19WWmNBVGZNNXBPWWlKSE1iYTlnb0VLWSJ9.eyJhdWQiOiJodHRwczovL2dyYXBoLndpbmRv****G5gUTV-kKorR-pg"}

### <a name="get-objectid-of-application-service-principal-in-user-azure-ad"></a><span data-ttu-id="dfb61-246">Obtención del id. de objeto de entidad de servicio de aplicación en la instancia de Azure AD de usuario</span><span class="sxs-lookup"><span data-stu-id="dfb61-246">Get ObjectId of application service principal in user Azure AD</span></span>
<span data-ttu-id="dfb61-247">Ahora use el token de acceso de solo aplicación para consultar la API de [entidades de servicio de Azure AD Graph](https://msdn.microsoft.com/Library/Azure/Ad/Graph/api/entity-and-complex-type-reference#serviceprincipal-entity) para determinar el identificador de objeto de la entidad de servicio de la aplicación en el directorio.</span><span class="sxs-lookup"><span data-stu-id="dfb61-247">Now, use the app-only access token to query the [Azure AD Graph Service Principals](https://msdn.microsoft.com/Library/Azure/Ad/Graph/api/entity-and-complex-type-reference#serviceprincipal-entity) API to determine the Object Id of the application's service principal in the directory.</span></span>

<span data-ttu-id="dfb61-248">El método [GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs#) de la aplicación de ejemplo ASP.NET MVC implementa esta llamada.</span><span class="sxs-lookup"><span data-stu-id="dfb61-248">The [GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs#) method of the ASP.net MVC sample application implements this call.</span></span>

<span data-ttu-id="dfb61-249">En el ejemplo siguiente se muestra cómo solicitar una entidad de servicio de aplicación.</span><span class="sxs-lookup"><span data-stu-id="dfb61-249">The following example shows how to request an application's service principal.</span></span> <span data-ttu-id="dfb61-250">a0448380-c346-4f9f-b897-c18733de9394 es el identificador de cliente de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="dfb61-250">a0448380-c346-4f9f-b897-c18733de9394 is the client id of the application.</span></span>

    GET https://graph.windows.net/62e173e9-301e-423e-bcd4-29121ec1aa24/servicePrincipals?api-version=1.5&$filter=appId%20eq%20'a0448380-c346-4f9f-b897-c18733de9394' HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJK*****-kKorR-pg

<span data-ttu-id="dfb61-251">En el ejemplo siguiente se muestra una respuesta a la solicitud de una entidad de servicio de aplicación</span><span class="sxs-lookup"><span data-stu-id="dfb61-251">The following example shows a response to the request for an application's service principal</span></span>

    HTTP/1.1 200 OK

    {"odata.metadata":"https://graph.windows.net/62e173e9-301e-423e-bcd4-29121ec1aa24/$metadata#directoryObjects/Microsoft.DirectoryServices.ServicePrincipal","value":[{"odata.type":"Microsoft.DirectoryServices.ServicePrincipal","objectType":"ServicePrincipal","objectId":"9b5018d4-6951-42ed-8a92-f11ec283ccec","deletionTimestamp":null,"accountEnabled":true,"appDisplayName":"CloudSense","appId":"a0448380-c346-4f9f-b897-c18733de9394","appOwnerTenantId":"62e173e9-301e-423e-bcd4-29121ec1aa24","appRoleAssignmentRequired":false,"appRoles":[],"displayName":"CloudSense","errorUrl":null,"homepage":"http://www.vipswapper.com/cloudsense","keyCredentials":[],"logoutUrl":null,"oauth2Permissions":[{"adminConsentDescription":"Allow the application to access CloudSense on behalf of the signed-in user.","adminConsentDisplayName":"Access CloudSense","id":"b7b7338e-683a-4796-b95e-60c10380de1c","isEnabled":true,"type":"User","userConsentDescription":"Allow the application to access CloudSense on your behalf.","userConsentDisplayName":"Access CloudSense","value":"user_impersonation"}],"passwordCredentials":[],"preferredTokenSigningKeyThumbprint":null,"publisherName":"vipswapper"quot;,"replyUrls":["http://www.vipswapper.com/cloudsense","http://www.vipswapper.com","http://vipswapper.com","http://vipswapper.azurewebsites.net","http://localhost:62080"],"samlMetadataUrl":null,"servicePrincipalNames":["http://www.vipswapper.com/cloudsense","a0448380-c346-4f9f-b897-c18733de9394"],"tags":["WindowsAzureActiveDirectoryIntegratedApp"]}]}

### <a name="get-azure-rbac-role-identifier"></a><span data-ttu-id="dfb61-252">Obtención del identificador del rol RBAC de Azure</span><span class="sxs-lookup"><span data-stu-id="dfb61-252">Get Azure RBAC role identifier</span></span>
<span data-ttu-id="dfb61-253">Para asignar el rol RBAC adecuado a la entidad de servicio, debe determinar el identificador del rol RBAC de Azure.</span><span class="sxs-lookup"><span data-stu-id="dfb61-253">To assign the appropriate RBAC role to your service principal, you must determine the identifier of the Azure RBAC role.</span></span>

<span data-ttu-id="dfb61-254">El rol RBAC correcta para su aplicación:</span><span class="sxs-lookup"><span data-stu-id="dfb61-254">The right RBAC role for your application:</span></span>

* <span data-ttu-id="dfb61-255">Si la aplicación solo supervisa la suscripción, sin realizar cambio alguno, solo necesita permisos de lector en la suscripción.</span><span class="sxs-lookup"><span data-stu-id="dfb61-255">If your application only monitors the subscription, without making any changes, it requires only reader permissions on the subscription.</span></span> <span data-ttu-id="dfb61-256">Asigne el rol **Lector** .</span><span class="sxs-lookup"><span data-stu-id="dfb61-256">Assign the **Reader** role.</span></span>
* <span data-ttu-id="dfb61-257">Si la aplicación administra Azure, la suscripción, la creación, modificación o eliminación de entidades, requiere uno de los permisos de colaborador.</span><span class="sxs-lookup"><span data-stu-id="dfb61-257">If your application manages Azure the subscription, creating/modifying/deleting entities, it requires one of the contributor permissions.</span></span>
  * <span data-ttu-id="dfb61-258">Para administrar un tipo concreto de recurso, asigne los roles de colaborador específicos del recurso (colaborador de máquina virtual, colaborador de red virtual, colaborador de cuenta de almacenamiento, etc.).</span><span class="sxs-lookup"><span data-stu-id="dfb61-258">To manage a particular type of resource, assign the resource-specific contributor roles (Virtual Machine Contributor, Virtual Network Contributor, Storage Account Contributor, etc.)</span></span>
  * <span data-ttu-id="dfb61-259">Para administrar cualquier tipo de recurso, asigne el rol **Colaborador** .</span><span class="sxs-lookup"><span data-stu-id="dfb61-259">To manage any resource type, assign the **Contributor** role.</span></span>

<span data-ttu-id="dfb61-260">La asignación de roles de la aplicación es visible para los usuarios, así que seleccione el mínimo privilegio necesario.</span><span class="sxs-lookup"><span data-stu-id="dfb61-260">The role assignment for your application is visible to users, so select the least-required privilege.</span></span>

<span data-ttu-id="dfb61-261">Llame a la [API de definición de roles de Resource Manager](https://docs.microsoft.com/rest/api/authorization/roledefinitions) para enumerar todos los roles RBAC de Azure y busque e itere en el resultado para buscar la definición de rol que desee por nombre.</span><span class="sxs-lookup"><span data-stu-id="dfb61-261">Call the [Resource Manager role definition API](https://docs.microsoft.com/rest/api/authorization/roledefinitions) to list all Azure RBAC roles and search then iterate over the result to find the desired role definition by name.</span></span>

<span data-ttu-id="dfb61-262">El método [GetRoleId](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L246) de la aplicación de ejemplo ASP.NET MVC implementa esta llamada.</span><span class="sxs-lookup"><span data-stu-id="dfb61-262">The [GetRoleId](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L246) method of the ASP.net MVC sample app implements this call.</span></span>

<span data-ttu-id="dfb61-263">El siguiente ejemplo de solicitud muestra cómo obtener el identificador del rol RBAC de Azure.</span><span class="sxs-lookup"><span data-stu-id="dfb61-263">The following request example shows how to get Azure RBAC role identifier.</span></span> <span data-ttu-id="dfb61-264">09cbd307-aa71-4aca-b346-5f253e6e3ebb es el identificador de la suscripción.</span><span class="sxs-lookup"><span data-stu-id="dfb61-264">09cbd307-aa71-4aca-b346-5f253e6e3ebb is the id of the subscription.</span></span>

    GET https://management.azure.com/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions?api-version=2015-07-01 HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJKV*****fY2lGc5

<span data-ttu-id="dfb61-265">La respuesta está en el formato siguiente:</span><span class="sxs-lookup"><span data-stu-id="dfb61-265">The response is in the following format:</span></span>

    HTTP/1.1 200 OK

    {"value":[{"properties":{"roleName":"API Management Service Contributor","type":"BuiltInRole","description":"Lets you manage API Management services, but not access to them.","scope":"/","permissions":[{"actions":["Microsoft.ApiManagement/Services/*","Microsoft.Authorization/*/read","Microsoft.Resources/subscriptions/resources/read","Microsoft.Resources/subscriptions/resourceGroups/read","Microsoft.Resources/subscriptions/resourceGroups/resources/read","Microsoft.Resources/subscriptions/resourceGroups/deployments/*","Microsoft.Insights/alertRules/*","Microsoft.Support/*"],"notActions":[]}]},"id":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/312a565d-c81f-4fd8-895a-4e21e48d571c","type":"Microsoft.Authorization/roleDefinitions","name":"312a565d-c81f-4fd8-895a-4e21e48d571c"},{"properties":{"roleName":"Application Insights Component Contributor","type":"BuiltInRole","description":"Lets you manage Application Insights components, but not access to them.","scope":"/","permissions":[{"actions":["Microsoft.Insights/components/*","Microsoft.Insights/webtests/*","Microsoft.Authorization/*/read","Microsoft.Resources/subscriptions/resources/read","Microsoft.Resources/subscriptions/resourceGroups/read","Microsoft.Resources/subscriptions/resourceGroups/resources/read","Microsoft.Resources/subscriptions/resourceGroups/deployments/*","Microsoft.Insights/alertRules/*","Microsoft.Support/*"],"notActions":[]}]},"id":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/ae349356-3a1b-4a5e-921d-050484c6347e","type":"Microsoft.Authorization/roleDefinitions","name":"ae349356-3a1b-4a5e-921d-050484c6347e"}]}

<span data-ttu-id="dfb61-266">No es preciso llamar a esta API de forma continua.</span><span class="sxs-lookup"><span data-stu-id="dfb61-266">You do not need to call this API on an ongoing basis.</span></span> <span data-ttu-id="dfb61-267">Una vez que haya determinado el GUID conocido de la definición de rol, puede construir el identificador de la definición de rol como:</span><span class="sxs-lookup"><span data-stu-id="dfb61-267">Once you've determined the well-known GUID of the role definition, you can construct the role definition id as:</span></span>

    /subscriptions/{subscription_id}/providers/Microsoft.Authorization/roleDefinitions/{well-known-role-guid}

<span data-ttu-id="dfb61-268">Estos son los GUID conocidos de los roles integrados que se usan habitualmente:</span><span class="sxs-lookup"><span data-stu-id="dfb61-268">Here are the well-known guids of commonly used built-in roles:</span></span>

| <span data-ttu-id="dfb61-269">Rol</span><span class="sxs-lookup"><span data-stu-id="dfb61-269">Role</span></span> | <span data-ttu-id="dfb61-270">Guid</span><span class="sxs-lookup"><span data-stu-id="dfb61-270">Guid</span></span> |
| --- | --- |
| <span data-ttu-id="dfb61-271">Lector</span><span class="sxs-lookup"><span data-stu-id="dfb61-271">Reader</span></span> |<span data-ttu-id="dfb61-272">acdd72a7-3385-48ef-bd42-f606fba81ae7</span><span class="sxs-lookup"><span data-stu-id="dfb61-272">acdd72a7-3385-48ef-bd42-f606fba81ae7</span></span> |
| <span data-ttu-id="dfb61-273">Colaborador</span><span class="sxs-lookup"><span data-stu-id="dfb61-273">Contributor</span></span> |<span data-ttu-id="dfb61-274">b24988ac-6180-42a0-ab88-20f7382dd24c</span><span class="sxs-lookup"><span data-stu-id="dfb61-274">b24988ac-6180-42a0-ab88-20f7382dd24c</span></span> |
| <span data-ttu-id="dfb61-275">Colaborador de la máquina virtual</span><span class="sxs-lookup"><span data-stu-id="dfb61-275">Virtual Machine Contributor</span></span> |<span data-ttu-id="dfb61-276">d73bb868-a0df-4d4d-bd69-98a00b01fccb</span><span class="sxs-lookup"><span data-stu-id="dfb61-276">d73bb868-a0df-4d4d-bd69-98a00b01fccb</span></span> |
| <span data-ttu-id="dfb61-277">Colaborador de la red virtual</span><span class="sxs-lookup"><span data-stu-id="dfb61-277">Virtual Network Contributor</span></span> |<span data-ttu-id="dfb61-278">b34d265f-36f7-4a0d-a4d4-e158ca92e90f</span><span class="sxs-lookup"><span data-stu-id="dfb61-278">b34d265f-36f7-4a0d-a4d4-e158ca92e90f</span></span> |
| <span data-ttu-id="dfb61-279">Colaborador de la cuenta de almacenamiento</span><span class="sxs-lookup"><span data-stu-id="dfb61-279">Storage Account Contributor</span></span> |<span data-ttu-id="dfb61-280">86e8f5dc-a6e9-4c67-9d15-de283e8eac25</span><span class="sxs-lookup"><span data-stu-id="dfb61-280">86e8f5dc-a6e9-4c67-9d15-de283e8eac25</span></span> |
| <span data-ttu-id="dfb61-281">Colaborador de sitio web</span><span class="sxs-lookup"><span data-stu-id="dfb61-281">Website Contributor</span></span> |<span data-ttu-id="dfb61-282">de139f84-1756-47ae-9be6-808fbbe84772</span><span class="sxs-lookup"><span data-stu-id="dfb61-282">de139f84-1756-47ae-9be6-808fbbe84772</span></span> |
| <span data-ttu-id="dfb61-283">Colaborador de plan web</span><span class="sxs-lookup"><span data-stu-id="dfb61-283">Web Plan Contributor</span></span> |<span data-ttu-id="dfb61-284">2cc479cb-7b4d-49a8-b449-8c00fd0f0a4b</span><span class="sxs-lookup"><span data-stu-id="dfb61-284">2cc479cb-7b4d-49a8-b449-8c00fd0f0a4b</span></span> |
| <span data-ttu-id="dfb61-285">Colaborador de SQL Server</span><span class="sxs-lookup"><span data-stu-id="dfb61-285">SQL Server Contributor</span></span> |<span data-ttu-id="dfb61-286">6d8ee4ec-f05a-4a1d-8b00-a9b17e38b437</span><span class="sxs-lookup"><span data-stu-id="dfb61-286">6d8ee4ec-f05a-4a1d-8b00-a9b17e38b437</span></span> |
| <span data-ttu-id="dfb61-287">Colaborador de SQL DB</span><span class="sxs-lookup"><span data-stu-id="dfb61-287">SQL DB Contributor</span></span> |<span data-ttu-id="dfb61-288">9b7fa17d-e63e-47b0-bb0a-15c516ac86ec</span><span class="sxs-lookup"><span data-stu-id="dfb61-288">9b7fa17d-e63e-47b0-bb0a-15c516ac86ec</span></span> |

### <a name="assign-rbac-role-to-application"></a><span data-ttu-id="dfb61-289">Asignación de un rol RBAC a una aplicación</span><span class="sxs-lookup"><span data-stu-id="dfb61-289">Assign RBAC role to application</span></span>
<span data-ttu-id="dfb61-290">Ya tiene todo lo que necesita para asignar el rol RBAC adecuado a la entidad de servicio mediante la API de [creación de asignación de roles de Resource Manager](https://docs.microsoft.com/rest/api/authorization/roleassignments) .</span><span class="sxs-lookup"><span data-stu-id="dfb61-290">You have everything you need to assign the appropriate RBAC role to your service principal by using the [Resource Manager create role assignment](https://docs.microsoft.com/rest/api/authorization/roleassignments) API.</span></span>

<span data-ttu-id="dfb61-291">El método [GrantRoleToServicePrincipalOnSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L170) de la aplicación de ejemplo ASP.NET MVC implementa esta llamada.</span><span class="sxs-lookup"><span data-stu-id="dfb61-291">The [GrantRoleToServicePrincipalOnSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L170) method of the ASP.net MVC sample app implements this call.</span></span>

<span data-ttu-id="dfb61-292">Un ejemplo de solicitud para asignar el rol RBAC a una aplicación:</span><span class="sxs-lookup"><span data-stu-id="dfb61-292">An example request to assign RBAC role to application:</span></span>

    PUT https://management.azure.com/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/microsoft.authorization/roleassignments/4f87261d-2816-465d-8311-70a27558df4c?api-version=2015-07-01 HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJKV1QiL*****FlwO1mM7Cw6JWtfY2lGc5
    Content-Type: application/json
    Content-Length: 230

    {"properties": {"roleDefinitionId":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/acdd72a7-3385-48ef-bd42-f606fba81ae7","principalId":"c3097b31-7309-4c59-b4e3-770f8406bad2"}}

<span data-ttu-id="dfb61-293">En la solicitud, se utilizan los siguientes valores:</span><span class="sxs-lookup"><span data-stu-id="dfb61-293">In the request, the following values are used:</span></span>

| <span data-ttu-id="dfb61-294">Guid</span><span class="sxs-lookup"><span data-stu-id="dfb61-294">Guid</span></span> | <span data-ttu-id="dfb61-295">Description</span><span class="sxs-lookup"><span data-stu-id="dfb61-295">Description</span></span> |
| --- | --- |
| <span data-ttu-id="dfb61-296">09cbd307-aa71-4aca-b346-5f253e6e3ebb</span><span class="sxs-lookup"><span data-stu-id="dfb61-296">09cbd307-aa71-4aca-b346-5f253e6e3ebb</span></span> |<span data-ttu-id="dfb61-297">el identificador de la suscripción</span><span class="sxs-lookup"><span data-stu-id="dfb61-297">the id of the subscription</span></span> |
| <span data-ttu-id="dfb61-298">c3097b31-7309-4c59-b4e3-770f8406bad2</span><span class="sxs-lookup"><span data-stu-id="dfb61-298">c3097b31-7309-4c59-b4e3-770f8406bad2</span></span> |<span data-ttu-id="dfb61-299">el identificador de objeto de la entidad de servicio de la aplicación</span><span class="sxs-lookup"><span data-stu-id="dfb61-299">the object id of the service principal of the application</span></span> |
| <span data-ttu-id="dfb61-300">acdd72a7-3385-48ef-bd42-f606fba81ae7</span><span class="sxs-lookup"><span data-stu-id="dfb61-300">acdd72a7-3385-48ef-bd42-f606fba81ae7</span></span> |<span data-ttu-id="dfb61-301">el identificador del rol Lector</span><span class="sxs-lookup"><span data-stu-id="dfb61-301">the id of the reader role</span></span> |
| <span data-ttu-id="dfb61-302">4f87261d-2816-465d-8311-70a27558df4c</span><span class="sxs-lookup"><span data-stu-id="dfb61-302">4f87261d-2816-465d-8311-70a27558df4c</span></span> |<span data-ttu-id="dfb61-303">un guid nuevo creado para la nueva asignación de rol</span><span class="sxs-lookup"><span data-stu-id="dfb61-303">a new guid created for the new role assignment</span></span> |

<span data-ttu-id="dfb61-304">La respuesta está en el formato siguiente:</span><span class="sxs-lookup"><span data-stu-id="dfb61-304">The response is in the following format:</span></span>

    HTTP/1.1 201 Created

    {"properties":{"roleDefinitionId":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/acdd72a7-3385-48ef-bd42-f606fba81ae7","principalId":"c3097b31-7309-4c59-b4e3-770f8406bad2","scope":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb"},"id":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleAssignments/4f87261d-2816-465d-8311-70a27558df4c","type":"Microsoft.Authorization/roleAssignments","name":"4f87261d-2816-465d-8311-70a27558df4c"}

### <a name="get-app-only-access-token-for-azure-resource-manager"></a><span data-ttu-id="dfb61-305">Obtención de token de acceso de solo aplicación para Azure Resource Manager</span><span class="sxs-lookup"><span data-stu-id="dfb61-305">Get app-only access token for Azure Resource Manager</span></span>
<span data-ttu-id="dfb61-306">Para validar que la aplicación tenga el acceso deseado en la suscripción, realice una tarea de prueba en la suscripción mediante un token de aplicación.</span><span class="sxs-lookup"><span data-stu-id="dfb61-306">To validate that app has the desired access on the subscription, perform a test task on the subscription using an app-only token.</span></span>

<span data-ttu-id="dfb61-307">Para obtener un token de acceso de solo aplicación, siga las instrucciones de la sección [Obtención de token de acceso de solo aplicación para la API de Azure AD Graph](#app-azure-ad-graph), con un valor diferente para el parámetro del recurso:</span><span class="sxs-lookup"><span data-stu-id="dfb61-307">To get an app-only access token, follow instructions from section [Get app-only access token for Azure AD Graph API](#app-azure-ad-graph), with a different value for the resource parameter:</span></span>

    https://management.core.windows.net/

<span data-ttu-id="dfb61-308">El método [ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) de la aplicación de ejemplo ASP.NET MVC obtiene un token de acceso de solo aplicación para Azure Resource Manager mediante la Biblioteca de autenticación de Active Directory para .NET.</span><span class="sxs-lookup"><span data-stu-id="dfb61-308">The [ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) method of the ASP.NET MVC sample application gets an app-only access token for Azure Resource Manager using the Active Directory Authentication Library for .net.</span></span>

#### <a name="get-applications-permissions-on-subscription"></a><span data-ttu-id="dfb61-309">Obtención de permisos de la aplicación en la suscripción</span><span class="sxs-lookup"><span data-stu-id="dfb61-309">Get Application's Permissions on Subscription</span></span>
<span data-ttu-id="dfb61-310">Para comprobar que la aplicación tenga el acceso deseado en una suscripción de Azure, puede llamar también a la API de [permisos de Resource Manager](https://docs.microsoft.com/rest/api/authorization/permissions) .</span><span class="sxs-lookup"><span data-stu-id="dfb61-310">To check that your application has the desired access on an Azure subscription, you may also call the [Resource Manager Permissions](https://docs.microsoft.com/rest/api/authorization/permissions) API.</span></span> <span data-ttu-id="dfb61-311">Este enfoque es similar al modo en que se determina si el usuario tiene derechos de administración de acceso en la suscripción.</span><span class="sxs-lookup"><span data-stu-id="dfb61-311">This approach is similar to how you determined whether the user has Access Management rights for the subscription.</span></span> <span data-ttu-id="dfb61-312">Sin embargo, esta vez, llame a la API de permisos con el token de acceso de solo aplicación que recibió en el paso anterior.</span><span class="sxs-lookup"><span data-stu-id="dfb61-312">However, this time, call the permissions API with the app-only access token that you received in the previous step.</span></span>

<span data-ttu-id="dfb61-313">El método [ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) de la aplicación de ejemplo ASP.NET MVC implementa esta llamada.</span><span class="sxs-lookup"><span data-stu-id="dfb61-313">The [ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) method of the ASP.NET MVC sample app implements this call.</span></span>

## <a name="manage-connected-subscriptions"></a><span data-ttu-id="dfb61-314">Administración de suscripciones conectadas</span><span class="sxs-lookup"><span data-stu-id="dfb61-314">Manage connected subscriptions</span></span>
<span data-ttu-id="dfb61-315">Cuando se asigna el rol RBAC adecuado a la entidad de servicio de la aplicación de la suscripción, la aplicación puede seguir supervisándola o administrándola mediante tokens de acceso de solo aplicación para Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="dfb61-315">When the appropriate RBAC role is assigned to your application's service principal on the subscription, your application can keep monitoring/managing it using app-only access tokens for Azure Resource Manager.</span></span>

<span data-ttu-id="dfb61-316">Si el propietario de la suscripción quita la asignación de rol de la aplicación mediante el Portal clásico o las herramientas de la línea de comandos, la aplicación ya no puede acceder a dicha suscripción.</span><span class="sxs-lookup"><span data-stu-id="dfb61-316">If a subscription owner removes your application's role assignment using the classic portal or command-line tools, your application is no longer able to access that subscription.</span></span> <span data-ttu-id="dfb61-317">En ese caso, debe notificar al usuario que se ha roto la conexión con la suscripción desde fuera de la aplicación y darle la opción de "reparar" la conexión.</span><span class="sxs-lookup"><span data-stu-id="dfb61-317">In that case, you should notify the user that the connection with the subscription was severed from outside the application and give them an option to "repair" the connection.</span></span> <span data-ttu-id="dfb61-318">La "reparación" simplemente volvería a crear la asignación de roles que se eliminó sin conexión.</span><span class="sxs-lookup"><span data-stu-id="dfb61-318">"Repair" would simply re-create the role assignment that was deleted offline.</span></span>

<span data-ttu-id="dfb61-319">Igual que permitió que el usuario conectara sus suscripciones a la aplicación, también debe permitirle que las desconecte.</span><span class="sxs-lookup"><span data-stu-id="dfb61-319">Just as you enabled the user to connect subscriptions to your application, you must allow the user to disconnect subscriptions too.</span></span> <span data-ttu-id="dfb61-320">Desde el punto de vista de la administración de acceso, desconectar significa quitar la asignación de roles que la entidad de servicio de la aplicación tiene en la suscripción.</span><span class="sxs-lookup"><span data-stu-id="dfb61-320">From an access management point of view, disconnect means removing the role assignment that the application's service principal has on the subscription.</span></span> <span data-ttu-id="dfb61-321">Opcionalmente, también se pueden quitar todos los estados de la aplicación para la suscripción.</span><span class="sxs-lookup"><span data-stu-id="dfb61-321">Optionally, any state in the application for the subscription might be removed too.</span></span>
<span data-ttu-id="dfb61-322">Solo los usuarios con permiso de administración de acceso en la suscripción pueden desconectar la suscripción.</span><span class="sxs-lookup"><span data-stu-id="dfb61-322">Only users with access management permission on the subscription are able to disconnect the subscription.</span></span>

<span data-ttu-id="dfb61-323">El método [RevokeRoleFromServicePrincipalOnSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L200) de la aplicación de ejemplo ASP.NET MVC implementa esta llamada.</span><span class="sxs-lookup"><span data-stu-id="dfb61-323">The [RevokeRoleFromServicePrincipalOnSubscription method](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L200) of the ASP.net MVC sample app implements this call.</span></span>

<span data-ttu-id="dfb61-324">Eso es todo: los usuarios ya pueden conectarse y administrar fácilmente sus suscripciones de Azure con su aplicación.</span><span class="sxs-lookup"><span data-stu-id="dfb61-324">That's it - users can now easily connect and manage their Azure subscriptions with your application.</span></span>
