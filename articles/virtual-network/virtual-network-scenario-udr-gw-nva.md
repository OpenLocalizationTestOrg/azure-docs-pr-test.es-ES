---
title: "conexión aaaHybrid con aplicación de capa 2 | Documentos de Microsoft"
description: "Obtenga información acerca de cómo toodeploy aparatos virtuales y UDR toocreate un entorno de aplicación de varios niveles en Azure"
services: virtual-network
documentationcenter: na
author: jimdial
manager: carmonm
editor: tysonn
ms.assetid: 1f509bec-bdd1-470d-8aa4-3cf2bb7f6134
ms.service: virtual-network
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 05/05/2016
ms.author: jdial
ms.openlocfilehash: 53599862289dbf9c6ab3289b0cb8dda6430f20f7
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 10/06/2017
---
# <a name="virtual-appliance-scenario"></a><span data-ttu-id="3a6c4-103">Escenario de aplicación virtual</span><span class="sxs-lookup"><span data-stu-id="3a6c4-103">Virtual appliance scenario</span></span>
<span data-ttu-id="3a6c4-104">Un escenario común entre mayor al cliente de Azure es Hola necesidad tooprovide una toohello de aplicación de dos niveles expuesto Internet, permitiendo toohello back-nivel de acceso de un centro de datos local.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-104">A common scenario among larger Azure customer is hello need tooprovide a two-tiered application exposed toohello Internet, while allowing access toohello back tier from an on-premises datacenter.</span></span> <span data-ttu-id="3a6c4-105">Este documento le guiará a través de un escenario de usuario define las rutas (UDR), una puerta de enlace VPN y toodeploy de dispositivos virtuales de red un entorno de dos niveles que cumpla Hola según los requisitos:</span><span class="sxs-lookup"><span data-stu-id="3a6c4-105">This document will walk you through a scenario using User Defined Routes (UDR), a VPN Gateway, and network virtual appliances toodeploy a two-tier environment that meets hello following requirements:</span></span>

* <span data-ttu-id="3a6c4-106">Aplicación Web debe ser accesible desde Hola sólo Internet pública.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-106">Web application must be accessible from hello public Internet only.</span></span>
* <span data-ttu-id="3a6c4-107">Aplicación Hola hospedaje del servidor Web debe ser capaz de tooaccess un servidor de aplicaciones back-end.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-107">Web server hosting hello application must be able tooaccess a backend application server.</span></span>
* <span data-ttu-id="3a6c4-108">Todo el tráfico de la aplicación web de Internet toohello Hola debe pasar por un dispositivo virtual de firewall.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-108">All traffic from hello Internet toohello web application must go through a firewall virtual appliance.</span></span> <span data-ttu-id="3a6c4-109">Esta aplicación virtual se usará solo para el tráfico de Internet.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-109">This virtual appliance will be used for Internet traffic only.</span></span>
* <span data-ttu-id="3a6c4-110">Todo el tráfico encaminado toohello servidor de aplicaciones debe pasar por un dispositivo virtual de firewall.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-110">All traffic going toohello application server must go through a firewall virtual appliance.</span></span> <span data-ttu-id="3a6c4-111">Este dispositivo virtual se usará para el servidor de acceso toohello back-end end y proceden de la red local de Hola a través de una puerta de enlace de VPN de acceso.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-111">This virtual appliance will be used for access toohello backend end server, and access coming in from hello on-premises network via a VPN Gateway.</span></span>
* <span data-ttu-id="3a6c4-112">Los administradores deben ser capaz de toomanage Hola firewall los accesorios virtuales desde sus equipos locales, mediante el uso de un tercer firewall dispositivo virtual que se usa exclusivamente para fines de administración.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-112">Administrators must be able toomanage hello firewall virtual appliances from their on-premises computers, by using a third firewall virtual appliance used exclusively for management purposes.</span></span>

<span data-ttu-id="3a6c4-113">Este es un escenario de red perimetral estándar con una red perimetral y una red protegida.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-113">This is a standard DMZ scenario with a DMZ and a protected network.</span></span> <span data-ttu-id="3a6c4-114">Dicho escenario se puede construir en Azure con NSG, aplicaciones virtuales de firewall o una combinación de ambos elementos.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-114">Such scenario can be constructed in Azure by using NSGs, firewall virtual appliances, or a combination of both.</span></span> <span data-ttu-id="3a6c4-115">tabla de Hello siguiente muestra algunas de hello pros y los contras entre los NSG y aparatos virtuales de firewall.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-115">hello table below shows some of hello pros and cons between NSGs and firewall virtual appliances.</span></span>

|  | <span data-ttu-id="3a6c4-116">Ventajas</span><span class="sxs-lookup"><span data-stu-id="3a6c4-116">Pros</span></span> | <span data-ttu-id="3a6c4-117">Desventajas</span><span class="sxs-lookup"><span data-stu-id="3a6c4-117">Cons</span></span> |
| --- | --- | --- |
| <span data-ttu-id="3a6c4-118">Grupo de seguridad de red</span><span class="sxs-lookup"><span data-stu-id="3a6c4-118">NSG</span></span> |<span data-ttu-id="3a6c4-119">No tienen costo.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-119">No cost.</span></span> <br/><span data-ttu-id="3a6c4-120">Están integrados en Azure RBAC.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-120">Integrated into Azure RBAC.</span></span> <br/><span data-ttu-id="3a6c4-121">Las reglas se pueden crear en plantillas ARM.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-121">Rules can be created in ARM templates.</span></span> |<span data-ttu-id="3a6c4-122">La complejidad podría variar en entornos de mayor tamaño.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-122">Complexity could vary in larger environments.</span></span> |
| <span data-ttu-id="3a6c4-123">Firewall</span><span class="sxs-lookup"><span data-stu-id="3a6c4-123">Firewall</span></span> |<span data-ttu-id="3a6c4-124">Control total sobre el plano de datos.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-124">Full control over data plane.</span></span> <br/><span data-ttu-id="3a6c4-125">Administración central a través de la consola de firewall.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-125">Central management through firewall console.</span></span> |<span data-ttu-id="3a6c4-126">El costo de la aplicación de firewall.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-126">Cost of firewall appliance.</span></span> <br/><span data-ttu-id="3a6c4-127">No está integrado con Azure RBAC.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-127">Not integrated with Azure RBAC.</span></span> |

<span data-ttu-id="3a6c4-128">solución de Hello siguiente utiliza firewall aparatos virtuales tooimplement un escenario de red DMZ/protegido.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-128">hello solution below uses firewall virtual appliances tooimplement a DMZ/protected network scenario.</span></span>

## <a name="considerations"></a><span data-ttu-id="3a6c4-129">Consideraciones</span><span class="sxs-lookup"><span data-stu-id="3a6c4-129">Considerations</span></span>
<span data-ttu-id="3a6c4-130">Puede implementar el entorno Hola explicado con anterioridad en Azure con diferentes características disponibles hoy en día, como se indica a continuación.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-130">You can deploy hello environment explained above in Azure using different features available today, as follows.</span></span>

* <span data-ttu-id="3a6c4-131">**Red virtual**.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-131">**Virtual network (VNet)**.</span></span> <span data-ttu-id="3a6c4-132">Una red virtual de Azure actúa en red de local de tooan de forma similar y se puede dividir en uno o más aislamiento del tráfico de subredes tooprovide y separación de intereses.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-132">An Azure VNet acts in similar fashion tooan on-premises network, and can be segmented into one or more subnets tooprovide traffic isolation, and separation of concerns.</span></span>
* <span data-ttu-id="3a6c4-133">**Aplicación virtual**.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-133">**Virtual appliance**.</span></span> <span data-ttu-id="3a6c4-134">Varios socios proporcionan dispositivos virtuales en hello Azure Marketplace que puede usarse para los tres firewalls Hola que se ha descrito anteriormente.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-134">Several partners provide virtual appliances in hello Azure Marketplace that can be used for hello three firewalls described above.</span></span> 
* <span data-ttu-id="3a6c4-135">**Rutas definidas por el usuario (UDR)**.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-135">**User Defined Routes (UDR)**.</span></span> <span data-ttu-id="3a6c4-136">Tablas de rutas pueden contener UDRs usa Azure red toocontrol Hola el flujo de paquetes dentro de una red virtual.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-136">Route tables can contain UDRs used by Azure networking toocontrol hello flow of packets within a VNet.</span></span> <span data-ttu-id="3a6c4-137">Estas tablas de rutas pueden ser toosubnets aplicada.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-137">These route tables can be applied toosubnets.</span></span> <span data-ttu-id="3a6c4-138">Una de las características más recientes de hello en Azure es Hola capacidad tooapply un toohello de tabla de ruta GatewaySubnet, proporcionando Hola capacidad tooforward todo el tráfico que entran en hello red virtual de Azure desde un dispositivo virtual de la tooa de conexión híbrida.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-138">One of hello newest features in Azure is hello ability tooapply a route table toohello GatewaySubnet, providing hello ability tooforward all traffic coming into hello Azure VNet from a hybrid connection tooa virtual appliance.</span></span>
* <span data-ttu-id="3a6c4-139">**Reenvío IP**.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-139">**IP Forwarding**.</span></span> <span data-ttu-id="3a6c4-140">De forma predeterminada, hello Azure motor red reenviarán los paquetes toovirtual tarjetas de interfaz de red (NIC) solo si dirección IP de destino de paquetes de saludo coincide con direcciones IP de NIC de Hola.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-140">By default, hello Azure networking engine forward packets toovirtual network interface cards (NICs) only if hello packet destination IP address matches hello NIC IP address.</span></span> <span data-ttu-id="3a6c4-141">Por lo tanto, si un UDR define que se debe enviar un paquete tooa dado el dispositivo virtual, hello Azure motor red entraban ese paquete.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-141">Therefore, if a UDR defines that a packet must be sent tooa given virtual appliance, hello Azure networking engine would drop that packet.</span></span> <span data-ttu-id="3a6c4-142">paquete de saludo tooensure se entrega tooa máquina virtual (en este caso, un dispositivo virtual) que no sea el destino real de hello para el paquete de saludo, deberá tooenable el reenvío IP para dispositivo virtual Hola.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-142">tooensure hello packet is delivered tooa VM (in this case a virtual appliance) that is not hello actual destination for hello packet, you need tooenable IP Forwarding for hello virtual appliance.</span></span>
* <span data-ttu-id="3a6c4-143">**Grupos de seguridad de red (NSG)**.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-143">**Network Security Groups (NSGs)**.</span></span> <span data-ttu-id="3a6c4-144">ejemplo de Hola siguiente no sirven de los NSG, pero puede usar NSG aplicados toohello subredes o NIC en esta solución toofurther filtro Hola tráfico dentro y fuera de esas subredes y la NIC.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-144">hello example below does not make use of NSGs, but you could use NSGs applied toohello subnets and/or NICs in this solution toofurther filter hello traffic in and out of those subnets and NICs.</span></span>

![Conectividad de IPv6](./media/virtual-network-scenario-udr-gw-nva/figure01.png)

<span data-ttu-id="3a6c4-146">En este ejemplo hay una suscripción que contiene Hola siguiente:</span><span class="sxs-lookup"><span data-stu-id="3a6c4-146">In this example there is a subscription that contains hello following:</span></span>

* <span data-ttu-id="3a6c4-147">2 grupos de recursos, que no se muestra en el diagrama de Hola.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-147">2 resource groups, not shown in hello diagram.</span></span> 
  * <span data-ttu-id="3a6c4-148">**ONPREMRG**.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-148">**ONPREMRG**.</span></span> <span data-ttu-id="3a6c4-149">Contiene todos los recursos toosimulate es necesario una red local.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-149">Contains all resources necessary toosimulate an on-premises network.</span></span>
  * <span data-ttu-id="3a6c4-150">**AZURERG**.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-150">**AZURERG**.</span></span> <span data-ttu-id="3a6c4-151">Contiene todos los recursos necesarios para el entorno de red virtual de Azure Hola.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-151">Contains all resources necessary for hello Azure virtual network environment.</span></span> 
* <span data-ttu-id="3a6c4-152">Una red virtual denominada **onpremvnet** utiliza toomimic segmentada de un centro de datos local como se muestra a continuación.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-152">A VNet named **onpremvnet** used toomimic an on-premises datacenter segmented as listed below.</span></span>
  * <span data-ttu-id="3a6c4-153">**onpremsn1**.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-153">**onpremsn1**.</span></span> <span data-ttu-id="3a6c4-154">Subred que contiene una máquina virtual (VM) que se ejecutan Ubuntu toomimic un servidor local.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-154">Subnet containing a virtual machine (VM) running Ubuntu toomimic an on-premises server.</span></span>
  * <span data-ttu-id="3a6c4-155">**onpremsn2**.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-155">**onpremsn2**.</span></span> <span data-ttu-id="3a6c4-156">Subred que contiene una máquina virtual con Ubuntu toomimic en un equipo local utilizado por un administrador.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-156">Subnet containing a VM running Ubuntu toomimic an on-premises computer used by an administrator.</span></span>
* <span data-ttu-id="3a6c4-157">Hay un dispositivo virtual de firewall denominado **OPFW** en **onpremvnet** utiliza toomaintain un túnel demasiado**azurevnet**.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-157">There is one firewall virtual appliance named **OPFW** on **onpremvnet** used toomaintain a tunnel too**azurevnet**.</span></span>
* <span data-ttu-id="3a6c4-158">Una red virtual llamada **azurevnet** segmentada como se muestra a continuación.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-158">A VNet named **azurevnet** segmented as listed below.</span></span>
  * <span data-ttu-id="3a6c4-159">**azsn1**.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-159">**azsn1**.</span></span> <span data-ttu-id="3a6c4-160">Subred de firewall externo utilizada exclusivamente para el servidor de seguridad externo Hola.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-160">External firewall subnet used exclusively for hello external firewall.</span></span> <span data-ttu-id="3a6c4-161">Todo el tráfico de Internet entrará a través de esta subred.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-161">All Internet traffic will come in through this subnet.</span></span> <span data-ttu-id="3a6c4-162">Esta subred solo contiene un servidor de seguridad NIC vinculado toohello externo.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-162">This subnet only contains a NIC linked toohello external firewall.</span></span>
  * <span data-ttu-id="3a6c4-163">**azsn2**.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-163">**azsn2**.</span></span> <span data-ttu-id="3a6c4-164">Subred de front-end que hospede una máquina virtual que se ejecuta como un servidor web que se obtendrá acceso desde Internet Hola.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-164">Front end subnet hosting a VM running as a web server that will be accessed from hello Internet.</span></span>
  * <span data-ttu-id="3a6c4-165">**azsn3**.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-165">**azsn3**.</span></span> <span data-ttu-id="3a6c4-166">Subred de back-end que hospede una máquina virtual con un servidor de aplicaciones back-end que tendrán acceso al servidor de hello front-end web.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-166">Backend subnet hosting a VM running a backend application server that will be accessed by hello front end web server.</span></span>
  * <span data-ttu-id="3a6c4-167">**azsn4**.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-167">**azsn4**.</span></span> <span data-ttu-id="3a6c4-168">Subred de administración utiliza exclusivamente tooprovide administración acceso tooall firewall aparatos virtuales.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-168">Management subnet used exclusively tooprovide management access tooall firewall virtual appliances.</span></span> <span data-ttu-id="3a6c4-169">Esta subred contiene sólo una NIC para cada dispositivo virtual firewall utilizado en la solución de Hola.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-169">This subnet only contains a NIC for each firewall virtual appliance used in hello solution.</span></span>
  * <span data-ttu-id="3a6c4-170">**GatewaySubnet**.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-170">**GatewaySubnet**.</span></span> <span data-ttu-id="3a6c4-171">Subred de conexión híbrida de Azure requerida para la conectividad de tooprovide ExpressRoute y puerta de enlace VPN entre redes virtuales de Azure y otras redes.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-171">Azure hybrid connection subnet required for ExpressRoute and VPN Gateway tooprovide connectivity between Azure VNets and other networks.</span></span> 
* <span data-ttu-id="3a6c4-172">Hay 3 aparatos virtuales firewall Hola **azurevnet** red.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-172">There are 3 firewall virtual appliances in hello **azurevnet** network.</span></span> 
  * <span data-ttu-id="3a6c4-173">**AZF1**.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-173">**AZF1**.</span></span> <span data-ttu-id="3a6c4-174">Firewall externo expuesta toohello Internet pública mediante el uso de un recurso de dirección IP público de Azure.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-174">External firewall exposed toohello public Internet by using a public IP address resource in Azure.</span></span> <span data-ttu-id="3a6c4-175">Necesita tooensure tiene una plantilla desde Hola Marketplace, o directamente desde el fabricante del dispositivo, que aprovisiona un dispositivo virtual 3 NIC.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-175">You need tooensure you have a template from hello Marketplace, or directly from your appliance vendor, that provisions a 3-NIC virtual appliance.</span></span>
  * <span data-ttu-id="3a6c4-176">**AZF2**.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-176">**AZF2**.</span></span> <span data-ttu-id="3a6c4-177">Firewall interno usa toocontrol tráfico entre **azsn2** y **azsn3**.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-177">Internal firewall used toocontrol traffic between **azsn2** and **azsn3**.</span></span> <span data-ttu-id="3a6c4-178">También es una aplicación virtual de 3 NIC.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-178">This is also a 3-NIC virtual appliance.</span></span>
  * <span data-ttu-id="3a6c4-179">**AZF3**.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-179">**AZF3**.</span></span> <span data-ttu-id="3a6c4-180">Tooadministrators accesible de firewall de administración de hello centro de datos local y conectado tooa administración subred usa toomanage todos los dispositivos de firewall.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-180">Management firewall accessible tooadministrators from hello on-premises datacenter, and connected tooa management subnet used toomanage all firewall appliances.</span></span> <span data-ttu-id="3a6c4-181">Puede buscar plantillas de dispositivo virtual de 2 NIC en hello Marketplace o solicitarlo directamente desde el proveedor del dispositivo.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-181">You can find 2-NIC virtual appliance templates in hello Marketplace, or request one directly from your appliance vendor.</span></span>

## <a name="user-defined-routing-udr"></a><span data-ttu-id="3a6c4-182">Enrutamiento definido por el usuario (UDR)</span><span class="sxs-lookup"><span data-stu-id="3a6c4-182">User Defined Routing (UDR)</span></span>
<span data-ttu-id="3a6c4-183">Cada subred de Azure puede ser vinculado tooa UDR tabla utilizada toodefine cómo se enruta el tráfico iniciado en esa subred.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-183">Each subnet in Azure can be linked tooa UDR table used toodefine how traffic initiated in that subnet is routed.</span></span> <span data-ttu-id="3a6c4-184">Si no se han definido ningún UDRs, Azure usa de forma predeterminada las rutas tooallow tráfico tooflow de tooanother de una subred.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-184">If no UDRs are defined, Azure uses default routes tooallow traffic tooflow from one subnet tooanother.</span></span> <span data-ttu-id="3a6c4-185">toobetter comprender UDRs, visite [¿qué son rutas definidas por el usuario y el reenvío IP](virtual-networks-udr-overview.md#ip-forwarding).</span><span class="sxs-lookup"><span data-stu-id="3a6c4-185">toobetter understand UDRs, visit [What are User Defined Routes and IP Forwarding](virtual-networks-udr-overview.md#ip-forwarding).</span></span>

<span data-ttu-id="3a6c4-186">tooensure comunicación se realiza a través de dispositivo de firewall derecho hello, basado en hello último requisito anterior, necesita toocreate Hola siguiente que contiene UDRs en una tabla de rutas **azurevnet**.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-186">tooensure communication is done through hello right firewall appliance, based on hello last requirement above, you need toocreate hello following route table containing UDRs in **azurevnet**.</span></span>

### <a name="azgwudr"></a><span data-ttu-id="3a6c4-187">azgwudr</span><span class="sxs-lookup"><span data-stu-id="3a6c4-187">azgwudr</span></span>
<span data-ttu-id="3a6c4-188">En este escenario, Hola solo tráfico que fluye desde tooAzure local se usa toomanage Hola firewalls conectándose demasiado**AZF3**, y que el tráfico debe pasar a través del firewall interno de hello, **AZF2**.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-188">In this scenario, hello only traffic flowing from on-premises tooAzure will be used toomanage hello firewalls by connecting too**AZF3**, and that traffic must go through hello internal firewall, **AZF2**.</span></span> <span data-ttu-id="3a6c4-189">Por lo tanto, es necesaria en hello solo una ruta **GatewaySubnet** tal y como se muestra a continuación.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-189">Therefore, only one route is necessary in hello **GatewaySubnet** as shown below.</span></span>

| <span data-ttu-id="3a6c4-190">Destino</span><span class="sxs-lookup"><span data-stu-id="3a6c4-190">Destination</span></span> | <span data-ttu-id="3a6c4-191">Próximo salto</span><span class="sxs-lookup"><span data-stu-id="3a6c4-191">Next hop</span></span> | <span data-ttu-id="3a6c4-192">Explicación</span><span class="sxs-lookup"><span data-stu-id="3a6c4-192">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="3a6c4-193">10.0.4.0/24</span><span class="sxs-lookup"><span data-stu-id="3a6c4-193">10.0.4.0/24</span></span> |<span data-ttu-id="3a6c4-194">10.0.3.11</span><span class="sxs-lookup"><span data-stu-id="3a6c4-194">10.0.3.11</span></span> |<span data-ttu-id="3a6c4-195">Permite a firewall de administración de tooreach de tráfico local **AZF3**</span><span class="sxs-lookup"><span data-stu-id="3a6c4-195">Allows on-premises traffic tooreach management firewall **AZF3**</span></span> |

### <a name="azsn2udr"></a><span data-ttu-id="3a6c4-196">azsn2udr</span><span class="sxs-lookup"><span data-stu-id="3a6c4-196">azsn2udr</span></span>
| <span data-ttu-id="3a6c4-197">Destino</span><span class="sxs-lookup"><span data-stu-id="3a6c4-197">Destination</span></span> | <span data-ttu-id="3a6c4-198">Próximo salto</span><span class="sxs-lookup"><span data-stu-id="3a6c4-198">Next hop</span></span> | <span data-ttu-id="3a6c4-199">Explicación</span><span class="sxs-lookup"><span data-stu-id="3a6c4-199">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="3a6c4-200">10.0.3.0/24</span><span class="sxs-lookup"><span data-stu-id="3a6c4-200">10.0.3.0/24</span></span> |<span data-ttu-id="3a6c4-201">10.0.2.11</span><span class="sxs-lookup"><span data-stu-id="3a6c4-201">10.0.2.11</span></span> |<span data-ttu-id="3a6c4-202">Permite la subred back-end de tráfico toohello de hospedaje de servidor de aplicación Hola a través de **AZF2**</span><span class="sxs-lookup"><span data-stu-id="3a6c4-202">Allows traffic toohello backend subnet hosting hello application server through **AZF2**</span></span> |
| <span data-ttu-id="3a6c4-203">0.0.0.0/0</span><span class="sxs-lookup"><span data-stu-id="3a6c4-203">0.0.0.0/0</span></span> |<span data-ttu-id="3a6c4-204">10.0.2.10</span><span class="sxs-lookup"><span data-stu-id="3a6c4-204">10.0.2.10</span></span> |<span data-ttu-id="3a6c4-205">Permite que todos los otro toobe de tráfico que se enrutan a través de **AZF1**</span><span class="sxs-lookup"><span data-stu-id="3a6c4-205">Allows all other traffic toobe routed through **AZF1**</span></span> |

### <a name="azsn3udr"></a><span data-ttu-id="3a6c4-206">azsn3udr</span><span class="sxs-lookup"><span data-stu-id="3a6c4-206">azsn3udr</span></span>
| <span data-ttu-id="3a6c4-207">Destino</span><span class="sxs-lookup"><span data-stu-id="3a6c4-207">Destination</span></span> | <span data-ttu-id="3a6c4-208">Próximo salto</span><span class="sxs-lookup"><span data-stu-id="3a6c4-208">Next hop</span></span> | <span data-ttu-id="3a6c4-209">Explicación</span><span class="sxs-lookup"><span data-stu-id="3a6c4-209">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="3a6c4-210">10.0.2.0/24</span><span class="sxs-lookup"><span data-stu-id="3a6c4-210">10.0.2.0/24</span></span> |<span data-ttu-id="3a6c4-211">10.0.3.10</span><span class="sxs-lookup"><span data-stu-id="3a6c4-211">10.0.3.10</span></span> |<span data-ttu-id="3a6c4-212">Permite el tráfico demasiado**azsn2** tooflow de servidor Web de toohello del servidor de aplicación a través de **AZF2**</span><span class="sxs-lookup"><span data-stu-id="3a6c4-212">Allows traffic too**azsn2** tooflow from app server toohello webserver through **AZF2**</span></span> |

<span data-ttu-id="3a6c4-213">También necesita toocreate tablas de rutas para las subredes de hello en **onpremvnet** toomimic Hola centro de datos local.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-213">You also need toocreate route tables for hello subnets in **onpremvnet** toomimic hello on-premises datacenter.</span></span>

### <a name="onpremsn1udr"></a><span data-ttu-id="3a6c4-214">onpremsn1udr</span><span class="sxs-lookup"><span data-stu-id="3a6c4-214">onpremsn1udr</span></span>
| <span data-ttu-id="3a6c4-215">Destino</span><span class="sxs-lookup"><span data-stu-id="3a6c4-215">Destination</span></span> | <span data-ttu-id="3a6c4-216">Próximo salto</span><span class="sxs-lookup"><span data-stu-id="3a6c4-216">Next hop</span></span> | <span data-ttu-id="3a6c4-217">Explicación</span><span class="sxs-lookup"><span data-stu-id="3a6c4-217">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="3a6c4-218">192.168.2.0/24</span><span class="sxs-lookup"><span data-stu-id="3a6c4-218">192.168.2.0/24</span></span> |<span data-ttu-id="3a6c4-219">192.168.1.4</span><span class="sxs-lookup"><span data-stu-id="3a6c4-219">192.168.1.4</span></span> |<span data-ttu-id="3a6c4-220">Permite el tráfico demasiado**onpremsn2** a través de **OPFW**</span><span class="sxs-lookup"><span data-stu-id="3a6c4-220">Allows traffic too**onpremsn2** through **OPFW**</span></span> |

### <a name="onpremsn2udr"></a><span data-ttu-id="3a6c4-221">onpremsn2udr</span><span class="sxs-lookup"><span data-stu-id="3a6c4-221">onpremsn2udr</span></span>
| <span data-ttu-id="3a6c4-222">Destino</span><span class="sxs-lookup"><span data-stu-id="3a6c4-222">Destination</span></span> | <span data-ttu-id="3a6c4-223">Próximo salto</span><span class="sxs-lookup"><span data-stu-id="3a6c4-223">Next hop</span></span> | <span data-ttu-id="3a6c4-224">Explicación</span><span class="sxs-lookup"><span data-stu-id="3a6c4-224">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="3a6c4-225">10.0.3.0/24</span><span class="sxs-lookup"><span data-stu-id="3a6c4-225">10.0.3.0/24</span></span> |<span data-ttu-id="3a6c4-226">192.168.2.4</span><span class="sxs-lookup"><span data-stu-id="3a6c4-226">192.168.2.4</span></span> |<span data-ttu-id="3a6c4-227">Permite la subred de tráfico toohello de seguridad en Azure a través de **OPFW**</span><span class="sxs-lookup"><span data-stu-id="3a6c4-227">Allows traffic toohello backed subnet in Azure through **OPFW**</span></span> |
| <span data-ttu-id="3a6c4-228">192.168.1.0/24</span><span class="sxs-lookup"><span data-stu-id="3a6c4-228">192.168.1.0/24</span></span> |<span data-ttu-id="3a6c4-229">192.168.2.4</span><span class="sxs-lookup"><span data-stu-id="3a6c4-229">192.168.2.4</span></span> |<span data-ttu-id="3a6c4-230">Permite el tráfico demasiado**onpremsn1** a través de **OPFW**</span><span class="sxs-lookup"><span data-stu-id="3a6c4-230">Allows traffic too**onpremsn1** through **OPFW**</span></span> |

## <a name="ip-forwarding"></a><span data-ttu-id="3a6c4-231">reenvío de IP</span><span class="sxs-lookup"><span data-stu-id="3a6c4-231">IP Forwarding</span></span>
<span data-ttu-id="3a6c4-232">UDR y el reenvío IP son características que puede usar en el flujo del tráfico de toocontrol de combinación tooallow aparatos virtuales toobe utilizado en una red virtual de Azure.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-232">UDR and IP Forwarding are features that you can use in combination tooallow virtual appliances toobe used toocontrol traffic flow in an Azure VNet.</span></span>  <span data-ttu-id="3a6c4-233">Un dispositivo virtual es nada más que una máquina virtual que se ejecuta un aplicación que se usa el tráfico de red toohandle de alguna manera, como un firewall o un dispositivo NAT.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-233">A virtual appliance is nothing more than a VM that runs an application used toohandle network traffic in some way, such as a firewall or a NAT device.</span></span>

<span data-ttu-id="3a6c4-234">Este dispositivo virtual de que VM debe ser capaz de tooreceive el tráfico entrante que está dirigido no tooitself.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-234">This virtual appliance VM must be able tooreceive incoming traffic that is not addressed tooitself.</span></span> <span data-ttu-id="3a6c4-235">tooallow un tráfico de tooreceive VM direccionado tooother destinos, debe habilitar el reenvío IP para hello máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-235">tooallow a VM tooreceive traffic addressed tooother destinations, you must enable IP Forwarding for hello VM.</span></span> <span data-ttu-id="3a6c4-236">Se trata de una configuración, no es una configuración de sistema operativo de Hola de Azure.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-236">This is an Azure setting, not a setting in hello guest operating system.</span></span> <span data-ttu-id="3a6c4-237">Su toorun necesidades todavía del dispositivo virtual cierta de tipo de aplicación toohandle Hola el tráfico entrante y enrutar de forma adecuada.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-237">Your virtual appliance still needs toorun some type of application toohandle hello incoming traffic, and route it appropriately.</span></span>

<span data-ttu-id="3a6c4-238">toolearn más información sobre el reenvío IP, visite [¿qué son rutas definidas por el usuario y el reenvío IP](virtual-networks-udr-overview.md#ip-forwarding).</span><span class="sxs-lookup"><span data-stu-id="3a6c4-238">toolearn more about IP Forwarding, visit [What are User Defined Routes and IP Forwarding](virtual-networks-udr-overview.md#ip-forwarding).</span></span>

<span data-ttu-id="3a6c4-239">Por ejemplo, imagine que tiene Hola después de la instalación en una red virtual de Azure:</span><span class="sxs-lookup"><span data-stu-id="3a6c4-239">As an example, imagine you have hello following setup in an Azure vnet:</span></span>

* <span data-ttu-id="3a6c4-240">La subred **onpremsn1** contiene una máquina virtual llamada **onpremvm1**.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-240">Subnet **onpremsn1** contains a VM named **onpremvm1**.</span></span>
* <span data-ttu-id="3a6c4-241">La subred **onpremsn2** contiene una máquina virtual llamada **onpremvm2**.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-241">Subnet **onpremsn2** contains a VM named **onpremvm2**.</span></span>
* <span data-ttu-id="3a6c4-242">Un dispositivo virtual denominado **OPFW** está conectado demasiado**onpremsn1** y **onpremsn2**.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-242">A virtual appliance named **OPFW** is connected too**onpremsn1** and **onpremsn2**.</span></span>
* <span data-ttu-id="3a6c4-243">Una ruta definida por el usuario vinculado demasiado**onpremsn1** especifica que todo el tráfico demasiado**onpremsn2** deben enviarse demasiado**OPFW**.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-243">A user defined route linked too**onpremsn1** specifies that all traffic too**onpremsn2** must be sent too**OPFW**.</span></span>

<span data-ttu-id="3a6c4-244">En este punto, si **onpremvm1** intenta tooestablish una conexión con **onpremvm2**, hello UDR se usará y el tráfico se enviará demasiado**OPFW** salto siguiente Hola.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-244">At this point, if **onpremvm1** tries tooestablish a connection with **onpremvm2**, hello UDR will be used and traffic will be sent too**OPFW** as hello next hop.</span></span> <span data-ttu-id="3a6c4-245">Tenga en cuenta que Hola destino paquete real no se está cambiando, sigue indicando **onpremvm2** constituye el destino de Hola.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-245">Keep in mind that hello actual packet destination is not being changed, it still says **onpremvm2** is hello destination.</span></span> 

<span data-ttu-id="3a6c4-246">Sin habilitado para el reenvío de IP **OPFW**, hello Azure lógica de red virtual quitará los paquetes de saludo, ya que sólo permite paquetes toobe envía tooa VM si hello dirección IP de la máquina virtual es el destino de hello para el paquete de saludo.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-246">Without IP Forwarding enabled for **OPFW**, hello Azure virtual networking logic will drop hello packets, since it only allows packets toobe sent tooa VM if hello VM’s IP address is hello destination for hello packet.</span></span>

<span data-ttu-id="3a6c4-247">Con el reenvío IP, Hola lógica de la red virtual de Azure reenviará tooOPFW de paquetes de saludo, sin cambiar su dirección de destino original.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-247">With IP Forwarding, hello Azure virtual network logic will forward hello packets tooOPFW, without changing its original destination address.</span></span> <span data-ttu-id="3a6c4-248">**OPFW** debe controlar los paquetes de saludo y determinar qué toodo con ellos.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-248">**OPFW** must handle hello packets and determine what toodo with them.</span></span>

<span data-ttu-id="3a6c4-249">Para el escenario de hello anteriormente toowork, debe habilitar el reenvío IP en hello NIC para **OPFW**, **AZF1**, **AZF2**, y **AZF3** que se utilizan para enrutamiento (todas las NIC excepto hello las toohello vinculado administración subred).</span><span class="sxs-lookup"><span data-stu-id="3a6c4-249">For hello scenario above toowork, you must enable IP Forwarding on hello NICs for **OPFW**, **AZF1**, **AZF2**, and **AZF3** that are used for routing (all NICs except hello ones linked toohello management subnet).</span></span> 

## <a name="firewall-rules"></a><span data-ttu-id="3a6c4-250">Reglas de firewall</span><span class="sxs-lookup"><span data-stu-id="3a6c4-250">Firewall Rules</span></span>
<span data-ttu-id="3a6c4-251">Como se describió anteriormente, solo el reenvío IP garantiza los paquetes se envían aparatos virtuales toohello.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-251">As described above, IP Forwarding only ensures packets are sent toohello virtual appliances.</span></span> <span data-ttu-id="3a6c4-252">El dispositivo sigue necesitando toodecide qué toodo con esos paquetes.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-252">Your appliance still needs toodecide what toodo with those packets.</span></span> <span data-ttu-id="3a6c4-253">En el escenario de hello anterior, necesitará hello toocreate siguiendo reglas de los dispositivos:</span><span class="sxs-lookup"><span data-stu-id="3a6c4-253">In hello scenario above, you will need toocreate hello following rules in your appliances:</span></span>

### <a name="opfw"></a><span data-ttu-id="3a6c4-254">OPFW</span><span class="sxs-lookup"><span data-stu-id="3a6c4-254">OPFW</span></span>
<span data-ttu-id="3a6c4-255">OPFW representa un dispositivo local que contiene Hola siguiendo reglas:</span><span class="sxs-lookup"><span data-stu-id="3a6c4-255">OPFW represents an on-premises device containing hello following rules:</span></span>

* <span data-ttu-id="3a6c4-256">**Ruta**: todo el tráfico too10.0.0.0/16 (**azurevnet**) se deben enviar a través de túnel **ONPREMAZURE**.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-256">**Route**: All traffic too10.0.0.0/16 (**azurevnet**) must be sent through tunnel **ONPREMAZURE**.</span></span>
* <span data-ttu-id="3a6c4-257">**Directiva**: permita todo el tráfico bidireccional entre **port2** y **ONPREMAZURE**.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-257">**Policy**: Allow all bidirectional traffic between **port2** and **ONPREMAZURE**.</span></span>

### <a name="azf1"></a><span data-ttu-id="3a6c4-258">AZF1</span><span class="sxs-lookup"><span data-stu-id="3a6c4-258">AZF1</span></span>
<span data-ttu-id="3a6c4-259">AZF1 representa una aplicación virtual de Azure que contiene Hola siguiendo reglas:</span><span class="sxs-lookup"><span data-stu-id="3a6c4-259">AZF1 represents an Azure virtual appliance containing hello following rules:</span></span>

* <span data-ttu-id="3a6c4-260">**Directiva**: permita todo el tráfico bidireccional entre **port1** y **port2**.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-260">**Policy**: Allow all bidirectional traffic between **port1** and **port2**.</span></span>

### <a name="azf2"></a><span data-ttu-id="3a6c4-261">AZF2</span><span class="sxs-lookup"><span data-stu-id="3a6c4-261">AZF2</span></span>
<span data-ttu-id="3a6c4-262">AZF2 representa una aplicación virtual de Azure que contiene Hola siguiendo reglas:</span><span class="sxs-lookup"><span data-stu-id="3a6c4-262">AZF2 represents an Azure virtual appliance containing hello following rules:</span></span>

* <span data-ttu-id="3a6c4-263">**Ruta**: todo el tráfico too10.0.0.0/16 (**onpremvnet**) se deben enviar dirección IP de puerta de enlace de Azure toohello (es decir, 10.0.0.1) a través de **port1**.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-263">**Route**: All traffic too10.0.0.0/16 (**onpremvnet**) must be sent toohello Azure gateway IP address (i.e. 10.0.0.1) through **port1**.</span></span>
* <span data-ttu-id="3a6c4-264">**Directiva**: permita todo el tráfico bidireccional entre **port1** y **port2**.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-264">**Policy**: Allow all bidirectional traffic between **port1** and **port2**.</span></span>

## <a name="network-security-groups-nsgs"></a><span data-ttu-id="3a6c4-265">Grupos de seguridad de red (NSG)</span><span class="sxs-lookup"><span data-stu-id="3a6c4-265">Network Security Groups (NSGs)</span></span>
<span data-ttu-id="3a6c4-266">En este escenario, no se usan los NSG.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-266">In this scenario, NSGs are not being used.</span></span> <span data-ttu-id="3a6c4-267">Sin embargo, podría aplicar NSG tooeach subred toorestrict tráfico entrante y saliente.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-267">However, you could apply NSGs tooeach subnet toorestrict incoming and outgoing traffic.</span></span> <span data-ttu-id="3a6c4-268">Por ejemplo, podría aplicar Hola después de la subred de FW externa de toohello de reglas NSG.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-268">For instance, you could apply hello following NSG rules toohello external FW subnet.</span></span>

<span data-ttu-id="3a6c4-269">**Entrante**</span><span class="sxs-lookup"><span data-stu-id="3a6c4-269">**Incoming**</span></span>

* <span data-ttu-id="3a6c4-270">Permitir todo el tráfico TCP de hello Internet tooport 80 en cualquier máquina virtual en la subred de Hola.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-270">Allow all TCP traffic from hello Internet tooport 80 on any VM in hello subnet.</span></span>
* <span data-ttu-id="3a6c4-271">Denegar todo el tráfico desde Internet Hola.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-271">Deny all other traffic from hello Internet.</span></span>

<span data-ttu-id="3a6c4-272">**Saliente**</span><span class="sxs-lookup"><span data-stu-id="3a6c4-272">**Outgoing**</span></span>

* <span data-ttu-id="3a6c4-273">Denegar todo el tráfico toohello Internet.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-273">Deny all traffic toohello Internet.</span></span>

## <a name="high-level-steps"></a><span data-ttu-id="3a6c4-274">Pasos de alto nivel</span><span class="sxs-lookup"><span data-stu-id="3a6c4-274">High level steps</span></span>
<span data-ttu-id="3a6c4-275">toodeploy este escenario, seguimiento Hola pasos de alto nivel siguiente.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-275">toodeploy this scenario, follow hello high level steps below.</span></span>

1. <span data-ttu-id="3a6c4-276">Inicio de sesión tooyour suscripción de Azure.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-276">Login tooyour Azure Subscription.</span></span>
2. <span data-ttu-id="3a6c4-277">Si desea un Hola de red virtual toomimic toodeploy red local, aprovisionar recursos de Hola que forman parte de **ONPREMRG**.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-277">If you want toodeploy a VNet toomimic hello on-premises network, provision hello resources that are part of **ONPREMRG**.</span></span>
3. <span data-ttu-id="3a6c4-278">Aprovisionar recursos de Hola que forman parte de **AZURERG**.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-278">Provision hello resources that are part of **AZURERG**.</span></span>
4. <span data-ttu-id="3a6c4-279">Túnel de Hola de aprovisionamiento de **onpremvnet** demasiado**azurevnet**.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-279">Provision hello tunnel from **onpremvnet** too**azurevnet**.</span></span>
5. <span data-ttu-id="3a6c4-280">Una vez que todos los recursos se aprovisionan, inicie sesión demasiado**onpremvm2** y la conectividad de ping 10.0.3.101 tootest entre **onpremsn2** y **azsn3**.</span><span class="sxs-lookup"><span data-stu-id="3a6c4-280">Once all resources are provisioned, log on too**onpremvm2** and ping 10.0.3.101 tootest connectivity between **onpremsn2** and **azsn3**.</span></span>

