---
title: "Solución de problemas de Azure Disk Encryption | Microsoft Docs"
description: "En este artículo se ofrecen sugerencias para solucionar problemas de Microsoft Azure Disk Encryption para máquinas virtuales IaaS con Windows y Linux."
services: security
documentationcenter: na
author: deventiwari
manager: avibm
editor: yuridio
ms.assetid: ce0e23bd-07eb-43af-a56c-aa1a73bdb747
ms.service: security
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 07/27/2017
ms.author: devtiw
ms.openlocfilehash: 5f482a92b8fcd71a1b767fcc5741bc57605997ea
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 08/29/2017
---
# <a name="azure-disk-encryption-troubleshooting-guide"></a><span data-ttu-id="b41a9-103">Guía de solución de problemas de Azure Disk Encryption</span><span class="sxs-lookup"><span data-stu-id="b41a9-103">Azure Disk Encryption Troubleshooting Guide</span></span>

<span data-ttu-id="b41a9-104">Esta guía está destinada a profesionales de tecnologías de la información (TI), analistas de seguridad de la información y administradores de la nube cuyas organizaciones utilizan Azure Disk Encryption y necesitan orientación para solucionar problemas relacionados con el cifrado de discos.</span><span class="sxs-lookup"><span data-stu-id="b41a9-104">This guide is for information technology (IT) professionals, information security analysts, and cloud administrators whose organizations are using Azure disk encryption and need guidance to troubleshoot disk-encryption related issues.</span></span>

## <a name="troubleshooting-linux-os-disk-encryption"></a><span data-ttu-id="b41a9-105">Solución de problemas del cifrado de discos con el SO Linux</span><span class="sxs-lookup"><span data-stu-id="b41a9-105">Troubleshooting Linux OS disk encryption</span></span>

<span data-ttu-id="b41a9-106">El cifrado de discos con el sistema operativo Linux debe desmontar la unidad del sistema operativo antes de pasar por el proceso de cifrado de disco completo.</span><span class="sxs-lookup"><span data-stu-id="b41a9-106">Linux OS disk encryption must unmount the OS drive prior to running it through the full disk encryption process.</span></span>   <span data-ttu-id="b41a9-107">Si no es posible, es probable que el mensaje de error "no se pudo desmontar después de..."</span><span class="sxs-lookup"><span data-stu-id="b41a9-107">If it cannot, an error message of "failed to unmount after…"</span></span> <span data-ttu-id="b41a9-108">aparezca.</span><span class="sxs-lookup"><span data-stu-id="b41a9-108">error message is likely to occur.</span></span>

<span data-ttu-id="b41a9-109">Suele ocurrir cuando se intenta el cifrado del disco del sistema operativo en un entorno de máquina virtual de destino que se ha modificado o cambiado desde su imagen de la galería admitida.</span><span class="sxs-lookup"><span data-stu-id="b41a9-109">This is most likely when OS disk encryption is attempted on a target VM environment that has been modified or changed from its supported stock gallery image.</span></span>  <span data-ttu-id="b41a9-110">Estos son algunos ejemplos de desviaciones de la imagen admitida, que pueden interferir con la capacidad de la extensión de desmontar la unidad del sistema operativo:</span><span class="sxs-lookup"><span data-stu-id="b41a9-110">Examples of deviations from the supported image, which can interfere with the extension’s ability to unmount the OS drive include:</span></span>
- <span data-ttu-id="b41a9-111">Imágenes personalizadas que ya no coinciden con un sistema de archivos o esquema de partición compatibles.</span><span class="sxs-lookup"><span data-stu-id="b41a9-111">Customized images that no longer match a supported file system and/or partitioning scheme.</span></span>
- <span data-ttu-id="b41a9-112">Imágenes personalizadas con aplicaciones como un antivirus, Docker, SAP, MongoDB o Apache Cassandra ejecutándose en el sistema operativo antes del cifrado.</span><span class="sxs-lookup"><span data-stu-id="b41a9-112">Customized images with applications such as antivirus, Docker, SAP, MongoDB, or Apache Cassandra running in the OS prior to encryption.</span></span>  <span data-ttu-id="b41a9-113">Estas aplicaciones son difíciles de terminar y, cuando conservan los identificadores de archivos abiertos en la unidad del sistema operativo, esta no se puede desmontar, lo que provoca un error.</span><span class="sxs-lookup"><span data-stu-id="b41a9-113">These applications are difficult to terminate, and when they retain open file handles to the OS drive, the drive cannot be unmounted, causing failure.</span></span>
- <span data-ttu-id="b41a9-114">Los scripts personalizados que se ejecutan cerca del paso de cifrado pueden interferir y provocar este error.</span><span class="sxs-lookup"><span data-stu-id="b41a9-114">Custom scripts that run in close time proximity to the encryption step can interfere and cause this failure.</span></span> <span data-ttu-id="b41a9-115">Esto puede ocurrir cuando una plantilla de Resource Manager define varias extensiones para ejecutarse al mismo tiempo o cuando una extensión de script personalizada u otra acción se ejecutan simultáneamente que el cifrado del disco.</span><span class="sxs-lookup"><span data-stu-id="b41a9-115">This can happen when a Resource Manager template defines multiple extensions to execute simultaneously, or when a custom script extension or other action is run simultaneously to disk encryption.</span></span>   <span data-ttu-id="b41a9-116">La serialización y el aislamiento de estos pasos pueden resolver el problema.</span><span class="sxs-lookup"><span data-stu-id="b41a9-116">Serializing and isolating such steps may resolve the issue.</span></span>
- <span data-ttu-id="b41a9-117">Cuando no se ha deshabilitado SELinux antes de habilitar el cifrado, se produce un error en el paso de desmontaje.</span><span class="sxs-lookup"><span data-stu-id="b41a9-117">When SELinux has not been disabled prior to enabling encryption, the unmount step fails.</span></span>  <span data-ttu-id="b41a9-118">SELinux puede habilitarse de nuevo después de completarse el cifrado.</span><span class="sxs-lookup"><span data-stu-id="b41a9-118">SELinux can be re-enabled after encryption has completed.</span></span>
- <span data-ttu-id="b41a9-119">Cuando el disco del sistema operativo usa un esquema de LVM (aunque hay compatibilidad limitada con los discos de datos LVM, no se admite el disco del sistema operativo LVM)</span><span class="sxs-lookup"><span data-stu-id="b41a9-119">When the OS disk is using an LVM scheme (although limited LVM data disk support is available, LVM OS disk is not)</span></span>
- <span data-ttu-id="b41a9-120">Cuando no se cumplen los requisitos mínimos de memoria (se recomiendan 7GB para el cifrado del disco de sistema operativo)</span><span class="sxs-lookup"><span data-stu-id="b41a9-120">When minimum memory requirements are not met (7GB is suggested for OS disk encryption)</span></span>
- <span data-ttu-id="b41a9-121">Cuando las unidades de datos se han montado recursivamente en el directorio /mnt/ o entre sí (por ejemplo, /mnt/datos1, /mnt/datos2, /datos3 + /datos3/datos4, etc.)</span><span class="sxs-lookup"><span data-stu-id="b41a9-121">When data drives have been recursively mounted under /mnt/ directory, or each other (for example, /mnt/data1, /mnt/data2, /data3 + /data3/data4, etc.)</span></span>
- <span data-ttu-id="b41a9-122">Cuando no se cumplen otros [requisitos previos](https://docs.microsoft.com/en-us/azure/security/azure-security-disk-encryption) de Azure Disk Encryption para Linux</span><span class="sxs-lookup"><span data-stu-id="b41a9-122">When other Azure Disk Encryption [prerequisites](https://docs.microsoft.com/en-us/azure/security/azure-security-disk-encryption) for Linux are not met</span></span>

## <a name="unable-to-encrypt"></a><span data-ttu-id="b41a9-123">No se puede cifrar</span><span class="sxs-lookup"><span data-stu-id="b41a9-123">Unable to encrypt</span></span>

<span data-ttu-id="b41a9-124">En algunos casos, parece que el cifrado del disco de Linux se atasca en el mensaje que indica que se inició el cifrado de disco del sistema operativo, y SSH se deshabilita.</span><span class="sxs-lookup"><span data-stu-id="b41a9-124">In some cases, the Linux disk encryption appears to be stuck at "OS disk encryption started" and SSH is disabled.</span></span> <span data-ttu-id="b41a9-125">En una imagen de la galería en existencias, este proceso puede tardar entre 3 y 16 horas en completarse.</span><span class="sxs-lookup"><span data-stu-id="b41a9-125">This process can take between 3-16 hours to complete on a stock gallery image.</span></span>  <span data-ttu-id="b41a9-126">Si se agregan discos de datos de varios TB, el proceso puede tardar días.</span><span class="sxs-lookup"><span data-stu-id="b41a9-126">If multi-TB size data disks are added, the process may take days.</span></span> <span data-ttu-id="b41a9-127">La secuencia de cifrado del disco del sistema operativo Linux desmonta temporalmente la unidad de sistema operativo y realiza el cifrado bloque a bloque de todo el disco antes de volver a montarlo cifrado.</span><span class="sxs-lookup"><span data-stu-id="b41a9-127">The Linux OS disk encryption sequence unmounts the OS drive temporarily, and performs block by block encryption of the entire OS disk, before remounting it in its encrypted state.</span></span>   <span data-ttu-id="b41a9-128">A diferencia de Azure Disk Encryption en Windows, el cifrado del disco de Linux no permite el uso simultáneo de la máquina virtual mientras el cifrado está en curso.</span><span class="sxs-lookup"><span data-stu-id="b41a9-128">Unlike Azure Disk Encryption on Windows, Linux Disk Encryption does not allow concurrent use of the VM while the encryption is in progress.</span></span>  <span data-ttu-id="b41a9-129">Las características de rendimiento de la máquina virtual, incluido el tamaño del disco y si la cuenta de almacenamiento está respaldada por el almacenamiento Standard o Premium (SSD), pueden influir en gran medida en el tiempo necesario para completar el cifrado.</span><span class="sxs-lookup"><span data-stu-id="b41a9-129">The performance characteristics of the VM, including the size of the disk and whether the storage account is backed by standard or premium (SSD) storage, can greatly influence the time required to complete encryption.</span></span>

<span data-ttu-id="b41a9-130">Para comprobar el estado, puede sondearse el campo ProgressMessage devuelto por el comando [Get-AzureRmVmDiskEncryptionStatus](https://docs.microsoft.com/powershell/module/azurerm.compute/get-azurermvmdiskencryptionstatus).</span><span class="sxs-lookup"><span data-stu-id="b41a9-130">To check status, the ProgressMessage field returned from the [Get-AzureRmVmDiskEncryptionStatus](https://docs.microsoft.com/powershell/module/azurerm.compute/get-azurermvmdiskencryptionstatus) command can be polled.</span></span>   <span data-ttu-id="b41a9-131">Mientras se cifra la unidad del sistema operativo, la máquina virtual entra en estado de mantenimiento y SSH también se deshabilita para evitar cualquier interrupción en el proceso en curso.</span><span class="sxs-lookup"><span data-stu-id="b41a9-131">While the OS drive is being encrypted, the VM enters a servicing state, and SSH is also disabled to prevent any disruption to the ongoing process.</span></span>  <span data-ttu-id="b41a9-132">Durante el cifrado, la mayoría de las veces se mostrará el mensaje EncryptionInProgress, seguido, varias horas después, del mensaje VMRestartPending que pregunta si se reinicia la máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="b41a9-132">EncryptionInProgress will be reported for the majority of the time while encryption is in progress, followed several hours later with a VMRestartPending message prompting to restart the VM.</span></span>  <span data-ttu-id="b41a9-133">Por ejemplo:</span><span class="sxs-lookup"><span data-stu-id="b41a9-133">For example:</span></span>


```
PS > Get-AzureRmVMDiskEncryptionStatus -ResourceGroupName $resourceGroupName -VMName $vmName
OsVolumeEncrypted          : EncryptionInProgress
DataVolumesEncrypted       : EncryptionInProgress
OsVolumeEncryptionSettings : Microsoft.Azure.Management.Compute.Models.DiskEncryptionSettings
ProgressMessage            : OS disk encryption started

PS > Get-AzureRmVMDiskEncryptionStatus -ResourceGroupName $resourceGroupName -VMName $vmName
OsVolumeEncrypted          : VMRestartPending
DataVolumesEncrypted       : Encrypted
OsVolumeEncryptionSettings : Microsoft.Azure.Management.Compute.Models.DiskEncryptionSettings
ProgressMessage            : OS disk successfully encrypted, please reboot the VM
```

<span data-ttu-id="b41a9-134">Una vez que se le pida que reinicie la máquina virtual, tras reiniciarla y transcurridos entonces de dos a tres minutos para el reinicio y para los pasos finales en el destino, el mensaje de estado indicará que el cifrado se ha completado finalmente.</span><span class="sxs-lookup"><span data-stu-id="b41a9-134">Once prompted to reboot the VM, and after restarting the VM, and giving 2-3 minutes for the reboot and for final steps to be performed on the target, the status message will indicate that encryption has finally completed.</span></span>   <span data-ttu-id="b41a9-135">Cuando este mensaje esté disponible, es de esperar que la unidad de sistema operativo cifrada y la máquina virtual se puedan utilizar de nuevo.</span><span class="sxs-lookup"><span data-stu-id="b41a9-135">Once this message is available, the encrypted OS drive is expected to be ready for use and for the VM to be usable again.</span></span>

<span data-ttu-id="b41a9-136">Si no se ha seguido esta secuencia o si se muestran otros mensajes de progreso o información de inicio o bien indicadores de error que informan de que el cifrado del sistema operativo ha fracasado en mitad de este proceso (por ejemplo, si ve el error "no se pudo desmontar" descrito en esta guía), se recomienda restaurar la máquina virtual a la instantánea o con la copia de seguridad realizadas inmediatamente antes del cifrado.</span><span class="sxs-lookup"><span data-stu-id="b41a9-136">In cases where this sequence was not seen, or if boot information, progress message, or other error indicators report that OS encryption has failed in the middle of this process (for example if you are seeing the "failed to unmount" error described in this guide), it is recommended to restore the VM back to the snapshot or backup taken immediately prior to encryption.</span></span>  <span data-ttu-id="b41a9-137">Antes de volver a intentarlo, se recomienda volver a evaluar las características de la máquina virtual y asegurarse de que se cumplan todos los requisitos previos.</span><span class="sxs-lookup"><span data-stu-id="b41a9-137">Prior to the next attempt, it is suggested to re-evaluate the characteristics of the VM and ensure that all prerequisites are satisfied.</span></span>

## <a name="troubleshooting-azure-disk-encryption-behind-a-firewall"></a><span data-ttu-id="b41a9-138">Solución de problemas de Azure Disk Encryption detrás de un firewall</span><span class="sxs-lookup"><span data-stu-id="b41a9-138">Troubleshooting Azure Disk Encryption behind a Firewall</span></span>
<span data-ttu-id="b41a9-139">Cuando la conectividad está limitada por un firewall, la configuración del grupo de seguridad de red (NSG) o el requisito de proxy, puede que se pierda la capacidad de la extensión para realizar las tareas necesarias.</span><span class="sxs-lookup"><span data-stu-id="b41a9-139">When connectivity is restricted by a firewall, proxy requirement, or network security group (NSG) settings, the ability of the extension to perform needed tasks can be disrupted.</span></span>   <span data-ttu-id="b41a9-140">Esto puede dar lugar a mensajes de estado similares a "El estado de extensión no está disponible en la máquina virtual" y podría ocurrir que el proceso no se pueda concluir.</span><span class="sxs-lookup"><span data-stu-id="b41a9-140">This can result in status messages such as "Extension status not available on the VM" and in expected scenarios failing to finish.</span></span>  <span data-ttu-id="b41a9-141">En las secciones siguientes se enumeran algunos problemas comunes del firewall que puede investigar.</span><span class="sxs-lookup"><span data-stu-id="b41a9-141">The sections that follow has some common firewall issues that you may investigate.</span></span>

### <a name="network-security-groups"></a><span data-ttu-id="b41a9-142">Grupos de seguridad de red</span><span class="sxs-lookup"><span data-stu-id="b41a9-142">Network security groups</span></span>
<span data-ttu-id="b41a9-143">Parte de la configuración del grupo de seguridad de red aplicada debe permitir todavía que el punto de conexión cumpla con los [requisitos previos](https://docs.microsoft.com/azure/security/azure-security-disk-encryption#prerequisites) documentados de la configuración de red para el cifrado del disco.</span><span class="sxs-lookup"><span data-stu-id="b41a9-143">Any network security group settings applied must still allow the endpoint to meet the documented network configuration [prerequisites](https://docs.microsoft.com/azure/security/azure-security-disk-encryption#prerequisites) for disk encryption.</span></span>

### <a name="azure-keyvault-behind-firewall"></a><span data-ttu-id="b41a9-144">Azure Key Vault detrás del firewall</span><span class="sxs-lookup"><span data-stu-id="b41a9-144">Azure Keyvault behind firewall</span></span>
<span data-ttu-id="b41a9-145">La máquina virtual debe poder tener acceso al almacén de claves.</span><span class="sxs-lookup"><span data-stu-id="b41a9-145">The VM must be able to access key vault.</span></span> <span data-ttu-id="b41a9-146">Consulte la documentación sobre el acceso al almacén de claves detrás de un firewall mantenido por el equipo de [Key Vault](https://docs.microsoft.com/azure/key-vault/key-vault-access-behind-firewall).</span><span class="sxs-lookup"><span data-stu-id="b41a9-146">Refer to guidance on access to key fault from behind a firewall that is maintained by the [Key Vault](https://docs.microsoft.com/azure/key-vault/key-vault-access-behind-firewall) team.</span></span>

### <a name="linux-package-management-behind-firewall"></a><span data-ttu-id="b41a9-147">Administración de paquetes de Linux detrás del firewall</span><span class="sxs-lookup"><span data-stu-id="b41a9-147">Linux package management behind firewall</span></span>
<span data-ttu-id="b41a9-148">En tiempo de ejecución, Azure Disk Encryption para Linux se basa en el sistema de administración de paquetes de la distribución de destino para instalar los componentes de requisitos previos necesarios antes de habilitar el cifrado.</span><span class="sxs-lookup"><span data-stu-id="b41a9-148">At run time, Azure Disk Encryption for Linux relies on the target distribution’s package management system to install needed prerequisite components prior to enabling encryption.</span></span>  <span data-ttu-id="b41a9-149">Si la configuración de firewall impide que la máquina virtual pueda descargar e instalar estos componentes, es previsible que produzcan errores.</span><span class="sxs-lookup"><span data-stu-id="b41a9-149">If firewall settings prevent the VM from being able to download and install these components, then subsequent failures are expected.</span></span>    <span data-ttu-id="b41a9-150">Los pasos para configurar esta opción pueden variar la distribución.</span><span class="sxs-lookup"><span data-stu-id="b41a9-150">The steps to configure this may vary by distribution.</span></span>  <span data-ttu-id="b41a9-151">En Red Hat, cuando se requiere un proxy, es vital asegurarse de que el administrador de la suscripción y yum están configurados correctamente.</span><span class="sxs-lookup"><span data-stu-id="b41a9-151">On Red Hat, when a proxy is required, ensuring that subscription-manager and yum are set up properly is vital.</span></span>  <span data-ttu-id="b41a9-152">Consulte [este artículo](https://access.redhat.com/solutions/189533) de soporte técnico de Red Hat sobre este tema.</span><span class="sxs-lookup"><span data-stu-id="b41a9-152">See [this](https://access.redhat.com/solutions/189533) Red Hat support article on this topic.</span></span>  

## <a name="troubleshooting-windows-server-2016-server-core"></a><span data-ttu-id="b41a9-153">Solución de problemas de Windows Server 2016 Server Core</span><span class="sxs-lookup"><span data-stu-id="b41a9-153">Troubleshooting Windows Server 2016 Server Core</span></span>

<span data-ttu-id="b41a9-154">En Windows Server 2016 Server Core, el componente bdehdcfg no está disponible de forma predeterminada.</span><span class="sxs-lookup"><span data-stu-id="b41a9-154">On Windows Server 2016 Server Core, the bdehdcfg component is not available by default.</span></span> <span data-ttu-id="b41a9-155">y Azure Disk Encryption necesita dicho componente.</span><span class="sxs-lookup"><span data-stu-id="b41a9-155">This component is required by Azure Disk Encryption.</span></span>

<span data-ttu-id="b41a9-156">Para solucionar este problema, copie los cuatro archivos siguientes de una máquina virtual del centro de datos de Windows Server 2016 a la carpeta c:\windows\system32 de la imagen de Server Core:</span><span class="sxs-lookup"><span data-stu-id="b41a9-156">To workaround this issue, copy the following 4 files from a Windows Server 2016 Data Center VM to the c:\windows\system32 folder of the Server Core image:</span></span>

```
bdehdcfg.exe
bdehdcfglib.dll
bdehdcfglib.dll.mui
bdehdcfg.exe.mui
```

<span data-ttu-id="b41a9-157">Luego, ejecute el siguiente comando:</span><span class="sxs-lookup"><span data-stu-id="b41a9-157">Then, run the following command:</span></span>

```
bdehdcfg.exe -target default
```

<span data-ttu-id="b41a9-158">Se creará una partición de sistema de 550 MB y, después, tras un reinicio, se puede usar Diskpart para comprobar los volúmenes y continuar.</span><span class="sxs-lookup"><span data-stu-id="b41a9-158">This will create a 550MB system partition and then after a reboot, you can use Diskpart to check the volumes, and proceed.</span></span>  

<span data-ttu-id="b41a9-159">Por ejemplo:</span><span class="sxs-lookup"><span data-stu-id="b41a9-159">For example:</span></span>

```
DISKPART> list vol

  Volume ###  Ltr  Label        Fs     Type        Size     Status     Info
  ----------  ---  -----------  -----  ----------  -------  ---------  --------
  Volume 0     C                NTFS   Partition    126 GB  Healthy    Boot
  Volume 1                      NTFS   Partition    550 MB  Healthy    System
  Volume 2     D   Temporary S  NTFS   Partition     13 GB  Healthy    Pagefile
```
## <a name="see-also"></a><span data-ttu-id="b41a9-160">Otras referencias</span><span class="sxs-lookup"><span data-stu-id="b41a9-160">See also</span></span>
<span data-ttu-id="b41a9-161">En este documento, aprendió más acerca de algunos problemas comunes de Azure Disk Encryption y cómo solucionarlos.</span><span class="sxs-lookup"><span data-stu-id="b41a9-161">In this document, you learned more about some common issues in Azure disk encryption, and how to troubleshoot.</span></span> <span data-ttu-id="b41a9-162">Para más información acerca de este servicio y su funcionalidad, lea:</span><span class="sxs-lookup"><span data-stu-id="b41a9-162">For more information about this service and its capability read:</span></span>

- [<span data-ttu-id="b41a9-163">Aplicación de cifrado de discos en Azure Security Center</span><span class="sxs-lookup"><span data-stu-id="b41a9-163">Apply disk encryption in Azure Security Center</span></span>](https://docs.microsoft.com/azure/security-center/security-center-apply-disk-encryption)
- [<span data-ttu-id="b41a9-164">Cifrado de una máquina virtual de Azure</span><span class="sxs-lookup"><span data-stu-id="b41a9-164">Encrypt an Azure Virtual Machine</span></span>](https://docs.microsoft.com/azure/security-center/security-center-disk-encryption)
- [<span data-ttu-id="b41a9-165">Cifrado en reposo de datos de Azure</span><span class="sxs-lookup"><span data-stu-id="b41a9-165">Azure Data Encryption-at-Rest</span></span>](https://docs.microsoft.com/azure/security/azure-security-encryption-atrest)
