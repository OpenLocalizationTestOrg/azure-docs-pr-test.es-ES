---
title: "Autenticación de entidad de servicio para API Apps en Azure App Service | Microsoft Docs"
description: "Aprenda a proteger una aplicación de API en el Servicio de aplicaciones de Azure para escenarios entre servicios."
services: app-service\api
documentationcenter: .net
author: alexkarcher-msft
manager: erikre
editor: 
ms.assetid: 7ca0bab2-1d29-4d51-b779-dce0edd34f8b
ms.service: app-service-api
ms.workload: na
ms.tgt_pltfrm: dotnet
ms.devlang: na
ms.topic: article
ms.date: 06/30/2016
ms.author: alkarche
ms.openlocfilehash: 95653287546bbe358111ed16af0c30a53caff2b5
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 07/11/2017
---
# <a name="service-principal-authentication-for-api-apps-in-azure-app-service"></a><span data-ttu-id="83f9c-103">Autenticación de entidad de servicio para Aplicaciones de API en el Servicio de aplicaciones de Azure</span><span class="sxs-lookup"><span data-stu-id="83f9c-103">Service principal authentication for API Apps in Azure App Service</span></span>
## <a name="overview"></a><span data-ttu-id="83f9c-104">Información general</span><span class="sxs-lookup"><span data-stu-id="83f9c-104">Overview</span></span>
<span data-ttu-id="83f9c-105">Este artículo explica cómo utilizar la autenticación del Servicio de aplicaciones para obtener acceso *interno* a aplicaciones de API.</span><span class="sxs-lookup"><span data-stu-id="83f9c-105">This article explains how to use App Service authentication for *internal* access to API apps.</span></span> <span data-ttu-id="83f9c-106">Un escenario interno se produce cuando tiene una aplicación de API que desea que solo sea consumible mediante su propio código de aplicación.</span><span class="sxs-lookup"><span data-stu-id="83f9c-106">An internal scenario is where you have an API app that you want to be consumable only by your own application code.</span></span> <span data-ttu-id="83f9c-107">La manera recomendada de implementar este escenario en el Servicio de aplicaciones es utilizar Azure AD para proteger la aplicación de API llamada.</span><span class="sxs-lookup"><span data-stu-id="83f9c-107">The recommended way to implement this scenario in App Service is to use Azure AD to protect the called API app.</span></span> <span data-ttu-id="83f9c-108">Se llama a la aplicación de API protegida con un token de portador que obtiene de Azure AD al proporcionar credenciales (entidad de servicio) de identidad de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="83f9c-108">You call the protected API app with a bearer token that you get from Azure AD by providing application identity (service principal) credentials.</span></span> <span data-ttu-id="83f9c-109">Para ver alternativas al uso de Azure AD, consulte la sección **Autenticación entre servicios** en [Autenticación y autorización en el Servicio de aplicaciones de Azure](../app-service/app-service-authentication-overview.md#service-to-service-authentication).</span><span class="sxs-lookup"><span data-stu-id="83f9c-109">For alternatives to using Azure AD, see the **Service-to-service authentication** section of the [Azure App Service authentication overview](../app-service/app-service-authentication-overview.md#service-to-service-authentication).</span></span>

<span data-ttu-id="83f9c-110">En este artículo, aprenderá lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="83f9c-110">In this article, you'll learn:</span></span>

* <span data-ttu-id="83f9c-111">Usar Azure Active Directory (Azure AD) para proteger una aplicación de API de accesos no autenticados.</span><span class="sxs-lookup"><span data-stu-id="83f9c-111">How to use Azure Active Directory (Azure AD) to protect an API app from unauthenticated access.</span></span>
* <span data-ttu-id="83f9c-112">Consumir una aplicación de API protegida desde otra aplicación de API, una aplicación web o una aplicación móvil mediante credenciales de entidad de servicio (identidad de aplicación) de Azure AD.</span><span class="sxs-lookup"><span data-stu-id="83f9c-112">How to consume a protected API app from an API app, web app, or mobile app by using Azure AD service principal (app identity) credentials.</span></span> <span data-ttu-id="83f9c-113">Para más información sobre cómo consumir desde una aplicación lógica, consulte [Uso de la API personalizada hospedada en Servicio de aplicaciones con aplicaciones lógicas](../logic-apps/logic-apps-custom-hosted-api.md).</span><span class="sxs-lookup"><span data-stu-id="83f9c-113">For information about how to consume from a logic app, see [Using your custom API hosted on App Service with Logic apps](../logic-apps/logic-apps-custom-hosted-api.md).</span></span>
* <span data-ttu-id="83f9c-114">Asegurarse de que los usuarios que iniciaron sesión no pueda llaman a la aplicación de API protegida desde un explorador.</span><span class="sxs-lookup"><span data-stu-id="83f9c-114">How to make sure that the protected API app can't be called from a browser by logged on users.</span></span>
* <span data-ttu-id="83f9c-115">Asegurarse de que solo una entidad de servicio de Azure AD pueda llamar a la aplicación de API protegida.</span><span class="sxs-lookup"><span data-stu-id="83f9c-115">How to make sure that the protected API app can only be called by a specific Azure AD service principal.</span></span>

<span data-ttu-id="83f9c-116">El artículo contiene dos secciones:</span><span class="sxs-lookup"><span data-stu-id="83f9c-116">The article contains two sections:</span></span>

* <span data-ttu-id="83f9c-117">La sección [Configuración de la autenticación de entidad de servicio en Azure App Service](#authconfig) explica en términos generales cómo configurar la autenticación para cualquier aplicación de API y cómo usar la aplicación de API protegida.</span><span class="sxs-lookup"><span data-stu-id="83f9c-117">The [How to configure service principal authentication in Azure App Service](#authconfig) section explains in general how to configure authentication for any API app, and how to consume the protected API app.</span></span> <span data-ttu-id="83f9c-118">Esta sección se aplica igualmente a todos los marcos admitidos por el Servicio de aplicaciones, como. NET, Node.js y Java.</span><span class="sxs-lookup"><span data-stu-id="83f9c-118">This section applies equally to all frameworks supported by App Service, including .NET, Node.js, and Java.</span></span>
* <span data-ttu-id="83f9c-119">A partir de la sección [Continuación de la serie de tutoriales de aplicaciones de API de .NET](#tutorialstart) , el tutorial lo guiará a través de la configuración de un escenario de "acceso interno" para una aplicación de ejemplo de .NET en ejecución en el Servicio de aplicaciones.</span><span class="sxs-lookup"><span data-stu-id="83f9c-119">Starting with the [Continuing the .NET getting-started tutorials](#tutorialstart) section, the tutorial guides you through configuring an "internal access" scenario for a .NET sample application running in App Service.</span></span> 

## <span data-ttu-id="83f9c-120"><a id="authconfig"></a> Configuración de la autenticación de entidad de servicio en el Servicio de aplicaciones de Azure</span><span class="sxs-lookup"><span data-stu-id="83f9c-120"><a id="authconfig"></a> How to configure service principal authentication in Azure App Service</span></span>
<span data-ttu-id="83f9c-121">Esta sección proporciona instrucciones generales que se aplican a cualquier aplicación de API.</span><span class="sxs-lookup"><span data-stu-id="83f9c-121">This section provides general instructions that apply to any API app.</span></span> <span data-ttu-id="83f9c-122">Para obtener los pasos específicos para la aplicación de ejemplo de .NET To Do List, vaya a [Continuación de la serie de tutoriales de aplicaciones de API de .NET](#tutorialstart).</span><span class="sxs-lookup"><span data-stu-id="83f9c-122">For steps specific to the To Do List .NET sample application, go to [Continuing the .NET API Apps tutorial series](#tutorialstart).</span></span>

1. <span data-ttu-id="83f9c-123">En [Azure Portal](https://portal.azure.com/), vaya a la hoja **Configuración** de la aplicación de API que quiere proteger, busque la sección **Características** y haga clic en **Autenticación/autorización**.</span><span class="sxs-lookup"><span data-stu-id="83f9c-123">In the [Azure portal](https://portal.azure.com/), navigate to the **Settings** blade of the API app that you want to protect, and then find the **Features** section and click **Authentication/ Authorization**.</span></span>
   
    ![Autenticación/autorización en el Portal de Azure](./media/app-service-api-dotnet-user-principal-auth/features.png)
2. <span data-ttu-id="83f9c-125">En la hoja **Autenticación/autorización**, haga clic en **Activado**.</span><span class="sxs-lookup"><span data-stu-id="83f9c-125">In the **Authentication / Authorization** blade, click **On**.</span></span>
3. <span data-ttu-id="83f9c-126">En la lista desplegable **Acción por realizar cuando no se autentique la solicitud**, seleccione **Iniciar sesión con Azure Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="83f9c-126">In the **Action to take when request is not authenticated** drop-down list, select **Log in with Azure Active Directory** .</span></span>
4. <span data-ttu-id="83f9c-127">En **Proveedores de autenticación,** seleccione **Azure Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="83f9c-127">Under **Authentication Providers**, select **Azure Active Directory**.</span></span>
   
    ![Hoja Autenticación/autorización del Portal de Azure](./media/app-service-api-dotnet-user-principal-auth/authblade.png)
5. <span data-ttu-id="83f9c-129">Configure la hoja **Configuración de Azure Active Directory** para crear una aplicación de Azure AD o use una aplicación de Azure AD existente si ya tiene alguna que quiera utilizar.</span><span class="sxs-lookup"><span data-stu-id="83f9c-129">Configure the **Azure Active Directory Settings** blade to create a new Azure AD application, or use an existing Azure AD application if you already have one that you want to use.</span></span>
   
    <span data-ttu-id="83f9c-130">En los escenarios internos normalmente hay una aplicación de API que llama a una aplicación de API.</span><span class="sxs-lookup"><span data-stu-id="83f9c-130">Internal scenarios typically involve an API app calling an API app.</span></span> <span data-ttu-id="83f9c-131">Puede usar aplicaciones de AD independientes para cada aplicación de API o una sola aplicación de Azure AD.</span><span class="sxs-lookup"><span data-stu-id="83f9c-131">You can use separate Azure AD applications for each API app or just one Azure AD application.</span></span>
   
    <span data-ttu-id="83f9c-132">Para ver instrucciones detalladas sobre esta hoja, consulte [Configuración de la aplicación del Servicio de aplicaciones para usar el inicio de sesión de Azure Active Directory](../app-service-mobile/app-service-mobile-how-to-configure-active-directory-authentication.md).</span><span class="sxs-lookup"><span data-stu-id="83f9c-132">For detailed instructions on this blade, see [How to configure your App Service application to use Azure Active Directory login](../app-service-mobile/app-service-mobile-how-to-configure-active-directory-authentication.md).</span></span>
6. <span data-ttu-id="83f9c-133">Cuando termine con la hoja de configuración del proveedor de autenticación, haga clic en **Aceptar**.</span><span class="sxs-lookup"><span data-stu-id="83f9c-133">When you're done with the authentication provider configuration blade, click **OK**.</span></span>
7. <span data-ttu-id="83f9c-134">En la hoja **Autenticación/autorización**, haga clic en **Guardar**.</span><span class="sxs-lookup"><span data-stu-id="83f9c-134">In the **Authentication / Authorization** blade, click **Save**.</span></span>
   
    ![Haga clic en Guardar](./media/app-service-api-dotnet-service-principal-auth/authsave.png)

<span data-ttu-id="83f9c-136">Una vez hecho esto, el Servicio de aplicaciones solo admitirá solicitudes de los llamadores en el inquilino de Azure AD configurado.</span><span class="sxs-lookup"><span data-stu-id="83f9c-136">When this is done, App Service only allows requests from callers in the configured Azure AD tenant.</span></span> <span data-ttu-id="83f9c-137">No se requiere ningún código de autenticación ni autorización en la aplicación de API protegida.</span><span class="sxs-lookup"><span data-stu-id="83f9c-137">No authentication or authorization code is required in the protected API app.</span></span> <span data-ttu-id="83f9c-138">El token de portador se pasa a la aplicación de API junto con las notificaciones utilizadas normalmente en encabezados HTTP y puede leer esa información en el código para comprobar que las solicitudes proceden de un llamador concreto, como una entidad de servicio.</span><span class="sxs-lookup"><span data-stu-id="83f9c-138">The bearer token is passed to the API app along with commonly used claims in HTTP headers, and you can read that information in code to validate that requests are from a particular caller, such as a service principal.</span></span>

<span data-ttu-id="83f9c-139">Esta funcionalidad de autenticación funciona de la misma manera para todos los lenguajes que el servicio de aplicaciones admite, como .NET, Node.js y Java.</span><span class="sxs-lookup"><span data-stu-id="83f9c-139">This authentication functionality works the same way for all languages that App service supports, including .NET, Node.js, and Java.</span></span> 

#### <a name="how-to-consume-the-protected-api-app"></a><span data-ttu-id="83f9c-140">Uso de la aplicación de API protegida</span><span class="sxs-lookup"><span data-stu-id="83f9c-140">How to consume the protected API app</span></span>
<span data-ttu-id="83f9c-141">El llamador debe proporcionar un token de portador de Azure AD con llamadas a API.</span><span class="sxs-lookup"><span data-stu-id="83f9c-141">The caller must provide an Azure AD bearer token with API calls.</span></span> <span data-ttu-id="83f9c-142">Para obtener un token de portador con las credenciales de entidad de servicio, el llamador usa la biblioteca de autenticación de Active Directory (ADAL para [.NET](https://www.nuget.org/packages/Microsoft.IdentityModel.Clients.ActiveDirectory), [Node.js](https://github.com/AzureAD/azure-activedirectory-library-for-nodejs) o [Java](https://github.com/AzureAD/azure-activedirectory-library-for-java)).</span><span class="sxs-lookup"><span data-stu-id="83f9c-142">To get a bearer token using service principal credentials, the caller uses Active Directory Authentication Library (ADAL for [.NET](https://www.nuget.org/packages/Microsoft.IdentityModel.Clients.ActiveDirectory), [Node.js](https://github.com/AzureAD/azure-activedirectory-library-for-nodejs), or [Java](https://github.com/AzureAD/azure-activedirectory-library-for-java)).</span></span> <span data-ttu-id="83f9c-143">Para obtener un token, el código que llama a ADAL proporciona a ADAL la siguiente información:</span><span class="sxs-lookup"><span data-stu-id="83f9c-143">To get a token, the code that calls ADAL provides to ADAL the following information:</span></span>

* <span data-ttu-id="83f9c-144">El nombre de su inquilino de Azure AD.</span><span class="sxs-lookup"><span data-stu-id="83f9c-144">The name of your Azure AD tenant.</span></span>
* <span data-ttu-id="83f9c-145">El identificador de cliente y el secreto del cliente (clave de aplicación) de la aplicación de Azure AD asociada al llamador.</span><span class="sxs-lookup"><span data-stu-id="83f9c-145">The client ID and client secret (app key) of the Azure AD app associated with the caller.</span></span>
* <span data-ttu-id="83f9c-146">El identificador de cliente de la aplicación de Azure AD asociada con la aplicación de API protegida.</span><span class="sxs-lookup"><span data-stu-id="83f9c-146">The client ID of the Azure AD application associated with the protected API app.</span></span> <span data-ttu-id="83f9c-147">(Si se usa una sola aplicación de Azure AD, es el mismo identificador de cliente que el llamador).</span><span class="sxs-lookup"><span data-stu-id="83f9c-147">(If just one Azure AD application is used, this is the same client ID as the one for the caller.)</span></span>

<span data-ttu-id="83f9c-148">Estos valores están disponibles en las páginas de Azure AD del [Portal de Azure clásico](https://manage.windowsazure.com/).</span><span class="sxs-lookup"><span data-stu-id="83f9c-148">These values are available in the Azure AD pages of the [Azure classic portal](https://manage.windowsazure.com/).</span></span>

<span data-ttu-id="83f9c-149">Una vez adquirido el token, el llamador lo incluye con las solicitudes HTTP en el encabezado de autorización.</span><span class="sxs-lookup"><span data-stu-id="83f9c-149">Once the token has been acquired, the caller includes it with HTTP requests in the Authorization header.</span></span>  <span data-ttu-id="83f9c-150">El Servicio de aplicaciones valida el token y permite que las solicitudes lleguen a la aplicación de API protegida.</span><span class="sxs-lookup"><span data-stu-id="83f9c-150">App Service validates the token and allows the requests to reach the protected API app.</span></span>

#### <a name="how-to-protect-the-api-app-from-access-by-users-in-the-same-tenant"></a><span data-ttu-id="83f9c-151">Protección de la aplicación de API del acceso de usuarios en el mismo inquilino</span><span class="sxs-lookup"><span data-stu-id="83f9c-151">How to protect the API app from access by users in the same tenant</span></span>
<span data-ttu-id="83f9c-152">Los tokens de portador para los usuarios en el mismo inquilino se consideran válidos para la aplicación de API protegida.</span><span class="sxs-lookup"><span data-stu-id="83f9c-152">Bearer tokens for users in the same tenant are considered valid for the protected API app.</span></span>  <span data-ttu-id="83f9c-153">Si desea asegurarse de que solo una entidad de servicio pueda llamar a la aplicación de API protegida, agregue el código en la aplicación de API protegida para validar las siguientes notificaciones del token:</span><span class="sxs-lookup"><span data-stu-id="83f9c-153">If you want to ensure that only a service principal can call the protected API app, add code in the protected API app to validate the following claims from the token:</span></span>

* <span data-ttu-id="83f9c-154">`appid` debe ser el identificador de cliente de la aplicación de Azure AD que está asociada con el llamador.</span><span class="sxs-lookup"><span data-stu-id="83f9c-154">`appid` should be the client ID of the Azure AD application that is associated with the caller.</span></span> 
* <span data-ttu-id="83f9c-155">`oid` (`objectidentifier`) debe ser el identificador de entidad de servicio del llamador.</span><span class="sxs-lookup"><span data-stu-id="83f9c-155">`oid` (`objectidentifier`) should be the service principal ID of the caller.</span></span> 

<span data-ttu-id="83f9c-156">El Servicio de aplicaciones también proporciona la notificación `objectidentifier` en el encabezado X-MS-CLIENT-PRINCIPAL-ID.</span><span class="sxs-lookup"><span data-stu-id="83f9c-156">App Service also provides the `objectidentifier` claim in the X-MS-CLIENT-PRINCIPAL-ID header.</span></span>

### <a name="how-to-protect-the-api-app-from-browser-access"></a><span data-ttu-id="83f9c-157">Protección de la aplicación de API de accesos desde el explorador</span><span class="sxs-lookup"><span data-stu-id="83f9c-157">How to protect the API app from browser access</span></span>
<span data-ttu-id="83f9c-158">Si no valida las notificaciones en el código en la aplicación de API protegida y si usa otra aplicación de Azure AD para la aplicación de API protegida, asegúrese de que la dirección URL de respuesta de la aplicación de Azure AD no sea igual que la dirección URL base de la aplicación de API.</span><span class="sxs-lookup"><span data-stu-id="83f9c-158">If you don't validate claims in code in the protected API app, and if you use a separate Azure AD application for the protected API app, make sure that the Azure AD application's Reply URL is not the same as the API app's base URL.</span></span> <span data-ttu-id="83f9c-159">Si la dirección URL de respuesta apunta directamente a la aplicación de API protegida, un usuario en el mismo inquilino de Azure AD podría usar un explorador para llegar a la aplicación de API, iniciar sesión y llamar correctamente a la API.</span><span class="sxs-lookup"><span data-stu-id="83f9c-159">If the Reply URL points directly to the protected API app, a user in the same Azure AD tenant could browse to the API app, log on, and successfully call the API.</span></span>

## <span data-ttu-id="83f9c-160"><a id="tutorialstart"></a> Continuación de la serie de tutoriales de aplicaciones de API de .NET</span><span class="sxs-lookup"><span data-stu-id="83f9c-160"><a id="tutorialstart"></a> Continuing the .NET API Apps tutorial series</span></span>
<span data-ttu-id="83f9c-161">Si está siguiendo las series de tutoriales de Node.js o de Java para aplicaciones de API, vaya a la sección [Siguientes pasos](#next-steps) .</span><span class="sxs-lookup"><span data-stu-id="83f9c-161">If you are following the Node.js or Java tutorial series for API apps, skip to the [Next steps](#next-steps) section.</span></span> 

<span data-ttu-id="83f9c-162">El resto de este artículo continúa la serie de tutoriales para aplicaciones de API de .NET y da por hecho que ha completado el [tutorial de autenticación de usuario](app-service-api-dotnet-user-principal-auth.md) y que tiene la aplicación de ejemplo en ejecución en Azure con la autenticación de usuario habilitada.</span><span class="sxs-lookup"><span data-stu-id="83f9c-162">The remainder of this article continues the .NET API Apps tutorial series and assumes that you have completed the [user authentication tutorial](app-service-api-dotnet-user-principal-auth.md) and have the sample application running in Azure with user authentication enabled.</span></span>

## <a name="set-up-authentication-in-azure"></a><span data-ttu-id="83f9c-163">Configuración de la autenticación en Azure</span><span class="sxs-lookup"><span data-stu-id="83f9c-163">Set up authentication in Azure</span></span>
<span data-ttu-id="83f9c-164">En esta sección, configurará el Servicio de aplicaciones para que solo las solicitudes HTTP que tengan tokens de portador de Azure AD válidos tengan acceso a la aplicación de API de capa de datos.</span><span class="sxs-lookup"><span data-stu-id="83f9c-164">In this section you configure App Service so that the only HTTP requests it allows to reach the data tier API app are the ones that have valid Azure AD bearer tokens.</span></span> 

<span data-ttu-id="83f9c-165">En la siguiente sección, configurará la aplicación de API de nivel intermedio para enviar las credenciales de la aplicación a Azure AD, obtener un token de portador y enviar el token de portador a la aplicación de API de capa de datos.</span><span class="sxs-lookup"><span data-stu-id="83f9c-165">In the following section, you configure the middle tier API app to send application credentials to Azure AD, get back a bearer token, and send the bearer token to the data tier API app.</span></span> <span data-ttu-id="83f9c-166">Este proceso se ilustra en el diagrama.</span><span class="sxs-lookup"><span data-stu-id="83f9c-166">This process is illustrated in the diagram.</span></span>

![Diagrama de autenticación del servicio](./media/app-service-api-dotnet-service-principal-auth/appdiagram.png)

<span data-ttu-id="83f9c-168">Si experimenta problemas al seguir las instrucciones del tutorial, consulte la sección [Solución de problemas](#troubleshooting) al final.</span><span class="sxs-lookup"><span data-stu-id="83f9c-168">If you run into problems while following the tutorial directions, see the [Troubleshooting](#troubleshooting) section at the end of the tutorial.</span></span> 

1. <span data-ttu-id="83f9c-169">En [Azure Portal](https://portal.azure.com/), vaya a la hoja **Configuración** de la aplicación de API que creó para ToDoListDataAPI (capa de datos) y haga clic en **Configuración**.</span><span class="sxs-lookup"><span data-stu-id="83f9c-169">In the [Azure portal](https://portal.azure.com/), navigate to the **Settings** blade of the API app that you created for the ToDoListDataAPI (data tier) API app, and then click **Settings**.</span></span>
2. <span data-ttu-id="83f9c-170">En la hoja **Configuración**, busque la sección **Características** y haga clic en **Autenticación/autorización**.</span><span class="sxs-lookup"><span data-stu-id="83f9c-170">In the **Settings** blade, find the **Features** section, and then click **Authentication / Authorization**.</span></span>
   
    ![Autenticación/autorización en el Portal de Azure](./media/app-service-api-dotnet-user-principal-auth/features.png)
3. <span data-ttu-id="83f9c-172">En la hoja **Autenticación/autorización**, haga clic en **Activado**.</span><span class="sxs-lookup"><span data-stu-id="83f9c-172">In the **Authentication / Authorization** blade, click **On**.</span></span>
4. <span data-ttu-id="83f9c-173">En la lista desplegable **Acción por realizar cuando no se autentique la solicitud**, seleccione **Iniciar sesión con Azure Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="83f9c-173">In the **Action to take when request is not authenticated** drop-down list, select **Log in with Azure Active Directory**.</span></span>
   
    <span data-ttu-id="83f9c-174">Esta es la configuración que hace que el Servicio de aplicaciones se asegure de que solo las solicitudes autenticadas alcancen la aplicación de API.</span><span class="sxs-lookup"><span data-stu-id="83f9c-174">This is the setting that causes App Service to ensure that only authenticated requests reach the API app.</span></span> <span data-ttu-id="83f9c-175">Para las solicitudes que tienen tokens de portador válidos, el Servicio de aplicaciones pasa los tokens a la aplicación de API y rellena los encabezados HTTP con las notificaciones usadas normalmente para que esa información esté más fácilmente disponible para el código.</span><span class="sxs-lookup"><span data-stu-id="83f9c-175">For requests that have valid bearer tokens, App Service passes the tokens along to the API app and populates HTTP headers with commonly used claims to make that information more easily available to your code.</span></span>
5. <span data-ttu-id="83f9c-176">En **Proveedores de autenticación**, haga clic en **Azure Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="83f9c-176">Under **Authentication Providers**, click **Azure Active Directory**.</span></span>
   
    ![Hoja Autenticación/autorización del Portal de Azure](./media/app-service-api-dotnet-user-principal-auth/authblade.png)
6. <span data-ttu-id="83f9c-178">En la hoja **Configuración de Azure Active Directory**, haga clic en **Rápido**.</span><span class="sxs-lookup"><span data-stu-id="83f9c-178">In the **Azure Active Directory Settings** blade, click **Express**.</span></span>
   
    <span data-ttu-id="83f9c-179">Con la opción **Rápido**, Azure puede crear automáticamente una aplicación AAD en su [inquilino](https://msdn.microsoft.com/en-us/library/azure/jj573650.aspx#BKMK_WhatIsAnAzureADTenant)de Azure AD.</span><span class="sxs-lookup"><span data-stu-id="83f9c-179">With the **Express** option Azure can automatically create an AAD application in your Azure AD [tenant](https://msdn.microsoft.com/en-us/library/azure/jj573650.aspx#BKMK_WhatIsAnAzureADTenant).</span></span> 
   
    <span data-ttu-id="83f9c-180">No es preciso que cree un inquilino, porque todas las cuenta de Azure tienen uno automáticamente.</span><span class="sxs-lookup"><span data-stu-id="83f9c-180">You don't have to create a tenant, because every Azure account automatically has one.</span></span>
7. <span data-ttu-id="83f9c-181">En **Modo de administración**, haga clic en **Crear nueva aplicación de AD** si aún no está seleccionado.</span><span class="sxs-lookup"><span data-stu-id="83f9c-181">Under **Management mode**, click **Create New AD App** if it isn't already selected.</span></span>
   
    <span data-ttu-id="83f9c-182">El portal conecta el cuadro de entrada **Crear aplicación** con un valor predeterminado.</span><span class="sxs-lookup"><span data-stu-id="83f9c-182">The portal plugs the **Create App** input box with a default value.</span></span> <span data-ttu-id="83f9c-183">De forma predeterminada, la aplicación de Azure AD recibe el mismo nombre que la aplicación de API.</span><span class="sxs-lookup"><span data-stu-id="83f9c-183">By default, the Azure AD application is named the same as the API app.</span></span> <span data-ttu-id="83f9c-184">Si lo prefiere, escriba un nombre diferente.</span><span class="sxs-lookup"><span data-stu-id="83f9c-184">If you prefer, you can enter a different name.</span></span>
   
    ![Configuración de Azure AD](./media/app-service-api-dotnet-service-principal-auth/aadsettings.png)
   
    <span data-ttu-id="83f9c-186">**Nota**: Como alternativa, podría usar una sola aplicación de Azure AD tanto para la aplicación de API que realiza la llamada como para la aplicación de API protegida.</span><span class="sxs-lookup"><span data-stu-id="83f9c-186">**Note**: As an alternative, you could use a single Azure AD application for both the calling API app and the protected API app.</span></span> <span data-ttu-id="83f9c-187">Si eligió esa alternativa, no necesitaría la opción **Crear nueva aplicación de AD** aquí porque ya creó antes una aplicación de Azure AD en el tutorial de autenticación de usuarios.</span><span class="sxs-lookup"><span data-stu-id="83f9c-187">If you chose that alternative, you would not need the **Create New AD App** option here because you already created an Azure AD application earlier in the user authentication tutorial.</span></span> <span data-ttu-id="83f9c-188">Para este tutorial, usará aplicaciones diferentes de Azure AD para la aplicación que realiza la llamada de API y la aplicación de API protegida.</span><span class="sxs-lookup"><span data-stu-id="83f9c-188">For this tutorial, you'll use separate Azure AD applications for the calling API app and the protected API app.</span></span>
8. <span data-ttu-id="83f9c-189">Anote el valor del cuadro de entrada **Crear aplicación** ; buscará esta aplicación AAD más adelante en el Portal de Azure clásico.</span><span class="sxs-lookup"><span data-stu-id="83f9c-189">Make a note of the value that is in the **Create App** input box; you'll look up this AAD application in the Azure classic portal later.</span></span>
9. <span data-ttu-id="83f9c-190">Haga clic en **OK**.</span><span class="sxs-lookup"><span data-stu-id="83f9c-190">Click **OK**.</span></span>
10. <span data-ttu-id="83f9c-191">En la hoja **Autenticación/autorización**, haga clic en **Guardar**.</span><span class="sxs-lookup"><span data-stu-id="83f9c-191">In the **Authentication / Authorization** blade, click **Save**.</span></span>
    
    ![Haga clic en Guardar](./media/app-service-api-dotnet-service-principal-auth/saveauth.png)
    
    <span data-ttu-id="83f9c-193">App Service crea una aplicación de Azure Active Directory con **URL de inicio de sesión** y **URL de respuesta** establecidas automáticamente en la URL de la aplicación de API.</span><span class="sxs-lookup"><span data-stu-id="83f9c-193">App Service creates an Azure Active Directory application with **Sign-on URL** and **Reply URL** automatically set to the URL of your API app.</span></span> <span data-ttu-id="83f9c-194">El último valor permite a los usuarios del inquilino de AAD iniciar sesión y tener acceso a la aplicación de API.</span><span class="sxs-lookup"><span data-stu-id="83f9c-194">The latter value enables users in your AAD tenant to log in and access the API app.</span></span>

### <a name="verify-that-the-api-app-is-protected"></a><span data-ttu-id="83f9c-195">Comprobación de la protección de la aplicación de API</span><span class="sxs-lookup"><span data-stu-id="83f9c-195">Verify that the API app is protected</span></span>
1. <span data-ttu-id="83f9c-196">En un explorador, vaya a la dirección URL de la aplicación de API: en la hoja **Aplicación de API** de Azure Portal, haga clic en el vínculo bajo **URL**.</span><span class="sxs-lookup"><span data-stu-id="83f9c-196">In a browser go to the URL of the API app: in the **API app** blade in the Azure portal, click the link under **URL**.</span></span> 
   
    <span data-ttu-id="83f9c-197">Se le redirigirá a una pantalla de inicio de sesión porque no se permite que las solicitudes no autenticadas tengan acceso a la aplicación de API.</span><span class="sxs-lookup"><span data-stu-id="83f9c-197">You are redirected to a login screen because unauthenticated requests are not allowed to reach the API app.</span></span> 
   
    <span data-ttu-id="83f9c-198">Si el explorador va a la interfaz de usuario de Swagger, es posible que el explorador ya iniciara sesión; en ese caso, abra una ventana de InPrivate o Incognito y vaya a la dirección URL de la interfaz de usuario de Swagger.</span><span class="sxs-lookup"><span data-stu-id="83f9c-198">If your browser does go to the Swagger UI, your browser might already be logged on -- in that case, open an InPrivate or Incognito window and go to the Swagger UI URL.</span></span>
2. <span data-ttu-id="83f9c-199">Inicie sesión con las credenciales de un usuario en su inquilino de AAD.</span><span class="sxs-lookup"><span data-stu-id="83f9c-199">Log in with credentials of a user in your AAD tenant.</span></span>
   
   <span data-ttu-id="83f9c-200">Una vez iniciada la sesión, en el explorador aparece una página que indica que "se creó correctamente".</span><span class="sxs-lookup"><span data-stu-id="83f9c-200">When you're logged on, the "successfully created" page appears in the browser.</span></span>

## <a name="configure-the-todolistapi-project-to-acquire-and-send-the-azure-ad-token"></a><span data-ttu-id="83f9c-201">Configuración del proyecto ToDoListAPI para adquirir y enviar el token de Azure AD</span><span class="sxs-lookup"><span data-stu-id="83f9c-201">Configure the ToDoListAPI project to acquire and send the Azure AD token</span></span>
<span data-ttu-id="83f9c-202">En esta sección realizará las siguientes tareas:</span><span class="sxs-lookup"><span data-stu-id="83f9c-202">In this section you do the following tasks:</span></span>

* <span data-ttu-id="83f9c-203">Agregar el código en la aplicación de API de nivel intermedio que usa credenciales de la aplicación de Azure AD para adquirir un token y enviarlo con las solicitudes HTTP a la aplicación de API de capa de datos.</span><span class="sxs-lookup"><span data-stu-id="83f9c-203">Add code in the middle tier API app that uses Azure AD application credentials to acquire a token and send it with HTTP requests to the data tier API app.</span></span>
* <span data-ttu-id="83f9c-204">Obtener las credenciales que necesita de Azure AD.</span><span class="sxs-lookup"><span data-stu-id="83f9c-204">Get the credentials you need from Azure AD.</span></span>
* <span data-ttu-id="83f9c-205">Escribir las credenciales en la configuración del entorno en tiempo de ejecución de Servicio de aplicaciones de Azure en la aplicación de API de nivel intermedio.</span><span class="sxs-lookup"><span data-stu-id="83f9c-205">Enter the credentials into Azure App Service runtime environment settings in the middle tier API app.</span></span> 

### <a name="configure-the-todolistapi-project-to-acquire-and-send-the-azure-ad-token"></a><span data-ttu-id="83f9c-206">Configuración del proyecto ToDoListAPI para adquirir y enviar el token de Azure AD</span><span class="sxs-lookup"><span data-stu-id="83f9c-206">Configure the ToDoListAPI project to acquire and send the Azure AD token</span></span>
<span data-ttu-id="83f9c-207">Realice los cambios siguientes en el proyecto ToDoListAPI en Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="83f9c-207">Make the following changes in the ToDoListAPI project in Visual Studio.</span></span>

1. <span data-ttu-id="83f9c-208">Quite las marcas de comentarios de todo el código en el archivo *ServicePrincipal.cs* .</span><span class="sxs-lookup"><span data-stu-id="83f9c-208">Uncomment all of the code in the *ServicePrincipal.cs* file.</span></span>
   
    <span data-ttu-id="83f9c-209">Este es el código que usa ADAL para .NET para adquirir el token de portador de Azure AD.</span><span class="sxs-lookup"><span data-stu-id="83f9c-209">This is the code that uses ADAL for .NET to acquire the Azure AD bearer token.</span></span>  <span data-ttu-id="83f9c-210">Usa varios valores de configuración que se establecerán más adelante en el entorno en tiempo de ejecución de Azure.</span><span class="sxs-lookup"><span data-stu-id="83f9c-210">It uses several configuration values that you'll set in the Azure runtime environment later.</span></span> <span data-ttu-id="83f9c-211">Este es el código:</span><span class="sxs-lookup"><span data-stu-id="83f9c-211">Here's the code:</span></span> 
   
        public static class ServicePrincipal
        {
            static string authority = ConfigurationManager.AppSettings["ida:Authority"];
            static string clientId = ConfigurationManager.AppSettings["ida:ClientId"];
            static string clientSecret = ConfigurationManager.AppSettings["ida:ClientSecret"];
            static string resource = ConfigurationManager.AppSettings["ida:Resource"];
   
            public static AuthenticationResult GetS2SAccessTokenForProdMSA()
            {
                return GetS2SAccessToken(authority, resource, clientId, clientSecret);
            }
   
            static AuthenticationResult GetS2SAccessToken(string authority, string resource, string clientId, string clientSecret)
            {
                var clientCredential = new ClientCredential(clientId, clientSecret);
                AuthenticationContext context = new AuthenticationContext(authority, false);
                AuthenticationResult authenticationResult = context.AcquireToken(
                    resource,
                    clientCredential);
                return authenticationResult;
            }
        }
   
    <span data-ttu-id="83f9c-212">**Nota:** Este código requiere ADAL para el paquete NuGet de .NET (Microsoft.IdentityModel.Clients.ActiveDirectory), que ya está instalado en el proyecto.</span><span class="sxs-lookup"><span data-stu-id="83f9c-212">**Note:** This code requires the ADAL for .NET NuGet package (Microsoft.IdentityModel.Clients.ActiveDirectory), which is already installed in the project.</span></span> <span data-ttu-id="83f9c-213">Si estuviese creando este proyecto desde cero, tendría que instalar este paquete.</span><span class="sxs-lookup"><span data-stu-id="83f9c-213">If you were creating this project from scratch, you would have to install this package.</span></span> <span data-ttu-id="83f9c-214">La plantilla de nuevo proyecto de aplicación de API no instala este paquete automáticamente.</span><span class="sxs-lookup"><span data-stu-id="83f9c-214">This package is not automatically installed by the API app new-project template.</span></span>
2. <span data-ttu-id="83f9c-215">En *Controllers/ToDoListController*, quite las marcas de comentarios del código en el método `NewDataAPIClient` que agrega el token a las solicitudes HTTP en el encabezado de autorización.</span><span class="sxs-lookup"><span data-stu-id="83f9c-215">In *Controllers/ToDoListController*, uncomment the code in the `NewDataAPIClient` method that adds the token to HTTP requests in the authorization header.</span></span>
   
        client.HttpClient.DefaultRequestHeaders.Authorization =
            new AuthenticationHeaderValue("Bearer", ServicePrincipal.GetS2SAccessTokenForProdMSA().AccessToken);
3. <span data-ttu-id="83f9c-216">Implemente el proyecto ToDoListAPI.</span><span class="sxs-lookup"><span data-stu-id="83f9c-216">Deploy the ToDoListAPI project.</span></span> <span data-ttu-id="83f9c-217">(Haga clic con el botón derecho en el proyecto y haga clic en **Publicar > Publicar**).</span><span class="sxs-lookup"><span data-stu-id="83f9c-217">(Right-click the project, then click **Publish > Publish**.)</span></span>
   
    <span data-ttu-id="83f9c-218">Visual Studio implementa el proyecto y abre un explorador en la dirección URL base de la aplicación web.</span><span class="sxs-lookup"><span data-stu-id="83f9c-218">Visual Studio deploys the project and opens a browser to the web app's base URL.</span></span> <span data-ttu-id="83f9c-219">Esto mostrará una página de error 403, lo que es normal cuando se intenta ir a una dirección URL base de Web API desde un explorador.</span><span class="sxs-lookup"><span data-stu-id="83f9c-219">This will show a 403 error page, which is normal for an attempt to go to a Web API base URL from a browser.</span></span>
4. <span data-ttu-id="83f9c-220">Cierre el explorador.</span><span class="sxs-lookup"><span data-stu-id="83f9c-220">Close the browser.</span></span>

### <a name="get-azure-ad-configuration-values"></a><span data-ttu-id="83f9c-221">Obtención de los valores de configuración de Azure AD</span><span class="sxs-lookup"><span data-stu-id="83f9c-221">Get Azure AD configuration values</span></span>
1. <span data-ttu-id="83f9c-222">En el [Portal de Azure clásico](https://manage.windowsazure.com/), vaya a **Azure Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="83f9c-222">In the [Azure classic portal](https://manage.windowsazure.com/), go to **Azure Active Directory**.</span></span>
2. <span data-ttu-id="83f9c-223">En la pestaña **Directorio** , haga clic en su inquilino de AAD.</span><span class="sxs-lookup"><span data-stu-id="83f9c-223">On the **Directory** tab, click your AAD tenant.</span></span>
3. <span data-ttu-id="83f9c-224">Haga clic en **Aplicaciones > Aplicación propiedad de mi compañía** y, después, en la marca de verificación.</span><span class="sxs-lookup"><span data-stu-id="83f9c-224">Click **Applications > Applications my company owns**, and then click the check mark.</span></span>
4. <span data-ttu-id="83f9c-225">En la lista de aplicaciones, haga clic en el nombre de la que Azure creó automáticamente cuando habilitó la autenticación para la aplicación de API ToDoListDataAPI (capa de datos).</span><span class="sxs-lookup"><span data-stu-id="83f9c-225">In the list of applications, click the name of the one that Azure created for you when you enabled authentication for the ToDoListDataAPI (data tier) API app.</span></span>
5. <span data-ttu-id="83f9c-226">Haga clic en la pestaña **Configurar** .</span><span class="sxs-lookup"><span data-stu-id="83f9c-226">Click the **Configure** tab.</span></span>
6. <span data-ttu-id="83f9c-227">Copie el valor de **Id. de cliente** y guárdelo en un lugar de donde pueda recuperarlo más adelante.</span><span class="sxs-lookup"><span data-stu-id="83f9c-227">Copy the **Client ID** value and save it someplace you can get it from later.</span></span> 
7. <span data-ttu-id="83f9c-228">En el Portal de Azure clásico, vuelva a la lista **Aplicaciones que tiene mi compañía**y haga clic en la aplicación AAD que creó para la aplicación de API ToDoListAPI de nivel intermedio (la que creó en el tutorial anterior, no la que ha creado en este tutorial).</span><span class="sxs-lookup"><span data-stu-id="83f9c-228">In the Azure classic portal go back to the list of **Applications my company owns**, and click the AAD application that you created for the middle tier ToDoListAPI API app (the one you created in the previous tutorial, not the one you created in this tutorial).</span></span>
8. <span data-ttu-id="83f9c-229">Haga clic en la pestaña **Configurar** .</span><span class="sxs-lookup"><span data-stu-id="83f9c-229">Click the **Configure** tab.</span></span>
9. <span data-ttu-id="83f9c-230">Copie el valor de **Id. de cliente** y guárdelo en un lugar de donde pueda recuperarlo más adelante.</span><span class="sxs-lookup"><span data-stu-id="83f9c-230">Copy the **Client ID** value and save it someplace you can get it from later.</span></span>
10. <span data-ttu-id="83f9c-231">En **Claves**, seleccione **1 año** en la lista desplegable **Seleccionar duración**.</span><span class="sxs-lookup"><span data-stu-id="83f9c-231">Under **keys**, select **1 year** from the **Select duration** drop-down list.</span></span>
11. <span data-ttu-id="83f9c-232">Haga clic en **Guardar**.</span><span class="sxs-lookup"><span data-stu-id="83f9c-232">Click **Save**.</span></span>
    
     ![Generar clave de aplicación](./media/app-service-api-dotnet-service-principal-auth/genkey.png)
12. <span data-ttu-id="83f9c-234">Copie el valor de clave y guárdelo en un lugar donde pueda recuperarlo más adelante.</span><span class="sxs-lookup"><span data-stu-id="83f9c-234">Copy the key value and save it someplace you can get it from later.</span></span>
    
     ![Copiar la nueva clave de aplicación](./media/app-service-api-dotnet-service-principal-auth/genkeycopy.png)

### <a name="configure-azure-ad-settings-in-the-middle-tier-api-apps-runtime-environment"></a><span data-ttu-id="83f9c-236">Configuración de opciones de Azure AD en el entorno en tiempo de ejecución de la aplicación de API de nivel intermedio</span><span class="sxs-lookup"><span data-stu-id="83f9c-236">Configure Azure AD settings in the middle tier API app's runtime environment</span></span>
1. <span data-ttu-id="83f9c-237">Vaya al [Portal de Azure](https://portal.azure.com/)y, después, vaya a la hoja **Aplicación de API** de la aplicación de API que hospeda el proyecto TodoListAPI (nivel intermedio).</span><span class="sxs-lookup"><span data-stu-id="83f9c-237">Go to the [Azure portal](https://portal.azure.com/), and then navigate to the **API App** blade for the API app that hosts the TodoListAPI (middle tier) project.</span></span>
2. <span data-ttu-id="83f9c-238">Haga clic en **Configuración > Configuración de la aplicación**.</span><span class="sxs-lookup"><span data-stu-id="83f9c-238">Click **Settings > Application Settings**.</span></span>
3. <span data-ttu-id="83f9c-239">En la sección **Configuración de la aplicación** , agregue las claves y los valores siguientes:</span><span class="sxs-lookup"><span data-stu-id="83f9c-239">In the **App settings** section, add the following keys and values:</span></span>
   
   | <span data-ttu-id="83f9c-240">**Clave**</span><span class="sxs-lookup"><span data-stu-id="83f9c-240">**Key**</span></span> | <span data-ttu-id="83f9c-241">ida:Authority</span><span class="sxs-lookup"><span data-stu-id="83f9c-241">ida:Authority</span></span> |
   | --- | --- |
   | <span data-ttu-id="83f9c-242">**Valor**</span><span class="sxs-lookup"><span data-stu-id="83f9c-242">**Value**</span></span> |<span data-ttu-id="83f9c-243">https://login.microsoftonline.com/{su nombre de inquilino de Azure AD}</span><span class="sxs-lookup"><span data-stu-id="83f9c-243">https://login.microsoftonline.com/{your Azure AD tenant name}</span></span> |
   | <span data-ttu-id="83f9c-244">**Ejemplo**</span><span class="sxs-lookup"><span data-stu-id="83f9c-244">**Example**</span></span> |<span data-ttu-id="83f9c-245">https://login.microsoftonline.com/contoso.onmicrosoft.com</span><span class="sxs-lookup"><span data-stu-id="83f9c-245">https://login.microsoftonline.com/contoso.onmicrosoft.com</span></span> |
   
   | <span data-ttu-id="83f9c-246">**Clave**</span><span class="sxs-lookup"><span data-stu-id="83f9c-246">**Key**</span></span> | <span data-ttu-id="83f9c-247">ida:ClientId</span><span class="sxs-lookup"><span data-stu-id="83f9c-247">ida:ClientId</span></span> |
   | --- | --- |
   | <span data-ttu-id="83f9c-248">**Valor**</span><span class="sxs-lookup"><span data-stu-id="83f9c-248">**Value**</span></span> |<span data-ttu-id="83f9c-249">Id. de cliente de la aplicación que realiza la llamada (nivel intermedio, ToDoListAPI)</span><span class="sxs-lookup"><span data-stu-id="83f9c-249">Client ID of the calling application (middle tier - ToDoListAPI)</span></span> |
   | <span data-ttu-id="83f9c-250">**Ejemplo**</span><span class="sxs-lookup"><span data-stu-id="83f9c-250">**Example**</span></span> |<span data-ttu-id="83f9c-251">960adec2-b74a-484a-960adec2-b74a-484a</span><span class="sxs-lookup"><span data-stu-id="83f9c-251">960adec2-b74a-484a-960adec2-b74a-484a</span></span> |
   
   | <span data-ttu-id="83f9c-252">**Clave**</span><span class="sxs-lookup"><span data-stu-id="83f9c-252">**Key**</span></span> | <span data-ttu-id="83f9c-253">ida:ClientSecret</span><span class="sxs-lookup"><span data-stu-id="83f9c-253">ida:ClientSecret</span></span> |
   | --- | --- |
   | <span data-ttu-id="83f9c-254">**Valor**</span><span class="sxs-lookup"><span data-stu-id="83f9c-254">**Value**</span></span> |<span data-ttu-id="83f9c-255">Clave de aplicación de la aplicación que realiza la llamada (nivel intermedio, ToDoListAPI)</span><span class="sxs-lookup"><span data-stu-id="83f9c-255">App key of the calling application (middle tier - ToDoListAPI)</span></span> |
   | <span data-ttu-id="83f9c-256">**Ejemplo**</span><span class="sxs-lookup"><span data-stu-id="83f9c-256">**Example**</span></span> |<span data-ttu-id="83f9c-257">e65e8fc9-5f6b-48e8-e65e8fc9-5f6b-48e8</span><span class="sxs-lookup"><span data-stu-id="83f9c-257">e65e8fc9-5f6b-48e8-e65e8fc9-5f6b-48e8</span></span> |
   
   | <span data-ttu-id="83f9c-258">**Clave**</span><span class="sxs-lookup"><span data-stu-id="83f9c-258">**Key**</span></span> | <span data-ttu-id="83f9c-259">ida:Resource</span><span class="sxs-lookup"><span data-stu-id="83f9c-259">ida:Resource</span></span> |
   | --- | --- |
   | <span data-ttu-id="83f9c-260">**Valor**</span><span class="sxs-lookup"><span data-stu-id="83f9c-260">**Value**</span></span> |<span data-ttu-id="83f9c-261">Id. de cliente de la aplicación a la que se llama (capa de datos, ToDoListDataAPI)</span><span class="sxs-lookup"><span data-stu-id="83f9c-261">Client ID of the called application (data tier - ToDoListDataAPI)</span></span> |
   | <span data-ttu-id="83f9c-262">**Ejemplo**</span><span class="sxs-lookup"><span data-stu-id="83f9c-262">**Example**</span></span> |<span data-ttu-id="83f9c-263">e65e8fc9-5f6b-48e8-e65e8fc9-5f6b-48e8</span><span class="sxs-lookup"><span data-stu-id="83f9c-263">e65e8fc9-5f6b-48e8-e65e8fc9-5f6b-48e8</span></span> |
   
    <span data-ttu-id="83f9c-264">**Nota**: Para `ida:Resource`, asegúrese de utilizar el **Id. de cliente** de la aplicación a la que se llama y no su **URI de id. de aplicación**.</span><span class="sxs-lookup"><span data-stu-id="83f9c-264">**Note**: For `ida:Resource`, make sure you use the called application's **client ID** and not its **App ID URI**.</span></span>
   
    <span data-ttu-id="83f9c-265">`ida:ClientId` e `ida:Resource` son diferentes valores en este tutorial porque está utilizando aplicaciones de Azure AD distintas para el nivel intermedio y la capa de datos.</span><span class="sxs-lookup"><span data-stu-id="83f9c-265">`ida:ClientId` and `ida:Resource` are different values for this tutorial because you're using separate Azure AD applicaations for the middle tier and data tier.</span></span> <span data-ttu-id="83f9c-266">Si usara una sola aplicación de Azure AD para la aplicación de API que realiza la llamada y la aplicación de API protegida, utilizaría el mismo valor tanto en `ida:ClientId` como en `ida:Resource`.</span><span class="sxs-lookup"><span data-stu-id="83f9c-266">If you were using a single Azure AD application for the calling API app and the protected API app, you would use the same value in both `ida:ClientId` and `ida:Resource`.</span></span>
   
    <span data-ttu-id="83f9c-267">El código usa ConfigurationManager para obtener estos valores, por lo que podría almacenarse en el archivo Web.config del proyecto o en el entorno en tiempo de ejecución de Azure.</span><span class="sxs-lookup"><span data-stu-id="83f9c-267">The code uses ConfigurationManager to get these values, so they could be stored in the project's Web.config file or in the Azure runtime environment.</span></span> <span data-ttu-id="83f9c-268">Mientras se ejecuta una aplicación ASP.NET en el Servicio de aplicaciones de Azure, la configuración del entorno invalida automáticamente la configuración de Web.config.</span><span class="sxs-lookup"><span data-stu-id="83f9c-268">While an ASP.NET application is running in Azure App Service, environment settings automatically override settings from Web.config.</span></span> <span data-ttu-id="83f9c-269">La configuración del entorno suele ser una [manera más segura de almacenar información confidencial en comparación con un archivo Web.config](http://www.asp.net/identity/overview/features-api/best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure).</span><span class="sxs-lookup"><span data-stu-id="83f9c-269">Environment settings are generally a [more secure way to store sensitive information compared to a Web.config file](http://www.asp.net/identity/overview/features-api/best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure).</span></span>
4. <span data-ttu-id="83f9c-270">Haga clic en **Guardar**.</span><span class="sxs-lookup"><span data-stu-id="83f9c-270">Click **Save**.</span></span>
   
    ![Haga clic en Guardar](./media/app-service-api-dotnet-service-principal-auth/appsettings.png)

### <a name="test-the-application"></a><span data-ttu-id="83f9c-272">Prueba de la aplicación</span><span class="sxs-lookup"><span data-stu-id="83f9c-272">Test the application</span></span>
1. <span data-ttu-id="83f9c-273">En un explorador, vaya a la dirección URL HTTPS de la aplicación web de front-end AngularJS.</span><span class="sxs-lookup"><span data-stu-id="83f9c-273">In a browser go to the HTTPS URL of the AngularJS front end web app.</span></span>
2. <span data-ttu-id="83f9c-274">Haga clic en la pestaña **To Do List** (Lista de tareas pendientes) e inicie sesión con las credenciales de un usuario en el inquilino de Azure AD.</span><span class="sxs-lookup"><span data-stu-id="83f9c-274">Click the **To Do List** tab and log in with credentials for a user in your Azure AD tenant.</span></span> 
3. <span data-ttu-id="83f9c-275">Agregue elementos de tareas pendientes para comprobar que la aplicación funciona.</span><span class="sxs-lookup"><span data-stu-id="83f9c-275">Add to-do items to verify that the application is working.</span></span>
   
    ![Página de Lista de tareas pendientes](./media/app-service-api-dotnet-service-principal-auth/mvchome.png)
   
    <span data-ttu-id="83f9c-277">Si la aplicación no funciona como se espera, vuelva a comprobar todos los valores que escribió en el Portal de Azure.</span><span class="sxs-lookup"><span data-stu-id="83f9c-277">If the application doesn't work as expected, double-check all of the settings you entered in the Azure portal.</span></span> <span data-ttu-id="83f9c-278">Si toda la configuración parece ser correcta, consulte la sección [Solución de problemas](#troubleshooting) más adelante en este tutorial.</span><span class="sxs-lookup"><span data-stu-id="83f9c-278">If all of the settings appear to be correct, see the [Troubleshooting](#troubleshooting) section later in this tutorial.</span></span>

## <a name="protect-the-api-app-from-browser-access"></a><span data-ttu-id="83f9c-279">Protección de la aplicación de API contra el acceso desde el explorador</span><span class="sxs-lookup"><span data-stu-id="83f9c-279">Protect the API app from browser access</span></span>
<span data-ttu-id="83f9c-280">Para este tutorial, creó una aplicación de Azure AD independiente para la aplicación de API ToDoListDataAPI (capa de datos).</span><span class="sxs-lookup"><span data-stu-id="83f9c-280">For this tutorial you created a separate Azure AD application for the ToDoListDataAPI (data tier) API app.</span></span> <span data-ttu-id="83f9c-281">Como hemos visto, cuando el Servicio de aplicaciones crea una aplicación AAD, la configura de manera que permite a un usuario ir a la dirección URL de la aplicación de API en un explorador e iniciar sesión.</span><span class="sxs-lookup"><span data-stu-id="83f9c-281">As you've seen, when App Service creates an AAD application, it configures the AAD application in a way that enables a user to go to the API app's URL in a browser and log on.</span></span> <span data-ttu-id="83f9c-282">Esto significa no solo una entidad de servicio puede tener acceso a la API, también un usuario final de su inquilino de Azure AD.</span><span class="sxs-lookup"><span data-stu-id="83f9c-282">That means it's possible for an end user in your Azure AD tenant, not just a service principal, to access the API.</span></span> 

<span data-ttu-id="83f9c-283">Si quiere impedir el acceso desde el explorador sin escribir ningún código en la aplicación de API protegida, puede cambiar la **URL de respuesta** en la aplicación AAD para que sea diferente de la dirección URL base de la aplicación de API.</span><span class="sxs-lookup"><span data-stu-id="83f9c-283">If you want to prevent browser access without writing any code in the protected API app, you can change the **Reply URL** in the AAD application so that it's different from the API app's base URL.</span></span> 

### <a name="disable-browser-access"></a><span data-ttu-id="83f9c-284">Deshabilitación del acceso desde el explorador</span><span class="sxs-lookup"><span data-stu-id="83f9c-284">Disable browser access</span></span>
1. <span data-ttu-id="83f9c-285">En la pestaña **Configurar** del portal clásico de la aplicación AAD que se creó para TodoListService, modifique el valor del campo **URL de respuesta** para que sea una dirección URL válida, pero no la URL de la aplicación de API.</span><span class="sxs-lookup"><span data-stu-id="83f9c-285">In the classic portal's **Configure** tab for the AAD application that was created for the TodoListService, change the value in the **Reply URL** field so that it is a valid URL but not the API app's URL.</span></span>
2. <span data-ttu-id="83f9c-286">Haga clic en **Guardar**.</span><span class="sxs-lookup"><span data-stu-id="83f9c-286">Click **Save**.</span></span>

### <a name="verify-browser-access-no-longer-works"></a><span data-ttu-id="83f9c-287">Comprobación de que el acceso desde el explorador ya no funciona</span><span class="sxs-lookup"><span data-stu-id="83f9c-287">Verify browser access no longer works</span></span>
<span data-ttu-id="83f9c-288">Antes comprobó que puede ir a la URL de la aplicación de API desde un explorador iniciando sesión con las credenciales de un usuario individual.</span><span class="sxs-lookup"><span data-stu-id="83f9c-288">Earlier you verified that you can go to the API app URL from a browser by logging on with an individual user's credentials.</span></span> <span data-ttu-id="83f9c-289">En esta sección, comprobará que ya no es posible.</span><span class="sxs-lookup"><span data-stu-id="83f9c-289">In this section, you verify that this is no longer possible.</span></span> 

1. <span data-ttu-id="83f9c-290">En una nueva ventana del explorador, vaya de nuevo a la dirección URL de la aplicación de API.</span><span class="sxs-lookup"><span data-stu-id="83f9c-290">In a new browser window, go to the URL of the API app again.</span></span>
2. <span data-ttu-id="83f9c-291">Inicie la sesión cuando se le solicite.</span><span class="sxs-lookup"><span data-stu-id="83f9c-291">Log in when prompted to do so.</span></span>
3. <span data-ttu-id="83f9c-292">El inicio de sesión se realiza correctamente, pero genera una página de error.</span><span class="sxs-lookup"><span data-stu-id="83f9c-292">Login succeeds but leads to an error page.</span></span>
   
    <span data-ttu-id="83f9c-293">Configuró la aplicación AAD para que los usuarios del inquilino de AAD no puedan iniciar sesión ni acceder a la API desde un explorador.</span><span class="sxs-lookup"><span data-stu-id="83f9c-293">You've configured the AAD app so that users in the AAD tenant cannot log in and access the API from a browser.</span></span> <span data-ttu-id="83f9c-294">Aún puede acceder a la aplicación de API con un token de entidad de servicio; para comprobarlo, vaya a la URL de la aplicación web y agregue más elementos de tareas pendientes.</span><span class="sxs-lookup"><span data-stu-id="83f9c-294">You can still access the API app by using a service principal token, which you can verify by going to the web app's URL and adding more to-do items.</span></span>

## <a name="restrict-access-to-a-particular-service-principal"></a><span data-ttu-id="83f9c-295">Restricción del acceso a una entidad de servicio determinada</span><span class="sxs-lookup"><span data-stu-id="83f9c-295">Restrict access to a particular service principal</span></span>
<span data-ttu-id="83f9c-296">En este momento, cualquier llamador que pueda obtener un token para un usuario o entidad de servicio del inquilino de Azure AD puede llamar a la aplicación de API TodoListDataAPI (capa de datos).</span><span class="sxs-lookup"><span data-stu-id="83f9c-296">Right now, any caller that can get a token for a user or service principal in your Azure AD tenant can call the TodoListDataAPI (data tier) API app.</span></span> <span data-ttu-id="83f9c-297">Puede que quiera asegurarse de que la aplicación de API de capa de datos solo acepta llamadas de la aplicación de API TodoListAPI (nivel intermedio) y solo de una entidad de servicio determinada.</span><span class="sxs-lookup"><span data-stu-id="83f9c-297">You might want to make sure that the data tier API app only accepts calls from the TodoListAPI (middle tier) API app, and only from a particular service principal.</span></span> 

<span data-ttu-id="83f9c-298">Para agregar estas restricciones, puede agregar código para validar las notificaciones de `appid` y `objectidentifier` en las llamadas entrantes.</span><span class="sxs-lookup"><span data-stu-id="83f9c-298">You can add these restrictions by adding code to validate the `appid` and `objectidentifier` claims on incoming calls.</span></span>

<span data-ttu-id="83f9c-299">Para este tutorial, coloque código que valida el identificador de la aplicación y el identificador de la entidad de servicio directamente en las acciones de controlador.</span><span class="sxs-lookup"><span data-stu-id="83f9c-299">For this tutorial you put the code that validates app ID and service principal ID directly in your controller actions.</span></span>  <span data-ttu-id="83f9c-300">Las alternativas son utilizar un atributo `Authorize` personalizado o realizar esta validación en las secuencias de inicio (por ejemplo, middleware OWIN).</span><span class="sxs-lookup"><span data-stu-id="83f9c-300">Alternatives are to use a custom `Authorize` attribute or to do this validation in your startup sequences (e.g. OWIN middleware).</span></span> <span data-ttu-id="83f9c-301">Para ver un ejemplo de esto último, consulte [esta aplicación de ejemplo](https://github.com/mohitsriv/EasyAuthMultiTierSample/blob/master/MyDashDataAPI/Startup.cs).</span><span class="sxs-lookup"><span data-stu-id="83f9c-301">For an example of the latter, see [this sample application](https://github.com/mohitsriv/EasyAuthMultiTierSample/blob/master/MyDashDataAPI/Startup.cs).</span></span> 

<span data-ttu-id="83f9c-302">Realice los cambios siguientes en el proyecto TodoListDataAPI.</span><span class="sxs-lookup"><span data-stu-id="83f9c-302">Make the following changes to the TodoListDataAPI project.</span></span>

1. <span data-ttu-id="83f9c-303">Abra el archivo *Controllers/TodoListController.cs* .</span><span class="sxs-lookup"><span data-stu-id="83f9c-303">Open the *Controllers/TodoListController.cs* file.</span></span>
2. <span data-ttu-id="83f9c-304">Quite las marcas de comentarios de las líneas que establecen `trustedCallerClientId` y `trustedCallerServicePrincipalId`.</span><span class="sxs-lookup"><span data-stu-id="83f9c-304">Uncomment the lines that set `trustedCallerClientId` and `trustedCallerServicePrincipalId`.</span></span>
   
        private static string trustedCallerClientId = ConfigurationManager.AppSettings["todo:TrustedCallerClientId"];
        private static string trustedCallerServicePrincipalId = ConfigurationManager.AppSettings["todo:TrustedCallerServicePrincipalId"];
3. <span data-ttu-id="83f9c-305">Quite los comentarios del código en el método CheckCallerId.</span><span class="sxs-lookup"><span data-stu-id="83f9c-305">Uncomment the code in the CheckCallerId method.</span></span> <span data-ttu-id="83f9c-306">Este método se llama al principio de cada método de acción en el controlador.</span><span class="sxs-lookup"><span data-stu-id="83f9c-306">This method is called at the start of every action method in the controller.</span></span> 
   
        private static void CheckCallerId()
        {
            string currentCallerClientId = ClaimsPrincipal.Current.FindFirst("appid").Value;
            string currentCallerServicePrincipalId = ClaimsPrincipal.Current.FindFirst("http://schemas.microsoft.com/identity/claims/objectidentifier").Value;
            if (currentCallerClientId != trustedCallerClientId || currentCallerServicePrincipalId != trustedCallerServicePrincipalId)
            {
                throw new HttpResponseException(new HttpResponseMessage { StatusCode = HttpStatusCode.Unauthorized, ReasonPhrase = "The appID or service principal ID is not the expected value." });
            }
        }
4. <span data-ttu-id="83f9c-307">Vuelva a implementar el proyecto ToDoListDataAPI en el Servicio de aplicaciones de Azure.</span><span class="sxs-lookup"><span data-stu-id="83f9c-307">Redeploy the ToDoListDataAPI project to Azure App Service.</span></span>
5. <span data-ttu-id="83f9c-308">En el explorador, vaya a la dirección URL HTTPS de la aplicación web front-end de AngularJS y, en la página principal, haga clic en la pestaña **To Do List** (Lista de tareas pendientes).</span><span class="sxs-lookup"><span data-stu-id="83f9c-308">In your browser, go to the AngularJS front end web app's HTTPS URL, and in the home page click the **To Do List** tab.</span></span>
   
    <span data-ttu-id="83f9c-309">La aplicación no funciona porque se producen errores en llamadas al back-end.</span><span class="sxs-lookup"><span data-stu-id="83f9c-309">The application doesn't work because calls to the back end are failing.</span></span> <span data-ttu-id="83f9c-310">El nuevo código está comprobando los valores reales de appid y objectidentifier pero todavía no tiene los valores correctos con los que compararlos.</span><span class="sxs-lookup"><span data-stu-id="83f9c-310">The new code is checking actual appid and objectidentifier but it doesn't yet have the correct values to check them against.</span></span> <span data-ttu-id="83f9c-311">La consola de herramientas para desarrolladores del explorador informa de que el servidor devuelve un error HTTP 401.</span><span class="sxs-lookup"><span data-stu-id="83f9c-311">The browser Developer Tools Console reports that the server is returning an HTTP 401 error.</span></span>
   
    ![Error en la Consola de Developer Tools](./media/app-service-api-dotnet-service-principal-auth/webapperror.png)
   
    <span data-ttu-id="83f9c-313">En los pasos siguientes configurará los valores esperados.</span><span class="sxs-lookup"><span data-stu-id="83f9c-313">In the following steps you configure the expected values.</span></span>
6. <span data-ttu-id="83f9c-314">Con Azure AD PowerShell, obtenga el valor de la entidad de servicio para la aplicación de Azure AD que creó para el proyecto TodoListWebApp.</span><span class="sxs-lookup"><span data-stu-id="83f9c-314">Using Azure AD PowerShell, get the value of the service principal for the Azure AD application that you created for the TodoListWebApp project.</span></span>
   
    <span data-ttu-id="83f9c-315">a.</span><span class="sxs-lookup"><span data-stu-id="83f9c-315">a.</span></span> <span data-ttu-id="83f9c-316">Para obtener instrucciones sobre cómo instalar Azure PowerShell y conectarse a su suscripción, consulte [Uso de Azure PowerShell con Azure Resource Manager](../powershell-azure-resource-manager.md).</span><span class="sxs-lookup"><span data-stu-id="83f9c-316">For instructions on how to install Azure PowerShell and connect to your subscription, see [Using Azure PowerShell with Azure Resource Manager](../powershell-azure-resource-manager.md).</span></span>
   
    <span data-ttu-id="83f9c-317">b.</span><span class="sxs-lookup"><span data-stu-id="83f9c-317">b.</span></span> <span data-ttu-id="83f9c-318">Para ver una lista de entidades de servicio, ejecute el comando `Login-AzureRmAccount` y luego el comando `Get-AzureRmADServicePrincipal`.</span><span class="sxs-lookup"><span data-stu-id="83f9c-318">To get a list of service principals, execute the `Login-AzureRmAccount` command and then the `Get-AzureRmADServicePrincipal` command.</span></span>
   
    <span data-ttu-id="83f9c-319">c.</span><span class="sxs-lookup"><span data-stu-id="83f9c-319">c.</span></span> <span data-ttu-id="83f9c-320">Busque el valor de objectid para la entidad de servicio de la aplicación TodoListAPI y guárdelo en una ubicación que pueda copiar más adelante.</span><span class="sxs-lookup"><span data-stu-id="83f9c-320">Find the objectid for the service principal of the TodoListAPI application, and save it in a location you can copy from later.</span></span>
7. <span data-ttu-id="83f9c-321">En el Portal de Azure, vaya a la hoja de la aplicación de API correspondiente a la aplicación de API en la que implementó el proyecto ToDoListDataAPI.</span><span class="sxs-lookup"><span data-stu-id="83f9c-321">In the Azure portal, navigate to the API app blade for the API app that you deployed the ToDoListDataAPI project to.</span></span>
8. <span data-ttu-id="83f9c-322">Haga clic en **Configuración > Configuración de la aplicación**.</span><span class="sxs-lookup"><span data-stu-id="83f9c-322">Click **Settings > Application settings**.</span></span>
9. <span data-ttu-id="83f9c-323">En la sección **Configuración de la aplicación** , agregue las claves y los valores siguientes:</span><span class="sxs-lookup"><span data-stu-id="83f9c-323">In the **App settings** section, add the following keys and values:</span></span>
   
   | <span data-ttu-id="83f9c-324">**Clave**</span><span class="sxs-lookup"><span data-stu-id="83f9c-324">**Key**</span></span> | <span data-ttu-id="83f9c-325">todo:TrustedCallerServicePrincipalId</span><span class="sxs-lookup"><span data-stu-id="83f9c-325">todo:TrustedCallerServicePrincipalId</span></span> |
   | --- | --- |
   | <span data-ttu-id="83f9c-326">**Valor**</span><span class="sxs-lookup"><span data-stu-id="83f9c-326">**Value**</span></span> |<span data-ttu-id="83f9c-327">Id. de entidad de servicio de la aplicación que realiza la llamada</span><span class="sxs-lookup"><span data-stu-id="83f9c-327">Service principal id of calling application</span></span> |
   | <span data-ttu-id="83f9c-328">**Ejemplo**</span><span class="sxs-lookup"><span data-stu-id="83f9c-328">**Example**</span></span> |<span data-ttu-id="83f9c-329">4f4a94a4-6f0d-4072-4f4a94a4-6f0d-4072</span><span class="sxs-lookup"><span data-stu-id="83f9c-329">4f4a94a4-6f0d-4072-4f4a94a4-6f0d-4072</span></span> |
   
   | <span data-ttu-id="83f9c-330">**Clave**</span><span class="sxs-lookup"><span data-stu-id="83f9c-330">**Key**</span></span> | <span data-ttu-id="83f9c-331">todo:TrustedCallerClientId</span><span class="sxs-lookup"><span data-stu-id="83f9c-331">todo:TrustedCallerClientId</span></span> |
   | --- | --- |
   | <span data-ttu-id="83f9c-332">**Valor**</span><span class="sxs-lookup"><span data-stu-id="83f9c-332">**Value**</span></span> |<span data-ttu-id="83f9c-333">Id. de cliente de la aplicación que realiza la llamada: copiado de la aplicación TodoListAPI de Azure AD</span><span class="sxs-lookup"><span data-stu-id="83f9c-333">Client ID of calling application - copied from the TodoListAPI Azure AD application</span></span> |
   | <span data-ttu-id="83f9c-334">**Ejemplo**</span><span class="sxs-lookup"><span data-stu-id="83f9c-334">**Example**</span></span> |<span data-ttu-id="83f9c-335">960adec2-b74a-484a-960adec2-b74a-484a</span><span class="sxs-lookup"><span data-stu-id="83f9c-335">960adec2-b74a-484a-960adec2-b74a-484a</span></span> |
10. <span data-ttu-id="83f9c-336">Haga clic en **Guardar**.</span><span class="sxs-lookup"><span data-stu-id="83f9c-336">Click **Save**.</span></span>
    
     ![Haga clic en Guardar](./media/app-service-api-dotnet-service-principal-auth/trustedcaller.png)
11. <span data-ttu-id="83f9c-338">En el explorador, vuelva a la dirección URL de la aplicación web y, en la página principal, haga clic en la pestaña **To Do List** (Lista de tareas pendientes).</span><span class="sxs-lookup"><span data-stu-id="83f9c-338">In your browser, return to the web app's URL, and in the home page click the **To Do List** tab.</span></span>
    
     <span data-ttu-id="83f9c-339">Esta vez la aplicación funciona según lo esperado porque el identificador de la aplicación que realiza la llamada y el identificador de entidad de servicio son los valores esperados.</span><span class="sxs-lookup"><span data-stu-id="83f9c-339">This time the application works as expected because the trusted caller app ID and service principal ID are the expected values.</span></span>
    
     ![Página de Lista de tareas pendientes](./media/app-service-api-dotnet-service-principal-auth/mvchome.png)

## <a name="building-the-projects-from-scratch"></a><span data-ttu-id="83f9c-341">Creación de los proyectos desde cero</span><span class="sxs-lookup"><span data-stu-id="83f9c-341">Building the projects from scratch</span></span>
<span data-ttu-id="83f9c-342">Los dos proyectos de Web API se crearon con la plantilla de proyecto **Aplicación de API de Azure** y reemplazando el controlador de los valores predeterminados por un controlador de ToDoList.</span><span class="sxs-lookup"><span data-stu-id="83f9c-342">The two Web API projects were created by using the **Azure API App** project template and replacing the default Values controller with a ToDoList controller.</span></span> <span data-ttu-id="83f9c-343">Para adquirir los tokens de entidad de servicio de Azure AD en el proyecto ToDoListAPI, se instaló el paquete NuGet [Biblioteca de autenticación de Active Directory (ADAL) para .NET](https://www.nuget.org/packages/Microsoft.IdentityModel.Clients.ActiveDirectory/) .</span><span class="sxs-lookup"><span data-stu-id="83f9c-343">For acquiring Azure AD service principal tokens in the ToDoListAPI project, the [Active Directory Authentication Library (ADAL) for .NET](https://www.nuget.org/packages/Microsoft.IdentityModel.Clients.ActiveDirectory/) NuGet package was installed.</span></span>

<span data-ttu-id="83f9c-344">Para más información sobre cómo crear una aplicación de una sola página de AngularJS con un back-end de API web como ToDoListAngular, consulte [Hands On Lab: Build a Single Page Application (SPA) with ASP.NET Web API and Angular.js](http://www.asp.net/web-api/overview/getting-started-with-aspnet-web-api/build-a-single-page-application-spa-with-aspnet-web-api-and-angularjs)(Laboratorio práctico: Crear una aplicación de una sola página (SPA) con ASP.NET Web API y Angular.js).</span><span class="sxs-lookup"><span data-stu-id="83f9c-344">For information about how to  create an AngularJS single-page application with a Web API back end like ToDoListAngular, see  [Hands On Lab: Build a Single Page Application (SPA) with ASP.NET Web API and Angular.js](http://www.asp.net/web-api/overview/getting-started-with-aspnet-web-api/build-a-single-page-application-spa-with-aspnet-web-api-and-angularjs).</span></span> <span data-ttu-id="83f9c-345">Para más información sobre cómo agregar código de autenticación de Azure AD, consulte [Seguridad de las aplicaciones de una sola página AngularJS con Azure AD](../active-directory/active-directory-devquickstarts-angular.md).</span><span class="sxs-lookup"><span data-stu-id="83f9c-345">For information about how to add Azure AD authentication code, see [Securing AngularJS Single Page Apps with Azure AD](../active-directory/active-directory-devquickstarts-angular.md).</span></span>

## <a name="troubleshooting"></a><span data-ttu-id="83f9c-346">Solución de problemas</span><span class="sxs-lookup"><span data-stu-id="83f9c-346">Troubleshooting</span></span>
[!INCLUDE [troubleshooting](../../includes/app-service-api-auth-troubleshooting.md)]

* <span data-ttu-id="83f9c-347">Asegúrese de no confundir ToDoListAPI (nivel intermedio) con ToDoListDataAPI (capa de datos).</span><span class="sxs-lookup"><span data-stu-id="83f9c-347">Make sure that you don't confuse ToDoListAPI (middle tier) and ToDoListDataAPI (data tier).</span></span> <span data-ttu-id="83f9c-348">Por ejemplo, en este tutorial agregará autenticación a la aplicación de API de capa de datos, **pero la clave de aplicación debe proceder de la aplicación de Azure AD que creó para la aplicación de API de nivel intermedio**.</span><span class="sxs-lookup"><span data-stu-id="83f9c-348">For example, in this tutorial you add authentication to the data tier API app, **but the app key must come from the Azure AD application that you created for the middle tier API app**.</span></span>

## <a name="next-steps"></a><span data-ttu-id="83f9c-349">Siguientes pasos</span><span class="sxs-lookup"><span data-stu-id="83f9c-349">Next steps</span></span>
<span data-ttu-id="83f9c-350">Este es el último tutorial de la serie de aplicaciones de API.</span><span class="sxs-lookup"><span data-stu-id="83f9c-350">This is the last tutorial in the API Apps series.</span></span> 

<span data-ttu-id="83f9c-351">Para más información acerca de Azure Active Directory, consulte los siguientes recursos.</span><span class="sxs-lookup"><span data-stu-id="83f9c-351">For more information about Azure Active Directory, see the following resources.</span></span>

* [<span data-ttu-id="83f9c-352">Guía para desarrolladores de Azure AD</span><span class="sxs-lookup"><span data-stu-id="83f9c-352">Azure AD developers' guide</span></span>](http://aka.ms/aaddev)
* [<span data-ttu-id="83f9c-353">Escenarios de Azure AD</span><span class="sxs-lookup"><span data-stu-id="83f9c-353">Azure AD scenarios</span></span>](http://aka.ms/aadscenarios)
* [<span data-ttu-id="83f9c-354">Ejemplos de Azure AD</span><span class="sxs-lookup"><span data-stu-id="83f9c-354">Azure AD samples</span></span>](http://aka.ms/aadsamples)
  
    <span data-ttu-id="83f9c-355">El ejemplo [WebApp-WebAPI-OAuth2-AppIdentity-DotNet](http://github.com/AzureADSamples/WebApp-WebAPI-OAuth2-AppIdentity-DotNet) es similar al que se muestra en este tutorial, pero sin utilizar la autenticación del Servicio de aplicaciones.</span><span class="sxs-lookup"><span data-stu-id="83f9c-355">The [WebApp-WebAPI-OAuth2-AppIdentity-DotNet](http://github.com/AzureADSamples/WebApp-WebAPI-OAuth2-AppIdentity-DotNet) sample is similar to what is shown in this tutorial, but without using App Service authentication.</span></span>

<span data-ttu-id="83f9c-356">Para más información sobre otras formas de implementar proyectos de Visual Studio en aplicaciones de API, ya sea con Visual Studio o mediante la [automatización de la implementación](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/continuous-integration-and-continuous-delivery) desde un [sistema de control de código fuente](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control), consulte [Documentación de implementación de Azure App Service](../app-service-web/web-sites-deploy.md).</span><span class="sxs-lookup"><span data-stu-id="83f9c-356">For information about other ways to deploy Visual Studio projects to API apps, by using Visual Studio or by [automating deployment](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/continuous-integration-and-continuous-delivery) from a [source control system](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control), see [How to deploy an Azure App Service app](../app-service-web/web-sites-deploy.md).</span></span>

