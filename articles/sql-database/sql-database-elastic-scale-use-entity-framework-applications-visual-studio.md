---
title: "bibliotecas de cliente de base de datos elástica aaaUsing con Entity Framework | Documentos de Microsoft"
description: "Uso de la biblioteca de cliente de Base de datos elástica y Entity Framework para la codificación de bases de datos"
services: sql-database
documentationcenter: 
manager: jhubbard
author: torsteng
editor: 
ms.assetid: b9c3065b-cb92-41be-aa7f-deba23e7e159
ms.service: sql-database
ms.custom: scale out apps
ms.workload: sql-database
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 03/06/2017
ms.author: torsteng
ms.openlocfilehash: 917f6d28d9855c0b42afe2c008613a9bbb3ec6b6
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 10/06/2017
---
# <a name="elastic-database-client-library-with-entity-framework"></a><span data-ttu-id="2028e-103">Biblioteca de cliente de base de datos elástica con Entity Framework</span><span class="sxs-lookup"><span data-stu-id="2028e-103">Elastic Database client library with Entity Framework</span></span>
<span data-ttu-id="2028e-104">Este documento muestra los cambios de hello en una aplicación de Entity Framework que son necesario toointegrate con hello [herramientas de base de datos elástica](sql-database-elastic-scale-introduction.md).</span><span class="sxs-lookup"><span data-stu-id="2028e-104">This document shows hello changes in an Entity Framework application that are needed toointegrate with hello [Elastic Database tools](sql-database-elastic-scale-introduction.md).</span></span> <span data-ttu-id="2028e-105">Hola es componer [administración de mapa de particiones](sql-database-elastic-scale-shard-map-management.md) y [enrutamiento dependiente de los datos](sql-database-elastic-scale-data-dependent-routing.md) con Entity Framework hello **Code First** enfoque.</span><span class="sxs-lookup"><span data-stu-id="2028e-105">hello focus is on composing [shard map management](sql-database-elastic-scale-shard-map-management.md) and [data-dependent routing](sql-database-elastic-scale-data-dependent-routing.md) with hello Entity Framework **Code First** approach.</span></span> <span data-ttu-id="2028e-106">Hola [Code First - nueva base de datos](http://msdn.microsoft.com/data/jj193542.aspx) tutorial de EF actúa como nuestro ejemplo a lo largo de este documento.</span><span class="sxs-lookup"><span data-stu-id="2028e-106">hello [Code First - New Database](http://msdn.microsoft.com/data/jj193542.aspx) tutorial for EF serves as our running example throughout this document.</span></span> <span data-ttu-id="2028e-107">código de ejemplo de Hola que acompaña a este documento es parte de herramientas de base de datos elástica conjunto de ejemplos de hello ejemplos de código de Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="2028e-107">hello sample code accompanying this document is part of elastic database tools' set of samples in hello Visual Studio Code Samples.</span></span>

## <a name="downloading-and-running-hello-sample-code"></a><span data-ttu-id="2028e-108">Descargar y ejecutar código de ejemplo de Hola</span><span class="sxs-lookup"><span data-stu-id="2028e-108">Downloading and Running hello Sample Code</span></span>
<span data-ttu-id="2028e-109">código de hello toodownload de este artículo:</span><span class="sxs-lookup"><span data-stu-id="2028e-109">toodownload hello code for this article:</span></span>

* <span data-ttu-id="2028e-110">Se requiere Visual Studio 2012 o posterior.</span><span class="sxs-lookup"><span data-stu-id="2028e-110">Visual Studio 2012 or later is required.</span></span> 
* <span data-ttu-id="2028e-111">Descargar hello [elástico herramientas de base de datos de SQL Azure: ejemplo de integración de Entity Framework](https://code.msdn.microsoft.com/windowsapps/Elastic-Scale-with-Azure-bae904ba) de MSDN.</span><span class="sxs-lookup"><span data-stu-id="2028e-111">Download hello [Elastic DB Tools for Azure SQL - Entity Framework Integration sample](https://code.msdn.microsoft.com/windowsapps/Elastic-Scale-with-Azure-bae904ba) from MSDN.</span></span> <span data-ttu-id="2028e-112">Descomprima tooa ubicación de ejemplo de Hola de su elección.</span><span class="sxs-lookup"><span data-stu-id="2028e-112">Unzip hello sample tooa location of your choosing.</span></span>
* <span data-ttu-id="2028e-113">Inicie Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="2028e-113">Start Visual Studio.</span></span> 
* <span data-ttu-id="2028e-114">En Visual Studio, seleccione Archivo -> Abrir proyecto/solución.</span><span class="sxs-lookup"><span data-stu-id="2028e-114">In Visual Studio, select File -> Open Project/Solution.</span></span> 
* <span data-ttu-id="2028e-115">Hola **Abrir proyecto** cuadro de diálogo, desplácese ejemplo toohello que ha descargado y seleccione **EntityFrameworkCodeFirst.sln** muestra de Hola a tooopen.</span><span class="sxs-lookup"><span data-stu-id="2028e-115">In hello **Open Project** dialog, navigate toohello sample you downloaded and select **EntityFrameworkCodeFirst.sln** tooopen hello sample.</span></span> 

<span data-ttu-id="2028e-116">ejemplo de Hola a toorun, necesita toocreate tres bases de datos vacías en la base de datos de SQL Azure:</span><span class="sxs-lookup"><span data-stu-id="2028e-116">toorun hello sample, you need toocreate three empty databases in Azure SQL Database:</span></span>

* <span data-ttu-id="2028e-117">Base de datos de administrador de mapas de particiones</span><span class="sxs-lookup"><span data-stu-id="2028e-117">Shard Map Manager database</span></span>
* <span data-ttu-id="2028e-118">Base de datos de partición 1</span><span class="sxs-lookup"><span data-stu-id="2028e-118">Shard 1 database</span></span>
* <span data-ttu-id="2028e-119">Base de datos de partición 2</span><span class="sxs-lookup"><span data-stu-id="2028e-119">Shard 2 database</span></span>

<span data-ttu-id="2028e-120">Una vez haya creado estas bases de datos, rellene los marcadores de posición de hello en **Program.cs** con el nombre del servidor de base de datos de SQL Azure, los nombres de base de datos de Hola y las bases de datos de credenciales tooconnect toohello.</span><span class="sxs-lookup"><span data-stu-id="2028e-120">Once you have created these databases, fill in hello place holders in **Program.cs** with your Azure SQL DB server name, hello database names and your credentials tooconnect toohello databases.</span></span> <span data-ttu-id="2028e-121">Compile la solución de hello en Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="2028e-121">Build hello solution in Visual Studio.</span></span> <span data-ttu-id="2028e-122">Visual Studio descargará los paquetes de NuGet Hola necesario para la biblioteca de cliente de base de datos elástica hello, Entity Framework y control como parte del proceso de compilación de Hola de errores transitorios.</span><span class="sxs-lookup"><span data-stu-id="2028e-122">Visual Studio will download hello required NuGet packages for hello elastic database client library, Entity Framework, and Transient Fault handling as part of hello build process.</span></span> <span data-ttu-id="2028e-123">Asegúrese de que la restauración de paquetes de NuGet está habilitada para la solución.</span><span class="sxs-lookup"><span data-stu-id="2028e-123">Make sure that restoring NuGet packages is enabled for your solution.</span></span> <span data-ttu-id="2028e-124">Puede habilitar a esta opción con el botón secundario en el archivo de solución de Hola Hola Explorador de soluciones de Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="2028e-124">You can enable this setting by right-clicking on hello solution file in hello Visual Studio Solution Explorer.</span></span> 

## <a name="entity-framework-workflows"></a><span data-ttu-id="2028e-125">Flujos de trabajo de Entity Framework</span><span class="sxs-lookup"><span data-stu-id="2028e-125">Entity Framework workflows</span></span>
<span data-ttu-id="2028e-126">Los desarrolladores de Entity Framework se basan en uno de hello siguientes cuatro aplicaciones de flujos de trabajo toobuild y persistencia de tooensure para objetos de la aplicación:</span><span class="sxs-lookup"><span data-stu-id="2028e-126">Entity Framework developers rely on one of hello following four workflows toobuild applications and tooensure persistence for application objects:</span></span> 

* <span data-ttu-id="2028e-127">**Code First (base de datos nueva)**: Hola desarrollador EF crea el modelo de hello en código de la aplicación hello y, a continuación, EF genera la base de datos de Hola de él.</span><span class="sxs-lookup"><span data-stu-id="2028e-127">**Code First (New Database)**: hello EF developer creates hello model in hello application code and then EF generates hello database from it.</span></span> 
* <span data-ttu-id="2028e-128">**Code First (base de datos existente)**: desarrollador Hola permite EF generar código de la aplicación hello para el modelo de Hola desde una base de datos existente.</span><span class="sxs-lookup"><span data-stu-id="2028e-128">**Code First (Existing Database)**: hello developer lets EF generate hello application code for hello model from an existing database.</span></span>
* <span data-ttu-id="2028e-129">**Modelo primero**: desarrollador Hola crea el modelo de hello en el Diseñador de EF de hello y, a continuación, EF crea la base de datos de Hola de modelo de Hola.</span><span class="sxs-lookup"><span data-stu-id="2028e-129">**Model First**: hello developer creates hello model in hello EF designer and then EF creates hello database from hello model.</span></span>
* <span data-ttu-id="2028e-130">**Primero la base de datos**: programador de hello usa EF tooling modelo de hello tooinfer desde una base de datos existente.</span><span class="sxs-lookup"><span data-stu-id="2028e-130">**Database First**: hello developer uses EF tooling tooinfer hello model from an existing database.</span></span> 

<span data-ttu-id="2028e-131">Todos estos métodos se basan en hello DbContext clase tootransparently administran conexiones de base de datos y el esquema de base de datos para una aplicación.</span><span class="sxs-lookup"><span data-stu-id="2028e-131">All these approaches rely on hello DbContext class tootransparently manage database connections and database schema for an application.</span></span> <span data-ttu-id="2028e-132">Como se explica con más detalle más adelante en el documento de hello, diferentes constructores de clase base de hello DbContext permiten tener distintos niveles de control sobre la creación de la conexión, creación de arranque y el esquema de base de datos.</span><span class="sxs-lookup"><span data-stu-id="2028e-132">As we will discuss in more detail later in hello document, different constructors on hello DbContext base class allow for different levels of control over connection creation, database bootstrapping and schema creation.</span></span> <span data-ttu-id="2028e-133">Desafíos surgen principalmente al hecho de Hola que forma una intersección con la administración de conexión de base de datos de hello proporcionada por EF con capacidades de administración de conexión de Hola Hola datos dependientes de interfaces de enrutamiento proporciona biblioteca de cliente de base de datos elástica Hola.</span><span class="sxs-lookup"><span data-stu-id="2028e-133">Challenges arise primarily from hello fact that hello database connection management provided by EF intersects with hello connection management capabilities of hello data dependent routing interfaces provided by hello elastic database client library.</span></span> 

## <a name="elastic-database-tools-assumptions"></a><span data-ttu-id="2028e-134">Suposiciones de herramientas de bases de datos elásticas</span><span class="sxs-lookup"><span data-stu-id="2028e-134">Elastic database tools assumptions</span></span>
<span data-ttu-id="2028e-135">Para definiciones de términos, consulte el [Glosario de herramientas de Base de datos elástica](sql-database-elastic-scale-glossary.md).</span><span class="sxs-lookup"><span data-stu-id="2028e-135">For term definitions, see [Elastic Database tools glossary](sql-database-elastic-scale-glossary.md).</span></span>

<span data-ttu-id="2028e-136">Con la biblioteca de cliente de bases de datos elásticas, se definen particiones de los datos de la aplicación, denominadas shardlets.</span><span class="sxs-lookup"><span data-stu-id="2028e-136">With elastic database client library, you define partitions of your application data called shardlets.</span></span> <span data-ttu-id="2028e-137">Se identifican mediante una clave de particionamiento y son bases de datos asignado toospecific Shardlets.</span><span class="sxs-lookup"><span data-stu-id="2028e-137">Shardlets are identified by a sharding key and are mapped toospecific databases.</span></span> <span data-ttu-id="2028e-138">Una aplicación puede tener tantas bases de datos según sea necesario y distribuir hello shardlets tooprovide suficiente capacidad o rendimiento dados los requisitos de negocios actual.</span><span class="sxs-lookup"><span data-stu-id="2028e-138">An application may have as many databases as needed and distribute hello shardlets tooprovide enough capacity or performance given current business requirements.</span></span> <span data-ttu-id="2028e-139">asignación de Hola de bases de datos de toohello de valores de clave de particionamiento se almacena mediante un mapa de particiones proporcionado por las API de cliente de base de datos elástica Hola.</span><span class="sxs-lookup"><span data-stu-id="2028e-139">hello mapping of sharding key values toohello databases is stored by a shard map provided by hello elastic database client APIs.</span></span> <span data-ttu-id="2028e-140">A esta capacidad la denominamos **Administración de mapas de particiones**o, para abreviar, SMM.</span><span class="sxs-lookup"><span data-stu-id="2028e-140">We call this capability **Shard Map Management**, or SMM for short.</span></span> <span data-ttu-id="2028e-141">mapa de particiones de Hello también actúa como broker Hola de conexiones de base de datos para las solicitudes que llevar a cabo una clave de particionamiento.</span><span class="sxs-lookup"><span data-stu-id="2028e-141">hello shard map also serves as hello broker of database connections for requests that carry a sharding key.</span></span> <span data-ttu-id="2028e-142">Nos referimos toothis capacidad como **enrutamiento dependiente de los datos**.</span><span class="sxs-lookup"><span data-stu-id="2028e-142">We refer toothis capability as **data-dependent routing**.</span></span> 

<span data-ttu-id="2028e-143">Administrador de mapa de particiones de Hello protege a los usuarios de vistas incoherentes en datos de shardlet que se pueden producir cuando se produzcan operaciones de administración de shardlet simultáneas (por ejemplo, reubicar los datos de una partición tooanother).</span><span class="sxs-lookup"><span data-stu-id="2028e-143">hello shard map manager protects users from inconsistent views into shardlet data that can occur when concurrent shardlet management operations (such as relocating data from one shard tooanother) are happening.</span></span> <span data-ttu-id="2028e-144">toodo Hola por lo tanto, administradas conexiones de base de datos de hello Service broker biblioteca de cliente hello para una aplicación de mapas de particiones.</span><span class="sxs-lookup"><span data-stu-id="2028e-144">toodo so, hello shard maps managed by hello client library broker hello database connections for an application.</span></span> <span data-ttu-id="2028e-145">Esto permite a kill de hello particiones mapa funcionalidad tooautomatically una conexión de base de datos cuando las operaciones de administración de particiones podrían afectar a hello shardlet que se ha creado la conexión de Hola para.</span><span class="sxs-lookup"><span data-stu-id="2028e-145">This allows hello shard map functionality tooautomatically kill a database connection when shard management operations could impact hello shardlet that hello connection has been created for.</span></span> <span data-ttu-id="2028e-146">Este enfoque debe toointegrate con parte de la funcionalidad de EF, como la creación de nuevas conexiones desde un una toocheck existente para la existencia de base de datos.</span><span class="sxs-lookup"><span data-stu-id="2028e-146">This approach needs toointegrate with some of EF’s functionality, such as creating new connections from an existing one toocheck for database existence.</span></span> <span data-ttu-id="2028e-147">En general, la observación ha sido que constructores de DbContext estándares Hola solo la funcionan bien para las conexiones de base de datos cerrada pueden clonarse para el trabajo EF.</span><span class="sxs-lookup"><span data-stu-id="2028e-147">In general, our observation has been that hello standard DbContext constructors only work reliably for closed database connections that can safely be cloned for EF work.</span></span> <span data-ttu-id="2028e-148">principio de diseño de Hola de base de datos elástica en su lugar es tooonly broker abrir conexiones.</span><span class="sxs-lookup"><span data-stu-id="2028e-148">hello design principle of elastic database instead is tooonly broker opened connections.</span></span> <span data-ttu-id="2028e-149">Uno podría pensar que cerrar una conexión asíncrona por la biblioteca de cliente de hello antes de entregarlo a través de toohello EF DbContext podría solucionar este problema.</span><span class="sxs-lookup"><span data-stu-id="2028e-149">One might think that closing a connection brokered by hello client library before handing it over toohello EF DbContext may solve this issue.</span></span> <span data-ttu-id="2028e-150">Sin embargo, al cerrar la conexión de Hola y confiar en EF toore al abrir, uno foregoes comprobaciones de validación y la coherencia de Hola Hola biblioteca realizadas.</span><span class="sxs-lookup"><span data-stu-id="2028e-150">However, by closing hello connection and relying on EF toore-open it, one foregoes hello validation and consistency checks performed by hello library.</span></span> <span data-ttu-id="2028e-151">la funcionalidad de migraciones de Hello en EF, sin embargo, usa estos Hola de toomanage conexiones esquema de base de datos de forma que sea transparente toohello aplicación subyacente.</span><span class="sxs-lookup"><span data-stu-id="2028e-151">hello migrations functionality in EF, however, uses these connections toomanage hello underlying database schema in a way that is transparent toohello application.</span></span> <span data-ttu-id="2028e-152">Idealmente, se desea tooretain y combinar todas estas capacidades de la biblioteca de cliente de base de datos elástica hello y EF Hola misma aplicación.</span><span class="sxs-lookup"><span data-stu-id="2028e-152">Ideally, we would like tooretain and combine all these capabilities from both hello elastic database client library and EF in hello same application.</span></span> <span data-ttu-id="2028e-153">Hello siguiente sección describen estas propiedades y los requisitos con más detalle.</span><span class="sxs-lookup"><span data-stu-id="2028e-153">hello following section discusses these properties and requirements in more detail.</span></span> 

## <a name="requirements"></a><span data-ttu-id="2028e-154">Requisitos</span><span class="sxs-lookup"><span data-stu-id="2028e-154">Requirements</span></span>
<span data-ttu-id="2028e-155">Cuando se trabaja con la biblioteca de cliente de base de datos elástica hello y las API de Entity Framework, queremos hello tooretain propiedades siguientes:</span><span class="sxs-lookup"><span data-stu-id="2028e-155">When working with both hello elastic database client library and Entity Framework APIs, we want tooretain hello following properties:</span></span> 

* <span data-ttu-id="2028e-156">**Escalado horizontal**: tooadd o quitar bases de datos de capa de datos de Hola de aplicación particionada hello según sea necesario para las demandas de capacidad de Hola de aplicación hello.</span><span class="sxs-lookup"><span data-stu-id="2028e-156">**Scale-out**: tooadd or remove databases from hello data tier of hello sharded application as necessary for hello capacity demands of hello application.</span></span> <span data-ttu-id="2028e-157">Esto significa que un control sobre la creación de Hola Hola y eliminación de bases de datos y utilizando Hola bases de datos elásticas particiones manager API toomanage las bases de datos y las asignaciones de shardlets.</span><span class="sxs-lookup"><span data-stu-id="2028e-157">This means control over hello hello creation and deletion of databases and using hello elastic database shard map manager APIs toomanage databases, and mappings of shardlets.</span></span> 
* <span data-ttu-id="2028e-158">**Coherencia**: aplicación hello emplea particionamiento y utiliza Hola capacidades de enrutamiento dependiente de datos de biblioteca de cliente de Hola.</span><span class="sxs-lookup"><span data-stu-id="2028e-158">**Consistency**: hello application employs sharding, and uses hello data dependent routing capabilities of hello client library.</span></span> <span data-ttu-id="2028e-159">tooavoid daños o resultados de la consulta incorrecta, las conexiones se pasa por el Administrador de mapa de particiones de Hola.</span><span class="sxs-lookup"><span data-stu-id="2028e-159">tooavoid corruption or wrong query results, connections are brokered through hello shard map manager.</span></span> <span data-ttu-id="2028e-160">También mantiene la validación y la coherencia.</span><span class="sxs-lookup"><span data-stu-id="2028e-160">This also retains validation and consistency.</span></span>
* <span data-ttu-id="2028e-161">**Code First**: comodidad de hello tooretain del primer paradigma del EF código.</span><span class="sxs-lookup"><span data-stu-id="2028e-161">**Code First**: tooretain hello convenience of EF’s code first paradigm.</span></span> <span data-ttu-id="2028e-162">En Code First, las clases de aplicación Hola se asignan de forma transparente toohello subyacente estructuras de base de datos.</span><span class="sxs-lookup"><span data-stu-id="2028e-162">In Code First, classes in hello application are mapped transparently toohello underlying database structures.</span></span> <span data-ttu-id="2028e-163">código de la aplicación Hello interactúa con DbSets que enmascarar la mayoría de los aspectos implicados en hello subyacente de procesamiento de la base de datos.</span><span class="sxs-lookup"><span data-stu-id="2028e-163">hello application code interacts with DbSets that mask most aspects involved in hello underlying database processing.</span></span>
* <span data-ttu-id="2028e-164">**Esquema**: Entity Framework controla la creación del esquema de base de datos inicial y la evolución del esquema posterior a través de migraciones.</span><span class="sxs-lookup"><span data-stu-id="2028e-164">**Schema**: Entity Framework handles initial database schema creation and subsequent schema evolution through migrations.</span></span> <span data-ttu-id="2028e-165">Al conservar estas capacidades, es fácil como Hola datos evoluciona adaptar la aplicación.</span><span class="sxs-lookup"><span data-stu-id="2028e-165">By retaining these capabilities, adapting your app is easy as hello data evolves.</span></span> 

<span data-ttu-id="2028e-166">Hello siguiente orientación indica a cómo toosatisfy estos requisitos para las aplicaciones de Code First con herramientas de base de datos elástica.</span><span class="sxs-lookup"><span data-stu-id="2028e-166">hello following guidance instructs how toosatisfy these requirements for Code First applications using elastic database tools.</span></span> 

## <a name="data-dependent-routing-using-ef-dbcontext"></a><span data-ttu-id="2028e-167">Enrutamiento dependiente de datos con DbContext de EF</span><span class="sxs-lookup"><span data-stu-id="2028e-167">Data dependent routing using EF DbContext</span></span>
<span data-ttu-id="2028e-168">Las conexiones de base de datos con Entity Framework se suelen administrar mediante subclases de **DbContext**.</span><span class="sxs-lookup"><span data-stu-id="2028e-168">Database connections with Entity Framework are typically managed through subclasses of **DbContext**.</span></span> <span data-ttu-id="2028e-169">Cree estas subclases basándose en **DbContext**.</span><span class="sxs-lookup"><span data-stu-id="2028e-169">Create these subclasses by deriving from **DbContext**.</span></span> <span data-ttu-id="2028e-170">Aquí es donde se define la **DbSets** que implementar colecciones de seguridad de base de datos de Hola de objetos CLR para la aplicación.</span><span class="sxs-lookup"><span data-stu-id="2028e-170">This is where you define your **DbSets** that implement hello database-backed collections of CLR objects for your application.</span></span> <span data-ttu-id="2028e-171">En el contexto de Hola de enrutamiento dependiente de datos, podemos identificar varias propiedades útiles que no tienen necesariamente para otros escenarios de aplicación EF primer de código:</span><span class="sxs-lookup"><span data-stu-id="2028e-171">In hello context of data dependent routing, we can identify several helpful properties that do not necessarily hold for other EF code first application scenarios:</span></span> 

* <span data-ttu-id="2028e-172">base de datos de Hello ya existe y se ha registrado en el mapa de particiones de bases de datos elásticas Hola.</span><span class="sxs-lookup"><span data-stu-id="2028e-172">hello database already exists and has been registered in hello elastic database shard map.</span></span> 
* <span data-ttu-id="2028e-173">esquema de Hola de aplicación hello ya ha sido implementado toohello base de datos (se explica más adelante).</span><span class="sxs-lookup"><span data-stu-id="2028e-173">hello schema of hello application has already been deployed toohello database (explained below).</span></span> 
* <span data-ttu-id="2028e-174">Base de datos de dependiente de los datos enrutamiento conexiones toohello se asíncrona al mapa de particiones de Hola.</span><span class="sxs-lookup"><span data-stu-id="2028e-174">Data-dependent routing connections toohello database are brokered by hello shard map.</span></span> 

<span data-ttu-id="2028e-175">toointegrate **DbContexts** con enrutamiento dependiente de los datos para la implementación escalada:</span><span class="sxs-lookup"><span data-stu-id="2028e-175">toointegrate **DbContexts** with data-dependent routing for scale-out:</span></span>

1. <span data-ttu-id="2028e-176">Crear conexiones de base de datos física a través de interfaces de cliente de base de datos elástica Hola de administrador de asignación de particiones de hello,</span><span class="sxs-lookup"><span data-stu-id="2028e-176">Create physical database connections through hello elastic database client interfaces of hello shard map manager,</span></span> 
2. <span data-ttu-id="2028e-177">Ajustar la conexión de hello con hello **DbContext** subclase</span><span class="sxs-lookup"><span data-stu-id="2028e-177">Wrap hello connection with hello **DbContext** subclass</span></span>
3. <span data-ttu-id="2028e-178">Pasar de conexión de hello hacia abajo en hello **DbContext** base tooensure clases todo el procesamiento de hello en lado EF Hola sucede así.</span><span class="sxs-lookup"><span data-stu-id="2028e-178">Pass hello connection down into hello **DbContext** base classes tooensure all hello processing on hello EF side happens as well.</span></span> 

<span data-ttu-id="2028e-179">Hola, ejemplo de código siguiente muestra este enfoque.</span><span class="sxs-lookup"><span data-stu-id="2028e-179">hello following code example illustrates this approach.</span></span> <span data-ttu-id="2028e-180">(Este código también es Hola que acompaña a proyecto de Visual Studio)</span><span class="sxs-lookup"><span data-stu-id="2028e-180">(This code is also in hello accompanying Visual Studio project)</span></span>

    public class ElasticScaleContext<T> : DbContext
    {
    public DbSet<Blog> Blogs { get; set; }
    …

        // C'tor for data dependent routing. This call will open a validated connection 
        // routed toohello proper shard by hello shard map manager. 
        // Note that hello base class c'tor call will fail for an open connection
        // if migrations need toobe done and SQL credentials are used. This is hello reason for hello 
        // separation of c'tors into hello data-dependent routing case (this c'tor) and hello internal c'tor for new shards.
        public ElasticScaleContext(ShardMap shardMap, T shardingKey, string connectionStr)
            : base(CreateDDRConnection(shardMap, shardingKey, connectionStr), 
            true /* contextOwnsConnection */)
        {
        }

        // Only static methods are allowed in calls into base class c'tors.
        private static DbConnection CreateDDRConnection(
        ShardMap shardMap, 
        T shardingKey, 
        string connectionStr)
        {
            // No initialization
            Database.SetInitializer<ElasticScaleContext<T>>(null);

            // Ask shard map toobroker a validated connection for hello given key
            SqlConnection conn = shardMap.OpenConnectionForKey<T>
                                (shardingKey, connectionStr, ConnectionOptions.Validate);
            return conn;
        }    

## <a name="main-points"></a><span data-ttu-id="2028e-181">Puntos principales</span><span class="sxs-lookup"><span data-stu-id="2028e-181">Main points</span></span>
* <span data-ttu-id="2028e-182">Un nuevo constructor reemplaza el constructor predeterminado de hello en subclase de DbContext Hola</span><span class="sxs-lookup"><span data-stu-id="2028e-182">A new constructor replaces hello default constructor in hello DbContext subclass</span></span> 
* <span data-ttu-id="2028e-183">Hola nuevo constructor usa argumentos de Hola que son necesarios para el enrutamiento dependiente de datos a través de la biblioteca de cliente de base de datos elástica:</span><span class="sxs-lookup"><span data-stu-id="2028e-183">hello new constructor takes hello arguments that are required for data dependent routing through elastic database client library:</span></span>
  
  * <span data-ttu-id="2028e-184">tooaccess de mapa de particiones de Hola Hola interfaces de enrutamiento dependiente de los datos,</span><span class="sxs-lookup"><span data-stu-id="2028e-184">hello shard map tooaccess hello data-dependent routing interfaces,</span></span>
  * <span data-ttu-id="2028e-185">Hola particionamiento tooidentify clave hello shardlet,</span><span class="sxs-lookup"><span data-stu-id="2028e-185">hello sharding key tooidentify hello shardlet,</span></span>
  * <span data-ttu-id="2028e-186">una cadena de conexión con credenciales de hello para la partición del toohello de conexión de enrutamiento Hola dependiente de los datos.</span><span class="sxs-lookup"><span data-stu-id="2028e-186">a connection string with hello credentials for hello data-dependent routing connection toohello shard.</span></span> 
* <span data-ttu-id="2028e-187">constructor de clase base en toohello Hola llamada toma un desvío en un método estático que lleva a cabo todos los pasos de hello necesaria para el enrutamiento dependiente de los datos.</span><span class="sxs-lookup"><span data-stu-id="2028e-187">hello call toohello base class constructor takes a detour into a static method that performs all hello steps necessary for data-dependent routing.</span></span> 
  
  * <span data-ttu-id="2028e-188">Utiliza llamadas de OpenConnectionForKey Hola de interfaces de cliente de base de datos elástica hello en hello particiones mapa tooestablish una conexión abierta.</span><span class="sxs-lookup"><span data-stu-id="2028e-188">It uses hello OpenConnectionForKey call of hello elastic database client interfaces on hello shard map tooestablish an open connection.</span></span>
  * <span data-ttu-id="2028e-189">mapa de particiones de Hello crea particiones de toohello de conexión abierta de Hola que contiene shardlet Hola Hola clave de particionamiento dada.</span><span class="sxs-lookup"><span data-stu-id="2028e-189">hello shard map creates hello open connection toohello shard that holds hello shardlet for hello given sharding key.</span></span>
  * <span data-ttu-id="2028e-190">Esta conexión abierta se pasa el constructor de clase base toohello atrás de tooindicate DbContext que esta conexión es toobe usa EF en lugar de dejar que EF cree automáticamente una nueva conexión.</span><span class="sxs-lookup"><span data-stu-id="2028e-190">This open connection is passed back toohello base class constructor of DbContext tooindicate that this connection is toobe used by EF instead of letting EF create a new connection automatically.</span></span> <span data-ttu-id="2028e-191">Esta conexión de manera Hola se ha etiquetado por la API de cliente de base de datos elástica Hola para que se pueda garantizar la coherencia en las operaciones de administración de mapa de particiones.</span><span class="sxs-lookup"><span data-stu-id="2028e-191">This way hello connection has been tagged by hello elastic database client API so that it can guarantee consistency under shard map management operations.</span></span>

<span data-ttu-id="2028e-192">Use Hola nuevo constructor de la subclase DbContext en lugar del constructor predeterminado de hello en el código.</span><span class="sxs-lookup"><span data-stu-id="2028e-192">Use hello new constructor for your DbContext subclass instead of hello default constructor in your code.</span></span> <span data-ttu-id="2028e-193">Aquí tiene un ejemplo:</span><span class="sxs-lookup"><span data-stu-id="2028e-193">Here is an example:</span></span> 

    // Create and save a new blog.

    Console.Write("Enter a name for a new blog: "); 
    var name = Console.ReadLine(); 

    using (var db = new ElasticScaleContext<int>( 
                            sharding.ShardMap,  
                            tenantId1,  
                            connStrBldr.ConnectionString)) 
    { 
        var blog = new Blog { Name = name }; 
        db.Blogs.Add(blog); 
        db.SaveChanges(); 

        // Display all Blogs for tenant 1 
        var query = from b in db.Blogs 
                    orderby b.Name 
                    select b; 
     … 
    }

<span data-ttu-id="2028e-194">Abre el nuevo constructor de Hello particiones toohello de hello conexión que contiene datos de Hola para shardlet Hola identificado por el valor de Hola de **tenantid1**.</span><span class="sxs-lookup"><span data-stu-id="2028e-194">hello new constructor opens hello connection toohello shard that holds hello data for hello shardlet identified by hello value of **tenantid1**.</span></span> <span data-ttu-id="2028e-195">Hola código de hello **con** bloque permanece sin cambios tooaccess hello **DbSet** para los blogs con EF en particiones de Hola para **tenantid1**.</span><span class="sxs-lookup"><span data-stu-id="2028e-195">hello code in hello **using** block stays unchanged tooaccess hello **DbSet** for blogs using EF on hello shard for **tenantid1**.</span></span> <span data-ttu-id="2028e-196">Esto cambia la semántica de código de hello en hello mediante el bloque de modo que todas las operaciones de base de datos ahora ámbito toohello una partición donde **tenantid1** se mantiene.</span><span class="sxs-lookup"><span data-stu-id="2028e-196">This changes semantics for hello code in hello using block such that all database operations are now scoped toohello one shard where **tenantid1** is kept.</span></span> <span data-ttu-id="2028e-197">Por ejemplo, una consulta LINQ a través de blogs de hello **DbSet** podría devolver solo los blogs almacenados en la partición actual de hello, pero no Hola a los que se almacenan en otras particiones.</span><span class="sxs-lookup"><span data-stu-id="2028e-197">For instance, a LINQ query over hello blogs **DbSet** would only return blogs stored on hello current shard, but not hello ones stored on other shards.</span></span>  

#### <a name="transient-faults-handling"></a><span data-ttu-id="2028e-198">Control de errores transitorios</span><span class="sxs-lookup"><span data-stu-id="2028e-198">Transient faults handling</span></span>
<span data-ttu-id="2028e-199">Hello Microsoft Patterns & Practices equipo Hola publicado [Hola Transient Fault Handling Application Block](https://msdn.microsoft.com/library/dn440719.aspx).</span><span class="sxs-lookup"><span data-stu-id="2028e-199">hello Microsoft Patterns & Practices team published hello [hello Transient Fault Handling Application Block](https://msdn.microsoft.com/library/dn440719.aspx).</span></span> <span data-ttu-id="2028e-200">biblioteca de Hola se usa con la biblioteca de cliente de escala elástica en combinación con EF.</span><span class="sxs-lookup"><span data-stu-id="2028e-200">hello library is used with elastic scale client library in combination with EF.</span></span> <span data-ttu-id="2028e-201">Sin embargo, asegúrese de que cualquier excepción transitoria devuelve lugar tooa donde es posible garantizar que ese nuevo constructor Hola está usándola después de un error transitorio para que cualquier nuevo intento de conexión se realiza mediante constructores Hola que nos hemos ajustado.</span><span class="sxs-lookup"><span data-stu-id="2028e-201">However, ensure that any transient exception returns tooa place where we can ensure that hello new constructor is being used after a transient fault so that any new connection attempt is made using hello constructors we have tweaked.</span></span> <span data-ttu-id="2028e-202">En caso contrario, se mantiene un toohello de conexión correcto no se garantiza la partición y no hay ninguna garantía de conexión hello como cambios que se producen toohello mapa de particiones.</span><span class="sxs-lookup"><span data-stu-id="2028e-202">Otherwise, a connection toohello correct shard is not guaranteed, and there are no assurances hello connection is maintained as changes toohello shard map occur.</span></span> 

<span data-ttu-id="2028e-203">Hello ejemplo de código siguiente muestra cómo una directiva de reintentos SQL puede utilizarse alrededor de hello nueva **DbContext** constructores de subclase:</span><span class="sxs-lookup"><span data-stu-id="2028e-203">hello following code sample illustrates how a SQL retry policy can be used around hello new **DbContext** subclass constructors:</span></span> 

    SqlDatabaseUtils.SqlRetryPolicy.ExecuteAction(() => 
    { 
        using (var db = new ElasticScaleContext<int>( 
                                sharding.ShardMap,  
                                tenantId1,  
                                connStrBldr.ConnectionString)) 
            { 
                    var blog = new Blog { Name = name }; 
                    db.Blogs.Add(blog); 
                    db.SaveChanges(); 
            … 
            } 
        }); 

<span data-ttu-id="2028e-204">**SqlDatabaseUtils.SqlRetryPolicy** en hello código anterior se define como un **SqlDatabaseTransientErrorDetectionStrategy** con un número de reintentos de 10 y 5 segundos de tiempo entre los reintentos de espera.</span><span class="sxs-lookup"><span data-stu-id="2028e-204">**SqlDatabaseUtils.SqlRetryPolicy** in hello code above is defined as a **SqlDatabaseTransientErrorDetectionStrategy** with a retry count of 10, and 5 seconds wait time between retries.</span></span> <span data-ttu-id="2028e-205">Este enfoque es similar Guía de toohello para EF y las transacciones iniciadas por el usuario (consulte [limitaciones con reintentando estrategias de ejecución (en adelante EF6)](http://msdn.microsoft.com/data/dn307226).</span><span class="sxs-lookup"><span data-stu-id="2028e-205">This approach is similar toohello guidance for EF and user-initiated transactions (see [Limitations with Retrying Execution Strategies (EF6 onwards)](http://msdn.microsoft.com/data/dn307226).</span></span> <span data-ttu-id="2028e-206">Ambas situaciones requieren ese programa de aplicación Hola controla Hola ámbito toowhich Hola excepción transitoria devuelve: tooeither vuelva a abrir la transacción de Hola o (tal y como se muestra), volver a crear contexto de Hola de constructor adecuado de Hola que usa Hola bases de datos elásticas biblioteca de cliente.</span><span class="sxs-lookup"><span data-stu-id="2028e-206">Both situations require that hello application program controls hello scope toowhich hello transient exception returns: tooeither reopen hello transaction, or (as shown) recreate hello context from hello proper constructor that uses hello elastic database client library.</span></span>

<span data-ttu-id="2028e-207">Hello toocontrol necesario en las excepciones transitorias nos adoptar en el ámbito también evita que las use Hola integrados de Hola de **SqlAzureExecutionStrategy** que viene con EF.</span><span class="sxs-lookup"><span data-stu-id="2028e-207">hello need toocontrol where transient exceptions take us back in scope also precludes hello use of hello built-in **SqlAzureExecutionStrategy** that comes with EF.</span></span> <span data-ttu-id="2028e-208">**SqlAzureExecutionStrategy** debería volver a abrir una conexión pero no usar **OpenConnectionForKey** y, por tanto, omitir todas las validaciones de Hola que se realizan como parte del programa Hola a **OpenConnectionForKey** llamar.</span><span class="sxs-lookup"><span data-stu-id="2028e-208">**SqlAzureExecutionStrategy** would reopen a connection but not use **OpenConnectionForKey** and therefore bypass all hello validation that is performed as part of hello **OpenConnectionForKey** call.</span></span> <span data-ttu-id="2028e-209">En su lugar, ejemplo de código de hello usa integradas de hello **DefaultExecutionStrategy** que también se proporciona con EF.</span><span class="sxs-lookup"><span data-stu-id="2028e-209">Instead, hello code sample uses hello built-in **DefaultExecutionStrategy** that also comes with EF.</span></span> <span data-ttu-id="2028e-210">En lugar de demasiado**SqlAzureExecutionStrategy**, funciona correctamente en combinación con la directiva de reintento de hello del control de errores transitorios.</span><span class="sxs-lookup"><span data-stu-id="2028e-210">As opposed too**SqlAzureExecutionStrategy**, it works correctly in combination with hello retry policy from Transient Fault Handling.</span></span> <span data-ttu-id="2028e-211">Directiva de ejecución de Hola se establece en hello **ElasticScaleDbConfiguration** clase.</span><span class="sxs-lookup"><span data-stu-id="2028e-211">hello execution policy is set in hello **ElasticScaleDbConfiguration** class.</span></span> <span data-ttu-id="2028e-212">Tenga en cuenta que decidimos no toouse **DefaultSqlExecutionStrategy** desde que sugiere toouse **SqlAzureExecutionStrategy** si se producen las excepciones transitorias - que provocaban toowrong comportamiento tal como se describe.</span><span class="sxs-lookup"><span data-stu-id="2028e-212">Note that we decided not toouse **DefaultSqlExecutionStrategy** since it suggests toouse **SqlAzureExecutionStrategy** if transient exceptions occur - which would lead toowrong behavior as discussed.</span></span> <span data-ttu-id="2028e-213">Para obtener más información sobre las directivas de reintento diferentes de Hola y EF, consulte [resistencia de conexión en EF](http://msdn.microsoft.com/data/dn456835.aspx).</span><span class="sxs-lookup"><span data-stu-id="2028e-213">For more information on hello different retry policies and EF, see [Connection Resiliency in EF](http://msdn.microsoft.com/data/dn456835.aspx).</span></span>     

#### <a name="constructor-rewrites"></a><span data-ttu-id="2028e-214">Reescrituras del constructor</span><span class="sxs-lookup"><span data-stu-id="2028e-214">Constructor rewrites</span></span>
<span data-ttu-id="2028e-215">ejemplos de código anteriores Hello ilustran predeterminado de hello constructor reescribe necesario para la aplicación en orden toouse depende de los datos de enrutamiento con hello Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="2028e-215">hello code examples above illustrate hello default constructor re-writes required for your application in order toouse  data dependent routing with hello Entity Framework.</span></span> <span data-ttu-id="2028e-216">Hello en la tabla siguiente generaliza esta constructores tooother de enfoque.</span><span class="sxs-lookup"><span data-stu-id="2028e-216">hello following table generalizes this approach tooother constructors.</span></span> 

| <span data-ttu-id="2028e-217">Constructor actual</span><span class="sxs-lookup"><span data-stu-id="2028e-217">Current Constructor</span></span> | <span data-ttu-id="2028e-218">Constructor reescrito para datos</span><span class="sxs-lookup"><span data-stu-id="2028e-218">Rewritten Constructor for data</span></span> | <span data-ttu-id="2028e-219">Constructor base</span><span class="sxs-lookup"><span data-stu-id="2028e-219">Base Constructor</span></span> | <span data-ttu-id="2028e-220">Notas</span><span class="sxs-lookup"><span data-stu-id="2028e-220">Notes</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="2028e-221">MyContext()</span><span class="sxs-lookup"><span data-stu-id="2028e-221">MyContext()</span></span> |<span data-ttu-id="2028e-222">ElasticScaleContext(ShardMap, TKey)</span><span class="sxs-lookup"><span data-stu-id="2028e-222">ElasticScaleContext(ShardMap, TKey)</span></span> |<span data-ttu-id="2028e-223">DbContext(DbConnection, bool)</span><span class="sxs-lookup"><span data-stu-id="2028e-223">DbContext(DbConnection, bool)</span></span> |<span data-ttu-id="2028e-224">conexión de Hello debe toobe una función de mapa de particiones de Hola y clave de enrutamiento Hola dependiente de los datos.</span><span class="sxs-lookup"><span data-stu-id="2028e-224">hello connection needs toobe a function of hello shard map and hello data-dependent routing key.</span></span> <span data-ttu-id="2028e-225">Creación de la conexión automática de tooby pasada por parte de EF es necesario y en su lugar use conexión de hello particiones mapa toobroker Hola.</span><span class="sxs-lookup"><span data-stu-id="2028e-225">You need tooby-pass automatic connection creation by EF and instead use hello shard map toobroker hello connection.</span></span> |
| <span data-ttu-id="2028e-226">MyContext(string)</span><span class="sxs-lookup"><span data-stu-id="2028e-226">MyContext(string)</span></span> |<span data-ttu-id="2028e-227">ElasticScaleContext(ShardMap, TKey)</span><span class="sxs-lookup"><span data-stu-id="2028e-227">ElasticScaleContext(ShardMap, TKey)</span></span> |<span data-ttu-id="2028e-228">DbContext(DbConnection, bool)</span><span class="sxs-lookup"><span data-stu-id="2028e-228">DbContext(DbConnection, bool)</span></span> |<span data-ttu-id="2028e-229">conexión de Hello es una función de mapa de particiones de Hola y la clave de enrutamiento de hello dependiente de los datos.</span><span class="sxs-lookup"><span data-stu-id="2028e-229">hello connection is a function of hello shard map and hello data-dependent routing key.</span></span> <span data-ttu-id="2028e-230">Una cadena de nombre o una conexión de base de datos fija no funcionará como validación eludir mediante el mapa de particiones de Hola.</span><span class="sxs-lookup"><span data-stu-id="2028e-230">A fixed database name or connection string will not work as they by-pass validation by hello shard map.</span></span> |
| <span data-ttu-id="2028e-231">MyContext(DbCompiledModel)</span><span class="sxs-lookup"><span data-stu-id="2028e-231">MyContext(DbCompiledModel)</span></span> |<span data-ttu-id="2028e-232">ElasticScaleContext(ShardMap, TKey, DbCompiledModel)</span><span class="sxs-lookup"><span data-stu-id="2028e-232">ElasticScaleContext(ShardMap, TKey, DbCompiledModel)</span></span> |<span data-ttu-id="2028e-233">DbContext(DbConnection, DbCompiledModel, bool)</span><span class="sxs-lookup"><span data-stu-id="2028e-233">DbContext(DbConnection, DbCompiledModel, bool)</span></span> |<span data-ttu-id="2028e-234">conexión de Hello obtener creará para hello tiene clave de particionamiento y de mapa de particiones con el modelo de hello proporcionado.</span><span class="sxs-lookup"><span data-stu-id="2028e-234">hello connection will get created for hello given shard map and sharding key with hello model provided.</span></span> <span data-ttu-id="2028e-235">Hola compilado modelo se pasarán en toohello base c'tor.</span><span class="sxs-lookup"><span data-stu-id="2028e-235">hello compiled model will be passed on toohello base c’tor.</span></span> |
| <span data-ttu-id="2028e-236">MyContext(DbConnection, bool)</span><span class="sxs-lookup"><span data-stu-id="2028e-236">MyContext(DbConnection, bool)</span></span> |<span data-ttu-id="2028e-237">ElasticScaleContext(ShardMap, TKey, bool)</span><span class="sxs-lookup"><span data-stu-id="2028e-237">ElasticScaleContext(ShardMap, TKey, bool)</span></span> |<span data-ttu-id="2028e-238">DbContext(DbConnection, bool)</span><span class="sxs-lookup"><span data-stu-id="2028e-238">DbContext(DbConnection, bool)</span></span> |<span data-ttu-id="2028e-239">conexión de Hello debe toobe inferir de mapa de particiones de Hola y la clave de Hola.</span><span class="sxs-lookup"><span data-stu-id="2028e-239">hello connection needs toobe inferred from hello shard map and hello key.</span></span> <span data-ttu-id="2028e-240">No se pueden proporcionar como entrada (a menos que ya estaba usando esa entrada mapa de particiones de Hola y la clave de hello).</span><span class="sxs-lookup"><span data-stu-id="2028e-240">It cannot be provided as an input (unless that input was already using hello shard map and hello key).</span></span> <span data-ttu-id="2028e-241">Hola booleano se pasarán en.</span><span class="sxs-lookup"><span data-stu-id="2028e-241">hello Boolean will be passed on.</span></span> |
| <span data-ttu-id="2028e-242">MyContext(string, DbCompiledModel)</span><span class="sxs-lookup"><span data-stu-id="2028e-242">MyContext(string, DbCompiledModel)</span></span> |<span data-ttu-id="2028e-243">ElasticScaleContext(ShardMap, TKey, DbCompiledModel)</span><span class="sxs-lookup"><span data-stu-id="2028e-243">ElasticScaleContext(ShardMap, TKey, DbCompiledModel)</span></span> |<span data-ttu-id="2028e-244">DbContext(DbConnection, DbCompiledModel, bool)</span><span class="sxs-lookup"><span data-stu-id="2028e-244">DbContext(DbConnection, DbCompiledModel, bool)</span></span> |<span data-ttu-id="2028e-245">conexión de Hello debe toobe inferir de mapa de particiones de Hola y la clave de Hola.</span><span class="sxs-lookup"><span data-stu-id="2028e-245">hello connection needs toobe inferred from hello shard map and hello key.</span></span> <span data-ttu-id="2028e-246">No se pueden proporcionar como entrada (a menos que estaba usando esa entrada mapa de particiones de Hola y la clave de hello).</span><span class="sxs-lookup"><span data-stu-id="2028e-246">It cannot be provided as an input (unless that input was using hello shard map and hello key).</span></span> <span data-ttu-id="2028e-247">Hola compilado modelo se pasarán en.</span><span class="sxs-lookup"><span data-stu-id="2028e-247">hello compiled model will be passed on.</span></span> |
| <span data-ttu-id="2028e-248">MyContext(ObjectContext, bool)</span><span class="sxs-lookup"><span data-stu-id="2028e-248">MyContext(ObjectContext, bool)</span></span> |<span data-ttu-id="2028e-249">ElasticScaleContext(ShardMap, TKey, ObjectContext, bool)</span><span class="sxs-lookup"><span data-stu-id="2028e-249">ElasticScaleContext(ShardMap, TKey, ObjectContext, bool)</span></span> |<span data-ttu-id="2028e-250">DbContext(ObjectContext, bool)</span><span class="sxs-lookup"><span data-stu-id="2028e-250">DbContext(ObjectContext, bool)</span></span> |<span data-ttu-id="2028e-251">constructor new Hello debe tooensure que las conexiones de hello que ObjectContext se pasa como entrada es conexión vuelve a enrutarse tooa administrado por la escala elástica.</span><span class="sxs-lookup"><span data-stu-id="2028e-251">hello new constructor needs tooensure that any connection in hello ObjectContext passed as an input is re-routed tooa connection managed by Elastic Scale.</span></span> <span data-ttu-id="2028e-252">Es una explicación detallada de ObjectContexts más allá del ámbito de Hola de este documento.</span><span class="sxs-lookup"><span data-stu-id="2028e-252">A detailed discussion of ObjectContexts is beyond hello scope of this document.</span></span> |
| <span data-ttu-id="2028e-253">MyContext(DbConnection, DbCompiledModel,bool)</span><span class="sxs-lookup"><span data-stu-id="2028e-253">MyContext(DbConnection, DbCompiledModel,bool)</span></span> |<span data-ttu-id="2028e-254">ElasticScaleContext(ShardMap, TKey, DbCompiledModel, bool)</span><span class="sxs-lookup"><span data-stu-id="2028e-254">ElasticScaleContext(ShardMap, TKey, DbCompiledModel, bool)</span></span> |<span data-ttu-id="2028e-255">DbContext(DbConnection, DbCompiledModel, bool);</span><span class="sxs-lookup"><span data-stu-id="2028e-255">DbContext(DbConnection, DbCompiledModel, bool);</span></span> |<span data-ttu-id="2028e-256">conexión de Hello debe toobe inferir de mapa de particiones de Hola y la clave de Hola.</span><span class="sxs-lookup"><span data-stu-id="2028e-256">hello connection needs toobe inferred from hello shard map and hello key.</span></span> <span data-ttu-id="2028e-257">conexión de Hello no se pueden proporcionar como entrada (a menos que ya estaba usando esa entrada mapa de particiones de Hola y la clave de hello).</span><span class="sxs-lookup"><span data-stu-id="2028e-257">hello connection cannot be provided as an input (unless that input was already using hello shard map and hello key).</span></span> <span data-ttu-id="2028e-258">Modelo y un valor booleano se pasan en el constructor de clase base toohello.</span><span class="sxs-lookup"><span data-stu-id="2028e-258">Model and Boolean are passed on toohello base class constructor.</span></span> |

## <a name="shard-schema-deployment-through-ef-migrations"></a><span data-ttu-id="2028e-259">Implementación del esquema de partición mediante migraciones de EF</span><span class="sxs-lookup"><span data-stu-id="2028e-259">Shard schema deployment through EF migrations</span></span>
<span data-ttu-id="2028e-260">Administración automática de esquemas es una comodidad que ofrece Hola Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="2028e-260">Automatic schema management is a convenience provided by hello Entity Framework.</span></span> <span data-ttu-id="2028e-261">En el contexto de Hola de aplicaciones mediante herramientas de base de datos elástica, queremos tooretain este particiones capacidad tooautomatically aprovisionar Hola esquema toonewly creado cuando las bases de datos se agregan aplicación particionada toohello.</span><span class="sxs-lookup"><span data-stu-id="2028e-261">In hello context of applications using elastic database tools, we want tooretain this capability tooautomatically provision hello schema toonewly created shards when databases are added toohello sharded application.</span></span> <span data-ttu-id="2028e-262">Hola uso principal es la capacidad de tooincrease en la capa de datos de Hola para aplicaciones con particiones mediante EF.</span><span class="sxs-lookup"><span data-stu-id="2028e-262">hello primary use case is tooincrease capacity at hello data tier for sharded applications using EF.</span></span> <span data-ttu-id="2028e-263">Confiar en las capacidades de EF para administrar el esquema reduce el esfuerzo de administración de base de datos de hello con una aplicación particionada basada en EF.</span><span class="sxs-lookup"><span data-stu-id="2028e-263">Relying on EF’s capabilities for schema management reduces hello database administration effort with a sharded application built on EF.</span></span> 

<span data-ttu-id="2028e-264">La implementación del esquema a través de migraciones de EF funciona mejor en **conexiones sin abrir**.</span><span class="sxs-lookup"><span data-stu-id="2028e-264">Schema deployment through EF migrations works best on **unopened connections**.</span></span> <span data-ttu-id="2028e-265">En cambio trata toohello escenario de enrutamiento dependiente de datos que se basa en conexión Hola abierto proporcionado por la API de cliente de base de datos elástica Hola.</span><span class="sxs-lookup"><span data-stu-id="2028e-265">This is in contrast toohello scenario for data dependent routing that relies on hello opened connection provided by hello elastic database client API.</span></span> <span data-ttu-id="2028e-266">Otra diferencia es el requisito de coherencia de hello: al tooensure deseable coherencia para todos los datos dependientes enrutamiento conexiones tooprotect contra la manipulación de mapa de particiones simultáneas, no es un problema con la base de datos de esquema inicial implementación tooa nueva que tiene todavía no se ha registrado en el mapa de particiones de Hola y todavía no ha asignado toohold shardlets.</span><span class="sxs-lookup"><span data-stu-id="2028e-266">Another difference is hello consistency requirement: While desirable tooensure consistency for all data-dependent routing connections tooprotect against concurrent shard map manipulation, it is not a concern with initial schema deployment tooa new database that has not yet been registered in hello shard map, and not yet been allocated toohold shardlets.</span></span> <span data-ttu-id="2028e-267">Por lo tanto, podemos dependen conexiones de base de datos normal para esta escenarios, como el enrutamiento de toodata dependiente opuestos.</span><span class="sxs-lookup"><span data-stu-id="2028e-267">We can therefore rely on regular database connections for this scenarios, as opposed toodata-dependent routing.</span></span>  

<span data-ttu-id="2028e-268">Esto conduce a tooan enfoque donde implementación del esquema a través de las migraciones de EF está asociado estrechamente al registro de hello de base de datos nueva hello como una partición en el mapa de particiones de la aplicación hello.</span><span class="sxs-lookup"><span data-stu-id="2028e-268">This leads tooan approach where schema deployment through EF migrations is tightly coupled with hello registration of hello new database as a shard in hello application’s shard map.</span></span> <span data-ttu-id="2028e-269">Esto se basa en hello siguiendo los requisitos previos:</span><span class="sxs-lookup"><span data-stu-id="2028e-269">This relies on hello following prerequisites:</span></span> 

* <span data-ttu-id="2028e-270">base de datos de Hello ya se ha creado.</span><span class="sxs-lookup"><span data-stu-id="2028e-270">hello database has already been created.</span></span> 
* <span data-ttu-id="2028e-271">base de datos de Hello está vacío, contiene ningún esquema de usuario y no hay datos de usuario.</span><span class="sxs-lookup"><span data-stu-id="2028e-271">hello database is empty - it holds no user schema and no user data.</span></span>
* <span data-ttu-id="2028e-272">base de datos de Hello aún no son accesibles a través de las API de cliente de base de datos elástica hello para el enrutamiento dependiente de los datos.</span><span class="sxs-lookup"><span data-stu-id="2028e-272">hello database cannot yet be accessed through hello elastic database client APIs for data-dependent routing.</span></span> 

<span data-ttu-id="2028e-273">Con estos requisitos previos en su lugar, podemos crear normal sin abierto **SqlConnection** tookick desactivar las migraciones de EF para la implementación del esquema.</span><span class="sxs-lookup"><span data-stu-id="2028e-273">With these prerequisites in place, we can create a regular un-opened **SqlConnection** tookick off EF migrations for schema deployment.</span></span> <span data-ttu-id="2028e-274">Hola siguiendo el ejemplo de código muestra este enfoque.</span><span class="sxs-lookup"><span data-stu-id="2028e-274">hello following code sample illustrates this approach.</span></span> 

        // Enter a new shard - i.e. an empty database - toohello shard map, allocate a first tenant tooit  
        // and kick off EF intialization of hello database toodeploy schema 

        public void RegisterNewShard(string server, string database, string connStr, int key) 
        { 

            Shard shard = this.ShardMap.CreateShard(new ShardLocation(server, database)); 

            SqlConnectionStringBuilder connStrBldr = new SqlConnectionStringBuilder(connStr); 
            connStrBldr.DataSource = server; 
            connStrBldr.InitialCatalog = database; 

            // Go into a DbContext tootrigger migrations and schema deployment for hello new shard. 
            // This requires an un-opened connection. 
            using (var db = new ElasticScaleContext<int>(connStrBldr.ConnectionString)) 
            { 
                // Run a query tooengage EF migrations 
                (from b in db.Blogs 
                    select b).Count(); 
            } 

            // Register hello mapping of hello tenant toohello shard in hello shard map. 
            // After this step, data-dependent routing on hello shard map can be used 

            this.ShardMap.CreatePointMapping(key, shard); 
        } 


<span data-ttu-id="2028e-275">Este ejemplo muestra el método hello **RegisterNewShard** que registros Hola particiones en mapa de particiones de hello, implementa el esquema de Hola a través de las migraciones de EF y almacena una asignación de una partición de toohello clave de particionamiento.</span><span class="sxs-lookup"><span data-stu-id="2028e-275">This sample shows hello method **RegisterNewShard** that registers hello shard in hello shard map, deploys hello schema through EF migrations, and stores a mapping of a sharding key toohello shard.</span></span> <span data-ttu-id="2028e-276">Se basa en un constructor de hello **DbContext** subclase (**ElasticScaleContext** en el ejemplo de Hola) que toma una cadena de conexión de SQL como entrada.</span><span class="sxs-lookup"><span data-stu-id="2028e-276">It relies on a constructor of hello **DbContext** subclass (**ElasticScaleContext** in hello sample) that takes a SQL connection string as input.</span></span> <span data-ttu-id="2028e-277">código de Hello de este constructor es sencilla, como Hola siguiente ejemplo se muestra:</span><span class="sxs-lookup"><span data-stu-id="2028e-277">hello code of this constructor is straight-forward, as hello following example shows:</span></span> 

        // C'tor toodeploy schema and migrations tooa new shard 
        protected internal ElasticScaleContext(string connectionString) 
            : base(SetInitializerForConnection(connectionString)) 
        { 
        } 

        // Only static methods are allowed in calls into base class c'tors 
        private static string SetInitializerForConnection(string connnectionString) 
        { 
            // We want existence checks so that hello schema can get deployed 
            Database.SetInitializer<ElasticScaleContext<T>>( 
        new CreateDatabaseIfNotExists<ElasticScaleContext<T>>()); 

            return connnectionString; 
        } 

<span data-ttu-id="2028e-278">Una posible que haya usado la versión Hola de constructor Hola que se hereda de la clase base Hola.</span><span class="sxs-lookup"><span data-stu-id="2028e-278">One might have used hello version of hello constructor inherited from hello base class.</span></span> <span data-ttu-id="2028e-279">Pero Hola código necesidades tooensure que Hola inicializador de manera predeterminada para EF se utiliza al conectarse.</span><span class="sxs-lookup"><span data-stu-id="2028e-279">But hello code needs tooensure that hello default initializer for EF is used when connecting.</span></span> <span data-ttu-id="2028e-280">Por lo tanto, Hola desvío corto en el método estático de hello antes de llamar al constructor de clase base Hola con cadena de conexión de Hola.</span><span class="sxs-lookup"><span data-stu-id="2028e-280">Hence hello short detour into hello static method before calling into hello base class constructor with hello connection string.</span></span> <span data-ttu-id="2028e-281">Tenga en cuenta que el registro de hello de particiones debe ejecutarse en un tooensure de dominio o un proceso de aplicación distinta configuración de inicializador de Hola para EF no entren en conflicto.</span><span class="sxs-lookup"><span data-stu-id="2028e-281">Note that hello registration of shards should run in a different app domain or process tooensure that hello initializer settings for EF do not conflict.</span></span> 

## <a name="limitations"></a><span data-ttu-id="2028e-282">Limitaciones</span><span class="sxs-lookup"><span data-stu-id="2028e-282">Limitations</span></span>
<span data-ttu-id="2028e-283">enfoques de Hola que se describen en este documento implican un par de limitaciones:</span><span class="sxs-lookup"><span data-stu-id="2028e-283">hello approaches outlined in this document entail a couple of limitations:</span></span> 

* <span data-ttu-id="2028e-284">Las aplicaciones de EF que utilizan **LocalDb** necesita primero la base de datos de SQL Server normal de toomigrate tooa antes de usar la biblioteca de cliente de base de datos elástica.</span><span class="sxs-lookup"><span data-stu-id="2028e-284">EF applications that use **LocalDb** first need toomigrate tooa regular SQL Server database before using elastic database client library.</span></span> <span data-ttu-id="2028e-285">El escalado horizontal de una aplicación mediante particionamiento con Escalado elástico no es posible con **LocalDb**.</span><span class="sxs-lookup"><span data-stu-id="2028e-285">Scaling out an application through sharding with Elastic Scale is not possible with **LocalDb**.</span></span> <span data-ttu-id="2028e-286">Tenga en cuenta que los desarrolladores pueden seguir usando **LocalDb**.</span><span class="sxs-lookup"><span data-stu-id="2028e-286">Note that development can still use **LocalDb**.</span></span> 
* <span data-ttu-id="2028e-287">Cualquier aplicación de toohello de cambios que implican cambios de esquema de base de datos necesita toogo a través de las migraciones de EF en todas las particiones.</span><span class="sxs-lookup"><span data-stu-id="2028e-287">Any changes toohello application that imply database schema changes need toogo through EF migrations on all shards.</span></span> <span data-ttu-id="2028e-288">código de ejemplo de Hola para este documento no se muestra cómo toodo esto.</span><span class="sxs-lookup"><span data-stu-id="2028e-288">hello sample code for this document does not demonstrate how toodo this.</span></span> <span data-ttu-id="2028e-289">Considere el uso de Update-Database con una tooiterate de parámetro ConnectionString sobre todas las particiones; ni un script de Hola T-SQL de extracción para hello pendiente de migración mediante Update-Database con Hola - opción de secuencia de comandos y aplicar particiones de tooyour de script de Hola T-SQL.</span><span class="sxs-lookup"><span data-stu-id="2028e-289">Consider using Update-Database with a ConnectionString parameter tooiterate over all shards; or extract hello T-SQL script for hello pending migration using Update-Database with hello -Script option and apply hello T-SQL script tooyour shards.</span></span>  
* <span data-ttu-id="2028e-290">Dada una solicitud, se asume que todo el procesamiento de la base de datos está contenido en una sola partición identificada por la clave de particionamiento de hello proporcionada por solicitud de saludo.</span><span class="sxs-lookup"><span data-stu-id="2028e-290">Given a request, it is assumed that all of its database processing is contained within a single shard as identified by hello sharding key provided by hello request.</span></span> <span data-ttu-id="2028e-291">Sin embargo, esta suposición no siempre es cierta.</span><span class="sxs-lookup"><span data-stu-id="2028e-291">However, this assumption does not always hold true.</span></span> <span data-ttu-id="2028e-292">Por ejemplo, cuando no es posible toomake una clave de particionamiento disponible.</span><span class="sxs-lookup"><span data-stu-id="2028e-292">For example, when it is not possible toomake a sharding key available.</span></span> <span data-ttu-id="2028e-293">tooaddress, Hola biblioteca de cliente proporciona hello **MultiShardQuery** clase que implementa una abstracción de conexión para las consultas en varias particiones.</span><span class="sxs-lookup"><span data-stu-id="2028e-293">tooaddress this, hello client library provides hello **MultiShardQuery** class that implements a connection abstraction for querying over several shards.</span></span> <span data-ttu-id="2028e-294">Aprendizaje hello toouse **MultiShardQuery** en combinación con EF está más allá del ámbito de Hola de este documento</span><span class="sxs-lookup"><span data-stu-id="2028e-294">Learning toouse hello **MultiShardQuery** in combination with EF is beyond hello scope of this document</span></span>

## <a name="conclusion"></a><span data-ttu-id="2028e-295">Conclusión</span><span class="sxs-lookup"><span data-stu-id="2028e-295">Conclusion</span></span>
<span data-ttu-id="2028e-296">Hola pasos que se describen en este documento, aplicaciones de EF pueden utilizar capacidad de la biblioteca de cliente de hello elástico de base de datos para datos que dependen de enrutamiento mediante la refactorización de constructores de hello **DbContext** subclases usa Hola EF aplicación.</span><span class="sxs-lookup"><span data-stu-id="2028e-296">Through hello steps outlined in this document, EF applications can use hello elastic database client library's capability for data dependent routing by refactoring constructors of hello **DbContext** subclasses used in hello EF application.</span></span> <span data-ttu-id="2028e-297">Este límites Hola requerían toothose los lugares donde **DbContext** clases ya existen.</span><span class="sxs-lookup"><span data-stu-id="2028e-297">This limits hello  changes required toothose places where **DbContext** classes already exist.</span></span> <span data-ttu-id="2028e-298">Además, las aplicaciones de EF pueden seguir toobenefit de implementación automática de esquemas mediante la combinación de pasos de Hola que invocan Hola necesarios EF migraciones con el registro de hello de nuevas particiones y las asignaciones en el mapa de particiones de Hola.</span><span class="sxs-lookup"><span data-stu-id="2028e-298">In addition, EF applications can continue toobenefit from automatic schema deployment by combining hello steps that invoke hello necessary EF migrations with hello registration of new shards and mappings in hello shard map.</span></span> 

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Image references-->
[1]: ./media/sql-database-elastic-scale-use-entity-framework-applications-visual-studio/sample.png
