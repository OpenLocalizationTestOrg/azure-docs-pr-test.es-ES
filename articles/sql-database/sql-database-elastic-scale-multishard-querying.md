---
title: Consulta de bases de datos Azure SQL Database con particiones | Microsoft Docs
description: "Ejecute consultas a través de particiones con la biblioteca de cliente de bases de datos elásticas."
services: sql-database
documentationcenter: 
manager: jhubbard
author: torsteng
editor: 
ms.assetid: a4379c15-f213-4026-ab6f-a450ee9d5758
ms.service: sql-database
ms.custom: scale out apps
ms.workload: sql-database
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 04/12/2016
ms.author: torsteng
ms.openlocfilehash: 67bcb3c7fe33341103f28bc70e8cc2acbb924cae
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 07/11/2017
---
# <a name="multi-shard-querying"></a><span data-ttu-id="207e2-103">Consultas a través de particiones múltiples</span><span class="sxs-lookup"><span data-stu-id="207e2-103">Multi-shard querying</span></span>
## <a name="overview"></a><span data-ttu-id="207e2-104">Información general</span><span class="sxs-lookup"><span data-stu-id="207e2-104">Overview</span></span>
<span data-ttu-id="207e2-105">Con las [herramientas de Base de datos elástica](sql-database-elastic-scale-introduction.md), puede crear soluciones de base de datos particionadas.</span><span class="sxs-lookup"><span data-stu-id="207e2-105">With the [Elastic Database tools](sql-database-elastic-scale-introduction.md), you can create sharded database solutions.</span></span> <span data-ttu-id="207e2-106">**Consultas a través de particiones múltiples** se usa para tareas como informes y recopilación de datos que requieren ejecutar una consulta que abarca varias particiones.</span><span class="sxs-lookup"><span data-stu-id="207e2-106">**Multi-shard querying** is used for tasks such as data collection/reporting that require running a query that stretches across several shards.</span></span> <span data-ttu-id="207e2-107">(Compare esto con el [enrutamiento dependiente de los datos](sql-database-elastic-scale-data-dependent-routing.md), que ejecuta todo el trabajo en una sola partición).</span><span class="sxs-lookup"><span data-stu-id="207e2-107">(Contrast this to [data-dependent routing](sql-database-elastic-scale-data-dependent-routing.md), which performs all work on a single shard.)</span></span> 

1. <span data-ttu-id="207e2-108">Obtenga una clase [**RangeShardMap**](https://msdn.microsoft.com/library/azure/dn807318.aspx) o [**ListShardMap**](https://msdn.microsoft.com/library/azure/dn807370.aspx) con el método [**TryGetRangeShardMap**](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.trygetrangeshardmap.aspx), [**TryGetListShardMap**](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.trygetlistshardmap.aspx) o [**GetShardMap**](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getshardmap.aspx).</span><span class="sxs-lookup"><span data-stu-id="207e2-108">Get a [**RangeShardMap**](https://msdn.microsoft.com/library/azure/dn807318.aspx) or [**ListShardMap**](https://msdn.microsoft.com/library/azure/dn807370.aspx) using the [**TryGetRangeShardMap**](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.trygetrangeshardmap.aspx), the [**TryGetListShardMap**](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.trygetlistshardmap.aspx), or the [**GetShardMap**](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getshardmap.aspx) method.</span></span> <span data-ttu-id="207e2-109">Consulte [**Construcción de un ShardMapManager**](sql-database-elastic-scale-shard-map-management.md#constructing-a-shardmapmanager) y [**Obtención de las clases RangeShardMap o ListShardMap**](sql-database-elastic-scale-shard-map-management.md#get-a-rangeshardmap-or-listshardmap).</span><span class="sxs-lookup"><span data-stu-id="207e2-109">See [**Constructing a ShardMapManager**](sql-database-elastic-scale-shard-map-management.md#constructing-a-shardmapmanager) and [**Get a RangeShardMap or ListShardMap**](sql-database-elastic-scale-shard-map-management.md#get-a-rangeshardmap-or-listshardmap).</span></span>
2. <span data-ttu-id="207e2-110">Cree un objeto **[MultiShardConnection](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardconnection.aspx)**.</span><span class="sxs-lookup"><span data-stu-id="207e2-110">Create a **[MultiShardConnection](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardconnection.aspx)** object.</span></span>
3. <span data-ttu-id="207e2-111">Cree un objeto **[MultiShardCommand](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardcommand.aspx)**.</span><span class="sxs-lookup"><span data-stu-id="207e2-111">Create a **[MultiShardCommand](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardcommand.aspx)**.</span></span> 
4. <span data-ttu-id="207e2-112">Establezca la **[propiedad CommandText](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardcommand.commandtext.aspx#P:Microsoft.Azure.SqlDatabase.ElasticScale.Query.MultiShardCommand.CommandText)** en un comando T-SQL.</span><span class="sxs-lookup"><span data-stu-id="207e2-112">Set the **[CommandText property](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardcommand.commandtext.aspx#P:Microsoft.Azure.SqlDatabase.ElasticScale.Query.MultiShardCommand.CommandText)** to a T-SQL command.</span></span>
5. <span data-ttu-id="207e2-113">Ejecute el comando mediante la invocación del **[método ExecuteReader](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardcommand.executereader.aspx)**.</span><span class="sxs-lookup"><span data-stu-id="207e2-113">Execute the command by calling the **[ExecuteReader method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardcommand.executereader.aspx)**.</span></span>
6. <span data-ttu-id="207e2-114">Vea los resultados con la **[clase MultiShardDataReader](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multisharddatareader.aspx)**.</span><span class="sxs-lookup"><span data-stu-id="207e2-114">View the results using the **[MultiShardDataReader class](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multisharddatareader.aspx)**.</span></span> 

## <a name="example"></a><span data-ttu-id="207e2-115">Ejemplo</span><span class="sxs-lookup"><span data-stu-id="207e2-115">Example</span></span>
<span data-ttu-id="207e2-116">El código siguiente ilustra el uso de consultas a través de particiones múltiples con un **ShardMap** llamado *myShardMap*.</span><span class="sxs-lookup"><span data-stu-id="207e2-116">The following code illustrates the usage of multi-shard querying using a given **ShardMap** named *myShardMap*.</span></span> 

    using (MultiShardConnection conn = new MultiShardConnection( 
                                        myShardMap.GetShards(), 
                                        myShardConnectionString) 
          ) 
    { 
    using (MultiShardCommand cmd = conn.CreateCommand())
           { 
            cmd.CommandText = "SELECT c1, c2, c3 FROM ShardedTable"; 
            cmd.CommandType = CommandType.Text; 
            cmd.ExecutionOptions = MultiShardExecutionOptions.IncludeShardNameColumn; 
            cmd.ExecutionPolicy = MultiShardExecutionPolicy.PartialResults; 

            using (MultiShardDataReader sdr = cmd.ExecuteReader()) 
                { 
                    while (sdr.Read())
                        { 
                            var c1Field = sdr.GetString(0); 
                            var c2Field = sdr.GetFieldValue<int>(1); 
                            var c3Field = sdr.GetFieldValue<Int64>(2);
                        } 
                 } 
           } 
    } 


<span data-ttu-id="207e2-117">Una diferencia clave es la construcción de conexiones entre particiones múltiples.</span><span class="sxs-lookup"><span data-stu-id="207e2-117">A key difference is the construction of multi-shard connections.</span></span> <span data-ttu-id="207e2-118">Donde **SqlConnection** opera en una sola base de datos, **MultiShardConnection** toma una ***colección de particiones*** como entrada.</span><span class="sxs-lookup"><span data-stu-id="207e2-118">Where **SqlConnection** operates on a single database, the **MultiShardConnection** takes a ***collection of shards*** as its input.</span></span> <span data-ttu-id="207e2-119">Complete la recopilación de particiones a partir de un mapa de particiones.</span><span class="sxs-lookup"><span data-stu-id="207e2-119">Populate the collection of shards from a shard map.</span></span> <span data-ttu-id="207e2-120">Luego la consulta se ejecuta en la recopilación de particiones usando la semántica **UNION ALL** para ensamblar un solo resultado global.</span><span class="sxs-lookup"><span data-stu-id="207e2-120">The query is then executed on the collection of shards using **UNION ALL** semantics to assemble a single overall result.</span></span> <span data-ttu-id="207e2-121">De manera opcional, el nombre de la partición donde se origina la fila se puede agregar a la salida usando la propiedad **ExecutionOptions** en el comando.</span><span class="sxs-lookup"><span data-stu-id="207e2-121">Optionally, the name of the shard where the row originates from can be added to the output using the **ExecutionOptions** property on command.</span></span> 

<span data-ttu-id="207e2-122">Observe la llamada a **myShardMap.GetShards()**.</span><span class="sxs-lookup"><span data-stu-id="207e2-122">Note the call to **myShardMap.GetShards()**.</span></span> <span data-ttu-id="207e2-123">Este método recupera todas las particiones desde el mapa de particiones y brinda una manera fácil de ejecutar una consulta a través de todas las bases de datos importantes.</span><span class="sxs-lookup"><span data-stu-id="207e2-123">This method retrieves all shards from the shard map and provides an easy way to run a query across all relevant databases.</span></span> <span data-ttu-id="207e2-124">La colección de particiones para una consulta a través de particiones múltiples se puede restringir aún más si se realiza una consulta LINQ sobre la colección devuelta desde la llamada a **myShardMap.GetShards()**.</span><span class="sxs-lookup"><span data-stu-id="207e2-124">The collection of shards for a multi-shard query can be refined further by performing a LINQ query over the collection returned from the call to **myShardMap.GetShards()**.</span></span> <span data-ttu-id="207e2-125">En combinación con la directiva de resultados parciales, la actual capacidad en las consultas a través de particiones múltiples se diseñó para funcionar bien con decenas, y hasta centenas, de particiones.</span><span class="sxs-lookup"><span data-stu-id="207e2-125">In combination with the partial results policy, the current capability in multi-shard querying has been designed to work well for tens up to hundreds of shards.</span></span>

<span data-ttu-id="207e2-126">Una limitación con las consultas a través de particiones múltiples actualmente es la falta de validación de las particiones y de los shardlets que se consultan.</span><span class="sxs-lookup"><span data-stu-id="207e2-126">A limitation with multi-shard querying is currently the lack of validation for shards and shardlets that are queried.</span></span> <span data-ttu-id="207e2-127">Mientras que el enrutamiento dependiente de los datos comprueba que una partición determinada sea parte del mapa de particiones en el momento de la consulta, las consultas a través de particiones múltiples no realizan esta comprobación.</span><span class="sxs-lookup"><span data-stu-id="207e2-127">While data-dependent routing verifies that a given shard is part of the shard map at the time of querying, multi-shard queries do not perform this check.</span></span> <span data-ttu-id="207e2-128">Esto puede llevar a que las consultas a través de particiones múltiples se ejecuten en bases de datos que se han quitado del mapa de particiones.</span><span class="sxs-lookup"><span data-stu-id="207e2-128">This can lead to multi-shard queries running on databases that have  been removed from the shard map.</span></span>

## <a name="multi-shard-queries-and-split-merge-operations"></a><span data-ttu-id="207e2-129">Consultas a través de particiones múltiples y operaciones de división y combinación</span><span class="sxs-lookup"><span data-stu-id="207e2-129">Multi-shard queries and split-merge operations</span></span>
<span data-ttu-id="207e2-130">Las consultas a través de particiones múltiples no comprueban si los shardlets en la base de datos consultada forman parte de las operaciones de división y combinación en curso.</span><span class="sxs-lookup"><span data-stu-id="207e2-130">Multi-shard queries do not verify whether shardlets on the queried database are participating in ongoing split-merge operations.</span></span> <span data-ttu-id="207e2-131">(Consulte el artículo sobre [escalado con la herramienta de división y combinación de Elastic Database](sql-database-elastic-scale-overview-split-and-merge.md)). Esto puede llevar a incoherencias donde las filas del mismo shardlet se muestran para bases de datos múltiples en la misma consulta a través de particiones múltiples.</span><span class="sxs-lookup"><span data-stu-id="207e2-131">(See [Scaling using the Elastic Database split-merge tool](sql-database-elastic-scale-overview-split-and-merge.md).) This can lead to inconsistencies where rows from the same shardlet show for multiple databases in the same multi-shard query.</span></span> <span data-ttu-id="207e2-132">Tenga en cuenta estas limitaciones y considere la posibilidad de agotar las operaciones de división y combinación y los cambios en el mapa de particiones mientras se realizan consultas a través de particiones múltiples.</span><span class="sxs-lookup"><span data-stu-id="207e2-132">Be aware of these limitations and consider draining ongoing split-merge operations and changes to the shard map while performing multi-shard queries.</span></span>

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

## <a name="see-also"></a><span data-ttu-id="207e2-133">Consulte también</span><span class="sxs-lookup"><span data-stu-id="207e2-133">See also</span></span>
<span data-ttu-id="207e2-134">Clases y métodos **[System.Data.SqlClient](http://msdn.microsoft.com/library/System.Data.SqlClient.aspx)**.</span><span class="sxs-lookup"><span data-stu-id="207e2-134">**[System.Data.SqlClient](http://msdn.microsoft.com/library/System.Data.SqlClient.aspx)** classes and methods.</span></span>

<span data-ttu-id="207e2-135">Administre las particiones con la [biblioteca de cliente de Base de datos elástica](sql-database-elastic-database-client-library.md).</span><span class="sxs-lookup"><span data-stu-id="207e2-135">Manage shards using the [Elastic Database client library](sql-database-elastic-database-client-library.md).</span></span> <span data-ttu-id="207e2-136">Incluye un nuevo espacio de nombres llamado [Microsoft.Azure.SqlDatabase.ElasticScale.Query](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.aspx) que proporciona la capacidad de consultar varias particiones con una sola solicitud y un resultado.</span><span class="sxs-lookup"><span data-stu-id="207e2-136">Includes a  namespace called [Microsoft.Azure.SqlDatabase.ElasticScale.Query](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.aspx) that provides the ability to query multiple shards using a single query and result.</span></span> <span data-ttu-id="207e2-137">Brinda una abstracción de consulta sobre una recopilación de particiones.</span><span class="sxs-lookup"><span data-stu-id="207e2-137">It provides a querying abstraction over a collection of shards.</span></span> <span data-ttu-id="207e2-138">También proporciona directivas de ejecución alternativas, en especial resultados parciales, para abordar errores cuando se consulte sobre muchas particiones.</span><span class="sxs-lookup"><span data-stu-id="207e2-138">It also provides alternative execution policies, in particular partial results, to deal with failures when querying over many shards.</span></span>  

