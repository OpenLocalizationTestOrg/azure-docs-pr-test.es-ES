---
title: aaaUsing particiones de Recovery Manager toofix asignar problemas | Documentos de Microsoft
description: Utilice los problemas de hello RecoveryManager clase toosolve con mapas de particiones
services: sql-database
documentationcenter: 
manager: jhubbard
author: ddove
ms.assetid: 45520ca3-6903-4b39-88ba-1d41b22da9fe
ms.service: sql-database
ms.custom: scale out apps
ms.workload: sql-database
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 10/25/2016
ms.author: ddove
ms.openlocfilehash: 2218fb15122f1df466e65483480461e366317f2f
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 10/06/2017
---
# <a name="using-hello-recoverymanager-class-toofix-shard-map-problems"></a><span data-ttu-id="bc589-103">Uso de los problemas de asignación de particiones de la clase toofix de hello RecoveryManager</span><span class="sxs-lookup"><span data-stu-id="bc589-103">Using hello RecoveryManager class toofix shard map problems</span></span>
<span data-ttu-id="bc589-104">Hola [RecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.aspx) clase proporciona a las aplicaciones de ADO.Net Hola capacidad tooeasily detectar y corregir las incoherencias entre el mapa de particiones global de hello (GSM) y el mapa de particiones locales de hello (LSM) en un entorno de base de datos particionada.</span><span class="sxs-lookup"><span data-stu-id="bc589-104">hello [RecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.aspx) class provides ADO.Net applications hello ability tooeasily detect and correct any inconsistencies between hello global shard map (GSM) and hello local shard map (LSM) in a sharded database environment.</span></span> 

<span data-ttu-id="bc589-105">Hola GSM y LSM pista Hola asignación de cada base de datos en un entorno particionado.</span><span class="sxs-lookup"><span data-stu-id="bc589-105">hello GSM and LSM track hello mapping of each database in a sharded environment.</span></span> <span data-ttu-id="bc589-106">En ocasiones, se produce una interrupción entre Hola GSM y Hola LSM.</span><span class="sxs-lookup"><span data-stu-id="bc589-106">Occasionally, a break occurs between hello GSM and hello LSM.</span></span> <span data-ttu-id="bc589-107">En ese caso, utilice hello RecoveryManager clase toodetect y reparar salto Hola.</span><span class="sxs-lookup"><span data-stu-id="bc589-107">In that case, use hello RecoveryManager class toodetect and repair hello break.</span></span>

<span data-ttu-id="bc589-108">Hola RecoveryManager clase forma parte del programa Hola a [biblioteca de cliente de base de datos elástica](sql-database-elastic-database-client-library.md).</span><span class="sxs-lookup"><span data-stu-id="bc589-108">hello RecoveryManager class is part of hello [Elastic Database client library](sql-database-elastic-database-client-library.md).</span></span> 

![Mapa de particiones][1]

<span data-ttu-id="bc589-110">Para definiciones de términos, consulte el [Glosario de herramientas de base de datos elástica](sql-database-elastic-scale-glossary.md).</span><span class="sxs-lookup"><span data-stu-id="bc589-110">For term definitions, see [Elastic Database tools glossary](sql-database-elastic-scale-glossary.md).</span></span> <span data-ttu-id="bc589-111">Cómo Hola toounderstand **ShardMapManager** toomanage usa datos en una solución particionada, consulte [administración de mapa de particiones](sql-database-elastic-scale-shard-map-management.md).</span><span class="sxs-lookup"><span data-stu-id="bc589-111">toounderstand how hello **ShardMapManager** is used toomanage data in a sharded solution, see [Shard map management](sql-database-elastic-scale-shard-map-management.md).</span></span>

## <a name="why-use-hello-recovery-manager"></a><span data-ttu-id="bc589-112">¿Por qué usar el Administrador de recuperación Hola?</span><span class="sxs-lookup"><span data-stu-id="bc589-112">Why use hello recovery manager?</span></span>
<span data-ttu-id="bc589-113">En un entorno de base de datos particionada, hay un inquilino por base de datos y muchas bases de datos por servidor.</span><span class="sxs-lookup"><span data-stu-id="bc589-113">In a sharded database environment, there is one tenant per database, and many databases per server.</span></span> <span data-ttu-id="bc589-114">También puede haber muchos servidores en el entorno de Hola.</span><span class="sxs-lookup"><span data-stu-id="bc589-114">There can also be many servers in hello environment.</span></span> <span data-ttu-id="bc589-115">Cada base de datos está asignada en el mapa de particiones de hello, por lo que pueden ser llamadas de base de datos y servidor correctos toohello enrutado.</span><span class="sxs-lookup"><span data-stu-id="bc589-115">Each database is mapped in hello shard map, so calls can be routed toohello correct server and database.</span></span> <span data-ttu-id="bc589-116">Se realiza el seguimiento de las bases de datos según tooa **clave de particionamiento**, y se asigna cada partición un **intervalo de valores de clave**.</span><span class="sxs-lookup"><span data-stu-id="bc589-116">Databases are tracked according tooa **sharding key**, and each shard is assigned a **range of key values**.</span></span> <span data-ttu-id="bc589-117">Por ejemplo, una clave de particionamiento puede representar los nombres de cliente hello de "D" demasiado "f"</span><span class="sxs-lookup"><span data-stu-id="bc589-117">For example, a sharding key may represent hello customer names from "D" too"F."</span></span> <span data-ttu-id="bc589-118">Hola la asignación de todas las particiones (también conocido como bases de datos) y sus rangos de asignación están incluidos en hello **mapa de particiones global (GSM)**.</span><span class="sxs-lookup"><span data-stu-id="bc589-118">hello mapping of all shards (aka databases) and their mapping ranges are contained in hello **global shard map (GSM)**.</span></span> <span data-ttu-id="bc589-119">Cada base de datos también contiene una asignación de intervalos de hello contenidos en la partición de Hola que se conoce como hello **mapa de particiones locales (LSM)**.</span><span class="sxs-lookup"><span data-stu-id="bc589-119">Each database also contains a map of hello ranges contained on hello shard that is known as hello **local shard map (LSM)**.</span></span> <span data-ttu-id="bc589-120">Cuando una aplicación se conecta tooa particiones, asignación de Hola se almacena en caché con la aplicación hello para la recuperación rápida.</span><span class="sxs-lookup"><span data-stu-id="bc589-120">When an app connects tooa shard, hello mapping is cached with hello app for quick retrieval.</span></span> <span data-ttu-id="bc589-121">Hola LSM es toovalidate usado en caché datos.</span><span class="sxs-lookup"><span data-stu-id="bc589-121">hello LSM is used toovalidate cached data.</span></span> 

<span data-ttu-id="bc589-122">Hello GSM y LSM pueden no estar sincronizados para hello siguientes motivos:</span><span class="sxs-lookup"><span data-stu-id="bc589-122">hello GSM and LSM may become out of sync for hello following reasons:</span></span>

1. <span data-ttu-id="bc589-123">eliminación de Hola de una partición cuyo intervalo se considera toono más estar en uso o cambiar el nombre de una partición.</span><span class="sxs-lookup"><span data-stu-id="bc589-123">hello deletion of a shard whose range is believed toono longer be in use, or renaming of a shard.</span></span> <span data-ttu-id="bc589-124">La eliminación de una partición da como resultado una **asignación de particiones huérfana**.</span><span class="sxs-lookup"><span data-stu-id="bc589-124">Deleting a shard results in an **orphaned shard mapping**.</span></span> <span data-ttu-id="bc589-125">De igual forma, una base de datos cuyo nombre cambió puede provocar una asignación de particiones huérfanas.</span><span class="sxs-lookup"><span data-stu-id="bc589-125">Similarly, a renamed database can cause an orphaned shard mapping.</span></span> <span data-ttu-id="bc589-126">Según el propósito de Hola de cambio de hello, particiones de hello quizás necesite toobe quitado o ubicación de la partición de hello necesita toobe actualizado.</span><span class="sxs-lookup"><span data-stu-id="bc589-126">Depending on hello intent of hello change, hello shard may need toobe removed or hello shard location needs toobe updated.</span></span> <span data-ttu-id="bc589-127">toorecover una base de datos eliminada, consulte [restaurar una base de datos eliminada](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="bc589-127">toorecover a deleted database, see [Restore a deleted database](sql-database-recovery-using-backups.md).</span></span>
2. <span data-ttu-id="bc589-128">Se produce un evento de conmutación por error geográfica.</span><span class="sxs-lookup"><span data-stu-id="bc589-128">A geo-failover event occurs.</span></span> <span data-ttu-id="bc589-129">toocontinue, uno debe actualizar el nombre del servidor de Hola y nombre de base de datos de administrador de mapa de particiones en la aplicación hello y, a continuación, detalles de la asignación de particiones de actualización Hola para todas las particiones en un mapa de particiones.</span><span class="sxs-lookup"><span data-stu-id="bc589-129">toocontinue, one must update hello server name, and database name of shard map manager in hello application and then update hello shard mapping details for all shards in a shard map.</span></span> <span data-ttu-id="bc589-130">Si se produce una conmutación geográfica, dicha lógica de recuperación debería automatizarse dentro de flujo de trabajo de conmutación por error de Hola.</span><span class="sxs-lookup"><span data-stu-id="bc589-130">If there is a geo-failover, such recovery logic should be automated within hello failover workflow.</span></span> <span data-ttu-id="bc589-131">La automatización de las acciones de recuperación permite una capacidad de administración sin contacto para bases de datos habilitadas geográficamente y evita acciones humanas manuales.</span><span class="sxs-lookup"><span data-stu-id="bc589-131">Automating recovery actions enables a frictionless manageability for geo-enabled databases and avoids manual human actions.</span></span> <span data-ttu-id="bc589-132">toolearn sobre toorecover opciones una base de datos si se produce una interrupción del centro de datos, vea [continuidad del negocio](sql-database-business-continuity.md) y [recuperación ante desastres](sql-database-disaster-recovery.md).</span><span class="sxs-lookup"><span data-stu-id="bc589-132">toolearn about options toorecover a database if there is a data center outage, see [Business Continuity](sql-database-business-continuity.md) and [Disaster Recovery](sql-database-disaster-recovery.md).</span></span>
3. <span data-ttu-id="bc589-133">Una partición o hello ShardMapManager base de datos es tooan restaurada anteriores un momento dado.</span><span class="sxs-lookup"><span data-stu-id="bc589-133">Either a shard or hello ShardMapManager database is restored tooan earlier point-in time.</span></span> <span data-ttu-id="bc589-134">toolearn sobre el punto de recuperación a un momento mediante copias de seguridad, consulte [recuperación mediante copias de seguridad](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="bc589-134">toolearn about point in time recovery using backups, see [Recovery using backups](sql-database-recovery-using-backups.md).</span></span>

<span data-ttu-id="bc589-135">Para obtener más información sobre herramientas de base de datos de elástico de base de datos de SQL de Azure, la replicación geográfica y restauración, vea Hola siguiente:</span><span class="sxs-lookup"><span data-stu-id="bc589-135">For more information about Azure SQL Database Elastic Database tools, geo-replication and Restore, see hello following:</span></span> 

* [<span data-ttu-id="bc589-136">Información general: continuidad del negocio en la nube y recuperación ante desastres con la Base de datos SQL</span><span class="sxs-lookup"><span data-stu-id="bc589-136">Overview: Cloud business continuity and database disaster recovery with SQL Database</span></span>](sql-database-business-continuity.md) 
* [<span data-ttu-id="bc589-137">Introducción a las herramientas de base de datos elástica</span><span class="sxs-lookup"><span data-stu-id="bc589-137">Get started with elastic database tools</span></span>](sql-database-elastic-scale-get-started.md)  
* [<span data-ttu-id="bc589-138">Administración de ShardMap</span><span class="sxs-lookup"><span data-stu-id="bc589-138">ShardMap Management</span></span>](sql-database-elastic-scale-shard-map-management.md)

## <a name="retrieving-recoverymanager-from-a-shardmapmanager"></a><span data-ttu-id="bc589-139">Recuperación de RecoveryManager desde un ShardMapManager</span><span class="sxs-lookup"><span data-stu-id="bc589-139">Retrieving RecoveryManager from a ShardMapManager</span></span>
<span data-ttu-id="bc589-140">Hola primer paso es una instancia de RecoveryManager toocreate.</span><span class="sxs-lookup"><span data-stu-id="bc589-140">hello first step is toocreate a RecoveryManager instance.</span></span> <span data-ttu-id="bc589-141">Hola [GetRecoveryManager método](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getrecoverymanager.aspx) devuelve Hola recovery manager para hello actual [ShardMapManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.aspx) instancia.</span><span class="sxs-lookup"><span data-stu-id="bc589-141">hello [GetRecoveryManager method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getrecoverymanager.aspx) returns hello recovery manager for hello current [ShardMapManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.aspx) instance.</span></span> <span data-ttu-id="bc589-142">tooaddress se asignan las incoherencias de particiones de hello, primero debe recuperar hello RecoveryManager para el mapa de particiones determinado de Hola.</span><span class="sxs-lookup"><span data-stu-id="bc589-142">tooaddress any inconsistencies in hello shard map, you must first retrieve hello RecoveryManager for hello particular shard map.</span></span> 

   ```
    ShardMapManager smm = ShardMapManagerFactory.GetSqlShardMapManager(smmConnnectionString,  
             ShardMapManagerLoadPolicy.Lazy);
             RecoveryManager rm = smm.GetRecoveryManager(); 
   ```

<span data-ttu-id="bc589-143">En este ejemplo, se inicializa hello RecoveryManager de hello ShardMapManager.</span><span class="sxs-lookup"><span data-stu-id="bc589-143">In this example, hello RecoveryManager is initialized from hello ShardMapManager.</span></span> <span data-ttu-id="bc589-144">Hola ShardMapManager que contiene un ShardMap también ya está inicializado.</span><span class="sxs-lookup"><span data-stu-id="bc589-144">hello ShardMapManager containing a ShardMap is also already initialized.</span></span> 

<span data-ttu-id="bc589-145">Puesto que este código de aplicación manipula propia asignación de particiones hello, Hola credenciales que se usan en el método de fábrica de hello (Hola anterior ejemplo, smmConnectionString) debe ser las credenciales que tienen permisos de lectura y escritura en base de datos de hello GSM al que hace referencia Hola cadena de conexión.</span><span class="sxs-lookup"><span data-stu-id="bc589-145">Since this application code manipulates hello shard map itself, hello credentials used in hello factory method (in hello preceding example, smmConnectionString) should be credentials that have read-write permissions on hello GSM database referenced by hello connection string.</span></span> <span data-ttu-id="bc589-146">Estas credenciales son suelen ser diferentes de las conexiones de tooopen de credenciales que se usan para el enrutamiento dependiente de los datos.</span><span class="sxs-lookup"><span data-stu-id="bc589-146">These credentials are typically different from credentials used tooopen connections for data-dependent routing.</span></span> <span data-ttu-id="bc589-147">Para obtener más información, consulte [con credenciales de cliente de base de datos elástica hello](sql-database-elastic-scale-manage-credentials.md).</span><span class="sxs-lookup"><span data-stu-id="bc589-147">For more information, see [Using credentials in hello elastic database client](sql-database-elastic-scale-manage-credentials.md).</span></span>

## <a name="removing-a-shard-from-hello-shardmap-after-a-shard-is-deleted"></a><span data-ttu-id="bc589-148">Quitar una partición de hello ShardMap después de elimina una partición</span><span class="sxs-lookup"><span data-stu-id="bc589-148">Removing a shard from hello ShardMap after a shard is deleted</span></span>
<span data-ttu-id="bc589-149">Hola [DetachShard método](https://msdn.microsoft.com/library/azure/dn842083.aspx) desasocia hello tiene particiones de mapa de particiones de Hola y elimina las asignaciones asociadas a la partición de Hola.</span><span class="sxs-lookup"><span data-stu-id="bc589-149">hello [DetachShard method](https://msdn.microsoft.com/library/azure/dn842083.aspx) detaches hello given shard from hello shard map and deletes mappings associated with hello shard.</span></span>  

* <span data-ttu-id="bc589-150">parámetro de ubicación de Hello es la ubicación de particiones de hello, específicamente el nombre del servidor y el nombre de base de datos de partición Hola va a separar.</span><span class="sxs-lookup"><span data-stu-id="bc589-150">hello location parameter is hello shard location, specifically server name and database name, of hello shard being detached.</span></span> 
* <span data-ttu-id="bc589-151">parámetro de Hello shardMapName es el nombre de mapa de particiones de Hola.</span><span class="sxs-lookup"><span data-stu-id="bc589-151">hello shardMapName parameter is hello shard map name.</span></span> <span data-ttu-id="bc589-152">Esto solo es necesario cuando se administran varias asignaciones de particiones por hello mismo administrador de mapa de particiones.</span><span class="sxs-lookup"><span data-stu-id="bc589-152">This is only required when multiple shard maps are managed by hello same shard map manager.</span></span> <span data-ttu-id="bc589-153">Opcional.</span><span class="sxs-lookup"><span data-stu-id="bc589-153">Optional.</span></span> 


> [!IMPORTANT]
> <span data-ttu-id="bc589-154">Use esta técnica solo si está seguro de que el rango de hello para la asignación de hello actualizado está vacío.</span><span class="sxs-lookup"><span data-stu-id="bc589-154">Use this technique only if you are certain that hello range for hello updated mapping is empty.</span></span> <span data-ttu-id="bc589-155">métodos de Hello anteriores no comprobar los datos para que se va a mover el intervalo de hello, por lo que es mejor tooinclude comprueba en el código.</span><span class="sxs-lookup"><span data-stu-id="bc589-155">hello methods above do not check data for hello range being moved, so it is best tooinclude checks in your code.</span></span>
>

<span data-ttu-id="bc589-156">Este ejemplo quita particiones de mapa de particiones de Hola.</span><span class="sxs-lookup"><span data-stu-id="bc589-156">This example removes shards from hello shard map.</span></span> 

   ```
   rm.DetachShard(s.Location, customerMap);
   ``` 

<span data-ttu-id="bc589-157">mapa de particiones de Hello refleja la ubicación de particiones de Hola Hola GSM antes de la eliminación de Hola de particiones de Hola.</span><span class="sxs-lookup"><span data-stu-id="bc589-157">hello shard map reflects hello shard location in hello GSM before hello deletion of hello shard.</span></span> <span data-ttu-id="bc589-158">Porque se eliminó la partición de hello, se supone esto fue intencionado, y el intervalo de claves de particionamiento de hello ya no está en uso.</span><span class="sxs-lookup"><span data-stu-id="bc589-158">Because hello shard was deleted, it is assumed this was intentional, and hello sharding key range is no longer in use.</span></span> <span data-ttu-id="bc589-159">De lo contrario, puede ejecutar la restauración a un momento dado.</span><span class="sxs-lookup"><span data-stu-id="bc589-159">If not, you can execute point-in time restore.</span></span> <span data-ttu-id="bc589-160">partición de hello toorecover de un momento anterior.</span><span class="sxs-lookup"><span data-stu-id="bc589-160">toorecover hello shard from an earlier point-in-time.</span></span> <span data-ttu-id="bc589-161">(En ese caso, revise Hola siguiendo las incoherencias de sección toodetect particiones). toorecover, consulte [punto de recuperación a un momento](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="bc589-161">(In that case, review hello following section toodetect shard inconsistencies.) toorecover, see [Point in time recovery](sql-database-recovery-using-backups.md).</span></span>

<span data-ttu-id="bc589-162">Ya que se supone la eliminación de la base de datos de hello era intencionada, hello acción de limpieza administrativas final es particiones de toodelete Hola entrada toohello en el Administrador de mapa de particiones de Hola.</span><span class="sxs-lookup"><span data-stu-id="bc589-162">Since it is assumed hello database deletion was intentional, hello final administrative cleanup action is toodelete hello entry toohello shard in hello shard map manager.</span></span> <span data-ttu-id="bc589-163">Esto evita que la aplicación hello de escriban sin querer intervalo tooa de información que no se esperaba.</span><span class="sxs-lookup"><span data-stu-id="bc589-163">This prevents hello application from inadvertently writing information tooa range that is not expected.</span></span>

## <a name="toodetect-mapping-differences"></a><span data-ttu-id="bc589-164">diferencias de asignación de toodetect</span><span class="sxs-lookup"><span data-stu-id="bc589-164">toodetect mapping differences</span></span>
<span data-ttu-id="bc589-165">Hola [DetectMappingDifferences método](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.detectmappingdifferences.aspx) selecciona y devuelve uno de los mapas de particiones de hello (ya sea locales o globales) como origen de Hola de verdad y reconcilia los asignaciones en ambas asignaciones de particiones (GSM y LSM).</span><span class="sxs-lookup"><span data-stu-id="bc589-165">hello [DetectMappingDifferences method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.detectmappingdifferences.aspx) selects and returns one of hello shard maps (either local or global) as hello source of truth and reconciles mappings on both shard maps (GSM and LSM).</span></span>

   ```
   rm.DetectMappingDifferences(location, shardMapName);
   ```

* <span data-ttu-id="bc589-166">Hola *ubicación* especifica el nombre del servidor de Hola y el nombre de la base de datos.</span><span class="sxs-lookup"><span data-stu-id="bc589-166">hello *location* specifies hello server name and database name.</span></span> 
* <span data-ttu-id="bc589-167">Hola *shardMapName* parámetro es el nombre de asignación de particiones de Hola.</span><span class="sxs-lookup"><span data-stu-id="bc589-167">hello *shardMapName* parameter is hello shard map name.</span></span> <span data-ttu-id="bc589-168">Esto solo es necesario si se administran varias asignaciones de particiones por hello mismo administrador de mapa de particiones.</span><span class="sxs-lookup"><span data-stu-id="bc589-168">This is only required if multiple shard maps are managed by hello same shard map manager.</span></span> <span data-ttu-id="bc589-169">Opcional.</span><span class="sxs-lookup"><span data-stu-id="bc589-169">Optional.</span></span> 

## <a name="tooresolve-mapping-differences"></a><span data-ttu-id="bc589-170">diferencias de asignación de tooresolve</span><span class="sxs-lookup"><span data-stu-id="bc589-170">tooresolve mapping differences</span></span>
<span data-ttu-id="bc589-171">Hola [ResolveMappingDifferences método](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.resolvemappingdifferences.aspx) selecciona uno de los mapas de particiones de hello (ya sea locales o globales) como origen de Hola de verdad y reconcilia los asignaciones en ambas asignaciones de particiones (GSM y LSM).</span><span class="sxs-lookup"><span data-stu-id="bc589-171">hello [ResolveMappingDifferences method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.resolvemappingdifferences.aspx) selects one of hello shard maps (either local or global) as hello source of truth and reconciles mappings on both shard maps (GSM and LSM).</span></span>

   ```
   ResolveMappingDifferences (RecoveryToken, MappingDifferenceResolution.KeepShardMapping);
   ```

* <span data-ttu-id="bc589-172">Hola *RecoveryToken* parámetro enumera las diferencias de hello en asignaciones de hello entre hello LSM para particiones específicas de Hola y Hola GSM.</span><span class="sxs-lookup"><span data-stu-id="bc589-172">hello *RecoveryToken* parameter enumerates hello differences in hello mappings between hello GSM and hello LSM for hello specific shard.</span></span> 
* <span data-ttu-id="bc589-173">Hola [MappingDifferenceResolution enumeración](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.mappingdifferenceresolution.aspx) es método de hello tooindicate usado para resolver la diferencia de hello entre las asignaciones de particiones de Hola.</span><span class="sxs-lookup"><span data-stu-id="bc589-173">hello [MappingDifferenceResolution enumeration](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.mappingdifferenceresolution.aspx) is used tooindicate hello method for resolving hello difference between hello shard mappings.</span></span> 
* <span data-ttu-id="bc589-174">**MappingDifferenceResolution.KeepShardMapping** se recomienda que cuando Hola LSM contiene asignación precisa de hello y, por tanto, debe usarse la asignación de hello en particiones de Hola.</span><span class="sxs-lookup"><span data-stu-id="bc589-174">**MappingDifferenceResolution.KeepShardMapping** is recommended that when hello LSM contains hello accurate mapping and therefore hello mapping in hello shard should be used.</span></span> <span data-ttu-id="bc589-175">Esto suele ser el caso de hello si se produce una conmutación por error: partición de hello ahora reside en un servidor nuevo.</span><span class="sxs-lookup"><span data-stu-id="bc589-175">This is typically hello case if there is a failover: hello shard now resides on a new server.</span></span> <span data-ttu-id="bc589-176">Puesto que la partición de hello en primer lugar debe quitarse de hello GSM (mediante el método de hello RecoveryManager.DetachShard), una asignación ya no existe en hello GSM.</span><span class="sxs-lookup"><span data-stu-id="bc589-176">Since hello shard must first be removed from hello GSM (using hello RecoveryManager.DetachShard method), a mapping no longer exists on hello GSM.</span></span> <span data-ttu-id="bc589-177">Por lo tanto, Hola LSM debe ser usado toore-establecer asignación de particiones de Hola.</span><span class="sxs-lookup"><span data-stu-id="bc589-177">Therefore, hello LSM must be used toore-establish hello shard mapping.</span></span>

## <a name="attach-a-shard-toohello-shardmap-after-a-shard-is-restored"></a><span data-ttu-id="bc589-178">Adjuntar un toohello particiones ShardMap después de restaura una partición</span><span class="sxs-lookup"><span data-stu-id="bc589-178">Attach a shard toohello ShardMap after a shard is restored</span></span>
<span data-ttu-id="bc589-179">Hola [AttachShard método](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.attachshard.aspx) adjunta Hola mapa de particiones de toohello de partición determinado.</span><span class="sxs-lookup"><span data-stu-id="bc589-179">hello [AttachShard method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.attachshard.aspx) attaches hello given shard toohello shard map.</span></span> <span data-ttu-id="bc589-180">A continuación, detecta cualquier incoherencia de mapa de particiones y actualiza la partición de hello asignaciones toomatch hello en el momento de Hola de restauración de la partición de Hola.</span><span class="sxs-lookup"><span data-stu-id="bc589-180">It then detects any shard map inconsistencies and updates hello mappings toomatch hello shard at hello point of hello shard restoration.</span></span> <span data-ttu-id="bc589-181">Se supone que esa base de datos de hello es también tooreflect cuyo nombre ha cambiado Hola base de datos nombre original (antes de que se restauró la partición de hello), puesto que la restauración de un momento dado de hello tiene como valor predeterminado tooa nueva base de datos anexado con marca de tiempo de Hola.</span><span class="sxs-lookup"><span data-stu-id="bc589-181">It is assumed that hello database is also renamed tooreflect hello original database name (before hello shard was restored), since hello point-in time restoration defaults tooa new database appended with hello timestamp.</span></span> 

   ```
   rm.AttachShard(location, shardMapName)
   ``` 

* <span data-ttu-id="bc589-182">Hola *ubicación* parámetro es el nombre del servidor de Hola y el nombre de base de datos de particiones de Hola que se va a adjuntar.</span><span class="sxs-lookup"><span data-stu-id="bc589-182">hello *location* parameter is hello server name and database name, of hello shard being attached.</span></span> 
* <span data-ttu-id="bc589-183">Hola *shardMapName* parámetro es el nombre de asignación de particiones de Hola.</span><span class="sxs-lookup"><span data-stu-id="bc589-183">hello *shardMapName* parameter is hello shard map name.</span></span> <span data-ttu-id="bc589-184">Esto solo es necesario cuando se administran varias asignaciones de particiones por hello mismo administrador de mapa de particiones.</span><span class="sxs-lookup"><span data-stu-id="bc589-184">This is only required when multiple shard maps are managed by hello same shard map manager.</span></span> <span data-ttu-id="bc589-185">Opcional.</span><span class="sxs-lookup"><span data-stu-id="bc589-185">Optional.</span></span> 

<span data-ttu-id="bc589-186">Este ejemplo agrega un mapa de particiones de toohello de partición que se ha restaurado recientemente de un momento dado anterior.</span><span class="sxs-lookup"><span data-stu-id="bc589-186">This example adds a shard toohello shard map that has been recently restored from an earlier point-in time.</span></span> <span data-ttu-id="bc589-187">Puesto que se ha restaurado la partición de hello (es decir Hola asignación de particiones de Hola Hola LSM), es potencialmente incoherente con la entrada de partición de Hola Hola GSM.</span><span class="sxs-lookup"><span data-stu-id="bc589-187">Since hello shard (namely hello mapping for hello shard in hello LSM) has been restored, it is potentially inconsistent with hello shard entry in hello GSM.</span></span> <span data-ttu-id="bc589-188">Fuera de este código de ejemplo, partición de Hola se restauró y cambiar toohello nombre original de la base de datos de Hola.</span><span class="sxs-lookup"><span data-stu-id="bc589-188">Outside of this example code, hello shard was restored and renamed toohello original name of hello database.</span></span> <span data-ttu-id="bc589-189">Puesto que se restauró, se supone asignación Hola Hola LSM es asignación confianza Hola.</span><span class="sxs-lookup"><span data-stu-id="bc589-189">Since it was restored, it is assumed hello mapping in hello LSM is hello trusted mapping.</span></span> 

   ```
   rm.AttachShard(s.Location, customerMap); 
   var gs = rm.DetectMappingDifferences(s.Location); 
      foreach (RecoveryToken g in gs) 
       { 
       rm.ResolveMappingDifferences(g, MappingDifferenceResolution.KeepShardMapping); 
       } 
   ```

## <a name="updating-shard-locations-after-a-geo-failover-restore-of-hello-shards"></a><span data-ttu-id="bc589-190">Actualizar ubicaciones de particiones tras una conmutación geográfica (restore) de particiones de Hola</span><span class="sxs-lookup"><span data-stu-id="bc589-190">Updating shard locations after a geo-failover (restore) of hello shards</span></span>
<span data-ttu-id="bc589-191">Si se produce una conmutación geográfica, base de datos secundaria de Hola se realiza escribir accesible y se convierte en la base de datos principal Hola nueva.</span><span class="sxs-lookup"><span data-stu-id="bc589-191">If there is a geo-failover, hello secondary database is made write accessible and becomes hello new primary database.</span></span> <span data-ttu-id="bc589-192">Hola nombre del servidor de hello y, potencialmente, base de datos de hello (dependiendo de la configuración), puede ser diferente de la réplica principal original Hola.</span><span class="sxs-lookup"><span data-stu-id="bc589-192">hello name of hello server, and potentially hello database (depending on your configuration), may be different from hello original primary.</span></span> <span data-ttu-id="bc589-193">Hola, por tanto, las entradas de asignación de particiones de Hola Hola GSM y debe corregirse LSM.</span><span class="sxs-lookup"><span data-stu-id="bc589-193">Therefore hello mapping entries for hello shard in hello GSM and LSM must be fixed.</span></span> <span data-ttu-id="bc589-194">De forma similar, si hello base de datos es restaurada tooa otro nombre o ubicación o tooan punto anterior en el tiempo, esto podría dar lugar a incoherencias en asignaciones de particiones de Hola.</span><span class="sxs-lookup"><span data-stu-id="bc589-194">Similarly, if hello database is restored tooa different name or location, or tooan earlier point in time, this might cause inconsistencies in hello shard maps.</span></span> <span data-ttu-id="bc589-195">Hola Shard Map Manager controla la distribución de Hola de base de datos de las conexiones abiertas toohello correcta.</span><span class="sxs-lookup"><span data-stu-id="bc589-195">hello Shard Map Manager handles hello distribution of open connections toohello correct database.</span></span> <span data-ttu-id="bc589-196">Distribución se basa en datos de hello en mapa de particiones de Hola y el valor de Hola de clave de particionamiento de Hola que es el destino de saludo de solicitud de aplicaciones de Hola.</span><span class="sxs-lookup"><span data-stu-id="bc589-196">Distribution is based on hello data in hello shard map and hello value of hello sharding key that is hello target of hello applications request.</span></span> <span data-ttu-id="bc589-197">Después de una conmutación geográfica, esta información debe actualizarse con el nombre del servidor precisa de hello, nombre de base de datos y asignación de particiones de base de datos recuperada de Hola.</span><span class="sxs-lookup"><span data-stu-id="bc589-197">After a geo-failover, this information must be updated with hello accurate server name, database name and shard mapping of hello recovered database.</span></span> 

## <a name="best-practices"></a><span data-ttu-id="bc589-198">Prácticas recomendadas</span><span class="sxs-lookup"><span data-stu-id="bc589-198">Best practices</span></span>
<span data-ttu-id="bc589-199">Conmutación por error geográfica y recuperación son operaciones suelen ser administradas por un administrador de la nube de aplicación Hola intencionadamente utilizando una de las características de continuidad del negocio de bases de datos de SQL Azure.</span><span class="sxs-lookup"><span data-stu-id="bc589-199">Geo-failover and recovery are operations typically managed by a cloud administrator of hello application intentionally utilizing one of Azure SQL Databases business continuity features.</span></span> <span data-ttu-id="bc589-200">Planificación de continuidad del negocio requiere procesos, procedimientos y medidas tooensure que operaciones comerciales puedan continuar sin interrupción.</span><span class="sxs-lookup"><span data-stu-id="bc589-200">Business continuity planning requires processes, procedures, and measures tooensure that business operations can continue without interruption.</span></span> <span data-ttu-id="bc589-201">Hola métodos disponibles como parte del programa Hola RecoveryManager clase debe utilizarse dentro de este hello tooensure de flujo de trabajo GSM y LSM se mantengan protegidos en función de la acción de recuperación de hello realizada.</span><span class="sxs-lookup"><span data-stu-id="bc589-201">hello methods available as part of hello RecoveryManager class should be used within this work flow tooensure hello GSM and LSM are kept up-to-date based on hello recovery action taken.</span></span> <span data-ttu-id="bc589-202">Hay cinco pasos básicos tooproperly garantizar Hola GSM y LSM reflejan información precisa de hello después de un evento de conmutación por error.</span><span class="sxs-lookup"><span data-stu-id="bc589-202">There are five basic steps tooproperly ensuring hello GSM and LSM reflect hello accurate information after a failover event.</span></span> <span data-ttu-id="bc589-203">Hola tooexecute de código de aplicación que estos pasos se pueden integrar en el flujo de trabajo y las herramientas existentes.</span><span class="sxs-lookup"><span data-stu-id="bc589-203">hello application code tooexecute these steps can be integrated into existing tools and workflow.</span></span> 

1. <span data-ttu-id="bc589-204">Recuperar hello RecoveryManager de hello ShardMapManager.</span><span class="sxs-lookup"><span data-stu-id="bc589-204">Retrieve hello RecoveryManager from hello ShardMapManager.</span></span> 
2. <span data-ttu-id="bc589-205">Separar la partición antigua de Hola de mapa de particiones de Hola.</span><span class="sxs-lookup"><span data-stu-id="bc589-205">Detach hello old shard from hello shard map.</span></span>
3. <span data-ttu-id="bc589-206">Adjuntar Hola nueva partición toohello mapa de particiones, incluida la ubicación de hello nueva partición.</span><span class="sxs-lookup"><span data-stu-id="bc589-206">Attach hello new shard toohello shard map, including hello new shard location.</span></span>
4. <span data-ttu-id="bc589-207">Detectar incoherencias en hello asignación entre Hola GSM y LSM.</span><span class="sxs-lookup"><span data-stu-id="bc589-207">Detect inconsistencies in hello mapping between hello GSM and LSM.</span></span> 
5. <span data-ttu-id="bc589-208">Resolver las diferencias entre Hola GSM y Hola LSM, que confía Hola LSM.</span><span class="sxs-lookup"><span data-stu-id="bc589-208">Resolve differences between hello GSM and hello LSM, trusting hello LSM.</span></span> 

<span data-ttu-id="bc589-209">Este ejemplo realiza Hola pasos:</span><span class="sxs-lookup"><span data-stu-id="bc589-209">This example performs hello following steps:</span></span>

1. <span data-ttu-id="bc589-210">Quita particiones de mapa de particiones que refleja las ubicaciones de particiones antes del evento de conmutación por error de Hola Hola.</span><span class="sxs-lookup"><span data-stu-id="bc589-210">Removes shards from hello Shard Map that reflect shard locations before hello failover event.</span></span>
2. <span data-ttu-id="bc589-211">Adjunta particiones toohello mapa de particiones reflejan Hola nuevas particiones ubicaciones (parámetro hello "Configuration.SecondaryServer" es el nombre del servidor nuevo de hello pero Hola mismo nombre de base de datos).</span><span class="sxs-lookup"><span data-stu-id="bc589-211">Attaches shards toohello Shard Map reflecting hello new shard locations (hello parameter "Configuration.SecondaryServer" is hello new server name but hello same database name).</span></span>
3. <span data-ttu-id="bc589-212">Recupera los tokens de recuperación de hello mediante la detección de diferencias de asignación entre Hola GSM y Hola LSM para cada partición.</span><span class="sxs-lookup"><span data-stu-id="bc589-212">Retrieves hello recovery tokens by detecting mapping differences between hello GSM and hello LSM for each shard.</span></span> 
4. <span data-ttu-id="bc589-213">Resuelve las incoherencias de Hola que confía asignación Hola de hello LSM de cada partición.</span><span class="sxs-lookup"><span data-stu-id="bc589-213">Resolves hello inconsistencies by trusting hello mapping from hello LSM of each shard.</span></span> 
   
   ```
   var shards = smm.GetShards(); 
   foreach (shard s in shards) 
   { 
     if (s.Location.Server == Configuration.PrimaryServer) 
   
         { 
          ShardLocation slNew = new ShardLocation(Configuration.SecondaryServer, s.Location.Database); 
   
          rm.DetachShard(s.Location); 
   
          rm.AttachShard(slNew); 
   
          var gs = rm.DetectMappingDifferences(slNew); 
   
          foreach (RecoveryToken g in gs) 
            { 
               rm.ResolveMappingDifferences(g, MappingDifferenceResolution.KeepShardMapping); 
            } 
        } 
    } 
   ```

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Image references-->
[1]: ./media/sql-database-elastic-database-recovery-manager/recovery-manager.png

