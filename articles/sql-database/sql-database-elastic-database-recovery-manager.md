---
title: Uso de Recovery Manager para solucionar problemas de mapas de particiones | Microsoft Docs
description: Uso de la clase RecoveryManager para solucionar problemas con los mapas de particiones
services: sql-database
documentationcenter: 
manager: jhubbard
author: ddove
ms.assetid: 45520ca3-6903-4b39-88ba-1d41b22da9fe
ms.service: sql-database
ms.custom: scale out apps
ms.workload: sql-database
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 10/25/2016
ms.author: ddove
ms.openlocfilehash: e60e2295484873ea15d52108b7d619319a57827f
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 07/11/2017
---
# <a name="using-the-recoverymanager-class-to-fix-shard-map-problems"></a><span data-ttu-id="0d603-103">Uso de la clase RecoveryManager para solucionar problemas de mapas de particiones</span><span class="sxs-lookup"><span data-stu-id="0d603-103">Using the RecoveryManager class to fix shard map problems</span></span>
<span data-ttu-id="0d603-104">La clase [RecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.aspx) proporciona a las aplicaciones ADO.Net la capacidad de detectar y corregir fácilmente las incoherencias entre el mapa de particiones global y el mapa de particiones local en un entorno de base de datos con particiones.</span><span class="sxs-lookup"><span data-stu-id="0d603-104">The [RecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.aspx) class provides ADO.Net applications the ability to easily detect and correct any inconsistencies between the global shard map (GSM) and the local shard map (LSM) in a sharded database environment.</span></span> 

<span data-ttu-id="0d603-105">Los mapas de particiones global y local realizan un seguimiento de la asignación de cada base de datos en un entorno con particiones.</span><span class="sxs-lookup"><span data-stu-id="0d603-105">The GSM and LSM track the mapping of each database in a sharded environment.</span></span> <span data-ttu-id="0d603-106">En ocasiones, se produce una interrupción entre el GSM y el LSM.</span><span class="sxs-lookup"><span data-stu-id="0d603-106">Occasionally, a break occurs between the GSM and the LSM.</span></span> <span data-ttu-id="0d603-107">En ese caso, utilice la clase RecoveryManager para detectar y reparar la interrupción.</span><span class="sxs-lookup"><span data-stu-id="0d603-107">In that case, use the RecoveryManager class to detect and repair the break.</span></span>

<span data-ttu-id="0d603-108">La clase RecoveryManager forma parte de la [biblioteca de cliente de Base de datos elástica](sql-database-elastic-database-client-library.md).</span><span class="sxs-lookup"><span data-stu-id="0d603-108">The RecoveryManager class is part of the [Elastic Database client library](sql-database-elastic-database-client-library.md).</span></span> 

![Mapa de particiones][1]

<span data-ttu-id="0d603-110">Para definiciones de términos, consulte el [Glosario de herramientas de base de datos elástica](sql-database-elastic-scale-glossary.md).</span><span class="sxs-lookup"><span data-stu-id="0d603-110">For term definitions, see [Elastic Database tools glossary](sql-database-elastic-scale-glossary.md).</span></span> <span data-ttu-id="0d603-111">Para comprender cómo se usa **ShardMapManager** para administrar los datos en una solución con particiones, consulte [Administración de mapas de particiones](sql-database-elastic-scale-shard-map-management.md).</span><span class="sxs-lookup"><span data-stu-id="0d603-111">To understand how the **ShardMapManager** is used to manage data in a sharded solution, see [Shard map management](sql-database-elastic-scale-shard-map-management.md).</span></span>

## <a name="why-use-the-recovery-manager"></a><span data-ttu-id="0d603-112">¿Por qué usar el Administrador de recuperación?</span><span class="sxs-lookup"><span data-stu-id="0d603-112">Why use the recovery manager?</span></span>
<span data-ttu-id="0d603-113">En un entorno de base de datos particionada, hay un inquilino por base de datos y muchas bases de datos por servidor.</span><span class="sxs-lookup"><span data-stu-id="0d603-113">In a sharded database environment, there is one tenant per database, and many databases per server.</span></span> <span data-ttu-id="0d603-114">También puede haber muchos servidores en el entorno.</span><span class="sxs-lookup"><span data-stu-id="0d603-114">There can also be many servers in the environment.</span></span> <span data-ttu-id="0d603-115">Cada base de datos se asigna en el mapa de particiones, de forma que las llamadas se puedan enrutar al servidor y a la base de datos correctos.</span><span class="sxs-lookup"><span data-stu-id="0d603-115">Each database is mapped in the shard map, so calls can be routed to the correct server and database.</span></span> <span data-ttu-id="0d603-116">Se realiza un seguimiento de las bases de datos según una **clave de particionamiento** y se asigna un **intervalo de valores de clave** a cada partición.</span><span class="sxs-lookup"><span data-stu-id="0d603-116">Databases are tracked according to a **sharding key**, and each shard is assigned a **range of key values**.</span></span> <span data-ttu-id="0d603-117">Por ejemplo, una clave de particionamiento puede representar los nombres de los clientes de "D" a "F".</span><span class="sxs-lookup"><span data-stu-id="0d603-117">For example, a sharding key may represent the customer names from "D" to "F."</span></span> <span data-ttu-id="0d603-118">La asignación de todas las particiones (es decir, de las bases de datos) y sus intervalos de asignación se encuentran en el **mapa de particiones global (GSM)**.</span><span class="sxs-lookup"><span data-stu-id="0d603-118">The mapping of all shards (aka databases) and their mapping ranges are contained in the **global shard map (GSM)**.</span></span> <span data-ttu-id="0d603-119">Cada base de datos también contiene un mapa de los intervalos contenidos en la partición, lo que se conoce como **mapa de particiones local (LSM)**.</span><span class="sxs-lookup"><span data-stu-id="0d603-119">Each database also contains a map of the ranges contained on the shard that is known as the **local shard map (LSM)**.</span></span> <span data-ttu-id="0d603-120">Cuando una aplicación se conecta a una partición, la asignación se almacena en caché con la aplicación para una rápida recuperación.</span><span class="sxs-lookup"><span data-stu-id="0d603-120">When an app connects to a shard, the mapping is cached with the app for quick retrieval.</span></span> <span data-ttu-id="0d603-121">El mapa de particiones local se usa para validar los datos almacenados en caché.</span><span class="sxs-lookup"><span data-stu-id="0d603-121">The LSM is used to validate cached data.</span></span> 

<span data-ttu-id="0d603-122">Puede que GSM y LSM no estén sincronizados por los motivos siguientes:</span><span class="sxs-lookup"><span data-stu-id="0d603-122">The GSM and LSM may become out of sync for the following reasons:</span></span>

1. <span data-ttu-id="0d603-123">La eliminación de una partición cuyo intervalo se considera que ya no está en uso o el cambio de nombre de una partición.</span><span class="sxs-lookup"><span data-stu-id="0d603-123">The deletion of a shard whose range is believed to no longer be in use, or renaming of a shard.</span></span> <span data-ttu-id="0d603-124">La eliminación de una partición da como resultado una **asignación de particiones huérfana**.</span><span class="sxs-lookup"><span data-stu-id="0d603-124">Deleting a shard results in an **orphaned shard mapping**.</span></span> <span data-ttu-id="0d603-125">De igual forma, una base de datos cuyo nombre cambió puede provocar una asignación de particiones huérfanas.</span><span class="sxs-lookup"><span data-stu-id="0d603-125">Similarly, a renamed database can cause an orphaned shard mapping.</span></span> <span data-ttu-id="0d603-126">En función de cuál sea el objetivo del cambio, puede que tenga que quitar la partición o simplemente actualizar la ubicación de la partición.</span><span class="sxs-lookup"><span data-stu-id="0d603-126">Depending on the intent of the change, the shard may need to be removed or the shard location needs to be updated.</span></span> <span data-ttu-id="0d603-127">Para recuperar una base de datos eliminada, consulte el artículo que explica cómo [restaurar una base de datos eliminada](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="0d603-127">To recover a deleted database, see [Restore a deleted database](sql-database-recovery-using-backups.md).</span></span>
2. <span data-ttu-id="0d603-128">Se produce un evento de conmutación por error geográfica.</span><span class="sxs-lookup"><span data-stu-id="0d603-128">A geo-failover event occurs.</span></span> <span data-ttu-id="0d603-129">Para continuar, se debe actualizar el nombre del servidor y el nombre de la base de datos del administrador de mapas de particiones en la aplicación y luego actualizar los detalles de la asignación de particiones de todas las particiones de un mapa de particiones.</span><span class="sxs-lookup"><span data-stu-id="0d603-129">To continue, one must update the server name, and database name of shard map manager in the application and then update the shard mapping details for all shards in a shard map.</span></span> <span data-ttu-id="0d603-130">Si hay una conmutación por error geográfica, se debería automatizar esa lógica de recuperación en el flujo de trabajo de conmutación por error.</span><span class="sxs-lookup"><span data-stu-id="0d603-130">If there is a geo-failover, such recovery logic should be automated within the failover workflow.</span></span> <span data-ttu-id="0d603-131">La automatización de las acciones de recuperación permite una capacidad de administración sin contacto para bases de datos habilitadas geográficamente y evita acciones humanas manuales.</span><span class="sxs-lookup"><span data-stu-id="0d603-131">Automating recovery actions enables a frictionless manageability for geo-enabled databases and avoids manual human actions.</span></span> <span data-ttu-id="0d603-132">Para descubrir las opciones de recuperación de una base de datos tras una posible interrupción del centro de datos, consulte los temas sobre la [continuidad empresarial](sql-database-business-continuity.md) y la [recuperación ante desastres](sql-database-disaster-recovery.md).</span><span class="sxs-lookup"><span data-stu-id="0d603-132">To learn about options to recover a database if there is a data center outage, see [Business Continuity](sql-database-business-continuity.md) and [Disaster Recovery](sql-database-disaster-recovery.md).</span></span>
3. <span data-ttu-id="0d603-133">Se restaura la partición o la base de datos de ShardMapManager al anterior punto de tiempo.</span><span class="sxs-lookup"><span data-stu-id="0d603-133">Either a shard or the ShardMapManager database is restored to an earlier point-in time.</span></span> <span data-ttu-id="0d603-134">Para obtener información sobre la recuperación a un momento dado mediante copias de seguridad, consulte [este artículo](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="0d603-134">To learn about point in time recovery using backups, see [Recovery using backups](sql-database-recovery-using-backups.md).</span></span>

<span data-ttu-id="0d603-135">Para obtener más información sobre las herramientas de Elastic Database de Azure SQL Database, la replicación y restauración geográficas, consulte lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="0d603-135">For more information about Azure SQL Database Elastic Database tools, geo-replication and Restore, see the following:</span></span> 

* [<span data-ttu-id="0d603-136">Información general: continuidad del negocio en la nube y recuperación ante desastres con la Base de datos SQL</span><span class="sxs-lookup"><span data-stu-id="0d603-136">Overview: Cloud business continuity and database disaster recovery with SQL Database</span></span>](sql-database-business-continuity.md) 
* [<span data-ttu-id="0d603-137">Introducción a las herramientas de base de datos elástica</span><span class="sxs-lookup"><span data-stu-id="0d603-137">Get started with elastic database tools</span></span>](sql-database-elastic-scale-get-started.md)  
* [<span data-ttu-id="0d603-138">Administración de ShardMap</span><span class="sxs-lookup"><span data-stu-id="0d603-138">ShardMap Management</span></span>](sql-database-elastic-scale-shard-map-management.md)

## <a name="retrieving-recoverymanager-from-a-shardmapmanager"></a><span data-ttu-id="0d603-139">Recuperación de RecoveryManager desde un ShardMapManager</span><span class="sxs-lookup"><span data-stu-id="0d603-139">Retrieving RecoveryManager from a ShardMapManager</span></span>
<span data-ttu-id="0d603-140">El primer paso es crear una instancia de RecoveryManager.</span><span class="sxs-lookup"><span data-stu-id="0d603-140">The first step is to create a RecoveryManager instance.</span></span> <span data-ttu-id="0d603-141">El [método GetRecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getrecoverymanager.aspx) devuelve Recovery Manager para la instancia de [ShardMapManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.aspx) actual.</span><span class="sxs-lookup"><span data-stu-id="0d603-141">The [GetRecoveryManager method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getrecoverymanager.aspx) returns the recovery manager for the current [ShardMapManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.aspx) instance.</span></span> <span data-ttu-id="0d603-142">Para resolver las incoherencias en la asignación de particiones, primero debe recuperar RecoveryManager para el mapa de partición particular.</span><span class="sxs-lookup"><span data-stu-id="0d603-142">To address any inconsistencies in the shard map, you must first retrieve the RecoveryManager for the particular shard map.</span></span> 

   ```
    ShardMapManager smm = ShardMapManagerFactory.GetSqlShardMapManager(smmConnnectionString,  
             ShardMapManagerLoadPolicy.Lazy);
             RecoveryManager rm = smm.GetRecoveryManager(); 
   ```

<span data-ttu-id="0d603-143">En este ejemplo, se inicializa RecoveryManager desde ShardMapManager.</span><span class="sxs-lookup"><span data-stu-id="0d603-143">In this example, the RecoveryManager is initialized from the ShardMapManager.</span></span> <span data-ttu-id="0d603-144">También se inicializa un ShardMapManager que contiene un ShardMap.</span><span class="sxs-lookup"><span data-stu-id="0d603-144">The ShardMapManager containing a ShardMap is also already initialized.</span></span> 

<span data-ttu-id="0d603-145">Como este código de aplicación manipula el mapa de particiones propiamente dicho, las credenciales que se usan en el método de fábrica (en el ejemplo anterior, smmConnectionString) deben ser credenciales con permisos de lectura-escritura en la base de datos del mapa de particiones global a la que hace referencia la cadena de conexión.</span><span class="sxs-lookup"><span data-stu-id="0d603-145">Since this application code manipulates the shard map itself, the credentials used in the factory method (in the preceding example, smmConnectionString) should be credentials that have read-write permissions on the GSM database referenced by the connection string.</span></span> <span data-ttu-id="0d603-146">Estas credenciales normalmente son distintas de las credenciales que se usan a fin de abrir conexiones para el enrutamiento dependiente de datos.</span><span class="sxs-lookup"><span data-stu-id="0d603-146">These credentials are typically different from credentials used to open connections for data-dependent routing.</span></span> <span data-ttu-id="0d603-147">Para más información, consulte [Uso de credenciales en las bibliotecas de cliente de base de datos elástica](sql-database-elastic-scale-manage-credentials.md).</span><span class="sxs-lookup"><span data-stu-id="0d603-147">For more information, see [Using credentials in the elastic database client](sql-database-elastic-scale-manage-credentials.md).</span></span>

## <a name="removing-a-shard-from-the-shardmap-after-a-shard-is-deleted"></a><span data-ttu-id="0d603-148">Supresión de una partición de ShardMap después de eliminar una partición</span><span class="sxs-lookup"><span data-stu-id="0d603-148">Removing a shard from the ShardMap after a shard is deleted</span></span>
<span data-ttu-id="0d603-149">El [método DetachShard](https://msdn.microsoft.com/library/azure/dn842083.aspx) desasocia la partición determinada del mapa de particiones y elimina las asignaciones asociadas a la partición.</span><span class="sxs-lookup"><span data-stu-id="0d603-149">The [DetachShard method](https://msdn.microsoft.com/library/azure/dn842083.aspx) detaches the given shard from the shard map and deletes mappings associated with the shard.</span></span>  

* <span data-ttu-id="0d603-150">El parámetro location es la ubicación de la partición, específicamente el nombre del servidor y el nombre de la base de datos de la partición que se va a desasociar.</span><span class="sxs-lookup"><span data-stu-id="0d603-150">The location parameter is the shard location, specifically server name and database name, of the shard being detached.</span></span> 
* <span data-ttu-id="0d603-151">El parámetro shardMapName es el nombre del mapa de particiones.</span><span class="sxs-lookup"><span data-stu-id="0d603-151">The shardMapName parameter is the shard map name.</span></span> <span data-ttu-id="0d603-152">Solo es necesario cuando se administran varios mapas de particiones por el mismo administrador de mapas de particiones.</span><span class="sxs-lookup"><span data-stu-id="0d603-152">This is only required when multiple shard maps are managed by the same shard map manager.</span></span> <span data-ttu-id="0d603-153">Opcional.</span><span class="sxs-lookup"><span data-stu-id="0d603-153">Optional.</span></span> 


> [!IMPORTANT]
> <span data-ttu-id="0d603-154">Use esta técnica solo si está seguro de que el intervalo para la asignación actualizada está vacío.</span><span class="sxs-lookup"><span data-stu-id="0d603-154">Use this technique only if you are certain that the range for the updated mapping is empty.</span></span> <span data-ttu-id="0d603-155">Los métodos anteriores no comprueban los datos para el intervalo que se va a mover, por lo que es mejor incluir comprobaciones en el código.</span><span class="sxs-lookup"><span data-stu-id="0d603-155">The methods above do not check data for the range being moved, so it is best to include checks in your code.</span></span>
>

<span data-ttu-id="0d603-156">En este ejemplo se eliminan particiones del mapa de particiones.</span><span class="sxs-lookup"><span data-stu-id="0d603-156">This example removes shards from the shard map.</span></span> 

   ```
   rm.DetachShard(s.Location, customerMap);
   ``` 

<span data-ttu-id="0d603-157">El mapa de particiones refleja la ubicación de partición en el GSM antes de la eliminación de la partición.</span><span class="sxs-lookup"><span data-stu-id="0d603-157">The shard map reflects the shard location in the GSM before the deletion of the shard.</span></span> <span data-ttu-id="0d603-158">Como se eliminó la partición, se supone esto fue intencionado y el rango con clave de particionamiento ya no está en uso.</span><span class="sxs-lookup"><span data-stu-id="0d603-158">Because the shard was deleted, it is assumed this was intentional, and the sharding key range is no longer in use.</span></span> <span data-ttu-id="0d603-159">De lo contrario, puede ejecutar la restauración a un momento dado.</span><span class="sxs-lookup"><span data-stu-id="0d603-159">If not, you can execute point-in time restore.</span></span> <span data-ttu-id="0d603-160">para recuperar la partición de un momento anterior.</span><span class="sxs-lookup"><span data-stu-id="0d603-160">to recover the shard from an earlier point-in-time.</span></span> <span data-ttu-id="0d603-161">(En ese caso, revise la sección siguiente para detectar las incoherencias de partición). Para recuperar, consulte el artículo sobre la [recuperación a un momento dado](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="0d603-161">(In that case, review the following section to detect shard inconsistencies.) To recover, see [Point in time recovery](sql-database-recovery-using-backups.md).</span></span>

<span data-ttu-id="0d603-162">Puesto que se supone que la eliminación de la base de datos era intencionada, la acción de limpieza administrativas final consiste en eliminar la entrada a la partición en el administrador de mapas de particiones.</span><span class="sxs-lookup"><span data-stu-id="0d603-162">Since it is assumed the database deletion was intentional, the final administrative cleanup action is to delete the entry to the shard in the shard map manager.</span></span> <span data-ttu-id="0d603-163">Esto impide que la aplicación escriba accidentalmente información en un rango que no se espera.</span><span class="sxs-lookup"><span data-stu-id="0d603-163">This prevents the application from inadvertently writing information to a range that is not expected.</span></span>

## <a name="to-detect-mapping-differences"></a><span data-ttu-id="0d603-164">Para detectar las diferencias de asignación</span><span class="sxs-lookup"><span data-stu-id="0d603-164">To detect mapping differences</span></span>
<span data-ttu-id="0d603-165">El [método DetectMappingDifferences](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.detectmappingdifferences.aspx) selecciona y devuelve uno de los mapas de particiones (local o global) como el origen de datos y reconcilia las asignaciones en ambos mapas de particiones (global y local).</span><span class="sxs-lookup"><span data-stu-id="0d603-165">The [DetectMappingDifferences method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.detectmappingdifferences.aspx) selects and returns one of the shard maps (either local or global) as the source of truth and reconciles mappings on both shard maps (GSM and LSM).</span></span>

   ```
   rm.DetectMappingDifferences(location, shardMapName);
   ```

* <span data-ttu-id="0d603-166">La *ubicación* especifica el nombre del servidor y el nombre de la base de datos.</span><span class="sxs-lookup"><span data-stu-id="0d603-166">The *location* specifies the server name and database name.</span></span> 
* <span data-ttu-id="0d603-167">El parámetro *shardMapName* es el nombre del mapa de particiones.</span><span class="sxs-lookup"><span data-stu-id="0d603-167">The *shardMapName* parameter is the shard map name.</span></span> <span data-ttu-id="0d603-168">Solo es necesario si un mismo administrador de mapas de particiones administra varios mapas de particiones.</span><span class="sxs-lookup"><span data-stu-id="0d603-168">This is only required if multiple shard maps are managed by the same shard map manager.</span></span> <span data-ttu-id="0d603-169">Opcional.</span><span class="sxs-lookup"><span data-stu-id="0d603-169">Optional.</span></span> 

## <a name="to-resolve-mapping-differences"></a><span data-ttu-id="0d603-170">Para resolver diferencias de asignación</span><span class="sxs-lookup"><span data-stu-id="0d603-170">To resolve mapping differences</span></span>
<span data-ttu-id="0d603-171">El [método ResolveMappingDifferences](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.resolvemappingdifferences.aspx) selecciona uno de los mapas de particiones (local o global) como origen de datos y concilia las asignaciones en ambos mapas de particiones (global y local).</span><span class="sxs-lookup"><span data-stu-id="0d603-171">The [ResolveMappingDifferences method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.resolvemappingdifferences.aspx) selects one of the shard maps (either local or global) as the source of truth and reconciles mappings on both shard maps (GSM and LSM).</span></span>

   ```
   ResolveMappingDifferences (RecoveryToken, MappingDifferenceResolution.KeepShardMapping);
   ```

* <span data-ttu-id="0d603-172">El parámetro *RecoveryToken* enumera las diferencias en las asignaciones entre los mapas de particiones global y local para la partición específica.</span><span class="sxs-lookup"><span data-stu-id="0d603-172">The *RecoveryToken* parameter enumerates the differences in the mappings between the GSM and the LSM for the specific shard.</span></span> 
* <span data-ttu-id="0d603-173">La enumeración [MappingDifferenceResolution](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.mappingdifferenceresolution.aspx) se usa para indicar el método para resolver la diferencia entre las asignaciones de particiones.</span><span class="sxs-lookup"><span data-stu-id="0d603-173">The [MappingDifferenceResolution enumeration](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.mappingdifferenceresolution.aspx) is used to indicate the method for resolving the difference between the shard mappings.</span></span> 
* <span data-ttu-id="0d603-174">Se recomienda **MappingDifferenceResolution.KeepShardMapping** cuando el mapa de particiones local contenga la asignación precisa y, por tanto, se deba usar la asignación en la partición.</span><span class="sxs-lookup"><span data-stu-id="0d603-174">**MappingDifferenceResolution.KeepShardMapping** is recommended that when the LSM contains the accurate mapping and therefore the mapping in the shard should be used.</span></span> <span data-ttu-id="0d603-175">Suele ser el caso de una conmutación por error: la partición ahora reside en un servidor nuevo.</span><span class="sxs-lookup"><span data-stu-id="0d603-175">This is typically the case if there is a failover: the shard now resides on a new server.</span></span> <span data-ttu-id="0d603-176">Como se debe quitar primero la partición del mapa de particiones global (mediante el método RecoveryManager.DetachShard), ya no existe una asignación en el mapa de particiones global.</span><span class="sxs-lookup"><span data-stu-id="0d603-176">Since the shard must first be removed from the GSM (using the RecoveryManager.DetachShard method), a mapping no longer exists on the GSM.</span></span> <span data-ttu-id="0d603-177">Por lo tanto, debe usarse el mapa de particiones local para volver a establecer la asignación de particiones.</span><span class="sxs-lookup"><span data-stu-id="0d603-177">Therefore, the LSM must be used to re-establish the shard mapping.</span></span>

## <a name="attach-a-shard-to-the-shardmap-after-a-shard-is-restored"></a><span data-ttu-id="0d603-178">Anexión de una partición al mapa de particiones después de restaurar una partición</span><span class="sxs-lookup"><span data-stu-id="0d603-178">Attach a shard to the ShardMap after a shard is restored</span></span>
<span data-ttu-id="0d603-179">El [método AttachShard](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.attachshard.aspx) asocia una partición determinada con el mapa de particiones.</span><span class="sxs-lookup"><span data-stu-id="0d603-179">The [AttachShard method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.attachshard.aspx) attaches the given shard to the shard map.</span></span> <span data-ttu-id="0d603-180">Detecta entonces cualquier inconsistencia en el mapa de particiones y actualiza las asignaciones para que coincidan con la partición en el punto de la restauración de las particiones.</span><span class="sxs-lookup"><span data-stu-id="0d603-180">It then detects any shard map inconsistencies and updates the mappings to match the shard at the point of the shard restoration.</span></span> <span data-ttu-id="0d603-181">Se supone que la base de datos se cambia también para reflejar el nombre de la base de datos original (antes de la restauración de la partición), dado que el valor predeterminado de la restauración en un momento dado es una nueva base de datos anexada con la marca de tiempo.</span><span class="sxs-lookup"><span data-stu-id="0d603-181">It is assumed that the database is also renamed to reflect the original database name (before the shard was restored), since the point-in time restoration defaults to a new database appended with the timestamp.</span></span> 

   ```
   rm.AttachShard(location, shardMapName)
   ``` 

* <span data-ttu-id="0d603-182">El parámetro *location* es el nombre del servidor y el nombre de la base de datos de la partición que se va a asociar.</span><span class="sxs-lookup"><span data-stu-id="0d603-182">The *location* parameter is the server name and database name, of the shard being attached.</span></span> 
* <span data-ttu-id="0d603-183">El parámetro *shardMapName* es el nombre del mapa de particiones.</span><span class="sxs-lookup"><span data-stu-id="0d603-183">The *shardMapName* parameter is the shard map name.</span></span> <span data-ttu-id="0d603-184">Solo es necesario cuando se administran varios mapas de particiones por el mismo administrador de mapas de particiones.</span><span class="sxs-lookup"><span data-stu-id="0d603-184">This is only required when multiple shard maps are managed by the same shard map manager.</span></span> <span data-ttu-id="0d603-185">Opcional.</span><span class="sxs-lookup"><span data-stu-id="0d603-185">Optional.</span></span> 

<span data-ttu-id="0d603-186">En este ejemplo se agrega una partición al mapa de particiones que se restauró recientemente desde un momento dado anterior.</span><span class="sxs-lookup"><span data-stu-id="0d603-186">This example adds a shard to the shard map that has been recently restored from an earlier point-in time.</span></span> <span data-ttu-id="0d603-187">Puesto que la partición (es decir, la asignación de la partición del mapa de particiones local) se restauró, es potencialmente incoherente con la entrada de partición en el mapa de particiones global.</span><span class="sxs-lookup"><span data-stu-id="0d603-187">Since the shard (namely the mapping for the shard in the LSM) has been restored, it is potentially inconsistent with the shard entry in the GSM.</span></span> <span data-ttu-id="0d603-188">Fuera de este código de ejemplo, la partición se restauró y cambió el nombre al nombre original de la base de datos.</span><span class="sxs-lookup"><span data-stu-id="0d603-188">Outside of this example code, the shard was restored and renamed to the original name of the database.</span></span> <span data-ttu-id="0d603-189">Como se restauró, se asume que la asignación del mapa de particiones local es la asignación de confianza.</span><span class="sxs-lookup"><span data-stu-id="0d603-189">Since it was restored, it is assumed the mapping in the LSM is the trusted mapping.</span></span> 

   ```
   rm.AttachShard(s.Location, customerMap); 
   var gs = rm.DetectMappingDifferences(s.Location); 
      foreach (RecoveryToken g in gs) 
       { 
       rm.ResolveMappingDifferences(g, MappingDifferenceResolution.KeepShardMapping); 
       } 
   ```

## <a name="updating-shard-locations-after-a-geo-failover-restore-of-the-shards"></a><span data-ttu-id="0d603-190">Actualización de las ubicaciones de partición después de una conmutación de error geográfica (restauración) de las particiones</span><span class="sxs-lookup"><span data-stu-id="0d603-190">Updating shard locations after a geo-failover (restore) of the shards</span></span>
<span data-ttu-id="0d603-191">Si se produce una conmutación por error geográfica, a la base de datos secundaria se le da permiso de escritura y se convierte en la nueva base de datos principal.</span><span class="sxs-lookup"><span data-stu-id="0d603-191">If there is a geo-failover, the secondary database is made write accessible and becomes the new primary database.</span></span> <span data-ttu-id="0d603-192">El nombre del servidor y, posiblemente de la base de datos (según la configuración), puede ser diferente de la réplica principal original.</span><span class="sxs-lookup"><span data-stu-id="0d603-192">The name of the server, and potentially the database (depending on your configuration), may be different from the original primary.</span></span> <span data-ttu-id="0d603-193">Por lo tanto, deben corregirse las entradas de asignación para la partición en el mapa de particiones local y global.</span><span class="sxs-lookup"><span data-stu-id="0d603-193">Therefore the mapping entries for the shard in the GSM and LSM must be fixed.</span></span> <span data-ttu-id="0d603-194">De igual forma, si la base de datos se restaura en una ubicación o nombre diferente o a un momento anterior en el tiempo, podría provocar inconsistencias en los mapas de particiones.</span><span class="sxs-lookup"><span data-stu-id="0d603-194">Similarly, if the database is restored to a different name or location, or to an earlier point in time, this might cause inconsistencies in the shard maps.</span></span> <span data-ttu-id="0d603-195">El administrador de mapas de particiones controla la distribución de las conexiones abiertas a la base de datos correcta.</span><span class="sxs-lookup"><span data-stu-id="0d603-195">The Shard Map Manager handles the distribution of open connections to the correct database.</span></span> <span data-ttu-id="0d603-196">La distribución se basa en los datos del mapa de particiones y en el valor de la clave de particionamiento, que es el destino de la solicitud de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="0d603-196">Distribution is based on the data in the shard map and the value of the sharding key that is the target of the applications request.</span></span> <span data-ttu-id="0d603-197">Después de una conmutación por error geográfica, esta información debe actualizarse con el nombre preciso del servidor, el nombre de la base de datos y la asignación de particiones de la base de datos recuperada.</span><span class="sxs-lookup"><span data-stu-id="0d603-197">After a geo-failover, this information must be updated with the accurate server name, database name and shard mapping of the recovered database.</span></span> 

## <a name="best-practices"></a><span data-ttu-id="0d603-198">Prácticas recomendadas</span><span class="sxs-lookup"><span data-stu-id="0d603-198">Best practices</span></span>
<span data-ttu-id="0d603-199">La conmutación por error geográfica y la recuperación son operaciones administradas normalmente por un administrador de nube de la aplicación mediante el uso intencional de una de las características de continuidad del negocio de Base de datos SQL de Azure.</span><span class="sxs-lookup"><span data-stu-id="0d603-199">Geo-failover and recovery are operations typically managed by a cloud administrator of the application intentionally utilizing one of Azure SQL Databases business continuity features.</span></span> <span data-ttu-id="0d603-200">La planeación de la continuidad de negocio requiere procesos, procedimientos y medidas para garantizar que las operaciones empresariales puedan continuar sin interrupción.</span><span class="sxs-lookup"><span data-stu-id="0d603-200">Business continuity planning requires processes, procedures, and measures to ensure that business operations can continue without interruption.</span></span> <span data-ttu-id="0d603-201">Deben usarse los métodos disponibles como parte de la clase RecoveryManager dentro de este flujo de trabajo para garantizar que los mapas de particiones local y global se actualizan según la acción de recuperación realizada.</span><span class="sxs-lookup"><span data-stu-id="0d603-201">The methods available as part of the RecoveryManager class should be used within this work flow to ensure the GSM and LSM are kept up-to-date based on the recovery action taken.</span></span> <span data-ttu-id="0d603-202">Existen cinco pasos básicos para asegurar correctamente que los mapas de particiones local y global reflejan la información precisa después de un evento de conmutación por error.</span><span class="sxs-lookup"><span data-stu-id="0d603-202">There are five basic steps to properly ensuring the GSM and LSM reflect the accurate information after a failover event.</span></span> <span data-ttu-id="0d603-203">El código de la aplicación para ejecutar estos pasos se puede integrar en el flujo de trabajo y en las herramientas existentes.</span><span class="sxs-lookup"><span data-stu-id="0d603-203">The application code to execute these steps can be integrated into existing tools and workflow.</span></span> 

1. <span data-ttu-id="0d603-204">Recupere RecoveryManager de ShardMapManager.</span><span class="sxs-lookup"><span data-stu-id="0d603-204">Retrieve the RecoveryManager from the ShardMapManager.</span></span> 
2. <span data-ttu-id="0d603-205">Desasocie la partición anterior del mapa de particiones.</span><span class="sxs-lookup"><span data-stu-id="0d603-205">Detach the old shard from the shard map.</span></span>
3. <span data-ttu-id="0d603-206">Asociar la nueva partición al mapa de particiones, incluida la nueva ubicación de la partición.</span><span class="sxs-lookup"><span data-stu-id="0d603-206">Attach the new shard to the shard map, including the new shard location.</span></span>
4. <span data-ttu-id="0d603-207">Detecte incoherencias en la asignación entre los mapas de particiones global y local.</span><span class="sxs-lookup"><span data-stu-id="0d603-207">Detect inconsistencies in the mapping between the GSM and LSM.</span></span> 
5. <span data-ttu-id="0d603-208">Resuelva las diferencias entre los mapas de particiones global y local, confiando en el mapa de particiones local.</span><span class="sxs-lookup"><span data-stu-id="0d603-208">Resolve differences between the GSM and the LSM, trusting the LSM.</span></span> 

<span data-ttu-id="0d603-209">En este ejemplo se realizan los siguientes pasos:</span><span class="sxs-lookup"><span data-stu-id="0d603-209">This example performs the following steps:</span></span>

1. <span data-ttu-id="0d603-210">Quita las particiones del mapa de particiones que reflejan las ubicaciones de particiones anteriores al evento de conmutación por error.</span><span class="sxs-lookup"><span data-stu-id="0d603-210">Removes shards from the Shard Map that reflect shard locations before the failover event.</span></span>
2. <span data-ttu-id="0d603-211">Asocia particiones al mapa de particiones que refleja las nuevas ubicaciones de las particiones (el parámetro "Configuration.SecondaryServer" es el nuevo nombre del servidor, pero el mismo nombre de base de datos).</span><span class="sxs-lookup"><span data-stu-id="0d603-211">Attaches shards to the Shard Map reflecting the new shard locations (the parameter "Configuration.SecondaryServer" is the new server name but the same database name).</span></span>
3. <span data-ttu-id="0d603-212">Recupera los tokens de recuperación mediante la detección de diferencias de asignación entre los mapas de particiones global y local para cada partición.</span><span class="sxs-lookup"><span data-stu-id="0d603-212">Retrieves the recovery tokens by detecting mapping differences between the GSM and the LSM for each shard.</span></span> 
4. <span data-ttu-id="0d603-213">Resuelve las incoherencias al confiar en la asignación del mapa de particiones local de cada partición.</span><span class="sxs-lookup"><span data-stu-id="0d603-213">Resolves the inconsistencies by trusting the mapping from the LSM of each shard.</span></span> 
   
   ```
   var shards = smm.GetShards(); 
   foreach (shard s in shards) 
   { 
     if (s.Location.Server == Configuration.PrimaryServer) 
   
         { 
          ShardLocation slNew = new ShardLocation(Configuration.SecondaryServer, s.Location.Database); 
   
          rm.DetachShard(s.Location); 
   
          rm.AttachShard(slNew); 
   
          var gs = rm.DetectMappingDifferences(slNew); 
   
          foreach (RecoveryToken g in gs) 
            { 
               rm.ResolveMappingDifferences(g, MappingDifferenceResolution.KeepShardMapping); 
            } 
        } 
    } 
   ```

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Image references-->
[1]: ./media/sql-database-elastic-database-recovery-manager/recovery-manager.png

