---
title: "Ejecución de consultas de análisis ad-hoc entre varias bases de datos de Azure SQL| Microsoft Docs"
description: "Ejecute consultas de análisis ad hoc en varias bases de datos SQL en la aplicación multiinquilino SaaS de Wingtip."
keywords: tutorial de base de datos sql
services: sql-database
documentationcenter: 
author: stevestein
manager: jhubbard
editor: 
ms.assetid: 
ms.service: sql-database
ms.custom: scale out apps
ms.workload: data-management
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 06/23/2017
ms.author: billgib; sstein
ms.openlocfilehash: c287fe5d6b333c749b0580b5253e7e46ac27232b
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 07/11/2017
---
# <a name="run-ad-hoc-analytics-queries-across-all-wingtip-saas-tenants"></a><span data-ttu-id="d7b62-104">Ejecución de consultas de análisis ad hoc en todos los inquilinos SaaS de Wingtip</span><span class="sxs-lookup"><span data-stu-id="d7b62-104">Run ad-hoc analytics queries across all Wingtip SaaS tenants</span></span>

<span data-ttu-id="d7b62-105">En este tutorial, se ejecutan consultas distribuidas en todo el conjunto de bases de datos de inquilino para habilitar el análisis ad hoc.</span><span class="sxs-lookup"><span data-stu-id="d7b62-105">In this tutorial, you run distributed queries across the entire set of tenant databases to enable ad-hoc analytics.</span></span> <span data-ttu-id="d7b62-106">La consulta elástica se usa para habilitar las consultas distribuidas, lo que requiere la implementación de una base de datos de análisis adicional (en el servidor de catálogo).</span><span class="sxs-lookup"><span data-stu-id="d7b62-106">Elastic Query is used to enable distributed queries, which requires an additional analytics database is deployed (to the catalog server).</span></span> <span data-ttu-id="d7b62-107">Estas consultas pueden extraer información incluida en los datos operativos diarios de la aplicación SaaS Wingtip.</span><span class="sxs-lookup"><span data-stu-id="d7b62-107">These queries can extract insights buried in the day-to-day operational data of the Wingtip SaaS app.</span></span>


<span data-ttu-id="d7b62-108">En este tutorial, obtendrá información:</span><span class="sxs-lookup"><span data-stu-id="d7b62-108">In this tutorial you learn:</span></span>

> [!div class="checklist"]

> * <span data-ttu-id="d7b62-109">Acerca de las vistas globales en cada base de datos, que habilitan la realización eficiente de consultas en varios inquilinos</span><span class="sxs-lookup"><span data-stu-id="d7b62-109">About the global views in each database, that enable efficient querying across tenants</span></span>
> * <span data-ttu-id="d7b62-110">Acerca de la implementación de una base de datos de análisis ad hoc</span><span class="sxs-lookup"><span data-stu-id="d7b62-110">How to deploy an ad-hoc analytics database</span></span>
> * <span data-ttu-id="d7b62-111">Acerca de cómo ejecutar consultas distribuidas en todas las bases de datos de inquilinos</span><span class="sxs-lookup"><span data-stu-id="d7b62-111">How to run distributed queries across all tenant databases</span></span>



<span data-ttu-id="d7b62-112">Para completar este tutorial, asegúrese de cumplir los siguientes requisitos previos:</span><span class="sxs-lookup"><span data-stu-id="d7b62-112">To complete this tutorial, make sure the following prerequisites are completed:</span></span>

* <span data-ttu-id="d7b62-113">Se implementa la aplicación SaaS de Wingtip.</span><span class="sxs-lookup"><span data-stu-id="d7b62-113">The Wingtip SaaS app is deployed.</span></span> <span data-ttu-id="d7b62-114">Para implementarla en menos de cinco minutos, consulte el artículo sobre la [implementación y exploración de la aplicación SaaS de Wingtip](sql-database-saas-tutorial.md).</span><span class="sxs-lookup"><span data-stu-id="d7b62-114">To deploy in less than five minutes, see [Deploy and explore the Wingtip SaaS application](sql-database-saas-tutorial.md)</span></span>
* <span data-ttu-id="d7b62-115">Azure PowerShell está instalado.</span><span class="sxs-lookup"><span data-stu-id="d7b62-115">Azure PowerShell is installed.</span></span> <span data-ttu-id="d7b62-116">Para más información, consulte [Introducción a Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps).</span><span class="sxs-lookup"><span data-stu-id="d7b62-116">For details, see [Getting started with Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps)</span></span>
* <span data-ttu-id="d7b62-117">SQL Server Management Studio (SSMS) está instalado.</span><span class="sxs-lookup"><span data-stu-id="d7b62-117">SQL Server Management Studio (SSMS) is installed.</span></span> <span data-ttu-id="d7b62-118">Para descargar e instalar SSMS, consulte [Descarga de SQL Server Management Studio (SSMS)](https://docs.microsoft.com/sql/ssms/download-sql-server-management-studio-ssms).</span><span class="sxs-lookup"><span data-stu-id="d7b62-118">To download and install SSMS, see [Download SQL Server Management Studio (SSMS)](https://docs.microsoft.com/sql/ssms/download-sql-server-management-studio-ssms).</span></span>


## <a name="ad-hoc-analytics-pattern"></a><span data-ttu-id="d7b62-119">Patrón de análisis ad hoc</span><span class="sxs-lookup"><span data-stu-id="d7b62-119">Ad-hoc analytics pattern</span></span>

<span data-ttu-id="d7b62-120">Una de las grandes oportunidades que ofrecen las aplicaciones SaaS es el uso de la gran cantidad de datos de inquilino almacenados centralmente en la nube.</span><span class="sxs-lookup"><span data-stu-id="d7b62-120">One of the great opportunities with SaaS applications is to use the vast amount of tenant data stored centrally in the cloud.</span></span> <span data-ttu-id="d7b62-121">Use estos datos para obtener información sobre la operación y el uso de la aplicación; los inquilinos, sus usuarios, preferencias y comportamientos; etc. Esta información puede guiarle en el desarrollo de características, mejoras de facilidad de uso y otras inversiones en sus aplicaciones y servicios.</span><span class="sxs-lookup"><span data-stu-id="d7b62-121">Use this data to gain insights into the operation and usage of your application, your tenants, their users, preferences, behaviors, etc. These insights can guide feature development, usability improvements, and other investments in your apps and services.</span></span>

<span data-ttu-id="d7b62-122">Es fácil obtener acceso a estos datos en una sola base de datos multiinquilino, pero no es tan fácil cuando se distribuyen a escala en miles de bases de datos.</span><span class="sxs-lookup"><span data-stu-id="d7b62-122">Accessing this data in a single multi-tenant database is easy, but not so easy when distributed at scale across potentially thousands of databases.</span></span> <span data-ttu-id="d7b62-123">Un enfoque es usar la [consulta elástica](sql-database-elastic-query-overview.md), que permite consultas en un conjunto distribuido de bases de datos con un esquema común.</span><span class="sxs-lookup"><span data-stu-id="d7b62-123">One approach is to use [Elastic Query](sql-database-elastic-query-overview.md), which enables querying across a distributed set of databases with common schema.</span></span> <span data-ttu-id="d7b62-124">La consulta elástica usa una única base de datos *principal* en la que se definen tablas externas que reflejan tablas o vistas en las bases de datos (de inquilino) distribuidas.</span><span class="sxs-lookup"><span data-stu-id="d7b62-124">Elastic Query uses a single *head* database in which external tables are defined that mirror tables or views in the distributed (tenant) databases.</span></span> <span data-ttu-id="d7b62-125">Las consultas que se envían a esta base de datos principal se compilan para producir un plan de consulta distribuido, con partes de la consulta aplicadas en las bases de datos de inquilino según sea necesario.</span><span class="sxs-lookup"><span data-stu-id="d7b62-125">Queries submitted to this head database are compiled to produce a distributed query plan, with portions of the query pushed down to the tenant databases as needed.</span></span> <span data-ttu-id="d7b62-126">La consulta elástica usa el mapa de particiones de la base de datos del catálogo para proporcionar la ubicación de las bases de datos de inquilino.</span><span class="sxs-lookup"><span data-stu-id="d7b62-126">Elastic Query uses the shard map in the catalog database to provide the location of the tenant databases.</span></span> <span data-ttu-id="d7b62-127">La configuración y la consulta son sencillas y utilizan [Transact-SQL](https://docs.microsoft.com/sql/t-sql/language-reference) estándar; además, admiten consultas ad hoc desde herramientas como Power BI y Excel.</span><span class="sxs-lookup"><span data-stu-id="d7b62-127">Setup and query are straightforward using standard [Transact-SQL](https://docs.microsoft.com/sql/t-sql/language-reference), and support ad-hoc querying from tools like Power BI and Excel.</span></span>

<span data-ttu-id="d7b62-128">Mediante la distribución de las consultas en las bases de datos de inquilino, la consulta elástica proporciona una visión inmediata de los datos de producción activos.</span><span class="sxs-lookup"><span data-stu-id="d7b62-128">By distributing queries across the tenant databases, Elastic Query provides immediate insight into live production data.</span></span> <span data-ttu-id="d7b62-129">Sin embargo, como la consulta elástica puede extraer los datos de muchas bases de datos, la latencia de las consultas a veces puede ser mayor que las consultas equivalentes enviadas a una sola base de datos multiinquilino.</span><span class="sxs-lookup"><span data-stu-id="d7b62-129">However, as Elastic Query pulls data from potentially many databases, query latency can sometimes be higher than for equivalent queries submitted to a single multi-tenant database.</span></span> <span data-ttu-id="d7b62-130">Se debe tener cuidado al diseñar las consultas para minimizar los datos que se devuelven.</span><span class="sxs-lookup"><span data-stu-id="d7b62-130">Care should be taken when designing queries to minimize the data that is returned.</span></span> <span data-ttu-id="d7b62-131">La consulta elástica a menudo resulta más apropiada para consultar pequeñas cantidades de datos en tiempo real, en lugar de generar informes o consultas de análisis complejos o usados con frecuencia.</span><span class="sxs-lookup"><span data-stu-id="d7b62-131">Elastic Query is often best suited for querying small amounts of real-time data, as opposed to building frequently used or complex analytics queries or reports.</span></span> <span data-ttu-id="d7b62-132">Si las consultas no funcionan correctamente, examine el [plan de ejecución](https://docs.microsoft.com/sql/relational-databases/performance/display-an-actual-execution-plan) para ver qué parte de la consulta se ha transferido a la base de datos remota y cuántos datos se devuelven.</span><span class="sxs-lookup"><span data-stu-id="d7b62-132">If queries don't perform well, look at the [execution plan](https://docs.microsoft.com/sql/relational-databases/performance/display-an-actual-execution-plan) to see what part of the query has been pushed down to the remote database and how much data is being returned.</span></span> <span data-ttu-id="d7b62-133">Las consultas que requieren un procesamiento analítico complejo en algunos casos pueden ser mejor atendidas si se extraen los datos de inquilino en una base de datos dedicada o un almacenamiento de datos optimizado para las consultas de análisis.</span><span class="sxs-lookup"><span data-stu-id="d7b62-133">Queries that require complex analytical processing may be better served in some cases by extracting tenant data into a dedicated database or data warehouse optimized for analytics queries.</span></span> <span data-ttu-id="d7b62-134">Este enfoque se explica en el [tutorial de análisis de inquilino](sql-database-saas-tutorial-tenant-analytics.md).</span><span class="sxs-lookup"><span data-stu-id="d7b62-134">This pattern is explained in the [tenant analytics tutorial](sql-database-saas-tutorial-tenant-analytics.md).</span></span> 

## <a name="get-the-wingtip-application-scripts"></a><span data-ttu-id="d7b62-135">Obtener scripts de la aplicación Wingtip</span><span class="sxs-lookup"><span data-stu-id="d7b62-135">Get the Wingtip application scripts</span></span>

<span data-ttu-id="d7b62-136">Los scripts SaaS de Wingtip y el código fuente de la aplicación están disponibles en el repositorio de GitHub [WingtipSaaS](https://github.com/Microsoft/WingtipSaaS).</span><span class="sxs-lookup"><span data-stu-id="d7b62-136">The Wingtip SaaS scripts and application source code are available in the [WingtipSaaS](https://github.com/Microsoft/WingtipSaaS) github repo.</span></span> <span data-ttu-id="d7b62-137">[Pasos para descargar los scripts SaaS de Wingtip](sql-database-wtp-overview.md#download-and-unblock-the-wingtip-saas-scripts).</span><span class="sxs-lookup"><span data-stu-id="d7b62-137">[Steps to download the Wingtip SaaS scripts](sql-database-wtp-overview.md#download-and-unblock-the-wingtip-saas-scripts).</span></span>

## <a name="create-ticket-sales-data"></a><span data-ttu-id="d7b62-138">Creación de datos de ventas de entradas</span><span class="sxs-lookup"><span data-stu-id="d7b62-138">Create ticket sales data</span></span>

<span data-ttu-id="d7b62-139">Para ejecutar consultas en un conjunto de datos más interesante, ejecute el generador de entradas para crear datos de ventas de entradas.</span><span class="sxs-lookup"><span data-stu-id="d7b62-139">To run queries against a more interesting data set, create ticket sales data by running the ticket-generator.</span></span>

1. <span data-ttu-id="d7b62-140">En *PowerShell ISE*, abra el script ...\\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalytics.ps1* y establezca los valores siguientes:</span><span class="sxs-lookup"><span data-stu-id="d7b62-140">In the *PowerShell ISE*, open the ...\\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalytics.ps1* script and set the following values:</span></span>
   * <span data-ttu-id="d7b62-141">**$DemoScenario** = 1, **Purchase tickets for events at all venues** (comprar entradas para eventos de todas las ubicaciones).</span><span class="sxs-lookup"><span data-stu-id="d7b62-141">**$DemoScenario** = 1, **Purchase tickets for events at all venues**.</span></span>
2. <span data-ttu-id="d7b62-142">Presione **F5** para ejecutar el script y generar datos de ventas de entradas.</span><span class="sxs-lookup"><span data-stu-id="d7b62-142">Press **F5** to run the script and generate ticket sales.</span></span> <span data-ttu-id="d7b62-143">Mientras se ejecuta el script, siga con los pasos de este tutorial.</span><span class="sxs-lookup"><span data-stu-id="d7b62-143">While the script is running, continue the steps in this tutorial.</span></span> <span data-ttu-id="d7b62-144">Los datos de entradas se consultan en la sección *Ejecución de consultas distribuidas ad hoc*, de modo que espere a que el generador de entradas finalice, si aún se está ejecutando cuando llegue a ese ejercicio.</span><span class="sxs-lookup"><span data-stu-id="d7b62-144">The ticket data is queried in the *Run ad-hoc distributed queries* section, so wait for the ticket generator to complete if it's still running when you get to that exercise.</span></span>

## <a name="explore-the-global-views"></a><span data-ttu-id="d7b62-145">Exploración de las vistas globales</span><span class="sxs-lookup"><span data-stu-id="d7b62-145">Explore the global views</span></span>

<span data-ttu-id="d7b62-146">La aplicación SaaS de Wingtip se compila siguiendo un modelo de inquilino por cada base de datos, por lo que el esquema de base de datos de inquilino se define desde la perspectiva del inquilino único.</span><span class="sxs-lookup"><span data-stu-id="d7b62-146">The Wingtip SaaS application is built using a tenant-per-database model, so the tenant database schema is defined from a single-tenant perspective.</span></span> <span data-ttu-id="d7b62-147">Existe información específica del inquilino en una tabla, *Venue*, que siempre tiene una sola fila y, además, se ha diseñado como montón, sin clave principal.</span><span class="sxs-lookup"><span data-stu-id="d7b62-147">Tenant-specific information exists in one table, *Venue*, which always has a single row, and is implemented as a heap, without a primary key.</span></span> <span data-ttu-id="d7b62-148">No es necesario que otras tablas del esquema estén relacionadas con la tabla *Venue*, ya que, en el uso normal, no hay nunca duda de a qué inquilino pertenecen los datos.</span><span class="sxs-lookup"><span data-stu-id="d7b62-148">Other tables in the schema don't need to be related to the *Venue* table, because in normal use, there is never any doubt which tenant the data belongs to.</span></span>

<span data-ttu-id="d7b62-149">Sin embargo, al consultar en todas las bases de datos, es importante que la consulta elástica pueda tratar los datos como si formaran parte de una sola base de datos lógica compartida por el inquilino.</span><span class="sxs-lookup"><span data-stu-id="d7b62-149">However, when querying across all databases, it's important that Elastic Query can treat the data as if it is part of a single logical database sharded by tenant.</span></span> <span data-ttu-id="d7b62-150">Para ello, se agrega un conjunto de vistas 'globales' a la base de datos de inquilino que proyectan un identificador de inquilino en cada una de las tablas que se consultan globalmente.</span><span class="sxs-lookup"><span data-stu-id="d7b62-150">To achieve this, a set of 'global' views are added to the tenant database that project a tenant id into each of the tables that are queried globally.</span></span> <span data-ttu-id="d7b62-151">Por ejemplo, la vista *VenueEvents* agrega un identificador *VenueId* calculado a las columnas que se proyectan desde la tabla *Events*.</span><span class="sxs-lookup"><span data-stu-id="d7b62-151">For example, the *VenueEvents* view adds a computed *VenueId* to the columns projected from the *Events* table.</span></span> <span data-ttu-id="d7b62-152">Al definir la tabla externa en la base de datos principal con la tabla *VenueEvents* (en lugar de con la tabla subyacente *Events*), la consulta elástica puede transferir las combinaciones basadas en el identificador *VenueId* de modo que se pueden ejecutar en paralelo en cada base de datos remota (en lugar de en la base de datos principal).</span><span class="sxs-lookup"><span data-stu-id="d7b62-152">By defining the external table in the head database over *VenueEvents* (rather than the underlying *Events* table), Elastic Query is able to push down joins based on *VenueId* so they can be executed in parallel on each remote database (rather than on the head database).</span></span> <span data-ttu-id="d7b62-153">Así se reduce considerablemente la cantidad de datos que se devuelven, lo que da como resultado un aumento sustancial del rendimiento para muchas consultas.</span><span class="sxs-lookup"><span data-stu-id="d7b62-153">This dramatically reduces the amount of data that is returned, which results in a substantial increase in performance for many queries.</span></span> <span data-ttu-id="d7b62-154">Estas vistas globales se han creado previamente en todas las bases de datos de inquilino (y en *basetenantdb*).</span><span class="sxs-lookup"><span data-stu-id="d7b62-154">These global views have been pre-created in all tenant databases (and in *basetenantdb*).</span></span>

1. <span data-ttu-id="d7b62-155">Abra SSMS y [conéctese al servidor tenants1-&lt;USUARIO&gt;](sql-database-wtp-overview.md#explore-database-schema-and-execute-sql-queries-using-ssms).</span><span class="sxs-lookup"><span data-stu-id="d7b62-155">Open SSMS and [connect to the tenants1-&lt;USER&gt; server](sql-database-wtp-overview.md#explore-database-schema-and-execute-sql-queries-using-ssms).</span></span>
2. <span data-ttu-id="d7b62-156">Expanda **Bases de datos**, haga clic con el botón derecho en **contosoconcerthall** y seleccione **Nueva consulta**.</span><span class="sxs-lookup"><span data-stu-id="d7b62-156">Expand **Databases**, right-click **contosoconcerthall**, and select **New Query**.</span></span>
3. <span data-ttu-id="d7b62-157">Ejecute las siguientes consultas para explorar la diferencia entre las tablas de inquilino único y las vistas globales:</span><span class="sxs-lookup"><span data-stu-id="d7b62-157">Run the following queries to explore the difference between the single-tenant tables and the global views:</span></span>

   ```T-SQL
   -- The base Venue table, that has no VenueId associated.
   SELECT * FROM Venue

   -- Notice the plural name 'Venues'. This view projects a VenueId column.
   SELECT * FROM Venues

   -- The base Events table, which has no VenueId column.
   SELECT * FROM Events

   -- This view projects the VenueId retrieved from the Venues table.
   SELECT * FROM VenueEvents
   ```

<span data-ttu-id="d7b62-158">En estas vistas, el identificador *VenueId* se ha calculado como un valor hash del nombre de Venue, pero se puede usar cualquier estrategia para introducir un valor único.</span><span class="sxs-lookup"><span data-stu-id="d7b62-158">In these views, the *VenueId* is computed as a hash of the Venue name, but any approach could be used to introduce a unique value.</span></span> <span data-ttu-id="d7b62-159">Esta estrategia es similar a cómo se calcula la clave de inquilino para usarse en el catálogo.</span><span class="sxs-lookup"><span data-stu-id="d7b62-159">This approach is similar to the way the tenant key is computed for use in the catalog.</span></span>

<span data-ttu-id="d7b62-160">Para examinar la definición de la vista *Venues*:</span><span class="sxs-lookup"><span data-stu-id="d7b62-160">To examine the definition of the *Venues* view:</span></span>

1. <span data-ttu-id="d7b62-161">En **Explorador de objetos**, expanda **contosoconcerthall** > **Vistas**:</span><span class="sxs-lookup"><span data-stu-id="d7b62-161">In **Object Explorer**, expand **contosoconcethall** > **Views**:</span></span>

   ![vistas](media/sql-database-saas-tutorial-adhoc-analytics/views.png)

2. <span data-ttu-id="d7b62-163">Haga clic con el botón derecho en **dbo.Venues**.</span><span class="sxs-lookup"><span data-stu-id="d7b62-163">Right-click **dbo.Venues**.</span></span>
3. <span data-ttu-id="d7b62-164">Seleccione **Incluir vista como** > **CREATE To** > **Nueva ventana del Editor de consultas**.</span><span class="sxs-lookup"><span data-stu-id="d7b62-164">Select **Script View as** > **CREATE To** > **New Query Editor Window**</span></span>

<span data-ttu-id="d7b62-165">Incluya en el script cualquiera de las otras vistas *Venue* para ver cómo agregan el identificador *VenueId*.</span><span class="sxs-lookup"><span data-stu-id="d7b62-165">Script any of the other *Venue* views to see how they add the *VenueId*.</span></span>

## <a name="deploy-the-database-used-for-ad-hoc-distributed-queries"></a><span data-ttu-id="d7b62-166">Implementación de la base de datos usada para las consultas distribuidas ad hoc</span><span class="sxs-lookup"><span data-stu-id="d7b62-166">Deploy the database used for ad-hoc distributed queries</span></span>

<span data-ttu-id="d7b62-167">En este ejercicio se implementa la base de datos *adhocanalytics*.</span><span class="sxs-lookup"><span data-stu-id="d7b62-167">This exercise deploys the *adhocanalytics* database.</span></span> <span data-ttu-id="d7b62-168">Esta es la base de datos principal que contendrá el esquema utilizado para realizar consultas en todas las bases de datos de inquilino.</span><span class="sxs-lookup"><span data-stu-id="d7b62-168">This is the head database that will contain the schema used for querying across all tenant databases.</span></span> <span data-ttu-id="d7b62-169">La base de datos se implementa en el servidor de catálogo existente, que es el utilizado para todas las bases de datos relacionadas con la administración en la aplicación de ejemplo.</span><span class="sxs-lookup"><span data-stu-id="d7b62-169">The database is deployed to the existing catalog server, which is the server used for all management-related databases in the sample app.</span></span>

1. <span data-ttu-id="d7b62-170">Abra ...\\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalytics.ps1* en *PowerShell ISE* y establezca los valores siguientes:</span><span class="sxs-lookup"><span data-stu-id="d7b62-170">Open ...\\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalytics.ps1* in the *PowerShell ISE* and set the following values:</span></span>
   * <span data-ttu-id="d7b62-171">**$DemoScenario** = 2, **Implementar una base de datos de análisis ad hoc**.</span><span class="sxs-lookup"><span data-stu-id="d7b62-171">**$DemoScenario** = 2, **Deploy Ad-hoc analytics database**.</span></span>

2. <span data-ttu-id="d7b62-172">Presione **F5** para ejecutar el script y crear la base de datos *adhocanalytics*.</span><span class="sxs-lookup"><span data-stu-id="d7b62-172">Press **F5** to run the script and create the *adhocanalytics* database.</span></span>

<span data-ttu-id="d7b62-173">En la siguiente sección, se agrega el esquema a la base de datos de modo que se pueda usar para ejecutar consultas distribuidas.</span><span class="sxs-lookup"><span data-stu-id="d7b62-173">In the next section, you add schema to the database so it can be used to run distributed queries.</span></span>

## <a name="configure-the-database-for-running-distributed-queries"></a><span data-ttu-id="d7b62-174">Configuración de la base de datos para ejecutar consultas distribuidas</span><span class="sxs-lookup"><span data-stu-id="d7b62-174">Configure the database for running distributed queries</span></span>

<span data-ttu-id="d7b62-175">En este ejercicio se agrega el esquema (el origen de datos externo y las definiciones de tabla externas) a la base de datos de análisis ad hoc que permite realizar consultas en todas las bases de datos de inquilino.</span><span class="sxs-lookup"><span data-stu-id="d7b62-175">This exercise adds schema (the external data source and external table definitions) to the ad-hoc analytics database that enables querying across all tenant databases.</span></span>

1. <span data-ttu-id="d7b62-176">Abra SQL Server Management Studio y conéctese a la base de datos de análisis ad hoc que creó en el paso anterior.</span><span class="sxs-lookup"><span data-stu-id="d7b62-176">Open SQL Server Management Studio, and connect to the Adhoc Analytics database you created in the previous step.</span></span> <span data-ttu-id="d7b62-177">El nombre de la base de datos será adhocanalytics.</span><span class="sxs-lookup"><span data-stu-id="d7b62-177">The name of the database will be adhocanalytics.</span></span>
2. <span data-ttu-id="d7b62-178">Abra ...\Learning Modules\Operational Analytics\Adhoc Analytics\ *Initialize-AdhocAnalyticsDB.sql* en SSMS.</span><span class="sxs-lookup"><span data-stu-id="d7b62-178">Open ...\Learning Modules\Operational Analytics\Adhoc Analytics\ *Initialize-AdhocAnalyticsDB.sql* in SSMS.</span></span>
3. <span data-ttu-id="d7b62-179">Revise el script SQL y tenga en cuenta lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="d7b62-179">Review the SQL script and note the following:</span></span>

   <span data-ttu-id="d7b62-180">La consulta elástica usa una credencial de ámbito de base de datos para acceder a cada una de las bases de datos de inquilino.</span><span class="sxs-lookup"><span data-stu-id="d7b62-180">Elastic Query uses a database-scoped credential to access each of the tenant databases.</span></span> <span data-ttu-id="d7b62-181">Esta credencial debe estar disponible en todas las bases de datos y normalmente se le deberían conceder los derechos mínimos necesarios para permitir estas consultas ad hoc.</span><span class="sxs-lookup"><span data-stu-id="d7b62-181">This credential needs to be available in all the databases and should normally be granted the minimum rights required to enable these ad-hoc queries.</span></span>

    ![crear credencial](media/sql-database-saas-tutorial-adhoc-analytics/create-credential.png)

   <span data-ttu-id="d7b62-183">El origen de datos externo, que se define para usar el mapa de particiones de inquilino en la base de datos de catálogo.</span><span class="sxs-lookup"><span data-stu-id="d7b62-183">The external data source, that is defined to use the tenant shard map in the catalog database.</span></span> <span data-ttu-id="d7b62-184">Al utilizarlo como origen de datos externo, las consultas se distribuyen a todas las bases de datos registradas en el catálogo cuando se ejecuta la consulta.</span><span class="sxs-lookup"><span data-stu-id="d7b62-184">By using this as the external data source, queries are distributed to all databases registered in the catalog when the query is run.</span></span> <span data-ttu-id="d7b62-185">Dado que los nombres de servidor son diferentes para cada implementación, este script de inicialización obtiene la ubicación de la base de datos de catálogo mediante la recuperación del servidor actual (@@servername) donde se ejecuta el script.</span><span class="sxs-lookup"><span data-stu-id="d7b62-185">Because server names are different for each deployment, this initialization script gets the location of the catalog database by retrieving the current server (@@servername) where the script is executed.</span></span>

    ![crear origen de datos externos](media/sql-database-saas-tutorial-adhoc-analytics/create-external-data-source.png)

   <span data-ttu-id="d7b62-187">Las tablas externas que hacen referencia a las vistas globales descritas en la sección anterior y definidas con **DISTRIBUTION = SHARDED(VenueId)**.</span><span class="sxs-lookup"><span data-stu-id="d7b62-187">The external tables that reference the global views described in the previous section, and defined with **DISTRIBUTION = SHARDED(VenueId)**.</span></span> <span data-ttu-id="d7b62-188">Dado que cada identificador *VenueId* se asigna a una sola base de datos, así se mejora el rendimiento para muchos escenarios, como se muestra en la sección siguiente.</span><span class="sxs-lookup"><span data-stu-id="d7b62-188">Because each *VenueId* maps to a single database, this improves performance for many scenarios as shown in the next section.</span></span>

    ![crear tablas externas](media/sql-database-saas-tutorial-adhoc-analytics/external-tables.png)

   <span data-ttu-id="d7b62-190">La tabla local *VenueTypes* que se crea y rellena.</span><span class="sxs-lookup"><span data-stu-id="d7b62-190">The local table *VenueTypes* that is created and populated.</span></span> <span data-ttu-id="d7b62-191">Esta tabla de datos de referencia es común en todas las bases de datos de inquilino, por lo que se puede representar como una tabla local y rellenarse con los datos comunes.</span><span class="sxs-lookup"><span data-stu-id="d7b62-191">This reference data table is common in all tenant databases, so it can be represented here as a local table and populated with the common data.</span></span> <span data-ttu-id="d7b62-192">En algunas consultas, así se puede reducir la cantidad de datos movidos entre las bases de datos de inquilino y la base de datos *adhocanalytics*.</span><span class="sxs-lookup"><span data-stu-id="d7b62-192">For some queries this may reduce the amount of data moved between the tenant databases and the *adhocanalytics* database.</span></span>

    ![crear tabla](media/sql-database-saas-tutorial-adhoc-analytics/create-table.png)

   <span data-ttu-id="d7b62-194">Si incluye tablas de referencia de esta manera, asegúrese de actualizar el esquema de tabla y los datos cada vez que actualice las bases de datos de inquilino.</span><span class="sxs-lookup"><span data-stu-id="d7b62-194">If you include reference tables in this manner, be sure to update the table schema and data whenever you update the tenant databases.</span></span>

4. <span data-ttu-id="d7b62-195">Presione **F5** para ejecutar el script e inicializar la base de datos *adhocanalytics*.</span><span class="sxs-lookup"><span data-stu-id="d7b62-195">Press **F5** to run the script and initialize the *adhocanalytics* database.</span></span> 

<span data-ttu-id="d7b62-196">Ahora puede ejecutar consultas distribuidas y recopilar información de todos los inquilinos.</span><span class="sxs-lookup"><span data-stu-id="d7b62-196">Now you can run distributed queries, and gather insights across all tenants!</span></span>

## <a name="run-ad-hoc-distributed-queries"></a><span data-ttu-id="d7b62-197">Ejecución de consultas distribuidas ad hoc</span><span class="sxs-lookup"><span data-stu-id="d7b62-197">Run ad-hoc distributed queries</span></span>

<span data-ttu-id="d7b62-198">Ahora que la base de datos *adhocanalytics* está configurada, continúe y ejecute algunas consultas distribuidas.</span><span class="sxs-lookup"><span data-stu-id="d7b62-198">Now that the *adhocanalytics* database is set up, go ahead and run some distributed queries.</span></span> <span data-ttu-id="d7b62-199">Incluya el plan de ejecución para comprender mejor dónde sucede el procesamiento de las consultas.</span><span class="sxs-lookup"><span data-stu-id="d7b62-199">Include the execution plan for a better understanding of where the query processing is happening.</span></span> 

<span data-ttu-id="d7b62-200">Al inspeccionar el plan de ejecución, mantenga el mouse sobre los iconos de plan para obtener más información.</span><span class="sxs-lookup"><span data-stu-id="d7b62-200">When inspecting the execution plan, hover over the plan icons for details.</span></span> 

<span data-ttu-id="d7b62-201">Es importante tener en cuenta que la configuración **DISTRIBUTION = SHARDED(VenueId)** cuando se define el origen de datos externo, mejora el rendimiento en muchos escenarios.</span><span class="sxs-lookup"><span data-stu-id="d7b62-201">Important to note, is that setting **DISTRIBUTION = SHARDED(VenueId)** when we defined the external data source, improves performance for many scenarios.</span></span> <span data-ttu-id="d7b62-202">Dado que cada identificador *VenueId* se asigna a una sola base de datos, el filtrado se lleva a cabo fácilmente de forma remota, y devuelve solo los datos que se necesitan.</span><span class="sxs-lookup"><span data-stu-id="d7b62-202">Because each *VenueId* maps to a single database, filtering is easily done remotely, returning only the data we need.</span></span>

1. <span data-ttu-id="d7b62-203">Abra ...\\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalyticsQueries.sql* en SSMS.</span><span class="sxs-lookup"><span data-stu-id="d7b62-203">Open ...\\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalyticsQueries.sql* in SSMS.</span></span>
2. <span data-ttu-id="d7b62-204">Asegúrese de que está conectado a la base de datos **adhocanalytics**.</span><span class="sxs-lookup"><span data-stu-id="d7b62-204">Ensure you are connected to the **adhocanalytics** database.</span></span>
3. <span data-ttu-id="d7b62-205">Seleccione el menú **Consulta** y haga clic en **Incluir plan de ejecución real**.</span><span class="sxs-lookup"><span data-stu-id="d7b62-205">Select the **Query** menu and click **Include Actual Execution Plan**</span></span>
4. <span data-ttu-id="d7b62-206">Resalte la consulta *Which venues are currently registered?* (¿Qué ubicaciones están registradas actualmente?) y presione **F5**.</span><span class="sxs-lookup"><span data-stu-id="d7b62-206">Highlight the *Which venues are currently registered?* query, and press **F5**.</span></span>

   <span data-ttu-id="d7b62-207">La consulta devuelve la lista de ubicaciones completa e ilustra lo rápido y fácil que es realizar consultas en todos los inquilinos y devolver los datos de cada uno.</span><span class="sxs-lookup"><span data-stu-id="d7b62-207">The query returns the entire venue list, illustrating how quick and easy it is to query across all tenants and return data from each tenant.</span></span>

   <span data-ttu-id="d7b62-208">Inspeccione el plan y compruebe que el costo íntegro es la consulta remota porque simplemente vamos a cada base de datos de inquilino y seleccionamos la información de las ubicaciones.</span><span class="sxs-lookup"><span data-stu-id="d7b62-208">Inspect the plan and see that the entire cost is the remote query because we're simply going to each tenant database and selecting the venue information.</span></span>

   ![SELECT * FROM dbo.Venues](media/sql-database-saas-tutorial-adhoc-analytics/query1-plan.png)

5. <span data-ttu-id="d7b62-210">Seleccione la siguiente consulta y presione **F5**.</span><span class="sxs-lookup"><span data-stu-id="d7b62-210">Select the next query, and press **F5**.</span></span>

   <span data-ttu-id="d7b62-211">Esta consulta combina datos de las bases de datos de inquilino y de la tabla local *VenueTypes* (local porque es una tabla de la base de datos *adhocanalytics*).</span><span class="sxs-lookup"><span data-stu-id="d7b62-211">This query joins data from the tenant databases and the local *VenueTypes* table (local, as its a table in the *adhocanalytics* database).</span></span>

   <span data-ttu-id="d7b62-212">Inspeccione el plan y compruebe que la mayor parte del costo es la consulta remota, ya que se consulta la información de ubicación de cada inquilino (dbo.Venues) y, a continuación, se realiza una combinación rápida local con la tabla local *VenueTypes* para mostrar el nombre descriptivo.</span><span class="sxs-lookup"><span data-stu-id="d7b62-212">Inspect the plan and see that the majority of cost is the remote query because we query each tenant's venue info (dbo.Venues), and then do a quick local join with the local *VenueTypes* table to display the friendly name.</span></span>

   ![Combinación de datos remotos y locales](media/sql-database-saas-tutorial-adhoc-analytics/query2-plan.png)

6. <span data-ttu-id="d7b62-214">Ahora seleccione la consulta *On which day were the most tickets sold?* (¿Qué día se vendieron más entradas?) y presione **F5**.</span><span class="sxs-lookup"><span data-stu-id="d7b62-214">Now select the *On which day were the most tickets sold?* query, and press **F5**.</span></span>

   <span data-ttu-id="d7b62-215">Esta consulta hace una combinación y una agregación un poco más complejas.</span><span class="sxs-lookup"><span data-stu-id="d7b62-215">This query does a bit more complex joining and aggregation.</span></span> <span data-ttu-id="d7b62-216">Es importante tener en cuenta que la mayor parte del procesamiento se realiza de forma remota y, una vez más, se devuelven solo las filas que se necesitan, una única fila para el recuento total diario de ventas de entradas de cada ubicación.</span><span class="sxs-lookup"><span data-stu-id="d7b62-216">What's important to note is that most of the processing is done remotely, and once again, we bring back only the rows we need, returning just a single row for each venue's aggregate ticket sale count per day.</span></span>

   ![query](media/sql-database-saas-tutorial-adhoc-analytics/query3-plan.png)


## <a name="next-steps"></a><span data-ttu-id="d7b62-218">Pasos siguientes</span><span class="sxs-lookup"><span data-stu-id="d7b62-218">Next steps</span></span>

<span data-ttu-id="d7b62-219">En este tutorial, ha aprendido cómo:</span><span class="sxs-lookup"><span data-stu-id="d7b62-219">In this tutorial you learned how to:</span></span>

> [!div class="checklist"]

> * <span data-ttu-id="d7b62-220">Ejecutar consultas distribuidas en todas las bases de datos de inquilinos</span><span class="sxs-lookup"><span data-stu-id="d7b62-220">Run distributed queries across all tenant databases</span></span>
> * <span data-ttu-id="d7b62-221">Implementar una base de datos de análisis ad hoc y agregarle el esquema para ejecutar consultas distribuidas.</span><span class="sxs-lookup"><span data-stu-id="d7b62-221">Deploy an ad-hoc analytics database and add schema to it to run distributed queries.</span></span>


<span data-ttu-id="d7b62-222">Ahora pruebe el [tutorial de análisis de inquilinos](sql-database-saas-tutorial-tenant-analytics.md) para explorar la extracción de datos en una base de datos de análisis independiente para llevar a cabo un procesamiento de análisis más complejo.</span><span class="sxs-lookup"><span data-stu-id="d7b62-222">Now try the [Tenant Analytics tutorial](sql-database-saas-tutorial-tenant-analytics.md) to explore extracting data to a separate analytics database for more complex analytics processing...</span></span>

## <a name="additional-resources"></a><span data-ttu-id="d7b62-223">Recursos adicionales</span><span class="sxs-lookup"><span data-stu-id="d7b62-223">Additional resources</span></span>

* <span data-ttu-id="d7b62-224">Otros [tutoriales basados en la aplicación SaaS de Wingtip](sql-database-wtp-overview.md#sql-database-wingtip-saas-tutorials)</span><span class="sxs-lookup"><span data-stu-id="d7b62-224">Additional [tutorials that build upon the Wingtip SaaS application](sql-database-wtp-overview.md#sql-database-wingtip-saas-tutorials)</span></span>
* [<span data-ttu-id="d7b62-225">Consulta elástica</span><span class="sxs-lookup"><span data-stu-id="d7b62-225">Elastic Query</span></span>](sql-database-elastic-query-overview.md)
