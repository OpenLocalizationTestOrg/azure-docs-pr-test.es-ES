---
title: "Preparación del entorno para realizar copias de seguridad de Azure Virtual Machines | Microsoft Docs"
description: "Asegúrese de que el entorno está preparado para la copia de seguridad de máquinas virtuales en Azure"
services: backup
documentationcenter: 
author: markgalioto
manager: carmonn
editor: 
keywords: copias de seguridad; realizar copia de seguridad
ms.assetid: 238ab93b-8acc-4262-81b7-ce930f76a662
ms.service: backup
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 4/25/2017
ms.author: markgal;trinadhk;
ms.openlocfilehash: 072efdccaa8df5d430314d753a437b524986b53c
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 07/11/2017
---
# <a name="prepare-your-environment-to-back-up-azure-virtual-machines"></a><span data-ttu-id="757a8-104">Preparación del entorno de copia de seguridad de máquinas virtuales de Azure</span><span class="sxs-lookup"><span data-stu-id="757a8-104">Prepare your environment to back up Azure virtual machines</span></span>
> [!div class="op_single_selector"]
> * [<span data-ttu-id="757a8-105">Modelo de Resource Manager</span><span class="sxs-lookup"><span data-stu-id="757a8-105">Resource Manager model</span></span>](backup-azure-arm-vms-prepare.md)
> * [<span data-ttu-id="757a8-106">Modelo clásico</span><span class="sxs-lookup"><span data-stu-id="757a8-106">Classic model</span></span>](backup-azure-vms-prepare.md)
>
>

<span data-ttu-id="757a8-107">Para hacer copias de seguridad de una máquina virtual (VM) de Azure, deben darse tres condiciones.</span><span class="sxs-lookup"><span data-stu-id="757a8-107">Before you can back up an Azure virtual machine (VM), there are three conditions that must exist.</span></span>

* <span data-ttu-id="757a8-108">Tiene que crear un almacén de copia de seguridad o identificar un almacén de copia de seguridad existente *en la misma región que la máquina virtual*.</span><span class="sxs-lookup"><span data-stu-id="757a8-108">You need to create a backup vault or identify an existing backup vault *in the same region as your VM*.</span></span>
* <span data-ttu-id="757a8-109">Establecer la conectividad de red entre las direcciones de Internet públicas Azure y los puntos de conexión de Azure Storage.</span><span class="sxs-lookup"><span data-stu-id="757a8-109">Establish network connectivity between the Azure public Internet addresses and the Azure storage endpoints.</span></span>
* <span data-ttu-id="757a8-110">Instalar el agente de máquina virtual en la VM.</span><span class="sxs-lookup"><span data-stu-id="757a8-110">Install the VM agent on the VM.</span></span>

<span data-ttu-id="757a8-111">Si sabe que estas condiciones ya existen en su entorno, vaya al artículo [Copia de seguridad de máquinas virtuales de Azure](backup-azure-vms.md).</span><span class="sxs-lookup"><span data-stu-id="757a8-111">If you know these conditions already exist in your environment then proceed to the [Back up your VMs article](backup-azure-vms.md).</span></span> <span data-ttu-id="757a8-112">De lo contrario, continúe leyendo, este artículo le guiará por los pasos para preparar el entorno para realizar la copia de una VM de Azure.</span><span class="sxs-lookup"><span data-stu-id="757a8-112">Otherwise, read on, this article will lead you through the steps to prepare your environment to back up an Azure VM.</span></span>

##<a name="supported-operating-system-for-backup"></a><span data-ttu-id="757a8-113">Sistemas operativos compatibles para copia de seguridad</span><span class="sxs-lookup"><span data-stu-id="757a8-113">Supported operating system for backup</span></span>
 * <span data-ttu-id="757a8-114">**Linux**: Azure Backup admite [una lista de distribuciones aprobadas por Azure](../virtual-machines/linux/endorsed-distros.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json), con la excepción de CoreOS Linux.</span><span class="sxs-lookup"><span data-stu-id="757a8-114">**Linux**: Azure Backup supports [a list of distributions that are endorsed by Azure](../virtual-machines/linux/endorsed-distros.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) except Core OS Linux.</span></span> <span data-ttu-id="757a8-115">_Otras distribuciones con la iniciativa "traiga su propio Linux" también podrían funcionar, siempre que el agente de máquina virtual esté disponible en la máquina virtual y haya compatibilidad con Python. Sin embargo, no respaldamos esas distribuciones para copia de seguridad._</span><span class="sxs-lookup"><span data-stu-id="757a8-115">_Other Bring-Your-Own-Linux distributions also might work as long as the VM agent is available on the virtual machine and support for Python exists. However, we do not endorse those distributions for backup._</span></span>
 * <span data-ttu-id="757a8-116">**Windows Server**: no se admiten las versiones anteriores a Windows Server 2008 R2.</span><span class="sxs-lookup"><span data-stu-id="757a8-116">**Windows Server**:  Versions older than Windows Server 2008 R2 are not supported.</span></span>


## <a name="limitations-when-backing-up-and-restoring-a-vm"></a><span data-ttu-id="757a8-117">Limitaciones al realizar copias de seguridad y restaurar una máquina virtual</span><span class="sxs-lookup"><span data-stu-id="757a8-117">Limitations when backing up and restoring a VM</span></span>
> [!NOTE]
> <span data-ttu-id="757a8-118">Azure cuenta con dos modelos de implementación para crear recursos y trabajar con ellos: [Resource Manager y el modelo clásico](../azure-resource-manager/resource-manager-deployment-model.md).</span><span class="sxs-lookup"><span data-stu-id="757a8-118">Azure has two deployment models for creating and working with resources: [Resource Manager and classic](../azure-resource-manager/resource-manager-deployment-model.md).</span></span> <span data-ttu-id="757a8-119">La siguiente lista proporciona las limitaciones cuando se implementa en el modelo clásico.</span><span class="sxs-lookup"><span data-stu-id="757a8-119">The following list provides the limitations when deploying in the classic model.</span></span>
>
>

* <span data-ttu-id="757a8-120">No se admite la copia de seguridad de máquinas virtuales con más de 16 discos de datos.</span><span class="sxs-lookup"><span data-stu-id="757a8-120">Backing up virtual machines with more than 16 data disks is not supported.</span></span>
* <span data-ttu-id="757a8-121">No se admite la copia de seguridad de máquinas virtuales con una dirección IP reservada y sin puntos de conexión definidos.</span><span class="sxs-lookup"><span data-stu-id="757a8-121">Backing up virtual machines with a reserved IP address and no defined endpoint is not supported.</span></span>
* <span data-ttu-id="757a8-122">Los datos de copia de seguridad no incluyen unidades montadas de red conectadas a la máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="757a8-122">Backup data doesn't include network mounted drives attached to VM.</span></span>
* <span data-ttu-id="757a8-123">No se admite el reemplazo de una máquina virtual existente durante la restauración.</span><span class="sxs-lookup"><span data-stu-id="757a8-123">Replacing an existing virtual machine during restore is not supported.</span></span> <span data-ttu-id="757a8-124">Primero, elimine la máquina virtual existente y los discos asociados y, a continuación, restaure los datos de copia de seguridad.</span><span class="sxs-lookup"><span data-stu-id="757a8-124">First delete the existing virtual machine and any associated disks, and then restore the data from backup.</span></span>
* <span data-ttu-id="757a8-125">No se admite la restauración y copia de seguridad entre regiones.</span><span class="sxs-lookup"><span data-stu-id="757a8-125">Cross-region backup and restore is not supported.</span></span>
* <span data-ttu-id="757a8-126">Se admite la copia de seguridad de máquinas virtuales mediante el uso del servicio Azure Backup en todas las regiones públicas de Azure (consulte la [lista de comprobación](https://azure.microsoft.com/regions/#services) de las regiones compatibles).</span><span class="sxs-lookup"><span data-stu-id="757a8-126">Backing up virtual machines by using the Azure Backup service is supported in all public regions of Azure (see the [checklist](https://azure.microsoft.com/regions/#services) of supported regions).</span></span> <span data-ttu-id="757a8-127">Si la región que está buscando no es compatible actualmente, no aparecerá en la lista desplegable durante la creación del almacén.</span><span class="sxs-lookup"><span data-stu-id="757a8-127">If the region that you are looking for is unsupported today, it will not appear in the dropdown list during vault creation.</span></span>
* <span data-ttu-id="757a8-128">La copia de seguridad de máquinas virtuales con el servicio Azure Backup solo se admite en determinadas versiones de sistemas operativos:</span><span class="sxs-lookup"><span data-stu-id="757a8-128">Backing up virtual machines by using the Azure Backup service is supported only for select operating system versions:</span></span>
* <span data-ttu-id="757a8-129">La restauración de una máquina virtual de controlador de dominio que forma parte de una configuración de varios controladores de dominio solo se admite a través de PowerShell.</span><span class="sxs-lookup"><span data-stu-id="757a8-129">Restoring a domain controller (DC) VM that is part of a multi-DC configuration is supported only through PowerShell.</span></span> <span data-ttu-id="757a8-130">Más información sobre cómo [restaurar un controlador de dominio de varios controladores de dominio](backup-azure-restore-vms.md#restoring-domain-controller-vms)</span><span class="sxs-lookup"><span data-stu-id="757a8-130">Read more about [restoring a multi-DC domain controller](backup-azure-restore-vms.md#restoring-domain-controller-vms).</span></span>
* <span data-ttu-id="757a8-131">Solo se admite la restauración de las máquinas virtuales que tienen las siguientes configuraciones especiales de red a través de PowerShell.</span><span class="sxs-lookup"><span data-stu-id="757a8-131">Restoring virtual machines that have the following special network configurations is supported only through PowerShell.</span></span> <span data-ttu-id="757a8-132">Las máquinas virtuales que se crean con el flujo de trabajo de restauración en la interfaz de usuario no tendrán estas configuraciones de red cuando se complete la operación de restauración.</span><span class="sxs-lookup"><span data-stu-id="757a8-132">VMs that you create by using the restore workflow in the UI will not have these network configurations after the restore operation is complete.</span></span> <span data-ttu-id="757a8-133">Si desea obtener más información, consulte [Restauración de máquinas virtuales con configuraciones de red especiales](backup-azure-restore-vms.md#restoring-vms-with-special-network-configurations).</span><span class="sxs-lookup"><span data-stu-id="757a8-133">To learn more, see [Restoring VMs with special network configurations](backup-azure-restore-vms.md#restoring-vms-with-special-network-configurations).</span></span>
  * <span data-ttu-id="757a8-134">Máquinas virtuales con la configuración del equilibrador de carga (interna y externa).</span><span class="sxs-lookup"><span data-stu-id="757a8-134">Virtual machines under load balancer configuration (internal and external)</span></span>
  * <span data-ttu-id="757a8-135">Máquinas virtuales con varias direcciones IP reservadas.</span><span class="sxs-lookup"><span data-stu-id="757a8-135">Virtual machines with multiple reserved IP addresses</span></span>
  * <span data-ttu-id="757a8-136">Máquinas virtuales con varios adaptadores de red.</span><span class="sxs-lookup"><span data-stu-id="757a8-136">Virtual machines with multiple network adapters</span></span>

## <a name="create-a-backup-vault-for-a-vm"></a><span data-ttu-id="757a8-137">Creación de un almacén de copia de seguridad para una máquina virtual</span><span class="sxs-lookup"><span data-stu-id="757a8-137">Create a backup vault for a VM</span></span>
<span data-ttu-id="757a8-138">Un almacén de copia de seguridad es una entidad que almacena todas las copias de seguridad y los puntos de recuperación creados con el tiempo.</span><span class="sxs-lookup"><span data-stu-id="757a8-138">A backup vault is an entity that stores all the backups and recovery points that have been created over time.</span></span> <span data-ttu-id="757a8-139">El almacén de copia de seguridad contiene también las directivas de copia de seguridad que se aplicarán a las máquinas virtuales cuya copia de seguridad se está realizando.</span><span class="sxs-lookup"><span data-stu-id="757a8-139">The backup vault also contains the backup policies that will be applied to the virtual machines being backed up.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="757a8-140">A partir de marzo de 2017, ya no podrá usar el portal clásico para crear almacenes de Backup.</span><span class="sxs-lookup"><span data-stu-id="757a8-140">Starting March 2017, you can no longer use the classic portal to create Backup vaults.</span></span> <span data-ttu-id="757a8-141">Todavía se admitirán los almacenes de Backup existentes y es posible [usar Azure PowerShell para crear almacenes de Backup](./backup-client-automation-classic.md#create-a-backup-vault).</span><span class="sxs-lookup"><span data-stu-id="757a8-141">Existing Backup vaults are still supported, and it is possible to [use Azure PowerShell to create Backup vaults](./backup-client-automation-classic.md#create-a-backup-vault).</span></span> <span data-ttu-id="757a8-142">Sin embargo, Microsoft recomienda crear almacenes de Recovery Services para todas las implementaciones porque las futuras mejoras solo se aplican a almacenes de Recovery Services.</span><span class="sxs-lookup"><span data-stu-id="757a8-142">However, Microsoft recommends you create Recovery Services vaults for all deployments because future enhancements apply to Recovery Services vaults, only.</span></span>


<span data-ttu-id="757a8-143">La siguiente imagen muestra las relaciones entre las diversas entidades de Azure Backup: ![entidades y relaciones de Azure Backup](./media/backup-azure-vms-prepare/vault-policy-vm.png)</span><span class="sxs-lookup"><span data-stu-id="757a8-143">This image shows the relationships between the various Azure Backup entities: ![Azure Backup entities and relationships](./media/backup-azure-vms-prepare/vault-policy-vm.png)</span></span>



## <a name="network-connectivity"></a><span data-ttu-id="757a8-144">Conectividad de red</span><span class="sxs-lookup"><span data-stu-id="757a8-144">Network connectivity</span></span>
<span data-ttu-id="757a8-145">Para administrar las instantáneas de máquina virtual, la extensión de copia de seguridad necesita conectividad a las direcciones IP públicas de Azure.</span><span class="sxs-lookup"><span data-stu-id="757a8-145">In order to manage the VM snapshots, the backup extension needs connectivity to the Azure public IP addresses.</span></span> <span data-ttu-id="757a8-146">Sin la conectividad a Internet adecuada, el tiempo de espera de las solicitudes HTTP de la máquina virtual se agota y se produce un error en la operación de copia de seguridad.</span><span class="sxs-lookup"><span data-stu-id="757a8-146">Without the right Internet connectivity, the virtual machine's HTTP requests time out and the backup operation fails.</span></span> <span data-ttu-id="757a8-147">Si la implementación tiene restricciones de acceso establecidas (a través de un grupo de seguridad de red (NSG), por ejemplo), elija entonces una de estas opciones para proporcionar una ruta de acceso clara para el tráfico de copia de seguridad:</span><span class="sxs-lookup"><span data-stu-id="757a8-147">If your deployment has access restrictions in place (through a network security group (NSG), for example), then choose one of these options for providing a clear path for backup traffic:</span></span>

* <span data-ttu-id="757a8-148">[Whitelist the Azure datacenter IP ranges](http://www.microsoft.com/en-us/download/details.aspx?id=41653) (Creación de listas blancas con intervalos de direcciones IP de centro de datos de Azure): consulte este artículo para obtener instrucciones sobre cómo crear una lista blanca con las direcciones IP.</span><span class="sxs-lookup"><span data-stu-id="757a8-148">[Whitelist the Azure datacenter IP ranges](http://www.microsoft.com/en-us/download/details.aspx?id=41653) - see the article for instructions on how to whitelist the IP addresses.</span></span>
* <span data-ttu-id="757a8-149">Implementación de un servidor proxy HTTP para enrutar el tráfico.</span><span class="sxs-lookup"><span data-stu-id="757a8-149">Deploy an HTTP proxy server for routing traffic.</span></span>

<span data-ttu-id="757a8-150">Al decidir qué opción utilizar, busque el equilibrio entre costo, control granular y facilidad de uso.</span><span class="sxs-lookup"><span data-stu-id="757a8-150">When deciding which option to use, the trade-offs are between manageability, granular control, and cost.</span></span>

| <span data-ttu-id="757a8-151">Opción</span><span class="sxs-lookup"><span data-stu-id="757a8-151">Option</span></span> | <span data-ttu-id="757a8-152">Ventajas</span><span class="sxs-lookup"><span data-stu-id="757a8-152">Advantages</span></span> | <span data-ttu-id="757a8-153">Desventajas</span><span class="sxs-lookup"><span data-stu-id="757a8-153">Disadvantages</span></span> |
| --- | --- | --- |
| <span data-ttu-id="757a8-154">Creación de una lista blanca con intervalos IP</span><span class="sxs-lookup"><span data-stu-id="757a8-154">Whitelist IP ranges</span></span> |<span data-ttu-id="757a8-155">Sin costos adicionales.</span><span class="sxs-lookup"><span data-stu-id="757a8-155">No additional costs.</span></span><br><br><span data-ttu-id="757a8-156">Para abrir el acceso en un grupo de seguridad de red, use el cmdlet <i>Set-AzureNetworkSecurityRule</i>.</span><span class="sxs-lookup"><span data-stu-id="757a8-156">For opening access in an NSG, use the <i>Set-AzureNetworkSecurityRule</i> cmdlet.</span></span> |<span data-ttu-id="757a8-157">Es complejo de administrar, ya que los intervalos de IP afectados cambian con el tiempo.</span><span class="sxs-lookup"><span data-stu-id="757a8-157">Complex to manage as the impacted IP ranges change over time.</span></span><br><br><span data-ttu-id="757a8-158">Proporciona acceso a la totalidad de Azure y no solo al almacenamiento.</span><span class="sxs-lookup"><span data-stu-id="757a8-158">Provides access to the whole of Azure, and not just Storage.</span></span> |
| <span data-ttu-id="757a8-159">Proxy HTTP</span><span class="sxs-lookup"><span data-stu-id="757a8-159">HTTP proxy</span></span> |<span data-ttu-id="757a8-160">Se permite un control detallado en el proxy sobre las direcciones URL de almacenamiento.</span><span class="sxs-lookup"><span data-stu-id="757a8-160">Granular control in the proxy over the storage URLs allowed.</span></span> <span data-ttu-id="757a8-161">Para configurar un control detallado en el proxy, el patrón de URL https://\*.blob.core.windows.net/\* debe estar en la lista de permitidos.</span><span class="sxs-lookup"><span data-stu-id="757a8-161">To setup granular control in the proxy, https://\*.blob.core.windows.net/\* URL Pattern needs to be whitelisted.</span></span> <span data-ttu-id="757a8-162">Para incluir en la lista de permitidos únicamente la cuenta de almacenamiento usada por la máquina virtual, el patrón de URL https://\<storageAccount\>.blob.core.windows.net/\* debe estar en la lista de permitidos.</span><span class="sxs-lookup"><span data-stu-id="757a8-162">To whitelist only the storage account used by the VM, https://\<storageAccount\>.blob.core.windows.net/\* URL pattern needs to be whitelisted.</span></span> <br><span data-ttu-id="757a8-163">Un único punto de acceso a Internet para las máquinas virtuales.</span><span class="sxs-lookup"><span data-stu-id="757a8-163">Single point of Internet access to VMs.</span></span><br><span data-ttu-id="757a8-164">No están sujetas a cambios de direcciones IP de Azure.</span><span class="sxs-lookup"><span data-stu-id="757a8-164">Not subject to Azure IP address changes.</span></span> |<span data-ttu-id="757a8-165">Costes adicionales de ejecutar una máquina virtual con el software de proxy.</span><span class="sxs-lookup"><span data-stu-id="757a8-165">Additional costs for running a VM with the proxy software.</span></span> |

### <a name="whitelist-the-azure-datacenter-ip-ranges"></a><span data-ttu-id="757a8-166">Whitelist the Azure datacenter IP ranges</span><span class="sxs-lookup"><span data-stu-id="757a8-166">Whitelist the Azure datacenter IP ranges</span></span>
<span data-ttu-id="757a8-167">Para crear una lista blanca con los intervalos de IP de centro de datos de Azure, visite el [sitio web de Azure](http://www.microsoft.com/en-us/download/details.aspx?id=41653). Ahí encontrará información detallada sobre los intervalos de IP, junto con instrucciones.</span><span class="sxs-lookup"><span data-stu-id="757a8-167">To whitelist the Azure datacenter IP ranges, please see the [Azure website](http://www.microsoft.com/en-us/download/details.aspx?id=41653) for details on the IP ranges, and instructions.</span></span>

### <a name="using-an-http-proxy-for-vm-backups"></a><span data-ttu-id="757a8-168">Uso de un proxy HTTP para las copias de seguridad de máquinas virtuales</span><span class="sxs-lookup"><span data-stu-id="757a8-168">Using an HTTP proxy for VM backups</span></span>
<span data-ttu-id="757a8-169">Cuando se realiza una copia de seguridad de una máquina virtual, la extensión de copia de seguridad de dicha máquina envía los comandos de administración de instantáneas a Azure Storage mediante una API de HTTPS.</span><span class="sxs-lookup"><span data-stu-id="757a8-169">When backing up a VM, the backup extension on the VM sends the snapshot management commands to Azure Storage using an HTTPS API.</span></span> <span data-ttu-id="757a8-170">Enrute el tráfico de extensión de copia de seguridad a través del proxy HTTP, ya que es el único componente configurado para el acceso a la red pública de Internet.</span><span class="sxs-lookup"><span data-stu-id="757a8-170">Route the backup extension traffic through the HTTP proxy since it is the only component configured for access to the public Internet.</span></span>

> [!NOTE]
> <span data-ttu-id="757a8-171">No hay ninguna recomendación que deba usarse para el software de proxy.</span><span class="sxs-lookup"><span data-stu-id="757a8-171">There is no recommendation for the proxy software that should be used.</span></span> <span data-ttu-id="757a8-172">Asegúrese de que selecciona un proxy que tenga permanencia de salida y que sea compatible con los pasos de configuración que se indican a continuación.</span><span class="sxs-lookup"><span data-stu-id="757a8-172">Ensure that you pick a proxy that has outbound stickiness and which is compatible with the configuration steps below.</span></span> <span data-ttu-id="757a8-173">Asegúrese de que los programas de software de terceros no modifican la configuración del proxy</span><span class="sxs-lookup"><span data-stu-id="757a8-173">Make sure third party softwares do not modify the proxy settings</span></span>
>
>

<span data-ttu-id="757a8-174">En la imagen de ejemplo siguiente se muestran los tres pasos de configuración necesarios para utilizar un proxy HTTP:</span><span class="sxs-lookup"><span data-stu-id="757a8-174">The example image below shows the three configuration steps necessary to use an HTTP proxy:</span></span>

* <span data-ttu-id="757a8-175">La máquina virtual de la aplicación enruta todo el tráfico HTTP enlazado para la red pública de Internet a través de la máquina virtual de proxy.</span><span class="sxs-lookup"><span data-stu-id="757a8-175">App VM routes all HTTP traffic bound for the public Internet through Proxy VM.</span></span>
* <span data-ttu-id="757a8-176">La máquina virtual de proxy permite el tráfico entrante de máquinas virtuales en la red virtual.</span><span class="sxs-lookup"><span data-stu-id="757a8-176">Proxy VM allows incoming traffic from VMs in the virtual network.</span></span>
* <span data-ttu-id="757a8-177">El grupo de seguridad de red (NSG) llamado NSF-lockdown necesita una regla de seguridad que permita el tráfico de Internet saliente de la máquina virtual de proxy.</span><span class="sxs-lookup"><span data-stu-id="757a8-177">The Network Security Group (NSG) named NSF-lockdown needs a security rule allowing outbound Internet traffic from Proxy VM.</span></span>

![Grupo de seguridad de red con el diagrama de implementación de proxy HTTP](./media/backup-azure-vms-prepare/nsg-with-http-proxy.png)

<span data-ttu-id="757a8-179">Para usar a un proxy HTTP para la comunicación con la red pública de Internet, siga estos pasos:</span><span class="sxs-lookup"><span data-stu-id="757a8-179">To use an HTTP proxy to communicating to the public Internet, follow these steps:</span></span>

#### <a name="step-1-configure-outgoing-network-connections"></a><span data-ttu-id="757a8-180">Paso 1.</span><span class="sxs-lookup"><span data-stu-id="757a8-180">Step 1.</span></span> <span data-ttu-id="757a8-181">Configuración de las conexiones de red salientes</span><span class="sxs-lookup"><span data-stu-id="757a8-181">Configure outgoing network connections</span></span>
###### <a name="for-windows-machines"></a><span data-ttu-id="757a8-182">Para máquinas Windows</span><span class="sxs-lookup"><span data-stu-id="757a8-182">For Windows machines</span></span>
<span data-ttu-id="757a8-183">En este paso se configura el servidor proxy para la cuenta de sistema local.</span><span class="sxs-lookup"><span data-stu-id="757a8-183">This will setup proxy server configuration for Local System Account.</span></span>

1. <span data-ttu-id="757a8-184">Descargue [PsExec](https://technet.microsoft.com/sysinternals/bb897553)</span><span class="sxs-lookup"><span data-stu-id="757a8-184">Download [PsExec](https://technet.microsoft.com/sysinternals/bb897553)</span></span>
2. <span data-ttu-id="757a8-185">Ejecute el comando siguiente desde un símbolo del sistema con privilegios elevados.</span><span class="sxs-lookup"><span data-stu-id="757a8-185">Run following command from elevated prompt,</span></span>

     ```
     psexec -i -s "c:\Program Files\Internet Explorer\iexplore.exe"
     ```
     <span data-ttu-id="757a8-186">Se abrirá la ventana de Internet Explorer.</span><span class="sxs-lookup"><span data-stu-id="757a8-186">It will open internet explorer window.</span></span>
3. <span data-ttu-id="757a8-187">Vaya a Herramientas -> Opciones de Internet -> Conexiones -> Configuración de LAN.</span><span class="sxs-lookup"><span data-stu-id="757a8-187">Go to Tools -> Internet Options -> Connections -> LAN settings.</span></span>
4. <span data-ttu-id="757a8-188">Compruebe la configuración de proxy de la cuenta del sistema.</span><span class="sxs-lookup"><span data-stu-id="757a8-188">Verify proxy settings for System account.</span></span> <span data-ttu-id="757a8-189">Configure la dirección IP de proxy y el puerto.</span><span class="sxs-lookup"><span data-stu-id="757a8-189">Set Proxy IP and port.</span></span>
5. <span data-ttu-id="757a8-190">Cierre Internet Explorer.</span><span class="sxs-lookup"><span data-stu-id="757a8-190">Close Internet Explorer.</span></span>

<span data-ttu-id="757a8-191">Se configurará el proxy en todo el equipo y se usará para el tráfico saliente de HTTP/HTTPS.</span><span class="sxs-lookup"><span data-stu-id="757a8-191">This will set up a machine-wide proxy configuration, and will be used for any outgoing HTTP/HTTPS traffic.</span></span>

<span data-ttu-id="757a8-192">Si ha configurado un servidor proxy en una cuenta de usuario actual (no en una cuenta de sistema local), use el siguiente script para aplicarlo a SYSTEMACCOUNT:</span><span class="sxs-lookup"><span data-stu-id="757a8-192">If you have setup a proxy server on a current user account(not a Local System Account), use the following script to apply them to SYSTEMACCOUNT:</span></span>

```
   $obj = Get-ItemProperty -Path Registry::”HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections"
   Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections" -Name DefaultConnectionSettings -Value $obj.DefaultConnectionSettings
   Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections" -Name SavedLegacySettings -Value $obj.SavedLegacySettings
   $obj = Get-ItemProperty -Path Registry::”HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings"
   Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings" -Name ProxyEnable -Value $obj.ProxyEnable
   Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings" -Name Proxyserver -Value $obj.Proxyserver
```

> [!NOTE]
> <span data-ttu-id="757a8-193">Si ve el mensaje "(407) Se requiere autenticación del proxy" en el registro del servidor proxy, compruebe que su autenticación está configurada correctamente.</span><span class="sxs-lookup"><span data-stu-id="757a8-193">If you observe "(407)Proxy Authentication Required" in proxy server log, check your authentication is setup correctly.</span></span>
>
>

###### <a name="for-linux-machines"></a><span data-ttu-id="757a8-194">Para máquinas Linux</span><span class="sxs-lookup"><span data-stu-id="757a8-194">For Linux machines</span></span>
<span data-ttu-id="757a8-195">Agregue la siguiente línea al archivo ```/etc/environment``` :</span><span class="sxs-lookup"><span data-stu-id="757a8-195">Add the following line to the ```/etc/environment``` file:</span></span>

```
http_proxy=http://<proxy IP>:<proxy port>
```

<span data-ttu-id="757a8-196">Agregue las líneas siguientes al archivo ```/etc/waagent.conf```:</span><span class="sxs-lookup"><span data-stu-id="757a8-196">Add the following lines to the ```/etc/waagent.conf``` file:</span></span>

```
HttpProxy.Host=<proxy IP>
HttpProxy.Port=<proxy port>
```

#### <a name="step-2-allow-incoming-connections-on-the-proxy-server"></a><span data-ttu-id="757a8-197">Paso 2:</span><span class="sxs-lookup"><span data-stu-id="757a8-197">Step 2.</span></span> <span data-ttu-id="757a8-198">Aceptación de conexiones entrantes en el servidor proxy:</span><span class="sxs-lookup"><span data-stu-id="757a8-198">Allow incoming connections on the proxy server:</span></span>
1. <span data-ttu-id="757a8-199">En el servidor proxy, abra Firewall de Windows.</span><span class="sxs-lookup"><span data-stu-id="757a8-199">On the proxy server, open Windows Firewall.</span></span> <span data-ttu-id="757a8-200">La manera más fácil de acceder al firewall es buscar Firewall de Windows con seguridad avanzada.</span><span class="sxs-lookup"><span data-stu-id="757a8-200">The easiest way to access the firewall is to search for Windows Firewall with Advanced Security.</span></span>

    ![Abrir el firewall](./media/backup-azure-vms-prepare/firewall-01.png)
2. <span data-ttu-id="757a8-202">En el cuadro de diálogo Firewall de Windows, haga clic con el botón derecho en **Reglas de entrada** y haga clic en **Nueva regla...**.</span><span class="sxs-lookup"><span data-stu-id="757a8-202">In the Windows Firewall dialog, right-click  **Inbound Rules** and click **New Rule...**.</span></span>

    ![Crear una nueva regla](./media/backup-azure-vms-prepare/firewall-02.png)
3. <span data-ttu-id="757a8-204">En **Asistente para nueva regla de entrada**, elija la opción **Personalizada** para el **Tipo de regla** y haga clic en **Siguiente**.</span><span class="sxs-lookup"><span data-stu-id="757a8-204">In the **New Inbound Rule Wizard**, choose the **Custom** option for the **Rule Type** and click **Next**.</span></span>
4. <span data-ttu-id="757a8-205">En la pantalla para seleccionar el **programa**, elija **Todos los programas** y haga clic en **Siguiente**.</span><span class="sxs-lookup"><span data-stu-id="757a8-205">On the page to select the **Program**, choose **All Programs** and click **Next**.</span></span>
5. <span data-ttu-id="757a8-206">En la página **Protocolo y puertos**, escriba la información siguiente y haga clic en **Siguiente**:</span><span class="sxs-lookup"><span data-stu-id="757a8-206">On the **Protocol and Ports** page, enter the following information and click **Next**:</span></span>

    ![Crear una nueva regla](./media/backup-azure-vms-prepare/firewall-03.png)

   * <span data-ttu-id="757a8-208">en *Tipo de protocolo*, elija *TCP*.</span><span class="sxs-lookup"><span data-stu-id="757a8-208">for *Protocol type* choose *TCP*</span></span>
   * <span data-ttu-id="757a8-209">En *Puerto Local*, elija *Puertos específicos* y, en el campo siguiente, especifique el valor de ```<Proxy Port>``` configurado.</span><span class="sxs-lookup"><span data-stu-id="757a8-209">for *Local port* choose *Specific Ports*, in the field below specify the ```<Proxy Port>``` that has been configured.</span></span>
   * <span data-ttu-id="757a8-210">En *Puerto remoto*, seleccione *Todos los puertos*.</span><span class="sxs-lookup"><span data-stu-id="757a8-210">for *Remote port* select *All Ports*</span></span>

     <span data-ttu-id="757a8-211">Durante el resto del asistente, haga clic en todas las pantallas hasta el final y asigne un nombre a esta regla.</span><span class="sxs-lookup"><span data-stu-id="757a8-211">For the rest of the wizard, click all the way to the end and give this rule a name.</span></span>

#### <a name="step-3-add-an-exception-rule-to-the-nsg"></a><span data-ttu-id="757a8-212">Paso 3:</span><span class="sxs-lookup"><span data-stu-id="757a8-212">Step 3.</span></span> <span data-ttu-id="757a8-213">Adición de una regla de excepción al grupo de seguridad de red</span><span class="sxs-lookup"><span data-stu-id="757a8-213">Add an exception rule to the NSG:</span></span>
<span data-ttu-id="757a8-214">En un símbolo del sistema de Azure PowerShell, escriba el siguiente comando:</span><span class="sxs-lookup"><span data-stu-id="757a8-214">In an Azure PowerShell command prompt, enter the following command:</span></span>

<span data-ttu-id="757a8-215">El siguiente comando agrega una excepción al NSG.</span><span class="sxs-lookup"><span data-stu-id="757a8-215">The following command adds an exception to the NSG.</span></span> <span data-ttu-id="757a8-216">Esta excepción permite el tráfico TCP de cualquier puerto en la dirección IP 10.0.0.5 a cualquier dirección de Internet en el puerto 80 (HTTP) o 443 (HTTPS).</span><span class="sxs-lookup"><span data-stu-id="757a8-216">This exception allows TCP traffic from any port on 10.0.0.5 to any Internet address on port 80 (HTTP) or 443 (HTTPS).</span></span> <span data-ttu-id="757a8-217">Si necesita un puerto específico en la red pública de Internet, asegúrese de agregarlo también a ```-DestinationPortRange``` .</span><span class="sxs-lookup"><span data-stu-id="757a8-217">If you require a specific port in the public Internet, be sure to add that port to the ```-DestinationPortRange``` as well.</span></span>

```
Get-AzureNetworkSecurityGroup -Name "NSG-lockdown" |
Set-AzureNetworkSecurityRule -Name "allow-proxy " -Action Allow -Protocol TCP -Type Outbound -Priority 200 -SourceAddressPrefix "10.0.0.5/32" -SourcePortRange "*" -DestinationAddressPrefix Internet -DestinationPortRange "80-443"
```

<span data-ttu-id="757a8-218">*Asegúrese de sustituir los nombres en el ejemplo con los detalles correspondientes a la implementación.*</span><span class="sxs-lookup"><span data-stu-id="757a8-218">*Ensure that you replace the names in the example with the details appropriate to your deployment.*</span></span>

## <a name="vm-agent"></a><span data-ttu-id="757a8-219">Agente de máquina virtual</span><span class="sxs-lookup"><span data-stu-id="757a8-219">VM agent</span></span>
<span data-ttu-id="757a8-220">Antes de empezar a realizar la copia de seguridad de la máquina virtual de Azure, asegúrese de que el agente de máquina virtual de Azure esté instalado correctamente en la máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="757a8-220">Before you can back up the Azure virtual machine, you should ensure that the Azure VM agent is correctly installed on the virtual machine.</span></span> <span data-ttu-id="757a8-221">Como el agente de máquina virtual es un componente opcional en el momento de crearse la máquina virtual, asegúrese de que la casilla correspondiente al agente de máquina virtual esté activada antes de aprovisionar la máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="757a8-221">Since the VM agent is an optional component at the time that the virtual machine is created, ensure that the check box for the VM agent is selected before the virtual machine is provisioned.</span></span>

### <a name="manual-installation-and-update"></a><span data-ttu-id="757a8-222">Instalación manual y actualización</span><span class="sxs-lookup"><span data-stu-id="757a8-222">Manual installation and update</span></span>
<span data-ttu-id="757a8-223">El agente de la máquina virtual ya está presente en las máquinas virtuales que se crean desde la Galería de Azure.</span><span class="sxs-lookup"><span data-stu-id="757a8-223">The VM agent is already present in VMs that are created from the Azure gallery.</span></span> <span data-ttu-id="757a8-224">Sin embargo, las máquinas virtuales que se migran desde los centros de datos locales no tienen instalado el agente de la máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="757a8-224">However, virtual machines that are migrated from on-premises datacenters would not have the VM agent installed.</span></span> <span data-ttu-id="757a8-225">Para dichas máquinas virtuales, el agente de la máquina virtual debe instalarse explícitamente.</span><span class="sxs-lookup"><span data-stu-id="757a8-225">For such VMs, the VM agent needs to be installed explicitly.</span></span> <span data-ttu-id="757a8-226">Lea más sobre cómo [instalar el agente de la máquina virtual en una máquina virtual existente](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx).</span><span class="sxs-lookup"><span data-stu-id="757a8-226">Read more about [installing the VM agent on an existing VM](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx).</span></span>

| <span data-ttu-id="757a8-227">**Operación**</span><span class="sxs-lookup"><span data-stu-id="757a8-227">**Operation**</span></span> | <span data-ttu-id="757a8-228">**Windows**</span><span class="sxs-lookup"><span data-stu-id="757a8-228">**Windows**</span></span> | <span data-ttu-id="757a8-229">**Linux**</span><span class="sxs-lookup"><span data-stu-id="757a8-229">**Linux**</span></span> |
| --- | --- | --- |
| <span data-ttu-id="757a8-230">Instalación del agente de la máquina virtual</span><span class="sxs-lookup"><span data-stu-id="757a8-230">Installing the VM agent</span></span> |<li><span data-ttu-id="757a8-231">Descargue e instale el [MSI del agente](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409).</span><span class="sxs-lookup"><span data-stu-id="757a8-231">Download and install the [agent MSI](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409).</span></span> <span data-ttu-id="757a8-232">Necesitará privilegios de administrador para efectuar la instalación.</span><span class="sxs-lookup"><span data-stu-id="757a8-232">You will need Administrator privileges to complete the installation.</span></span> <li><span data-ttu-id="757a8-233">[Actualice la propiedad de la máquina virtual](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx) para indicar que el agente está instalado.</span><span class="sxs-lookup"><span data-stu-id="757a8-233">[Update the VM property](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx) to indicate that the agent is installed.</span></span> |<li> <span data-ttu-id="757a8-234">Instale el [agente de Linux](https://github.com/Azure/WALinuxAgent) más reciente desde GitHub.</span><span class="sxs-lookup"><span data-stu-id="757a8-234">Install the latest [Linux agent](https://github.com/Azure/WALinuxAgent) from GitHub.</span></span> <span data-ttu-id="757a8-235">Necesitará privilegios de administrador para efectuar la instalación.</span><span class="sxs-lookup"><span data-stu-id="757a8-235">You will need Administrator privileges to complete the installation.</span></span> <li> <span data-ttu-id="757a8-236">[Actualice la propiedad de la máquina virtual](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx) para indicar que el agente está instalado.</span><span class="sxs-lookup"><span data-stu-id="757a8-236">[Update the VM property](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx) to indicate that the agent is installed.</span></span> |
| <span data-ttu-id="757a8-237">Actualización del agente de la máquina virtual</span><span class="sxs-lookup"><span data-stu-id="757a8-237">Updating the VM agent</span></span> |<span data-ttu-id="757a8-238">Actualizar el agente de la máquina virtual es tan sencillo como volver a instalar los [archivos binarios del agente de la máquina virtual](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409).</span><span class="sxs-lookup"><span data-stu-id="757a8-238">Updating the VM agent is as simple as reinstalling the [VM agent binaries](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409).</span></span> <br><br><span data-ttu-id="757a8-239">Asegúrese de que no se está ejecutando ninguna operación de copia de seguridad mientras se actualiza el agente de la máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="757a8-239">Ensure that no backup operation is running while the VM agent is being updated.</span></span> |<span data-ttu-id="757a8-240">Siga las instrucciones para [actualizar el agente de máquina virtual Linux ](../virtual-machines/linux/update-agent.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).</span><span class="sxs-lookup"><span data-stu-id="757a8-240">Follow the instructions on [updating the Linux VM agent ](../virtual-machines/linux/update-agent.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).</span></span> <br><br><span data-ttu-id="757a8-241">Asegúrese de que no se está ejecutando ninguna operación de copia de seguridad mientras se actualiza el agente de la máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="757a8-241">Ensure that no backup operation is running while the VM agent is being updated.</span></span> |
| <span data-ttu-id="757a8-242">Validación de la instalación del agente de máquina virtual</span><span class="sxs-lookup"><span data-stu-id="757a8-242">Validating the VM agent installation</span></span> |<li><span data-ttu-id="757a8-243">Acceda a la carpeta *C:\WindowsAzure\Packages* de la máquina virtual de Azure.</span><span class="sxs-lookup"><span data-stu-id="757a8-243">Navigate to the *C:\WindowsAzure\Packages* folder in the Azure VM.</span></span> <li><span data-ttu-id="757a8-244">El archivo WaAppAgent.exe debe estar ahí.</span><span class="sxs-lookup"><span data-stu-id="757a8-244">You should find the WaAppAgent.exe file present.</span></span><li> <span data-ttu-id="757a8-245">Haga clic con el botón derecho en el archivo, desplácese hasta **Propiedades** y seleccione la pestaña **Detalles**.</span><span class="sxs-lookup"><span data-stu-id="757a8-245">Right-click the file, go to **Properties**, and then select the **Details** tab.</span></span> <span data-ttu-id="757a8-246">En el campo de versión del producto, debe aparecer el valor 2.6.1198.718 o uno superior.</span><span class="sxs-lookup"><span data-stu-id="757a8-246">The Product Version field should be 2.6.1198.718 or higher.</span></span> |<span data-ttu-id="757a8-247">N/D</span><span class="sxs-lookup"><span data-stu-id="757a8-247">N/A</span></span> |

<span data-ttu-id="757a8-248">Obtenga información acerca del [agente de máquina virtual](https://go.microsoft.com/fwLink/?LinkID=390493&clcid=0x409) y [cómo instalarlo](https://azure.microsoft.com/blog/2014/04/15/vm-agent-and-extensions-part-2/).</span><span class="sxs-lookup"><span data-stu-id="757a8-248">Learn about the [VM agent](https://go.microsoft.com/fwLink/?LinkID=390493&clcid=0x409) and [how to install it](https://azure.microsoft.com/blog/2014/04/15/vm-agent-and-extensions-part-2/).</span></span>

### <a name="backup-extension"></a><span data-ttu-id="757a8-249">Extensión de Backup</span><span class="sxs-lookup"><span data-stu-id="757a8-249">Backup extension</span></span>
<span data-ttu-id="757a8-250">Para crear la copia de seguridad de la máquina virtual, el servicio Azure Backup instala una extensión al agente de máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="757a8-250">To back up the virtual machine, the Azure Backup service installs an extension to the VM agent.</span></span> <span data-ttu-id="757a8-251">El servicio Azure Backup actualiza y aplica revisiones perfectamente a la extensión de copia de seguridad sin la intervención del usuario.</span><span class="sxs-lookup"><span data-stu-id="757a8-251">The Azure Backup service seamlessly upgrades and patches the backup extension without additional user intervention.</span></span>

<span data-ttu-id="757a8-252">Si se ejecuta la máquina virtual, se instala la extensión de copia de seguridad.</span><span class="sxs-lookup"><span data-stu-id="757a8-252">The backup extension is installed if the VM is running.</span></span> <span data-ttu-id="757a8-253">Una máquina virtual en ejecución también ofrece la mayor probabilidad de obtener un punto de recuperación coherente con la aplicación.</span><span class="sxs-lookup"><span data-stu-id="757a8-253">A running VM also provides the greatest chance of getting an application-consistent recovery point.</span></span> <span data-ttu-id="757a8-254">Sin embargo, el servicio Azure Backup continuará realizando una copia de seguridad de la máquina virtual, incluso si está desactivada y la extensión no se ha podido instalar (lo que se conoce también como máquina virtual sin conexión).</span><span class="sxs-lookup"><span data-stu-id="757a8-254">However, the Azure Backup service will continue to back up the VM--even if it is turned off, and the extension could not be installed (aka Offline VM).</span></span> <span data-ttu-id="757a8-255">En este caso, el punto de recuperación será *coherente frente a bloqueos* , como se explicó anteriormente.</span><span class="sxs-lookup"><span data-stu-id="757a8-255">In this case, the recovery point will be *crash consistent* as discussed above.</span></span>

## <a name="questions"></a><span data-ttu-id="757a8-256">¿Tiene preguntas?</span><span class="sxs-lookup"><span data-stu-id="757a8-256">Questions?</span></span>
<span data-ttu-id="757a8-257">Si tiene alguna pregunta o hay alguna característica que le gustaría que se incluyera, [envíenos sus comentarios](http://aka.ms/azurebackup_feedback).</span><span class="sxs-lookup"><span data-stu-id="757a8-257">If you have questions, or if there is any feature that you would like to see included, [send us feedback](http://aka.ms/azurebackup_feedback).</span></span>

## <a name="next-steps"></a><span data-ttu-id="757a8-258">Pasos siguientes</span><span class="sxs-lookup"><span data-stu-id="757a8-258">Next steps</span></span>
<span data-ttu-id="757a8-259">Ahora que ha preparado el entorno para realizar la copia de seguridad de la máquina virtual, el siguiente paso lógico es crear una copia de seguridad.</span><span class="sxs-lookup"><span data-stu-id="757a8-259">Now that you have prepared your environment for backing up your VM, your next logical step is to create a backup.</span></span> <span data-ttu-id="757a8-260">El artículo de planeamiento ofrece información más detallada sobre la realización de copias de seguridad de máquinas virtuales.</span><span class="sxs-lookup"><span data-stu-id="757a8-260">The planning article provides more detailed information about backing up VMs.</span></span>

* [<span data-ttu-id="757a8-261">Copia de seguridad de máquinas virtuales</span><span class="sxs-lookup"><span data-stu-id="757a8-261">Back up virtual machines</span></span>](backup-azure-vms.md)
* [<span data-ttu-id="757a8-262">Planeación de la infraestructura de copia de seguridad de máquinas virtuales</span><span class="sxs-lookup"><span data-stu-id="757a8-262">Plan your VM backup infrastructure</span></span>](backup-azure-vms-introduction.md)
* [<span data-ttu-id="757a8-263">Administración de copias de seguridad de máquinas virtuales</span><span class="sxs-lookup"><span data-stu-id="757a8-263">Manage virtual machine backups</span></span>](backup-azure-manage-vms.md)
