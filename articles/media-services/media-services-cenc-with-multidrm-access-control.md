---
title: "CENC con varios DRM y Access Control: diseño e implementación de referencia en Azure y Azure Media Services | Microsoft Docs"
description: "Más información sobre cómo obtener licencias de Microsoft® Smooth Streaming Client Porting Kit."
services: media-services
documentationcenter: 
author: willzhan
manager: cfowler
editor: 
ms.assetid: 7814739b-cea9-4b9b-8370-538702e5c615
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/19/2017
ms.author: willzhan;kilroyh;yanmf;juliako
ms.openlocfilehash: 730917b6859f8dbd800ef2cb141062f45d7779ac
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 08/29/2017
---
# <a name="cenc-with-multi-drm-and-access-control-a-reference-design-and-implementation-on-azure-and-azure-media-services"></a><span data-ttu-id="8a2ae-103">CENC con varios DRM y control de acceso: diseño e implementación de referencia en Azure y Servicios multimedia de Azure</span><span class="sxs-lookup"><span data-stu-id="8a2ae-103">CENC with Multi-DRM and Access Control: A Reference Design and Implementation on Azure and Azure Media Services</span></span>
 
## <a name="introduction"></a><span data-ttu-id="8a2ae-104">Introducción</span><span class="sxs-lookup"><span data-stu-id="8a2ae-104">Introduction</span></span>
<span data-ttu-id="8a2ae-105">Es bien sabido que diseñar y compilar un subsistema DRM para una solución de streaming en línea u OTT es una tarea compleja.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-105">It is well known that it is a complex task to design and build a DRM subsystem for an OTT or online streaming solution.</span></span> <span data-ttu-id="8a2ae-106">Y una práctica común de los operadores o proveedores de vídeo en línea es subcontratar esta parte a proveedores de servicios DRM especializados.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-106">And it is a common practice for operators/online video providers to outsource this part to specialized DRM service providers.</span></span> <span data-ttu-id="8a2ae-107">El objetivo de este documento es presentar un diseño de referencia y la implementación del subsistema DRM de extremo a extremo en una solución de streaming en línea o de OTT.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-107">The goal of this document is to present a reference design and implementation of end-to-end DRM subsystem in OTT or online streaming solution.</span></span>

<span data-ttu-id="8a2ae-108">Este documento va dirigido a ingenieros que trabajan en el subsistema DRM de soluciones OTT o soluciones de varias pantallas o streaming en línea, o a cualquier lector interesado en el subsistema DRM.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-108">The targeted readers of this document are engineers working in DRM subsystem of OTT or online streaming/multi-screen solutions, or any readers interested in DRM subsystem.</span></span> <span data-ttu-id="8a2ae-109">Se supone que los lectores están familiarizados con al menos una de las tecnologías DRM del mercado, como PlayReady, Widevine, FairPlay o Adobe Access.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-109">The assumption is that readers are familiar with at least one of the DRM technologies on the market, such as PlayReady, Widevine, FairPlay or Adobe Access.</span></span>

<span data-ttu-id="8a2ae-110">En el término DRM, también incluimos CENC (Cifrado común) con varios DRM.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-110">By DRM, we also include CENC (Common Encryption) with multi-DRM.</span></span> <span data-ttu-id="8a2ae-111">Una de las principales tendencias en el sector de OTT y del streaming en línea es el uso de CENC con varios DRM nativos en distintas plataformas cliente, lo que supone un cambio desde la tendencia anterior de uso de un solo DRM y su SDK cliente.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-111">A major trend in online streaming and OTT industry is to use CENC with multi-native-DRM on various client platforms, which is a shift from the previous trend of using a single DRM and its client SDK for various client platforms.</span></span> <span data-ttu-id="8a2ae-112">Cuando se utiliza CENC con varios DRM nativos, tanto PlayReady como Widevine se cifran según la especificación [Cifrado común (ISO/IEC 23001-7 CENC)](http://www.iso.org/iso/home/store/catalogue_ics/catalogue_detail_ics.htm?csnumber=65271/) .</span><span class="sxs-lookup"><span data-stu-id="8a2ae-112">When using CENC with multi-native-DRM, both PlayReady and Widevine are encrypted per the [Common Encryption (ISO/IEC 23001-7 CENC)](http://www.iso.org/iso/home/store/catalogue_ics/catalogue_detail_ics.htm?csnumber=65271/) specification.</span></span>

<span data-ttu-id="8a2ae-113">Las ventajas de CENC con varios DRM son las siguientes:</span><span class="sxs-lookup"><span data-stu-id="8a2ae-113">The benefits of CENC with multi-DRM are as follows:</span></span>

1. <span data-ttu-id="8a2ae-114">Reduce el costo del cifrado puesto que se emplea un solo procesamiento de cifrado que tiene como destino distintas plataformas con sus DRM nativos.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-114">Reduces encryption cost since a single encryption processing is used targeting different platforms with its native DRMs;</span></span>
2. <span data-ttu-id="8a2ae-115">Reduce el costo de administrar los activos cifrados dado que solo se necesita una copia de ellos.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-115">Reduces the cost of managing encrypted assets since only a single copy of encrypted assets is needed;</span></span>
3. <span data-ttu-id="8a2ae-116">Elimina el costo de licencia de clientes DRM dado que el cliente DRM nativo suele ser gratuito en su plataforma nativa.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-116">Eliminates DRM client licensing cost since the native DRM client is usually free on its native platform.</span></span>

<span data-ttu-id="8a2ae-117">Microsoft ha sido un promotor activo de DASH y CENC junto con algunos de los principales reproductores del sector.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-117">Microsoft has been an active promoter of DASH and CENC together with some major industry players.</span></span> <span data-ttu-id="8a2ae-118">Servicios multimedia de Microsoft Azure ha estado ofreciendo soporte técnico para DASH y CENC.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-118">Microsoft Azure Media Services has been providing support of DASH and CENC.</span></span> <span data-ttu-id="8a2ae-119">Para conocer los anuncios recientes, consulte los blogs de Mingfei: [Announcing Google Widevine license delivery services in Azure Media Services](https://azure.microsoft.com/blog/announcing-general-availability-of-google-widevine-license-services/) (Anuncio de los servicios de entrega de licencias de Google Widevine) y [Azure Media Services adds Google Widevine packaging for delivering multi-DRM stream](https://azure.microsoft.com/blog/azure-media-services-adds-google-widevine-packaging-for-delivering-multi-drm-stream/) (Azure Media Services agregan el paquete Google Widevine para la entrega de transmisiones de varios DRM).</span><span class="sxs-lookup"><span data-stu-id="8a2ae-119">For recent announcements, please see Mingfei’s blogs: [Announcing Google Widevine license delivery services in Azure Media Services](https://azure.microsoft.com/blog/announcing-general-availability-of-google-widevine-license-services/), and [Azure Media Services adds Google Widevine packaging for delivering multi-DRM stream](https://azure.microsoft.com/blog/azure-media-services-adds-google-widevine-packaging-for-delivering-multi-drm-stream/).</span></span>  

### <a name="overview-of-this-article"></a><span data-ttu-id="8a2ae-120">Información general de este artículo</span><span class="sxs-lookup"><span data-stu-id="8a2ae-120">Overview of this article</span></span>
<span data-ttu-id="8a2ae-121">Este artículo se ha escrito teniendo en mente los siguientes objetivos:</span><span class="sxs-lookup"><span data-stu-id="8a2ae-121">The goal of this article includes the following:</span></span>

1. <span data-ttu-id="8a2ae-122">Proporcionar un diseño de referencia del subsistema DRM mediante CENC con varios DRM.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-122">Provides a reference design of DRM subsystem using CENC with multi-DRM;</span></span>
2. <span data-ttu-id="8a2ae-123">Proporcionar una implementación de referencia en la plataforma de Servicios multimedia de Azure o Microsoft Azure.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-123">Provides a reference implementation on Microsoft Azure/Azure Media Services platform;</span></span>
3. <span data-ttu-id="8a2ae-124">Describir algunos temas de diseño e implementación.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-124">Discusses some design and implementation topics.</span></span>

<span data-ttu-id="8a2ae-125">En este artículo, cuando hablamos de "varios DRM" hacemos referencia a:</span><span class="sxs-lookup"><span data-stu-id="8a2ae-125">In the article, “multi-DRM” covers the following:</span></span>

1. <span data-ttu-id="8a2ae-126">Microsoft PlayReady</span><span class="sxs-lookup"><span data-stu-id="8a2ae-126">Microsoft PlayReady</span></span>
2. <span data-ttu-id="8a2ae-127">Google Widevine</span><span class="sxs-lookup"><span data-stu-id="8a2ae-127">Google Widevine</span></span>
3. <span data-ttu-id="8a2ae-128">Apple FairPlay</span><span class="sxs-lookup"><span data-stu-id="8a2ae-128">Apple FairPlay</span></span> 

<span data-ttu-id="8a2ae-129">En la tabla siguiente se resume la aplicación o plataforma nativa y los exploradores que admite cada DRM.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-129">The following table summarizes the native platform/native app, and browsers supported by each DRM.</span></span>

| <span data-ttu-id="8a2ae-130">**Plataforma de cliente**</span><span class="sxs-lookup"><span data-stu-id="8a2ae-130">**Client Platform**</span></span> | <span data-ttu-id="8a2ae-131">**Compatibilidad con DRM nativo**</span><span class="sxs-lookup"><span data-stu-id="8a2ae-131">**Native DRM Support**</span></span> | <span data-ttu-id="8a2ae-132">**Explorador/aplicación**</span><span class="sxs-lookup"><span data-stu-id="8a2ae-132">**Browser/App**</span></span> | <span data-ttu-id="8a2ae-133">**Formatos de streaming**</span><span class="sxs-lookup"><span data-stu-id="8a2ae-133">**Streaming Formats**</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="8a2ae-134">**Televisores inteligentes, operador STB, OTT STB**</span><span class="sxs-lookup"><span data-stu-id="8a2ae-134">**Smart TVs, operator STBs, OTT STBs**</span></span> |<span data-ttu-id="8a2ae-135">PlayReady principalmente o Widevine u otros</span><span class="sxs-lookup"><span data-stu-id="8a2ae-135">PlayReady primarily, and/or Widevine, and/or other</span></span> |<span data-ttu-id="8a2ae-136">Linux, Opera y WebKit, otros</span><span class="sxs-lookup"><span data-stu-id="8a2ae-136">Linux, Opera, WebKit, Other</span></span> |<span data-ttu-id="8a2ae-137">Varios formatos</span><span class="sxs-lookup"><span data-stu-id="8a2ae-137">Various formats</span></span> |
| <span data-ttu-id="8a2ae-138">**Dispositivos Windows 10 (Windows PC, tabletas de Windows, Windows Phone, Xbox)**</span><span class="sxs-lookup"><span data-stu-id="8a2ae-138">**Windows 10 devices (Windows PC, Windows Tablets, Windows Phone, Xbox)**</span></span> |<span data-ttu-id="8a2ae-139">PlayReady</span><span class="sxs-lookup"><span data-stu-id="8a2ae-139">PlayReady</span></span> |<span data-ttu-id="8a2ae-140">MS Edge/IE11/EME</span><span class="sxs-lookup"><span data-stu-id="8a2ae-140">MS Edge/IE11/EME</span></span><br/><br/><br/><span data-ttu-id="8a2ae-141">UWP</span><span class="sxs-lookup"><span data-stu-id="8a2ae-141">UWP</span></span> |<span data-ttu-id="8a2ae-142">DASH (no se admite PlayReady para HLS)</span><span class="sxs-lookup"><span data-stu-id="8a2ae-142">DASH (For HLS, PlayReady is not supported)</span></span><br/><br/><span data-ttu-id="8a2ae-143">DASH, Smooth Streaming (no se admite PlayReady para HLS)</span><span class="sxs-lookup"><span data-stu-id="8a2ae-143">DASH, Smooth Streaming (For HLS, PlayReady is not supported)</span></span> |
| <span data-ttu-id="8a2ae-144">**Dispositivos Android (teléfono, tableta, TV)**</span><span class="sxs-lookup"><span data-stu-id="8a2ae-144">**Android devices (Phone, Tablet, TV)**</span></span> |<span data-ttu-id="8a2ae-145">Widevine</span><span class="sxs-lookup"><span data-stu-id="8a2ae-145">Widevine</span></span> |<span data-ttu-id="8a2ae-146">Chrome/EME</span><span class="sxs-lookup"><span data-stu-id="8a2ae-146">Chrome/EME</span></span> |<span data-ttu-id="8a2ae-147">DASH, HLS</span><span class="sxs-lookup"><span data-stu-id="8a2ae-147">DASH,HLS</span></span> |
| <span data-ttu-id="8a2ae-148">**iOS (iPhone, iPad), clientes de OS X y Apple TV**</span><span class="sxs-lookup"><span data-stu-id="8a2ae-148">**iOS (iPhone, iPad), OS X clients and Apple TV**</span></span> |<span data-ttu-id="8a2ae-149">FairPlay</span><span class="sxs-lookup"><span data-stu-id="8a2ae-149">FairPlay</span></span> |<span data-ttu-id="8a2ae-150">Safari 8+/EME</span><span class="sxs-lookup"><span data-stu-id="8a2ae-150">Safari 8+/EME</span></span> |<span data-ttu-id="8a2ae-151">HLS</span><span class="sxs-lookup"><span data-stu-id="8a2ae-151">HLS</span></span> |


<span data-ttu-id="8a2ae-152">Teniendo en cuenta el estado actual de implementación para cada DRM, normalmente el servicio querrá implementar dos o tres DRM para asegurarse de que aborda todos los tipos de puntos de conexión de la mejor manera.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-152">Considering the current state of deployment for each DRM, a service will typically want to implement 2 or 3 DRMs to make sure you address all the types of endpoints in the best way.</span></span>

<span data-ttu-id="8a2ae-153">Hay un equilibrio entre la complejidad de la lógica del servicio y la complejidad del cliente para alcanzar un determinado nivel de experiencia del usuario en los distintos clientes.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-153">There is a tradeoff between the complexity of the service logic and the complexity on the client side to reach a certain level of user experience on the various clients.</span></span>

<span data-ttu-id="8a2ae-154">Para realizar la selección, tenga en cuenta lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="8a2ae-154">To make your selection, keep in mind these facts:</span></span>

* <span data-ttu-id="8a2ae-155">PlayReady se implementa de forma nativa en cada dispositivo de Windows, en algunos dispositivos Android y está disponibles a través de SDK de software en prácticamente cualquier plataforma.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-155">PlayReady is natively implemented in every Windows device, on some Android devices, and available through software SDKs on virtually any platform</span></span>
* <span data-ttu-id="8a2ae-156">Widevine se implementa de forma nativa en todos los dispositivos Android, en Chrome y algunos otros dispositivos.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-156">Widevine is natively implemented in every Android device, in Chrome, and in some other devices</span></span>
* <span data-ttu-id="8a2ae-157">FairPlay solo está disponible en clientes iOS y Mac OS o a través de iTunes.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-157">FairPlay is available only on iOS and Mac OS clients or through iTunes.</span></span>

<span data-ttu-id="8a2ae-158">Por tanto un multi-DRM típico sería:</span><span class="sxs-lookup"><span data-stu-id="8a2ae-158">So a typical multi-DRM would be:</span></span>

* <span data-ttu-id="8a2ae-159">Opción 1: PlayReady y Widevine</span><span class="sxs-lookup"><span data-stu-id="8a2ae-159">Option 1: PlayReady and Widevine</span></span>
* <span data-ttu-id="8a2ae-160">Opción 2: PlayReady, Widevine y FairPlay</span><span class="sxs-lookup"><span data-stu-id="8a2ae-160">Option 2: PlayReady, Widevine and FairPlay</span></span>

## <a name="a-reference-design"></a><span data-ttu-id="8a2ae-161">Un diseño de referencia</span><span class="sxs-lookup"><span data-stu-id="8a2ae-161">A reference design</span></span>
<span data-ttu-id="8a2ae-162">En esta sección, presentamos un diseño de referencia que es independiente de las tecnologías usadas para implementarlo.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-162">In this section, we will present a reference design which is agnostic to technologies used to implement it.</span></span>

<span data-ttu-id="8a2ae-163">Un subsistema DRM puede contener los siguientes componentes:</span><span class="sxs-lookup"><span data-stu-id="8a2ae-163">A DRM subsystem may contain the following components:</span></span>

1. <span data-ttu-id="8a2ae-164">Administración de claves</span><span class="sxs-lookup"><span data-stu-id="8a2ae-164">Key management</span></span>
2. <span data-ttu-id="8a2ae-165">Empaquetado de DRM</span><span class="sxs-lookup"><span data-stu-id="8a2ae-165">DRM packaging</span></span>
3. <span data-ttu-id="8a2ae-166">Entrega de licencias DRM</span><span class="sxs-lookup"><span data-stu-id="8a2ae-166">DRM license delivery</span></span>
4. <span data-ttu-id="8a2ae-167">Comprobación de derechos</span><span class="sxs-lookup"><span data-stu-id="8a2ae-167">Entitlement check</span></span>
5. <span data-ttu-id="8a2ae-168">Autenticación y autorización</span><span class="sxs-lookup"><span data-stu-id="8a2ae-168">Authentication/authorization</span></span>
6. <span data-ttu-id="8a2ae-169">Reproductor</span><span class="sxs-lookup"><span data-stu-id="8a2ae-169">Player</span></span>
7. <span data-ttu-id="8a2ae-170">Origen y CDN</span><span class="sxs-lookup"><span data-stu-id="8a2ae-170">Origin/CDN</span></span>

<span data-ttu-id="8a2ae-171">El siguiente diagrama ilustra la interacción de alto nivel entre los componentes de un subsistema DRM.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-171">The following diagram illustrates the high level interaction among the components in a DRM subsystem.</span></span>

![Subsistema DRM con CENC](./media/media-services-cenc-with-multidrm-access-control/media-services-generic-drm-subsystem-with-cenc.png)

<span data-ttu-id="8a2ae-173">Existen tres "capas" básicas en el diseño:</span><span class="sxs-lookup"><span data-stu-id="8a2ae-173">There are three basic “layers” in the design:</span></span>

1. <span data-ttu-id="8a2ae-174">Capa de área de operaciones (en negro), que no se expone externamente.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-174">Back office layer (in black) which are not exposed externally;</span></span>
2. <span data-ttu-id="8a2ae-175">Capa de "red perimetral" (azul), que contiene todos los puntos de conexión de cara al público.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-175">“DMZ” layer (blue) containing all the endpoints facing public;</span></span>
3. <span data-ttu-id="8a2ae-176">Capa de Internet pública (azul claro), que contiene la CDN y los reproductores con el tráfico que atraviesa la Internet pública.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-176">Public Internet layer (light blue) containing CDN and players with traffic across public Internet.</span></span>

<span data-ttu-id="8a2ae-177">Debe haber una herramienta de administración del contenido para controlar la protección DRM, con independencia de que el cifrado sea estático o dinámico.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-177">There should be a content management tool for controlling DRM protection, regardless it is static or dynamic encryption.</span></span> <span data-ttu-id="8a2ae-178">Las entradas del cifrado de DRM deben incluir:</span><span class="sxs-lookup"><span data-stu-id="8a2ae-178">The inputs for DRM encryption should include:</span></span>

1. <span data-ttu-id="8a2ae-179">Contenido de vídeo MBR</span><span class="sxs-lookup"><span data-stu-id="8a2ae-179">MBR video content;</span></span>
2. <span data-ttu-id="8a2ae-180">Clave de contenido</span><span class="sxs-lookup"><span data-stu-id="8a2ae-180">Content key;</span></span>
3. <span data-ttu-id="8a2ae-181">Direcciones URL de adquisición de licencias.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-181">License acquisition URLs.</span></span>

<span data-ttu-id="8a2ae-182">Durante el tiempo de reproducción, el flujo de alto nivel es:</span><span class="sxs-lookup"><span data-stu-id="8a2ae-182">During playback time, the high level flow is:</span></span>

1. <span data-ttu-id="8a2ae-183">El usuario está autenticado.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-183">User is authenticated;</span></span>
2. <span data-ttu-id="8a2ae-184">Se crea el token de autorización para el usuario.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-184">Authorization token is created for the user;</span></span>
3. <span data-ttu-id="8a2ae-185">El contenido protegido con DRM (manifiesto) se descarga en el reproductor.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-185">DRM protected content (manifest) is downloaded to player;</span></span>
4. <span data-ttu-id="8a2ae-186">El reproductor envía la solicitud de adquisición de licencias a los servidores de licencias junto con el identificador de clave y el token de autorización.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-186">Player submits license acquisition request to license servers together with key ID and authorization token.</span></span>

<span data-ttu-id="8a2ae-187">Antes de pasar al tema siguiente, algunas palabras sobre el diseño de la administración de claves.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-187">Before moving to the next topic, a few words about the design of key management.</span></span>

| <span data-ttu-id="8a2ae-188">**Clave de contenido a activo**</span><span class="sxs-lookup"><span data-stu-id="8a2ae-188">**ContentKey–to-Asset**</span></span> | <span data-ttu-id="8a2ae-189">**Escenario**</span><span class="sxs-lookup"><span data-stu-id="8a2ae-189">**Scenario**</span></span> |
| --- | --- |
| <span data-ttu-id="8a2ae-190">1-1</span><span class="sxs-lookup"><span data-stu-id="8a2ae-190">1–to-1</span></span> |<span data-ttu-id="8a2ae-191">El caso más simple.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-191">The simplest case.</span></span> <span data-ttu-id="8a2ae-192">Proporciona el control más específico.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-192">It provides the finest control.</span></span> <span data-ttu-id="8a2ae-193">Sin embargo, el resultado es generalmente un costo más alto en la entrega de licencias.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-193">But this generally results in the highest license delivery cost.</span></span> <span data-ttu-id="8a2ae-194">Se requiere al menos una solicitud de licencia para cada activo protegido.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-194">At minimum one license request is required for each protected asset.</span></span> |
| <span data-ttu-id="8a2ae-195">1 a muchos</span><span class="sxs-lookup"><span data-stu-id="8a2ae-195">1–to-Many</span></span> |<span data-ttu-id="8a2ae-196">Puede utilizar la misma clave de contenido para varios activos.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-196">You could use the same content key for multiple assets.</span></span> <span data-ttu-id="8a2ae-197">Por ejemplo, para todos los activos de un grupo lógico, como un género o un subconjunto del género (o género de película), podría utilizar una única clave de contenido.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-197">For example, for all the assets in a logical group such as a genre or subset of genre (or Movie Gene), you could use a single content key.</span></span> |
| <span data-ttu-id="8a2ae-198">Muchos a 1</span><span class="sxs-lookup"><span data-stu-id="8a2ae-198">Many–to-1</span></span> |<span data-ttu-id="8a2ae-199">Se necesitan varias claves de contenido para cada activo.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-199">Multiple content keys are needed for each asset.</span></span> <br/><br/><span data-ttu-id="8a2ae-200">Por ejemplo, si tiene que aplicar protección CENC dinámica con varios DRM para MPEG-DASH y cifrado AES-128 para HLS, necesitará dos claves de contenido distintas, cada una con su propio valor de ContentKeyType.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-200">For example, if you need to apply dynamic CENC protection with multi-DRM for MPEG-DASH, and dynamic AES-128 encryption for HLS, you need two separate content keys, each with its own ContentKeyType.</span></span> <span data-ttu-id="8a2ae-201">(Para la clave de contenido que se usa en la protección CENC dinámica, se debe utilizar ContentKeyType.CommonEncryption, mientras que para la clave de contenido que se usa en el cifrado AES-128 dinámico, se debe utilizar ContentKeyType.EnvelopeEncryption).</span><span class="sxs-lookup"><span data-stu-id="8a2ae-201">(For the content key used for dynamic CENC protection, ContentKeyType.CommonEncryption should be used, while for the content key used for dynamic AES-128 encryption, ContentKeyType.EnvelopeEncryption should be used.)</span></span><br/><br/><span data-ttu-id="8a2ae-202">Otro ejemplo: en la protección CENC de contenido DASH, en teoría, se puede usar una clave de contenido para proteger la transmisión de vídeo y otra para proteger la transmisión de audio.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-202">Another example, in CENC protection of DASH content, in theory, one content key can be used to protect video stream and another content key to protect audio stream.</span></span> |
| <span data-ttu-id="8a2ae-203">Muchos a muchos</span><span class="sxs-lookup"><span data-stu-id="8a2ae-203">Many – to - Many</span></span> |<span data-ttu-id="8a2ae-204">Combinación de los dos escenarios anteriores: se utiliza un conjunto de claves de contenido para cada uno de los diversos activos del mismo "grupo" de activos.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-204">Combination of the above two scenarios: one set of content keys are used for each of the multiple assets in the same asset “group”.</span></span> |

<span data-ttu-id="8a2ae-205">Otro factor importante a tener en cuenta es el uso de licencias persistentes y no persistentes.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-205">Another important factor to consider is the use of persistent and non-persistent licenses.</span></span>

<span data-ttu-id="8a2ae-206">¿Por qué son importantes estas consideraciones?</span><span class="sxs-lookup"><span data-stu-id="8a2ae-206">Why are these considerations important?</span></span>

<span data-ttu-id="8a2ae-207">Si usa la nube pública para la entrega de licencias, afectan directamente a su costo.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-207">They have direct impact to license delivery cost if you use public cloud for license delivery.</span></span> <span data-ttu-id="8a2ae-208">Para ilustrar esto, pensemos en los dos siguientes casos de diseño diferentes:</span><span class="sxs-lookup"><span data-stu-id="8a2ae-208">Let’s consider the following two different design cases to illustrate:</span></span>

1. <span data-ttu-id="8a2ae-209">Suscripción mensual: utiliza licencias persistentes y la asignación 1 a muchos entre claves de contenido y recursos.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-209">Monthly subscription: Use persistent license, and 1-to-many content key-to-asset mapping.</span></span> <span data-ttu-id="8a2ae-210">Por ejemplo,</span><span class="sxs-lookup"><span data-stu-id="8a2ae-210">E.g.</span></span> <span data-ttu-id="8a2ae-211">para todas las películas de niños, usamos una única clave de contenido para el cifrado.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-211">for all the kids movies, we use a single content key for encryption.</span></span> <span data-ttu-id="8a2ae-212">En este caso:</span><span class="sxs-lookup"><span data-stu-id="8a2ae-212">In this case:</span></span>

    <span data-ttu-id="8a2ae-213">El número total de licencias solicitadas para todas las películas o dispositivos de niños = 1</span><span class="sxs-lookup"><span data-stu-id="8a2ae-213">Total # licenses requested for all kids movies/device = 1</span></span>
2. <span data-ttu-id="8a2ae-214">Suscripción mensual: utiliza licencias no persistentes y asignación 1 a 1 entre claves de contenido y recursos.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-214">Monthly subscription: Use non-persistent license, and 1-to-1 mapping between content key and asset.</span></span> <span data-ttu-id="8a2ae-215">En este caso:</span><span class="sxs-lookup"><span data-stu-id="8a2ae-215">In this case:</span></span>

    <span data-ttu-id="8a2ae-216">El número total de licencias solicitadas para todas las películas o dispositivos de niños =  [n.º de películas vistas] x [n.º de sesiones].</span><span class="sxs-lookup"><span data-stu-id="8a2ae-216">Total # licenses requested for all kids movies/device = [# movies watched] x [# sessions]</span></span>

<span data-ttu-id="8a2ae-217">Como puede ver fácilmente, los dos diseños diferentes dan como resultado patrones de solicitud de licencia muy diferentes, de ahí el costo de entrega de las licencias si el servicio de entrega de licencias se proporciona mediante una nube pública como Servicios multimedia de Azure.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-217">As you can easily see, the two different designs result in very different license request patterns hence license delivery cost if license delivery service is provided by a public cloud such as Azure Media Services.</span></span>

## <a name="mapping-design-to-technology-for-implementation"></a><span data-ttu-id="8a2ae-218">Asignación del diseño a la tecnología para la implementación</span><span class="sxs-lookup"><span data-stu-id="8a2ae-218">Mapping design to technology for implementation</span></span>
<span data-ttu-id="8a2ae-219">A continuación, asignamos nuestro diseño genérico a las tecnologías de la plataforma Microsoft Azure o Servicios multimedia de Azure, para lo cual especificamos la tecnología que queremos usar en cada bloque de creación.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-219">Next, we map our generic design to technologies on Microsoft Azure/Azure Media Services platform, by specifying which technology to use for each building block.</span></span>

<span data-ttu-id="8a2ae-220">En la tabla siguiente se muestra la asignación:</span><span class="sxs-lookup"><span data-stu-id="8a2ae-220">The following table shows the mapping:</span></span>

| <span data-ttu-id="8a2ae-221">**Bloque de creación**</span><span class="sxs-lookup"><span data-stu-id="8a2ae-221">**Building Block**</span></span> | <span data-ttu-id="8a2ae-222">**Technology**</span><span class="sxs-lookup"><span data-stu-id="8a2ae-222">**Technology**</span></span> |
| --- | --- |
| <span data-ttu-id="8a2ae-223">**Reproductor**</span><span class="sxs-lookup"><span data-stu-id="8a2ae-223">**Player**</span></span> |[<span data-ttu-id="8a2ae-224">Reproductor multimedia de Azure</span><span class="sxs-lookup"><span data-stu-id="8a2ae-224">Azure Media Player</span></span>](https://azure.microsoft.com/services/media-services/media-player/) |
| <span data-ttu-id="8a2ae-225">**Proveedor de identidades (IDP)**</span><span class="sxs-lookup"><span data-stu-id="8a2ae-225">**Identity Provider (IDP)**</span></span> |<span data-ttu-id="8a2ae-226">Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="8a2ae-226">Azure Active Directory</span></span> |
| <span data-ttu-id="8a2ae-227">**Servicio de token seguro (STS)**</span><span class="sxs-lookup"><span data-stu-id="8a2ae-227">**Secure Token Service (STS)**</span></span> |<span data-ttu-id="8a2ae-228">Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="8a2ae-228">Azure Active Directory</span></span> |
| <span data-ttu-id="8a2ae-229">**Flujo de trabajo de protección DRM**</span><span class="sxs-lookup"><span data-stu-id="8a2ae-229">**DRM Protection Workflow**</span></span> |<span data-ttu-id="8a2ae-230">Protección dinámica de Servicios multimedia de Azure</span><span class="sxs-lookup"><span data-stu-id="8a2ae-230">Azure Media Services Dynamic Protection</span></span> |
| <span data-ttu-id="8a2ae-231">**Entrega de licencias DRM**</span><span class="sxs-lookup"><span data-stu-id="8a2ae-231">**DRM License Delivery**</span></span> |<span data-ttu-id="8a2ae-232">1. Entrega de licencias de Azure Media Services (PlayReady, Widevine, FairPlay), o</span><span class="sxs-lookup"><span data-stu-id="8a2ae-232">1. Azure Media Services License Delivery (PlayReady, Widevine, FairPlay), or</span></span> <br/><span data-ttu-id="8a2ae-233">2. Servidor de licencias de Axinom,</span><span class="sxs-lookup"><span data-stu-id="8a2ae-233">2. Axinom License Server,</span></span> <br/><span data-ttu-id="8a2ae-234">3. Servidor de licencias personalizado de PlayReady</span><span class="sxs-lookup"><span data-stu-id="8a2ae-234">3. Custom PlayReady License Server</span></span> |
| <span data-ttu-id="8a2ae-235">**Origen**</span><span class="sxs-lookup"><span data-stu-id="8a2ae-235">**Origin**</span></span> |<span data-ttu-id="8a2ae-236">Punto de conexión de streaming de Servicios multimedia de Azure</span><span class="sxs-lookup"><span data-stu-id="8a2ae-236">Azure Media Services Streaming Endpoint</span></span> |
| <span data-ttu-id="8a2ae-237">**Administración de claves**</span><span class="sxs-lookup"><span data-stu-id="8a2ae-237">**Key Management**</span></span> |<span data-ttu-id="8a2ae-238">No es necesaria para la implementación de referencia.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-238">Not needed for reference implementation</span></span> |
| <span data-ttu-id="8a2ae-239">**Administración de contenido**</span><span class="sxs-lookup"><span data-stu-id="8a2ae-239">**Content Management**</span></span> |<span data-ttu-id="8a2ae-240">Una aplicación de consola de C#.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-240">A C# console application</span></span> |

<span data-ttu-id="8a2ae-241">En otras palabras, el proveedor de identidades (IDP) y el servicio de token seguro (STS) serán Azure AD.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-241">In other words, both Identity Provider (IDP) and Secure Token Service (STS) will be Azure AD.</span></span> <span data-ttu-id="8a2ae-242">Para el reproductor, usaremos la [API del Reproductor multimedia de Azure](http://amp.azure.net/libs/amp/latest/docs/).</span><span class="sxs-lookup"><span data-stu-id="8a2ae-242">For player, we will use [Azure Media Player API](http://amp.azure.net/libs/amp/latest/docs/).</span></span> <span data-ttu-id="8a2ae-243">Tanto los Servicios multimedia de Azure como el Reproductor multimedia de Azure admiten DASH y CENC con varios DRM.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-243">Both Azure Media Services and Azure Media Player support DASH and CENC with multi-DRM.</span></span>

<span data-ttu-id="8a2ae-244">En el diagrama siguiente se muestra la estructura y el flujo generales con la asignación de tecnología anterior.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-244">The following diagram shows the overall structure and flow with the above technology mapping.</span></span>

![CENC en AMS](./media/media-services-cenc-with-multidrm-access-control/media-services-cenc-subsystem-on-AMS-platform.png)

<span data-ttu-id="8a2ae-246">Para configurar el cifrado CENC dinámico, la herramienta de administración de contenido usará las siguientes entradas:</span><span class="sxs-lookup"><span data-stu-id="8a2ae-246">In order to set up dynamic CENC encryption, the content management tool will use the following inputs:</span></span>

1. <span data-ttu-id="8a2ae-247">Contenido abierto</span><span class="sxs-lookup"><span data-stu-id="8a2ae-247">Open content;</span></span>
2. <span data-ttu-id="8a2ae-248">Clave de contenido de la generación o administración de claves</span><span class="sxs-lookup"><span data-stu-id="8a2ae-248">Content key from key generation/management;</span></span>
3. <span data-ttu-id="8a2ae-249">Direcciones URL de adquisición de licencias</span><span class="sxs-lookup"><span data-stu-id="8a2ae-249">License acquisition URLs;</span></span>
4. <span data-ttu-id="8a2ae-250">Una lista de información de Azure AD.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-250">A list of information from Azure AD.</span></span>

<span data-ttu-id="8a2ae-251">La salida de la herramienta de administración de contenido será:</span><span class="sxs-lookup"><span data-stu-id="8a2ae-251">The output of the content management tool will be:</span></span>

1. <span data-ttu-id="8a2ae-252">ContentKeyAuthorizationPolicy, que contiene la especificación de cómo la entrega de licencias comprueba un token de JWT y las especificaciones de licencias de DRM.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-252">ContentKeyAuthorizationPolicy containing the specification on how license delivery verifies a JWT token and DRM license specifications;</span></span>
2. <span data-ttu-id="8a2ae-253">AssetDeliveryPolicy, que contiene las especificaciones de formato de streaming, protección DRM y direcciones URL de adquisición de licencias.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-253">AssetDeliveryPolicy containing specifications on streaming format, DRM protection and license acquisition URLs.</span></span>

<span data-ttu-id="8a2ae-254">Durante el tiempo de ejecución, el flujo es como  se muestra a continuación:</span><span class="sxs-lookup"><span data-stu-id="8a2ae-254">During runtime, the flow is as below:</span></span>

1. <span data-ttu-id="8a2ae-255">Tras la autenticación del usuario, se genera un token de JWT.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-255">Upon user authentication, a JWT token is generated;</span></span>
2. <span data-ttu-id="8a2ae-256">Una de las notificaciones contenidas en el token de JWT es la notificación "grupos" que contiene el identificador de objeto de grupo de "EntitledUserGroup".</span><span class="sxs-lookup"><span data-stu-id="8a2ae-256">One of the claims contained in the JWT token is “groups” claim containing the group object ID of “EntitledUserGroup”.</span></span> <span data-ttu-id="8a2ae-257">Esta notificación se utilizará para pasar la "comprobación de derechos".</span><span class="sxs-lookup"><span data-stu-id="8a2ae-257">This claim will be used for passing “entitlement check”.</span></span>
3. <span data-ttu-id="8a2ae-258">El reproductor descarga el manifiesto de cliente de un contenido protegido por CENC y "ve" lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="8a2ae-258">Player downloads client manifest of a CENC protected content and “sees” the following:</span></span>

   1. <span data-ttu-id="8a2ae-259">El id. de clave.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-259">key ID,</span></span>
   2. <span data-ttu-id="8a2ae-260">El contenido está protegido por CENC.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-260">the content is CENC protected,</span></span>
   3. <span data-ttu-id="8a2ae-261">Las direcciones URL de adquisición de licencias.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-261">License acquisition URLs.</span></span>
4. <span data-ttu-id="8a2ae-262">El reproductor realiza una solicitud de adquisición de licencias basada en el explorador o DRM admitidos.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-262">Player makes a license acquisition request based on the browser/DRM supported.</span></span> <span data-ttu-id="8a2ae-263">En la solicitud de adquisición de licencias, también se envían el id. de clave y el token de JWT.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-263">In the license acquisition request, key ID and the JWT token will also be submitted.</span></span> <span data-ttu-id="8a2ae-264">El servicio de entrega de licencias comprobará el token de JWT y las notificaciones contenidas antes de emitir la licencia necesaria.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-264">License delivery service will verify the JWT token and the claims contained before issuing the needed license.</span></span>

## <a name="implementation"></a><span data-ttu-id="8a2ae-265">Implementación</span><span class="sxs-lookup"><span data-stu-id="8a2ae-265">Implementation</span></span>
### <a name="implementation-procedures"></a><span data-ttu-id="8a2ae-266">Procedimientos de implementación</span><span class="sxs-lookup"><span data-stu-id="8a2ae-266">Implementation procedures</span></span>
<span data-ttu-id="8a2ae-267">La implementación incluye los pasos siguientes:</span><span class="sxs-lookup"><span data-stu-id="8a2ae-267">The implementation will include the following steps:</span></span>

1. <span data-ttu-id="8a2ae-268">Preparar los activos de prueba: codificar o empaquetar un vídeo de prueba en MP4 fragmentado de varias velocidades de bits en Servicios Multimedia de Azure.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-268">Prepare test asset(s): encode/package a test video to multi-bitrate fragmented MP4 in Azure Media Services.</span></span> <span data-ttu-id="8a2ae-269">Este activo NO está protegido con DRM.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-269">This asset is NOT DRM protected.</span></span> <span data-ttu-id="8a2ae-270">La protección DRM se realizará posteriormente mediante protección dinámica.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-270">DRM protection will be done by dynamic protection later.</span></span>
2. <span data-ttu-id="8a2ae-271">Crear el id. de clave y la clave de contenido (opcionalmente a partir de la inicialización de clave).</span><span class="sxs-lookup"><span data-stu-id="8a2ae-271">Create key ID and content key (optionally from key seed).</span></span> <span data-ttu-id="8a2ae-272">Para nuestro propósito, el sistema de administración de claves no es necesario puesto que estamos trabajando con un solo conjunto de id. de clave y clave de contenido para un par de activos de prueba.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-272">For our purpose, key management system is not needed since we are dealing with only a single set of key ID and content key for a couple of test assets;</span></span>
3. <span data-ttu-id="8a2ae-273">Usar la API de AMS para configurar servicios de entrega de licencias de varios DRM para el activo de prueba.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-273">Use AMS API to configure multi-DRM license delivery services for the test asset.</span></span> <span data-ttu-id="8a2ae-274">Si usa servidores de licencia personalizados por su empresa o proveedores de su empresa en lugar de los servicios de licencia de Servicios multimedia de Azure, puede omitir este paso y especificar las direcciones URL de adquisición de licencias en el paso para configurar la entrega de licencias.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-274">If you are using custom license servers by your company or your company’s vendors instead of license services in Azure Media Services, you can skip this step and specify license acquisition URLs in the step for configuring license delivery.</span></span> <span data-ttu-id="8a2ae-275">Las API de AMS son necesarias para especificar algunas configuraciones detalladas, como restricción de directivas de autorización, plantillas de respuesta de licencia para distintos servicios de licencias DRM, etc. En este momento, el Portal de Azure no proporciona aún la interfaz de usuario necesaria para esta configuración.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-275">AMS API is needed to specify some detailed configurations, such as authorization policy restriction, license response templates for different DRM license services, etc. At this time, the Azure portal does not yet provide the needed UI for this configuration.</span></span> <span data-ttu-id="8a2ae-276">Puede encontrar información de nivel de API y código de ejemplo en el documento de Julia Kornich: [Uso de cifrado dinámico común de PlayReady o Widevine](media-services-protect-with-drm.md).</span><span class="sxs-lookup"><span data-stu-id="8a2ae-276">You can find API level info and sample code in Julia Kornich’s document: [Using PlayReady and/or Widevine Dynamic Common Encryption](media-services-protect-with-drm.md).</span></span>
4. <span data-ttu-id="8a2ae-277">Usar la API de AMS para configurar la directiva de entrega de activos para el activo de prueba.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-277">Use AMS API to configure asset delivery policy for the test asset.</span></span> <span data-ttu-id="8a2ae-278">Puede encontrar información de nivel de API y código de ejemplo en el documento de Julia Kornich: [Uso de cifrado dinámico común de PlayReady o Widevine](media-services-protect-with-drm.md).</span><span class="sxs-lookup"><span data-stu-id="8a2ae-278">You can find API level info and sample code in Julia Kornich’s document: [Using PlayReady and/or Widevine Dynamic Common Encryption](media-services-protect-with-drm.md).</span></span>
5. <span data-ttu-id="8a2ae-279">Crear y configurar un inquilino de Azure Active Directory en Azure.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-279">Create and configure an Azure Active Directory tenant in Azure;</span></span>
6. <span data-ttu-id="8a2ae-280">Crear algunas cuentas y grupos de usuarios en el inquilino de Azure Active Directory: debe crear al menos el grupo "EntitledUser" y agregar un usuario a este grupo.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-280">Create a few user accounts and groups in your Azure Active Directory tenant: you should create at least “EntitledUser” group and add a user to this group.</span></span> <span data-ttu-id="8a2ae-281">Los usuarios de este grupo pasarán la comprobación de derechos en la adquisición de licencias y los usuarios que no están en este grupo no podrán pasar la comprobación de autenticación y no podrán adquirir ninguna licencia.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-281">Users in this group will pass entitlement check in license acquisition and users not in this group will fail to pass authentication check and will not be able to acquire any license.</span></span> <span data-ttu-id="8a2ae-282">Ser miembro del grupo "EntitledUser" es una notificación de "grupos" necesaria en el token de JWT emitido por Azure AD.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-282">Being a member of this “EntitledUser” group is a required “groups” claim in the JWT token issued by Azure AD.</span></span> <span data-ttu-id="8a2ae-283">Este requisito de notificación debe especificarse en la configuración del paso de servicios de entrega de licencias de varios DRM.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-283">This claim requirement should be specified in configuring multi-DRM license delivery services step.</span></span>
7. <span data-ttu-id="8a2ae-284">Crear una aplicación de ASP.NET MVC que hospedará el reproductor de vídeo.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-284">Create an ASP.NET MVC app which will be hosting your video player.</span></span> <span data-ttu-id="8a2ae-285">Esta aplicación ASP.NET estará protegida con autenticación de usuario con respecto al inquilino de Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-285">This ASP.NET app will be protected with user authentication against the Azure Active Directory tenant.</span></span> <span data-ttu-id="8a2ae-286">Se incluirán las notificaciones adecuadas en los tokens de acceso obtenidos después de la autenticación de usuario.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-286">Proper claims will be included in the access tokens obtained after user authentication.</span></span> <span data-ttu-id="8a2ae-287">Para este paso se recomienda la API de OpenID Connect.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-287">OpenID Connect API is recommended for this step.</span></span> <span data-ttu-id="8a2ae-288">Deberá instalar los siguientes paquetes de NuGet:</span><span class="sxs-lookup"><span data-stu-id="8a2ae-288">You need to install the following NuGet packages:</span></span>
   * <span data-ttu-id="8a2ae-289">Install-Package Microsoft.Azure.ActiveDirectory.GraphClient</span><span class="sxs-lookup"><span data-stu-id="8a2ae-289">Install-Package Microsoft.Azure.ActiveDirectory.GraphClient</span></span>
   * <span data-ttu-id="8a2ae-290">Install-Package Microsoft.Owin.Security.OpenIdConnect</span><span class="sxs-lookup"><span data-stu-id="8a2ae-290">Install-Package Microsoft.Owin.Security.OpenIdConnect</span></span>
   * <span data-ttu-id="8a2ae-291">Install-Package Microsoft.Owin.Security.Cookies</span><span class="sxs-lookup"><span data-stu-id="8a2ae-291">Install-Package Microsoft.Owin.Security.Cookies</span></span>
   * <span data-ttu-id="8a2ae-292">Install-Package Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="8a2ae-292">Install-Package Microsoft.Owin.Host.SystemWeb</span></span>
   * <span data-ttu-id="8a2ae-293">Install-Package Microsoft.IdentityModel.Clients.ActiveDirectory</span><span class="sxs-lookup"><span data-stu-id="8a2ae-293">Install-Package Microsoft.IdentityModel.Clients.ActiveDirectory</span></span>
8. <span data-ttu-id="8a2ae-294">Crear un reproductor mediante la [API del Reproductor multimedia de Azure](http://amp.azure.net/libs/amp/latest/docs/).</span><span class="sxs-lookup"><span data-stu-id="8a2ae-294">Create a player using [Azure Media Player API](http://amp.azure.net/libs/amp/latest/docs/).</span></span> <span data-ttu-id="8a2ae-295">[API ProtectionInfo del Reproductor multimedia de Azure](http://amp.azure.net/libs/amp/latest/docs/) le permite especificar la tecnología DRM que se usará en distintas plataformas DRM.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-295">[Azure Media Player’s ProtectionInfo API](http://amp.azure.net/libs/amp/latest/docs/) allows you to specify which DRM technology to use on different DRM platform.</span></span>
9. <span data-ttu-id="8a2ae-296">Matriz de pruebas:</span><span class="sxs-lookup"><span data-stu-id="8a2ae-296">Test matrix:</span></span>

| <span data-ttu-id="8a2ae-297">**DRM**</span><span class="sxs-lookup"><span data-stu-id="8a2ae-297">**DRM**</span></span> | <span data-ttu-id="8a2ae-298">**Browser**</span><span class="sxs-lookup"><span data-stu-id="8a2ae-298">**Browser**</span></span> | <span data-ttu-id="8a2ae-299">**Resultado de usuario autorizado**</span><span class="sxs-lookup"><span data-stu-id="8a2ae-299">**Result for Entitled User**</span></span> | <span data-ttu-id="8a2ae-300">**Resultado de usuario no autorizado**</span><span class="sxs-lookup"><span data-stu-id="8a2ae-300">**Result for Un-entitled User**</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="8a2ae-301">**PlayReady**</span><span class="sxs-lookup"><span data-stu-id="8a2ae-301">**PlayReady**</span></span> |<span data-ttu-id="8a2ae-302">MS Edge o IE11 en Windows 10</span><span class="sxs-lookup"><span data-stu-id="8a2ae-302">MS Edge or IE11 on Windows 10</span></span> |<span data-ttu-id="8a2ae-303">Correcto</span><span class="sxs-lookup"><span data-stu-id="8a2ae-303">Succeed</span></span> |<span data-ttu-id="8a2ae-304">Fail (no superado)</span><span class="sxs-lookup"><span data-stu-id="8a2ae-304">Fail</span></span> |
| <span data-ttu-id="8a2ae-305">**Widevine**</span><span class="sxs-lookup"><span data-stu-id="8a2ae-305">**Widevine**</span></span> |<span data-ttu-id="8a2ae-306">Chrome en Windows 10</span><span class="sxs-lookup"><span data-stu-id="8a2ae-306">Chrome on Windows 10</span></span> |<span data-ttu-id="8a2ae-307">Correcto</span><span class="sxs-lookup"><span data-stu-id="8a2ae-307">Succeed</span></span> |<span data-ttu-id="8a2ae-308">Fail (no superado)</span><span class="sxs-lookup"><span data-stu-id="8a2ae-308">Fail</span></span> |
| <span data-ttu-id="8a2ae-309">**FairPlay**</span><span class="sxs-lookup"><span data-stu-id="8a2ae-309">**FairPlay**</span></span> |<span data-ttu-id="8a2ae-310">TBD</span><span class="sxs-lookup"><span data-stu-id="8a2ae-310">TBD</span></span> | | |

<span data-ttu-id="8a2ae-311">George Trifonov, del equipo de Servicios multimedia de Azure, ha escrito un blog donde se proporcionan los pasos detallados para configurar Azure Active Directory para una aplicación de reproductor ASP.NET MVC: [Integrate Azure Media Services OWIN MVC based app with Azure Active Directory and restrict content key delivery based on JWT claims](http://gtrifonov.com/2015/01/24/mvc-owin-azure-media-services-ad-integration/)(Integración de una aplicación basada en OWIN MVC de Servicios multimedia de Azure con Azure Active Directory y restricción de la entrega de claves de contenido en función de las notificaciones JWT).</span><span class="sxs-lookup"><span data-stu-id="8a2ae-311">George Trifonov of Azure Media Services Team has written a blog providing detailed steps in setting up Azure Active Directory for an ASP.NET MVC player app: [Integrate Azure Media Services OWIN MVC based app with Azure Active Directory and restrict content key delivery based on JWT claims](http://gtrifonov.com/2015/01/24/mvc-owin-azure-media-services-ad-integration/).</span></span>

<span data-ttu-id="8a2ae-312">George también ha escrito un blog sobre la [autenticación de tokens de JWT en Servicios multimedia de Azure y Cifrado dinámico](http://gtrifonov.com/2015/01/03/jwt-token-authentication-in-azure-media-services-and-dynamic-encryption/).</span><span class="sxs-lookup"><span data-stu-id="8a2ae-312">George has also written a blog on [JWT token Authentication in Azure Media Services and Dynamic Encryption](http://gtrifonov.com/2015/01/03/jwt-token-authentication-in-azure-media-services-and-dynamic-encryption/).</span></span> <span data-ttu-id="8a2ae-313">Y este es su [ejemplo sobre la integración de Azure AD con la entrega de claves de Servicios multimedia de Azure](https://github.com/AzureMediaServicesSamples/Key-delivery-with-AAD-integration/).</span><span class="sxs-lookup"><span data-stu-id="8a2ae-313">And here is his [sample on Azure AD integration with Azure Media Services key delivery](https://github.com/AzureMediaServicesSamples/Key-delivery-with-AAD-integration/).</span></span>

<span data-ttu-id="8a2ae-314">Para más información sobre Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="8a2ae-314">For information on Azure Active Directory:</span></span>

* <span data-ttu-id="8a2ae-315">Puede encontrar información para desarrolladores en la [Guía para desarrolladores de Azure Active Directory](../active-directory/active-directory-developers-guide.md).</span><span class="sxs-lookup"><span data-stu-id="8a2ae-315">You can find developer information in [Azure Active Directory Developer’s Guide](../active-directory/active-directory-developers-guide.md).</span></span>
* <span data-ttu-id="8a2ae-316">Puede encontrar información para administradores en [Administración del directorio de Azure AD](../active-directory/active-directory-administer.md).</span><span class="sxs-lookup"><span data-stu-id="8a2ae-316">You can find administrator information in [Administer Your Azure AD Directory](../active-directory/active-directory-administer.md).</span></span>

### <a name="some-gotchas-in-implementation"></a><span data-ttu-id="8a2ae-317">Algunos problemas de implementación</span><span class="sxs-lookup"><span data-stu-id="8a2ae-317">Some gotchas in implementation</span></span>
<span data-ttu-id="8a2ae-318">Existen algunas dificultades en la implementación.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-318">There are some “gotchas” in the implementation.</span></span> <span data-ttu-id="8a2ae-319">Por fortuna, la siguiente lista puede ayudarle a solucionar problemas en caso de toparse con ellos.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-319">Hopefully the following list of “gotchas” can help you troubleshooting in case you run into issues.</span></span>

1. <span data-ttu-id="8a2ae-320">La dirección URL del **emisor** debe terminar con **"/"**.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-320">**Issuer** URL should end with **"/"**.</span></span>  

    <span data-ttu-id="8a2ae-321">La **audiencia** debe ser el identificador de cliente de la aplicación de reproductor y también se debe agregar **"/"** al final de la dirección URL del emisor.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-321">**Audience** should be the player application client ID and you should also add **"/"** at the end of the issuer URL.</span></span>

        <add key="ida:audience" value="[Application Client ID GUID]" />
        <add key="ida:issuer" value="https://sts.windows.net/[AAD Tenant ID]/" />

    <span data-ttu-id="8a2ae-322">En [JWT Decoder](http://jwt.calebb.net/), debería ver **aud** y **iss**, como se muestra a continuación en el token de JWT:</span><span class="sxs-lookup"><span data-stu-id="8a2ae-322">In [JWT Decoder](http://jwt.calebb.net/), you should see **aud** and **iss** as below in the JWT token:</span></span>

    ![Problema 1](./media/media-services-cenc-with-multidrm-access-control/media-services-1st-gotcha.png)
2. <span data-ttu-id="8a2ae-324">Agregue permisos a la aplicación en AAD (en la pestaña Configurar de la aplicación).</span><span class="sxs-lookup"><span data-stu-id="8a2ae-324">Add Permissions to the application in AAD (on Configure tab of the application).</span></span> <span data-ttu-id="8a2ae-325">Este paso es necesario para cada aplicación (las versiones local e implementada).</span><span class="sxs-lookup"><span data-stu-id="8a2ae-325">This is required for each application (local and deployed versions).</span></span>

    ![Problema 2](./media/media-services-cenc-with-multidrm-access-control/media-services-perms-to-other-apps.png)
3. <span data-ttu-id="8a2ae-327">Utilice el emisor correcto en la configuración de la protección CENC dinámica:</span><span class="sxs-lookup"><span data-stu-id="8a2ae-327">Use the right issuer in setting up dynamic CENC protection:</span></span>

        <add key="ida:issuer" value="https://sts.windows.net/[AAD Tenant ID]/"/>

    <span data-ttu-id="8a2ae-328">Lo siguiente no funcionará:</span><span class="sxs-lookup"><span data-stu-id="8a2ae-328">The following will not work:</span></span>

        <add key="ida:issuer" value="https://willzhanad.onmicrosoft.com/" />

    <span data-ttu-id="8a2ae-329">El GUID es el identificador del inquilino de AAD.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-329">The GUID is the AAD tenant ID.</span></span> <span data-ttu-id="8a2ae-330">Puede encontrar el GUID en la ventana emergente de puntos de conexión del Portal de Azure.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-330">The GUID can be found in Endpoints popup in Azure portal.</span></span>
4. <span data-ttu-id="8a2ae-331">Otorgue privilegios de notificaciones de pertenencia a grupo.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-331">Grant group membership claims privileges.</span></span> <span data-ttu-id="8a2ae-332">Asegúrese de que en el archivo de manifiesto de aplicación de AAD tengamos lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="8a2ae-332">Make sure in AAD application manifest file, we have the following</span></span>

    <span data-ttu-id="8a2ae-333">"groupMembershipClaims": "All",    (el valor predeterminado es nulo)</span><span class="sxs-lookup"><span data-stu-id="8a2ae-333">"groupMembershipClaims": "All",    (the default value is null)</span></span>
5. <span data-ttu-id="8a2ae-334">Establezca el valor adecuado de TokenType al crear los requisitos de restricción.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-334">Setting proper TokenType when creating restriction requirements.</span></span>

        objTokenRestrictionTemplate.TokenType = TokenType.JWT;

    <span data-ttu-id="8a2ae-335">Desde que se agregó compatibilidad con JWT (AAD), además de con SWT (ACS), el valor predeterminado de TokenType es TokenType.JWT.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-335">Since adding support of JWT (AAD) in addition to SWT (ACS), the default TokenType is TokenType.JWT.</span></span> <span data-ttu-id="8a2ae-336">Si utiliza SWT y ACS, debe establecerlo en TokenType.SWT.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-336">If you use SWT/ACS, you must set to TokenType.SWT.</span></span>

## <a name="additional-topics-for-implementation"></a><span data-ttu-id="8a2ae-337">Temas adicionales para la implementación</span><span class="sxs-lookup"><span data-stu-id="8a2ae-337">Additional Topics for Implementation</span></span>
<span data-ttu-id="8a2ae-338">A continuación trataremos algunos temas adicionales de nuestro diseño e implementación.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-338">Next we will disc uss some additional topics in our design and implementation.</span></span>

### <a name="http-or-https"></a><span data-ttu-id="8a2ae-339">¿HTTP o HTTPS?</span><span class="sxs-lookup"><span data-stu-id="8a2ae-339">HTTP or HTTPS?</span></span>
<span data-ttu-id="8a2ae-340">La aplicación de reproductor de ASP.NET MVC que hemos creado debe ser compatible con lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="8a2ae-340">The ASP.NET MVC player application we built must support the following:</span></span>

1. <span data-ttu-id="8a2ae-341">Autenticación de usuarios a través de Azure AD que debe estar en HTTPS.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-341">User authentication through Azure AD which needs to be under HTTPS;</span></span>
2. <span data-ttu-id="8a2ae-342">Intercambio de tokens de JWT entre el cliente y Azure AD que debe estar en HTTPS.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-342">JWT token exchange between client and Azure AD which needs to be under HTTPS;</span></span>
3. <span data-ttu-id="8a2ae-343">Se requiere la adquisición de licencias DRM por el cliente para estar en HTTPS si Servicios multimedia de Azure proporciona la entrega de licencias.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-343">DRM license acquisition by the client which is required to be under HTTPS if license delivery is provided by Azure Media Services.</span></span> <span data-ttu-id="8a2ae-344">Por supuesto, el conjunto de productos de PlayReady no impone HTTPS para la entrega de licencias.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-344">Of course, PlayReady product suite does not mandate HTTPS for license delivery.</span></span> <span data-ttu-id="8a2ae-345">Si el servidor de licencias de PlayReady está fuera de Servicios multimedia de Azure, se podría usar HTTP o HTTPS.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-345">If your PlayReady license server is outside of Azure Media Services, either HTTP or HTTPS could be used.</span></span>

<span data-ttu-id="8a2ae-346">Por lo tanto, la aplicación de reproductor ASP.NET usará HTTPS como procedimiento recomendado.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-346">Therefore, the ASP.NET player application will use HTTPS as a best practice.</span></span> <span data-ttu-id="8a2ae-347">Esto significa que el Reproductor multimedia de Azure estará en una página en HTTPS.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-347">This means the Azure Media Player will be on a page under HTTPS.</span></span> <span data-ttu-id="8a2ae-348">Sin embargo, para el streaming preferimos HTTP, de ahí que debamos considerar el problema del contenido mixto.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-348">However, for streaming we prefer HTTP, hence we need to consider mixed content issue.</span></span>

1. <span data-ttu-id="8a2ae-349">El explorador no permite contenido mixto.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-349">Browser does not allow mixed content.</span></span> <span data-ttu-id="8a2ae-350">Pero, los complementos como Silverlight y OSMF para Smooth y DASH sí lo hacen.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-350">But plugins like Silverlight and OSMF plugin for smooth and DASH allow.</span></span> <span data-ttu-id="8a2ae-351">El contenido mixto es un problema de seguridad: esto se debe a la amenaza de la posibilidad de insertar JS malintencionado que puede poner en riesgo los datos del cliente.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-351">Mixed content is a security concern - This is due to the threat of the ability to inject malicious JS which can cause the customer data to be at risk.</span></span>  <span data-ttu-id="8a2ae-352">Los exploradores lo bloquean de forma predeterminada y, hasta ahora, la única manera de solucionar esto es en el servidor (origen), para permitir todos los dominios (con independencia de si son https o http).</span><span class="sxs-lookup"><span data-stu-id="8a2ae-352">Browsers block this by default and so far the only way to work around it is on the server (origin) side, to allow all domains (regardless https or http).</span></span> <span data-ttu-id="8a2ae-353">Probablemente esto tampoco sea una buena idea.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-353">This is probably not a good idea either.</span></span>
2. <span data-ttu-id="8a2ae-354">Debemos evitar contenido mixto: tanto si se usa HTTP o HTTPS.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-354">We should avoid mixed content: either both use HTTP or both use HTTPS.</span></span> <span data-ttu-id="8a2ae-355">Al reproducir contenido mixto, silverlightSS tech requiere que se borre una advertencia de contenido mixto.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-355">When playing mixed content, silverlightSS tech requires clearing a mixed content warning.</span></span> <span data-ttu-id="8a2ae-356">flashSS tech controla el contenido mixto sin advertencia de contenido mixto.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-356">flashSS tech handles mixed content without mixed content warning.</span></span>
3. <span data-ttu-id="8a2ae-357">Si su punto de conexión de streaming se creó antes de agosto de 2014, no admitirá HTTPS.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-357">If your streaming endpoint was created before August 2014, it will not support HTTPS.</span></span> <span data-ttu-id="8a2ae-358">En este caso, cree y utilice un nuevo punto de conexión de streaming para HTTPS.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-358">In this case, please create and use a new streaming endpoint for HTTPS.</span></span>

<span data-ttu-id="8a2ae-359">En la implementación de referencia, para el contenido protegido con DRM, tanto la aplicación como el proceso de streaming estarán en HTTTPS.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-359">In the reference implementation, for DRM protected contents, both application and streaming will be under HTTTPS.</span></span> <span data-ttu-id="8a2ae-360">Para el contenido abierto, el reproductor no necesita autenticación ni licencia, por lo que tiene la libertad de utilizar HTTP o HTTPS.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-360">For open contents, the player does not need authentication or license, so you have the liberty to use either HTTP or HTTPS.</span></span>

### <a name="azure-active-directory-signing-key-rollover"></a><span data-ttu-id="8a2ae-361">Sustitución de claves de firma de Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="8a2ae-361">Azure Active Directory signing key rollover</span></span>
<span data-ttu-id="8a2ae-362">Se trata de un punto importante de su implementación a tener en cuenta.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-362">This is an important point to take into consideration of your implementation.</span></span> <span data-ttu-id="8a2ae-363">Si no lo considera en su implementación, el sistema completado finalmente dejará de funcionar completamente al cabo de 6 semanas a lo sumo.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-363">If you do not consider this in your implementation, the completed system will eventually stop working completely within at most 6 weeks.</span></span>

<span data-ttu-id="8a2ae-364">Azure AD utiliza el estándar del sector para establecer la confianza entre sí mismo y las aplicaciones que usan Azure AD.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-364">Azure AD uses industry standard to establish trust between itself and applications using Azure AD.</span></span> <span data-ttu-id="8a2ae-365">En concreto, Azure AD utiliza una clave de firma que consta de un par de claves pública y privada.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-365">Specifically, Azure AD uses a signing key that consists of a public and private key pair.</span></span> <span data-ttu-id="8a2ae-366">Cuando Azure AD crea un token de seguridad que contiene información sobre el usuario, Azure AD firma este token con su clave privada antes de enviarlo a la aplicación.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-366">When Azure AD creates a security token that contains information about the user, this token is signed by Azure AD using its private key before it is sent back to the application.</span></span> <span data-ttu-id="8a2ae-367">Para comprobar que el token es válido y que realmente se originó en Azure AD, la aplicación debe validar la firma del token usando la clave pública expuesta por Azure AD que se encuentra en el documento de metadatos de federación del inquilino.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-367">To verify that the token is valid and actually originated from Azure AD, the application must validate the token’s signature using the public key exposed by Azure AD that is contained in the tenant’s federation metadata document.</span></span> <span data-ttu-id="8a2ae-368">Esta clave pública, y la clave de firma de la que se deriva, es la misma que se utiliza en todos los inquilinos de Azure AD.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-368">This public key – and the signing key from which it derives – is the same one used for all tenants in Azure AD.</span></span>

<span data-ttu-id="8a2ae-369">Puede encontrar información detallada sobre la sustitución de claves de Azure AD en el documento: [Información importante acerca de la sustitución de la clave de firma en Azure AD](../active-directory/active-directory-signing-key-rollover.md).</span><span class="sxs-lookup"><span data-stu-id="8a2ae-369">Detailed info on Azure AD key rollover can be found in the document: [Important Information about Signing Key Rollover in Azure AD](../active-directory/active-directory-signing-key-rollover.md).</span></span>

<span data-ttu-id="8a2ae-370">Entre el [par de claves pública y privada](https://login.microsoftonline.com/common/discovery/keys/):</span><span class="sxs-lookup"><span data-stu-id="8a2ae-370">Between the [public-private key pair](https://login.microsoftonline.com/common/discovery/keys/),</span></span>

* <span data-ttu-id="8a2ae-371">Azure Active Directory utiliza la clave privada para generar un token de JWT.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-371">The private key is used by Azure Active Directory to generate a JWT token;</span></span>
* <span data-ttu-id="8a2ae-372">La clave pública se utiliza en una aplicación, como Servicios de entrega de licencias de DRM en AMS, para comprobar el token de JWT.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-372">The public key is used by an application such as DRM License Delivery Services in AMS to verify the JWT token;</span></span>

<span data-ttu-id="8a2ae-373">Por motivos de seguridad, Azure Active Directory realiza la rotación de este certificado periódicamente (cada 6 semanas).</span><span class="sxs-lookup"><span data-stu-id="8a2ae-373">For security purpose, Azure Active Directory rotates this certificate periodically (every 6 weeks).</span></span> <span data-ttu-id="8a2ae-374">En caso de infracciones de seguridad, la sustitución de claves se produce en cualquier momento.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-374">In case of security breaches, the key rollover can occur any time.</span></span> <span data-ttu-id="8a2ae-375">Por lo tanto, los servicios de entrega de licencias de AMS deben actualizar la clave pública utilizada cuando Azure AD realiza la rotación del par de claves, de lo contrario, la autenticación del token en AMS dará error y no se emitirá ninguna licencia.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-375">Therefore, the license delivery services in AMS need to update the public key used as Azure AD rotates the key pair, otherwise token authentication in AMS will fail and no license will be issued.</span></span>

<span data-ttu-id="8a2ae-376">Para ello, es necesario establecer TokenRestrictionTemplate.OpenIdConnectDiscoveryDocument al configurar los servicios de entrega de licencias de DRM.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-376">This is achieved by setting TokenRestrictionTemplate.OpenIdConnectDiscoveryDocument when configuring DRM license delivery services.</span></span>

<span data-ttu-id="8a2ae-377">El flujo de tokens de JWT es como se muestra a continuación:</span><span class="sxs-lookup"><span data-stu-id="8a2ae-377">The JWT token flow is as below:</span></span>

1. <span data-ttu-id="8a2ae-378">Azure AD emitirá el token de JWT con la clave privada actual de un usuario autenticado.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-378">Azure AD will issue the JWT token with the current private key for an authenticated user;</span></span>
2. <span data-ttu-id="8a2ae-379">Cuando un reproductor ve un CENC con contenido protegido por varios DRM, primero busca el token de JWT emitido por Azure AD.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-379">When a player sees a CENC with multi-DRM protected content, it will first locate the JWT token issued by Azure AD.</span></span>
3. <span data-ttu-id="8a2ae-380">El reproductor envía la solicitud de adquisición de licencias con el token de JWT a los servicios de entrega de licencias de AMS.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-380">The player sends license acquisition request with the JWT token to license delivery services in AMS;</span></span>
4. <span data-ttu-id="8a2ae-381">Los servicios de entrega de licencias de AMS utilizarán la clave pública actual o válida de Azure AD para comprobar el token de JWT, antes de emitir las licencias.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-381">The license delivery services in AMS will use the current/valid public key from Azure AD to verify the JWT token, before issuing licenses.</span></span>

<span data-ttu-id="8a2ae-382">Los servicios de entrega de licencias de DRM siempre estarán buscando la clave pública actual o válida de Azure AD.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-382">DRM license delivery services will always be checking for the current/valid public key from Azure AD.</span></span> <span data-ttu-id="8a2ae-383">La clave pública presentada por Azure AD será la clave utilizada para comprobar un token de JWT emitido por Azure AD.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-383">The public key presented by Azure AD will be the key used for verifying a JWT token issued by Azure AD.</span></span>

<span data-ttu-id="8a2ae-384">¿Y si la sustitución de claves sucede después de que AAD genera un token de JWT pero antes de que los reproductores envíen el token de JWT a los servicios de entrega de licencias de DRM en AMS para que lo comprueben?</span><span class="sxs-lookup"><span data-stu-id="8a2ae-384">What if the key rollover happens after AAD generates a JWT token but before the JWT token is sent by players to DRM license delivery services in AMS for verification?</span></span>

<span data-ttu-id="8a2ae-385">Dado que una clave se puede sustituir en cualquier momento, siempre hay más de una clave pública válida disponible en el documento de metadatos de federación.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-385">Because a key may be rolled at any moment, there is always more than one valid public key available in the federation metadata document.</span></span> <span data-ttu-id="8a2ae-386">En la entrega de licencias de Servicios multimedia de Azure se puede utilizar cualquiera de las claves especificadas en el documento, ya que una clave se puede sustituir pronto, otra puede ser su reemplazo, etc.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-386">Azure Media Services license delivery can use any of the keys specified in the document, since one key may be rolled soon, another may be its replacement, and so forth.</span></span>

### <a name="where-is-the-access-token"></a><span data-ttu-id="8a2ae-387">¿Dónde está el token de acceso?</span><span class="sxs-lookup"><span data-stu-id="8a2ae-387">Where is the Access Token?</span></span>
<span data-ttu-id="8a2ae-388">Si observa cómo una aplicación web llama a una aplicación de API en [Escenarios de autenticación para Azure AD](../active-directory/develop/active-directory-authentication-scenarios.md#web-application-to-web-api), el flujo de autenticación tiene lugar como se indica a continuación:</span><span class="sxs-lookup"><span data-stu-id="8a2ae-388">If you look at how a web app calls an API app under [Application Identity with OAuth 2.0 Client Credentials Grant](../active-directory/develop/active-directory-authentication-scenarios.md#web-application-to-web-api), the authentication flow is as below:</span></span>

1. <span data-ttu-id="8a2ae-389">Un usuario inicia sesión en Azure AD en la aplicación web (consulte la sección [Explorador web a aplicación web](../active-directory/develop/active-directory-authentication-scenarios.md#web-browser-to-web-application)).</span><span class="sxs-lookup"><span data-stu-id="8a2ae-389">A user is signed in to Azure AD in the web application (see the [Web Browser to Web Application](../active-directory/develop/active-directory-authentication-scenarios.md#web-browser-to-web-application).</span></span>
2. <span data-ttu-id="8a2ae-390">El punto de conexión de autorización de Azure AD redirige al agente de usuario a la aplicación cliente con un código de autorización.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-390">The Azure AD authorization endpoint redirects the user agent back to the client application with an authorization code.</span></span> <span data-ttu-id="8a2ae-391">El agente de usuario devuelve el código de autorización al URI de redireccionamiento de la aplicación cliente.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-391">The user agent returns authorization code to the client application’s redirect URI.</span></span>
3. <span data-ttu-id="8a2ae-392">La aplicación web necesita adquirir un token de acceso para poder autenticarse ante la API web y recuperar el recurso deseado.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-392">The web application needs to acquire an access token so that it can authenticate to the web API and retrieve the desired resource.</span></span> <span data-ttu-id="8a2ae-393">Realiza una solicitud al extremo de token de Azure AD y proporciona las credenciales, el identificador del cliente y el URI del identificador de aplicación de la API web.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-393">It makes a request to Azure AD’s token endpoint, providing the credential, client ID, and web API’s application ID URI.</span></span> <span data-ttu-id="8a2ae-394">Presenta el código de autorización para demostrar que el usuario ha dado su consentimiento.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-394">It presents the authorization code to prove that the user has consented.</span></span>
4. <span data-ttu-id="8a2ae-395">Azure AD autentica la aplicación y devuelve un token de acceso de JWT que se usa para llamar a la API web.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-395">Azure AD authenticates the application and returns a JWT access token that is used to call the web API.</span></span>
5. <span data-ttu-id="8a2ae-396">A través de HTTPS, la aplicación web usa el token de acceso de JWT devuelto para agregar la cadena JWT con una designación “Bearer” en el encabezado Authorization de la solicitud a la API web.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-396">Over HTTPS, the web application uses the returned JWT access token to add the JWT string with a “Bearer” designation in the Authorization header of the request to the web API.</span></span> <span data-ttu-id="8a2ae-397">A continuación, la API web valida el token de JWT y, si la validación es correcta, devuelve el recurso deseado.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-397">The web API then validates the JWT token, and if validation is successful, returns the desired resource.</span></span>

<span data-ttu-id="8a2ae-398">En este flujo de "identidad de aplicación", la API web confía en que la aplicación web autenticó al usuario.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-398">In this “application identity” flow, the web API trusts that the web application authenticated the user.</span></span> <span data-ttu-id="8a2ae-399">Por ello, este patrón se conoce como subsistema de confianza.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-399">For this reason, this pattern is called a trusted subsystem.</span></span> <span data-ttu-id="8a2ae-400">En el [diagrama de esta página](https://docs.microsoft.com/azure/active-directory/active-directory-protocols-oauth-code) se describe cómo funciona el flujo de concesión del código de autorización.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-400">The [diagram on this page](https://docs.microsoft.com/azure/active-directory/active-directory-protocols-oauth-code) describes how authorization code grant flow works.</span></span>

<span data-ttu-id="8a2ae-401">En la adquisición de licencias con restricción de token, estamos siguiendo el mismo patrón de subsistema de confianza.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-401">In license acquisition with token restriction, we are following the same trusted subsystem pattern.</span></span> <span data-ttu-id="8a2ae-402">Y el servicio de entrega de licencias de Servicios multimedia de Azure es el recurso de API web, el "recurso de back-end", una aplicación web que necesita acceso.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-402">And the license delivery service in Azure Media Services is the web API resource, the “backend resource” a web application needs to access.</span></span> <span data-ttu-id="8a2ae-403">Entonces, ¿dónde está el token de acceso?</span><span class="sxs-lookup"><span data-stu-id="8a2ae-403">So where is the access token?</span></span>

<span data-ttu-id="8a2ae-404">De hecho, vamos a obtener el token de acceso desde Azure AD.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-404">Indeed, we are obtaining access token from Azure AD.</span></span> <span data-ttu-id="8a2ae-405">Después de autenticar al usuario correctamente, se devuelve el código de autorización.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-405">After successful user authentication, authorization code is returned.</span></span> <span data-ttu-id="8a2ae-406">El código de autorización se utiliza entonces junto con el id. de cliente y la clave de aplicación para intercambiarlos por el token de acceso.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-406">The authorization code is then used, together with client ID and app key, to exchange for access token.</span></span> <span data-ttu-id="8a2ae-407">Y el token de acceso sirve para acceder a una aplicación "puntero" que señala o representa el servicio de entrega de licencias de Servicios multimedia de Azure.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-407">And the access token is for accessing a “pointer” application pointing or representing Azure Media Services license delivery service.</span></span>

<span data-ttu-id="8a2ae-408">Es necesario registrar y configurar la aplicación "puntero" en Azure AD mediante los pasos siguientes:</span><span class="sxs-lookup"><span data-stu-id="8a2ae-408">We need to register and configure the “pointer” app in Azure AD by following the steps below:</span></span>

1. <span data-ttu-id="8a2ae-409">En el inquilino de Azure AD,</span><span class="sxs-lookup"><span data-stu-id="8a2ae-409">In the Azure AD tenant</span></span>

   * <span data-ttu-id="8a2ae-410">agregue una aplicación (recurso) con la dirección URL de inicio de sesión</span><span class="sxs-lookup"><span data-stu-id="8a2ae-410">add an application (resource) with sign-on URL:</span></span>

   <span data-ttu-id="8a2ae-411">https://[resource_name].azurewebsites.net/ and</span><span class="sxs-lookup"><span data-stu-id="8a2ae-411">https://[resource_name].azurewebsites.net/ and</span></span>

   * <span data-ttu-id="8a2ae-412">la URL de identificador de aplicación</span><span class="sxs-lookup"><span data-stu-id="8a2ae-412">app ID URL:</span></span>

   <span data-ttu-id="8a2ae-413">https://[aad_tenant_name].onmicrosoft.com/[resource_name];</span><span class="sxs-lookup"><span data-stu-id="8a2ae-413">https://[aad_tenant_name].onmicrosoft.com/[resource_name];</span></span>
2. <span data-ttu-id="8a2ae-414">Agregue una nueva clave para la aplicación de recursos.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-414">Add a new key for the resource app;</span></span>
3. <span data-ttu-id="8a2ae-415">Actualice el archivo de manifiesto de aplicación para que la propiedad groupMembershipClaims tenga el siguiente valor: "groupMembershipClaims": "All".</span><span class="sxs-lookup"><span data-stu-id="8a2ae-415">Update the app manifest file so that the groupMembershipClaims property has the following value: "groupMembershipClaims": "All",</span></span>  
4. <span data-ttu-id="8a2ae-416">En la aplicación de Azure AD que apunta a la aplicación web de reproductor, en la sección "Permisos para otras aplicaciones", agregue la aplicación de recursos que se agregó en el paso 1 anteriormente.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-416">In the Azure AD app pointing to the player web app, in the section “permissions to other applications”, add the resource app which was added in step 1 above.</span></span> <span data-ttu-id="8a2ae-417">En "Permisos delegados", active la casilla "Acceso [nombre_de_recurso]".</span><span class="sxs-lookup"><span data-stu-id="8a2ae-417">Under “delegated permissions” check “Access [resource_name]” checkmark.</span></span> <span data-ttu-id="8a2ae-418">Con ello se proporciona permiso a la aplicación web para crear tokens de acceso para el acceso a la aplicación de recursos.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-418">This gives the web app permission to create access tokens for accessing the resource app.</span></span> <span data-ttu-id="8a2ae-419">Esto debe hacerlo para la versión local e implementada de la aplicación web si va a desarrollar con la aplicación web de Visual Studio y Azure.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-419">You should do this for both local and deployed version of the web app if you are developing with Visual Studio and Azure web app.</span></span>

<span data-ttu-id="8a2ae-420">Por lo tanto, el token de JWT emitido por Azure AD es realmente el token de acceso a este recurso "puntero".</span><span class="sxs-lookup"><span data-stu-id="8a2ae-420">Therefore, the JWT token issued by Azure AD is indeed the access token for accessing this “pointer” resource.</span></span>

### <a name="what-about-live-streaming"></a><span data-ttu-id="8a2ae-421">¿Y qué pasa con el streaming en vivo?</span><span class="sxs-lookup"><span data-stu-id="8a2ae-421">What about Live Streaming?</span></span>
<span data-ttu-id="8a2ae-422">Antes, nuestra discusión se ha centrado en los activos a petición.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-422">In the above, our discussion has been focusing on on-demand assets.</span></span> <span data-ttu-id="8a2ae-423">¿Y qué pasa con el streaming en vivo?</span><span class="sxs-lookup"><span data-stu-id="8a2ae-423">What about live streaming?</span></span>

<span data-ttu-id="8a2ae-424">La buena noticia es que puede usar exactamente el mismo diseño y la misma implementación para proteger el streaming en vivo en Servicios multimedia de Azure, solo hay que tratar el activo asociado con un programa como un "activo VOD".</span><span class="sxs-lookup"><span data-stu-id="8a2ae-424">The good news is that you can use exactly the same design and implementation for protecting live streaming in Azure Media Services, by treating the asset associated with a program as a “VOD asset”.</span></span>

<span data-ttu-id="8a2ae-425">En concreto, es bien sabido que para hacer streaming en vivo en Servicios multimedia de Azure, debe crear un canal y, luego, un programa bajo él.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-425">Specifically, it is well known that to do live streaming in Azure Media Services, you need to create a channel, then a program under the channel.</span></span> <span data-ttu-id="8a2ae-426">Para crear el programa, debe crear un activo que contendrá el archivo en vivo del programa.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-426">To create the program, you need to create an asset which will contain the live archive for the program.</span></span> <span data-ttu-id="8a2ae-427">Para proporcionar a CENC protección de varios DRM del contenido en directo, todo lo que debe hacer es aplicar la misma configuración o procesamiento al activo como si fuera un "activo VOD", antes de iniciar el programa.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-427">In order to provide CENC with multi-DRM protection of the live content, all you need to do, is to apply the same setup/processing to the asset as if it was a “VOD asset” before you start the program.</span></span>

### <a name="what-about-license-servers-outside-of-azure-media-services"></a><span data-ttu-id="8a2ae-428">¿Y qué sucede con los servidores de licencias que están fuera de Servicios multimedia de Azure?</span><span class="sxs-lookup"><span data-stu-id="8a2ae-428">What about license servers outside of Azure Media Services?</span></span>
<span data-ttu-id="8a2ae-429">Con frecuencia, puede ocurrir que los clientes inviertan en granjas de servidores de licencias en su propio centro de datos u hospedados por proveedores de servicios DRM.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-429">Often, customers may have invested in license server farm either in their own data center or hosted by DRM service providers.</span></span> <span data-ttu-id="8a2ae-430">Por fortuna, la protección del contenido de Servicios multimedia de Azure le permite trabajar en modo híbrido: el contenido está hospedado y protegido de forma dinámica en Servicios multimedia de Azure, mientras que las licencias DRM las entregan servidores externos a Servicios multimedia de Azure.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-430">Fortunately, Azure Media Services Content Protection allows you to operate in hybrid mode: contents hosted and dynamically protected in Azure Media Services, while DRM licenses are delivered by servers outside Azure Media Services.</span></span> <span data-ttu-id="8a2ae-431">En este caso, hay considerar los siguientes cambios:</span><span class="sxs-lookup"><span data-stu-id="8a2ae-431">In this case, there are the following considerations of changes:</span></span>

1. <span data-ttu-id="8a2ae-432">El servicio de token seguro debe emitir tokens que sean aceptables y que se puedan comprobar en la granja de servidores de licencias.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-432">The Secure Token Service needs to issue tokens which are acceptable and can be verified by the license server farm.</span></span> <span data-ttu-id="8a2ae-433">Por ejemplo, los servidores de licencias de Widevine proporcionados por Axinom requieren un token de JWT específico que contenga el "mensaje de derechos".</span><span class="sxs-lookup"><span data-stu-id="8a2ae-433">For example, the Widevine license servers provided by Axinom requires a specific JWT token which contains “entitlement message”.</span></span> <span data-ttu-id="8a2ae-434">Por lo tanto, debe tener un STS para emitir dicho token.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-434">Therefore, you need to have an STS to issue such JWT token.</span></span> <span data-ttu-id="8a2ae-435">Los autores han realizado este tipo de implementación. Puede encontrar los detalles en el siguiente documento en [Centro de documentación de Azure](https://azure.microsoft.com/documentation/): [Uso de Axinom para entregar licencias de Widevine a Azure Media Services](media-services-axinom-integration.md).</span><span class="sxs-lookup"><span data-stu-id="8a2ae-435">The authors have completed such an implementation and you can find the details in the following document in [Azure Documentation Center](https://azure.microsoft.com/documentation/): [Using Axinom to deliver Widevine licenses to Azure Media Services](media-services-axinom-integration.md).</span></span>
2. <span data-ttu-id="8a2ae-436">Ya no necesitará configurar el servicio de entrega de licencias (ContentKeyAuthorizationPolicy) en Servicios multimedia de Azure.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-436">You no longer need to configure license delivery service (ContentKeyAuthorizationPolicy) in Azure Media Services.</span></span> <span data-ttu-id="8a2ae-437">Lo que debe hacer es proporcionar las direcciones URL de adquisición de licencias (para PlayReady, Widevine y FairPlay) cuando configura AssetDeliveryPolicy en la configuración de CENC con varios DRM.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-437">What you need to do is to provide the license acquisition URLs (for PlayReady, Widevine and FairPlay) when you configure AssetDeliveryPolicy in setting up CENC with multi-DRM.</span></span>

### <a name="what-if-i-want-to-use-a-custom-sts"></a><span data-ttu-id="8a2ae-438">¿Y si quiero usar un STS personalizado?</span><span class="sxs-lookup"><span data-stu-id="8a2ae-438">What if I want to use a custom STS?</span></span>
<span data-ttu-id="8a2ae-439">Puede haber varias razones por las que un cliente prefiera el uso de un STS (Servicio de token seguro) personalizado para proporcionar tokens de JWT.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-439">There could be a few reasons that a customer may choose to use a custom STS (Secure Token Service) for providing JWT tokens.</span></span> <span data-ttu-id="8a2ae-440">Algunas de ellas son:</span><span class="sxs-lookup"><span data-stu-id="8a2ae-440">Some of them are:</span></span>

1. <span data-ttu-id="8a2ae-441">El proveedor de identidades (IDP) utilizada por el cliente no admite a STS.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-441">The Identity Provider (IDP) used by the customer does not support STS.</span></span> <span data-ttu-id="8a2ae-442">En este caso, un STS personalizado puede ser una opción.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-442">In this case a custom STS may be an option.</span></span>
2. <span data-ttu-id="8a2ae-443">El cliente puede necesitar un control más flexible o más estricto en la integración de STS con el sistema de facturación de los suscriptores del cliente.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-443">The customer may need more flexible or tighter control in integrating STS with customer’s subscriber billing system.</span></span> <span data-ttu-id="8a2ae-444">Por ejemplo, un operador MVPD puede ofrecer varios paquetes de suscriptor OTT, por ejemplo, premium, básico, deportes, etc. El operador puede querer hacer coincidir las notificaciones de un token con el paquete de un suscriptor de forma que solo el contenido del paquete adecuado esté disponible.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-444">For example, an MVPD operator may offer multiple OTT subscriber packages such as premium, basic, sports, etc. The operator may want to match the claims in a token with a subscriber’s package so that only contents in the right package is made available.</span></span> <span data-ttu-id="8a2ae-445">En este caso, un STS personalizado proporciona la flexibilidad y el control necesarios.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-445">In this case, a custom STS provides the needed flexibility and control.</span></span>

<span data-ttu-id="8a2ae-446">Dos cambios deben realizarse cuando se utiliza un STS personalizado:</span><span class="sxs-lookup"><span data-stu-id="8a2ae-446">Two changes need to be made when using a custom STS:</span></span>

1. <span data-ttu-id="8a2ae-447">Al configurar el servicio de entrega de licencias para un activo, debe especificar la clave de seguridad utilizada para la comprobación por el STS personalizado (más detalles a continuación) en lugar de la clave actual de Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-447">When configuring license delivery service for an asset, you need to specify the security key used for verification by the custom STS (more details below) instead of the current key from Azure Active Directory.</span></span>
2. <span data-ttu-id="8a2ae-448">Cuando se genera un token de JTW, se especifica una clave de seguridad en lugar de la clave privada del certificado X509 actual en Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-448">When a JTW token is generated, a security key is specified instead of the private key of the current X509 certificate in Azure Active Directory.</span></span>

<span data-ttu-id="8a2ae-449">Hay dos tipos de claves de seguridad:</span><span class="sxs-lookup"><span data-stu-id="8a2ae-449">There are two types of security keys:</span></span>

1. <span data-ttu-id="8a2ae-450">Clave simétrica: se utiliza la misma clave para generar y comprobar un token de JWT.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-450">Symmetric key: the same key is used for both generating and verifying a JWT token;</span></span>
2. <span data-ttu-id="8a2ae-451">Clave asimétrica: se utiliza un par de claves pública/privada de un certificado X509 junto con la clave privada para cifrar o generar un token de JWT, y la clave pública para comprobar el token.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-451">Asymmetric key: a public-private key pair in an X509 certificate is used with private key for encrypting/generating a JWT token and the public key for verifying the token.</span></span>

#### <a name="tech-note"></a><span data-ttu-id="8a2ae-452">Nota técnica</span><span class="sxs-lookup"><span data-stu-id="8a2ae-452">Tech note</span></span>
<span data-ttu-id="8a2ae-453">Si utiliza .NET Framework o C# como plataforma de desarrollo, el certificado X509 usado en la clave de seguridad asimétrica debe tener una longitud de clave de al menos 2048.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-453">If you use .NET Framework/C# as your development platform, the X509 certificate used for asymmetric security key must have key length at least 2048.</span></span> <span data-ttu-id="8a2ae-454">Se trata de un requisito de la clase System.IdentityModel.Tokens.X509AsymmetricSecurityKey en .NET Framework.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-454">This is a requirement of the class System.IdentityModel.Tokens.X509AsymmetricSecurityKey in .NET Framework.</span></span> <span data-ttu-id="8a2ae-455">De lo contrario, se producirá la siguiente excepción:</span><span class="sxs-lookup"><span data-stu-id="8a2ae-455">Otherwise, the following exception will be thrown:</span></span>

<span data-ttu-id="8a2ae-456">IDX10630: El valor 'System.IdentityModel.Tokens.X509AsymmetricSecurityKey' de la firma no puede ser inferior a '2048' bits.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-456">IDX10630: The 'System.IdentityModel.Tokens.X509AsymmetricSecurityKey' for signing cannot be smaller than '2048' bits.</span></span>

## <a name="the-completed-system-and-test"></a><span data-ttu-id="8a2ae-457">Finalización del sistema y prueba</span><span class="sxs-lookup"><span data-stu-id="8a2ae-457">The completed system and test</span></span>
<span data-ttu-id="8a2ae-458">Recorreremos algunos escenarios en el sistema de un extremo a otro completado para que los lectores puedan tener una idea general del comportamiento antes de obtener una cuenta de inicio de sesión.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-458">We will walk through a few scenarios in the completed end-to-end system so that readers can have a basic “picture” of the behavior before getting a login account.</span></span>

<span data-ttu-id="8a2ae-459">Puede encontrar la aplicación web de reproductor y su inicio de sesión [aquí](https://openidconnectweb.azurewebsites.net/).</span><span class="sxs-lookup"><span data-stu-id="8a2ae-459">The player web application and its login can be found [here](https://openidconnectweb.azurewebsites.net/).</span></span>

<span data-ttu-id="8a2ae-460">Si lo que necesita es un escenario "no integrado": activos de vídeo hospedados en Servicios multimedia de Azure que están sin protección o DRM protegidos pero sin autenticación de token (emisión de una licencia a cualquiera que la solicite), puede probarlo sin inicio de sesión (cambiando a HTTP si su transmisión por secuencias de vídeo es sobre HTTP).</span><span class="sxs-lookup"><span data-stu-id="8a2ae-460">If what you need is “non-integrated” scenario: video assets hosted in Azure Media Services which are either unprotected, or DRM protected but without token authentication (issuing a license to whoever requesting it), you can test it without login (by switching to HTTP if your video streaming is over HTTP).</span></span>

<span data-ttu-id="8a2ae-461">Si lo que necesita es un escenario integrado de extremo a extremo: los activos de vídeo están bajo la protección DRM dinámica en Servicios multimedia de Azure, con autenticación de token y token de JWT generado por Azure AD, debe iniciar sesión.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-461">If what you need is end-to-end integrated scenario: video assets is under dynamic DRM protection in Azure Media Services, with token authentication and JWT token being generated by Azure AD, you need to login.</span></span>

### <a name="user-login"></a><span data-ttu-id="8a2ae-462">Inicio de sesión de usuario</span><span class="sxs-lookup"><span data-stu-id="8a2ae-462">User login</span></span>
<span data-ttu-id="8a2ae-463">Para probar el sistema DRM integrado de extremo a extremo, debe tener una "cuenta" creada o agregada.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-463">In order to test the end-to-end integrated DRM system, you need to have an “account” created or added.</span></span>

<span data-ttu-id="8a2ae-464">¿Qué cuenta?</span><span class="sxs-lookup"><span data-stu-id="8a2ae-464">What account?</span></span>

<span data-ttu-id="8a2ae-465">Aunque Azure inicialmente permitía el acceso únicamente a usuarios de cuentas Microsoft, ahora permite el acceso a usuarios de ambos sistemas.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-465">Although Azure originally allowed access only by Microsoft account users, it now allows access by users from both systems.</span></span> <span data-ttu-id="8a2ae-466">Esto se hizo haciendo que todas las propiedades de Azure confiaran en Azure AD para la autenticación, haciendo que Azure AD autenticara usuarios de la organización y creando una relación de federación en la que Azure AD confiaba en el sistema de identidad del cliente de cuentas de Microsoft para autenticar usuarios de cliente.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-466">This was done by having all the Azure properties trust Azure AD for authentication, having Azure AD authenticate organizational users, and by creating a federation relationship where Azure AD trusts the Microsoft account consumer identity system to authenticate consumer users.</span></span> <span data-ttu-id="8a2ae-467">Como resultado, Azure AD puede autenticar cuentas Microsoft de tipo "Invitado", así como cuentas de Azure AD "nativas".</span><span class="sxs-lookup"><span data-stu-id="8a2ae-467">As a result, Azure AD is able to authenticate “guest” Microsoft accounts as well as “native” Azure AD accounts.</span></span>

<span data-ttu-id="8a2ae-468">Puesto que Azure AD confía en el dominio de la cuenta Microsoft (MSA), puede agregar cuentas de cualquiera de los siguientes dominios al inquilino de Azure AD personalizado y usar la cuenta para iniciar sesión:</span><span class="sxs-lookup"><span data-stu-id="8a2ae-468">Since Azure AD trusts Microsoft Account (MSA) domain, you can add any accounts from any of the following domains to the custom Azure AD tenant and use the account to login:</span></span>

| <span data-ttu-id="8a2ae-469">**Nombre de dominio**</span><span class="sxs-lookup"><span data-stu-id="8a2ae-469">**Domain Name**</span></span> | <span data-ttu-id="8a2ae-470">**Dominio**</span><span class="sxs-lookup"><span data-stu-id="8a2ae-470">**Domain**</span></span> |
| --- | --- |
| <span data-ttu-id="8a2ae-471">**Dominio de inquilino de Azure AD personalizado**</span><span class="sxs-lookup"><span data-stu-id="8a2ae-471">**Custom Azure AD tenant domain**</span></span> |<span data-ttu-id="8a2ae-472">somename.onmicrosoft.com</span><span class="sxs-lookup"><span data-stu-id="8a2ae-472">somename.onmicrosoft.com</span></span> |
| <span data-ttu-id="8a2ae-473">**Dominio corporativo**</span><span class="sxs-lookup"><span data-stu-id="8a2ae-473">**Corporate domain**</span></span> |<span data-ttu-id="8a2ae-474">microsoft.com</span><span class="sxs-lookup"><span data-stu-id="8a2ae-474">microsoft.com</span></span> |
| <span data-ttu-id="8a2ae-475">**Dominio de la cuenta Microsoft (MSA)**</span><span class="sxs-lookup"><span data-stu-id="8a2ae-475">**Microsoft Account (MSA) domain**</span></span> |<span data-ttu-id="8a2ae-476">outlook.com, live.com, hotmail.com</span><span class="sxs-lookup"><span data-stu-id="8a2ae-476">outlook.com, live.com, hotmail.com</span></span> |

<span data-ttu-id="8a2ae-477">Puede ponerse en contacto con cualquiera de los autores para que le creen o le agreguen una cuenta.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-477">You may contact any of the authors to have an account created or added for you.</span></span>

<span data-ttu-id="8a2ae-478">A continuación, se muestran las capturas de pantalla de diferentes páginas de inicio de sesión que se usan con distintas cuentas de dominio.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-478">Below are the screenshots of different login pages used by different domain accounts.</span></span>

<span data-ttu-id="8a2ae-479">**Cuenta de dominio de inquilino de Azure AD personalizado**: en este caso, verá la página de inicio de sesión personalizada del dominio de inquilino de Azure AD personalizado.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-479">**Custom Azure AD tenant domain account**: In this case, you see the customized login page of the custom Azure AD tenant domain.</span></span>

![Cuenta de dominio de inquilino de Azure AD personalizado](./media/media-services-cenc-with-multidrm-access-control/media-services-ad-tenant-domain1.png)

<span data-ttu-id="8a2ae-481">**Cuenta de dominio de Microsoft con tarjeta inteligente**: en este caso, verá la página de inicio de sesión personalizada por el responsable de TI corporativa de Microsoft con autenticación en dos fases.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-481">**Microsoft domain account with smart card**: In this case you see the login page customized by Microsoft corporate IT with two-factor authentication.</span></span>

![Cuenta de dominio de inquilino de Azure AD personalizado](./media/media-services-cenc-with-multidrm-access-control/media-services-ad-tenant-domain2.png)

<span data-ttu-id="8a2ae-483">**Cuenta Microsoft (MSA)**: en este caso, verá la página de inicio de sesión de Microsoft de cuentas para consumidores.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-483">**Microsoft Account (MSA)**: In this case, you see the login page of Microsoft Account for consumers.</span></span>

![Cuenta de dominio de inquilino de Azure AD personalizado](./media/media-services-cenc-with-multidrm-access-control/media-services-ad-tenant-domain3.png)

### <a name="using-encrypted-media-extensions-for-playready"></a><span data-ttu-id="8a2ae-485">Uso de extensiones multimedia cifradas para PlayReady</span><span class="sxs-lookup"><span data-stu-id="8a2ae-485">Using Encrypted Media Extensions for PlayReady</span></span>
<span data-ttu-id="8a2ae-486">En un explorador moderno con compatibilidad con las extensiones multimedia cifradas (EME)/PlayReady, como Internet Explorer 11 en Windows 8.1 o superior y el explorador de Microsoft Edge en Windows 10, PlayReady será el DRM subyacente para EME.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-486">On a modern browser with Encrypted Media Extensions (EME) for PlayReady support, such as IE 11 on Windows 8.1 and up, and Microsoft Edge browser on Windows 10, PlayReady will be the underlying DRM for EME.</span></span>

![Uso de EME para PlayReady](./media/media-services-cenc-with-multidrm-access-control/media-services-eme-for-playready1.png)

<span data-ttu-id="8a2ae-488">El área oscura del reproductor se debe a que la protección de PlayReady impide la realización de una captura de pantalla del vídeo protegido.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-488">The dark player area is due to the fact that PlayReady protection prevents one from making screen capture of protected video.</span></span>

<span data-ttu-id="8a2ae-489">La siguiente pantalla muestra los complementos y la compatibilidad con MSE/EME del reproductor.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-489">The following screen shows the player plugins and MSE/EME support.</span></span>

![Uso de EME para PlayReady](./media/media-services-cenc-with-multidrm-access-control/media-services-eme-for-playready2.png)

<span data-ttu-id="8a2ae-491">EME en Microsoft Edge e Internet Explorer 11 en Windows 10 permiten invocar [PlayReady SL3000](https://www.microsoft.com/playready/features/EnhancedContentProtection.aspx/) en dispositivos de Windows 10 que lo admitan.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-491">EME in Microsoft Edge and IE 11 on Windows 10 allows invoking of [PlayReady SL3000](https://www.microsoft.com/playready/features/EnhancedContentProtection.aspx/) on Windows 10 devices which support it.</span></span> <span data-ttu-id="8a2ae-492">PlayReady SL3000 desbloquea el flujo del contenido premium mejorado (4K, HDR, etc.) y los nuevos modelos de entrega de contenido (ventana anticipada para el contenido mejorado).</span><span class="sxs-lookup"><span data-stu-id="8a2ae-492">PlayReady SL3000 unlocks the flow of enhanced premium content (4K, HDR, etc.) and new content delivery models (early window for Enhanced Content).</span></span>

<span data-ttu-id="8a2ae-493">Céntrese en los dispositivos de Windows: PlayReady es el único DRM en el hardware disponible en dispositivos de Windows (PlayReady SL3000).</span><span class="sxs-lookup"><span data-stu-id="8a2ae-493">Focus on the Windows devices: PlayReady is the only DRM in the HW available on Windows devices (PlayReady SL3000).</span></span> <span data-ttu-id="8a2ae-494">Un servicio de streaming puede usar PlayReady mediante EME o una aplicación de UWP y ofrecer una mayor calidad de vídeo con PlayReady SL3000 que otro DRM.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-494">A streaming service can use PlayReady through EME or through a UWP application and offer a higher video quality using PlayReady SL3000 than another DRM.</span></span> <span data-ttu-id="8a2ae-495">Normalmente, el contenido de 2K se propagará a través de Chrome o Firefox y el contenido de 4K lo hará a través de Microsoft Edge/IE11 o una aplicación de UWP en el mismo dispositivo (según la configuración e implementación del servicio).</span><span class="sxs-lookup"><span data-stu-id="8a2ae-495">Typically, 2K content will flow through Chrome or Firefox, and 4K content through Microsoft Edge/IE11 or a UWP application on the same device (depending on service settings and implementation).</span></span>

#### <a name="using-eme-for-widevine"></a><span data-ttu-id="8a2ae-496">Uso de EME para Widevine</span><span class="sxs-lookup"><span data-stu-id="8a2ae-496">Using EME for Widevine</span></span>
<span data-ttu-id="8a2ae-497">En un explorador moderno con compatibilidad con EME/Widevine, como Chrome 41+ en Windows 10, Windows 8.1, Mac OSX Yosemite y Chrome en Android 4.4.4, Google Widevine es el DRM que subyace a EME.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-497">On a modern browser with EME/Widevine support, such as Chrome 41+ on Windows 10, Windows 8.1, Mac OSX Yosemite, and Chrome on Android 4.4.4, Google Widevine is the DRM behind EME.</span></span>

![Uso de EME para Widevine](./media/media-services-cenc-with-multidrm-access-control/media-services-eme-for-widevine1.png)

<span data-ttu-id="8a2ae-499">Tenga en cuenta que Widevine no impide la realización de capturas de pantalla de vídeo protegido.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-499">Notice that Widevine does not prevent one from making screen capture of protected video.</span></span>

![Uso de EME para Widevine](./media/media-services-cenc-with-multidrm-access-control/media-services-eme-for-widevine2.png)

### <a name="not-entitled-users"></a><span data-ttu-id="8a2ae-501">Usuarios no autorizados</span><span class="sxs-lookup"><span data-stu-id="8a2ae-501">Not entitled users</span></span>
<span data-ttu-id="8a2ae-502">Si un usuario no es miembro del grupo "Usuarios autorizados", el usuario no podrá pasar la "comprobación de derechos" y el servicio de licencias de varios DRM se negará a emitir la licencia solicitada, como se muestra a continuación.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-502">If a user is not a member of "Entitled Users" group, the user will not be able to pass “entitlement check” and the multi-DRM license service will refuse to issue the requested license as shown below.</span></span> <span data-ttu-id="8a2ae-503">La descripción detallada es "error al adquirir licencias", que es como se ha diseñado.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-503">The detailed description is “License acquire failed”, which is as designed.</span></span>

![Usuarios no autorizados](./media/media-services-cenc-with-multidrm-access-control/media-services-unentitledusers.png)

### <a name="running-custom-secure-token-service"></a><span data-ttu-id="8a2ae-505">Ejecución del servicio de token seguro personalizado</span><span class="sxs-lookup"><span data-stu-id="8a2ae-505">Running custom Secure Token Service</span></span>
<span data-ttu-id="8a2ae-506">Para el escenario de ejecución del servicio de token seguro (STS) personalizado, el STS personalizado emitirá el token de JWT mediante la clave simétrica o asimétrica.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-506">For the scenario of running custom Secure Token Service (STS), the JWT token will be issued by the custom STS using either symmetric or asymmetric key.</span></span>

<span data-ttu-id="8a2ae-507">Caso de uso de clave simétrica (con Chrome):</span><span class="sxs-lookup"><span data-stu-id="8a2ae-507">The case of using symmetric key (using Chrome):</span></span>

![Ejecución del STS personalizado](./media/media-services-cenc-with-multidrm-access-control/media-services-running-sts1.png)

<span data-ttu-id="8a2ae-509">El caso de uso de una clave asimétrica mediante un certificado X 509 (con el explorador moderno de Microsoft).</span><span class="sxs-lookup"><span data-stu-id="8a2ae-509">The case of using asymmetric key via an X509 certificate (using Microsoft modern browser).</span></span>

![Ejecución del STS personalizado](./media/media-services-cenc-with-multidrm-access-control/media-services-running-sts2.png)

<span data-ttu-id="8a2ae-511">En los dos casos mencionados anteriormente, la autenticación de usuario indica lo mismo: mediante Azure AD.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-511">In both of the above cases, user authentication stays the same – through Azure AD.</span></span> <span data-ttu-id="8a2ae-512">La única diferencia es que los tokens los emite el STS personalizado en lugar de Azure AD.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-512">The only difference is that JWT tokens are issued by the custom STS instead of Azure AD.</span></span> <span data-ttu-id="8a2ae-513">Desde luego, al configurar la protección CENC dinámica, la restricción del servicio de entrega de licencias especifica el tipo de token de JWT: clave simétrica o asimétrica.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-513">Of course, when configuring dynamic CENC protection, the restriction of license delivery service specifies the type of JWT token, either symmetric or asymmetric key.</span></span>

## <a name="summary"></a><span data-ttu-id="8a2ae-514">Resumen</span><span class="sxs-lookup"><span data-stu-id="8a2ae-514">Summary</span></span>
<span data-ttu-id="8a2ae-515">En este documento, hemos examinado el CENC con varios DRM nativos y el control de acceso mediante la autenticación con tokens: su diseño y su implementación mediante Azure, Servicios multimedia de Azure y el Reproductor multimedia de Azure.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-515">In this document, we discussed CENC with multi-native-DRM and access control via token authentication: its design and its implementation using Azure, Azure Media Services and Azure Media Player.</span></span>

* <span data-ttu-id="8a2ae-516">Se presenta un diseño de referencia que contiene todos los componentes necesarios de un subsistema DRM/CENC,</span><span class="sxs-lookup"><span data-stu-id="8a2ae-516">A reference design is presented which contains all the necessary components in a DRM/CENC subsystem;</span></span>
* <span data-ttu-id="8a2ae-517">y una implementación de referencia en Azure, Servicios multimedia de Azure y el Reproductor multimedia de Azure.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-517">A reference implementation on Azure, Azure Media Services and Azure Media Player.</span></span>
* <span data-ttu-id="8a2ae-518">También se han tratado algunos temas directamente relacionados con el diseño y la implementación.</span><span class="sxs-lookup"><span data-stu-id="8a2ae-518">Some topics directly involved in the design and implementation are also discussed.</span></span>

## <a name="media-services-learning-paths"></a><span data-ttu-id="8a2ae-519">Rutas de aprendizaje de Servicios multimedia</span><span class="sxs-lookup"><span data-stu-id="8a2ae-519">Media Services learning paths</span></span>
[!INCLUDE [media-services-learning-paths-include](../../includes/media-services-learning-paths-include.md)]

## <a name="provide-feedback"></a><span data-ttu-id="8a2ae-520">Envío de comentarios</span><span class="sxs-lookup"><span data-stu-id="8a2ae-520">Provide feedback</span></span>
[!INCLUDE [media-services-user-voice-include](../../includes/media-services-user-voice-include.md)]
 
